<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">-- | Interpreter and typechecker of a contract in Morley language.</span><span>
</span><a name="line-2"></a><span>
</span><a name="line-3"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Michelson.Runtime</span><span>
</span><a name="line-4"></a><span>       </span><span class="hs-special">(</span><span>
</span><a name="line-5"></a><span>         </span><span class="hs-comment">-- * High level interface for end user</span><span>
</span><a name="line-6"></a><span>         </span><a href="Michelson.Runtime.html#originateContract"><span class="hs-identifier hs-var">originateContract</span></a><span>
</span><a name="line-7"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Michelson.Runtime.html#runContract"><span class="hs-identifier hs-var">runContract</span></a><span>
</span><a name="line-8"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Michelson.Runtime.html#transfer"><span class="hs-identifier hs-var">transfer</span></a><span>
</span><a name="line-9"></a><span>
</span><a name="line-10"></a><span>       </span><span class="hs-comment">-- * Other helpers</span><span>
</span><a name="line-11"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Michelson.Runtime.html#parseContract"><span class="hs-identifier hs-var">parseContract</span></a><span>
</span><a name="line-12"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Michelson.Runtime.html#parseExpandContract"><span class="hs-identifier hs-var">parseExpandContract</span></a><span>
</span><a name="line-13"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Michelson.Runtime.html#readAndParseContract"><span class="hs-identifier hs-var">readAndParseContract</span></a><span>
</span><a name="line-14"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Michelson.Runtime.html#prepareContract"><span class="hs-identifier hs-var">prepareContract</span></a><span>
</span><a name="line-15"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Michelson.Runtime.html#typeCheckWithDb"><span class="hs-identifier hs-var">typeCheckWithDb</span></a><span>
</span><a name="line-16"></a><span>
</span><a name="line-17"></a><span>       </span><span class="hs-comment">-- * Re-exports</span><span>
</span><a name="line-18"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Michelson.Runtime.GState.html#ContractState"><span class="hs-identifier hs-type">ContractState</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-19"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Michelson.Runtime.GState.html#AddressState"><span class="hs-identifier hs-type">AddressState</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-20"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Michelson.Runtime.TxData.html#TxData"><span class="hs-identifier hs-type">TxData</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-21"></a><span>
</span><a name="line-22"></a><span>       </span><span class="hs-comment">-- * For testing</span><span>
</span><a name="line-23"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Michelson.Runtime.html#InterpreterOp"><span class="hs-identifier hs-type">InterpreterOp</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-24"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Michelson.Runtime.html#InterpreterRes"><span class="hs-identifier hs-type">InterpreterRes</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-25"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Michelson.Runtime.html#InterpreterError%27"><span class="hs-identifier hs-type">InterpreterError'</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-26"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Michelson.Runtime.html#InterpreterError"><span class="hs-identifier hs-type">InterpreterError</span></a><span>
</span><a name="line-27"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Michelson.Runtime.html#interpreterPure"><span class="hs-identifier hs-var">interpreterPure</span></a><span>
</span><a name="line-28"></a><span>
</span><a name="line-29"></a><span>       </span><span class="hs-comment">-- * To avoid warnings (can't generate lenses only for some fields)</span><span>
</span><a name="line-30"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Michelson.Runtime.html#irInterpretResults"><span class="hs-identifier hs-var">irInterpretResults</span></a><span>
</span><a name="line-31"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Michelson.Runtime.html#irUpdates"><span class="hs-identifier hs-var">irUpdates</span></a><span>
</span><a name="line-32"></a><span>       </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-33"></a><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Lens</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">at</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">makeLenses</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">%=</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.Except</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Except</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">runExcept</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">throwError</span><span class="hs-special">)</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Text.IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getContents</span><span class="hs-special">)</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Fmt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Buildable</span><span class="hs-special">(</span><span class="hs-identifier hs-var">build</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">blockListF</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">fmt</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">fmtLn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">nameF</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">pretty</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">+|</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">|+</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Named</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-type">:!</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-type">:?</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">arg</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">argDef</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">defaults</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">!</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Text.Megaparsec</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">parse</span><span class="hs-special">)</span><span>
</span><a name="line-40"></a><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><a href="Michelson.Interpret.html"><span class="hs-identifier">Michelson.Interpret</span></a><span>
</span><a name="line-42"></a><span>  </span><span class="hs-special">(</span><a href="Michelson.Interpret.html#ContractEnv"><span class="hs-identifier hs-type">ContractEnv</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Michelson.Interpret.html#InterpretError"><span class="hs-identifier hs-type">InterpretError</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Michelson.Interpret.html#InterpretResult"><span class="hs-identifier hs-type">InterpretResult</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Michelson.Interpret.html#InterpreterState"><span class="hs-identifier hs-type">InterpreterState</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Michelson.Interpret.html#MorleyLogs"><span class="hs-identifier hs-type">MorleyLogs</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-43"></a><span>  </span><a href="Michelson.Interpret.html#RemainingSteps"><span class="hs-identifier hs-type">RemainingSteps</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Michelson.Interpret.html#interpretSome"><span class="hs-identifier hs-var">interpretSome</span></a><span class="hs-special">)</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><a href="Michelson.Macro.html"><span class="hs-identifier">Michelson.Macro</span></a><span> </span><span class="hs-special">(</span><a href="Michelson.Macro.html#ParsedOp"><span class="hs-identifier hs-type">ParsedOp</span></a><span class="hs-special">,</span><span> </span><a href="Michelson.Macro.html#expandContract"><span class="hs-identifier hs-var">expandContract</span></a><span class="hs-special">)</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Michelson.Parser.html"><span class="hs-identifier">Michelson.Parser</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">P</span><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><a href="Michelson.Runtime.GState.html"><span class="hs-identifier">Michelson.Runtime.GState</span></a><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><a href="Michelson.Runtime.TxData.html"><span class="hs-identifier">Michelson.Runtime.TxData</span></a><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span> </span><a href="Michelson.TypeCheck.html"><span class="hs-identifier">Michelson.TypeCheck</span></a><span>
</span><a name="line-49"></a><span>  </span><span class="hs-special">(</span><a href="Michelson.TypeCheck.Types.html#SomeContract"><span class="hs-identifier hs-type">SomeContract</span></a><span class="hs-special">,</span><span> </span><a href="Michelson.TypeCheck.Types.html#StorageOrParameter"><span class="hs-identifier hs-type">StorageOrParameter</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Michelson.TypeCheck.Error.html#TCError"><span class="hs-identifier hs-type">TCError</span></a><span class="hs-special">,</span><span> </span><a href="Michelson.TypeCheck.Instr.html#typeCheckContract"><span class="hs-identifier hs-var">typeCheckContract</span></a><span class="hs-special">,</span><span> </span><a href="Michelson.TypeCheck.Instr.html#typeCheckStorageOrParameter"><span class="hs-identifier hs-var">typeCheckStorageOrParameter</span></a><span class="hs-special">)</span><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><a href="Michelson.Typed.html"><span class="hs-identifier">Michelson.Typed</span></a><span>
</span><a name="line-51"></a><span>  </span><span class="hs-special">(</span><a href="Michelson.Typed.Value.html#CreateContract"><span class="hs-identifier hs-type">CreateContract</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Michelson.Typed.Value.html#Operation%27"><span class="hs-identifier hs-type">Operation'</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Michelson.Typed.Value.html#SomeValue%27"><span class="hs-identifier hs-type">SomeValue'</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Michelson.Typed.Value.html#TransferTokens"><span class="hs-identifier hs-type">TransferTokens</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Michelson.Typed.Convert.html#convertContract"><span class="hs-identifier hs-var">convertContract</span></a><span class="hs-special">,</span><span>
</span><a name="line-52"></a><span>  </span><a href="Michelson.Typed.Convert.html#untypeValue"><span class="hs-identifier hs-var">untypeValue</span></a><span class="hs-special">)</span><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Michelson.Typed.html"><span class="hs-identifier">Michelson.Typed</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">T</span><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span> </span><a href="Michelson.Untyped.html"><span class="hs-identifier">Michelson.Untyped</span></a><span> </span><span class="hs-special">(</span><a href="Michelson.Untyped.Aliases.html#Contract"><span class="hs-identifier hs-type">Contract</span></a><span class="hs-special">,</span><span> </span><a href="Michelson.Untyped.Instr.html#OriginationOperation"><span class="hs-identifier hs-type">OriginationOperation</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Michelson.Untyped.Instr.html#mkContractAddress"><span class="hs-identifier hs-var">mkContractAddress</span></a><span class="hs-special">)</span><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Michelson.Untyped.html"><span class="hs-identifier">Michelson.Untyped</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">U</span><span>
</span><a name="line-56"></a><span class="hs-keyword">import</span><span> </span><a href="Tezos.Address.html"><span class="hs-identifier">Tezos.Address</span></a><span> </span><span class="hs-special">(</span><a href="Tezos.Address.html#Address"><span class="hs-identifier hs-type">Address</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-57"></a><span class="hs-keyword">import</span><span> </span><a href="Tezos.Core.html"><span class="hs-identifier">Tezos.Core</span></a><span> </span><span class="hs-special">(</span><a href="Tezos.Core.html#Mutez"><span class="hs-identifier hs-type">Mutez</span></a><span class="hs-special">,</span><span> </span><a href="Tezos.Core.html#Timestamp"><span class="hs-identifier hs-type">Timestamp</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Tezos.Core.html#getCurrentTime"><span class="hs-identifier hs-var">getCurrentTime</span></a><span class="hs-special">,</span><span> </span><a href="Tezos.Core.html#unsafeAddMutez"><span class="hs-identifier hs-var">unsafeAddMutez</span></a><span class="hs-special">,</span><span> </span><a href="Tezos.Core.html#unsafeSubMutez"><span class="hs-identifier hs-var">unsafeSubMutez</span></a><span class="hs-special">)</span><span>
</span><a name="line-58"></a><span class="hs-keyword">import</span><span> </span><a href="Tezos.Crypto.html"><span class="hs-identifier">Tezos.Crypto</span></a><span> </span><span class="hs-special">(</span><a href="Tezos.Crypto.html#parseKeyHash"><span class="hs-identifier hs-var">parseKeyHash</span></a><span class="hs-special">)</span><span>
</span><a name="line-59"></a><span class="hs-keyword">import</span><span> </span><a href="Util.IO.html"><span class="hs-identifier">Util.IO</span></a><span> </span><span class="hs-special">(</span><a href="Util.IO.html#readFileUtf8"><span class="hs-identifier hs-var">readFileUtf8</span></a><span class="hs-special">)</span><span>
</span><a name="line-60"></a><span>
</span><a name="line-61"></a><span class="hs-comment">----------------------------------------------------------------------------</span><span>
</span><a name="line-62"></a><span class="hs-comment">-- Auxiliary types</span><span>
</span><a name="line-63"></a><span class="hs-comment">----------------------------------------------------------------------------</span><span>
</span><a name="line-64"></a><span>
</span><a name="line-65"></a><span class="hs-comment">-- | Operations executed by interpreter.</span><span>
</span><a name="line-66"></a><span class="hs-comment">-- In our model one Michelson's operation (`operation` type in Michelson)</span><span>
</span><a name="line-67"></a><span class="hs-comment">-- corresponds to 0 or 1 interpreter operation.</span><span>
</span><a name="line-68"></a><span class="hs-comment">--</span><span>
</span><a name="line-69"></a><span class="hs-comment">-- Note: 'Address' is not part of 'TxData', because 'TxData' is</span><span>
</span><a name="line-70"></a><span class="hs-comment">-- supposed to be provided by the user, while 'Address' can be</span><span>
</span><a name="line-71"></a><span class="hs-comment">-- computed by our code.</span><span>
</span><a name="line-72"></a><span class="hs-keyword">data</span><span> </span><a name="InterpreterOp"><a href="Michelson.Runtime.html#InterpreterOp"><span class="hs-identifier">InterpreterOp</span></a></a><span>
</span><a name="line-73"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="OriginateOp"><a href="Michelson.Runtime.html#OriginateOp"><span class="hs-identifier">OriginateOp</span></a></a><span> </span><span class="hs-glyph">!</span><a href="Michelson.Untyped.Instr.html#OriginationOperation"><span class="hs-identifier hs-type">OriginationOperation</span></a><span>
</span><a name="line-74"></a><span>  </span><span class="hs-comment">-- ^ Originate a contract.</span><span>
</span><a name="line-75"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="TransferOp"><a href="Michelson.Runtime.html#TransferOp"><span class="hs-identifier">TransferOp</span></a></a><span> </span><a href="Tezos.Address.html#Address"><span class="hs-identifier hs-type">Address</span></a><span>
</span><a name="line-76"></a><span>               </span><a href="Michelson.Runtime.TxData.html#TxData"><span class="hs-identifier hs-type">TxData</span></a><span>
</span><a name="line-77"></a><span>  </span><span class="hs-comment">-- ^ Send a transaction to given address which is assumed to be the</span><span>
</span><a name="line-78"></a><span>  </span><span class="hs-comment">-- address of an originated contract.</span><span>
</span><a name="line-79"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">)</span><span>
</span><a name="line-80"></a><span>
</span><a name="line-81"></a><span class="hs-comment">-- | Result of a single execution of interpreter.</span><span>
</span><a name="line-82"></a><span class="hs-keyword">data</span><span> </span><a name="InterpreterRes"><a href="Michelson.Runtime.html#InterpreterRes"><span class="hs-identifier">InterpreterRes</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="InterpreterRes"><a href="Michelson.Runtime.html#InterpreterRes"><span class="hs-identifier">InterpreterRes</span></a></a><span>
</span><a name="line-83"></a><span>  </span><span class="hs-special">{</span><span> </span><a name="_irGState"><a href="Michelson.Runtime.html#_irGState"><span class="hs-identifier">_irGState</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="Michelson.Runtime.GState.html#GState"><span class="hs-identifier hs-type">GState</span></a><span>
</span><a name="line-84"></a><span>  </span><span class="hs-comment">-- ^ New 'GState'.</span><span>
</span><a name="line-85"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="_irOperations"><a href="Michelson.Runtime.html#_irOperations"><span class="hs-identifier">_irOperations</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Michelson.Runtime.html#InterpreterOp"><span class="hs-identifier hs-type">InterpreterOp</span></a><span class="hs-special">]</span><span>
</span><a name="line-86"></a><span>  </span><span class="hs-comment">-- ^ List of operations to be added to the operations queue.</span><span>
</span><a name="line-87"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="_irUpdates"><a href="Michelson.Runtime.html#_irUpdates"><span class="hs-identifier">_irUpdates</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">[</span><a href="Michelson.Runtime.GState.html#GStateUpdate"><span class="hs-identifier hs-type">GStateUpdate</span></a><span class="hs-special">]</span><span>
</span><a name="line-88"></a><span>  </span><span class="hs-comment">-- ^ Updates applied to 'GState'.</span><span>
</span><a name="line-89"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="_irInterpretResults"><a href="Michelson.Runtime.html#_irInterpretResults"><span class="hs-identifier">_irInterpretResults</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Tezos.Address.html#Address"><span class="hs-identifier hs-type">Address</span></a><span class="hs-special">,</span><span> </span><a href="Michelson.Interpret.html#InterpretResult"><span class="hs-identifier hs-type">InterpretResult</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-90"></a><span>  </span><span class="hs-comment">-- ^ During execution a contract can print logs and in the end it returns</span><span>
</span><a name="line-91"></a><span>  </span><span class="hs-comment">-- a pair. All logs and returned values are kept until all called contracts</span><span>
</span><a name="line-92"></a><span>  </span><span class="hs-comment">-- are executed. In the end they are printed.</span><span>
</span><a name="line-93"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="_irSourceAddress"><a href="Michelson.Runtime.html#_irSourceAddress"><span class="hs-identifier">_irSourceAddress</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Tezos.Address.html#Address"><span class="hs-identifier hs-type">Address</span></a><span class="hs-special">)</span><span>
</span><a name="line-94"></a><span>  </span><span class="hs-comment">-- ^ As soon as transfer operation is encountered, this address is</span><span>
</span><a name="line-95"></a><span>  </span><span class="hs-comment">-- set to its input.</span><span>
</span><a name="line-96"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="_irRemainingSteps"><a href="Michelson.Runtime.html#_irRemainingSteps"><span class="hs-identifier">_irRemainingSteps</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="Michelson.Interpret.html#RemainingSteps"><span class="hs-identifier hs-type">RemainingSteps</span></a><span>
</span><a name="line-97"></a><span>  </span><span class="hs-comment">-- ^ Now much gas all remaining executions can consume.</span><span>
</span><a name="line-98"></a><span>  </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">)</span><span>
</span><a name="line-99"></a><span>
</span><a name="line-100"></a><span class="hs-identifier hs-var">makeLenses</span><span> </span><span class="hs-special">''</span><span class="hs-identifier hs-var">InterpreterRes</span><span>
</span><a name="line-101"></a><span>
</span><a name="line-102"></a><span class="hs-comment">-- Note that it's not commutative.</span><span>
</span><a name="line-103"></a><span class="hs-comment">-- It applies to the case when we have some InterpreterRes already</span><span>
</span><a name="line-104"></a><span class="hs-comment">-- and get a new one after performing some operations.</span><span>
</span><a name="line-105"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Semigroup</span><span> </span><a href="Michelson.Runtime.html#InterpreterRes"><span class="hs-identifier hs-type">InterpreterRes</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-106"></a><span>  </span><a name="local-6989586621680577628"><a href="#local-6989586621680577628"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-3458764513820541482"><span class="hs-operator">&lt;&gt;</span></a><span> </span><a name="local-6989586621680577629"><a href="#local-6989586621680577629"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-107"></a><span>    </span><a href="#local-6989586621680577629"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-108"></a><span>      </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">_irUpdates</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">_irUpdates</span><span> </span><a href="#local-6989586621680577628"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier">_irUpdates</span><span> </span><a href="#local-6989586621680577629"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-109"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_irInterpretResults</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">_irInterpretResults</span><span> </span><a href="#local-6989586621680577628"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier">_irInterpretResults</span><span> </span><a href="#local-6989586621680577629"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-110"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_irSourceAddress</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">_irSourceAddress</span><span> </span><a href="#local-6989586621680577628"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-operator hs-var">&lt;|&gt;</span><span> </span><span class="hs-identifier">_irSourceAddress</span><span> </span><a href="#local-6989586621680577629"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-111"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-112"></a><span>
</span><a name="line-113"></a><span class="hs-comment">-- | Errors that can happen during contract interpreting.</span><span>
</span><a name="line-114"></a><span class="hs-comment">-- Type parameter @a@ determines how contracts will be represented</span><span>
</span><a name="line-115"></a><span class="hs-comment">-- in these errors, e.g. @Address@</span><span>
</span><a name="line-116"></a><span class="hs-keyword">data</span><span> </span><a name="InterpreterError%27"><a href="Michelson.Runtime.html#InterpreterError%27"><span class="hs-identifier">InterpreterError'</span></a></a><span> </span><a name="local-6989586621680577612"><a href="#local-6989586621680577612"><span class="hs-identifier">a</span></a></a><span>
</span><a name="line-117"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="IEUnknownContract"><a href="Michelson.Runtime.html#IEUnknownContract"><span class="hs-identifier">IEUnknownContract</span></a></a><span> </span><span class="hs-glyph">!</span><a href="#local-6989586621680577612"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-118"></a><span>  </span><span class="hs-comment">-- ^ The interpreted contract hasn't been originated.</span><span>
</span><a name="line-119"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="IEInterpreterFailed"><a href="Michelson.Runtime.html#IEInterpreterFailed"><span class="hs-identifier">IEInterpreterFailed</span></a></a><span> </span><span class="hs-glyph">!</span><a href="#local-6989586621680577612"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-120"></a><span>                        </span><span class="hs-glyph">!</span><a href="Michelson.Interpret.html#InterpretError"><span class="hs-identifier hs-type">InterpretError</span></a><span>
</span><a name="line-121"></a><span>  </span><span class="hs-comment">-- ^ Interpretation of Michelson contract failed.</span><span>
</span><a name="line-122"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="IEAlreadyOriginated"><a href="Michelson.Runtime.html#IEAlreadyOriginated"><span class="hs-identifier">IEAlreadyOriginated</span></a></a><span> </span><span class="hs-glyph">!</span><a href="#local-6989586621680577612"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-123"></a><span>                        </span><span class="hs-glyph">!</span><a href="Michelson.Runtime.GState.html#ContractState"><span class="hs-identifier hs-type">ContractState</span></a><span>
</span><a name="line-124"></a><span>  </span><span class="hs-comment">-- ^ A contract is already originated.</span><span>
</span><a name="line-125"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="IEUnknownSender"><a href="Michelson.Runtime.html#IEUnknownSender"><span class="hs-identifier">IEUnknownSender</span></a></a><span> </span><span class="hs-glyph">!</span><a href="#local-6989586621680577612"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-126"></a><span>  </span><span class="hs-comment">-- ^ Sender address is unknown.</span><span>
</span><a name="line-127"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="IEUnknownManager"><a href="Michelson.Runtime.html#IEUnknownManager"><span class="hs-identifier">IEUnknownManager</span></a></a><span> </span><span class="hs-glyph">!</span><a href="#local-6989586621680577612"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-128"></a><span>  </span><span class="hs-comment">-- ^ Manager address is unknown.</span><span>
</span><a name="line-129"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="IENotEnoughFunds"><a href="Michelson.Runtime.html#IENotEnoughFunds"><span class="hs-identifier">IENotEnoughFunds</span></a></a><span> </span><span class="hs-glyph">!</span><a href="#local-6989586621680577612"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">!</span><a href="Tezos.Core.html#Mutez"><span class="hs-identifier hs-type">Mutez</span></a><span>
</span><a name="line-130"></a><span>  </span><span class="hs-comment">-- ^ Sender doesn't have enough funds.</span><span>
</span><a name="line-131"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="IEFailedToApplyUpdates"><a href="Michelson.Runtime.html#IEFailedToApplyUpdates"><span class="hs-identifier">IEFailedToApplyUpdates</span></a></a><span> </span><span class="hs-glyph">!</span><a href="Michelson.Runtime.GState.html#GStateUpdateError"><span class="hs-identifier hs-type">GStateUpdateError</span></a><span>
</span><a name="line-132"></a><span>  </span><span class="hs-comment">-- ^ Failed to apply updates to GState.</span><span>
</span><a name="line-133"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="IEIllTypedContract"><a href="Michelson.Runtime.html#IEIllTypedContract"><span class="hs-identifier">IEIllTypedContract</span></a></a><span> </span><span class="hs-glyph">!</span><a href="Michelson.TypeCheck.Error.html#TCError"><span class="hs-identifier hs-type">TCError</span></a><span>
</span><a name="line-134"></a><span>  </span><span class="hs-comment">-- ^ A contract is ill-typed.</span><span>
</span><a name="line-135"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="IEIllTypedStorage"><a href="Michelson.Runtime.html#IEIllTypedStorage"><span class="hs-identifier">IEIllTypedStorage</span></a></a><span> </span><span class="hs-glyph">!</span><a href="Michelson.TypeCheck.Error.html#TCError"><span class="hs-identifier hs-type">TCError</span></a><span>
</span><a name="line-136"></a><span>  </span><span class="hs-comment">-- ^ Contract storage is ill-typed</span><span>
</span><a name="line-137"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="IEIllTypedParameter"><a href="Michelson.Runtime.html#IEIllTypedParameter"><span class="hs-identifier">IEIllTypedParameter</span></a></a><span> </span><span class="hs-glyph">!</span><a href="Michelson.TypeCheck.Error.html#TCError"><span class="hs-identifier hs-type">TCError</span></a><span>
</span><a name="line-138"></a><span>  </span><span class="hs-comment">-- ^ Contract parameter is ill-typed</span><span>
</span><a name="line-139"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">)</span><span>
</span><a name="line-140"></a><span>
</span><a name="line-141"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Buildable</span><span> </span><a href="#local-6989586621680577614"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Buildable</span><span> </span><span class="hs-special">(</span><a href="Michelson.Runtime.html#InterpreterError%27"><span class="hs-identifier hs-type">InterpreterError'</span></a><span> </span><a href="#local-6989586621680577614"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-142"></a><span>  </span><a name="local-8214565720323800704"><span class="hs-identifier">build</span></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-143"></a><span>    </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><a name="line-144"></a><span>      </span><a href="Michelson.Runtime.html#IEUnknownContract"><span class="hs-identifier hs-var">IEUnknownContract</span></a><span> </span><a name="local-6989586621680577615"><a href="#local-6989586621680577615"><span class="hs-identifier">addr</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-string">&quot;The contract is not originated &quot;</span><span> </span><span class="hs-operator hs-var">+|</span><span> </span><a href="#local-6989586621680577615"><span class="hs-identifier hs-var">addr</span></a><span> </span><span class="hs-operator hs-var">|+</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-145"></a><span>      </span><a href="Michelson.Runtime.html#IEInterpreterFailed"><span class="hs-identifier hs-var">IEInterpreterFailed</span></a><span> </span><a name="local-6989586621680577616"><a href="#local-6989586621680577616"><span class="hs-identifier">addr</span></a></a><span> </span><a name="local-6989586621680577617"><a href="#local-6989586621680577617"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-146"></a><span>        </span><span class="hs-string">&quot;Michelson interpreter failed for contract &quot;</span><span> </span><span class="hs-operator hs-var">+|</span><span> </span><a href="#local-6989586621680577616"><span class="hs-identifier hs-var">addr</span></a><span> </span><span class="hs-operator hs-var">|+</span><span> </span><span class="hs-string">&quot;: &quot;</span><span> </span><span class="hs-operator hs-var">+|</span><span> </span><a href="#local-6989586621680577617"><span class="hs-identifier hs-var">err</span></a><span> </span><span class="hs-operator hs-var">|+</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-147"></a><span>      </span><a href="Michelson.Runtime.html#IEAlreadyOriginated"><span class="hs-identifier hs-var">IEAlreadyOriginated</span></a><span> </span><a name="local-6989586621680577618"><a href="#local-6989586621680577618"><span class="hs-identifier">addr</span></a></a><span> </span><a name="local-6989586621680577619"><a href="#local-6989586621680577619"><span class="hs-identifier">cs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-148"></a><span>        </span><span class="hs-string">&quot;The following contract is already originated: &quot;</span><span> </span><span class="hs-operator hs-var">+|</span><span> </span><a href="#local-6989586621680577618"><span class="hs-identifier hs-var">addr</span></a><span> </span><span class="hs-operator hs-var">|+</span><span>
</span><a name="line-149"></a><span>        </span><span class="hs-string">&quot;, &quot;</span><span> </span><span class="hs-operator hs-var">+|</span><span> </span><a href="#local-6989586621680577619"><span class="hs-identifier hs-var">cs</span></a><span> </span><span class="hs-operator hs-var">|+</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-150"></a><span>      </span><a href="Michelson.Runtime.html#IEUnknownSender"><span class="hs-identifier hs-var">IEUnknownSender</span></a><span> </span><a name="local-6989586621680577620"><a href="#local-6989586621680577620"><span class="hs-identifier">addr</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-string">&quot;The sender address is unknown &quot;</span><span> </span><span class="hs-operator hs-var">+|</span><span> </span><a href="#local-6989586621680577620"><span class="hs-identifier hs-var">addr</span></a><span> </span><span class="hs-operator hs-var">|+</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-151"></a><span>      </span><a href="Michelson.Runtime.html#IEUnknownManager"><span class="hs-identifier hs-var">IEUnknownManager</span></a><span> </span><a name="local-6989586621680577621"><a href="#local-6989586621680577621"><span class="hs-identifier">addr</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-string">&quot;The manager address is unknown &quot;</span><span> </span><span class="hs-operator hs-var">+|</span><span> </span><a href="#local-6989586621680577621"><span class="hs-identifier hs-var">addr</span></a><span> </span><span class="hs-operator hs-var">|+</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-152"></a><span>      </span><a href="Michelson.Runtime.html#IENotEnoughFunds"><span class="hs-identifier hs-var">IENotEnoughFunds</span></a><span> </span><a name="local-6989586621680577622"><a href="#local-6989586621680577622"><span class="hs-identifier">addr</span></a></a><span> </span><a name="local-6989586621680577623"><a href="#local-6989586621680577623"><span class="hs-identifier">amount</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-153"></a><span>        </span><span class="hs-string">&quot;The sender (&quot;</span><span> </span><span class="hs-operator hs-var">+|</span><span> </span><a href="#local-6989586621680577622"><span class="hs-identifier hs-var">addr</span></a><span> </span><span class="hs-operator hs-var">|+</span><span>
</span><a name="line-154"></a><span>        </span><span class="hs-string">&quot;) doesn't  have enough funds (has only &quot;</span><span> </span><span class="hs-operator hs-var">+|</span><span> </span><a href="#local-6989586621680577623"><span class="hs-identifier hs-var">amount</span></a><span> </span><span class="hs-operator hs-var">|+</span><span> </span><span class="hs-string">&quot;)&quot;</span><span>
</span><a name="line-155"></a><span>      </span><a href="Michelson.Runtime.html#IEFailedToApplyUpdates"><span class="hs-identifier hs-var">IEFailedToApplyUpdates</span></a><span> </span><a name="local-6989586621680577624"><a href="#local-6989586621680577624"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-string">&quot;Failed to update GState: &quot;</span><span> </span><span class="hs-operator hs-var">+|</span><span> </span><a href="#local-6989586621680577624"><span class="hs-identifier hs-var">err</span></a><span> </span><span class="hs-operator hs-var">|+</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-156"></a><span>      </span><a href="Michelson.Runtime.html#IEIllTypedContract"><span class="hs-identifier hs-var">IEIllTypedContract</span></a><span> </span><a name="local-6989586621680577625"><a href="#local-6989586621680577625"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-string">&quot;The contract is ill-typed: &quot;</span><span> </span><span class="hs-operator hs-var">+|</span><span> </span><a href="#local-6989586621680577625"><span class="hs-identifier hs-var">err</span></a><span> </span><span class="hs-operator hs-var">|+</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-157"></a><span>      </span><a href="Michelson.Runtime.html#IEIllTypedStorage"><span class="hs-identifier hs-var">IEIllTypedStorage</span></a><span> </span><a name="local-6989586621680577626"><a href="#local-6989586621680577626"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-string">&quot;The contract storage is ill-typed: &quot;</span><span> </span><span class="hs-operator hs-var">+|</span><span> </span><a href="#local-6989586621680577626"><span class="hs-identifier hs-var">err</span></a><span> </span><span class="hs-operator hs-var">|+</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-158"></a><span>      </span><a href="Michelson.Runtime.html#IEIllTypedParameter"><span class="hs-identifier hs-var">IEIllTypedParameter</span></a><span> </span><a name="local-6989586621680577627"><a href="#local-6989586621680577627"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-string">&quot;The contract parameter is ill-typed: &quot;</span><span> </span><span class="hs-operator hs-var">+|</span><span> </span><a href="#local-6989586621680577627"><span class="hs-identifier hs-var">err</span></a><span> </span><span class="hs-operator hs-var">|+</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-159"></a><span>
</span><a name="line-160"></a><span class="hs-keyword">type</span><span> </span><a name="InterpreterError"><a href="Michelson.Runtime.html#InterpreterError"><span class="hs-identifier">InterpreterError</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Michelson.Runtime.html#InterpreterError%27"><span class="hs-identifier hs-type">InterpreterError'</span></a><span> </span><a href="Tezos.Address.html#Address"><span class="hs-identifier hs-type">Address</span></a><span>
</span><a name="line-161"></a><span>
</span><a name="line-162"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Typeable</span><span> </span><a href="#local-6989586621680577613"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Show</span><span> </span><a href="#local-6989586621680577613"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Buildable</span><span> </span><a href="#local-6989586621680577613"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Exception</span><span> </span><span class="hs-special">(</span><a href="Michelson.Runtime.html#InterpreterError%27"><span class="hs-identifier hs-type">InterpreterError'</span></a><span> </span><a href="#local-6989586621680577613"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-163"></a><span>  </span><a name="local-8214565720323791248"><span class="hs-identifier">displayException</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pretty</span><span>
</span><a name="line-164"></a><span>
</span><a name="line-165"></a><span class="hs-comment">----------------------------------------------------------------------------</span><span>
</span><a name="line-166"></a><span class="hs-comment">-- Interface</span><span>
</span><a name="line-167"></a><span class="hs-comment">----------------------------------------------------------------------------</span><span>
</span><a name="line-168"></a><span>
</span><a name="line-169"></a><span class="hs-comment">-- | Parse a contract from 'Text'.</span><span>
</span><a name="line-170"></a><span class="hs-identifier">parseContract</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-171"></a><span>     </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Either</span><span> </span><a href="Michelson.Parser.Error.html#ParserException"><span class="hs-identifier hs-type">P.ParserException</span></a><span> </span><span class="hs-special">(</span><a href="Michelson.Untyped.Contract.html#Contract%27"><span class="hs-identifier hs-type">U.Contract'</span></a><span> </span><a href="Michelson.Macro.html#ParsedOp"><span class="hs-identifier hs-type">ParsedOp</span></a><span class="hs-special">)</span><span>
</span><a name="line-172"></a><a name="parseContract"><a href="Michelson.Runtime.html#parseContract"><span class="hs-identifier">parseContract</span></a></a><span> </span><a name="local-6989586621680577630"><a href="#local-6989586621680577630"><span class="hs-identifier">mFileName</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-173"></a><span>  </span><span class="hs-identifier hs-var">first</span><span> </span><a href="Michelson.Parser.Error.html#ParserException"><span class="hs-identifier hs-var">P.ParserException</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">parse</span><span> </span><a href="Michelson.Parser.html#program"><span class="hs-identifier hs-var">P.program</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><span class="hs-string">&quot;&lt;stdin&gt;&quot;</span><span> </span><a href="#local-6989586621680577630"><span class="hs-identifier hs-var">mFileName</span></a><span class="hs-special">)</span><span>
</span><a name="line-174"></a><span>
</span><a name="line-175"></a><span class="hs-comment">-- | Parse a contract from 'Text' and expand macros.</span><span>
</span><a name="line-176"></a><span class="hs-identifier">parseExpandContract</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-177"></a><span>     </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Either</span><span> </span><a href="Michelson.Parser.Error.html#ParserException"><span class="hs-identifier hs-type">P.ParserException</span></a><span> </span><a href="Michelson.Untyped.Aliases.html#Contract"><span class="hs-identifier hs-type">Contract</span></a><span>
</span><a name="line-178"></a><a name="parseExpandContract"><a href="Michelson.Runtime.html#parseExpandContract"><span class="hs-identifier">parseExpandContract</span></a></a><span> </span><a name="local-6989586621680577631"><a href="#local-6989586621680577631"><span class="hs-identifier">mFileName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><a href="Michelson.Macro.html#expandContract"><span class="hs-identifier hs-var">expandContract</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Michelson.Runtime.html#parseContract"><span class="hs-identifier hs-var">parseContract</span></a><span> </span><a href="#local-6989586621680577631"><span class="hs-identifier hs-var">mFileName</span></a><span>
</span><a name="line-179"></a><span>
</span><a name="line-180"></a><span class="hs-comment">-- | Read and parse a contract from give path or `stdin` (if the</span><span>
</span><a name="line-181"></a><span class="hs-comment">-- argument is 'Nothing'). The contract is not expanded.</span><span>
</span><a name="line-182"></a><span class="hs-identifier">readAndParseContract</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="Michelson.Untyped.Contract.html#Contract%27"><span class="hs-identifier hs-type">U.Contract'</span></a><span> </span><a href="Michelson.Macro.html#ParsedOp"><span class="hs-identifier hs-type">ParsedOp</span></a><span class="hs-special">)</span><span>
</span><a name="line-183"></a><a name="readAndParseContract"><a href="Michelson.Runtime.html#readAndParseContract"><span class="hs-identifier">readAndParseContract</span></a></a><span> </span><a name="local-6989586621680577632"><a href="#local-6989586621680577632"><span class="hs-identifier">mFilename</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-184"></a><span>  </span><a name="local-6989586621680577634"><a href="#local-6989586621680577634"><span class="hs-identifier">code</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680577633"><span class="hs-identifier hs-var">readCode</span></a><span> </span><a href="#local-6989586621680577632"><span class="hs-identifier hs-var">mFilename</span></a><span>
</span><a name="line-185"></a><span>  </span><span class="hs-identifier hs-var">either</span><span> </span><span class="hs-identifier hs-var">throwM</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Michelson.Runtime.html#parseContract"><span class="hs-identifier hs-var">parseContract</span></a><span> </span><a href="#local-6989586621680577632"><span class="hs-identifier hs-var">mFilename</span></a><span> </span><a href="#local-6989586621680577634"><span class="hs-identifier hs-var">code</span></a><span>
</span><a name="line-186"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-187"></a><span>    </span><span class="hs-identifier">readCode</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">Text</span><span>
</span><a name="line-188"></a><span>    </span><a name="local-6989586621680577633"><a href="#local-6989586621680577633"><span class="hs-identifier">readCode</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-identifier hs-var">getContents</span><span> </span><a href="Util.IO.html#readFileUtf8"><span class="hs-identifier hs-var">readFileUtf8</span></a><span>
</span><a name="line-189"></a><span>
</span><a name="line-190"></a><span class="hs-comment">-- | Read a contract using 'readAndParseContract', expand and</span><span>
</span><a name="line-191"></a><span class="hs-comment">-- flatten. The contract is not type checked.</span><span>
</span><a name="line-192"></a><span class="hs-identifier">prepareContract</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Michelson.Untyped.Aliases.html#Contract"><span class="hs-identifier hs-type">Contract</span></a><span>
</span><a name="line-193"></a><a name="prepareContract"><a href="Michelson.Runtime.html#prepareContract"><span class="hs-identifier">prepareContract</span></a></a><span> </span><a name="local-6989586621680577635"><a href="#local-6989586621680577635"><span class="hs-identifier">mFile</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Michelson.Macro.html#expandContract"><span class="hs-identifier hs-var">expandContract</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Michelson.Runtime.html#readAndParseContract"><span class="hs-identifier hs-var">readAndParseContract</span></a><span> </span><a href="#local-6989586621680577635"><span class="hs-identifier hs-var">mFile</span></a><span>
</span><a name="line-194"></a><span>
</span><a name="line-195"></a><span class="hs-comment">-- | Originate a contract. Returns the address of the originated</span><span>
</span><a name="line-196"></a><span class="hs-comment">-- contract.</span><span>
</span><a name="line-197"></a><span class="hs-identifier">originateContract</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-198"></a><span>     </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Michelson.Untyped.Instr.html#OriginationOperation"><span class="hs-identifier hs-type">OriginationOperation</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-string">&quot;verbose&quot;</span><span> </span><span class="hs-operator hs-type">:!</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Tezos.Address.html#Address"><span class="hs-identifier hs-type">Address</span></a><span>
</span><a name="line-199"></a><a name="originateContract"><a href="Michelson.Runtime.html#originateContract"><span class="hs-identifier">originateContract</span></a></a><span> </span><a name="local-6989586621680577636"><a href="#local-6989586621680577636"><span class="hs-identifier">dbPath</span></a></a><span> </span><a name="local-6989586621680577637"><a href="#local-6989586621680577637"><span class="hs-identifier">origination</span></a></a><span> </span><a name="local-6989586621680577638"><a href="#local-6989586621680577638"><span class="hs-identifier">verbose</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-200"></a><span>  </span><span class="hs-comment">-- pass 100500 as maxSteps, because it doesn't matter for origination,</span><span>
</span><a name="line-201"></a><span>  </span><span class="hs-comment">-- as well as 'now'</span><span>
</span><a name="line-202"></a><span>  </span><a href="Michelson.Untyped.Instr.html#mkContractAddress"><span class="hs-identifier hs-var">mkContractAddress</span></a><span> </span><a href="#local-6989586621680577637"><span class="hs-identifier hs-var">origination</span></a><span> </span><span class="hs-operator hs-var">&lt;$</span><span>
</span><a name="line-203"></a><span>  </span><a href="Michelson.Runtime.html#interpreter"><span class="hs-identifier hs-var">interpreter</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-number">100500</span><span> </span><a href="#local-6989586621680577636"><span class="hs-identifier hs-var">dbPath</span></a><span> </span><span class="hs-special">[</span><a href="Michelson.Runtime.html#OriginateOp"><span class="hs-identifier hs-var">OriginateOp</span></a><span> </span><a href="#local-6989586621680577637"><span class="hs-identifier hs-var">origination</span></a><span class="hs-special">]</span><span> </span><a href="#local-6989586621680577638"><span class="hs-identifier hs-var">verbose</span></a><span>
</span><a name="line-204"></a><span>  </span><span class="hs-glyph">!</span><span> </span><span class="hs-identifier hs-var">defaults</span><span>
</span><a name="line-205"></a><span>
</span><a name="line-206"></a><span class="hs-comment">-- | Run a contract. The contract is originated first (if it's not</span><span>
</span><a name="line-207"></a><span class="hs-comment">-- already) and then we pretend that we send a transaction to it.</span><span>
</span><a name="line-208"></a><span class="hs-identifier">runContract</span><span>
</span><a name="line-209"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Tezos.Core.html#Timestamp"><span class="hs-identifier hs-type">Timestamp</span></a><span>
</span><a name="line-210"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Word64</span><span>
</span><a name="line-211"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Tezos.Core.html#Mutez"><span class="hs-identifier hs-type">Mutez</span></a><span>
</span><a name="line-212"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span>
</span><a name="line-213"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Michelson.Untyped.Aliases.html#Value"><span class="hs-identifier hs-type">U.Value</span></a><span>
</span><a name="line-214"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Michelson.Untyped.Aliases.html#Contract"><span class="hs-identifier hs-type">Contract</span></a><span>
</span><a name="line-215"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Michelson.Runtime.TxData.html#TxData"><span class="hs-identifier hs-type">TxData</span></a><span>
</span><a name="line-216"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-string">&quot;verbose&quot;</span><span> </span><span class="hs-operator hs-type">:!</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-217"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-string">&quot;dryRun&quot;</span><span> </span><span class="hs-operator hs-type">:!</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-218"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-219"></a><a name="runContract"><a href="Michelson.Runtime.html#runContract"><span class="hs-identifier">runContract</span></a></a><span> </span><a name="local-6989586621680577639"><a href="#local-6989586621680577639"><span class="hs-identifier">maybeNow</span></a></a><span> </span><a name="local-6989586621680577640"><a href="#local-6989586621680577640"><span class="hs-identifier">maxSteps</span></a></a><span> </span><a name="local-6989586621680577641"><a href="#local-6989586621680577641"><span class="hs-identifier">initBalance</span></a></a><span> </span><a name="local-6989586621680577642"><a href="#local-6989586621680577642"><span class="hs-identifier">dbPath</span></a></a><span> </span><a name="local-6989586621680577643"><a href="#local-6989586621680577643"><span class="hs-identifier">storageValue</span></a></a><span> </span><a name="local-6989586621680577644"><a href="#local-6989586621680577644"><span class="hs-identifier">contract</span></a></a><span> </span><a name="local-6989586621680577645"><a href="#local-6989586621680577645"><span class="hs-identifier">txData</span></a></a><span>
</span><a name="line-220"></a><span>  </span><a name="local-6989586621680577646"><a href="#local-6989586621680577646"><span class="hs-identifier">verbose</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">arg</span><span> </span><span class="">#dryRun</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a name="local-6989586621680577647"><a href="#local-6989586621680577647"><span class="hs-identifier">dryRun</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-221"></a><span>  </span><a href="Michelson.Runtime.html#interpreter"><span class="hs-identifier hs-var">interpreter</span></a><span> </span><a href="#local-6989586621680577639"><span class="hs-identifier hs-var">maybeNow</span></a><span> </span><a href="#local-6989586621680577640"><span class="hs-identifier hs-var">maxSteps</span></a><span> </span><a href="#local-6989586621680577642"><span class="hs-identifier hs-var">dbPath</span></a><span> </span><a href="#local-6989586621680577651"><span class="hs-identifier hs-var">operations</span></a><span> </span><a href="#local-6989586621680577646"><span class="hs-identifier hs-var">verbose</span></a><span> </span><span class="hs-glyph">!</span><span> </span><span class="">#dryRun</span><span> </span><a href="#local-6989586621680577647"><span class="hs-identifier hs-var">dryRun</span></a><span>
</span><a name="line-222"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-223"></a><span>    </span><span class="hs-comment">-- We hardcode some random key hash here as delegate to make sure that:</span><span>
</span><a name="line-224"></a><span>    </span><span class="hs-comment">-- 1. Contract's address won't clash with already originated one (because</span><span>
</span><a name="line-225"></a><span>    </span><span class="hs-comment">-- it may have different storage value which may be confusing).</span><span>
</span><a name="line-226"></a><span>    </span><span class="hs-comment">-- 2. If one uses this functionality twice with the same contract and</span><span>
</span><a name="line-227"></a><span>    </span><span class="hs-comment">-- other data, the contract will have the same address.</span><span>
</span><a name="line-228"></a><span>    </span><a name="local-6989586621680577648"><a href="#local-6989586621680577648"><span class="hs-identifier">delegate</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-229"></a><span>      </span><span class="hs-identifier hs-var">either</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">mappend</span><span> </span><span class="hs-string">&quot;runContract can't parse delegate: &quot;</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">pretty</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">id</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-230"></a><span>      </span><a href="Tezos.Crypto.html#parseKeyHash"><span class="hs-identifier hs-var">parseKeyHash</span></a><span> </span><span class="hs-string">&quot;tz1YCABRTa6H8PLKx2EtDWeCGPaKxUhNgv47&quot;</span><span>
</span><a name="line-231"></a><span>    </span><a name="local-6989586621680577649"><a href="#local-6989586621680577649"><span class="hs-identifier">origination</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Michelson.Untyped.Instr.html#OriginationOperation"><span class="hs-identifier hs-var">OriginationOperation</span></a><span>
</span><a name="line-232"></a><span>      </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ooManager</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Michelson.Runtime.GState.html#genesisKeyHash"><span class="hs-identifier hs-var">genesisKeyHash</span></a><span>
</span><a name="line-233"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ooDelegate</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621680577648"><span class="hs-identifier hs-var">delegate</span></a><span>
</span><a name="line-234"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ooSpendable</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-235"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ooDelegatable</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-236"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ooBalance</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680577641"><span class="hs-identifier hs-var">initBalance</span></a><span>
</span><a name="line-237"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ooStorage</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680577643"><span class="hs-identifier hs-var">storageValue</span></a><span>
</span><a name="line-238"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ooContract</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680577644"><span class="hs-identifier hs-var">contract</span></a><span>
</span><a name="line-239"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-240"></a><span>    </span><a name="local-6989586621680577650"><a href="#local-6989586621680577650"><span class="hs-identifier">addr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Michelson.Untyped.Instr.html#mkContractAddress"><span class="hs-identifier hs-var">mkContractAddress</span></a><span> </span><a href="#local-6989586621680577649"><span class="hs-identifier hs-var">origination</span></a><span>
</span><a name="line-241"></a><span>    </span><a name="local-6989586621680577651"><a href="#local-6989586621680577651"><span class="hs-identifier">operations</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-242"></a><span>      </span><span class="hs-special">[</span><span> </span><a href="Michelson.Runtime.html#OriginateOp"><span class="hs-identifier hs-var">OriginateOp</span></a><span> </span><a href="#local-6989586621680577649"><span class="hs-identifier hs-var">origination</span></a><span>
</span><a name="line-243"></a><span>      </span><span class="hs-special">,</span><span> </span><a href="Michelson.Runtime.html#TransferOp"><span class="hs-identifier hs-var">TransferOp</span></a><span> </span><a href="#local-6989586621680577650"><span class="hs-identifier hs-var">addr</span></a><span> </span><a href="#local-6989586621680577645"><span class="hs-identifier hs-var">txData</span></a><span>
</span><a name="line-244"></a><span>      </span><span class="hs-special">]</span><span>
</span><a name="line-245"></a><span>
</span><a name="line-246"></a><span class="hs-comment">-- | Send a transaction to given address with given parameters.</span><span>
</span><a name="line-247"></a><span class="hs-identifier">transfer</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-248"></a><span>     </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Tezos.Core.html#Timestamp"><span class="hs-identifier hs-type">Timestamp</span></a><span>
</span><a name="line-249"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Word64</span><span>
</span><a name="line-250"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span>
</span><a name="line-251"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Tezos.Address.html#Address"><span class="hs-identifier hs-type">Address</span></a><span>
</span><a name="line-252"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Michelson.Runtime.TxData.html#TxData"><span class="hs-identifier hs-type">TxData</span></a><span>
</span><a name="line-253"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-string">&quot;verbose&quot;</span><span> </span><span class="hs-operator hs-type">:!</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-string">&quot;dryRun&quot;</span><span> </span><span class="hs-operator hs-type">:?</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-254"></a><a name="transfer"><a href="Michelson.Runtime.html#transfer"><span class="hs-identifier">transfer</span></a></a><span> </span><a name="local-6989586621680577652"><a href="#local-6989586621680577652"><span class="hs-identifier">maybeNow</span></a></a><span> </span><a name="local-6989586621680577653"><a href="#local-6989586621680577653"><span class="hs-identifier">maxSteps</span></a></a><span> </span><a name="local-6989586621680577654"><a href="#local-6989586621680577654"><span class="hs-identifier">dbPath</span></a></a><span> </span><a name="local-6989586621680577655"><a href="#local-6989586621680577655"><span class="hs-identifier">destination</span></a></a><span> </span><a name="local-6989586621680577656"><a href="#local-6989586621680577656"><span class="hs-identifier">txData</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-255"></a><span>  </span><a href="Michelson.Runtime.html#interpreter"><span class="hs-identifier hs-var">interpreter</span></a><span> </span><a href="#local-6989586621680577652"><span class="hs-identifier hs-var">maybeNow</span></a><span> </span><a href="#local-6989586621680577653"><span class="hs-identifier hs-var">maxSteps</span></a><span> </span><a href="#local-6989586621680577654"><span class="hs-identifier hs-var">dbPath</span></a><span> </span><span class="hs-special">[</span><a href="Michelson.Runtime.html#TransferOp"><span class="hs-identifier hs-var">TransferOp</span></a><span> </span><a href="#local-6989586621680577655"><span class="hs-identifier hs-var">destination</span></a><span> </span><a href="#local-6989586621680577656"><span class="hs-identifier hs-var">txData</span></a><span class="hs-special">]</span><span>
</span><a name="line-256"></a><span>
</span><a name="line-257"></a><span class="hs-comment">----------------------------------------------------------------------------</span><span>
</span><a name="line-258"></a><span class="hs-comment">-- Interpreter</span><span>
</span><a name="line-259"></a><span class="hs-comment">----------------------------------------------------------------------------</span><span>
</span><a name="line-260"></a><span>
</span><a name="line-261"></a><span class="hs-comment">-- | Interpret a contract on some global state (read from file) and</span><span>
</span><a name="line-262"></a><span class="hs-comment">-- transaction data (passed explicitly).</span><span>
</span><a name="line-263"></a><span class="hs-identifier">interpreter</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-264"></a><span>     </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Tezos.Core.html#Timestamp"><span class="hs-identifier hs-type">Timestamp</span></a><span>
</span><a name="line-265"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Word64</span><span>
</span><a name="line-266"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span>
</span><a name="line-267"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Michelson.Runtime.html#InterpreterOp"><span class="hs-identifier hs-type">InterpreterOp</span></a><span class="hs-special">]</span><span>
</span><a name="line-268"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-string">&quot;verbose&quot;</span><span> </span><span class="hs-operator hs-type">:!</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-string">&quot;dryRun&quot;</span><span> </span><span class="hs-operator hs-type">:?</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-269"></a><a name="interpreter"><a href="Michelson.Runtime.html#interpreter"><span class="hs-identifier">interpreter</span></a></a><span> </span><a name="local-6989586621680577657"><a href="#local-6989586621680577657"><span class="hs-identifier">maybeNow</span></a></a><span> </span><a name="local-6989586621680577658"><a href="#local-6989586621680577658"><span class="hs-identifier">maxSteps</span></a></a><span> </span><a name="local-6989586621680577659"><a href="#local-6989586621680577659"><span class="hs-identifier">dbPath</span></a></a><span> </span><a name="local-6989586621680577660"><a href="#local-6989586621680577660"><span class="hs-identifier">operations</span></a></a><span>
</span><a name="line-270"></a><span>  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">arg</span><span> </span><span class="">#verbose</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a name="local-6989586621680577661"><a href="#local-6989586621680577661"><span class="hs-identifier">verbose</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-271"></a><span>  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">argDef</span><span> </span><span class="">#dryRun</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a name="local-6989586621680577662"><a href="#local-6989586621680577662"><span class="hs-identifier">dryRun</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-272"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-273"></a><span>  </span><a name="local-6989586621680577669"><a href="#local-6989586621680577669"><span class="hs-identifier">now</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">maybe</span><span> </span><a href="Tezos.Core.html#getCurrentTime"><span class="hs-identifier hs-var">getCurrentTime</span></a><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621680577657"><span class="hs-identifier hs-var">maybeNow</span></a><span>
</span><a name="line-274"></a><span>  </span><a name="local-6989586621680577670"><a href="#local-6989586621680577670"><span class="hs-identifier">gState</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Michelson.Runtime.GState.html#readGState"><span class="hs-identifier hs-var">readGState</span></a><span> </span><a href="#local-6989586621680577659"><span class="hs-identifier hs-var">dbPath</span></a><span>
</span><a name="line-275"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680577671"><a href="#local-6989586621680577671"><span class="hs-identifier">eitherRes</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-276"></a><span>        </span><a href="Michelson.Runtime.html#interpreterPure"><span class="hs-identifier hs-var">interpreterPure</span></a><span> </span><a href="#local-6989586621680577669"><span class="hs-identifier hs-var">now</span></a><span> </span><span class="hs-special">(</span><a href="Michelson.Interpret.html#RemainingSteps"><span class="hs-identifier hs-var">RemainingSteps</span></a><span> </span><a href="#local-6989586621680577658"><span class="hs-identifier hs-var">maxSteps</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680577670"><span class="hs-identifier hs-var">gState</span></a><span> </span><a href="#local-6989586621680577660"><span class="hs-identifier hs-var">operations</span></a><span>
</span><a name="line-277"></a><span>  </span><a href="Michelson.Runtime.html#InterpreterRes"><span class="hs-identifier hs-var">InterpreterRes</span></a><span> </span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">either</span><span> </span><span class="hs-identifier hs-var">throwM</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621680577671"><span class="hs-identifier hs-var">eitherRes</span></a><span>
</span><a name="line-278"></a><span>  </span><span class="hs-identifier hs-var">mapM_</span><span> </span><a href="#local-6989586621680577663"><span class="hs-identifier hs-var">printInterpretResult</span></a><span> </span><a href="#local-6989586621680577675"><span class="hs-identifier hs-var">_irInterpretResults</span></a><span>
</span><a name="line-279"></a><span>  </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680577661"><span class="hs-identifier hs-var">verbose</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621680577674"><span class="hs-identifier hs-var">_irUpdates</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-280"></a><span>    </span><span class="hs-identifier hs-var">fmtLn</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">nameF</span><span> </span><span class="hs-string">&quot;Updates:&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">blockListF</span><span> </span><a href="#local-6989586621680577674"><span class="hs-identifier hs-var">_irUpdates</span></a><span class="hs-special">)</span><span>
</span><a name="line-281"></a><span>    </span><span class="hs-identifier hs-var">putTextLn</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Remaining gas: &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">pretty</span><span> </span><a href="#local-6989586621680577677"><span class="hs-identifier hs-var">_irRemainingSteps</span></a><span>
</span><a name="line-282"></a><span>  </span><span class="hs-identifier hs-var">unless</span><span> </span><a href="#local-6989586621680577662"><span class="hs-identifier hs-var">dryRun</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-283"></a><span>    </span><a href="Michelson.Runtime.GState.html#writeGState"><span class="hs-identifier hs-var">writeGState</span></a><span> </span><a href="#local-6989586621680577659"><span class="hs-identifier hs-var">dbPath</span></a><span> </span><a href="#local-6989586621680577672"><span class="hs-identifier hs-var">_irGState</span></a><span>
</span><a name="line-284"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-285"></a><span>    </span><span class="hs-identifier">printInterpretResult</span><span>
</span><a name="line-286"></a><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Tezos.Address.html#Address"><span class="hs-identifier hs-type">Address</span></a><span class="hs-special">,</span><span> </span><a href="Michelson.Interpret.html#InterpretResult"><span class="hs-identifier hs-type">InterpretResult</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-287"></a><span>    </span><a name="local-6989586621680577663"><a href="#local-6989586621680577663"><span class="hs-identifier">printInterpretResult</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680577664"><a href="#local-6989586621680577664"><span class="hs-identifier">addr</span></a></a><span class="hs-special">,</span><span> </span><a href="Michelson.Interpret.html#InterpretResult"><span class="hs-identifier hs-var">InterpretResult</span></a><span> </span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-288"></a><span>      </span><span class="hs-identifier hs-var">putTextLn</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Executed contract &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">pretty</span><span> </span><a href="#local-6989586621680577664"><span class="hs-identifier hs-var">addr</span></a><span>
</span><a name="line-289"></a><span>      </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680577665"><span class="hs-identifier hs-var">iurOps</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-290"></a><span>        </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">putTextLn</span><span> </span><span class="hs-string">&quot;It didn't return any operations&quot;</span><span>
</span><a name="line-291"></a><span>        </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">fmt</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">nameF</span><span> </span><span class="hs-string">&quot;It returned operations:&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">blockListF</span><span> </span><a href="#local-6989586621680577665"><span class="hs-identifier hs-var">iurOps</span></a><span class="hs-special">)</span><span>
</span><a name="line-292"></a><span>      </span><span class="hs-identifier hs-var">putTextLn</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-293"></a><span>        </span><span class="hs-string">&quot;It returned storage: &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">pretty</span><span> </span><span class="hs-special">(</span><a href="Michelson.Typed.Convert.html#untypeValue"><span class="hs-identifier hs-var">untypeValue</span></a><span> </span><a href="#local-6989586621680577666"><span class="hs-identifier hs-var">iurNewStorage</span></a><span class="hs-special">)</span><span>
</span><a name="line-294"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a href="Michelson.Interpret.html#MorleyLogs"><span class="hs-identifier hs-var">MorleyLogs</span></a><span> </span><a name="local-6989586621680577668"><a href="#local-6989586621680577668"><span class="hs-identifier">logs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">isMorleyLogs</span><span> </span><a href="#local-6989586621680577667"><span class="hs-identifier hs-var">iurNewState</span></a><span>
</span><a name="line-295"></a><span>      </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621680577668"><span class="hs-identifier hs-var">logs</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-296"></a><span>        </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-identifier hs-var">putTextLn</span><span> </span><a href="#local-6989586621680577668"><span class="hs-identifier hs-var">logs</span></a><span>
</span><a name="line-297"></a><span>      </span><span class="hs-identifier hs-var">putTextLn</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><span class="hs-comment">-- extra break line to separate logs from two sequence contracts</span><span>
</span><a name="line-298"></a><span>
</span><a name="line-299"></a><span class="hs-comment">-- | Implementation of interpreter outside 'IO'.  It reads operations,</span><span>
</span><a name="line-300"></a><span class="hs-comment">-- interprets them one by one and updates state accordingly.</span><span>
</span><a name="line-301"></a><span class="hs-comment">-- Each operation from the passed list is fully interpreted before</span><span>
</span><a name="line-302"></a><span class="hs-comment">-- the next one is considered.</span><span>
</span><a name="line-303"></a><span class="hs-identifier">interpreterPure</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-304"></a><span>  </span><a href="Tezos.Core.html#Timestamp"><span class="hs-identifier hs-type">Timestamp</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Michelson.Interpret.html#RemainingSteps"><span class="hs-identifier hs-type">RemainingSteps</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Michelson.Runtime.GState.html#GState"><span class="hs-identifier hs-type">GState</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Michelson.Runtime.html#InterpreterOp"><span class="hs-identifier hs-type">InterpreterOp</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Either</span><span> </span><a href="Michelson.Runtime.html#InterpreterError"><span class="hs-identifier hs-type">InterpreterError</span></a><span> </span><a href="Michelson.Runtime.html#InterpreterRes"><span class="hs-identifier hs-type">InterpreterRes</span></a><span>
</span><a name="line-305"></a><a name="interpreterPure"><a href="Michelson.Runtime.html#interpreterPure"><span class="hs-identifier">interpreterPure</span></a></a><span> </span><a name="local-6989586621680577678"><a href="#local-6989586621680577678"><span class="hs-identifier">now</span></a></a><span> </span><a name="local-6989586621680577679"><a href="#local-6989586621680577679"><span class="hs-identifier">maxSteps</span></a></a><span> </span><a name="local-6989586621680577680"><a href="#local-6989586621680577680"><span class="hs-identifier">gState</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-306"></a><span>  </span><span class="hs-identifier hs-var">foldM</span><span> </span><a href="#local-6989586621680577682"><span class="hs-identifier hs-var">step</span></a><span> </span><a href="#local-6989586621680577681"><span class="hs-identifier hs-var">initialState</span></a><span>
</span><a name="line-307"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-308"></a><span>    </span><span class="hs-comment">-- Note that we can't just put all operations into '_irOperations'</span><span>
</span><a name="line-309"></a><span>    </span><span class="hs-comment">-- and call 'statefulInterpreter' once, because in this case the</span><span>
</span><a name="line-310"></a><span>    </span><span class="hs-comment">-- order of operations will be wrong. We need to consider</span><span>
</span><a name="line-311"></a><span>    </span><span class="hs-comment">-- top-level operations (passed to this function) and operations returned by contracts separatety.</span><span>
</span><a name="line-312"></a><span>    </span><span class="hs-comment">-- Specifically, suppose that we want to interpreter two 'TransferOp's: [t1, t2].</span><span>
</span><a name="line-313"></a><span>    </span><span class="hs-comment">-- If t1 returns an operation, it should be performed before t2, but if we just</span><span>
</span><a name="line-314"></a><span>    </span><span class="hs-comment">-- pass [t1, t2] as '_irOperations' then 't2' will done immediately after 't1'.</span><span>
</span><a name="line-315"></a><span>    </span><a name="local-6989586621680577681"><a href="#local-6989586621680577681"><span class="hs-identifier">initialState</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Michelson.Runtime.html#InterpreterRes"><span class="hs-identifier hs-var">InterpreterRes</span></a><span>
</span><a name="line-316"></a><span>      </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">_irGState</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680577680"><span class="hs-identifier hs-var">gState</span></a><span>
</span><a name="line-317"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_irOperations</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-318"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_irUpdates</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mempty</span><span>
</span><a name="line-319"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_irInterpretResults</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-320"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_irSourceAddress</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-321"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_irRemainingSteps</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680577679"><span class="hs-identifier hs-var">maxSteps</span></a><span>
</span><a name="line-322"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-323"></a><span>
</span><a name="line-324"></a><span>    </span><span class="hs-identifier">step</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Michelson.Runtime.html#InterpreterRes"><span class="hs-identifier hs-type">InterpreterRes</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Michelson.Runtime.html#InterpreterOp"><span class="hs-identifier hs-type">InterpreterOp</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Either</span><span> </span><a href="Michelson.Runtime.html#InterpreterError"><span class="hs-identifier hs-type">InterpreterError</span></a><span> </span><a href="Michelson.Runtime.html#InterpreterRes"><span class="hs-identifier hs-type">InterpreterRes</span></a><span>
</span><a name="line-325"></a><span>    </span><a name="local-6989586621680577682"><a href="#local-6989586621680577682"><span class="hs-identifier">step</span></a></a><span> </span><a name="local-6989586621680577683"><a href="#local-6989586621680577683"><span class="hs-identifier">currentRes</span></a></a><span> </span><a name="local-6989586621680577684"><a href="#local-6989586621680577684"><span class="hs-identifier">op</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-326"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680577685"><a href="#local-6989586621680577685"><span class="hs-identifier">start</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680577683"><span class="hs-identifier hs-var">currentRes</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">_irOperations</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621680577684"><span class="hs-identifier hs-var">op</span></a><span class="hs-special">]</span><span>
</span><a name="line-327"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_irUpdates</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-328"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_irInterpretResults</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-329"></a><span>                             </span><span class="hs-special">}</span><span>
</span><a name="line-330"></a><span>       </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680577683"><span class="hs-identifier hs-var">currentRes</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">runExcept</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">execStateT</span><span> </span><span class="hs-special">(</span><a href="Michelson.Runtime.html#statefulInterpreter"><span class="hs-identifier hs-var">statefulInterpreter</span></a><span> </span><a href="#local-6989586621680577678"><span class="hs-identifier hs-var">now</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680577685"><span class="hs-identifier hs-var">start</span></a><span class="hs-special">)</span><span>
</span><a name="line-331"></a><span>
</span><a name="line-332"></a><span class="hs-identifier">statefulInterpreter</span><span>
</span><a name="line-333"></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="Tezos.Core.html#Timestamp"><span class="hs-identifier hs-type">Timestamp</span></a><span>
</span><a name="line-334"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">StateT</span><span> </span><a href="Michelson.Runtime.html#InterpreterRes"><span class="hs-identifier hs-type">InterpreterRes</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Except</span><span> </span><a href="Michelson.Runtime.html#InterpreterError"><span class="hs-identifier hs-type">InterpreterError</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-335"></a><a name="statefulInterpreter"><a href="Michelson.Runtime.html#statefulInterpreter"><span class="hs-identifier">statefulInterpreter</span></a></a><span> </span><a name="local-6989586621680577686"><a href="#local-6989586621680577686"><span class="hs-identifier">now</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-336"></a><span>  </span><a name="local-6989586621680577690"><a href="#local-6989586621680577690"><span class="hs-identifier">curGState</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">use</span><span> </span><a href="Michelson.Runtime.html#irGState"><span class="hs-identifier hs-var">irGState</span></a><span>
</span><a name="line-337"></a><span>  </span><a name="local-6989586621680577691"><a href="#local-6989586621680577691"><span class="hs-identifier">mSourceAddr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">use</span><span> </span><a href="Michelson.Runtime.html#irSourceAddress"><span class="hs-identifier hs-var">irSourceAddress</span></a><span>
</span><a name="line-338"></a><span>  </span><a name="local-6989586621680577692"><a href="#local-6989586621680577692"><span class="hs-identifier">remainingSteps</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">use</span><span> </span><a href="Michelson.Runtime.html#irRemainingSteps"><span class="hs-identifier hs-var">irRemainingSteps</span></a><span>
</span><a name="line-339"></a><span>  </span><span class="hs-identifier hs-var">use</span><span> </span><a href="Michelson.Runtime.html#irOperations"><span class="hs-identifier hs-var">irOperations</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><a name="line-340"></a><span>    </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pass</span><span>
</span><a name="line-341"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680577693"><a href="#local-6989586621680577693"><span class="hs-identifier">op</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621680577694"><a href="#local-6989586621680577694"><span class="hs-identifier">opsTail</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-342"></a><span>      </span><span class="hs-identifier hs-var">either</span><span> </span><span class="hs-identifier hs-var">throwError</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680577687"><span class="hs-identifier hs-var">processIntRes</span></a><span> </span><a href="#local-6989586621680577694"><span class="hs-identifier hs-var">opsTail</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-343"></a><span>      </span><a href="Michelson.Runtime.html#interpretOneOp"><span class="hs-identifier hs-var">interpretOneOp</span></a><span> </span><a href="#local-6989586621680577686"><span class="hs-identifier hs-var">now</span></a><span> </span><a href="#local-6989586621680577692"><span class="hs-identifier hs-var">remainingSteps</span></a><span> </span><a href="#local-6989586621680577691"><span class="hs-identifier hs-var">mSourceAddr</span></a><span> </span><a href="#local-6989586621680577690"><span class="hs-identifier hs-var">curGState</span></a><span> </span><a href="#local-6989586621680577693"><span class="hs-identifier hs-var">op</span></a><span>
</span><a name="line-344"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-345"></a><span>    </span><a name="local-6989586621680577687"><a href="#local-6989586621680577687"><span class="hs-identifier">processIntRes</span></a></a><span> </span><a name="local-6989586621680577688"><a href="#local-6989586621680577688"><span class="hs-identifier">opsTail</span></a></a><span> </span><a name="local-6989586621680577689"><a href="#local-6989586621680577689"><span class="hs-identifier">ir</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-346"></a><span>      </span><span class="hs-comment">-- Not using `&lt;&gt;=` because it requires `Monoid` for no reason.</span><span>
</span><a name="line-347"></a><span>      </span><span class="hs-identifier hs-var">id</span><span> </span><span class="hs-operator hs-var">%=</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-6989586621680577689"><span class="hs-identifier hs-var">ir</span></a><span class="hs-special">)</span><span>
</span><a name="line-348"></a><span>      </span><a href="Michelson.Runtime.html#irOperations"><span class="hs-identifier hs-var">irOperations</span></a><span> </span><span class="hs-operator hs-var">%=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680577688"><span class="hs-identifier hs-var">opsTail</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span class="hs-special">)</span><span>
</span><a name="line-349"></a><span>      </span><a href="Michelson.Runtime.html#statefulInterpreter"><span class="hs-identifier hs-var">statefulInterpreter</span></a><span> </span><a href="#local-6989586621680577686"><span class="hs-identifier hs-var">now</span></a><span>
</span><a name="line-350"></a><span>
</span><a name="line-351"></a><span class="hs-comment">-- | Run only one interpreter operation and update 'GState' accordingly.</span><span>
</span><a name="line-352"></a><span class="hs-identifier">interpretOneOp</span><span>
</span><a name="line-353"></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="Tezos.Core.html#Timestamp"><span class="hs-identifier hs-type">Timestamp</span></a><span>
</span><a name="line-354"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Michelson.Interpret.html#RemainingSteps"><span class="hs-identifier hs-type">RemainingSteps</span></a><span>
</span><a name="line-355"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Tezos.Address.html#Address"><span class="hs-identifier hs-type">Address</span></a><span>
</span><a name="line-356"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Michelson.Runtime.GState.html#GState"><span class="hs-identifier hs-type">GState</span></a><span>
</span><a name="line-357"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Michelson.Runtime.html#InterpreterOp"><span class="hs-identifier hs-type">InterpreterOp</span></a><span>
</span><a name="line-358"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Either</span><span> </span><a href="Michelson.Runtime.html#InterpreterError"><span class="hs-identifier hs-type">InterpreterError</span></a><span> </span><a href="Michelson.Runtime.html#InterpreterRes"><span class="hs-identifier hs-type">InterpreterRes</span></a><span>
</span><a name="line-359"></a><a name="interpretOneOp"><a href="Michelson.Runtime.html#interpretOneOp"><span class="hs-identifier">interpretOneOp</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680577695"><a href="#local-6989586621680577695"><span class="hs-identifier">remainingSteps</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680577696"><a href="#local-6989586621680577696"><span class="hs-identifier">gs</span></a></a><span> </span><span class="hs-special">(</span><a href="Michelson.Runtime.html#OriginateOp"><span class="hs-identifier hs-var">OriginateOp</span></a><span> </span><a name="local-6989586621680577697"><a href="#local-6989586621680577697"><span class="hs-identifier">origination</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-360"></a><span>  </span><a name="local-6989586621680577702"><a href="#local-6989586621680577702"><span class="hs-identifier">typedContract</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">first</span><span> </span><a href="Michelson.Runtime.html#IEIllTypedContract"><span class="hs-identifier hs-var">IEIllTypedContract</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-361"></a><span>    </span><a href="Michelson.TypeCheck.Instr.html#typeCheckContract"><span class="hs-identifier hs-var">typeCheckContract</span></a><span> </span><span class="hs-special">(</span><a href="Michelson.Runtime.GState.html#extractAllContracts"><span class="hs-identifier hs-var">extractAllContracts</span></a><span> </span><a href="#local-6989586621680577696"><span class="hs-identifier hs-var">gs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ooContract</span><span> </span><a href="#local-6989586621680577697"><span class="hs-identifier hs-var">origination</span></a><span class="hs-special">)</span><span>
</span><a name="line-362"></a><span>  </span><a name="local-6989586621680577703"><a href="#local-6989586621680577703"><span class="hs-identifier">typedStorage</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">first</span><span> </span><a href="Michelson.Runtime.html#IEIllTypedStorage"><span class="hs-identifier hs-var">IEIllTypedStorage</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-363"></a><span>    </span><a href="Michelson.TypeCheck.Instr.html#typeCheckStorageOrParameter"><span class="hs-identifier hs-var">typeCheckStorageOrParameter</span></a><span> </span><a href="Michelson.TypeCheck.Types.html#Storage"><span class="hs-identifier hs-var">Storage</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ooStorage</span><span> </span><a href="#local-6989586621680577697"><span class="hs-identifier hs-var">origination</span></a><span class="hs-special">)</span><span>
</span><a name="line-364"></a><span>    </span><span class="hs-special">(</span><a href="Michelson.Runtime.GState.html#extractAllContracts"><span class="hs-identifier hs-var">extractAllContracts</span></a><span> </span><a href="#local-6989586621680577696"><span class="hs-identifier hs-var">gs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ooContract</span><span> </span><a href="#local-6989586621680577697"><span class="hs-identifier hs-var">origination</span></a><span class="hs-special">)</span><span>
</span><a name="line-365"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680577704"><a href="#local-6989586621680577704"><span class="hs-identifier">originatorAddress</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Tezos.Address.html#KeyAddress"><span class="hs-identifier hs-var">KeyAddress</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ooManager</span><span> </span><a href="#local-6989586621680577697"><span class="hs-identifier hs-var">origination</span></a><span class="hs-special">)</span><span>
</span><a name="line-366"></a><span>  </span><a name="local-6989586621680577706"><a href="#local-6989586621680577706"><span class="hs-identifier">originatorBalance</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">gsAddresses</span><span> </span><a href="#local-6989586621680577696"><span class="hs-identifier hs-var">gs</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><span class="hs-identifier hs-var">at</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680577704"><span class="hs-identifier hs-var">originatorAddress</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-367"></a><span>    </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">(</span><a href="Michelson.Runtime.html#IEUnknownManager"><span class="hs-identifier hs-var">IEUnknownManager</span></a><span> </span><a href="#local-6989586621680577704"><span class="hs-identifier hs-var">originatorAddress</span></a><span class="hs-special">)</span><span>
</span><a name="line-368"></a><span>    </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="Michelson.Runtime.GState.html#asBalance"><span class="hs-identifier hs-var">asBalance</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a name="local-6989586621680577705"><a href="#local-6989586621680577705"><span class="hs-identifier">oldBalance</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-369"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680577705"><span class="hs-identifier hs-var">oldBalance</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-identifier">ooBalance</span><span> </span><a href="#local-6989586621680577697"><span class="hs-identifier hs-var">origination</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-370"></a><span>        </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">(</span><a href="Michelson.Runtime.html#IENotEnoughFunds"><span class="hs-identifier hs-var">IENotEnoughFunds</span></a><span> </span><a href="#local-6989586621680577704"><span class="hs-identifier hs-var">originatorAddress</span></a><span> </span><a href="#local-6989586621680577705"><span class="hs-identifier hs-var">oldBalance</span></a><span class="hs-special">)</span><span>
</span><a name="line-371"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-372"></a><span>        </span><span class="hs-comment">-- Subtraction is safe because we have checked its</span><span>
</span><a name="line-373"></a><span>        </span><span class="hs-comment">-- precondition in guard.</span><span>
</span><a name="line-374"></a><span>        </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680577705"><span class="hs-identifier hs-var">oldBalance</span></a><span> </span><span class="hs-special">`</span><a href="Tezos.Core.html#unsafeSubMutez"><span class="hs-identifier hs-var">unsafeSubMutez</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier">ooBalance</span><span> </span><a href="#local-6989586621680577697"><span class="hs-identifier hs-var">origination</span></a><span class="hs-special">)</span><span>
</span><a name="line-375"></a><span>  </span><span class="hs-keyword">let</span><span>
</span><a name="line-376"></a><span>    </span><a name="local-6989586621680577707"><a href="#local-6989586621680577707"><span class="hs-identifier">updates</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-377"></a><span>      </span><span class="hs-special">[</span><span> </span><a href="Michelson.Runtime.GState.html#GSAddAddress"><span class="hs-identifier hs-var">GSAddAddress</span></a><span> </span><a href="#local-6989586621680577699"><span class="hs-identifier hs-var">address</span></a><span> </span><span class="hs-special">(</span><a href="Michelson.Runtime.GState.html#ASContract"><span class="hs-identifier hs-var">ASContract</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621680577698"><span class="hs-identifier hs-var">mkContractState</span></a><span> </span><a href="#local-6989586621680577702"><span class="hs-identifier hs-var">typedContract</span></a><span> </span><a href="#local-6989586621680577703"><span class="hs-identifier hs-var">typedStorage</span></a><span class="hs-special">)</span><span>
</span><a name="line-378"></a><span>      </span><span class="hs-special">,</span><span> </span><a href="Michelson.Runtime.GState.html#GSSetBalance"><span class="hs-identifier hs-var">GSSetBalance</span></a><span> </span><a href="#local-6989586621680577704"><span class="hs-identifier hs-var">originatorAddress</span></a><span> </span><a href="#local-6989586621680577706"><span class="hs-identifier hs-var">originatorBalance</span></a><span>
</span><a name="line-379"></a><span>      </span><span class="hs-special">]</span><span>
</span><a name="line-380"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="Michelson.Runtime.GState.html#applyUpdates"><span class="hs-identifier hs-var">applyUpdates</span></a><span> </span><a href="#local-6989586621680577707"><span class="hs-identifier hs-var">updates</span></a><span> </span><a href="#local-6989586621680577696"><span class="hs-identifier hs-var">gs</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-381"></a><span>    </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-382"></a><span>      </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">(</span><a href="Michelson.Runtime.html#IEAlreadyOriginated"><span class="hs-identifier hs-var">IEAlreadyOriginated</span></a><span> </span><a href="#local-6989586621680577699"><span class="hs-identifier hs-var">address</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621680577698"><span class="hs-identifier hs-var">mkContractState</span></a><span> </span><a href="#local-6989586621680577702"><span class="hs-identifier hs-var">typedContract</span></a><span> </span><a href="#local-6989586621680577703"><span class="hs-identifier hs-var">typedStorage</span></a><span class="hs-special">)</span><span>
</span><a name="line-383"></a><span>    </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621680577708"><a href="#local-6989586621680577708"><span class="hs-identifier">newGS</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-384"></a><span>      </span><a href="Michelson.Runtime.html#InterpreterRes"><span class="hs-identifier hs-var">InterpreterRes</span></a><span>
</span><a name="line-385"></a><span>      </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">_irGState</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680577708"><span class="hs-identifier hs-var">newGS</span></a><span>
</span><a name="line-386"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_irOperations</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mempty</span><span>
</span><a name="line-387"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_irUpdates</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680577707"><span class="hs-identifier hs-var">updates</span></a><span>
</span><a name="line-388"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_irInterpretResults</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-389"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_irSourceAddress</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-390"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_irRemainingSteps</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680577695"><span class="hs-identifier hs-var">remainingSteps</span></a><span>
</span><a name="line-391"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-392"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-393"></a><span>    </span><a name="local-6989586621680577698"><a href="#local-6989586621680577698"><span class="hs-identifier">mkContractState</span></a></a><span> </span><a name="local-6989586621680577700"><a href="#local-6989586621680577700"><span class="hs-identifier">typedContract</span></a></a><span> </span><a name="local-6989586621680577701"><a href="#local-6989586621680577701"><span class="hs-identifier">typedStorage</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Michelson.Runtime.GState.html#ContractState"><span class="hs-identifier hs-var">ContractState</span></a><span>
</span><a name="line-394"></a><span>      </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">csBalance</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ooBalance</span><span> </span><a href="#local-6989586621680577697"><span class="hs-identifier hs-var">origination</span></a><span>
</span><a name="line-395"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">csStorage</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ooStorage</span><span> </span><a href="#local-6989586621680577697"><span class="hs-identifier hs-var">origination</span></a><span>
</span><a name="line-396"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">csContract</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ooContract</span><span> </span><a href="#local-6989586621680577697"><span class="hs-identifier hs-var">origination</span></a><span>
</span><a name="line-397"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">csTypedContract</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621680577700"><span class="hs-identifier hs-var">typedContract</span></a><span>
</span><a name="line-398"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">csTypedStorage</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621680577701"><span class="hs-identifier hs-var">typedStorage</span></a><span>
</span><a name="line-399"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-400"></a><span>    </span><a name="local-6989586621680577699"><a href="#local-6989586621680577699"><span class="hs-identifier">address</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Michelson.Untyped.Instr.html#mkContractAddress"><span class="hs-identifier hs-var">mkContractAddress</span></a><span> </span><a href="#local-6989586621680577697"><span class="hs-identifier hs-var">origination</span></a><span>
</span><a name="line-401"></a><span class="hs-identifier">interpretOneOp</span><span> </span><a name="local-6989586621680577709"><a href="#local-6989586621680577709"><span class="hs-identifier">now</span></a></a><span> </span><a name="local-6989586621680577710"><a href="#local-6989586621680577710"><span class="hs-identifier">remainingSteps</span></a></a><span> </span><a name="local-6989586621680577711"><a href="#local-6989586621680577711"><span class="hs-identifier">mSourceAddr</span></a></a><span> </span><a name="local-6989586621680577712"><a href="#local-6989586621680577712"><span class="hs-identifier">gs</span></a></a><span> </span><span class="hs-special">(</span><a href="Michelson.Runtime.html#TransferOp"><span class="hs-identifier hs-var">TransferOp</span></a><span> </span><a name="local-6989586621680577713"><a href="#local-6989586621680577713"><span class="hs-identifier">addr</span></a></a><span> </span><a name="local-6989586621680577714"><a href="#local-6989586621680577714"><span class="hs-identifier">txData</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-402"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680577716"><a href="#local-6989586621680577716"><span class="hs-identifier">sourceAddr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tdSenderAddress</span><span> </span><a href="#local-6989586621680577714"><span class="hs-identifier hs-var">txData</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680577711"><span class="hs-identifier hs-var">mSourceAddr</span></a><span>
</span><a name="line-403"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680577717"><a href="#local-6989586621680577717"><span class="hs-identifier">senderAddr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tdSenderAddress</span><span> </span><a href="#local-6989586621680577714"><span class="hs-identifier hs-var">txData</span></a><span>
</span><a name="line-404"></a><span>    </span><a name="local-6989586621680577719"><a href="#local-6989586621680577719"><span class="hs-identifier">decreaseSenderBalance</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680577715"><span class="hs-identifier hs-var">addresses</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><span class="hs-identifier hs-var">at</span><span> </span><a href="#local-6989586621680577717"><span class="hs-identifier hs-var">senderAddr</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-405"></a><span>      </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">(</span><a href="Michelson.Runtime.html#IEUnknownSender"><span class="hs-identifier hs-var">IEUnknownSender</span></a><span> </span><a href="#local-6989586621680577717"><span class="hs-identifier hs-var">senderAddr</span></a><span class="hs-special">)</span><span>
</span><a name="line-406"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="Michelson.Runtime.GState.html#asBalance"><span class="hs-identifier hs-var">asBalance</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a name="local-6989586621680577718"><a href="#local-6989586621680577718"><span class="hs-identifier">balance</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-407"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680577718"><span class="hs-identifier hs-var">balance</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-identifier">tdAmount</span><span> </span><a href="#local-6989586621680577714"><span class="hs-identifier hs-var">txData</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-408"></a><span>          </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">(</span><a href="Michelson.Runtime.html#IENotEnoughFunds"><span class="hs-identifier hs-var">IENotEnoughFunds</span></a><span> </span><a href="#local-6989586621680577717"><span class="hs-identifier hs-var">senderAddr</span></a><span> </span><a href="#local-6989586621680577718"><span class="hs-identifier hs-var">balance</span></a><span class="hs-special">)</span><span>
</span><a name="line-409"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-410"></a><span>          </span><span class="hs-comment">-- Subtraction is safe because we have checked its</span><span>
</span><a name="line-411"></a><span>          </span><span class="hs-comment">-- precondition in guard.</span><span>
</span><a name="line-412"></a><span>          </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><a href="Michelson.Runtime.GState.html#GSSetBalance"><span class="hs-identifier hs-var">GSSetBalance</span></a><span> </span><a href="#local-6989586621680577717"><span class="hs-identifier hs-var">senderAddr</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680577718"><span class="hs-identifier hs-var">balance</span></a><span> </span><span class="hs-special">`</span><a href="Tezos.Core.html#unsafeSubMutez"><span class="hs-identifier hs-var">unsafeSubMutez</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier">tdAmount</span><span> </span><a href="#local-6989586621680577714"><span class="hs-identifier hs-var">txData</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-413"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680577720"><a href="#local-6989586621680577720"><span class="hs-identifier">onlyUpdates</span></a></a><span> </span><a name="local-6989586621680577721"><a href="#local-6989586621680577721"><span class="hs-identifier">updates</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680577721"><span class="hs-identifier hs-var">updates</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680577710"><span class="hs-identifier hs-var">remainingSteps</span></a><span class="hs-special">)</span><span>
</span><a name="line-414"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680577743"><a href="#local-6989586621680577743"><span class="hs-identifier">otherUpdates</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680577744"><a href="#local-6989586621680577744"><span class="hs-identifier">sideEffects</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680577745"><a href="#local-6989586621680577745"><span class="hs-identifier">maybeInterpretRes</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680577746"><a href="#local-6989586621680577746"><span class="hs-identifier">newRemSteps</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-415"></a><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680577715"><span class="hs-identifier hs-var">addresses</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><span class="hs-identifier hs-var">at</span><span> </span><a href="#local-6989586621680577713"><span class="hs-identifier hs-var">addr</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680577713"><span class="hs-identifier hs-var">addr</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-416"></a><span>      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">,</span><span> </span><a href="Tezos.Address.html#ContractAddress"><span class="hs-identifier hs-var">ContractAddress</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-417"></a><span>        </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">(</span><a href="Michelson.Runtime.html#IEUnknownContract"><span class="hs-identifier hs-var">IEUnknownContract</span></a><span> </span><a href="#local-6989586621680577713"><span class="hs-identifier hs-var">addr</span></a><span class="hs-special">)</span><span>
</span><a name="line-418"></a><span>      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">,</span><span> </span><a href="Tezos.Address.html#KeyAddress"><span class="hs-identifier hs-var">KeyAddress</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-419"></a><span>        </span><span class="hs-keyword">let</span><span>
</span><a name="line-420"></a><span>          </span><a name="local-6989586621680577722"><a href="#local-6989586621680577722"><span class="hs-identifier">addrState</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Michelson.Runtime.GState.html#ASSimple"><span class="hs-identifier hs-var">ASSimple</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tdAmount</span><span> </span><a href="#local-6989586621680577714"><span class="hs-identifier hs-var">txData</span></a><span class="hs-special">)</span><span>
</span><a name="line-421"></a><span>          </span><a name="local-6989586621680577723"><a href="#local-6989586621680577723"><span class="hs-identifier">upd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Michelson.Runtime.GState.html#GSAddAddress"><span class="hs-identifier hs-var">GSAddAddress</span></a><span> </span><a href="#local-6989586621680577713"><span class="hs-identifier hs-var">addr</span></a><span> </span><a href="#local-6989586621680577722"><span class="hs-identifier hs-var">addrState</span></a><span>
</span><a name="line-422"></a><span>        </span><a href="#local-6989586621680577720"><span class="hs-identifier hs-var">onlyUpdates</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621680577723"><span class="hs-identifier hs-var">upd</span></a><span class="hs-special">]</span><span>
</span><a name="line-423"></a><span>      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="Michelson.Runtime.GState.html#ASSimple"><span class="hs-identifier hs-var">ASSimple</span></a><span> </span><a name="local-6989586621680577724"><a href="#local-6989586621680577724"><span class="hs-identifier">oldBalance</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-424"></a><span>        </span><span class="hs-comment">-- can't overflow if global state is correct (because we can't</span><span>
</span><a name="line-425"></a><span>        </span><span class="hs-comment">-- create money out of nowhere)</span><span>
</span><a name="line-426"></a><span>        </span><span class="hs-keyword">let</span><span>
</span><a name="line-427"></a><span>          </span><a name="local-6989586621680577725"><a href="#local-6989586621680577725"><span class="hs-identifier">newBalance</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680577724"><span class="hs-identifier hs-var">oldBalance</span></a><span> </span><span class="hs-special">`</span><a href="Tezos.Core.html#unsafeAddMutez"><span class="hs-identifier hs-var">unsafeAddMutez</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier">tdAmount</span><span> </span><a href="#local-6989586621680577714"><span class="hs-identifier hs-var">txData</span></a><span>
</span><a name="line-428"></a><span>          </span><a name="local-6989586621680577726"><a href="#local-6989586621680577726"><span class="hs-identifier">upd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Michelson.Runtime.GState.html#GSSetBalance"><span class="hs-identifier hs-var">GSSetBalance</span></a><span> </span><a href="#local-6989586621680577713"><span class="hs-identifier hs-var">addr</span></a><span> </span><a href="#local-6989586621680577725"><span class="hs-identifier hs-var">newBalance</span></a><span>
</span><a name="line-429"></a><span>        </span><a href="#local-6989586621680577720"><span class="hs-identifier hs-var">onlyUpdates</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621680577726"><span class="hs-identifier hs-var">upd</span></a><span class="hs-special">]</span><span>
</span><a name="line-430"></a><span>      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="Michelson.Runtime.GState.html#ASContract"><span class="hs-identifier hs-var">ASContract</span></a><span> </span><a name="local-6989586621680577727"><a href="#local-6989586621680577727"><span class="hs-identifier">cs</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-431"></a><span>        </span><span class="hs-keyword">let</span><span>
</span><a name="line-432"></a><span>          </span><a name="local-6989586621680577728"><a href="#local-6989586621680577728"><span class="hs-identifier">contract</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">csContract</span><span> </span><a href="#local-6989586621680577727"><span class="hs-identifier hs-var">cs</span></a><span>
</span><a name="line-433"></a><span>          </span><a name="local-6989586621680577729"><a href="#local-6989586621680577729"><span class="hs-identifier">existingContracts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Michelson.Runtime.GState.html#extractAllContracts"><span class="hs-identifier hs-var">extractAllContracts</span></a><span> </span><a href="#local-6989586621680577712"><span class="hs-identifier hs-var">gs</span></a><span>
</span><a name="line-434"></a><span>          </span><a name="local-6989586621680577730"><a href="#local-6989586621680577730"><span class="hs-identifier">contractEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Michelson.Interpret.html#ContractEnv"><span class="hs-identifier hs-var">ContractEnv</span></a><span>
</span><a name="line-435"></a><span>            </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ceNow</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680577709"><span class="hs-identifier hs-var">now</span></a><span>
</span><a name="line-436"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ceMaxSteps</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680577710"><span class="hs-identifier hs-var">remainingSteps</span></a><span>
</span><a name="line-437"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ceBalance</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">csBalance</span><span> </span><a href="#local-6989586621680577727"><span class="hs-identifier hs-var">cs</span></a><span>
</span><a name="line-438"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ceContracts</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680577729"><span class="hs-identifier hs-var">existingContracts</span></a><span>
</span><a name="line-439"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ceSelf</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680577713"><span class="hs-identifier hs-var">addr</span></a><span>
</span><a name="line-440"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ceSource</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680577716"><span class="hs-identifier hs-var">sourceAddr</span></a><span>
</span><a name="line-441"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ceSender</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680577717"><span class="hs-identifier hs-var">senderAddr</span></a><span>
</span><a name="line-442"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ceAmount</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tdAmount</span><span> </span><a href="#local-6989586621680577714"><span class="hs-identifier hs-var">txData</span></a><span>
</span><a name="line-443"></a><span>            </span><span class="hs-special">}</span><span>
</span><a name="line-444"></a><span>        </span><a name="local-6989586621680577731"><a href="#local-6989586621680577731"><span class="hs-identifier">typedParameter</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">first</span><span> </span><a href="Michelson.Runtime.html#IEIllTypedParameter"><span class="hs-identifier hs-var">IEIllTypedParameter</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-445"></a><span>           </span><a href="Michelson.TypeCheck.Instr.html#typeCheckStorageOrParameter"><span class="hs-identifier hs-var">typeCheckStorageOrParameter</span></a><span> </span><a href="Michelson.TypeCheck.Types.html#Parameter"><span class="hs-identifier hs-var">Parameter</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tdParameter</span><span> </span><a href="#local-6989586621680577714"><span class="hs-identifier hs-var">txData</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680577729"><span class="hs-identifier hs-var">existingContracts</span></a><span> </span><a href="#local-6989586621680577728"><span class="hs-identifier hs-var">contract</span></a><span>
</span><a name="line-446"></a><span>        </span><a name="local-6989586621680577732"><a href="#local-6989586621680577732"><span class="hs-identifier">typedStorage</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">first</span><span> </span><a href="Michelson.Runtime.html#IEIllTypedStorage"><span class="hs-identifier hs-var">IEIllTypedStorage</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Michelson.Runtime.GState.html#getTypedStorage"><span class="hs-identifier hs-var">getTypedStorage</span></a><span> </span><a href="#local-6989586621680577712"><span class="hs-identifier hs-var">gs</span></a><span> </span><a href="#local-6989586621680577727"><span class="hs-identifier hs-var">cs</span></a><span>
</span><a name="line-447"></a><span>        </span><a name="local-6989586621680577733"><a href="#local-6989586621680577733"><span class="hs-identifier">typedContract</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">first</span><span> </span><a href="Michelson.Runtime.html#IEIllTypedContract"><span class="hs-identifier hs-var">IEIllTypedContract</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Michelson.Runtime.GState.html#getTypedContract"><span class="hs-identifier hs-var">getTypedContract</span></a><span> </span><a href="#local-6989586621680577712"><span class="hs-identifier hs-var">gs</span></a><span> </span><a href="#local-6989586621680577727"><span class="hs-identifier hs-var">cs</span></a><span>
</span><a name="line-448"></a><span>        </span><a name="local-6989586621680577734"><a href="#local-6989586621680577734"><span class="hs-identifier">iur</span></a></a><span class="hs-glyph">@</span><a href="Michelson.Interpret.html#InterpretResult"><span class="hs-identifier hs-var">InterpretResult</span></a><span>
</span><a name="line-449"></a><span>          </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">iurOps</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680577735"><a href="#local-6989586621680577735"><span class="hs-identifier">sideEffects</span></a></a><span>
</span><a name="line-450"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">iurNewStorage</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680577736"><a href="#local-6989586621680577736"><span class="hs-identifier">newValue</span></a></a><span>
</span><a name="line-451"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">iurNewState</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Michelson.Interpret.html#InterpreterState"><span class="hs-identifier hs-var">InterpreterState</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680577737"><a href="#local-6989586621680577737"><span class="hs-identifier">newRemainingSteps</span></a></a><span>
</span><a name="line-452"></a><span>          </span><span class="hs-special">}</span><span>
</span><a name="line-453"></a><span>          </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">first</span><span> </span><span class="hs-special">(</span><a href="Michelson.Runtime.html#IEInterpreterFailed"><span class="hs-identifier hs-var">IEInterpreterFailed</span></a><span> </span><a href="#local-6989586621680577713"><span class="hs-identifier hs-var">addr</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-454"></a><span>                </span><a href="Michelson.Interpret.html#interpretSome"><span class="hs-identifier hs-var">interpretSome</span></a><span> </span><a href="#local-6989586621680577733"><span class="hs-identifier hs-var">typedContract</span></a><span> </span><a href="#local-6989586621680577731"><span class="hs-identifier hs-var">typedParameter</span></a><span>
</span><a name="line-455"></a><span>                </span><a href="#local-6989586621680577732"><span class="hs-identifier hs-var">typedStorage</span></a><span> </span><a href="#local-6989586621680577730"><span class="hs-identifier hs-var">contractEnv</span></a><span>
</span><a name="line-456"></a><span>        </span><span class="hs-keyword">let</span><span>
</span><a name="line-457"></a><span>          </span><a name="local-6989586621680577738"><a href="#local-6989586621680577738"><span class="hs-identifier">newValueU</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Michelson.Typed.Convert.html#untypeValue"><span class="hs-identifier hs-var">untypeValue</span></a><span> </span><a href="#local-6989586621680577736"><span class="hs-identifier hs-var">newValue</span></a><span>
</span><a name="line-458"></a><span>          </span><span class="hs-comment">-- can't overflow if global state is correct (because we can't</span><span>
</span><a name="line-459"></a><span>          </span><span class="hs-comment">-- create money out of nowhere)</span><span>
</span><a name="line-460"></a><span>          </span><a name="local-6989586621680577739"><a href="#local-6989586621680577739"><span class="hs-identifier">newBalance</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">csBalance</span><span> </span><a href="#local-6989586621680577727"><span class="hs-identifier hs-var">cs</span></a><span> </span><span class="hs-special">`</span><a href="Tezos.Core.html#unsafeAddMutez"><span class="hs-identifier hs-var">unsafeAddMutez</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier">tdAmount</span><span> </span><a href="#local-6989586621680577714"><span class="hs-identifier hs-var">txData</span></a><span>
</span><a name="line-461"></a><span>          </span><a name="local-6989586621680577740"><a href="#local-6989586621680577740"><span class="hs-identifier">updBalance</span></a></a><span>
</span><a name="line-462"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680577739"><span class="hs-identifier hs-var">newBalance</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier">csBalance</span><span> </span><a href="#local-6989586621680577727"><span class="hs-identifier hs-var">cs</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-463"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Michelson.Runtime.GState.html#GSSetBalance"><span class="hs-identifier hs-var">GSSetBalance</span></a><span> </span><a href="#local-6989586621680577713"><span class="hs-identifier hs-var">addr</span></a><span> </span><a href="#local-6989586621680577739"><span class="hs-identifier hs-var">newBalance</span></a><span>
</span><a name="line-464"></a><span>          </span><a name="local-6989586621680577741"><a href="#local-6989586621680577741"><span class="hs-identifier">updStorage</span></a></a><span>
</span><a name="line-465"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a href="Michelson.Typed.Value.html#SomeValue"><span class="hs-identifier hs-var">SomeValue</span></a><span> </span><a href="#local-6989586621680577736"><span class="hs-identifier hs-var">newValue</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621680577732"><span class="hs-identifier hs-var">typedStorage</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-466"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Michelson.Runtime.GState.html#GSSetStorageValue"><span class="hs-identifier hs-var">GSSetStorageValue</span></a><span> </span><a href="#local-6989586621680577713"><span class="hs-identifier hs-var">addr</span></a><span> </span><a href="#local-6989586621680577738"><span class="hs-identifier hs-var">newValueU</span></a><span> </span><span class="hs-special">(</span><a href="Michelson.Typed.Value.html#SomeValue"><span class="hs-identifier hs-var">SomeValue</span></a><span> </span><a href="#local-6989586621680577736"><span class="hs-identifier hs-var">newValue</span></a><span class="hs-special">)</span><span>
</span><a name="line-467"></a><span>          </span><a name="local-6989586621680577742"><a href="#local-6989586621680577742"><span class="hs-identifier">updates</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">catMaybes</span><span>
</span><a name="line-468"></a><span>            </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621680577740"><span class="hs-identifier hs-var">updBalance</span></a><span>
</span><a name="line-469"></a><span>            </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680577741"><span class="hs-identifier hs-var">updStorage</span></a><span>
</span><a name="line-470"></a><span>            </span><span class="hs-special">]</span><span>
</span><a name="line-471"></a><span>        </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680577742"><span class="hs-identifier hs-var">updates</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680577735"><span class="hs-identifier hs-var">sideEffects</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621680577734"><span class="hs-identifier hs-var">iur</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680577737"><span class="hs-identifier hs-var">newRemainingSteps</span></a><span class="hs-special">)</span><span>
</span><a name="line-472"></a><span>
</span><a name="line-473"></a><span>    </span><span class="hs-keyword">let</span><span>
</span><a name="line-474"></a><span>      </span><a name="local-6989586621680577747"><a href="#local-6989586621680577747"><span class="hs-identifier">updates</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680577719"><span class="hs-identifier hs-var">decreaseSenderBalance</span></a><span class="hs-glyph">:</span><a href="#local-6989586621680577743"><span class="hs-identifier hs-var">otherUpdates</span></a><span>
</span><a name="line-475"></a><span>
</span><a name="line-476"></a><span>    </span><a name="local-6989586621680577748"><a href="#local-6989586621680577748"><span class="hs-identifier">newGState</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">first</span><span> </span><a href="Michelson.Runtime.html#IEFailedToApplyUpdates"><span class="hs-identifier hs-var">IEFailedToApplyUpdates</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Michelson.Runtime.GState.html#applyUpdates"><span class="hs-identifier hs-var">applyUpdates</span></a><span> </span><a href="#local-6989586621680577747"><span class="hs-identifier hs-var">updates</span></a><span> </span><a href="#local-6989586621680577712"><span class="hs-identifier hs-var">gs</span></a><span>
</span><a name="line-477"></a><span>
</span><a name="line-478"></a><span>    </span><span class="hs-identifier">return</span><span> </span><a href="Michelson.Runtime.html#InterpreterRes"><span class="hs-identifier hs-var">InterpreterRes</span></a><span>
</span><a name="line-479"></a><span>      </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">_irGState</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680577748"><span class="hs-identifier hs-var">newGState</span></a><span>
</span><a name="line-480"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_irOperations</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapMaybe</span><span> </span><span class="hs-special">(</span><a href="Michelson.Runtime.html#convertOp"><span class="hs-identifier hs-var">convertOp</span></a><span> </span><a href="#local-6989586621680577713"><span class="hs-identifier hs-var">addr</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680577744"><span class="hs-identifier hs-var">sideEffects</span></a><span>
</span><a name="line-481"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_irUpdates</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680577747"><span class="hs-identifier hs-var">updates</span></a><span>
</span><a name="line-482"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_irInterpretResults</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-identifier hs-var">mempty</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">one</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680577713"><span class="hs-identifier hs-var">addr</span></a><span class="hs-special">,</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680577745"><span class="hs-identifier hs-var">maybeInterpretRes</span></a><span>
</span><a name="line-483"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_irSourceAddress</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621680577716"><span class="hs-identifier hs-var">sourceAddr</span></a><span>
</span><a name="line-484"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_irRemainingSteps</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680577746"><span class="hs-identifier hs-var">newRemSteps</span></a><span>
</span><a name="line-485"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-486"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-487"></a><span>    </span><span class="hs-identifier">addresses</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><a href="Tezos.Address.html#Address"><span class="hs-identifier hs-type">Address</span></a><span> </span><a href="Michelson.Runtime.GState.html#AddressState"><span class="hs-identifier hs-type">AddressState</span></a><span>
</span><a name="line-488"></a><span>    </span><a name="local-6989586621680577715"><a href="#local-6989586621680577715"><span class="hs-identifier">addresses</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">gsAddresses</span><span> </span><a href="#local-6989586621680577712"><span class="hs-identifier hs-var">gs</span></a><span>
</span><a name="line-489"></a><span>
</span><a name="line-490"></a><span class="hs-comment">----------------------------------------------------------------------------</span><span>
</span><a name="line-491"></a><span class="hs-comment">-- TypeCheck</span><span>
</span><a name="line-492"></a><span class="hs-comment">----------------------------------------------------------------------------</span><span>
</span><a name="line-493"></a><span class="hs-identifier">typeCheckWithDb</span><span>
</span><a name="line-494"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span>
</span><a name="line-495"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Michelson.Untyped.Aliases.html#Contract"><span class="hs-identifier hs-type">U.Contract</span></a><span>
</span><a name="line-496"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><a href="Michelson.TypeCheck.Error.html#TCError"><span class="hs-identifier hs-type">TCError</span></a><span> </span><a href="Michelson.TypeCheck.Types.html#SomeContract"><span class="hs-identifier hs-type">SomeContract</span></a><span class="hs-special">)</span><span>
</span><a name="line-497"></a><a name="typeCheckWithDb"><a href="Michelson.Runtime.html#typeCheckWithDb"><span class="hs-identifier">typeCheckWithDb</span></a></a><span> </span><a name="local-6989586621680577749"><a href="#local-6989586621680577749"><span class="hs-identifier">dbPath</span></a></a><span> </span><a name="local-6989586621680577750"><a href="#local-6989586621680577750"><span class="hs-identifier">morleyContract</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-498"></a><span>  </span><a name="local-6989586621680577751"><a href="#local-6989586621680577751"><span class="hs-identifier">gState</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Michelson.Runtime.GState.html#readGState"><span class="hs-identifier hs-var">readGState</span></a><span> </span><a href="#local-6989586621680577749"><span class="hs-identifier hs-var">dbPath</span></a><span>
</span><a name="line-499"></a><span>  </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Michelson.TypeCheck.Instr.html#typeCheckContract"><span class="hs-identifier hs-var">typeCheckContract</span></a><span> </span><span class="hs-special">(</span><a href="Michelson.Runtime.GState.html#extractAllContracts"><span class="hs-identifier hs-var">extractAllContracts</span></a><span> </span><a href="#local-6989586621680577751"><span class="hs-identifier hs-var">gState</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621680577750"><span class="hs-identifier hs-var">morleyContract</span></a><span>
</span><a name="line-500"></a><span>
</span><a name="line-501"></a><span class="hs-comment">----------------------------------------------------------------------------</span><span>
</span><a name="line-502"></a><span class="hs-comment">-- Simple helpers</span><span>
</span><a name="line-503"></a><span class="hs-comment">----------------------------------------------------------------------------</span><span>
</span><a name="line-504"></a><span>
</span><a name="line-505"></a><span class="hs-comment">-- The argument is the address of the contract that generation this operation.</span><span>
</span><a name="line-506"></a><span class="hs-identifier">convertOp</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Tezos.Address.html#Address"><span class="hs-identifier hs-type">Address</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Michelson.Typed.Aliases.html#Operation"><span class="hs-identifier hs-type">T.Operation</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Michelson.Runtime.html#InterpreterOp"><span class="hs-identifier hs-type">InterpreterOp</span></a><span>
</span><a name="line-507"></a><a name="convertOp"><a href="Michelson.Runtime.html#convertOp"><span class="hs-identifier">convertOp</span></a></a><span> </span><a name="local-6989586621680577752"><a href="#local-6989586621680577752"><span class="hs-identifier">interpretedAddr</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-508"></a><span>  </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><a name="line-509"></a><span>    </span><a href="Michelson.Typed.Value.html#OpTransferTokens"><span class="hs-identifier hs-var">OpTransferTokens</span></a><span> </span><a name="local-6989586621680577753"><a href="#local-6989586621680577753"><span class="hs-identifier">tt</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-510"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680577754"><a href="#local-6989586621680577754"><span class="hs-identifier">txData</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-511"></a><span>            </span><a href="Michelson.Runtime.TxData.html#TxData"><span class="hs-identifier hs-var">TxData</span></a><span>
</span><a name="line-512"></a><span>              </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tdSenderAddress</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680577752"><span class="hs-identifier hs-var">interpretedAddr</span></a><span>
</span><a name="line-513"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tdParameter</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Michelson.Typed.Convert.html#untypeValue"><span class="hs-identifier hs-var">untypeValue</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ttContractParameter</span><span> </span><a href="#local-6989586621680577753"><span class="hs-identifier hs-var">tt</span></a><span class="hs-special">)</span><span>
</span><a name="line-514"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tdAmount</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ttAmount</span><span> </span><a href="#local-6989586621680577753"><span class="hs-identifier hs-var">tt</span></a><span>
</span><a name="line-515"></a><span>              </span><span class="hs-special">}</span><span>
</span><a name="line-516"></a><span>          </span><a href="Michelson.Typed.Value.html#VContract"><span class="hs-identifier hs-var">T.VContract</span></a><span> </span><a name="local-6989586621680577755"><a href="#local-6989586621680577755"><span class="hs-identifier">destAddress</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ttContract</span><span> </span><a href="#local-6989586621680577753"><span class="hs-identifier hs-var">tt</span></a><span>
</span><a name="line-517"></a><span>       </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="Michelson.Runtime.html#TransferOp"><span class="hs-identifier hs-var">TransferOp</span></a><span> </span><a href="#local-6989586621680577755"><span class="hs-identifier hs-var">destAddress</span></a><span> </span><a href="#local-6989586621680577754"><span class="hs-identifier hs-var">txData</span></a><span class="hs-special">)</span><span>
</span><a name="line-518"></a><span>    </span><a href="Michelson.Typed.Value.html#OpSetDelegate"><span class="hs-identifier hs-var">OpSetDelegate</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-519"></a><span>    </span><a href="Michelson.Typed.Value.html#OpCreateAccount"><span class="hs-identifier hs-var">OpCreateAccount</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-520"></a><span>    </span><a href="Michelson.Typed.Value.html#OpCreateContract"><span class="hs-identifier hs-var">OpCreateContract</span></a><span> </span><a name="local-6989586621680577756"><a href="#local-6989586621680577756"><span class="hs-identifier">cc</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-521"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680577757"><a href="#local-6989586621680577757"><span class="hs-identifier">origination</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Michelson.Untyped.Instr.html#OriginationOperation"><span class="hs-identifier hs-var">OriginationOperation</span></a><span>
</span><a name="line-522"></a><span>            </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ooManager</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ccManager</span><span> </span><a href="#local-6989586621680577756"><span class="hs-identifier hs-var">cc</span></a><span>
</span><a name="line-523"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ooDelegate</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ccDelegate</span><span> </span><a href="#local-6989586621680577756"><span class="hs-identifier hs-var">cc</span></a><span>
</span><a name="line-524"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ooSpendable</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ccSpendable</span><span> </span><a href="#local-6989586621680577756"><span class="hs-identifier hs-var">cc</span></a><span>
</span><a name="line-525"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ooDelegatable</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ccDelegatable</span><span> </span><a href="#local-6989586621680577756"><span class="hs-identifier hs-var">cc</span></a><span>
</span><a name="line-526"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ooBalance</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ccBalance</span><span> </span><a href="#local-6989586621680577756"><span class="hs-identifier hs-var">cc</span></a><span>
</span><a name="line-527"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ooStorage</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Michelson.Typed.Convert.html#untypeValue"><span class="hs-identifier hs-var">untypeValue</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ccStorageVal</span><span> </span><a href="#local-6989586621680577756"><span class="hs-identifier hs-var">cc</span></a><span class="hs-special">)</span><span>
</span><a name="line-528"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ooContract</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Michelson.Typed.Convert.html#convertContract"><span class="hs-identifier hs-var">convertContract</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ccContractCode</span><span> </span><a href="#local-6989586621680577756"><span class="hs-identifier hs-var">cc</span></a><span class="hs-special">)</span><span>
</span><a name="line-529"></a><span>            </span><span class="hs-special">}</span><span>
</span><a name="line-530"></a><span>       </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="Michelson.Runtime.html#OriginateOp"><span class="hs-identifier hs-var">OriginateOp</span></a><span> </span><a href="#local-6989586621680577757"><span class="hs-identifier hs-var">origination</span></a><span class="hs-special">)</span><span>
</span><a name="line-531"></a></pre></body></html>