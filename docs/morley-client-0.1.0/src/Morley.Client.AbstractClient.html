<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Morley.Client.AbstractClient</span><span>
</span><a name="line-2"></a><span>  </span><span class="hs-special">(</span><span> </span><a href="Morley.Client.AbstractClient.html#HasTezosNodeRpc"><span class="hs-identifier hs-type">HasTezosNodeRpc</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-3"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-4"></a><span>
</span><a name="line-5"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Concurrent</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">threadDelay</span><span class="hs-special">)</span><span>
</span><a name="line-6"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Servant.Client</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ClientEnv</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">runClientM</span><span class="hs-special">)</span><span>
</span><a name="line-7"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Tezos.Common.Json</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TezosInt64</span><span class="hs-special">)</span><span>
</span><a name="line-8"></a><span>
</span><a name="line-9"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util.ByteString</span><span>
</span><a name="line-10"></a><span>
</span><a name="line-11"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Morley.Client.API.html"><span class="hs-identifier">Morley.Client.API</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">API</span><span>
</span><a name="line-12"></a><span class="hs-keyword">import</span><span> </span><a href="Morley.Client.Types.html"><span class="hs-identifier">Morley.Client.Types</span></a><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span> </span><a href="Morley.Client.Util.html"><span class="hs-identifier">Morley.Client.Util</span></a><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Tezos.Address</span><span>
</span><a name="line-15"></a><span>
</span><a name="line-16"></a><span class="hs-comment">-- | Type class which provides basic low-level tezos-node functionality</span><span>
</span><a name="line-17"></a><span class="hs-keyword">class</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679372499"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadThrow</span><span> </span><a href="#local-6989586621679372499"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a name="HasTezosNodeRpc"><a href="Morley.Client.AbstractClient.html#HasTezosNodeRpc"><span class="hs-identifier">HasTezosNodeRpc</span></a></a><span> </span><a name="local-6989586621679372499"><a href="#local-6989586621679372499"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-18"></a><span>  </span><a name="getHeadBlock"><a href="Morley.Client.AbstractClient.html#getHeadBlock"><span class="hs-identifier">getHeadBlock</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679372499"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Text</span><span>
</span><a name="line-19"></a><span>  </span><span class="hs-comment">-- ^ Get hash of the current head block, this head hash is used in other</span><span>
</span><a name="line-20"></a><span>  </span><span class="hs-comment">-- RPC calls.</span><span>
</span><a name="line-21"></a><span>  </span><a name="getCounter"><a href="Morley.Client.AbstractClient.html#getCounter"><span class="hs-identifier">getCounter</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Address</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679372499"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">TezosInt64</span><span>
</span><a name="line-22"></a><span>  </span><span class="hs-comment">-- ^ Get address counter, which is required for both transaction sending</span><span>
</span><a name="line-23"></a><span>  </span><span class="hs-comment">-- and contract origination.</span><span>
</span><a name="line-24"></a><span>  </span><a name="getBlockConstants"><a href="Morley.Client.AbstractClient.html#getBlockConstants"><span class="hs-identifier">getBlockConstants</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679372499"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Morley.Client.Types.html#BlockConstants"><span class="hs-identifier hs-type">BlockConstants</span></a><span>
</span><a name="line-25"></a><span>  </span><span class="hs-comment">-- ^ Get block constants that required by other RPC calls.</span><span>
</span><a name="line-26"></a><span>  </span><a name="runOperation"><a href="Morley.Client.AbstractClient.html#runOperation"><span class="hs-identifier">runOperation</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Morley.Client.Types.html#RunOperation"><span class="hs-identifier hs-type">RunOperation</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679372499"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Morley.Client.Types.html#RunOperationResult"><span class="hs-identifier hs-type">RunOperationResult</span></a><span>
</span><a name="line-27"></a><span>  </span><span class="hs-comment">-- ^ Perform operation run, this operation doesn't require proper signing.</span><span>
</span><a name="line-28"></a><span>  </span><span class="hs-comment">-- As a result it returns burned gas and storage diff (also list of originated</span><span>
</span><a name="line-29"></a><span>  </span><span class="hs-comment">-- contracts but their addresses are incorrect due to the fact that operation</span><span>
</span><a name="line-30"></a><span>  </span><span class="hs-comment">-- could be not signed properly) or indicates about operation failure.</span><span>
</span><a name="line-31"></a><span>  </span><a name="preApplyOperations"><a href="Morley.Client.AbstractClient.html#preApplyOperations"><span class="hs-identifier">preApplyOperations</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Morley.Client.Types.html#PreApplyOperation"><span class="hs-identifier hs-type">PreApplyOperation</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679372499"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">[</span><a href="Morley.Client.Types.html#RunOperationResult"><span class="hs-identifier hs-type">RunOperationResult</span></a><span class="hs-special">]</span><span>
</span><a name="line-32"></a><span>  </span><span class="hs-comment">-- ^ Preapply list of operations, each operation has to be signed with sender</span><span>
</span><a name="line-33"></a><span>  </span><span class="hs-comment">-- secret key. As a result it returns list of results each of which has information</span><span>
</span><a name="line-34"></a><span>  </span><span class="hs-comment">-- about burned gas, storage diff size and originated contracts.</span><span>
</span><a name="line-35"></a><span>  </span><a name="forgeOperation"><a href="Morley.Client.AbstractClient.html#forgeOperation"><span class="hs-identifier">forgeOperation</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Morley.Client.Types.html#ForgeOperation"><span class="hs-identifier hs-type">ForgeOperation</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679372499"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">HexJSONByteString</span><span>
</span><a name="line-36"></a><span>  </span><span class="hs-comment">-- ^ Forge operation in order to receive its hexadecimal representation.</span><span>
</span><a name="line-37"></a><span>  </span><a name="injectOperation"><a href="Morley.Client.AbstractClient.html#injectOperation"><span class="hs-identifier">injectOperation</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679372499"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Text</span><span>
</span><a name="line-38"></a><span>  </span><span class="hs-comment">-- ^ Inject operation, note that this operation has to be signed before</span><span>
</span><a name="line-39"></a><span>  </span><span class="hs-comment">-- injection. As a result it returns operation hash.</span><span>
</span><a name="line-40"></a><span>  </span><a name="getContractScript"><a href="Morley.Client.AbstractClient.html#getContractScript"><span class="hs-identifier">getContractScript</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Address</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679372499"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Morley.Client.Types.html#OriginationScript"><span class="hs-identifier hs-type">OriginationScript</span></a><span>
</span><a name="line-41"></a><span>  </span><span class="hs-comment">-- ^ Get code and storage of the desired contract. Note that both code and storage</span><span>
</span><a name="line-42"></a><span>  </span><span class="hs-comment">-- are presented in low-level Micheline representation.</span><span>
</span><a name="line-43"></a><span>  </span><a name="waitForOperationInclusion"><a href="Morley.Client.AbstractClient.html#waitForOperationInclusion"><span class="hs-identifier">waitForOperationInclusion</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679372499"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Text</span><span>
</span><a name="line-44"></a><span>  </span><span class="hs-comment">-- ^ Wait until operation known by some hash is included into the chain.</span><span>
</span><a name="line-45"></a><span>  </span><a name="getContractBigMap"><a href="Morley.Client.AbstractClient.html#getContractBigMap"><span class="hs-identifier">getContractBigMap</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Address</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Morley.Client.Types.html#GetBigMap"><span class="hs-identifier hs-type">GetBigMap</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679372499"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Morley.Client.Types.html#GetBigMapResult"><span class="hs-identifier hs-type">GetBigMapResult</span></a><span>
</span><a name="line-46"></a><span>  </span><span class="hs-comment">-- ^ Get big map value by contract address.</span><span>
</span><a name="line-47"></a><span>
</span><a name="line-48"></a><span class="hs-keyword">instance</span><span> </span><a href="Morley.Client.AbstractClient.html#HasTezosNodeRpc"><span class="hs-identifier hs-type">HasTezosNodeRpc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ReaderT</span><span> </span><span class="hs-identifier hs-type">ClientEnv</span><span> </span><span class="hs-identifier hs-type">IO</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-49"></a><span>  </span><a name="local-8214565720324147400"><a href="Morley.Client.AbstractClient.html#getHeadBlock"><span class="hs-identifier">getHeadBlock</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ReaderT</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679372500"><a href="#local-6989586621679372500"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-50"></a><span>    </span><a href="Morley.Client.Util.html#throwLeft"><span class="hs-identifier hs-var">throwLeft</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">runClientM</span><span> </span><a href="Morley.Client.API.html#getLastBlock"><span class="hs-identifier hs-var">API.getLastBlock</span></a><span> </span><a href="#local-6989586621679372500"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-51"></a><span>  </span><a name="local-8214565720324147401"><a href="Morley.Client.AbstractClient.html#getCounter"><span class="hs-identifier">getCounter</span></a></a><span> </span><a name="local-6989586621679372501"><a href="#local-6989586621679372501"><span class="hs-identifier">addr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ReaderT</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679372502"><a href="#local-6989586621679372502"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-52"></a><span>    </span><a href="Morley.Client.Util.html#throwLeft"><span class="hs-identifier hs-var">throwLeft</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">runClientM</span><span> </span><span class="hs-special">(</span><a href="Morley.Client.API.html#getCounter"><span class="hs-identifier hs-var">API.getCounter</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">formatAddress</span><span> </span><a href="#local-6989586621679372501"><span class="hs-identifier hs-var">addr</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679372502"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-53"></a><span>  </span><a name="local-8214565720324147402"><a href="Morley.Client.AbstractClient.html#getBlockConstants"><span class="hs-identifier">getBlockConstants</span></a></a><span> </span><a name="local-6989586621679372503"><a href="#local-6989586621679372503"><span class="hs-identifier">block</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ReaderT</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679372504"><a href="#local-6989586621679372504"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-54"></a><span>    </span><a href="Morley.Client.Util.html#throwLeft"><span class="hs-identifier hs-var">throwLeft</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">runClientM</span><span> </span><span class="hs-special">(</span><a href="Morley.Client.API.html#getBlockConstants"><span class="hs-identifier hs-var">API.getBlockConstants</span></a><span> </span><a href="#local-6989586621679372503"><span class="hs-identifier hs-var">block</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679372504"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-55"></a><span>  </span><a name="local-8214565720324147403"><a href="Morley.Client.AbstractClient.html#runOperation"><span class="hs-identifier">runOperation</span></a></a><span> </span><a name="local-6989586621679372505"><a href="#local-6989586621679372505"><span class="hs-identifier">runOp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ReaderT</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679372506"><a href="#local-6989586621679372506"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-56"></a><span>    </span><a href="Morley.Client.Util.html#throwLeft"><span class="hs-identifier hs-var">throwLeft</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">runClientM</span><span> </span><span class="hs-special">(</span><a href="Morley.Client.API.html#runOperation"><span class="hs-identifier hs-var">API.runOperation</span></a><span> </span><a href="#local-6989586621679372505"><span class="hs-identifier hs-var">runOp</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679372506"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-57"></a><span>  </span><a name="local-8214565720324147404"><a href="Morley.Client.AbstractClient.html#preApplyOperations"><span class="hs-identifier">preApplyOperations</span></a></a><span> </span><a name="local-6989586621679372507"><a href="#local-6989586621679372507"><span class="hs-identifier">preApplyOps</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ReaderT</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679372508"><a href="#local-6989586621679372508"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-58"></a><span>    </span><a href="Morley.Client.Util.html#throwLeft"><span class="hs-identifier hs-var">throwLeft</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">runClientM</span><span> </span><span class="hs-special">(</span><a href="Morley.Client.API.html#preApplyOperations"><span class="hs-identifier hs-var">API.preApplyOperations</span></a><span> </span><a href="#local-6989586621679372507"><span class="hs-identifier hs-var">preApplyOps</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679372508"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-59"></a><span>  </span><a name="local-8214565720324147405"><a href="Morley.Client.AbstractClient.html#forgeOperation"><span class="hs-identifier">forgeOperation</span></a></a><span> </span><a name="local-6989586621679372509"><a href="#local-6989586621679372509"><span class="hs-identifier">forgeOp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ReaderT</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679372510"><a href="#local-6989586621679372510"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-60"></a><span>    </span><a href="Morley.Client.Util.html#throwLeft"><span class="hs-identifier hs-var">throwLeft</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">runClientM</span><span> </span><span class="hs-special">(</span><a href="Morley.Client.API.html#forgeOperation"><span class="hs-identifier hs-var">API.forgeOperation</span></a><span> </span><a href="#local-6989586621679372509"><span class="hs-identifier hs-var">forgeOp</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679372510"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-61"></a><span>  </span><a name="local-8214565720324147406"><a href="Morley.Client.AbstractClient.html#injectOperation"><span class="hs-identifier">injectOperation</span></a></a><span> </span><a name="local-6989586621679372511"><a href="#local-6989586621679372511"><span class="hs-identifier">op</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ReaderT</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679372512"><a href="#local-6989586621679372512"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-62"></a><span>    </span><a href="Morley.Client.Util.html#throwLeft"><span class="hs-identifier hs-var">throwLeft</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">runClientM</span><span> </span><span class="hs-special">(</span><a href="Morley.Client.API.html#injectOperation"><span class="hs-identifier hs-var">API.injectOperation</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-string">&quot;main&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679372511"><span class="hs-identifier hs-var">op</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679372512"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-63"></a><span>  </span><a name="local-8214565720324147407"><a href="Morley.Client.AbstractClient.html#getContractScript"><span class="hs-identifier">getContractScript</span></a></a><span> </span><a name="local-6989586621679372513"><a href="#local-6989586621679372513"><span class="hs-identifier">addr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ReaderT</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679372514"><a href="#local-6989586621679372514"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-64"></a><span>    </span><a href="Morley.Client.Util.html#throwLeft"><span class="hs-identifier hs-var">throwLeft</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">runClientM</span><span> </span><span class="hs-special">(</span><a href="Morley.Client.API.html#getScript"><span class="hs-identifier hs-var">API.getScript</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">formatAddress</span><span> </span><a href="#local-6989586621679372513"><span class="hs-identifier hs-var">addr</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679372514"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-65"></a><span>  </span><a name="local-8214565720324147409"><a href="Morley.Client.AbstractClient.html#getContractBigMap"><span class="hs-identifier">getContractBigMap</span></a></a><span> </span><a name="local-6989586621679372515"><a href="#local-6989586621679372515"><span class="hs-identifier">addr</span></a></a><span> </span><a name="local-6989586621679372516"><a href="#local-6989586621679372516"><span class="hs-identifier">req</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ReaderT</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679372517"><a href="#local-6989586621679372517"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-66"></a><span>    </span><a href="Morley.Client.Util.html#throwLeft"><span class="hs-identifier hs-var">throwLeft</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">runClientM</span><span> </span><span class="hs-special">(</span><a href="Morley.Client.API.html#getBigMap"><span class="hs-identifier hs-var">API.getBigMap</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">formatAddress</span><span> </span><a href="#local-6989586621679372515"><span class="hs-identifier hs-var">addr</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679372516"><span class="hs-identifier hs-var">req</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679372517"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-67"></a><span>  </span><a name="local-8214565720324147408"><a href="Morley.Client.AbstractClient.html#waitForOperationInclusion"><span class="hs-identifier">waitForOperationInclusion</span></a></a><span> </span><a name="local-6989586621679372518"><a href="#local-6989586621679372518"><span class="hs-identifier">op</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ReaderT</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679372519"><span class="hs-identifier hs-var">waitImpl</span></a><span>
</span><a name="line-68"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-69"></a><span>      </span><span class="hs-identifier">waitImpl</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ClientEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">Text</span><span>
</span><a name="line-70"></a><span>      </span><a name="local-6989586621679372519"><a href="#local-6989586621679372519"><span class="hs-identifier">waitImpl</span></a></a><span> </span><a name="local-6989586621679372520"><a href="#local-6989586621679372520"><span class="hs-identifier">env'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-71"></a><span>        </span><a name="local-6989586621679372521"><a href="#local-6989586621679372521"><span class="hs-identifier">headBlock</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Morley.Client.Util.html#throwLeft"><span class="hs-identifier hs-var">throwLeft</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">runClientM</span><span> </span><a href="Morley.Client.API.html#getLastBlock"><span class="hs-identifier hs-var">API.getLastBlock</span></a><span> </span><a href="#local-6989586621679372520"><span class="hs-identifier hs-var">env'</span></a><span>
</span><a name="line-72"></a><span>        </span><a name="local-6989586621679373578"><a href="#local-6989586621679373578"><span class="hs-identifier">operations</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">concat</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Morley.Client.Util.html#throwLeft"><span class="hs-identifier hs-var">throwLeft</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-73"></a><span>          </span><span class="hs-identifier hs-var">runClientM</span><span> </span><span class="hs-special">(</span><a href="Morley.Client.API.html#getHeadBlockOperations"><span class="hs-identifier hs-var">API.getHeadBlockOperations</span></a><span> </span><a href="#local-6989586621679372521"><span class="hs-identifier hs-var">headBlock</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679372520"><span class="hs-identifier hs-var">env'</span></a><span>
</span><a name="line-74"></a><span>        </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a href="Morley.Client.Types.html#BlockOperation"><span class="hs-identifier hs-var">BlockOperation</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679373579"><span class="hs-identifier hs-var">boHash</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621679372518"><span class="hs-identifier hs-var">op</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679373578"><span class="hs-identifier hs-var">operations</span></a><span>
</span><a name="line-75"></a><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621679372521"><span class="hs-identifier hs-var">headBlock</span></a><span>
</span><a name="line-76"></a><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-77"></a><span>          </span><span class="hs-comment">-- Block period varies in different chains (e.g. babylonnet has 30 seconds</span><span>
</span><a name="line-78"></a><span>          </span><span class="hs-comment">-- and mainnet has 60 seconds), here we wait 10 seconds, so that we definitely</span><span>
</span><a name="line-79"></a><span>          </span><span class="hs-comment">-- won't miss the head with desired operation.</span><span>
</span><a name="line-80"></a><span>          </span><span class="hs-identifier hs-var">threadDelay</span><span> </span><span class="hs-number">1e7</span><span>
</span><a name="line-81"></a><span>          </span><a href="#local-6989586621679372519"><span class="hs-identifier hs-var">waitImpl</span></a><span> </span><a href="#local-6989586621679372520"><span class="hs-identifier hs-var">env'</span></a><span>
</span><a name="line-82"></a></pre></body></html>