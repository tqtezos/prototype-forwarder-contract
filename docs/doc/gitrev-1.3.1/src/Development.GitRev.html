<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE LambdaCase #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE MultiWayIf #-}</span><span>
</span><a name="line-3"></a><span>
</span><a name="line-4"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-5"></a><span class="hs-comment">-- Module      :  $Header$</span><span>
</span><a name="line-6"></a><span class="hs-comment">-- Copyright   :  (c) 2015 Adam C. Foltzer</span><span>
</span><a name="line-7"></a><span class="hs-comment">-- License     :  BSD3</span><span>
</span><a name="line-8"></a><span class="hs-comment">-- Maintainer  :  acfoltzer@galois.com</span><span>
</span><a name="line-9"></a><span class="hs-comment">-- Stability   :  provisional</span><span>
</span><a name="line-10"></a><span class="hs-comment">-- Portability :  portable</span><span>
</span><a name="line-11"></a><span class="hs-comment">--</span><span>
</span><a name="line-12"></a><span class="hs-comment">-- Some handy Template Haskell splices for including the current git</span><span>
</span><a name="line-13"></a><span class="hs-comment">-- hash and branch in the code of your project. Useful for including</span><span>
</span><a name="line-14"></a><span class="hs-comment">-- in panic messages, @--version@ output, or diagnostic info for more</span><span>
</span><a name="line-15"></a><span class="hs-comment">-- informative bug reports.</span><span>
</span><a name="line-16"></a><span class="hs-comment">--</span><span>
</span><a name="line-17"></a><span class="hs-comment">-- &gt; {-# LANGUAGE TemplateHaskell #-}</span><span>
</span><a name="line-18"></a><span class="hs-comment">-- &gt; import Development.GitRev</span><span>
</span><a name="line-19"></a><span class="hs-comment">-- &gt;</span><span>
</span><a name="line-20"></a><span class="hs-comment">-- &gt; panic :: String -&gt; a</span><span>
</span><a name="line-21"></a><span class="hs-comment">-- &gt; panic msg = error panicMsg</span><span>
</span><a name="line-22"></a><span class="hs-comment">-- &gt;   where panicMsg =</span><span>
</span><a name="line-23"></a><span class="hs-comment">-- &gt;           concat [ &quot;[panic &quot;, $(gitBranch), &quot;@&quot;, $(gitHash)</span><span>
</span><a name="line-24"></a><span class="hs-comment">-- &gt;                  , &quot; (&quot;, $(gitCommitDate), &quot;)&quot;</span><span>
</span><a name="line-25"></a><span class="hs-comment">-- &gt;                  , &quot; (&quot;, $(gitCommitCount), &quot; commits in HEAD)&quot;</span><span>
</span><a name="line-26"></a><span class="hs-comment">-- &gt;                  , dirty, &quot;] &quot;, msg ]</span><span>
</span><a name="line-27"></a><span class="hs-comment">-- &gt;         dirty | $(gitDirty) = &quot; (uncommitted files present)&quot;</span><span>
</span><a name="line-28"></a><span class="hs-comment">-- &gt;               | otherwise   = &quot;&quot;</span><span>
</span><a name="line-29"></a><span class="hs-comment">-- &gt;</span><span>
</span><a name="line-30"></a><span class="hs-comment">-- &gt; main = panic &quot;oh no!&quot;</span><span>
</span><a name="line-31"></a><span class="hs-comment">--</span><span>
</span><a name="line-32"></a><span class="hs-comment">-- &gt; % cabal exec runhaskell Example.hs</span><span>
</span><a name="line-33"></a><span class="hs-comment">-- &gt; Example.hs: [panic master@2ae047ba5e4a6f0f3e705a43615363ac006099c1 (Mon Jan 11 11:50:59 2016 -0800) (14 commits in HEAD) (uncommitted files present)] oh no!</span><span>
</span><a name="line-34"></a><span>
</span><a name="line-35"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Development.GitRev</span><span>
</span><a name="line-36"></a><span>  </span><span class="hs-special">(</span><span> </span><a href="Development.GitRev.html#gitBranch"><span class="hs-identifier hs-var">gitBranch</span></a><span>
</span><a name="line-37"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Development.GitRev.html#gitCommitCount"><span class="hs-identifier hs-var">gitCommitCount</span></a><span>
</span><a name="line-38"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Development.GitRev.html#gitCommitDate"><span class="hs-identifier hs-var">gitCommitDate</span></a><span>
</span><a name="line-39"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Development.GitRev.html#gitDescribe"><span class="hs-identifier hs-var">gitDescribe</span></a><span>
</span><a name="line-40"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Development.GitRev.html#gitDirty"><span class="hs-identifier hs-var">gitDirty</span></a><span>
</span><a name="line-41"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Development.GitRev.html#gitDirtyTracked"><span class="hs-identifier hs-var">gitDirtyTracked</span></a><span>
</span><a name="line-42"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Development.GitRev.html#gitHash"><span class="hs-identifier hs-var">gitHash</span></a><span>
</span><a name="line-43"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-44"></a><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Exception</span><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Maybe</span><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Language.Haskell.TH</span><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Language.Haskell.TH.Syntax</span><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.Directory</span><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.Exit</span><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.FilePath</span><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.Process</span><span>
</span><a name="line-54"></a><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Prelude</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-56"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Prelude.Compat</span><span>
</span><a name="line-57"></a><span>
</span><a name="line-58"></a><span class="hs-comment">-- | Run git with the given arguments and no stdin, returning the</span><span>
</span><a name="line-59"></a><span class="hs-comment">-- stdout output. If git isn't available or something goes wrong,</span><span>
</span><a name="line-60"></a><span class="hs-comment">-- return the second argument.</span><span>
</span><a name="line-61"></a><span class="hs-identifier">runGit</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Development.GitRev.html#IndexUsed"><span class="hs-identifier hs-type">IndexUsed</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-62"></a><a name="runGit"><a href="Development.GitRev.html#runGit"><span class="hs-identifier">runGit</span></a></a><span> </span><a name="local-6989586621679038427"><a href="#local-6989586621679038427"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621679038428"><a href="#local-6989586621679038428"><span class="hs-identifier">def</span></a></a><span> </span><a name="local-6989586621679038429"><a href="#local-6989586621679038429"><span class="hs-identifier">useIdx</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-63"></a><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">oops</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SomeException</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ExitCode</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">String</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">String</span><span class="hs-special">)</span><span>
</span><a name="line-64"></a><span>      </span><a name="local-6989586621679038430"><a href="#local-6989586621679038430"><span class="hs-identifier">oops</span></a></a><span> </span><a name="local-6989586621679039454"><a href="#local-6989586621679039454"><span class="hs-identifier">_e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ExitFailure</span><span> </span><span class="hs-number">1</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679038428"><span class="hs-identifier hs-var">def</span></a><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-65"></a><span>  </span><a name="local-6989586621679039469"><a href="#local-6989586621679039469"><span class="hs-identifier">gitFound</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">runIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">isJust</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">findExecutable</span><span> </span><span class="hs-string">&quot;git&quot;</span><span>
</span><a name="line-66"></a><span>  </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679039469"><span class="hs-identifier hs-var">gitFound</span></a><span>
</span><a name="line-67"></a><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-68"></a><span>      </span><span class="hs-comment">-- a lot of bookkeeping to record the right dependencies</span><span>
</span><a name="line-69"></a><span>      </span><a name="local-6989586621679039470"><a href="#local-6989586621679039470"><span class="hs-identifier">pwd</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">runIO</span><span> </span><a href="Development.GitRev.html#getDotGit"><span class="hs-identifier hs-var">getDotGit</span></a><span>
</span><a name="line-70"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679039471"><a href="#local-6989586621679039471"><span class="hs-identifier">hd</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679039470"><span class="hs-identifier hs-var">pwd</span></a><span> </span><span class="hs-operator hs-var">&lt;/&gt;</span><span> </span><span class="hs-string">&quot;.git&quot;</span><span> </span><span class="hs-operator hs-var">&lt;/&gt;</span><span> </span><span class="hs-string">&quot;HEAD&quot;</span><span>
</span><a name="line-71"></a><span>          </span><a name="local-6989586621679039472"><a href="#local-6989586621679039472"><span class="hs-identifier">index</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679039470"><span class="hs-identifier hs-var">pwd</span></a><span> </span><span class="hs-operator hs-var">&lt;/&gt;</span><span> </span><span class="hs-string">&quot;.git&quot;</span><span> </span><span class="hs-operator hs-var">&lt;/&gt;</span><span> </span><span class="hs-string">&quot;index&quot;</span><span>
</span><a name="line-72"></a><span>          </span><a name="local-6989586621679039473"><a href="#local-6989586621679039473"><span class="hs-identifier">packedRefs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679039470"><span class="hs-identifier hs-var">pwd</span></a><span> </span><span class="hs-operator hs-var">&lt;/&gt;</span><span> </span><span class="hs-string">&quot;.git&quot;</span><span> </span><span class="hs-operator hs-var">&lt;/&gt;</span><span> </span><span class="hs-string">&quot;packed-refs&quot;</span><span>
</span><a name="line-73"></a><span>      </span><a name="local-6989586621679039606"><a href="#local-6989586621679039606"><span class="hs-identifier">hdExists</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">runIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">doesFileExist</span><span> </span><a href="#local-6989586621679039471"><span class="hs-identifier hs-var">hd</span></a><span>
</span><a name="line-74"></a><span>      </span><span class="hs-identifier hs-var">when</span><span> </span><a href="#local-6989586621679039606"><span class="hs-identifier hs-var">hdExists</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-75"></a><span>        </span><span class="hs-comment">-- the HEAD file either contains the hash of a detached head</span><span>
</span><a name="line-76"></a><span>        </span><span class="hs-comment">-- or a pointer to the file that contains the hash of the head</span><span>
</span><a name="line-77"></a><span>        </span><span class="hs-identifier hs-var">splitAt</span><span> </span><span class="hs-number">5</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">fmap</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">runIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">readFile</span><span> </span><a href="#local-6989586621679039471"><span class="hs-identifier hs-var">hd</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><a name="line-78"></a><span>          </span><span class="hs-comment">-- pointer to ref</span><span>
</span><a name="line-79"></a><span>          </span><span class="hs-special">(</span><span class="hs-string">&quot;ref: &quot;</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679039955"><a href="#local-6989586621679039955"><span class="hs-identifier">relRef</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-80"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679039956"><a href="#local-6989586621679039956"><span class="hs-identifier">ref</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679039470"><span class="hs-identifier hs-var">pwd</span></a><span> </span><span class="hs-operator hs-var">&lt;/&gt;</span><span> </span><span class="hs-string">&quot;.git&quot;</span><span> </span><span class="hs-operator hs-var">&lt;/&gt;</span><span> </span><a href="#local-6989586621679039955"><span class="hs-identifier hs-var">relRef</span></a><span>
</span><a name="line-81"></a><span>            </span><a name="local-6989586621679039957"><a href="#local-6989586621679039957"><span class="hs-identifier">refExists</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">runIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">doesFileExist</span><span> </span><a href="#local-6989586621679039956"><span class="hs-identifier hs-var">ref</span></a><span>
</span><a name="line-82"></a><span>            </span><span class="hs-identifier hs-var">when</span><span> </span><a href="#local-6989586621679039957"><span class="hs-identifier hs-var">refExists</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">addDependentFile</span><span> </span><a href="#local-6989586621679039956"><span class="hs-identifier hs-var">ref</span></a><span>
</span><a name="line-83"></a><span>          </span><span class="hs-comment">-- detached head</span><span>
</span><a name="line-84"></a><span>          </span><a name="local-6989586621679039958"><a href="#local-6989586621679039958"><span class="hs-identifier">_hash</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">addDependentFile</span><span> </span><a href="#local-6989586621679039471"><span class="hs-identifier hs-var">hd</span></a><span>
</span><a name="line-85"></a><span>      </span><span class="hs-comment">-- add the index if it exists to set the dirty flag</span><span>
</span><a name="line-86"></a><span>      </span><a name="local-6989586621679039959"><a href="#local-6989586621679039959"><span class="hs-identifier">indexExists</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">runIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">doesFileExist</span><span> </span><a href="#local-6989586621679039472"><span class="hs-identifier hs-var">index</span></a><span>
</span><a name="line-87"></a><span>      </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679039959"><span class="hs-identifier hs-var">indexExists</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621679038429"><span class="hs-identifier hs-var">useIdx</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="Development.GitRev.html#IdxUsed"><span class="hs-identifier hs-var">IdxUsed</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">addDependentFile</span><span> </span><a href="#local-6989586621679039472"><span class="hs-identifier hs-var">index</span></a><span>
</span><a name="line-88"></a><span>      </span><span class="hs-comment">-- if the refs have been packed, the info we're looking for</span><span>
</span><a name="line-89"></a><span>      </span><span class="hs-comment">-- might be in that file rather than the one-file-per-ref case</span><span>
</span><a name="line-90"></a><span>      </span><span class="hs-comment">-- handled above</span><span>
</span><a name="line-91"></a><span>      </span><a name="local-6989586621679039960"><a href="#local-6989586621679039960"><span class="hs-identifier">packedExists</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">runIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">doesFileExist</span><span> </span><a href="#local-6989586621679039473"><span class="hs-identifier hs-var">packedRefs</span></a><span>
</span><a name="line-92"></a><span>      </span><span class="hs-identifier hs-var">when</span><span> </span><a href="#local-6989586621679039960"><span class="hs-identifier hs-var">packedExists</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">addDependentFile</span><span> </span><a href="#local-6989586621679039473"><span class="hs-identifier hs-var">packedRefs</span></a><span>
</span><a name="line-93"></a><span>      </span><span class="hs-identifier hs-var">runIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-94"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621679039961"><a href="#local-6989586621679039961"><span class="hs-identifier">code</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679039962"><a href="#local-6989586621679039962"><span class="hs-identifier">out</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679039963"><a href="#local-6989586621679039963"><span class="hs-identifier">_err</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readProcessWithExitCode</span><span> </span><span class="hs-string">&quot;git&quot;</span><span> </span><a href="#local-6989586621679038427"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">catch</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679038430"><span class="hs-identifier hs-var">oops</span></a><span>
</span><a name="line-95"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679039961"><span class="hs-identifier hs-var">code</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-96"></a><span>          </span><span class="hs-identifier hs-var">ExitSuccess</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">takeWhile</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-char">'\n'</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679039962"><span class="hs-identifier hs-var">out</span></a><span class="hs-special">)</span><span>
</span><a name="line-97"></a><span>          </span><span class="hs-identifier hs-var">ExitFailure</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679038428"><span class="hs-identifier hs-var">def</span></a><span>
</span><a name="line-98"></a><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679038428"><span class="hs-identifier hs-var">def</span></a><span>
</span><a name="line-99"></a><span>
</span><a name="line-100"></a><span class="hs-comment">-- | Determine where our @.git@ directory is, in case we're in a</span><span>
</span><a name="line-101"></a><span class="hs-comment">-- submodule.</span><span>
</span><a name="line-102"></a><span class="hs-identifier">getDotGit</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span>
</span><a name="line-103"></a><a name="getDotGit"><a href="Development.GitRev.html#getDotGit"><span class="hs-identifier">getDotGit</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-104"></a><span>  </span><a name="local-6989586621679039964"><a href="#local-6989586621679039964"><span class="hs-identifier">pwd</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Development.GitRev.html#getGitRoot"><span class="hs-identifier hs-var">getGitRoot</span></a><span>
</span><a name="line-105"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679039965"><a href="#local-6989586621679039965"><span class="hs-identifier">dotGit</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679039964"><span class="hs-identifier hs-var">pwd</span></a><span> </span><span class="hs-operator hs-var">&lt;/&gt;</span><span> </span><span class="hs-string">&quot;.git&quot;</span><span>
</span><a name="line-106"></a><span>      </span><a name="local-6989586621679039966"><a href="#local-6989586621679039966"><span class="hs-identifier">oops</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679039965"><span class="hs-identifier hs-var">dotGit</span></a><span> </span><span class="hs-comment">-- it's gonna fail, that's fine</span><span>
</span><a name="line-107"></a><span>  </span><a name="local-6989586621679039967"><a href="#local-6989586621679039967"><span class="hs-identifier">isDir</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">doesDirectoryExist</span><span> </span><a href="#local-6989586621679039965"><span class="hs-identifier hs-var">dotGit</span></a><span>
</span><a name="line-108"></a><span>  </span><a name="local-6989586621679039968"><a href="#local-6989586621679039968"><span class="hs-identifier">isFile</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">doesFileExist</span><span> </span><a href="#local-6989586621679039965"><span class="hs-identifier hs-var">dotGit</span></a><span>
</span><a name="line-109"></a><span>  </span><span class="hs-keyword">if</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679039967"><span class="hs-identifier hs-var">isDir</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679039965"><span class="hs-identifier hs-var">dotGit</span></a><span>
</span><a name="line-110"></a><span>     </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621679039968"><span class="hs-identifier hs-var">isFile</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679039966"><span class="hs-identifier hs-var">oops</span></a><span>
</span><a name="line-111"></a><span>     </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679039968"><span class="hs-identifier hs-var">isFile</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-112"></a><span>         </span><span class="hs-identifier hs-var">splitAt</span><span> </span><span class="hs-number">8</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">fmap</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">readFile</span><span> </span><a href="#local-6989586621679039965"><span class="hs-identifier hs-var">dotGit</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><a name="line-113"></a><span>           </span><span class="hs-special">(</span><span class="hs-string">&quot;gitdir: &quot;</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679039969"><a href="#local-6989586621679039969"><span class="hs-identifier">relDir</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-114"></a><span>             </span><a name="local-6989586621679039970"><a href="#local-6989586621679039970"><span class="hs-identifier">isRelDir</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">doesDirectoryExist</span><span> </span><a href="#local-6989586621679039969"><span class="hs-identifier hs-var">relDir</span></a><span>
</span><a name="line-115"></a><span>             </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679039970"><span class="hs-identifier hs-var">isRelDir</span></a><span>
</span><a name="line-116"></a><span>               </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679039969"><span class="hs-identifier hs-var">relDir</span></a><span>
</span><a name="line-117"></a><span>               </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621679039966"><span class="hs-identifier hs-var">oops</span></a><span>
</span><a name="line-118"></a><span>           </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679039966"><span class="hs-identifier hs-var">oops</span></a><span>
</span><a name="line-119"></a><span>
</span><a name="line-120"></a><span class="hs-comment">-- | Get the root directory of the Git repo.</span><span>
</span><a name="line-121"></a><span class="hs-identifier">getGitRoot</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span>
</span><a name="line-122"></a><a name="getGitRoot"><a href="Development.GitRev.html#getGitRoot"><span class="hs-identifier">getGitRoot</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-123"></a><span>  </span><a name="local-6989586621679039971"><a href="#local-6989586621679039971"><span class="hs-identifier">pwd</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getCurrentDirectory</span><span>
</span><a name="line-124"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679039972"><a href="#local-6989586621679039972"><span class="hs-identifier">code</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679039973"><a href="#local-6989586621679039973"><span class="hs-identifier">out</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-125"></a><span>    </span><span class="hs-identifier hs-var">readProcessWithExitCode</span><span> </span><span class="hs-string">&quot;git&quot;</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;rev-parse&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;--show-toplevel&quot;</span><span class="hs-special">]</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-126"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679039972"><span class="hs-identifier hs-var">code</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-127"></a><span>    </span><span class="hs-identifier hs-var">ExitSuccess</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">takeWhile</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-char">'\n'</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679039973"><span class="hs-identifier hs-var">out</span></a><span>
</span><a name="line-128"></a><span>    </span><span class="hs-identifier hs-var">ExitFailure</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679039971"><span class="hs-identifier hs-var">pwd</span></a><span> </span><span class="hs-comment">-- later steps will fail, that's fine</span><span>
</span><a name="line-129"></a><span>
</span><a name="line-130"></a><span class="hs-comment">-- | Type to flag if the git index is used or not in a call to runGit</span><span>
</span><a name="line-131"></a><span class="hs-keyword">data</span><span> </span><a name="IndexUsed"><a href="Development.GitRev.html#IndexUsed"><span class="hs-identifier">IndexUsed</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="IdxUsed"><a href="Development.GitRev.html#IdxUsed"><span class="hs-identifier">IdxUsed</span></a></a><span> </span><span class="hs-comment">-- ^ The git index is used</span><span>
</span><a name="line-132"></a><span>               </span><span class="hs-glyph">|</span><span> </span><a name="IdxNotUsed"><a href="Development.GitRev.html#IdxNotUsed"><span class="hs-identifier">IdxNotUsed</span></a></a><span> </span><span class="hs-comment">-- ^ The git index is /not/ used</span><span>
</span><a name="line-133"></a><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">)</span><span>
</span><a name="line-134"></a><span>
</span><a name="line-135"></a><span class="hs-comment">-- | Return the hash of the current git commit, or @UNKNOWN@ if not in</span><span>
</span><a name="line-136"></a><span class="hs-comment">-- a git repository</span><span>
</span><a name="line-137"></a><span class="hs-identifier">gitHash</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ExpQ</span><span>
</span><a name="line-138"></a><a name="gitHash"><a href="Development.GitRev.html#gitHash"><span class="hs-identifier">gitHash</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-139"></a><span>  </span><span class="hs-identifier hs-var">stringE</span><span> </span><span class="hs-operator hs-var">=&lt;&lt;</span><span> </span><a href="Development.GitRev.html#runGit"><span class="hs-identifier hs-var">runGit</span></a><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;rev-parse&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;HEAD&quot;</span><span class="hs-special">]</span><span> </span><span class="hs-string">&quot;UNKNOWN&quot;</span><span> </span><a href="Development.GitRev.html#IdxNotUsed"><span class="hs-identifier hs-var">IdxNotUsed</span></a><span>
</span><a name="line-140"></a><span>
</span><a name="line-141"></a><span class="hs-comment">-- | Return the branch (or tag) name of the current git commit, or @UNKNOWN@</span><span>
</span><a name="line-142"></a><span class="hs-comment">-- if not in a git repository. For detached heads, this will just be</span><span>
</span><a name="line-143"></a><span class="hs-comment">-- &quot;HEAD&quot;</span><span>
</span><a name="line-144"></a><span class="hs-identifier">gitBranch</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ExpQ</span><span>
</span><a name="line-145"></a><a name="gitBranch"><a href="Development.GitRev.html#gitBranch"><span class="hs-identifier">gitBranch</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-146"></a><span>  </span><span class="hs-identifier hs-var">stringE</span><span> </span><span class="hs-operator hs-var">=&lt;&lt;</span><span> </span><a href="Development.GitRev.html#runGit"><span class="hs-identifier hs-var">runGit</span></a><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;rev-parse&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;--abbrev-ref&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;HEAD&quot;</span><span class="hs-special">]</span><span> </span><span class="hs-string">&quot;UNKNOWN&quot;</span><span> </span><a href="Development.GitRev.html#IdxNotUsed"><span class="hs-identifier hs-var">IdxNotUsed</span></a><span>
</span><a name="line-147"></a><span>
</span><a name="line-148"></a><span class="hs-comment">-- | Return the long git description for the current git commit, or</span><span>
</span><a name="line-149"></a><span class="hs-comment">-- @UNKNOWN@ if not in a git repository.</span><span>
</span><a name="line-150"></a><span class="hs-identifier">gitDescribe</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ExpQ</span><span>
</span><a name="line-151"></a><a name="gitDescribe"><a href="Development.GitRev.html#gitDescribe"><span class="hs-identifier">gitDescribe</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-152"></a><span>  </span><span class="hs-identifier hs-var">stringE</span><span> </span><span class="hs-operator hs-var">=&lt;&lt;</span><span> </span><a href="Development.GitRev.html#runGit"><span class="hs-identifier hs-var">runGit</span></a><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;describe&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;--long&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;--always&quot;</span><span class="hs-special">]</span><span> </span><span class="hs-string">&quot;UNKNOWN&quot;</span><span> </span><a href="Development.GitRev.html#IdxNotUsed"><span class="hs-identifier hs-var">IdxNotUsed</span></a><span>
</span><a name="line-153"></a><span>
</span><a name="line-154"></a><span class="hs-comment">-- | Return @True@ if there are non-committed files present in the</span><span>
</span><a name="line-155"></a><span class="hs-comment">-- repository</span><span>
</span><a name="line-156"></a><span class="hs-identifier">gitDirty</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ExpQ</span><span>
</span><a name="line-157"></a><a name="gitDirty"><a href="Development.GitRev.html#gitDirty"><span class="hs-identifier">gitDirty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-158"></a><span>  </span><a name="local-6989586621679039974"><a href="#local-6989586621679039974"><span class="hs-identifier">output</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Development.GitRev.html#runGit"><span class="hs-identifier hs-var">runGit</span></a><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;status&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;--porcelain&quot;</span><span class="hs-special">]</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><a href="Development.GitRev.html#IdxUsed"><span class="hs-identifier hs-var">IdxUsed</span></a><span>
</span><a name="line-159"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679039974"><span class="hs-identifier hs-var">output</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-160"></a><span>    </span><span class="hs-string">&quot;&quot;</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">conE</span><span> </span><span class="hs-identifier hs-var">falseName</span><span>
</span><a name="line-161"></a><span>    </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">conE</span><span> </span><span class="hs-identifier hs-var">trueName</span><span>
</span><a name="line-162"></a><span>
</span><a name="line-163"></a><span class="hs-comment">-- | Return @True@ if there are non-commited changes to tracked files</span><span>
</span><a name="line-164"></a><span class="hs-comment">-- present in the repository</span><span>
</span><a name="line-165"></a><span class="hs-identifier">gitDirtyTracked</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ExpQ</span><span>
</span><a name="line-166"></a><a name="gitDirtyTracked"><a href="Development.GitRev.html#gitDirtyTracked"><span class="hs-identifier">gitDirtyTracked</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-167"></a><span>  </span><a name="local-6989586621679039975"><a href="#local-6989586621679039975"><span class="hs-identifier">output</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Development.GitRev.html#runGit"><span class="hs-identifier hs-var">runGit</span></a><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;status&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;--porcelain&quot;</span><span class="hs-special">,</span><span class="hs-string">&quot;--untracked-files=no&quot;</span><span class="hs-special">]</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><a href="Development.GitRev.html#IdxUsed"><span class="hs-identifier hs-var">IdxUsed</span></a><span>
</span><a name="line-168"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679039975"><span class="hs-identifier hs-var">output</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-169"></a><span>    </span><span class="hs-string">&quot;&quot;</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">conE</span><span> </span><span class="hs-identifier hs-var">falseName</span><span>
</span><a name="line-170"></a><span>    </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">conE</span><span> </span><span class="hs-identifier hs-var">trueName</span><span>
</span><a name="line-171"></a><span>
</span><a name="line-172"></a><span class="hs-comment">-- | Return the number of commits in the current head</span><span>
</span><a name="line-173"></a><span class="hs-identifier">gitCommitCount</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ExpQ</span><span>
</span><a name="line-174"></a><a name="gitCommitCount"><a href="Development.GitRev.html#gitCommitCount"><span class="hs-identifier">gitCommitCount</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-175"></a><span>  </span><span class="hs-identifier hs-var">stringE</span><span> </span><span class="hs-operator hs-var">=&lt;&lt;</span><span> </span><a href="Development.GitRev.html#runGit"><span class="hs-identifier hs-var">runGit</span></a><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;rev-list&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;HEAD&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;--count&quot;</span><span class="hs-special">]</span><span> </span><span class="hs-string">&quot;UNKNOWN&quot;</span><span> </span><a href="Development.GitRev.html#IdxNotUsed"><span class="hs-identifier hs-var">IdxNotUsed</span></a><span>
</span><a name="line-176"></a><span>
</span><a name="line-177"></a><span class="hs-comment">-- | Return the commit date of the current head</span><span>
</span><a name="line-178"></a><span class="hs-identifier">gitCommitDate</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ExpQ</span><span>
</span><a name="line-179"></a><a name="gitCommitDate"><a href="Development.GitRev.html#gitCommitDate"><span class="hs-identifier">gitCommitDate</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-180"></a><span>  </span><span class="hs-identifier hs-var">stringE</span><span> </span><span class="hs-operator hs-var">=&lt;&lt;</span><span> </span><a href="Development.GitRev.html#runGit"><span class="hs-identifier hs-var">runGit</span></a><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;log&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;HEAD&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;-1&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;--format=%cd&quot;</span><span class="hs-special">]</span><span> </span><span class="hs-string">&quot;UNKNOWN&quot;</span><span> </span><a href="Development.GitRev.html#IdxNotUsed"><span class="hs-identifier hs-var">IdxNotUsed</span></a><span>
</span><a name="line-181"></a></pre></body></html>