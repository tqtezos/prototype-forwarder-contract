<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Lorentz.Errors.Numeric.Contract</title><link href="ocean.css" rel="stylesheet" type="text/css" title="Ocean" /><link rel="stylesheet" type="text/css" href="quick-jump.css" /><script src="haddock-bundle.min.js" async="async" type="text/javascript"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script></head><body><div id="package-header"><ul class="links" id="page-menu"><li><a href="src/Lorentz.Errors.Numeric.Contract.html">Source</a></li><li><a href="index.html">Contents</a></li><li><a href="doc-index.html">Index</a></li></ul><p class="caption">lorentz-0.1.0: EDSL for the Michelson Language</p></div><div id="content"><div id="module-header"><table class="info"><tr><th>Safe Haskell</th><td>None</td></tr><tr><th>Language</th><td>Haskell2010</td></tr></table><p class="caption">Lorentz.Errors.Numeric.Contract</p></div><div id="description"><p class="caption">Description</p><div class="doc"><p>By default we represent error tags using strings. This module
 makes it possible to use numbers instead. It introduces new [error format].</p><p>There are two possible ways to use it:
 1. If you have just one Lorentz instruction (potentially a big one),
 just use <code><a href="Lorentz-Errors-Numeric-Contract.html#v:useNumericErrors" title="Lorentz.Errors.Numeric.Contract">useNumericErrors</a></code> function. It will change error representation
 there and return a map that can be used to interpret new error codes.
 2. If your contract consists of multiple parts, start with gathering all
 error tags (<code><a href="Lorentz-Errors-Numeric-Contract.html#v:gatherErrorTags" title="Lorentz.Errors.Numeric.Contract">gatherErrorTags</a></code>). Then build <code><a href="Lorentz-Errors-Numeric-Contract.html#t:ErrorTagMap" title="Lorentz.Errors.Numeric.Contract">ErrorTagMap</a></code> using
 <code><a href="Lorentz-Errors-Numeric-Contract.html#v:addNewErrorTags" title="Lorentz.Errors.Numeric.Contract">addNewErrorTags</a></code>. Pass empty map if you are building from scratch
 (you can use <code><a href="Lorentz-Errors-Numeric-Contract.html#v:buildErrorTagMap" title="Lorentz.Errors.Numeric.Contract">buildErrorTagMap</a></code> shortcut) or an existing
 map if you have one (e. g. you are upgrading a contract).</p></div></div><div id="synopsis"><details id="syn"><summary>Synopsis</summary><ul class="details-toggle" data-details-id="syn"><li class="src short"><span class="keyword">type</span> <a href="#t:ErrorTagMap">ErrorTagMap</a> = <a href="../bimap-0.4.0/Data-Bimap.html#t:Bimap" title="Data.Bimap">Bimap</a> <a href="Lorentz-Value.html#t:Natural" title="Lorentz.Value">Natural</a> <a href="Lorentz-Value.html#t:MText" title="Lorentz.Value">MText</a></li><li class="src short"><span class="keyword">type</span> <a href="#t:ErrorTagExclusions">ErrorTagExclusions</a> = <a href="../morley-prelude-0.3.0/Prelude.html#t:HashSet" title="Prelude">HashSet</a> <a href="Lorentz-Value.html#t:MText" title="Lorentz.Value">MText</a></li><li class="src short"><a href="#v:gatherErrorTags">gatherErrorTags</a> :: (inp <a href="Lorentz-Base.html#t::-45--62-" title="Lorentz.Base">:-&gt;</a> out) -&gt; <a href="../morley-prelude-0.3.0/Prelude.html#t:HashSet" title="Prelude">HashSet</a> <a href="Lorentz-Value.html#t:MText" title="Lorentz.Value">MText</a></li><li class="src short"><a href="#v:addNewErrorTags">addNewErrorTags</a> :: <a href="Lorentz-Errors-Numeric-Contract.html#t:ErrorTagMap" title="Lorentz.Errors.Numeric.Contract">ErrorTagMap</a> -&gt; <a href="../morley-prelude-0.3.0/Prelude.html#t:HashSet" title="Prelude">HashSet</a> <a href="Lorentz-Value.html#t:MText" title="Lorentz.Value">MText</a> -&gt; <a href="Lorentz-Errors-Numeric-Contract.html#t:ErrorTagMap" title="Lorentz.Errors.Numeric.Contract">ErrorTagMap</a></li><li class="src short"><a href="#v:buildErrorTagMap">buildErrorTagMap</a> :: <a href="../morley-prelude-0.3.0/Prelude.html#t:HashSet" title="Prelude">HashSet</a> <a href="Lorentz-Value.html#t:MText" title="Lorentz.Value">MText</a> -&gt; <a href="Lorentz-Errors-Numeric-Contract.html#t:ErrorTagMap" title="Lorentz.Errors.Numeric.Contract">ErrorTagMap</a></li><li class="src short"><a href="#v:excludeErrorTags">excludeErrorTags</a> :: <a href="../base-4.12.0.0/GHC-Stack.html#t:HasCallStack" title="GHC.Stack">HasCallStack</a> =&gt; <a href="Lorentz-Errors-Numeric-Contract.html#t:ErrorTagExclusions" title="Lorentz.Errors.Numeric.Contract">ErrorTagExclusions</a> -&gt; <a href="Lorentz-Errors-Numeric-Contract.html#t:ErrorTagMap" title="Lorentz.Errors.Numeric.Contract">ErrorTagMap</a> -&gt; <a href="Lorentz-Errors-Numeric-Contract.html#t:ErrorTagMap" title="Lorentz.Errors.Numeric.Contract">ErrorTagMap</a></li><li class="src short"><a href="#v:applyErrorTagMap">applyErrorTagMap</a> :: <a href="../base-4.12.0.0/GHC-Stack.html#t:HasCallStack" title="GHC.Stack">HasCallStack</a> =&gt; <a href="Lorentz-Errors-Numeric-Contract.html#t:ErrorTagMap" title="Lorentz.Errors.Numeric.Contract">ErrorTagMap</a> -&gt; (inp <a href="Lorentz-Base.html#t::-45--62-" title="Lorentz.Base">:-&gt;</a> out) -&gt; inp <a href="Lorentz-Base.html#t::-45--62-" title="Lorentz.Base">:-&gt;</a> out</li><li class="src short"><a href="#v:applyErrorTagMapWithExclusions">applyErrorTagMapWithExclusions</a> :: <a href="../base-4.12.0.0/GHC-Stack.html#t:HasCallStack" title="GHC.Stack">HasCallStack</a> =&gt; <a href="Lorentz-Errors-Numeric-Contract.html#t:ErrorTagMap" title="Lorentz.Errors.Numeric.Contract">ErrorTagMap</a> -&gt; <a href="Lorentz-Errors-Numeric-Contract.html#t:ErrorTagExclusions" title="Lorentz.Errors.Numeric.Contract">ErrorTagExclusions</a> -&gt; (inp <a href="Lorentz-Base.html#t::-45--62-" title="Lorentz.Base">:-&gt;</a> out) -&gt; inp <a href="Lorentz-Base.html#t::-45--62-" title="Lorentz.Base">:-&gt;</a> out</li><li class="src short"><a href="#v:useNumericErrors">useNumericErrors</a> :: <a href="../base-4.12.0.0/GHC-Stack.html#t:HasCallStack" title="GHC.Stack">HasCallStack</a> =&gt; (inp <a href="Lorentz-Base.html#t::-45--62-" title="Lorentz.Base">:-&gt;</a> out) -&gt; (inp <a href="Lorentz-Base.html#t::-45--62-" title="Lorentz.Base">:-&gt;</a> out, <a href="Lorentz-Errors-Numeric-Contract.html#t:ErrorTagMap" title="Lorentz.Errors.Numeric.Contract">ErrorTagMap</a>)</li><li class="src short"><a href="#v:errorFromValNumeric">errorFromValNumeric</a> :: (<a href="../base-4.12.0.0/Type-Reflection.html#t:Typeable" title="Type.Reflection">Typeable</a> t, <a href="../morley-1.0.0/Michelson-Typed-Scope.html#t:SingI" title="Michelson.Typed.Scope">SingI</a> t, <a href="Lorentz-Errors.html#t:IsError" title="Lorentz.Errors">IsError</a> e) =&gt; <a href="Lorentz-Errors-Numeric-Contract.html#t:ErrorTagMap" title="Lorentz.Errors.Numeric.Contract">ErrorTagMap</a> -&gt; <a href="Lorentz-Value.html#t:Value" title="Lorentz.Value">Value</a> t -&gt; <a href="Lorentz-Prelude.html#t:Either" title="Lorentz.Prelude">Either</a> <a href="Lorentz-Prelude.html#t:Text" title="Lorentz.Prelude">Text</a> e</li></ul></details></div><div id="interface"><h1>Documentation</h1><div class="top"><p class="src"><span class="keyword">type</span> <a id="t:ErrorTagMap" class="def">ErrorTagMap</a> = <a href="../bimap-0.4.0/Data-Bimap.html#t:Bimap" title="Data.Bimap">Bimap</a> <a href="Lorentz-Value.html#t:Natural" title="Lorentz.Value">Natural</a> <a href="Lorentz-Value.html#t:MText" title="Lorentz.Value">MText</a> <a href="src/Lorentz.Errors.Numeric.Contract.html#ErrorTagMap" class="link">Source</a> <a href="#t:ErrorTagMap" class="selflink">#</a></p><div class="doc"><p>This is a bidirectional map with correspondence between numeric
 and textual error tags.</p></div></div><div class="top"><p class="src"><span class="keyword">type</span> <a id="t:ErrorTagExclusions" class="def">ErrorTagExclusions</a> = <a href="../morley-prelude-0.3.0/Prelude.html#t:HashSet" title="Prelude">HashSet</a> <a href="Lorentz-Value.html#t:MText" title="Lorentz.Value">MText</a> <a href="src/Lorentz.Errors.Numeric.Contract.html#ErrorTagExclusions" class="link">Source</a> <a href="#t:ErrorTagExclusions" class="selflink">#</a></p><div class="doc"><p>Tags excluded from map.</p></div></div><div class="top"><p class="src"><a id="v:gatherErrorTags" class="def">gatherErrorTags</a> :: (inp <a href="Lorentz-Base.html#t::-45--62-" title="Lorentz.Base">:-&gt;</a> out) -&gt; <a href="../morley-prelude-0.3.0/Prelude.html#t:HashSet" title="Prelude">HashSet</a> <a href="Lorentz-Value.html#t:MText" title="Lorentz.Value">MText</a> <a href="src/Lorentz.Errors.Numeric.Contract.html#gatherErrorTags" class="link">Source</a> <a href="#v:gatherErrorTags" class="selflink">#</a></p><div class="doc"><p>Find all textual error tags that are used in typical
 <code>FAILWITH</code> patterns within given instruction.
 Map them to natural numbers.</p></div></div><div class="top"><p class="src"><a id="v:addNewErrorTags" class="def">addNewErrorTags</a> :: <a href="Lorentz-Errors-Numeric-Contract.html#t:ErrorTagMap" title="Lorentz.Errors.Numeric.Contract">ErrorTagMap</a> -&gt; <a href="../morley-prelude-0.3.0/Prelude.html#t:HashSet" title="Prelude">HashSet</a> <a href="Lorentz-Value.html#t:MText" title="Lorentz.Value">MText</a> -&gt; <a href="Lorentz-Errors-Numeric-Contract.html#t:ErrorTagMap" title="Lorentz.Errors.Numeric.Contract">ErrorTagMap</a> <a href="src/Lorentz.Errors.Numeric.Contract.html#addNewErrorTags" class="link">Source</a> <a href="#v:addNewErrorTags" class="selflink">#</a></p><div class="doc"><p>Add more error tags to an existing <code><a href="Lorentz-Errors-Numeric-Contract.html#t:ErrorTagMap" title="Lorentz.Errors.Numeric.Contract">ErrorTagMap</a></code>. It is useful when
 your contract consists of multiple parts (e. g. in case of contract
 upgrade), you have existing map for some part and want to add tags
 from another part to it.
 You can pass empty map as existing one if you just want to build
 <code><a href="Lorentz-Errors-Numeric-Contract.html#t:ErrorTagMap" title="Lorentz.Errors.Numeric.Contract">ErrorTagMap</a></code> from a set of textual tags. See <code><a href="Lorentz-Errors-Numeric-Contract.html#v:buildErrorTagMap" title="Lorentz.Errors.Numeric.Contract">buildErrorTagMap</a></code>.</p></div></div><div class="top"><p class="src"><a id="v:buildErrorTagMap" class="def">buildErrorTagMap</a> :: <a href="../morley-prelude-0.3.0/Prelude.html#t:HashSet" title="Prelude">HashSet</a> <a href="Lorentz-Value.html#t:MText" title="Lorentz.Value">MText</a> -&gt; <a href="Lorentz-Errors-Numeric-Contract.html#t:ErrorTagMap" title="Lorentz.Errors.Numeric.Contract">ErrorTagMap</a> <a href="src/Lorentz.Errors.Numeric.Contract.html#buildErrorTagMap" class="link">Source</a> <a href="#v:buildErrorTagMap" class="selflink">#</a></p><div class="doc"><p>Build <code><a href="Lorentz-Errors-Numeric-Contract.html#t:ErrorTagMap" title="Lorentz.Errors.Numeric.Contract">ErrorTagMap</a></code> from a set of textual tags.</p></div></div><div class="top"><p class="src"><a id="v:excludeErrorTags" class="def">excludeErrorTags</a> :: <a href="../base-4.12.0.0/GHC-Stack.html#t:HasCallStack" title="GHC.Stack">HasCallStack</a> =&gt; <a href="Lorentz-Errors-Numeric-Contract.html#t:ErrorTagExclusions" title="Lorentz.Errors.Numeric.Contract">ErrorTagExclusions</a> -&gt; <a href="Lorentz-Errors-Numeric-Contract.html#t:ErrorTagMap" title="Lorentz.Errors.Numeric.Contract">ErrorTagMap</a> -&gt; <a href="Lorentz-Errors-Numeric-Contract.html#t:ErrorTagMap" title="Lorentz.Errors.Numeric.Contract">ErrorTagMap</a> <a href="src/Lorentz.Errors.Numeric.Contract.html#excludeErrorTags" class="link">Source</a> <a href="#v:excludeErrorTags" class="selflink">#</a></p><div class="doc"><p>Remove some error tags from map.
 This way you say to remain these string tags intact, while others will be
 converted to numbers when this map is applied.</p><p>Note that later you have to apply this map using
 <code><a href="Lorentz-Errors-Numeric-Contract.html#v:applyErrorTagMapWithExclusions" title="Lorentz.Errors.Numeric.Contract">applyErrorTagMapWithExclusions</a></code>, otherwise an error would be raised.</p></div></div><div class="top"><p class="src"><a id="v:applyErrorTagMap" class="def">applyErrorTagMap</a> :: <a href="../base-4.12.0.0/GHC-Stack.html#t:HasCallStack" title="GHC.Stack">HasCallStack</a> =&gt; <a href="Lorentz-Errors-Numeric-Contract.html#t:ErrorTagMap" title="Lorentz.Errors.Numeric.Contract">ErrorTagMap</a> -&gt; (inp <a href="Lorentz-Base.html#t::-45--62-" title="Lorentz.Base">:-&gt;</a> out) -&gt; inp <a href="Lorentz-Base.html#t::-45--62-" title="Lorentz.Base">:-&gt;</a> out <a href="src/Lorentz.Errors.Numeric.Contract.html#applyErrorTagMap" class="link">Source</a> <a href="#v:applyErrorTagMap" class="selflink">#</a></p><div class="doc"><p>For each typical <code><a href="../morley-1.0.0/Michelson-Typed-Instr.html#v:FAILWITH" title="Michelson.Typed.Instr">FAILWITH</a></code> that uses a string to represent error
 tag this function changes error tag to be a number using the
 supplied conversion map.
 It assumes that supplied map contains all such strings
 (and will error out if it does not).
 It will always be the case if you gather all error tags using
 <code><a href="Lorentz-Errors-Numeric-Contract.html#v:gatherErrorTags" title="Lorentz.Errors.Numeric.Contract">gatherErrorTags</a></code> and build <code><a href="Lorentz-Errors-Numeric-Contract.html#t:ErrorTagMap" title="Lorentz.Errors.Numeric.Contract">ErrorTagMap</a></code> from them using <code><a href="Lorentz-Errors-Numeric-Contract.html#v:addNewErrorTags" title="Lorentz.Errors.Numeric.Contract">addNewErrorTags</a></code>.</p></div></div><div class="top"><p class="src"><a id="v:applyErrorTagMapWithExclusions" class="def">applyErrorTagMapWithExclusions</a> :: <a href="../base-4.12.0.0/GHC-Stack.html#t:HasCallStack" title="GHC.Stack">HasCallStack</a> =&gt; <a href="Lorentz-Errors-Numeric-Contract.html#t:ErrorTagMap" title="Lorentz.Errors.Numeric.Contract">ErrorTagMap</a> -&gt; <a href="Lorentz-Errors-Numeric-Contract.html#t:ErrorTagExclusions" title="Lorentz.Errors.Numeric.Contract">ErrorTagExclusions</a> -&gt; (inp <a href="Lorentz-Base.html#t::-45--62-" title="Lorentz.Base">:-&gt;</a> out) -&gt; inp <a href="Lorentz-Base.html#t::-45--62-" title="Lorentz.Base">:-&gt;</a> out <a href="src/Lorentz.Errors.Numeric.Contract.html#applyErrorTagMapWithExclusions" class="link">Source</a> <a href="#v:applyErrorTagMapWithExclusions" class="selflink">#</a></p><div class="doc"><p>Similar to <code><a href="Lorentz-Errors-Numeric-Contract.html#v:applyErrorTagMap" title="Lorentz.Errors.Numeric.Contract">applyErrorTagMap</a></code>, but for case when you have excluded some
 tags from map via <code><a href="Lorentz-Errors-Numeric-Contract.html#v:excludeErrorTags" title="Lorentz.Errors.Numeric.Contract">excludeErrorTags</a></code>.
 Needed, because both <code><a href="Lorentz-Errors-Numeric-Contract.html#v:excludeErrorTags" title="Lorentz.Errors.Numeric.Contract">excludeErrorTags</a></code> and this function do not tolerate
 unknown errors in contract code (for your safety).</p></div></div><div class="top"><p class="src"><a id="v:useNumericErrors" class="def">useNumericErrors</a> :: <a href="../base-4.12.0.0/GHC-Stack.html#t:HasCallStack" title="GHC.Stack">HasCallStack</a> =&gt; (inp <a href="Lorentz-Base.html#t::-45--62-" title="Lorentz.Base">:-&gt;</a> out) -&gt; (inp <a href="Lorentz-Base.html#t::-45--62-" title="Lorentz.Base">:-&gt;</a> out, <a href="Lorentz-Errors-Numeric-Contract.html#t:ErrorTagMap" title="Lorentz.Errors.Numeric.Contract">ErrorTagMap</a>) <a href="src/Lorentz.Errors.Numeric.Contract.html#useNumericErrors" class="link">Source</a> <a href="#v:useNumericErrors" class="selflink">#</a></p><div class="doc"><p>This function implements the simplest scenario of using this
 module's functionality:
 1. Gather all error tags from a single instruction.
 2. Turn them into error conversion map.
 3. Apply this conversion.</p></div></div><div class="top"><p class="src"><a id="v:errorFromValNumeric" class="def">errorFromValNumeric</a> :: (<a href="../base-4.12.0.0/Type-Reflection.html#t:Typeable" title="Type.Reflection">Typeable</a> t, <a href="../morley-1.0.0/Michelson-Typed-Scope.html#t:SingI" title="Michelson.Typed.Scope">SingI</a> t, <a href="Lorentz-Errors.html#t:IsError" title="Lorentz.Errors">IsError</a> e) =&gt; <a href="Lorentz-Errors-Numeric-Contract.html#t:ErrorTagMap" title="Lorentz.Errors.Numeric.Contract">ErrorTagMap</a> -&gt; <a href="Lorentz-Value.html#t:Value" title="Lorentz.Value">Value</a> t -&gt; <a href="Lorentz-Prelude.html#t:Either" title="Lorentz.Prelude">Either</a> <a href="Lorentz-Prelude.html#t:Text" title="Lorentz.Prelude">Text</a> e <a href="src/Lorentz.Errors.Numeric.Contract.html#errorFromValNumeric" class="link">Source</a> <a href="#v:errorFromValNumeric" class="selflink">#</a></p><div class="doc"><p>If you apply numeric error representation in your contract, <code><a href="Lorentz-Errors.html#v:errorFromVal" title="Lorentz.Errors">errorFromVal</a></code>
 will stop working because it doesn't know about this
 transformation.
 This function takes this transformation into account.
 If a number is used as a tag, but it is not found in the passed
 map, we conservatively preserve that number (because this whole
 approach is rather a heuristic).</p></div></div></div></div><div id="footer"><p>Produced by <a href="http://www.haskell.org/haddock/">Haddock</a> version 2.22.0</p></div></body></html>