<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{- Data/Singletons/Syntax.hs

(c) Richard Eisenberg 2014
rae@cs.brynmawr.edu

Converts a list of DLetDecs into a LetDecEnv for easier processing,
and contains various other AST definitions.
-}</span><span>
</span><a name="line-9"></a><span>
</span><a name="line-10"></a><span class="hs-pragma">{-# LANGUAGE DataKinds, TypeFamilies, PolyKinds, DeriveDataTypeable,
             StandaloneDeriving, FlexibleInstances, ConstraintKinds #-}</span><span>
</span><a name="line-12"></a><span>
</span><a name="line-13"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Data.Singletons.Syntax</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-14"></a><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Prelude</span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">exp</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Kind</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Constraint</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Type</span><span class="hs-special">)</span><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Language.Haskell.TH.Syntax</span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">)</span><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Language.Haskell.TH.Desugar</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Map.Strict</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Map.Strict</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Map</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Set</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Set</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Semigroup</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Semigroup</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-23"></a><span>
</span><a name="line-24"></a><span class="hs-keyword">type</span><span> </span><a name="VarPromotions"><a href="Data.Singletons.Syntax.html#VarPromotions"><span class="hs-identifier">VarPromotions</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Name</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- from term-level name to type-level name</span><span>
</span><a name="line-25"></a><span>
</span><a name="line-26"></a><span class="hs-comment">-- Information that is accumulated when promoting patterns.</span><span>
</span><a name="line-27"></a><span class="hs-keyword">data</span><span> </span><a name="PromDPatInfos"><a href="Data.Singletons.Syntax.html#PromDPatInfos"><span class="hs-identifier">PromDPatInfos</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="PromDPatInfos"><a href="Data.Singletons.Syntax.html#PromDPatInfos"><span class="hs-identifier">PromDPatInfos</span></a></a><span>
</span><a name="line-28"></a><span>  </span><span class="hs-special">{</span><span> </span><a name="prom_dpat_vars"><a href="Data.Singletons.Syntax.html#prom_dpat_vars"><span class="hs-identifier">prom_dpat_vars</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="Data.Singletons.Syntax.html#VarPromotions"><span class="hs-identifier hs-type">VarPromotions</span></a><span>
</span><a name="line-29"></a><span>      </span><span class="hs-comment">-- Maps term-level pattern variables to their promoted, type-level counterparts.</span><span>
</span><a name="line-30"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="prom_dpat_sig_kvs"><a href="Data.Singletons.Syntax.html#prom_dpat_sig_kvs"><span class="hs-identifier">prom_dpat_sig_kvs</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Set</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-31"></a><span>      </span><span class="hs-comment">-- Kind variables bound by DSigPas.</span><span>
</span><a name="line-32"></a><span>      </span><span class="hs-comment">-- See Note [Explicitly binding kind variables] in Data.Singletons.Promote.Monad</span><span>
</span><a name="line-33"></a><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-34"></a><span>
</span><a name="line-35"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Semigroup</span><span> </span><a href="Data.Singletons.Syntax.html#PromDPatInfos"><span class="hs-identifier hs-type">PromDPatInfos</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-36"></a><span>  </span><a href="Data.Singletons.Syntax.html#PromDPatInfos"><span class="hs-identifier hs-var">PromDPatInfos</span></a><span> </span><a name="local-6989586621679069118"><a href="#local-6989586621679069118"><span class="hs-identifier">vars1</span></a></a><span> </span><a name="local-6989586621679069119"><a href="#local-6989586621679069119"><span class="hs-identifier">sig_kvs1</span></a></a><span> </span><a name="local-3458764513820541482"><span class="hs-operator">&lt;&gt;</span></a><span> </span><a href="Data.Singletons.Syntax.html#PromDPatInfos"><span class="hs-identifier hs-var">PromDPatInfos</span></a><span> </span><a name="local-6989586621679069120"><a href="#local-6989586621679069120"><span class="hs-identifier">vars2</span></a></a><span> </span><a name="local-6989586621679069121"><a href="#local-6989586621679069121"><span class="hs-identifier">sig_kvs2</span></a></a><span>
</span><a name="line-37"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Syntax.html#PromDPatInfos"><span class="hs-identifier hs-var">PromDPatInfos</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679069118"><span class="hs-identifier hs-var">vars1</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-6989586621679069120"><span class="hs-identifier hs-var">vars2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679069119"><span class="hs-identifier hs-var">sig_kvs1</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-6989586621679069121"><span class="hs-identifier hs-var">sig_kvs2</span></a><span class="hs-special">)</span><span>
</span><a name="line-38"></a><span>
</span><a name="line-39"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Monoid</span><span> </span><a href="Data.Singletons.Syntax.html#PromDPatInfos"><span class="hs-identifier hs-type">PromDPatInfos</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-40"></a><span>  </span><a name="local-3458764513820541483"><span class="hs-identifier">mempty</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Syntax.html#PromDPatInfos"><span class="hs-identifier hs-var">PromDPatInfos</span></a><span> </span><span class="hs-identifier hs-var">mempty</span><span> </span><span class="hs-identifier hs-var">mempty</span><span>
</span><a name="line-41"></a><span>
</span><a name="line-42"></a><span class="hs-comment">-- A list of 'SingDSigPaInfos' is produced when singling pattern signatures, as we</span><span>
</span><a name="line-43"></a><span class="hs-comment">-- must case on the 'DExp's and match on them using the supplied 'DType's to</span><span>
</span><a name="line-44"></a><span class="hs-comment">-- bring the necessary singleton equality constraints into scope.</span><span>
</span><a name="line-45"></a><span class="hs-comment">-- See @Note [Singling pattern signatures]@.</span><span>
</span><a name="line-46"></a><span class="hs-keyword">type</span><span> </span><a name="SingDSigPaInfos"><a href="Data.Singletons.Syntax.html#SingDSigPaInfos"><span class="hs-identifier">SingDSigPaInfos</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">DExp</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">DType</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-47"></a><span>
</span><a name="line-48"></a><span class="hs-comment">-- The parts of data declarations that are relevant to singletons.</span><span>
</span><a name="line-49"></a><span class="hs-keyword">data</span><span> </span><a name="DataDecl"><a href="Data.Singletons.Syntax.html#DataDecl"><span class="hs-identifier">DataDecl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="DataDecl"><a href="Data.Singletons.Syntax.html#DataDecl"><span class="hs-identifier">DataDecl</span></a></a><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DTyVarBndr</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DCon</span><span class="hs-special">]</span><span>
</span><a name="line-50"></a><span>
</span><a name="line-51"></a><span class="hs-comment">-- The parts of type synonyms that are relevant to singletons.</span><span>
</span><a name="line-52"></a><span class="hs-keyword">data</span><span> </span><a name="TySynDecl"><a href="Data.Singletons.Syntax.html#TySynDecl"><span class="hs-identifier">TySynDecl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="TySynDecl"><a href="Data.Singletons.Syntax.html#TySynDecl"><span class="hs-identifier">TySynDecl</span></a></a><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DTyVarBndr</span><span class="hs-special">]</span><span>
</span><a name="line-53"></a><span>
</span><a name="line-54"></a><span class="hs-comment">-- The parts of open type families that are relevant to singletons.</span><span>
</span><a name="line-55"></a><span class="hs-keyword">type</span><span> </span><a name="OpenTypeFamilyDecl"><a href="Data.Singletons.Syntax.html#OpenTypeFamilyDecl"><span class="hs-identifier">OpenTypeFamilyDecl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Syntax.html#TypeFamilyDecl"><span class="hs-identifier hs-type">TypeFamilyDecl</span></a><span> </span><span class="hs-special">'</span><a href="Data.Singletons.Syntax.html#Open"><span class="hs-identifier hs-type">Open</span></a><span>
</span><a name="line-56"></a><span>
</span><a name="line-57"></a><span class="hs-comment">-- The parts of closed type families that are relevant to singletons.</span><span>
</span><a name="line-58"></a><span class="hs-keyword">type</span><span> </span><a name="ClosedTypeFamilyDecl"><a href="Data.Singletons.Syntax.html#ClosedTypeFamilyDecl"><span class="hs-identifier">ClosedTypeFamilyDecl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Syntax.html#TypeFamilyDecl"><span class="hs-identifier hs-type">TypeFamilyDecl</span></a><span> </span><span class="hs-special">'</span><a href="Data.Singletons.Syntax.html#Closed"><span class="hs-identifier hs-type">Closed</span></a><span>
</span><a name="line-59"></a><span>
</span><a name="line-60"></a><span class="hs-comment">-- The parts of type families that are relevant to singletons.</span><span>
</span><a name="line-61"></a><span class="hs-keyword">newtype</span><span> </span><a name="TypeFamilyDecl"><a href="Data.Singletons.Syntax.html#TypeFamilyDecl"><span class="hs-identifier">TypeFamilyDecl</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679069111"><a href="#local-6989586621679069111"><span class="hs-identifier">info</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Singletons.Syntax.html#FamilyInfo"><span class="hs-identifier hs-type">FamilyInfo</span></a><span class="hs-special">)</span><span>
</span><a name="line-62"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="TypeFamilyDecl"><a href="Data.Singletons.Syntax.html#TypeFamilyDecl"><span class="hs-identifier">TypeFamilyDecl</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="getTypeFamilyDecl"><a href="Data.Singletons.Syntax.html#getTypeFamilyDecl"><span class="hs-identifier">getTypeFamilyDecl</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DTypeFamilyHead</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-63"></a><span class="hs-comment">-- Whether a type family is open or closed.</span><span>
</span><a name="line-64"></a><span class="hs-keyword">data</span><span> </span><a name="FamilyInfo"><a href="Data.Singletons.Syntax.html#FamilyInfo"><span class="hs-identifier">FamilyInfo</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Open"><a href="Data.Singletons.Syntax.html#Open"><span class="hs-identifier">Open</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="Closed"><a href="Data.Singletons.Syntax.html#Closed"><span class="hs-identifier">Closed</span></a></a><span>
</span><a name="line-65"></a><span>
</span><a name="line-66"></a><span class="hs-keyword">data</span><span> </span><a name="ClassDecl"><a href="Data.Singletons.Syntax.html#ClassDecl"><span class="hs-identifier">ClassDecl</span></a></a><span> </span><a name="local-6989586621679069110"><a href="#local-6989586621679069110"><span class="hs-identifier">ann</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="ClassDecl"><a href="Data.Singletons.Syntax.html#ClassDecl"><span class="hs-identifier">ClassDecl</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="cd_cxt"><a href="Data.Singletons.Syntax.html#cd_cxt"><span class="hs-identifier">cd_cxt</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DCxt</span><span>
</span><a name="line-67"></a><span>                               </span><span class="hs-special">,</span><span> </span><a name="cd_name"><a href="Data.Singletons.Syntax.html#cd_name"><span class="hs-identifier">cd_name</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-68"></a><span>                               </span><span class="hs-special">,</span><span> </span><a name="cd_tvbs"><a href="Data.Singletons.Syntax.html#cd_tvbs"><span class="hs-identifier">cd_tvbs</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DTyVarBndr</span><span class="hs-special">]</span><span>
</span><a name="line-69"></a><span>                               </span><span class="hs-special">,</span><span> </span><a name="cd_fds"><a href="Data.Singletons.Syntax.html#cd_fds"><span class="hs-identifier">cd_fds</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">FunDep</span><span class="hs-special">]</span><span>
</span><a name="line-70"></a><span>                               </span><span class="hs-special">,</span><span> </span><a name="cd_lde"><a href="Data.Singletons.Syntax.html#cd_lde"><span class="hs-identifier">cd_lde</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="Data.Singletons.Syntax.html#LetDecEnv"><span class="hs-identifier hs-type">LetDecEnv</span></a><span> </span><a href="#local-6989586621679069110"><span class="hs-identifier hs-type">ann</span></a><span>
</span><a name="line-71"></a><span>                               </span><span class="hs-special">}</span><span>
</span><a name="line-72"></a><span>
</span><a name="line-73"></a><span class="hs-keyword">data</span><span> </span><a name="InstDecl"><a href="Data.Singletons.Syntax.html#InstDecl"><span class="hs-identifier">InstDecl</span></a></a><span>  </span><a name="local-6989586621679069109"><a href="#local-6989586621679069109"><span class="hs-identifier">ann</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="InstDecl"><a href="Data.Singletons.Syntax.html#InstDecl"><span class="hs-identifier">InstDecl</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="id_cxt"><a href="Data.Singletons.Syntax.html#id_cxt"><span class="hs-identifier">id_cxt</span></a></a><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DCxt</span><span>
</span><a name="line-74"></a><span>                              </span><span class="hs-special">,</span><span> </span><a name="id_name"><a href="Data.Singletons.Syntax.html#id_name"><span class="hs-identifier">id_name</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-75"></a><span>                              </span><span class="hs-special">,</span><span> </span><a name="id_arg_tys"><a href="Data.Singletons.Syntax.html#id_arg_tys"><span class="hs-identifier">id_arg_tys</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DType</span><span class="hs-special">]</span><span>
</span><a name="line-76"></a><span>                              </span><span class="hs-special">,</span><span> </span><a name="id_sigs"><a href="Data.Singletons.Syntax.html#id_sigs"><span class="hs-identifier">id_sigs</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-identifier hs-type">DType</span><span>
</span><a name="line-77"></a><span>                              </span><span class="hs-special">,</span><span> </span><a name="id_meths"><a href="Data.Singletons.Syntax.html#id_meths"><span class="hs-identifier">id_meths</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span> </span><a href="Data.Singletons.Syntax.html#LetDecRHS"><span class="hs-identifier hs-type">LetDecRHS</span></a><span> </span><a href="#local-6989586621679069109"><span class="hs-identifier hs-type">ann</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-78"></a><span>
</span><a name="line-79"></a><span class="hs-keyword">type</span><span> </span><a name="UClassDecl"><a href="Data.Singletons.Syntax.html#UClassDecl"><span class="hs-identifier">UClassDecl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Syntax.html#ClassDecl"><span class="hs-identifier hs-type">ClassDecl</span></a><span> </span><a href="Data.Singletons.Syntax.html#Unannotated"><span class="hs-identifier hs-type">Unannotated</span></a><span>
</span><a name="line-80"></a><span class="hs-keyword">type</span><span> </span><a name="UInstDecl"><a href="Data.Singletons.Syntax.html#UInstDecl"><span class="hs-identifier">UInstDecl</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Syntax.html#InstDecl"><span class="hs-identifier hs-type">InstDecl</span></a><span> </span><a href="Data.Singletons.Syntax.html#Unannotated"><span class="hs-identifier hs-type">Unannotated</span></a><span>
</span><a name="line-81"></a><span>
</span><a name="line-82"></a><span class="hs-keyword">type</span><span> </span><a name="AClassDecl"><a href="Data.Singletons.Syntax.html#AClassDecl"><span class="hs-identifier">AClassDecl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Syntax.html#ClassDecl"><span class="hs-identifier hs-type">ClassDecl</span></a><span> </span><a href="Data.Singletons.Syntax.html#Annotated"><span class="hs-identifier hs-type">Annotated</span></a><span>
</span><a name="line-83"></a><span class="hs-keyword">type</span><span> </span><a name="AInstDecl"><a href="Data.Singletons.Syntax.html#AInstDecl"><span class="hs-identifier">AInstDecl</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Syntax.html#InstDecl"><span class="hs-identifier hs-type">InstDecl</span></a><span> </span><a href="Data.Singletons.Syntax.html#Annotated"><span class="hs-identifier hs-type">Annotated</span></a><span>
</span><a name="line-84"></a><span>
</span><a name="line-85"></a><span class="hs-comment">{-
We see below several datatypes beginning with &quot;A&quot;. These are annotated structures,
necessary for Promote to communicate key things to Single. In particular, promotion
of expressions is *not* deterministic, due to the necessity to create unique names
for lets, cases, and lambdas. So, we put these promotions into an annotated AST
so that Single can use the right promotions.
-}</span><span>
</span><a name="line-92"></a><span>
</span><a name="line-93"></a><span class="hs-comment">-- A DExp with let, lambda, and type-signature nodes annotated with their</span><span>
</span><a name="line-94"></a><span class="hs-comment">-- type-level equivalents</span><span>
</span><a name="line-95"></a><span class="hs-keyword">data</span><span> </span><a name="ADExp"><a href="Data.Singletons.Syntax.html#ADExp"><span class="hs-identifier">ADExp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="ADVarE"><a href="Data.Singletons.Syntax.html#ADVarE"><span class="hs-identifier">ADVarE</span></a></a><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-96"></a><span>           </span><span class="hs-glyph">|</span><span> </span><a name="ADConE"><a href="Data.Singletons.Syntax.html#ADConE"><span class="hs-identifier">ADConE</span></a></a><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-97"></a><span>           </span><span class="hs-glyph">|</span><span> </span><a name="ADLitE"><a href="Data.Singletons.Syntax.html#ADLitE"><span class="hs-identifier">ADLitE</span></a></a><span> </span><span class="hs-identifier hs-type">Lit</span><span>
</span><a name="line-98"></a><span>           </span><span class="hs-glyph">|</span><span> </span><a name="ADAppE"><a href="Data.Singletons.Syntax.html#ADAppE"><span class="hs-identifier">ADAppE</span></a></a><span> </span><a href="Data.Singletons.Syntax.html#ADExp"><span class="hs-identifier hs-type">ADExp</span></a><span> </span><a href="Data.Singletons.Syntax.html#ADExp"><span class="hs-identifier hs-type">ADExp</span></a><span>
</span><a name="line-99"></a><span>           </span><span class="hs-glyph">|</span><span> </span><a name="ADLamE"><a href="Data.Singletons.Syntax.html#ADLamE"><span class="hs-identifier">ADLamE</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span>         </span><span class="hs-comment">-- type-level names corresponding to term-level ones</span><span>
</span><a name="line-100"></a><span>                    </span><span class="hs-identifier hs-type">DType</span><span>          </span><span class="hs-comment">-- the promoted lambda</span><span>
</span><a name="line-101"></a><span>                    </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span> </span><a href="Data.Singletons.Syntax.html#ADExp"><span class="hs-identifier hs-type">ADExp</span></a><span>
</span><a name="line-102"></a><span>           </span><span class="hs-glyph">|</span><span> </span><a name="ADCaseE"><a href="Data.Singletons.Syntax.html#ADCaseE"><span class="hs-identifier">ADCaseE</span></a></a><span> </span><a href="Data.Singletons.Syntax.html#ADExp"><span class="hs-identifier hs-type">ADExp</span></a><span> </span><span class="hs-special">[</span><a href="Data.Singletons.Syntax.html#ADMatch"><span class="hs-identifier hs-type">ADMatch</span></a><span class="hs-special">]</span><span> </span><span class="hs-identifier hs-type">DType</span><span>
</span><a name="line-103"></a><span>               </span><span class="hs-comment">-- the type is the return type</span><span>
</span><a name="line-104"></a><span>           </span><span class="hs-glyph">|</span><span> </span><a name="ADLetE"><a href="Data.Singletons.Syntax.html#ADLetE"><span class="hs-identifier">ADLetE</span></a></a><span> </span><a href="Data.Singletons.Syntax.html#ALetDecEnv"><span class="hs-identifier hs-type">ALetDecEnv</span></a><span> </span><a href="Data.Singletons.Syntax.html#ADExp"><span class="hs-identifier hs-type">ADExp</span></a><span>
</span><a name="line-105"></a><span>           </span><span class="hs-glyph">|</span><span> </span><a name="ADSigE"><a href="Data.Singletons.Syntax.html#ADSigE"><span class="hs-identifier">ADSigE</span></a></a><span> </span><span class="hs-identifier hs-type">DType</span><span>          </span><span class="hs-comment">-- the promoted expression</span><span>
</span><a name="line-106"></a><span>                    </span><a href="Data.Singletons.Syntax.html#ADExp"><span class="hs-identifier hs-type">ADExp</span></a><span> </span><span class="hs-identifier hs-type">DType</span><span>
</span><a name="line-107"></a><span>
</span><a name="line-108"></a><span class="hs-comment">-- A DPat with a pattern-signature node annotated with its type-level equivalent</span><span>
</span><a name="line-109"></a><span class="hs-keyword">data</span><span> </span><a name="ADPat"><a href="Data.Singletons.Syntax.html#ADPat"><span class="hs-identifier">ADPat</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="ADLitPa"><a href="Data.Singletons.Syntax.html#ADLitPa"><span class="hs-identifier">ADLitPa</span></a></a><span> </span><span class="hs-identifier hs-type">Lit</span><span>
</span><a name="line-110"></a><span>           </span><span class="hs-glyph">|</span><span> </span><a name="ADVarPa"><a href="Data.Singletons.Syntax.html#ADVarPa"><span class="hs-identifier">ADVarPa</span></a></a><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-111"></a><span>           </span><span class="hs-glyph">|</span><span> </span><a name="ADConPa"><a href="Data.Singletons.Syntax.html#ADConPa"><span class="hs-identifier">ADConPa</span></a></a><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-special">[</span><a href="Data.Singletons.Syntax.html#ADPat"><span class="hs-identifier hs-type">ADPat</span></a><span class="hs-special">]</span><span>
</span><a name="line-112"></a><span>           </span><span class="hs-glyph">|</span><span> </span><a name="ADTildePa"><a href="Data.Singletons.Syntax.html#ADTildePa"><span class="hs-identifier">ADTildePa</span></a></a><span> </span><a href="Data.Singletons.Syntax.html#ADPat"><span class="hs-identifier hs-type">ADPat</span></a><span>
</span><a name="line-113"></a><span>           </span><span class="hs-glyph">|</span><span> </span><a name="ADBangPa"><a href="Data.Singletons.Syntax.html#ADBangPa"><span class="hs-identifier">ADBangPa</span></a></a><span> </span><a href="Data.Singletons.Syntax.html#ADPat"><span class="hs-identifier hs-type">ADPat</span></a><span>
</span><a name="line-114"></a><span>           </span><span class="hs-glyph">|</span><span> </span><a name="ADSigPa"><a href="Data.Singletons.Syntax.html#ADSigPa"><span class="hs-identifier">ADSigPa</span></a></a><span> </span><span class="hs-identifier hs-type">DType</span><span> </span><span class="hs-comment">-- The promoted pattern. Will not contain any wildcards,</span><span>
</span><a name="line-115"></a><span>                           </span><span class="hs-comment">-- as per Note [Singling pattern signatures]</span><span>
</span><a name="line-116"></a><span>                     </span><a href="Data.Singletons.Syntax.html#ADPat"><span class="hs-identifier hs-type">ADPat</span></a><span> </span><span class="hs-identifier hs-type">DType</span><span>
</span><a name="line-117"></a><span>           </span><span class="hs-glyph">|</span><span> </span><a name="ADWildPa"><a href="Data.Singletons.Syntax.html#ADWildPa"><span class="hs-identifier">ADWildPa</span></a></a><span>
</span><a name="line-118"></a><span>
</span><a name="line-119"></a><span class="hs-keyword">data</span><span> </span><a name="ADMatch"><a href="Data.Singletons.Syntax.html#ADMatch"><span class="hs-identifier">ADMatch</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="ADMatch"><a href="Data.Singletons.Syntax.html#ADMatch"><span class="hs-identifier">ADMatch</span></a></a><span> </span><a href="Data.Singletons.Syntax.html#VarPromotions"><span class="hs-identifier hs-type">VarPromotions</span></a><span> </span><a href="Data.Singletons.Syntax.html#ADPat"><span class="hs-identifier hs-type">ADPat</span></a><span> </span><a href="Data.Singletons.Syntax.html#ADExp"><span class="hs-identifier hs-type">ADExp</span></a><span>
</span><a name="line-120"></a><span class="hs-keyword">data</span><span> </span><a name="ADClause"><a href="Data.Singletons.Syntax.html#ADClause"><span class="hs-identifier">ADClause</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="ADClause"><a href="Data.Singletons.Syntax.html#ADClause"><span class="hs-identifier">ADClause</span></a></a><span> </span><a href="Data.Singletons.Syntax.html#VarPromotions"><span class="hs-identifier hs-type">VarPromotions</span></a><span>
</span><a name="line-121"></a><span>                         </span><span class="hs-special">[</span><a href="Data.Singletons.Syntax.html#ADPat"><span class="hs-identifier hs-type">ADPat</span></a><span class="hs-special">]</span><span> </span><a href="Data.Singletons.Syntax.html#ADExp"><span class="hs-identifier hs-type">ADExp</span></a><span>
</span><a name="line-122"></a><span>
</span><a name="line-123"></a><span class="hs-keyword">data</span><span> </span><a name="AnnotationFlag"><a href="Data.Singletons.Syntax.html#AnnotationFlag"><span class="hs-identifier">AnnotationFlag</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Annotated"><a href="Data.Singletons.Syntax.html#Annotated"><span class="hs-identifier">Annotated</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="Unannotated"><a href="Data.Singletons.Syntax.html#Unannotated"><span class="hs-identifier">Unannotated</span></a></a><span>
</span><a name="line-124"></a><span>
</span><a name="line-125"></a><span class="hs-comment">-- These are used at the type-level exclusively</span><span>
</span><a name="line-126"></a><span class="hs-keyword">type</span><span> </span><a name="Annotated"><a href="Data.Singletons.Syntax.html#Annotated"><span class="hs-identifier">Annotated</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">'</span><a href="Data.Singletons.Syntax.html#Annotated"><span class="hs-identifier hs-type">Annotated</span></a><span>
</span><a name="line-127"></a><span class="hs-keyword">type</span><span> </span><a name="Unannotated"><a href="Data.Singletons.Syntax.html#Unannotated"><span class="hs-identifier">Unannotated</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">'</span><a href="Data.Singletons.Syntax.html#Unannotated"><span class="hs-identifier hs-type">Unannotated</span></a><span>
</span><a name="line-128"></a><span>
</span><a name="line-129"></a><span class="hs-keyword">type</span><span> </span><span class="hs-keyword">family</span><span> </span><a name="IfAnn"><a href="Data.Singletons.Syntax.html#IfAnn"><span class="hs-identifier">IfAnn</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679069102"><a href="#local-6989586621679069102"><span class="hs-identifier">ann</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Singletons.Syntax.html#AnnotationFlag"><span class="hs-identifier hs-type">AnnotationFlag</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679069103"><a href="#local-6989586621679069103"><span class="hs-identifier">yes</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679069101"><span class="hs-identifier hs-type">k</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679069104"><a href="#local-6989586621679069104"><span class="hs-identifier">no</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679069101"><span class="hs-identifier hs-type">k</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679069101"><span class="hs-identifier hs-type">k</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-130"></a><span>  </span><span class="hs-identifier">IfAnn</span><span> </span><a href="Data.Singletons.Syntax.html#Annotated"><span class="hs-identifier hs-type">Annotated</span></a><span>   </span><a href="#local-6989586621679069105"><span class="hs-identifier hs-type">yes</span></a><span> </span><a href="#local-6989586621679069106"><span class="hs-identifier hs-type">no</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679069105"><span class="hs-identifier hs-type">yes</span></a><span>
</span><a name="line-131"></a><span>  </span><span class="hs-identifier">IfAnn</span><span> </span><a href="Data.Singletons.Syntax.html#Unannotated"><span class="hs-identifier hs-type">Unannotated</span></a><span> </span><a href="#local-6989586621679069107"><span class="hs-identifier hs-type">yes</span></a><span> </span><a href="#local-6989586621679069108"><span class="hs-identifier hs-type">no</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679069108"><span class="hs-identifier hs-type">no</span></a><span>
</span><a name="line-132"></a><span>
</span><a name="line-133"></a><span class="hs-keyword">data</span><span> </span><span class="hs-keyword">family</span><span> </span><a name="LetDecRHS"><a href="Data.Singletons.Syntax.html#LetDecRHS"><span class="hs-identifier">LetDecRHS</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Singletons.Syntax.html#AnnotationFlag"><span class="hs-identifier hs-type">AnnotationFlag</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span>
</span><a name="line-134"></a><span class="hs-keyword">data</span><span> </span><span class="hs-keyword">instance</span><span> </span><a href="Data.Singletons.Syntax.html#LetDecRHS"><span class="hs-identifier hs-type">LetDecRHS</span></a><span> </span><a href="Data.Singletons.Syntax.html#Annotated"><span class="hs-identifier hs-type">Annotated</span></a><span>
</span><a name="line-135"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="AFunction"><a href="Data.Singletons.Syntax.html#AFunction"><span class="hs-identifier">AFunction</span></a></a><span> </span><span class="hs-identifier hs-type">DType</span><span>  </span><span class="hs-comment">-- promote function (unapplied)</span><span>
</span><a name="line-136"></a><span>    </span><span class="hs-identifier hs-type">Int</span><span>    </span><span class="hs-comment">-- number of arrows in type</span><span>
</span><a name="line-137"></a><span>    </span><span class="hs-special">[</span><a href="Data.Singletons.Syntax.html#ADClause"><span class="hs-identifier hs-type">ADClause</span></a><span class="hs-special">]</span><span>
</span><a name="line-138"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="AValue"><a href="Data.Singletons.Syntax.html#AValue"><span class="hs-identifier">AValue</span></a></a><span> </span><span class="hs-identifier hs-type">DType</span><span> </span><span class="hs-comment">-- promoted exp</span><span>
</span><a name="line-139"></a><span>    </span><span class="hs-identifier hs-type">Int</span><span>   </span><span class="hs-comment">-- number of arrows in type</span><span>
</span><a name="line-140"></a><span>    </span><a href="Data.Singletons.Syntax.html#ADExp"><span class="hs-identifier hs-type">ADExp</span></a><span>
</span><a name="line-141"></a><span class="hs-keyword">data</span><span> </span><span class="hs-keyword">instance</span><span> </span><a href="Data.Singletons.Syntax.html#LetDecRHS"><span class="hs-identifier hs-type">LetDecRHS</span></a><span> </span><a href="Data.Singletons.Syntax.html#Unannotated"><span class="hs-identifier hs-type">Unannotated</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="UFunction"><a href="Data.Singletons.Syntax.html#UFunction"><span class="hs-identifier">UFunction</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DClause</span><span class="hs-special">]</span><span>
</span><a name="line-142"></a><span>                                    </span><span class="hs-glyph">|</span><span> </span><a name="UValue"><a href="Data.Singletons.Syntax.html#UValue"><span class="hs-identifier">UValue</span></a></a><span> </span><span class="hs-identifier hs-type">DExp</span><span>
</span><a name="line-143"></a><span>
</span><a name="line-144"></a><span class="hs-keyword">type</span><span> </span><a name="ALetDecRHS"><a href="Data.Singletons.Syntax.html#ALetDecRHS"><span class="hs-identifier">ALetDecRHS</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Syntax.html#LetDecRHS"><span class="hs-identifier hs-type">LetDecRHS</span></a><span> </span><a href="Data.Singletons.Syntax.html#Annotated"><span class="hs-identifier hs-type">Annotated</span></a><span>
</span><a name="line-145"></a><span class="hs-keyword">type</span><span> </span><a name="ULetDecRHS"><a href="Data.Singletons.Syntax.html#ULetDecRHS"><span class="hs-identifier">ULetDecRHS</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Syntax.html#LetDecRHS"><span class="hs-identifier hs-type">LetDecRHS</span></a><span> </span><a href="Data.Singletons.Syntax.html#Unannotated"><span class="hs-identifier hs-type">Unannotated</span></a><span>
</span><a name="line-146"></a><span>
</span><a name="line-147"></a><span class="hs-keyword">data</span><span> </span><a name="LetDecEnv"><a href="Data.Singletons.Syntax.html#LetDecEnv"><span class="hs-identifier">LetDecEnv</span></a></a><span> </span><a name="local-6989586621679069100"><a href="#local-6989586621679069100"><span class="hs-identifier">ann</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="LetDecEnv"><a href="Data.Singletons.Syntax.html#LetDecEnv"><span class="hs-identifier">LetDecEnv</span></a></a><span>
</span><a name="line-148"></a><span>                   </span><span class="hs-special">{</span><span> </span><a name="lde_defns"><a href="Data.Singletons.Syntax.html#lde_defns"><span class="hs-identifier">lde_defns</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Syntax.html#LetDecRHS"><span class="hs-identifier hs-type">LetDecRHS</span></a><span> </span><a href="#local-6989586621679069100"><span class="hs-identifier hs-type">ann</span></a><span class="hs-special">)</span><span>
</span><a name="line-149"></a><span>                   </span><span class="hs-special">,</span><span> </span><a name="lde_types"><a href="Data.Singletons.Syntax.html#lde_types"><span class="hs-identifier">lde_types</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-identifier hs-type">DType</span><span>   </span><span class="hs-comment">-- type signatures</span><span>
</span><a name="line-150"></a><span>                   </span><span class="hs-special">,</span><span> </span><a name="lde_infix"><a href="Data.Singletons.Syntax.html#lde_infix"><span class="hs-identifier">lde_infix</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-identifier hs-type">Fixity</span><span>  </span><span class="hs-comment">-- infix declarations</span><span>
</span><a name="line-151"></a><span>                   </span><span class="hs-special">,</span><span> </span><a name="lde_proms"><a href="Data.Singletons.Syntax.html#lde_proms"><span class="hs-identifier">lde_proms</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Singletons.Syntax.html#IfAnn"><span class="hs-identifier hs-type">IfAnn</span></a><span> </span><a href="#local-6989586621679069100"><span class="hs-identifier hs-type">ann</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Map</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-identifier hs-type">DType</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- possibly, promotions</span><span>
</span><a name="line-152"></a><span>                   </span><span class="hs-special">,</span><span> </span><a name="lde_bound_kvs"><a href="Data.Singletons.Syntax.html#lde_bound_kvs"><span class="hs-identifier">lde_bound_kvs</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Singletons.Syntax.html#IfAnn"><span class="hs-identifier hs-type">IfAnn</span></a><span> </span><a href="#local-6989586621679069100"><span class="hs-identifier hs-type">ann</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Map</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Set</span><span> </span><span class="hs-identifier hs-type">Name</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-153"></a><span>                     </span><span class="hs-comment">-- The set of bound variables in scope.</span><span>
</span><a name="line-154"></a><span>                     </span><span class="hs-comment">-- See Note [Explicitly binding kind variables]</span><span>
</span><a name="line-155"></a><span>                     </span><span class="hs-comment">-- in Data.Singletons.Promote.Monad</span><span>
</span><a name="line-156"></a><span>                   </span><span class="hs-special">}</span><span>
</span><a name="line-157"></a><span class="hs-keyword">type</span><span> </span><a name="ALetDecEnv"><a href="Data.Singletons.Syntax.html#ALetDecEnv"><span class="hs-identifier">ALetDecEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Syntax.html#LetDecEnv"><span class="hs-identifier hs-type">LetDecEnv</span></a><span> </span><a href="Data.Singletons.Syntax.html#Annotated"><span class="hs-identifier hs-type">Annotated</span></a><span>
</span><a name="line-158"></a><span class="hs-keyword">type</span><span> </span><a name="ULetDecEnv"><a href="Data.Singletons.Syntax.html#ULetDecEnv"><span class="hs-identifier">ULetDecEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Syntax.html#LetDecEnv"><span class="hs-identifier hs-type">LetDecEnv</span></a><span> </span><a href="Data.Singletons.Syntax.html#Unannotated"><span class="hs-identifier hs-type">Unannotated</span></a><span>
</span><a name="line-159"></a><span>
</span><a name="line-160"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Semigroup</span><span> </span><a href="Data.Singletons.Syntax.html#ULetDecEnv"><span class="hs-identifier hs-type">ULetDecEnv</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-161"></a><span>  </span><a href="Data.Singletons.Syntax.html#LetDecEnv"><span class="hs-identifier hs-var">LetDecEnv</span></a><span> </span><a name="local-6989586621679069112"><a href="#local-6989586621679069112"><span class="hs-identifier">defns1</span></a></a><span> </span><a name="local-6989586621679069113"><a href="#local-6989586621679069113"><span class="hs-identifier">types1</span></a></a><span> </span><a name="local-6989586621679069114"><a href="#local-6989586621679069114"><span class="hs-identifier">infx1</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-3458764513820541482"><span class="hs-operator">&lt;&gt;</span></a><span> </span><a href="Data.Singletons.Syntax.html#LetDecEnv"><span class="hs-identifier hs-var">LetDecEnv</span></a><span> </span><a name="local-6989586621679069115"><a href="#local-6989586621679069115"><span class="hs-identifier">defns2</span></a></a><span> </span><a name="local-6989586621679069116"><a href="#local-6989586621679069116"><span class="hs-identifier">types2</span></a></a><span> </span><a name="local-6989586621679069117"><a href="#local-6989586621679069117"><span class="hs-identifier">infx2</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-162"></a><span>    </span><a href="Data.Singletons.Syntax.html#LetDecEnv"><span class="hs-identifier hs-var">LetDecEnv</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679069112"><span class="hs-identifier hs-var">defns1</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-6989586621679069115"><span class="hs-identifier hs-var">defns2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679069113"><span class="hs-identifier hs-var">types1</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-6989586621679069116"><span class="hs-identifier hs-var">types2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679069114"><span class="hs-identifier hs-var">infx1</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-6989586621679069117"><span class="hs-identifier hs-var">infx2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-163"></a><span>
</span><a name="line-164"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Monoid</span><span> </span><a href="Data.Singletons.Syntax.html#ULetDecEnv"><span class="hs-identifier hs-type">ULetDecEnv</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-165"></a><span>  </span><a name="local-3458764513820541483"><span class="hs-identifier">mempty</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Syntax.html#LetDecEnv"><span class="hs-identifier hs-var">LetDecEnv</span></a><span> </span><span class="hs-identifier hs-var">Map.empty</span><span> </span><span class="hs-identifier hs-var">Map.empty</span><span> </span><span class="hs-identifier hs-var">Map.empty</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-166"></a><span>
</span><a name="line-167"></a><span class="hs-identifier">valueBinding</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Syntax.html#ULetDecRHS"><span class="hs-identifier hs-type">ULetDecRHS</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Syntax.html#ULetDecEnv"><span class="hs-identifier hs-type">ULetDecEnv</span></a><span>
</span><a name="line-168"></a><a name="valueBinding"><a href="Data.Singletons.Syntax.html#valueBinding"><span class="hs-identifier">valueBinding</span></a></a><span> </span><a name="local-6989586621679069123"><a href="#local-6989586621679069123"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679069124"><a href="#local-6989586621679069124"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Syntax.html#emptyLetDecEnv"><span class="hs-identifier hs-var">emptyLetDecEnv</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">lde_defns</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.singleton</span><span> </span><a href="#local-6989586621679069123"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621679069124"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-169"></a><span>
</span><a name="line-170"></a><span class="hs-identifier">typeBinding</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Syntax.html#ULetDecEnv"><span class="hs-identifier hs-type">ULetDecEnv</span></a><span>
</span><a name="line-171"></a><a name="typeBinding"><a href="Data.Singletons.Syntax.html#typeBinding"><span class="hs-identifier">typeBinding</span></a></a><span> </span><a name="local-6989586621679069232"><a href="#local-6989586621679069232"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679069233"><a href="#local-6989586621679069233"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Syntax.html#emptyLetDecEnv"><span class="hs-identifier hs-var">emptyLetDecEnv</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">lde_types</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.singleton</span><span> </span><a href="#local-6989586621679069232"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621679069233"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-172"></a><span>
</span><a name="line-173"></a><span class="hs-identifier">infixDecl</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Fixity</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Syntax.html#ULetDecEnv"><span class="hs-identifier hs-type">ULetDecEnv</span></a><span>
</span><a name="line-174"></a><a name="infixDecl"><a href="Data.Singletons.Syntax.html#infixDecl"><span class="hs-identifier">infixDecl</span></a></a><span> </span><a name="local-6989586621679069234"><a href="#local-6989586621679069234"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679069235"><a href="#local-6989586621679069235"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Syntax.html#emptyLetDecEnv"><span class="hs-identifier hs-var">emptyLetDecEnv</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">lde_infix</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.singleton</span><span> </span><a href="#local-6989586621679069235"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621679069234"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-175"></a><span>
</span><a name="line-176"></a><span class="hs-identifier">emptyLetDecEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Singletons.Syntax.html#ULetDecEnv"><span class="hs-identifier hs-type">ULetDecEnv</span></a><span>
</span><a name="line-177"></a><a name="emptyLetDecEnv"><a href="Data.Singletons.Syntax.html#emptyLetDecEnv"><span class="hs-identifier">emptyLetDecEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mempty</span><span>
</span><a name="line-178"></a><span>
</span><a name="line-179"></a><span class="hs-identifier">buildLetDecEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Quasi</span><span> </span><a href="#local-6989586621679069122"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DLetDec</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679069122"><span class="hs-identifier hs-type">q</span></a><span> </span><a href="Data.Singletons.Syntax.html#ULetDecEnv"><span class="hs-identifier hs-type">ULetDecEnv</span></a><span>
</span><a name="line-180"></a><a name="buildLetDecEnv"><a href="Data.Singletons.Syntax.html#buildLetDecEnv"><span class="hs-identifier">buildLetDecEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679069236"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="Data.Singletons.Syntax.html#emptyLetDecEnv"><span class="hs-identifier hs-var">emptyLetDecEnv</span></a><span>
</span><a name="line-181"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-182"></a><span>    </span><a name="local-6989586621679069236"><a href="#local-6989586621679069236"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621679069237"><a href="#local-6989586621679069237"><span class="hs-identifier">acc</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679069237"><span class="hs-identifier hs-var">acc</span></a><span>
</span><a name="line-183"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621679069238"><a href="#local-6989586621679069238"><span class="hs-identifier">acc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DFunD</span><span> </span><a name="local-6989586621679069239"><a href="#local-6989586621679069239"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621679069240"><a href="#local-6989586621679069240"><span class="hs-identifier">clauses</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621679069241"><a href="#local-6989586621679069241"><span class="hs-identifier">rest</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-184"></a><span>      </span><a href="#local-6989586621679069236"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Syntax.html#valueBinding"><span class="hs-identifier hs-var">valueBinding</span></a><span> </span><a href="#local-6989586621679069239"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Syntax.html#UFunction"><span class="hs-identifier hs-var">UFunction</span></a><span> </span><a href="#local-6989586621679069240"><span class="hs-identifier hs-var">clauses</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-6989586621679069238"><span class="hs-identifier hs-var">acc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679069241"><span class="hs-identifier hs-var">rest</span></a><span>
</span><a name="line-185"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621679069242"><a href="#local-6989586621679069242"><span class="hs-identifier">acc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DValD</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DVarPa</span><span> </span><a name="local-6989586621679069243"><a href="#local-6989586621679069243"><span class="hs-identifier">name</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679069244"><a href="#local-6989586621679069244"><span class="hs-identifier">exp</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621679069245"><a href="#local-6989586621679069245"><span class="hs-identifier">rest</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-186"></a><span>      </span><a href="#local-6989586621679069236"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Syntax.html#valueBinding"><span class="hs-identifier hs-var">valueBinding</span></a><span> </span><a href="#local-6989586621679069243"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Syntax.html#UValue"><span class="hs-identifier hs-var">UValue</span></a><span> </span><a href="#local-6989586621679069244"><span class="hs-identifier hs-var">exp</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-6989586621679069242"><span class="hs-identifier hs-var">acc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679069245"><span class="hs-identifier hs-var">rest</span></a><span>
</span><a name="line-187"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621679069246"><a href="#local-6989586621679069246"><span class="hs-identifier">acc</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679069247"><a href="#local-6989586621679069247"><span class="hs-identifier">dec</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">DValD</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621679069248"><a href="#local-6989586621679069248"><span class="hs-identifier">rest</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-188"></a><span>      </span><a name="local-6989586621679069249"><a href="#local-6989586621679069249"><span class="hs-identifier">flattened</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">flattenDValD</span><span> </span><a href="#local-6989586621679069247"><span class="hs-identifier hs-var">dec</span></a><span>
</span><a name="line-189"></a><span>      </span><a href="#local-6989586621679069236"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679069246"><span class="hs-identifier hs-var">acc</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679069249"><span class="hs-identifier hs-var">flattened</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679069248"><span class="hs-identifier hs-var">rest</span></a><span class="hs-special">)</span><span>
</span><a name="line-190"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621679069250"><a href="#local-6989586621679069250"><span class="hs-identifier">acc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DSigD</span><span> </span><a name="local-6989586621679069251"><a href="#local-6989586621679069251"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621679069252"><a href="#local-6989586621679069252"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621679069253"><a href="#local-6989586621679069253"><span class="hs-identifier">rest</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-191"></a><span>      </span><a href="#local-6989586621679069236"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Syntax.html#typeBinding"><span class="hs-identifier hs-var">typeBinding</span></a><span> </span><a href="#local-6989586621679069251"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679069252"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-6989586621679069250"><span class="hs-identifier hs-var">acc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679069253"><span class="hs-identifier hs-var">rest</span></a><span>
</span><a name="line-192"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621679069254"><a href="#local-6989586621679069254"><span class="hs-identifier">acc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DInfixD</span><span> </span><a name="local-6989586621679069255"><a href="#local-6989586621679069255"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679069256"><a href="#local-6989586621679069256"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621679069257"><a href="#local-6989586621679069257"><span class="hs-identifier">rest</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-193"></a><span>      </span><a href="#local-6989586621679069236"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Syntax.html#infixDecl"><span class="hs-identifier hs-var">infixDecl</span></a><span> </span><a href="#local-6989586621679069255"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679069256"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-6989586621679069254"><span class="hs-identifier hs-var">acc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679069257"><span class="hs-identifier hs-var">rest</span></a><span>
</span><a name="line-194"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621679069258"><a href="#local-6989586621679069258"><span class="hs-identifier">acc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DPragmaD</span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621679069259"><a href="#local-6989586621679069259"><span class="hs-identifier">rest</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679069236"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679069258"><span class="hs-identifier hs-var">acc</span></a><span> </span><a href="#local-6989586621679069259"><span class="hs-identifier hs-var">rest</span></a><span>
</span><a name="line-195"></a><span>
</span><a name="line-196"></a><span class="hs-comment">-- See Note [DerivedDecl]</span><span>
</span><a name="line-197"></a><span class="hs-keyword">data</span><span> </span><a name="DerivedDecl"><a href="Data.Singletons.Syntax.html#DerivedDecl"><span class="hs-identifier">DerivedDecl</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679066078"><a href="#local-6989586621679066078"><span class="hs-identifier">cls</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Constraint</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="DerivedDecl"><a href="Data.Singletons.Syntax.html#DerivedDecl"><span class="hs-identifier">DerivedDecl</span></a></a><span>
</span><a name="line-198"></a><span>  </span><span class="hs-special">{</span><span> </span><a name="ded_mb_cxt"><a href="Data.Singletons.Syntax.html#ded_mb_cxt"><span class="hs-identifier">ded_mb_cxt</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">DCxt</span><span>
</span><a name="line-199"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="ded_type"><a href="Data.Singletons.Syntax.html#ded_type"><span class="hs-identifier">ded_type</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DType</span><span>
</span><a name="line-200"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="ded_decl"><a href="Data.Singletons.Syntax.html#ded_decl"><span class="hs-identifier">ded_decl</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><a href="Data.Singletons.Syntax.html#DataDecl"><span class="hs-identifier hs-type">DataDecl</span></a><span>
</span><a name="line-201"></a><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-202"></a><span>
</span><a name="line-203"></a><span class="hs-keyword">type</span><span> </span><a name="DerivedEqDecl"><a href="Data.Singletons.Syntax.html#DerivedEqDecl"><span class="hs-identifier">DerivedEqDecl</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Syntax.html#DerivedDecl"><span class="hs-identifier hs-type">DerivedDecl</span></a><span> </span><span class="hs-identifier hs-type">Eq</span><span>
</span><a name="line-204"></a><span class="hs-keyword">type</span><span> </span><a name="DerivedShowDecl"><a href="Data.Singletons.Syntax.html#DerivedShowDecl"><span class="hs-identifier">DerivedShowDecl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Syntax.html#DerivedDecl"><span class="hs-identifier hs-type">DerivedDecl</span></a><span> </span><span class="hs-identifier hs-type">Show</span><span>
</span><a name="line-205"></a><span>
</span><a name="line-206"></a><span class="hs-comment">{- Note [DerivedDecl]
~~~~~~~~~~~~~~~~~~~~~
Most derived instances are wholly handled in
Data.Singletons.Partition.partitionDecs. There are two notable exceptions to
this rule, however:

* Eq instances (which are handled entirely outside of partitionDecs)
* Show instances (which are partially handled outside of partitionDecs)

For these instances, we use a DerivedDecl data type to encode just enough
information to recreate the derived instance:

1. Just the instance context, if it's standalone-derived, or Nothing if it's in
   a deriving clause (ded_mb_cxt)
2. The datatype, applied to some number of type arguments, as in the
   instance declaration (ded_type)
3. The datatype's original information, as provided through DataDecl (ded_decl)

Why are these instances handled outside of partitionDecs?

* Deriving Eq in singletons not only derives PEq/SEq instances, but it also
  derives SDecide instances. This additional complication makes Eq difficult
  to integrate with the other deriving machinery, so we handle it specially
  in Data.Singletons.Promote and Data.Singletons.Single (depending on the task
  at hand).
* Deriving Show in singletons not only derives PShow/SShow instances, but it
  also derives Show instances for singletons types. To make this work,
  we let partitionDecs handle the PShow/SShow instances, but we also stick the
  relevant info into a DerivedDecl value for later use in
  Data.Singletons.Single, where we additionally generate Show
  instances.
-}</span><span>
</span><a name="line-238"></a></pre></body></html>