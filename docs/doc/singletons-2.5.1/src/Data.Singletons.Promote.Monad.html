<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{- Data/Singletons/Promote/Monad.hs

(c) Richard Eisenberg 2014
rae@cs.brynmawr.edu

This file defines the PrM monad and its operations, for use during promotion.

The PrM monad allows reading from a PrEnv environment and writing to a list
of DDec, and is wrapped around a Q.
-}</span><span>
</span><a name="line-11"></a><span>
</span><a name="line-12"></a><span class="hs-pragma">{-# LANGUAGE GeneralizedNewtypeDeriving, StandaloneDeriving,
             FlexibleContexts, TypeFamilies, KindSignatures #-}</span><span>
</span><a name="line-14"></a><span>
</span><a name="line-15"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Data.Singletons.Promote.Monad</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-16"></a><span>  </span><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a><span class="hs-special">,</span><span> </span><a href="Data.Singletons.Promote.Monad.html#promoteM"><span class="hs-identifier hs-var">promoteM</span></a><span class="hs-special">,</span><span> </span><a href="Data.Singletons.Promote.Monad.html#promoteM_"><span class="hs-identifier hs-var">promoteM_</span></a><span class="hs-special">,</span><span> </span><a href="Data.Singletons.Promote.Monad.html#promoteMDecs"><span class="hs-identifier hs-var">promoteMDecs</span></a><span class="hs-special">,</span><span> </span><a href="Data.Singletons.Syntax.html#VarPromotions"><span class="hs-identifier hs-type">VarPromotions</span></a><span class="hs-special">,</span><span>
</span><a name="line-17"></a><span>  </span><a href="Data.Singletons.Promote.Monad.html#allLocals"><span class="hs-identifier hs-var">allLocals</span></a><span class="hs-special">,</span><span> </span><a href="Data.Singletons.Promote.Monad.html#emitDecs"><span class="hs-identifier hs-var">emitDecs</span></a><span class="hs-special">,</span><span> </span><a href="Data.Singletons.Promote.Monad.html#emitDecsM"><span class="hs-identifier hs-var">emitDecsM</span></a><span class="hs-special">,</span><span>
</span><a name="line-18"></a><span>  </span><a href="Data.Singletons.Promote.Monad.html#lambdaBind"><span class="hs-identifier hs-var">lambdaBind</span></a><span class="hs-special">,</span><span> </span><a href="Data.Singletons.Promote.Monad.html#LetBind"><span class="hs-identifier hs-type">LetBind</span></a><span class="hs-special">,</span><span> </span><a href="Data.Singletons.Promote.Monad.html#letBind"><span class="hs-identifier hs-var">letBind</span></a><span class="hs-special">,</span><span> </span><a href="Data.Singletons.Promote.Monad.html#lookupVarE"><span class="hs-identifier hs-var">lookupVarE</span></a><span class="hs-special">,</span><span> </span><a href="Data.Singletons.Promote.Monad.html#forallBind"><span class="hs-identifier hs-var">forallBind</span></a><span class="hs-special">,</span><span> </span><a href="Data.Singletons.Promote.Monad.html#allBoundKindVars"><span class="hs-identifier hs-var">allBoundKindVars</span></a><span>
</span><a name="line-19"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-20"></a><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.Reader</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.Writer</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Map.Strict</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Map</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Map.Strict</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Set</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Set</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Set</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Set</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Language.Haskell.TH.Syntax</span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">lift</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Language.Haskell.TH.Desugar</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Singletons.Names.html"><span class="hs-identifier">Data.Singletons.Names</span></a><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Singletons.Syntax.html"><span class="hs-identifier">Data.Singletons.Syntax</span></a><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.Fail</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">MonadFail</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-32"></a><span>
</span><a name="line-33"></a><span class="hs-keyword">type</span><span> </span><a name="LetExpansions"><a href="Data.Singletons.Promote.Monad.html#LetExpansions"><span class="hs-identifier">LetExpansions</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-identifier hs-type">DType</span><span>  </span><span class="hs-comment">-- from **term-level** name</span><span>
</span><a name="line-34"></a><span>
</span><a name="line-35"></a><span class="hs-comment">-- environment during promotion</span><span>
</span><a name="line-36"></a><span class="hs-keyword">data</span><span> </span><a name="PrEnv"><a href="Data.Singletons.Promote.Monad.html#PrEnv"><span class="hs-identifier">PrEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-37"></a><span>  </span><a name="PrEnv"><a href="Data.Singletons.Promote.Monad.html#PrEnv"><span class="hs-identifier">PrEnv</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="pr_lambda_bound"><a href="Data.Singletons.Promote.Monad.html#pr_lambda_bound"><span class="hs-identifier">pr_lambda_bound</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-38"></a><span>        </span><span class="hs-special">,</span><span> </span><a name="pr_let_bound"><a href="Data.Singletons.Promote.Monad.html#pr_let_bound"><span class="hs-identifier">pr_let_bound</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="Data.Singletons.Promote.Monad.html#LetExpansions"><span class="hs-identifier hs-type">LetExpansions</span></a><span>
</span><a name="line-39"></a><span>        </span><span class="hs-special">,</span><span> </span><a name="pr_forall_bound"><a href="Data.Singletons.Promote.Monad.html#pr_forall_bound"><span class="hs-identifier">pr_forall_bound</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Set</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-comment">-- See Note [Explicitly quantifying kinds variables]</span><span>
</span><a name="line-40"></a><span>        </span><span class="hs-special">,</span><span> </span><a name="pr_local_decls"><a href="Data.Singletons.Promote.Monad.html#pr_local_decls"><span class="hs-identifier">pr_local_decls</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span>
</span><a name="line-41"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-42"></a><span>
</span><a name="line-43"></a><span class="hs-identifier">emptyPrEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Singletons.Promote.Monad.html#PrEnv"><span class="hs-identifier hs-type">PrEnv</span></a><span>
</span><a name="line-44"></a><a name="emptyPrEnv"><a href="Data.Singletons.Promote.Monad.html#emptyPrEnv"><span class="hs-identifier">emptyPrEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Promote.Monad.html#PrEnv"><span class="hs-identifier hs-var">PrEnv</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">pr_lambda_bound</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.empty</span><span>
</span><a name="line-45"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">pr_let_bound</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.empty</span><span>
</span><a name="line-46"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">pr_forall_bound</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Set.empty</span><span>
</span><a name="line-47"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">pr_local_decls</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-48"></a><span>
</span><a name="line-49"></a><span class="hs-comment">-- the promotion monad</span><span>
</span><a name="line-50"></a><span class="hs-keyword">newtype</span><span> </span><a name="PrM"><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier">PrM</span></a></a><span> </span><a name="local-6989586621679159523"><a href="#local-6989586621679159523"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="PrM"><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier">PrM</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ReaderT</span><span> </span><a href="Data.Singletons.Promote.Monad.html#PrEnv"><span class="hs-identifier hs-type">PrEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">WriterT</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DDec</span><span class="hs-special">]</span><span> </span><span class="hs-identifier hs-type">Q</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679159523"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-51"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Functor</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Applicative</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Monad</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Quasi</span><span>
</span><a name="line-52"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadReader</span><span> </span><a href="Data.Singletons.Promote.Monad.html#PrEnv"><span class="hs-identifier hs-type">PrEnv</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadWriter</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DDec</span><span class="hs-special">]</span><span>
</span><a name="line-53"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadFail</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-54"></a><span>
</span><a name="line-55"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">DsMonad</span><span> </span><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-56"></a><span>  </span><a name="local-8214565720323796445"><span class="hs-identifier">localDeclarations</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">asks</span><span> </span><span class="hs-identifier">pr_local_decls</span><span>
</span><a name="line-57"></a><span>
</span><a name="line-58"></a><span class="hs-comment">-- return *type-level* names</span><span>
</span><a name="line-59"></a><span class="hs-identifier">allLocals</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadReader</span><span> </span><a href="Data.Singletons.Promote.Monad.html#PrEnv"><span class="hs-identifier hs-type">PrEnv</span></a><span> </span><a href="#local-6989586621679159533"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679159533"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span>
</span><a name="line-60"></a><a name="allLocals"><a href="Data.Singletons.Promote.Monad.html#allLocals"><span class="hs-identifier">allLocals</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-61"></a><span>  </span><a name="local-6989586621679159534"><a href="#local-6989586621679159534"><span class="hs-identifier">lambdas</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">asks</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.toList</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">pr_lambda_bound</span><span class="hs-special">)</span><span>
</span><a name="line-62"></a><span>  </span><a name="local-6989586621679159535"><a href="#local-6989586621679159535"><span class="hs-identifier">lets</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">asks</span><span> </span><span class="hs-identifier">pr_let_bound</span><span>
</span><a name="line-63"></a><span>    </span><span class="hs-comment">-- filter out shadowed variables!</span><span>
</span><a name="line-64"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621679159537"><span class="hs-identifier hs-var">typeName</span></a><span>
</span><a name="line-65"></a><span>         </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679159536"><a href="#local-6989586621679159536"><span class="hs-identifier">termName</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679159537"><a href="#local-6989586621679159537"><span class="hs-identifier">typeName</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679159534"><span class="hs-identifier hs-var">lambdas</span></a><span>
</span><a name="line-66"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><a href="#local-6989586621679159536"><span class="hs-identifier hs-var">termName</span></a><span> </span><a href="#local-6989586621679159535"><span class="hs-identifier hs-var">lets</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-67"></a><span>             </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DVarT</span><span> </span><a name="local-6989586621679159538"><a href="#local-6989586621679159538"><span class="hs-identifier">typeName'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679159538"><span class="hs-identifier hs-var">typeName'</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621679159537"><span class="hs-identifier hs-var">typeName</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-68"></a><span>             </span><span class="hs-identifier">_</span><span>                                              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-69"></a><span>
</span><a name="line-70"></a><span class="hs-identifier">emitDecs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadWriter</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DDec</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621679159532"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DDec</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679159532"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-71"></a><a name="emitDecs"><a href="Data.Singletons.Promote.Monad.html#emitDecs"><span class="hs-identifier">emitDecs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tell</span><span>
</span><a name="line-72"></a><span>
</span><a name="line-73"></a><span class="hs-identifier">emitDecsM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadWriter</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DDec</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621679159531"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679159531"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DDec</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679159531"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-74"></a><a name="emitDecsM"><a href="Data.Singletons.Promote.Monad.html#emitDecsM"><span class="hs-identifier">emitDecsM</span></a></a><span> </span><a name="local-6989586621679159539"><a href="#local-6989586621679159539"><span class="hs-identifier">action</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-75"></a><span>  </span><a name="local-6989586621679159540"><a href="#local-6989586621679159540"><span class="hs-identifier">decs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679159539"><span class="hs-identifier hs-var">action</span></a><span>
</span><a name="line-76"></a><span>  </span><a href="Data.Singletons.Promote.Monad.html#emitDecs"><span class="hs-identifier hs-var">emitDecs</span></a><span> </span><a href="#local-6989586621679159540"><span class="hs-identifier hs-var">decs</span></a><span>
</span><a name="line-77"></a><span>
</span><a name="line-78"></a><span class="hs-comment">-- when lambda-binding variables, we still need to add the variables</span><span>
</span><a name="line-79"></a><span class="hs-comment">-- to the let-expansion, because of shadowing. ugh.</span><span>
</span><a name="line-80"></a><span class="hs-identifier">lambdaBind</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Singletons.Syntax.html#VarPromotions"><span class="hs-identifier hs-type">VarPromotions</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a><span> </span><a href="#local-6989586621679159530"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a><span> </span><a href="#local-6989586621679159530"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-81"></a><a name="lambdaBind"><a href="Data.Singletons.Promote.Monad.html#lambdaBind"><span class="hs-identifier">lambdaBind</span></a></a><span> </span><a name="local-6989586621679159541"><a href="#local-6989586621679159541"><span class="hs-identifier">binds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">local</span><span> </span><a href="#local-6989586621679159542"><span class="hs-identifier hs-var">add_binds</span></a><span>
</span><a name="line-82"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621679159542"><a href="#local-6989586621679159542"><span class="hs-identifier">add_binds</span></a></a><span> </span><a name="local-6989586621679159543"><a href="#local-6989586621679159543"><span class="hs-identifier">env</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Data.Singletons.Promote.Monad.html#PrEnv"><span class="hs-identifier hs-var">PrEnv</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">pr_lambda_bound</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679159544"><a href="#local-6989586621679159544"><span class="hs-identifier">lambdas</span></a></a><span>
</span><a name="line-83"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">pr_let_bound</span><span>    </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679159545"><a href="#local-6989586621679159545"><span class="hs-identifier">lets</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-84"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679159546"><a href="#local-6989586621679159546"><span class="hs-identifier">new_lets</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.fromList</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679159547"><span class="hs-identifier hs-var">tmN</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">DVarT</span><span> </span><a href="#local-6989586621679159548"><span class="hs-identifier hs-var">tyN</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679159547"><a href="#local-6989586621679159547"><span class="hs-identifier">tmN</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679159548"><a href="#local-6989586621679159548"><span class="hs-identifier">tyN</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679159541"><span class="hs-identifier hs-var">binds</span></a><span> </span><span class="hs-special">]</span><span> </span><span class="hs-keyword">in</span><span>
</span><a name="line-85"></a><span>          </span><a href="#local-6989586621679159543"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">pr_lambda_bound</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.union</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.fromList</span><span> </span><a href="#local-6989586621679159541"><span class="hs-identifier hs-var">binds</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679159544"><span class="hs-identifier hs-var">lambdas</span></a><span>
</span><a name="line-86"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">pr_let_bound</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.union</span><span> </span><a href="#local-6989586621679159546"><span class="hs-identifier hs-var">new_lets</span></a><span> </span><a href="#local-6989586621679159545"><span class="hs-identifier hs-var">lets</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-87"></a><span>
</span><a name="line-88"></a><span class="hs-keyword">type</span><span> </span><a name="LetBind"><a href="Data.Singletons.Promote.Monad.html#LetBind"><span class="hs-identifier">LetBind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">DType</span><span class="hs-special">)</span><span>
</span><a name="line-89"></a><span class="hs-identifier">letBind</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Data.Singletons.Promote.Monad.html#LetBind"><span class="hs-identifier hs-type">LetBind</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a><span> </span><a href="#local-6989586621679159529"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a><span> </span><a href="#local-6989586621679159529"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-90"></a><a name="letBind"><a href="Data.Singletons.Promote.Monad.html#letBind"><span class="hs-identifier">letBind</span></a></a><span> </span><a name="local-6989586621679159549"><a href="#local-6989586621679159549"><span class="hs-identifier">binds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">local</span><span> </span><a href="#local-6989586621679159550"><span class="hs-identifier hs-var">add_binds</span></a><span>
</span><a name="line-91"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621679159550"><a href="#local-6989586621679159550"><span class="hs-identifier">add_binds</span></a></a><span> </span><a name="local-6989586621679159551"><a href="#local-6989586621679159551"><span class="hs-identifier">env</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Data.Singletons.Promote.Monad.html#PrEnv"><span class="hs-identifier hs-var">PrEnv</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">pr_let_bound</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679159552"><a href="#local-6989586621679159552"><span class="hs-identifier">lets</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-92"></a><span>          </span><a href="#local-6989586621679159551"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">pr_let_bound</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.union</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.fromList</span><span> </span><a href="#local-6989586621679159549"><span class="hs-identifier hs-var">binds</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679159552"><span class="hs-identifier hs-var">lets</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-93"></a><span>
</span><a name="line-94"></a><span class="hs-identifier">lookupVarE</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a><span> </span><span class="hs-identifier hs-type">DType</span><span>
</span><a name="line-95"></a><a name="lookupVarE"><a href="Data.Singletons.Promote.Monad.html#lookupVarE"><span class="hs-identifier">lookupVarE</span></a></a><span> </span><a name="local-6989586621679159553"><a href="#local-6989586621679159553"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-96"></a><span>  </span><a name="local-6989586621679159554"><a href="#local-6989586621679159554"><span class="hs-identifier">lets</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">asks</span><span> </span><span class="hs-identifier">pr_let_bound</span><span>
</span><a name="line-97"></a><span>  </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><a href="#local-6989586621679159553"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621679159554"><span class="hs-identifier hs-var">lets</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-98"></a><span>    </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679159555"><a href="#local-6989586621679159555"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679159555"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-99"></a><span>    </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Singletons.Names.html#promoteValRhs"><span class="hs-identifier hs-var">promoteValRhs</span></a><span> </span><a href="#local-6989586621679159553"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-100"></a><span>
</span><a name="line-101"></a><span class="hs-comment">-- Add to the set of bound kind variables currently in scope.</span><span>
</span><a name="line-102"></a><span class="hs-comment">-- See Note [Explicitly binding kind variables]</span><span>
</span><a name="line-103"></a><span class="hs-identifier">forallBind</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Set</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a><span> </span><a href="#local-6989586621679159528"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a><span> </span><a href="#local-6989586621679159528"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-104"></a><a name="forallBind"><a href="Data.Singletons.Promote.Monad.html#forallBind"><span class="hs-identifier">forallBind</span></a></a><span> </span><a name="local-6989586621679159556"><a href="#local-6989586621679159556"><span class="hs-identifier">kvs1</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-105"></a><span>  </span><span class="hs-identifier hs-var">local</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679159557"><a href="#local-6989586621679159557"><span class="hs-identifier">env</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Data.Singletons.Promote.Monad.html#PrEnv"><span class="hs-identifier hs-var">PrEnv</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">pr_forall_bound</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679159558"><a href="#local-6989586621679159558"><span class="hs-identifier">kvs2</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-106"></a><span>    </span><a href="#local-6989586621679159557"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">pr_forall_bound</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679159556"><span class="hs-identifier hs-var">kvs1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">Set.union</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679159558"><span class="hs-identifier hs-var">kvs2</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-107"></a><span>
</span><a name="line-108"></a><span class="hs-comment">-- Look up the set of bound kind variables currently in scope.</span><span>
</span><a name="line-109"></a><span class="hs-comment">-- See Note [Explicitly binding kind variables]</span><span>
</span><a name="line-110"></a><span class="hs-identifier">allBoundKindVars</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Set</span><span> </span><span class="hs-identifier hs-type">Name</span><span class="hs-special">)</span><span>
</span><a name="line-111"></a><a name="allBoundKindVars"><a href="Data.Singletons.Promote.Monad.html#allBoundKindVars"><span class="hs-identifier">allBoundKindVars</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">asks</span><span> </span><span class="hs-identifier">pr_forall_bound</span><span>
</span><a name="line-112"></a><span>
</span><a name="line-113"></a><span class="hs-identifier">promoteM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DsMonad</span><span> </span><a href="#local-6989586621679159526"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a><span> </span><a href="#local-6989586621679159527"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679159526"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679159527"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DDec</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-114"></a><a name="promoteM"><a href="Data.Singletons.Promote.Monad.html#promoteM"><span class="hs-identifier">promoteM</span></a></a><span> </span><a name="local-6989586621679159559"><a href="#local-6989586621679159559"><span class="hs-identifier">locals</span></a></a><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-var">PrM</span></a><span> </span><a name="local-6989586621679159560"><a href="#local-6989586621679159560"><span class="hs-identifier">rdr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-115"></a><span>  </span><a name="local-6989586621679159561"><a href="#local-6989586621679159561"><span class="hs-identifier">other_locals</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">localDeclarations</span><span>
</span><a name="line-116"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679159562"><a href="#local-6989586621679159562"><span class="hs-identifier">wr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">runReaderT</span><span> </span><a href="#local-6989586621679159560"><span class="hs-identifier hs-var">rdr</span></a><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Promote.Monad.html#emptyPrEnv"><span class="hs-identifier hs-var">emptyPrEnv</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">pr_local_decls</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679159561"><span class="hs-identifier hs-var">other_locals</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679159559"><span class="hs-identifier hs-var">locals</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-117"></a><span>      </span><a name="local-6989586621679159563"><a href="#local-6989586621679159563"><span class="hs-identifier">q</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">runWriterT</span><span> </span><a href="#local-6989586621679159562"><span class="hs-identifier hs-var">wr</span></a><span>
</span><a name="line-118"></a><span>  </span><span class="hs-identifier hs-var">runQ</span><span> </span><a href="#local-6989586621679159563"><span class="hs-identifier hs-var">q</span></a><span>
</span><a name="line-119"></a><span>
</span><a name="line-120"></a><span class="hs-identifier">promoteM_</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DsMonad</span><span> </span><a href="#local-6989586621679159525"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679159525"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DDec</span><span class="hs-special">]</span><span>
</span><a name="line-121"></a><a name="promoteM_"><a href="Data.Singletons.Promote.Monad.html#promoteM_"><span class="hs-identifier">promoteM_</span></a></a><span> </span><a name="local-6989586621679159564"><a href="#local-6989586621679159564"><span class="hs-identifier">locals</span></a></a><span> </span><a name="local-6989586621679159565"><a href="#local-6989586621679159565"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-122"></a><span>  </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679159566"><a href="#local-6989586621679159566"><span class="hs-identifier">decs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Promote.Monad.html#promoteM"><span class="hs-identifier hs-var">promoteM</span></a><span> </span><a href="#local-6989586621679159564"><span class="hs-identifier hs-var">locals</span></a><span> </span><a href="#local-6989586621679159565"><span class="hs-identifier hs-var">thing</span></a><span>
</span><a name="line-123"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679159566"><span class="hs-identifier hs-var">decs</span></a><span>
</span><a name="line-124"></a><span>
</span><a name="line-125"></a><span class="hs-comment">-- promoteM specialized to [DDec]</span><span>
</span><a name="line-126"></a><span class="hs-identifier">promoteMDecs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DsMonad</span><span> </span><a href="#local-6989586621679159524"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DDec</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679159524"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DDec</span><span class="hs-special">]</span><span>
</span><a name="line-127"></a><a name="promoteMDecs"><a href="Data.Singletons.Promote.Monad.html#promoteMDecs"><span class="hs-identifier">promoteMDecs</span></a></a><span> </span><a name="local-6989586621679159567"><a href="#local-6989586621679159567"><span class="hs-identifier">locals</span></a></a><span> </span><a name="local-6989586621679159568"><a href="#local-6989586621679159568"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-128"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679159569"><a href="#local-6989586621679159569"><span class="hs-identifier">decs1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679159570"><a href="#local-6989586621679159570"><span class="hs-identifier">decs2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Promote.Monad.html#promoteM"><span class="hs-identifier hs-var">promoteM</span></a><span> </span><a href="#local-6989586621679159567"><span class="hs-identifier hs-var">locals</span></a><span> </span><a href="#local-6989586621679159568"><span class="hs-identifier hs-var">thing</span></a><span>
</span><a name="line-129"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679159569"><span class="hs-identifier hs-var">decs1</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679159570"><span class="hs-identifier hs-var">decs2</span></a><span>
</span><a name="line-130"></a><span>
</span><a name="line-131"></a><span class="hs-comment">{-
Note [Explicitly binding kind variables]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We want to ensure that when we single type signatures for functions, we should
explicitly quantify every kind variable bound by a forall. For example, if we
were to single the identity function:

  identity :: forall a. a -&gt; a
  identity x = x

We want the final result to be:

  sIdentity :: forall a (x :: a). Sing x -&gt; Sing (Identity x)
  sIdentity sX = sX

Accomplishing this takes a bit of care during promotion. When promoting a
function, we determine what set of kind variables are currently bound at that
point and store them in an ALetDecEnv (as lde_bound_kvs), which in turn is
singled. Then, during singling, we extract every kind variable in a singled
type signature, subtract the lde_bound_kvs, and explicitly bind the variables
that remain.

For a top-level function like identity, lde_bound_kvs is the empty set. But
consider this more complicated example:

  f :: forall a. a -&gt; a
  f = g
    where
      g :: a -&gt; a
      g x = x

When singling, we would eventually end up in this spot:

  sF :: forall a (x :: a). Sing a -&gt; Sing (F a)
  sF = sG
    where
      sG :: _
      sG x = x

We must make sure /not/ to fill in the following type for _:

  sF :: forall a (x :: a). Sing a -&gt; Sing (F a)
  sF = sG
    where
      sG :: forall a (y :: a). Sing a -&gt; Sing (G a)
      sG x = x

This would be incorrect, as the `a` bound by sF /must/ be the same one used in
sG, as per the scoping of the original `f` function. Thus, we ensure that the
bound variables from `f` are put into lde_bound_kvs when promoting `g` so
that we subtract out `a` and are left with the correct result:

  sF :: forall a (x :: a). Sing a -&gt; Sing (F a)
  sF = sG
    where
      sG :: forall (y :: a). Sing a -&gt; Sing (G a)
      sG x = x
-}</span><span>
</span><a name="line-189"></a></pre></body></html>