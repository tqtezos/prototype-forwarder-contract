<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{- Data/Singletons/Promote/Defun.hs

(c) Richard Eisenberg, Jan Stolarek 2014
rae@cs.brynmawr.edu

This file creates defunctionalization symbols for types during promotion.
-}</span><span>
</span><a name="line-8"></a><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# LANGUAGE TemplateHaskell #-}</span><span>
</span><a name="line-10"></a><span>
</span><a name="line-11"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Data.Singletons.Promote.Defun</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-12"></a><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Language.Haskell.TH.Desugar</span><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Singletons.Promote.Monad.html"><span class="hs-identifier">Data.Singletons.Promote.Monad</span></a><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Singletons.Promote.Type.html"><span class="hs-identifier">Data.Singletons.Promote.Type</span></a><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Singletons.Names.html"><span class="hs-identifier">Data.Singletons.Names</span></a><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Language.Haskell.TH.Syntax</span><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Singletons.Syntax.html"><span class="hs-identifier">Data.Singletons.Syntax</span></a><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Singletons.Util.html"><span class="hs-identifier">Data.Singletons.Util</span></a><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Map.Strict</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Map</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Map.Strict</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Map</span><span class="hs-special">)</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Maybe</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Set</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Set</span><span>
</span><a name="line-25"></a><span>
</span><a name="line-26"></a><span class="hs-identifier">defunInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DInfo</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DDec</span><span class="hs-special">]</span><span>
</span><a name="line-27"></a><a name="defunInfo"><a href="Data.Singletons.Promote.Defun.html#defunInfo"><span class="hs-identifier">defunInfo</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DTyConI</span><span> </span><a name="local-6989586621679185246"><a href="#local-6989586621679185246"><span class="hs-identifier">dec</span></a></a><span> </span><a name="local-6989586621679185247"><a href="#local-6989586621679185247"><span class="hs-identifier">_instances</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Promote.Defun.html#buildDefunSyms"><span class="hs-identifier hs-var">buildDefunSyms</span></a><span> </span><a href="#local-6989586621679185246"><span class="hs-identifier hs-var">dec</span></a><span>
</span><a name="line-28"></a><span class="hs-identifier">defunInfo</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DPrimTyConI</span><span> </span><a name="local-6989586621679185248"><a href="#local-6989586621679185248"><span class="hs-identifier">_name</span></a></a><span> </span><a name="local-6989586621679185249"><a href="#local-6989586621679185249"><span class="hs-identifier">_numArgs</span></a></a><span> </span><a name="local-6989586621679185250"><a href="#local-6989586621679185250"><span class="hs-identifier">_unlifted</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-29"></a><span>  </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Building defunctionalization symbols of primitive &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-30"></a><span>         </span><span class="hs-string">&quot;type constructors not supported&quot;</span><span>
</span><a name="line-31"></a><span class="hs-identifier">defunInfo</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DVarI</span><span> </span><a name="local-6989586621679185251"><a href="#local-6989586621679185251"><span class="hs-identifier">_name</span></a></a><span> </span><a name="local-6989586621679185252"><a href="#local-6989586621679185252"><span class="hs-identifier">_ty</span></a></a><span> </span><a name="local-6989586621679185253"><a href="#local-6989586621679185253"><span class="hs-identifier">_mdec</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-32"></a><span>  </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-string">&quot;Building defunctionalization symbols of values not supported&quot;</span><span>
</span><a name="line-33"></a><span class="hs-identifier">defunInfo</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DTyVarI</span><span> </span><a name="local-6989586621679185254"><a href="#local-6989586621679185254"><span class="hs-identifier">_name</span></a></a><span> </span><a name="local-6989586621679185255"><a href="#local-6989586621679185255"><span class="hs-identifier">_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-34"></a><span>  </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-string">&quot;Building defunctionalization symbols of type variables not supported&quot;</span><span>
</span><a name="line-35"></a><span class="hs-identifier">defunInfo</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DPatSynI</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-36"></a><span>  </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-string">&quot;Building defunctionalization symbols of pattern synonyms not supported&quot;</span><span>
</span><a name="line-37"></a><span>
</span><a name="line-38"></a><span class="hs-identifier">defunTypeDecls</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Data.Singletons.Syntax.html#TySynDecl"><span class="hs-identifier hs-type">TySynDecl</span></a><span class="hs-special">]</span><span>
</span><a name="line-39"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Data.Singletons.Syntax.html#ClosedTypeFamilyDecl"><span class="hs-identifier hs-type">ClosedTypeFamilyDecl</span></a><span class="hs-special">]</span><span>
</span><a name="line-40"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Data.Singletons.Syntax.html#OpenTypeFamilyDecl"><span class="hs-identifier hs-type">OpenTypeFamilyDecl</span></a><span class="hs-special">]</span><span>
</span><a name="line-41"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-42"></a><a name="defunTypeDecls"><a href="Data.Singletons.Promote.Defun.html#defunTypeDecls"><span class="hs-identifier">defunTypeDecls</span></a></a><span> </span><a name="local-6989586621679185256"><a href="#local-6989586621679185256"><span class="hs-identifier">ty_syns</span></a></a><span> </span><a name="local-6989586621679185257"><a href="#local-6989586621679185257"><span class="hs-identifier">c_tyfams</span></a></a><span> </span><a name="local-6989586621679185258"><a href="#local-6989586621679185258"><span class="hs-identifier">o_tyfams</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-43"></a><span>  </span><a name="local-6989586621679185261"><a href="#local-6989586621679185261"><span class="hs-identifier">defun_ty_syns</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-44"></a><span>    </span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a href="Data.Singletons.Syntax.html#TySynDecl"><span class="hs-identifier hs-var">TySynDecl</span></a><span> </span><a name="local-6989586621679185259"><a href="#local-6989586621679185259"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621679185260"><a href="#local-6989586621679185260"><span class="hs-identifier">tvbs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Promote.Defun.html#buildDefunSymsTySynD"><span class="hs-identifier hs-var">buildDefunSymsTySynD</span></a><span> </span><a href="#local-6989586621679185259"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679185260"><span class="hs-identifier hs-var">tvbs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679185256"><span class="hs-identifier hs-var">ty_syns</span></a><span>
</span><a name="line-45"></a><span>  </span><a name="local-6989586621679185262"><a href="#local-6989586621679185262"><span class="hs-identifier">defun_c_tyfams</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-46"></a><span>    </span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Promote.Defun.html#buildDefunSymsClosedTypeFamilyD"><span class="hs-identifier hs-var">buildDefunSymsClosedTypeFamilyD</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">getTypeFamilyDecl</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679185257"><span class="hs-identifier hs-var">c_tyfams</span></a><span>
</span><a name="line-47"></a><span>  </span><a name="local-6989586621679185263"><a href="#local-6989586621679185263"><span class="hs-identifier">defun_o_tyfams</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-48"></a><span>    </span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Promote.Defun.html#buildDefunSymsOpenTypeFamilyD"><span class="hs-identifier hs-var">buildDefunSymsOpenTypeFamilyD</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">getTypeFamilyDecl</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679185258"><span class="hs-identifier hs-var">o_tyfams</span></a><span>
</span><a name="line-49"></a><span>  </span><a href="Data.Singletons.Promote.Monad.html#emitDecs"><span class="hs-identifier hs-var">emitDecs</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679185261"><span class="hs-identifier hs-var">defun_ty_syns</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679185262"><span class="hs-identifier hs-var">defun_c_tyfams</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679185263"><span class="hs-identifier hs-var">defun_o_tyfams</span></a><span>
</span><a name="line-50"></a><span>
</span><a name="line-51"></a><span class="hs-identifier">buildDefunSyms</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DDec</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DDec</span><span class="hs-special">]</span><span>
</span><a name="line-52"></a><a name="buildDefunSyms"><a href="Data.Singletons.Promote.Defun.html#buildDefunSyms"><span class="hs-identifier">buildDefunSyms</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DDataD</span><span> </span><a name="local-6989586621679185264"><a href="#local-6989586621679185264"><span class="hs-identifier">_new_or_data</span></a></a><span> </span><a name="local-6989586621679185265"><a href="#local-6989586621679185265"><span class="hs-identifier">_cxt</span></a></a><span> </span><a name="local-6989586621679185266"><a href="#local-6989586621679185266"><span class="hs-identifier">_tyName</span></a></a><span> </span><a name="local-6989586621679185267"><a href="#local-6989586621679185267"><span class="hs-identifier">_tvbs</span></a></a><span> </span><a name="local-6989586621679185268"><a href="#local-6989586621679185268"><span class="hs-identifier">_k</span></a></a><span> </span><a name="local-6989586621679185269"><a href="#local-6989586621679185269"><span class="hs-identifier">ctors</span></a></a><span> </span><a name="local-6989586621679185270"><a href="#local-6989586621679185270"><span class="hs-identifier">_derivings</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-53"></a><span>  </span><a href="Data.Singletons.Promote.Defun.html#buildDefunSymsDataD"><span class="hs-identifier hs-var">buildDefunSymsDataD</span></a><span> </span><a href="#local-6989586621679185269"><span class="hs-identifier hs-var">ctors</span></a><span>
</span><a name="line-54"></a><span class="hs-identifier">buildDefunSyms</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DClosedTypeFamilyD</span><span> </span><a name="local-6989586621679185271"><a href="#local-6989586621679185271"><span class="hs-identifier">tf_head</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-55"></a><span>  </span><a href="Data.Singletons.Promote.Defun.html#buildDefunSymsClosedTypeFamilyD"><span class="hs-identifier hs-var">buildDefunSymsClosedTypeFamilyD</span></a><span> </span><a href="#local-6989586621679185271"><span class="hs-identifier hs-var">tf_head</span></a><span>
</span><a name="line-56"></a><span class="hs-identifier">buildDefunSyms</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DOpenTypeFamilyD</span><span> </span><a name="local-6989586621679185272"><a href="#local-6989586621679185272"><span class="hs-identifier">tf_head</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-57"></a><span>  </span><a href="Data.Singletons.Promote.Defun.html#buildDefunSymsOpenTypeFamilyD"><span class="hs-identifier hs-var">buildDefunSymsOpenTypeFamilyD</span></a><span> </span><a href="#local-6989586621679185272"><span class="hs-identifier hs-var">tf_head</span></a><span>
</span><a name="line-58"></a><span class="hs-identifier">buildDefunSyms</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DTySynD</span><span> </span><a name="local-6989586621679185273"><a href="#local-6989586621679185273"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621679185274"><a href="#local-6989586621679185274"><span class="hs-identifier">tvbs</span></a></a><span> </span><a name="local-6989586621679185275"><a href="#local-6989586621679185275"><span class="hs-identifier">_type</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-59"></a><span>  </span><a href="Data.Singletons.Promote.Defun.html#buildDefunSymsTySynD"><span class="hs-identifier hs-var">buildDefunSymsTySynD</span></a><span> </span><a href="#local-6989586621679185273"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679185274"><span class="hs-identifier hs-var">tvbs</span></a><span>
</span><a name="line-60"></a><span class="hs-identifier">buildDefunSyms</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DClassD</span><span> </span><a name="local-6989586621679185276"><a href="#local-6989586621679185276"><span class="hs-identifier">_cxt</span></a></a><span> </span><a name="local-6989586621679185277"><a href="#local-6989586621679185277"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621679185278"><a href="#local-6989586621679185278"><span class="hs-identifier">tvbs</span></a></a><span> </span><a name="local-6989586621679185279"><a href="#local-6989586621679185279"><span class="hs-identifier">_fundeps</span></a></a><span> </span><a name="local-6989586621679185280"><a href="#local-6989586621679185280"><span class="hs-identifier">_members</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-61"></a><span>  </span><a href="Data.Singletons.Promote.Defun.html#defunReifyFixity"><span class="hs-identifier hs-var">defunReifyFixity</span></a><span> </span><a href="#local-6989586621679185277"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679185278"><span class="hs-identifier hs-var">tvbs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DConT</span><span> </span><a href="Data.Singletons.Names.html#constraintName"><span class="hs-identifier hs-var">constraintName</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-62"></a><span class="hs-identifier">buildDefunSyms</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Defunctionalization symbols can only be built for &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-63"></a><span>                          </span><span class="hs-string">&quot;type families and data declarations&quot;</span><span>
</span><a name="line-64"></a><span>
</span><a name="line-65"></a><span class="hs-identifier">buildDefunSymsClosedTypeFamilyD</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DTypeFamilyHead</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DDec</span><span class="hs-special">]</span><span>
</span><a name="line-66"></a><a name="buildDefunSymsClosedTypeFamilyD"><a href="Data.Singletons.Promote.Defun.html#buildDefunSymsClosedTypeFamilyD"><span class="hs-identifier">buildDefunSymsClosedTypeFamilyD</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Promote.Defun.html#buildDefunSymsTypeFamilyHead"><span class="hs-identifier hs-var">buildDefunSymsTypeFamilyHead</span></a><span> </span><span class="hs-identifier hs-var">id</span><span> </span><span class="hs-identifier hs-var">id</span><span>
</span><a name="line-67"></a><span>
</span><a name="line-68"></a><span class="hs-identifier">buildDefunSymsOpenTypeFamilyD</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DTypeFamilyHead</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DDec</span><span class="hs-special">]</span><span>
</span><a name="line-69"></a><a name="buildDefunSymsOpenTypeFamilyD"><a href="Data.Singletons.Promote.Defun.html#buildDefunSymsOpenTypeFamilyD"><span class="hs-identifier">buildDefunSymsOpenTypeFamilyD</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Promote.Defun.html#buildDefunSymsTypeFamilyHead"><span class="hs-identifier hs-var">buildDefunSymsTypeFamilyHead</span></a><span> </span><a href="Data.Singletons.Util.html#cuskify"><span class="hs-identifier hs-var">cuskify</span></a><span> </span><a href="#local-6989586621679185281"><span class="hs-identifier hs-var">default_to_star</span></a><span>
</span><a name="line-70"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-71"></a><span>    </span><span class="hs-identifier">default_to_star</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">DKind</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">DKind</span><span>
</span><a name="line-72"></a><span>    </span><a name="local-6989586621679185281"><a href="#local-6989586621679185281"><span class="hs-identifier">default_to_star</span></a></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">DConT</span><span> </span><span class="hs-identifier hs-var">typeKindName</span><span>
</span><a name="line-73"></a><span>    </span><span class="hs-identifier">default_to_star</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679185282"><a href="#local-6989586621679185282"><span class="hs-identifier">k</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679185282"><span class="hs-identifier hs-var">k</span></a><span>
</span><a name="line-74"></a><span>
</span><a name="line-75"></a><span class="hs-identifier">buildDefunSymsTypeFamilyHead</span><span>
</span><a name="line-76"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DTyVarBndr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DTyVarBndr</span><span class="hs-special">)</span><span>
</span><a name="line-77"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">DKind</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">DKind</span><span class="hs-special">)</span><span>
</span><a name="line-78"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DTypeFamilyHead</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DDec</span><span class="hs-special">]</span><span>
</span><a name="line-79"></a><a name="buildDefunSymsTypeFamilyHead"><a href="Data.Singletons.Promote.Defun.html#buildDefunSymsTypeFamilyHead"><span class="hs-identifier">buildDefunSymsTypeFamilyHead</span></a></a><span> </span><a name="local-6989586621679185283"><a href="#local-6989586621679185283"><span class="hs-identifier">default_tvb</span></a></a><span> </span><a name="local-6989586621679185284"><a href="#local-6989586621679185284"><span class="hs-identifier">default_kind</span></a></a><span>
</span><a name="line-80"></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DTypeFamilyHead</span><span> </span><a name="local-6989586621679185285"><a href="#local-6989586621679185285"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621679185286"><a href="#local-6989586621679185286"><span class="hs-identifier">tvbs</span></a></a><span> </span><a name="local-6989586621679185287"><a href="#local-6989586621679185287"><span class="hs-identifier">result_sig</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-81"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679185288"><a href="#local-6989586621679185288"><span class="hs-identifier">arg_tvbs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621679185283"><span class="hs-identifier hs-var">default_tvb</span></a><span> </span><a href="#local-6989586621679185286"><span class="hs-identifier hs-var">tvbs</span></a><span>
</span><a name="line-82"></a><span>      </span><a name="local-6989586621679185289"><a href="#local-6989586621679185289"><span class="hs-identifier">res_kind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679185284"><span class="hs-identifier hs-var">default_kind</span></a><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Util.html#resultSigToMaybeKind"><span class="hs-identifier hs-var">resultSigToMaybeKind</span></a><span> </span><a href="#local-6989586621679185287"><span class="hs-identifier hs-var">result_sig</span></a><span class="hs-special">)</span><span>
</span><a name="line-83"></a><span>  </span><a href="Data.Singletons.Promote.Defun.html#defunReifyFixity"><span class="hs-identifier hs-var">defunReifyFixity</span></a><span> </span><a href="#local-6989586621679185285"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679185288"><span class="hs-identifier hs-var">arg_tvbs</span></a><span> </span><a href="#local-6989586621679185289"><span class="hs-identifier hs-var">res_kind</span></a><span>
</span><a name="line-84"></a><span>
</span><a name="line-85"></a><span class="hs-identifier">buildDefunSymsTySynD</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DTyVarBndr</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DDec</span><span class="hs-special">]</span><span>
</span><a name="line-86"></a><a name="buildDefunSymsTySynD"><a href="Data.Singletons.Promote.Defun.html#buildDefunSymsTySynD"><span class="hs-identifier">buildDefunSymsTySynD</span></a></a><span> </span><a name="local-6989586621679185290"><a href="#local-6989586621679185290"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621679185291"><a href="#local-6989586621679185291"><span class="hs-identifier">tvbs</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-87"></a><span>  </span><a href="Data.Singletons.Promote.Defun.html#defunReifyFixity"><span class="hs-identifier hs-var">defunReifyFixity</span></a><span> </span><a href="#local-6989586621679185290"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679185291"><span class="hs-identifier hs-var">tvbs</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-88"></a><span>
</span><a name="line-89"></a><span class="hs-identifier">buildDefunSymsDataD</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DCon</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DDec</span><span class="hs-special">]</span><span>
</span><a name="line-90"></a><a name="buildDefunSymsDataD"><a href="Data.Singletons.Promote.Defun.html#buildDefunSymsDataD"><span class="hs-identifier">buildDefunSymsDataD</span></a></a><span> </span><a name="local-6989586621679185292"><a href="#local-6989586621679185292"><span class="hs-identifier">ctors</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-91"></a><span>  </span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a><span> </span><a href="#local-6989586621679185293"><span class="hs-identifier hs-var">promoteCtor</span></a><span> </span><a href="#local-6989586621679185292"><span class="hs-identifier hs-var">ctors</span></a><span>
</span><a name="line-92"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-93"></a><span>    </span><span class="hs-identifier">promoteCtor</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DDec</span><span class="hs-special">]</span><span>
</span><a name="line-94"></a><span>    </span><a name="local-6989586621679185293"><a href="#local-6989586621679185293"><span class="hs-identifier">promoteCtor</span></a></a><span> </span><a name="local-6989586621679185294"><a href="#local-6989586621679185294"><span class="hs-identifier">ctor</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">DCon</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679185295"><a href="#local-6989586621679185295"><span class="hs-identifier">res_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-95"></a><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679185296"><a href="#local-6989586621679185296"><span class="hs-identifier">name</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679185297"><a href="#local-6989586621679185297"><span class="hs-identifier">arg_tys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Util.html#extractNameTypes"><span class="hs-identifier hs-var">extractNameTypes</span></a><span> </span><a href="#local-6989586621679185294"><span class="hs-identifier hs-var">ctor</span></a><span>
</span><a name="line-96"></a><span>      </span><a name="local-6989586621679185298"><a href="#local-6989586621679185298"><span class="hs-identifier">tvb_names</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">replicateM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679185297"><span class="hs-identifier hs-var">arg_tys</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">qNewName</span><span> </span><span class="hs-string">&quot;t&quot;</span><span>
</span><a name="line-97"></a><span>      </span><a name="local-6989586621679185299"><a href="#local-6989586621679185299"><span class="hs-identifier">arg_kis</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="Data.Singletons.Promote.Type.html#promoteType"><span class="hs-identifier hs-var">promoteType</span></a><span> </span><a href="#local-6989586621679185297"><span class="hs-identifier hs-var">arg_tys</span></a><span>
</span><a name="line-98"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679185300"><a href="#local-6989586621679185300"><span class="hs-identifier">arg_tvbs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">zipWith</span><span> </span><span class="hs-identifier hs-var">DKindedTV</span><span> </span><a href="#local-6989586621679185298"><span class="hs-identifier hs-var">tvb_names</span></a><span> </span><a href="#local-6989586621679185299"><span class="hs-identifier hs-var">arg_kis</span></a><span>
</span><a name="line-99"></a><span>      </span><a name="local-6989586621679185301"><a href="#local-6989586621679185301"><span class="hs-identifier">res_ki</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Promote.Type.html#promoteType"><span class="hs-identifier hs-var">promoteType</span></a><span> </span><a href="#local-6989586621679185295"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-100"></a><span>      </span><a href="Data.Singletons.Promote.Defun.html#defunReifyFixity"><span class="hs-identifier hs-var">defunReifyFixity</span></a><span> </span><a href="#local-6989586621679185296"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679185300"><span class="hs-identifier hs-var">arg_tvbs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679185301"><span class="hs-identifier hs-var">res_ki</span></a><span class="hs-special">)</span><span>
</span><a name="line-101"></a><span>
</span><a name="line-102"></a><span class="hs-comment">-- Generate defunctionalization symbols for a name, using reifyFixityWithLocals</span><span>
</span><a name="line-103"></a><span class="hs-comment">-- to determine what the fixity of each symbol should be.</span><span>
</span><a name="line-104"></a><span class="hs-comment">-- See Note [Fixity declarations for defunctionalization symbols]</span><span>
</span><a name="line-105"></a><span class="hs-identifier">defunReifyFixity</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DTyVarBndr</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">DKind</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DDec</span><span class="hs-special">]</span><span>
</span><a name="line-106"></a><a name="defunReifyFixity"><a href="Data.Singletons.Promote.Defun.html#defunReifyFixity"><span class="hs-identifier">defunReifyFixity</span></a></a><span> </span><a name="local-6989586621679185302"><a href="#local-6989586621679185302"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621679185303"><a href="#local-6989586621679185303"><span class="hs-identifier">tvbs</span></a></a><span> </span><a name="local-6989586621679185304"><a href="#local-6989586621679185304"><span class="hs-identifier">m_res_kind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-107"></a><span>  </span><a name="local-6989586621679185305"><a href="#local-6989586621679185305"><span class="hs-identifier">m_fixity</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">reifyFixityWithLocals</span><span> </span><a href="#local-6989586621679185302"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-108"></a><span>  </span><a href="Data.Singletons.Promote.Defun.html#defunctionalize"><span class="hs-identifier hs-var">defunctionalize</span></a><span> </span><a href="#local-6989586621679185302"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679185305"><span class="hs-identifier hs-var">m_fixity</span></a><span> </span><a href="#local-6989586621679185303"><span class="hs-identifier hs-var">tvbs</span></a><span> </span><a href="#local-6989586621679185304"><span class="hs-identifier hs-var">m_res_kind</span></a><span>
</span><a name="line-109"></a><span>
</span><a name="line-110"></a><span class="hs-comment">-- Generate data declarations and apply instances</span><span>
</span><a name="line-111"></a><span class="hs-comment">-- required for defunctionalization.</span><span>
</span><a name="line-112"></a><span class="hs-comment">-- For a type family:</span><span>
</span><a name="line-113"></a><span class="hs-comment">--</span><span>
</span><a name="line-114"></a><span class="hs-comment">-- type family Foo (m :: Nat) (n :: Nat) (l :: Nat) :: Nat</span><span>
</span><a name="line-115"></a><span class="hs-comment">--</span><span>
</span><a name="line-116"></a><span class="hs-comment">-- we generate data declarations that allow us to talk about partial</span><span>
</span><a name="line-117"></a><span class="hs-comment">-- application at the type level:</span><span>
</span><a name="line-118"></a><span class="hs-comment">--</span><span>
</span><a name="line-119"></a><span class="hs-comment">-- type FooSym3 a b c = Foo a b c</span><span>
</span><a name="line-120"></a><span class="hs-comment">-- data FooSym2 a b f where</span><span>
</span><a name="line-121"></a><span class="hs-comment">--   FooSym2KindInference :: SameKind (Apply (FooSym2 a b) arg) (FooSym3 a b arg)</span><span>
</span><a name="line-122"></a><span class="hs-comment">--                        =&gt; FooSym2 a b f</span><span>
</span><a name="line-123"></a><span class="hs-comment">-- type instance Apply (FooSym2 a b) c = FooSym3 a b c</span><span>
</span><a name="line-124"></a><span class="hs-comment">-- data FooSym1 a f where</span><span>
</span><a name="line-125"></a><span class="hs-comment">--   FooSym1KindInference :: SameKind (Apply (FooSym1 a) arg) (FooSym2 a arg)</span><span>
</span><a name="line-126"></a><span class="hs-comment">--                        =&gt; FooSym1 a f</span><span>
</span><a name="line-127"></a><span class="hs-comment">-- type instance Apply (FooSym1 a) b = FooSym2 a b</span><span>
</span><a name="line-128"></a><span class="hs-comment">-- data FooSym0 f where</span><span>
</span><a name="line-129"></a><span class="hs-comment">--  FooSym0KindInference :: SameKind (Apply FooSym0 arg) (FooSym1 arg)</span><span>
</span><a name="line-130"></a><span class="hs-comment">--                       =&gt; FooSym0 f</span><span>
</span><a name="line-131"></a><span class="hs-comment">-- type instance Apply FooSym0 a = FooSym1 a</span><span>
</span><a name="line-132"></a><span class="hs-comment">--</span><span>
</span><a name="line-133"></a><span class="hs-comment">-- What's up with all the &quot;KindInference&quot; stuff? In some scenarios, we don't</span><span>
</span><a name="line-134"></a><span class="hs-comment">-- know the kinds that we should be using in these symbols. But, GHC can figure</span><span>
</span><a name="line-135"></a><span class="hs-comment">-- it out using the types of the &quot;KindInference&quot; dummy data constructors. A</span><span>
</span><a name="line-136"></a><span class="hs-comment">-- bit of a hack, but it works quite nicely. The only problem is that GHC will</span><span>
</span><a name="line-137"></a><span class="hs-comment">-- warn about an unused data constructor. So, we use the data constructor in</span><span>
</span><a name="line-138"></a><span class="hs-comment">-- an instance of a dummy class. (See Data.Singletons.SuppressUnusedWarnings</span><span>
</span><a name="line-139"></a><span class="hs-comment">-- for the class, which should never be seen by anyone, ever.)</span><span>
</span><a name="line-140"></a><span class="hs-comment">--</span><span>
</span><a name="line-141"></a><span class="hs-comment">-- The defunctionalize function takes Maybe DKinds so that the caller can</span><span>
</span><a name="line-142"></a><span class="hs-comment">-- indicate which kinds are known and which need to be inferred.</span><span>
</span><a name="line-143"></a><span class="hs-comment">--</span><span>
</span><a name="line-144"></a><span class="hs-comment">-- See also Note [Defunctionalization and dependent quantification]</span><span>
</span><a name="line-145"></a><span class="hs-identifier">defunctionalize</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-146"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Fixity</span><span> </span><span class="hs-comment">-- The name's fixity, if one was declared.</span><span>
</span><a name="line-147"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DTyVarBndr</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">DKind</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DDec</span><span class="hs-special">]</span><span>
</span><a name="line-148"></a><a name="defunctionalize"><a href="Data.Singletons.Promote.Defun.html#defunctionalize"><span class="hs-identifier">defunctionalize</span></a></a><span> </span><a name="local-6989586621679185306"><a href="#local-6989586621679185306"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621679185307"><a href="#local-6989586621679185307"><span class="hs-identifier">m_fixity</span></a></a><span> </span><a name="local-6989586621679185308"><a href="#local-6989586621679185308"><span class="hs-identifier">m_arg_tvbs'</span></a></a><span> </span><a name="local-6989586621679185309"><a href="#local-6989586621679185309"><span class="hs-identifier">m_res_kind'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-149"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679185327"><a href="#local-6989586621679185327"><span class="hs-identifier">m_arg_tvbs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679185328"><a href="#local-6989586621679185328"><span class="hs-identifier">m_res_kind</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679185311"><span class="hs-identifier hs-var">eta_expand</span></a><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Util.html#noExactTyVars"><span class="hs-identifier hs-var">noExactTyVars</span></a><span> </span><a href="#local-6989586621679185308"><span class="hs-identifier hs-var">m_arg_tvbs'</span></a><span class="hs-special">)</span><span>
</span><a name="line-150"></a><span>                                         </span><span class="hs-special">(</span><a href="Data.Singletons.Util.html#noExactTyVars"><span class="hs-identifier hs-var">noExactTyVars</span></a><span> </span><a href="#local-6989586621679185309"><span class="hs-identifier hs-var">m_res_kind'</span></a><span class="hs-special">)</span><span>
</span><a name="line-151"></a><span>
</span><a name="line-152"></a><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- Implements part (2)(i) from Note [Defunctionalization and dependent quantification]</span><span>
</span><a name="line-153"></a><span>      </span><span class="hs-identifier">tvb_to_type_map</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-identifier hs-type">DType</span><span>
</span><a name="line-154"></a><span>      </span><a name="local-6989586621679185329"><a href="#local-6989586621679185329"><span class="hs-identifier">tvb_to_type_map</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.fromList</span><span> </span><span class="hs-operator hs-var">$</span><span>                   </span><span class="hs-comment">-- (2)(i)(c)</span><span>
</span><a name="line-155"></a><span>                        </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679185331"><a href="#local-6989586621679185331"><span class="hs-identifier">tvb</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Util.html#extractTvbName"><span class="hs-identifier hs-var">extractTvbName</span></a><span> </span><a href="#local-6989586621679185331"><span class="hs-identifier hs-var">tvb</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">dTyVarBndrToDType</span><span> </span><a href="#local-6989586621679185331"><span class="hs-identifier hs-var">tvb</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-156"></a><span>                        </span><span class="hs-identifier hs-var">toposortTyVarsOf</span><span> </span><span class="hs-operator hs-var">$</span><span>               </span><span class="hs-comment">-- (2)(i)(b)</span><span>
</span><a name="line-157"></a><span>                        </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">dTyVarBndrToDType</span><span> </span><a href="#local-6989586621679185327"><span class="hs-identifier hs-var">m_arg_tvbs</span></a><span>
</span><a name="line-158"></a><span>                          </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">maybeToList</span><span> </span><a href="#local-6989586621679185328"><span class="hs-identifier hs-var">m_res_kind</span></a><span>      </span><span class="hs-comment">-- (2)(i)(a)</span><span>
</span><a name="line-159"></a><span>
</span><a name="line-160"></a><span>      </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DTyVarBndr</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">DKind</span><span>
</span><a name="line-161"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">DTyVarBndr</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DType</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- given the argument tyvar binders,</span><span>
</span><a name="line-162"></a><span>                                     </span><span class="hs-comment">-- produce the RHS of the Apply instance</span><span>
</span><a name="line-163"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DDec</span><span class="hs-special">]</span><span>
</span><a name="line-164"></a><span>      </span><a name="local-6989586621679185330"><a href="#local-6989586621679185330"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-165"></a><span>      </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621679185332"><a href="#local-6989586621679185332"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679185333"><a href="#local-6989586621679185333"><span class="hs-identifier">m_arg</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621679185334"><a href="#local-6989586621679185334"><span class="hs-identifier">m_args</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679185335"><a href="#local-6989586621679185335"><span class="hs-identifier">m_result</span></a></a><span> </span><a name="local-6989586621679185336"><a href="#local-6989586621679185336"><span class="hs-identifier">mk_rhs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-166"></a><span>        </span><a name="local-6989586621679185337"><a href="#local-6989586621679185337"><span class="hs-identifier">extra_name</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">qNewName</span><span> </span><span class="hs-string">&quot;arg&quot;</span><span>
</span><a name="line-167"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679185338"><a href="#local-6989586621679185338"><span class="hs-identifier">tyfun_name</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Util.html#extractTvbName"><span class="hs-identifier hs-var">extractTvbName</span></a><span> </span><a href="#local-6989586621679185333"><span class="hs-identifier hs-var">m_arg</span></a><span>
</span><a name="line-168"></a><span>            </span><a name="local-6989586621679185339"><a href="#local-6989586621679185339"><span class="hs-identifier">data_name</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Names.html#promoteTySym"><span class="hs-identifier hs-var">promoteTySym</span></a><span> </span><a href="#local-6989586621679185306"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679185332"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-169"></a><span>            </span><a name="local-6989586621679185340"><a href="#local-6989586621679185340"><span class="hs-identifier">next_name</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Names.html#promoteTySym"><span class="hs-identifier hs-var">promoteTySym</span></a><span> </span><a href="#local-6989586621679185306"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679185332"><span class="hs-identifier hs-var">n</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-170"></a><span>            </span><a name="local-6989586621679185341"><a href="#local-6989586621679185341"><span class="hs-identifier">con_name</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Util.html#prefixName"><span class="hs-identifier hs-var">prefixName</span></a><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><span class="hs-string">&quot;:&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Singletons.Util.html#suffixName"><span class="hs-identifier hs-var">suffixName</span></a><span> </span><span class="hs-string">&quot;KindInference&quot;</span><span> </span><span class="hs-string">&quot;###&quot;</span><span> </span><a href="#local-6989586621679185339"><span class="hs-identifier hs-var">data_name</span></a><span>
</span><a name="line-171"></a><span>            </span><a name="local-6989586621679185342"><a href="#local-6989586621679185342"><span class="hs-identifier">m_tyfun</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Promote.Defun.html#buildTyFunArrow_maybe"><span class="hs-identifier hs-var">buildTyFunArrow_maybe</span></a><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Util.html#extractTvbKind"><span class="hs-identifier hs-var">extractTvbKind</span></a><span> </span><a href="#local-6989586621679185333"><span class="hs-identifier hs-var">m_arg</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679185335"><span class="hs-identifier hs-var">m_result</span></a><span>
</span><a name="line-172"></a><span>            </span><a name="local-6989586621679185343"><a href="#local-6989586621679185343"><span class="hs-identifier">arg_params</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- Implements part (2)(ii) from</span><span>
</span><a name="line-173"></a><span>                          </span><span class="hs-comment">-- Note [Defunctionalization and dependent quantification]</span><span>
</span><a name="line-174"></a><span>                          </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679185312"><span class="hs-identifier hs-var">map_tvb_kind</span></a><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Util.html#substType"><span class="hs-identifier hs-var">substType</span></a><span> </span><a href="#local-6989586621679185329"><span class="hs-identifier hs-var">tvb_to_type_map</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-175"></a><span>                          </span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621679185334"><span class="hs-identifier hs-var">m_args</span></a><span>
</span><a name="line-176"></a><span>            </span><a name="local-6989586621679185344"><a href="#local-6989586621679185344"><span class="hs-identifier">tyfun_param</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679185310"><span class="hs-identifier hs-var">mk_tvb</span></a><span> </span><a href="#local-6989586621679185338"><span class="hs-identifier hs-var">tyfun_name</span></a><span> </span><a href="#local-6989586621679185342"><span class="hs-identifier hs-var">m_tyfun</span></a><span>
</span><a name="line-177"></a><span>            </span><a name="local-6989586621679185345"><a href="#local-6989586621679185345"><span class="hs-identifier">arg_names</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="Data.Singletons.Util.html#extractTvbName"><span class="hs-identifier hs-var">extractTvbName</span></a><span> </span><a href="#local-6989586621679185343"><span class="hs-identifier hs-var">arg_params</span></a><span>
</span><a name="line-178"></a><span>            </span><a name="local-6989586621679185346"><a href="#local-6989586621679185346"><span class="hs-identifier">params</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679185343"><span class="hs-identifier hs-var">arg_params</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679185344"><span class="hs-identifier hs-var">tyfun_param</span></a><span class="hs-special">]</span><span>
</span><a name="line-179"></a><span>            </span><a name="local-6989586621679185347"><a href="#local-6989586621679185347"><span class="hs-identifier">con_eq_ct</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">DConPr</span><span> </span><a href="Data.Singletons.Names.html#sameKindName"><span class="hs-identifier hs-var">sameKindName</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">DAppPr</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679185357"><span class="hs-identifier hs-var">lhs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">DAppPr</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679185358"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-180"></a><span>              </span><span class="hs-keyword">where</span><span>
</span><a name="line-181"></a><span>                </span><a name="local-6989586621679185357"><a href="#local-6989586621679185357"><span class="hs-identifier">lhs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Util.html#foldType"><span class="hs-identifier hs-var">foldType</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DConT</span><span> </span><a href="#local-6989586621679185339"><span class="hs-identifier hs-var">data_name</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">DVarT</span><span> </span><a href="#local-6989586621679185345"><span class="hs-identifier hs-var">arg_names</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><a href="Data.Singletons.Names.html#apply"><span class="hs-identifier hs-var">apply</span></a><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DVarT</span><span> </span><a href="#local-6989586621679185337"><span class="hs-identifier hs-var">extra_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-182"></a><span>                </span><a name="local-6989586621679185358"><a href="#local-6989586621679185358"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Util.html#foldType"><span class="hs-identifier hs-var">foldType</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DConT</span><span> </span><a href="#local-6989586621679185340"><span class="hs-identifier hs-var">next_name</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">DVarT</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679185345"><span class="hs-identifier hs-var">arg_names</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679185337"><span class="hs-identifier hs-var">extra_name</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-183"></a><span>            </span><a name="local-6989586621679185348"><a href="#local-6989586621679185348"><span class="hs-identifier">con_decl</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">DCon</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="Data.Singletons.Promote.Defun.html#dropTvbKind"><span class="hs-identifier hs-var">dropTvbKind</span></a><span> </span><a href="#local-6989586621679185346"><span class="hs-identifier hs-var">params</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">DPlainTV</span><span> </span><a href="#local-6989586621679185337"><span class="hs-identifier hs-var">extra_name</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-184"></a><span>                               </span><span class="hs-special">[</span><a href="#local-6989586621679185347"><span class="hs-identifier hs-var">con_eq_ct</span></a><span class="hs-special">]</span><span>
</span><a name="line-185"></a><span>                               </span><a href="#local-6989586621679185341"><span class="hs-identifier hs-var">con_name</span></a><span>
</span><a name="line-186"></a><span>                               </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DNormalC</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-187"></a><span>                               </span><span class="hs-special">(</span><a href="Data.Singletons.Util.html#foldTypeTvbs"><span class="hs-identifier hs-var">foldTypeTvbs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DConT</span><span> </span><a href="#local-6989586621679185339"><span class="hs-identifier hs-var">data_name</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679185346"><span class="hs-identifier hs-var">params</span></a><span class="hs-special">)</span><span>
</span><a name="line-188"></a><span>            </span><a name="local-6989586621679185349"><a href="#local-6989586621679185349"><span class="hs-identifier">data_decl</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">DDataD</span><span> </span><span class="hs-identifier hs-var">Data</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621679185339"><span class="hs-identifier hs-var">data_name</span></a><span> </span><a href="#local-6989586621679185359"><span class="hs-identifier hs-var">args</span></a><span> </span><a href="#local-6989586621679185360"><span class="hs-identifier hs-var">res_ki</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621679185348"><span class="hs-identifier hs-var">con_decl</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-189"></a><span>              </span><span class="hs-keyword">where</span><span>
</span><a name="line-190"></a><span>                </span><span class="hs-special">(</span><a name="local-6989586621679185359"><a href="#local-6989586621679185359"><span class="hs-identifier">args</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679185360"><a href="#local-6989586621679185360"><span class="hs-identifier">res_ki</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-191"></a><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679185342"><span class="hs-identifier hs-var">m_tyfun</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-192"></a><span>                      </span><span class="hs-identifier hs-var">Nothing</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679185346"><span class="hs-identifier hs-var">params</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span>
</span><a name="line-193"></a><span>                                    </span><span class="hs-comment">-- If we cannot infer the return type, don't bother</span><span>
</span><a name="line-194"></a><span>                                    </span><span class="hs-comment">-- trying to construct an explicit return kind.</span><span>
</span><a name="line-195"></a><span>                      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679185361"><a href="#local-6989586621679185361"><span class="hs-identifier">tyfun</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-196"></a><span>                        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679185362"><a href="#local-6989586621679185362"><span class="hs-identifier">bound_tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Set.fromList</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="Data.Singletons.Util.html#extractTvbName"><span class="hs-identifier hs-var">extractTvbName</span></a><span> </span><a href="#local-6989586621679185343"><span class="hs-identifier hs-var">arg_params</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">Set.union</span><span class="hs-special">`</span><span>
</span><a name="line-197"></a><span>                                        </span><span class="hs-identifier hs-var">foldMap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">foldMap</span><span> </span><span class="hs-identifier hs-var">fvDType</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="Data.Singletons.Util.html#extractTvbKind"><span class="hs-identifier hs-var">extractTvbKind</span></a><span> </span><a href="#local-6989586621679185343"><span class="hs-identifier hs-var">arg_params</span></a><span class="hs-special">)</span><span>
</span><a name="line-198"></a><span>                            </span><a name="local-6989586621679185363"><a href="#local-6989586621679185363"><span class="hs-identifier">not_bound</span></a></a><span> </span><a name="local-6989586621679185366"><a href="#local-6989586621679185366"><span class="hs-identifier">tvb</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Util.html#extractTvbName"><span class="hs-identifier hs-var">extractTvbName</span></a><span> </span><a href="#local-6989586621679185366"><span class="hs-identifier hs-var">tvb</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">Set.member</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679185362"><span class="hs-identifier hs-var">bound_tvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-199"></a><span>                            </span><a name="local-6989586621679185364"><a href="#local-6989586621679185364"><span class="hs-identifier">tvb_to_type</span></a></a><span> </span><a name="local-6989586621679185367"><a href="#local-6989586621679185367"><span class="hs-identifier">tvb_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DVarT</span><span> </span><a href="#local-6989586621679185367"><span class="hs-identifier hs-var">tvb_name</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-200"></a><span>                                                   </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><a href="#local-6989586621679185367"><span class="hs-identifier hs-var">tvb_name</span></a><span> </span><a href="#local-6989586621679185329"><span class="hs-identifier hs-var">tvb_to_type_map</span></a><span>
</span><a name="line-201"></a><span>                            </span><span class="hs-comment">-- Implements part (2)(iii) from</span><span>
</span><a name="line-202"></a><span>                            </span><span class="hs-comment">-- Note [Defunctionalization and dependent quantification]</span><span>
</span><a name="line-203"></a><span>                            </span><a name="local-6989586621679185365"><a href="#local-6989586621679185365"><span class="hs-identifier">tyfun_tvbs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><a href="#local-6989586621679185363"><span class="hs-identifier hs-var">not_bound</span></a><span> </span><span class="hs-operator hs-var">$</span><span>         </span><span class="hs-comment">-- (2)(iii)(d)</span><span>
</span><a name="line-204"></a><span>                                         </span><span class="hs-identifier hs-var">toposortTyVarsOf</span><span> </span><span class="hs-operator hs-var">$</span><span>         </span><span class="hs-comment">-- (2)(iii)(c)</span><span>
</span><a name="line-205"></a><span>                                         </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621679185364"><span class="hs-identifier hs-var">tvb_to_type</span></a><span> </span><span class="hs-operator hs-var">$</span><span>          </span><span class="hs-comment">-- (2)(iii)(b)</span><span>
</span><a name="line-206"></a><span>                                         </span><span class="hs-identifier hs-var">Set.toList</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">fvDType</span><span> </span><a href="#local-6989586621679185361"><span class="hs-identifier hs-var">tyfun</span></a><span> </span><span class="hs-comment">-- (2)(iii)(a)</span><span>
</span><a name="line-207"></a><span>                        </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679185343"><span class="hs-identifier hs-var">arg_params</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DForallT</span><span> </span><a href="#local-6989586621679185365"><span class="hs-identifier hs-var">tyfun_tvbs</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621679185361"><span class="hs-identifier hs-var">tyfun</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-208"></a><span>            </span><a name="local-6989586621679185350"><a href="#local-6989586621679185350"><span class="hs-identifier">app_data_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Util.html#foldTypeTvbs"><span class="hs-identifier hs-var">foldTypeTvbs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DConT</span><span> </span><a href="#local-6989586621679185339"><span class="hs-identifier hs-var">data_name</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679185334"><span class="hs-identifier hs-var">m_args</span></a><span>
</span><a name="line-209"></a><span>            </span><a name="local-6989586621679185351"><a href="#local-6989586621679185351"><span class="hs-identifier">app_eqn</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">DTySynEqn</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679185350"><span class="hs-identifier hs-var">app_data_ty</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">DVarT</span><span> </span><a href="#local-6989586621679185338"><span class="hs-identifier hs-var">tyfun_name</span></a><span class="hs-special">]</span><span>
</span><a name="line-210"></a><span>                                    </span><span class="hs-special">(</span><a href="#local-6989586621679185336"><span class="hs-identifier hs-var">mk_rhs</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679185334"><span class="hs-identifier hs-var">m_args</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">DPlainTV</span><span> </span><a href="#local-6989586621679185338"><span class="hs-identifier hs-var">tyfun_name</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-211"></a><span>            </span><a name="local-6989586621679185352"><a href="#local-6989586621679185352"><span class="hs-identifier">app_decl</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">DTySynInstD</span><span> </span><a href="Data.Singletons.Names.html#applyName"><span class="hs-identifier hs-var">applyName</span></a><span> </span><a href="#local-6989586621679185351"><span class="hs-identifier hs-var">app_eqn</span></a><span>
</span><a name="line-212"></a><span>            </span><a name="local-6989586621679185353"><a href="#local-6989586621679185353"><span class="hs-identifier">suppress</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">DInstanceD</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-213"></a><span>                            </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DConT</span><span> </span><a href="Data.Singletons.Names.html#suppressClassName"><span class="hs-identifier hs-var">suppressClassName</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">DAppT</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679185350"><span class="hs-identifier hs-var">app_data_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-214"></a><span>                            </span><span class="hs-special">[</span><span class="hs-identifier hs-var">DLetDec</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">DFunD</span><span> </span><a href="Data.Singletons.Names.html#suppressMethodName"><span class="hs-identifier hs-var">suppressMethodName</span></a><span>
</span><a name="line-215"></a><span>                                             </span><span class="hs-special">[</span><span class="hs-identifier hs-var">DClause</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-216"></a><span>                                                      </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier hs-var">DVarE</span><span> </span><span class="hs-special">'</span><span class="hs-identifier">snd</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">DAppE</span><span class="hs-special">`</span><span>
</span><a name="line-217"></a><span>                                                       </span><span class="hs-identifier hs-var">mkTupleDExp</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">DConE</span><span> </span><a href="#local-6989586621679185341"><span class="hs-identifier hs-var">con_name</span></a><span class="hs-special">,</span><span>
</span><a name="line-218"></a><span>                                                                    </span><span class="hs-identifier hs-var">mkTupleDExp</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-219"></a><span>
</span><a name="line-220"></a><span>            </span><a name="local-6989586621679185354"><a href="#local-6989586621679185354"><span class="hs-identifier">mk_rhs'</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Util.html#foldTypeTvbs"><span class="hs-identifier hs-var">foldTypeTvbs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DConT</span><span> </span><a href="#local-6989586621679185339"><span class="hs-identifier hs-var">data_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-221"></a><span>
</span><a name="line-222"></a><span>            </span><span class="hs-comment">-- See Note [Fixity declarations for defunctionalization symbols]</span><span>
</span><a name="line-223"></a><span>            </span><a name="local-6989586621679185355"><a href="#local-6989586621679185355"><span class="hs-identifier">mk_fix_decl</span></a></a><span> </span><a name="local-6989586621679185368"><a href="#local-6989586621679185368"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">DLetDec</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">DInfixD</span><span> </span><a href="#local-6989586621679185368"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679185339"><span class="hs-identifier hs-var">data_name</span></a><span>
</span><a name="line-224"></a><span>            </span><a name="local-6989586621679185356"><a href="#local-6989586621679185356"><span class="hs-identifier">fixity_decl</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">maybeToList</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><a href="#local-6989586621679185355"><span class="hs-identifier hs-var">mk_fix_decl</span></a><span> </span><a href="#local-6989586621679185307"><span class="hs-identifier hs-var">m_fixity</span></a><span>
</span><a name="line-225"></a><span>
</span><a name="line-226"></a><span>        </span><a name="local-6989586621679185369"><a href="#local-6989586621679185369"><span class="hs-identifier">decls</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679185330"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679185332"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679185334"><span class="hs-identifier hs-var">m_args</span></a><span> </span><a href="#local-6989586621679185342"><span class="hs-identifier hs-var">m_tyfun</span></a><span> </span><a href="#local-6989586621679185354"><span class="hs-identifier hs-var">mk_rhs'</span></a><span>
</span><a name="line-227"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679185353"><span class="hs-identifier hs-var">suppress</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679185349"><span class="hs-identifier hs-var">data_decl</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679185352"><span class="hs-identifier hs-var">app_decl</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679185356"><span class="hs-identifier hs-var">fixity_decl</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679185369"><span class="hs-identifier hs-var">decls</span></a><span>
</span><a name="line-228"></a><span>
</span><a name="line-229"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679185370"><a href="#local-6989586621679185370"><span class="hs-identifier">num_args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679185327"><span class="hs-identifier hs-var">m_arg_tvbs</span></a><span>
</span><a name="line-230"></a><span>      </span><a name="local-6989586621679185371"><a href="#local-6989586621679185371"><span class="hs-identifier">sat_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Names.html#promoteTySym"><span class="hs-identifier hs-var">promoteTySym</span></a><span> </span><a href="#local-6989586621679185306"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679185370"><span class="hs-identifier hs-var">num_args</span></a><span>
</span><a name="line-231"></a><span>      </span><a name="local-6989586621679185372"><a href="#local-6989586621679185372"><span class="hs-identifier">mk_rhs</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Util.html#foldTypeTvbs"><span class="hs-identifier hs-var">foldTypeTvbs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DConT</span><span> </span><a href="#local-6989586621679185306"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-232"></a><span>      </span><a name="local-6989586621679185373"><a href="#local-6989586621679185373"><span class="hs-identifier">sat_dec</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">DTySynD</span><span> </span><a href="#local-6989586621679185371"><span class="hs-identifier hs-var">sat_name</span></a><span> </span><a href="#local-6989586621679185327"><span class="hs-identifier hs-var">m_arg_tvbs</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679185372"><span class="hs-identifier hs-var">mk_rhs</span></a><span> </span><a href="#local-6989586621679185327"><span class="hs-identifier hs-var">m_arg_tvbs</span></a><span class="hs-special">)</span><span>
</span><a name="line-233"></a><span>
</span><a name="line-234"></a><span>  </span><a name="local-6989586621679185374"><a href="#local-6989586621679185374"><span class="hs-identifier">other_decs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679185330"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679185370"><span class="hs-identifier hs-var">num_args</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621679185327"><span class="hs-identifier hs-var">m_arg_tvbs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679185328"><span class="hs-identifier hs-var">m_res_kind</span></a><span> </span><a href="#local-6989586621679185372"><span class="hs-identifier hs-var">mk_rhs</span></a><span>
</span><a name="line-235"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679185373"><span class="hs-identifier hs-var">sat_dec</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679185374"><span class="hs-identifier hs-var">other_decs</span></a><span>
</span><a name="line-236"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-237"></a><span>    </span><span class="hs-identifier">mk_tvb</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">DKind</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DTyVarBndr</span><span>
</span><a name="line-238"></a><span>    </span><a name="local-6989586621679185310"><a href="#local-6989586621679185310"><span class="hs-identifier">mk_tvb</span></a></a><span> </span><a name="local-6989586621679185313"><a href="#local-6989586621679185313"><span class="hs-identifier">tvb_name</span></a></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">DPlainTV</span><span> </span><a href="#local-6989586621679185313"><span class="hs-identifier hs-var">tvb_name</span></a><span>
</span><a name="line-239"></a><span>    </span><span class="hs-identifier">mk_tvb</span><span> </span><a name="local-6989586621679185314"><a href="#local-6989586621679185314"><span class="hs-identifier">tvb_name</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679185315"><a href="#local-6989586621679185315"><span class="hs-identifier">k</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">DKindedTV</span><span> </span><a href="#local-6989586621679185314"><span class="hs-identifier hs-var">tvb_name</span></a><span> </span><a href="#local-6989586621679185315"><span class="hs-identifier hs-var">k</span></a><span>
</span><a name="line-240"></a><span>
</span><a name="line-241"></a><span>    </span><span class="hs-identifier">eta_expand</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DTyVarBndr</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">DKind</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">DTyVarBndr</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">DKind</span><span class="hs-special">)</span><span>
</span><a name="line-242"></a><span>    </span><a name="local-6989586621679185311"><a href="#local-6989586621679185311"><span class="hs-identifier">eta_expand</span></a></a><span> </span><a name="local-6989586621679185316"><a href="#local-6989586621679185316"><span class="hs-identifier">m_arg_tvbs</span></a></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679185316"><span class="hs-identifier hs-var">m_arg_tvbs</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span>
</span><a name="line-243"></a><span>    </span><span class="hs-identifier">eta_expand</span><span> </span><a name="local-6989586621679185317"><a href="#local-6989586621679185317"><span class="hs-identifier">m_arg_tvbs</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679185318"><a href="#local-6989586621679185318"><span class="hs-identifier">res_kind</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-244"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679185319"><a href="#local-6989586621679185319"><span class="hs-identifier">argKs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679185320"><a href="#local-6989586621679185320"><span class="hs-identifier">resultK</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unravel</span><span> </span><a href="#local-6989586621679185318"><span class="hs-identifier hs-var">res_kind</span></a><span>
</span><a name="line-245"></a><span>        </span><a name="local-6989586621679185321"><a href="#local-6989586621679185321"><span class="hs-identifier">tvb_names</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">replicateM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679185319"><span class="hs-identifier hs-var">argKs</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">qNewName</span><span> </span><span class="hs-string">&quot;e&quot;</span><span>
</span><a name="line-246"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679185322"><a href="#local-6989586621679185322"><span class="hs-identifier">res_kind_arg_tvbs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">zipWith</span><span> </span><span class="hs-identifier hs-var">DKindedTV</span><span> </span><a href="#local-6989586621679185321"><span class="hs-identifier hs-var">tvb_names</span></a><span> </span><a href="#local-6989586621679185319"><span class="hs-identifier hs-var">argKs</span></a><span>
</span><a name="line-247"></a><span>        </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679185317"><span class="hs-identifier hs-var">m_arg_tvbs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679185322"><span class="hs-identifier hs-var">res_kind_arg_tvbs</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679185320"><span class="hs-identifier hs-var">resultK</span></a><span class="hs-special">)</span><span>
</span><a name="line-248"></a><span>
</span><a name="line-249"></a><span>    </span><span class="hs-identifier">map_tvb_kind</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DKind</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DKind</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DTyVarBndr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DTyVarBndr</span><span>
</span><a name="line-250"></a><span>    </span><a name="local-6989586621679185312"><a href="#local-6989586621679185312"><span class="hs-identifier">map_tvb_kind</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679185323"><a href="#local-6989586621679185323"><span class="hs-identifier">tvb</span></a></a><span class="hs-glyph">@</span><span class="hs-identifier hs-var">DPlainTV</span><span class="hs-special">{</span><span class="hs-special">}</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679185323"><span class="hs-identifier hs-var">tvb</span></a><span>
</span><a name="line-251"></a><span>    </span><span class="hs-identifier">map_tvb_kind</span><span> </span><a name="local-6989586621679185324"><a href="#local-6989586621679185324"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DKindedTV</span><span> </span><a name="local-6989586621679185325"><a href="#local-6989586621679185325"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679185326"><a href="#local-6989586621679185326"><span class="hs-identifier">k</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">DKindedTV</span><span> </span><a href="#local-6989586621679185325"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679185324"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679185326"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">)</span><span>
</span><a name="line-252"></a><span>
</span><a name="line-253"></a><span class="hs-comment">{-
Note [Defunctionalization and dependent quantification]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The machinery in this module supports defunctionalizing types that use
dependent quantification, such as in the following example:

  type family Symmetry (a :: Proxy t) (y :: Proxy t)
                       (e :: (a :: Proxy (t :: k)) :~: (y :: Proxy (t :: k))) :: Type where
    Symmetry a y _ = y :~: a

Here is what is involved in making this happen:

1. When defunctionalizing, we must not only know the argument kinds, but rather
   the argument *kind variable binders*. This is essential since, for instance,
   Symmetry dependently quantifies `a` and `y` and uses them in the kind of
   `e`. If we did not track the original kind variable names, then instead of
   generating this defunctionalization symbol for Symmetry:

     data SymmetrySym2 (a :: Proxy t) (y :: Proxy t) :: (a :~: y) ~&gt; Type

   We would generate something more general, like this:

     data SymmetrySym2 (abc1 :: Proxy t) (abc2 :: Proxy t) :: (a :~: y) ~&gt; Type

   Alas, there are times where will have no choice but to write a slightly
   more general kind than we should. For instance, consider this:

     data SymmetrySym0 :: Proxy t ~&gt; Proxy t ~&gt; (a :~: y) ~&gt; Type

   This defunctionalization symbol doesn't capture the dependent quantification
   in the first and second argument kinds. But in order to do that properly,
   you'd need the ability to write something like:

     data SymmetrySym0 :: forall (a :: Proxy t) ~&gt; forall (y :: Proxy t)
                       ~&gt; (a :~: y) ~&gt; Type

   It is my (RGS's) belief that it is not possible to achieve something like
   this in today's GHC (see #304), so we'll just have to live with SymmetrySym0
   being slightly more general than it ought to be. In practice, this is
   unlikely to bite unless you're writing code that specifically exploits this
   dependency in just the right way.

2. I pulled a fast one earlier by writing:

     data SymmetrySym0 :: Proxy t ~&gt; Proxy t ~&gt; (a :~: y) ~&gt; Type

   GHC will actually reject this, because it does not have a CUSK. There are
   two glaring problems here:

   (a) The kind of `t` is underdetermined.
   (b) `a` and `y` should have kind `Proxy t`, but this is not currently the case.

   Ultimately, the fix is to use explicit kind signatures. A na&#239;ve attempt
   would be something like this:

     data SymmetrySym0 :: Proxy (t :: (k :: Type)) ~&gt; Proxy (t :: (k :: Type))
                       ~&gt; ((a :: Proxy (t :: (k :: Type))) :~: (y :: Proxy (t :: (k :: Type))))
                       ~&gt; Type

   While that works, it adds a nontrivial amount of clutter. Plus, it requires
   figuring out (in Template Haskell) which variables have underdetermined
   kinds and substituting for them. Blegh. A much cleaner approach is:

     data SymmetrySym0 :: forall (k :: Type) (t :: k) (a :: Proxy t) (y :: Proxy t).
                          Proxy t ~&gt; Proxy t ~&gt; (a :~: y) ~&gt; Type

   This time, all we have to do is put an explicit `forall` in front, and we
   achieve a CUSK without having to muck up the body of return kind. It also
   has the benefit of looking much nicer in generated code.

   Let's talk about how to achieve this feat, using SymmetrySym1 as the
   guiding example:

   (i) Before we begin defunctionalizing a type, we construct a mapping from
       variable names to their corresponding types, complete with kinds.
       For instance, in Symmetry, we would have the following map:

         { k :-&gt; DVarT k                                         -- k
         , t :-&gt; DSigT (DVarT t) (DVarT k)                       -- (t :: k)
         , a :-&gt; DSigT (DVarT a) (DConT ''Proxy `DAppT` DVarT t) -- (a :: Proxy t)
         , y :-&gt; DSigT (DVarT y) (DConT ''Proxy `DAppT` DVarT y) -- (y :: Proxy t)
         , e :-&gt; DSigT (DVarT e) (DConT ''(:~:)
                                  `DAppT` DSigT (DVarT a) (DConT ''Proxy `DAppT` DSigT (DVarT t) (DVarT k))
                                  `DAppT` DSigT (DVarT y) (DConT ''Proxy `DAppT` DSigT (DVarT t) (DVarT k)))
                                                                 -- (e :: (a :: Proxy (t :: k)) :~: (y :: Proxy (t :: k)))
         }

       Why do this? Because when constructing the `forall` in the return kind
       of a defunctionalization symbol, it's convenient to be able to know
       the kinds of everything being bound at a glance. It's not always
       possible to recover the kinds of every variable (for instance, if
       we're just given `Proxy t ~&gt; Proxy t ~&gt; (a :~: y) ~&gt; Type`), so having
       this information is handy.

       To construct this map, we:

       (a) Grab the list of type variable binders (this is given as an input
           to defunctionalize, as discussed in part (1)) and turn it into a list
           of types. Also include the return kind (if there is one) in this
           list, as it may also mention type variables with explicit kinds.
       (b) Construct a flat list of all type variables mentioned in this list.
           This may involve looking in the kinds of type variables binders.
           (Note that this part is crucial&#8212;the the Singletons/PolyKinds test
           will fail to compile without it!)
       (c) Take the flat list and insert each variable into the map by
           mapping its name to its type (as demonstrated above).

       To continue the Symmetry example:

       (a) We grab the list of type variable binders

             [ (a :: Proxy t)
             , (y :: Proxy t)
             , (e :: (a :: Proxy (t :: k)) :~: (y :: Proxy (t :: k)))
             ]

           from the Symmetry declaration. Including the return kind (Type),
           we get:

             [ (a :: Proxy t)
             , (y :: Proxy t)
             , (e :: (a :: Proxy (t :: k)) :~: (y :: Proxy (t :: k)))
             , Type
             ]

       (b) We flatten this into a list of well scoped type variables:

             [ k
             , (t :: k)
             , (a :: Proxy t)
             , (y :: Proxy t)
             , (e :: (a :: Proxy (t :: k)) :~: (y :~: Proxy (t :: k)))
             ]

       (c) From this, we construct the map shown at the beginning of (i).

   (ii) Using the map, we will annotate any kind variables in the LHS of the
        declaration with their respective kinds. In this example, the LHS is:

          data SymmetrySym1 (a :: Proxy t) :: ...

        Since `t` maps to simply `(t :: k)` in the map, the LHS becomes:

          data SymmetrySym1 (a :: Proxy (t :: k)) :: ...

        Why do this? Because we need to make it apparent that `k` is bound on
        the LHS. If we don't, we might end up trying to quantify `k` in the
        return kind (see #353 for an example of what goes wrong if you try to
        do this).

        Having to explicitly annotate each occurrence of every kind variable on
        the LHS like this is a bit tiresome, especially since we don't have to
        do this in the return kind. If GHC had syntax for visible dependent
        quantification, we could avoid this step entirely and simply write:

          data SymmetrySym1 :: forall k (t :: k). forall (a :: Proxy t) -&gt; ...

        Until GHC gains this syntax, this is the best alternative.

   (iii) When constructing each defunctionalization symbol, we will end up with
         some remaining type variable binders and a return kind. For instance:

           data SymmetrySym1 (a :: Proxy (t :: k))
             :: forall ???. Proxy t
                         ~&gt; ((a :: Proxy (t :: k)) :~: (y :: Proxy (t :: k)))
                         ~&gt; Type

         We must fill in the ??? part. Here is how we do so:

         (a) Collect all of the type variables mentioned in the return kind.
         (b) Look up each type variable's corresponding type in the map (from
             part (i)) to learn as much kind information as possible.
         (c) Perform a reverse topological sort on these types to put the
             types (and kind) variables in proper dependency order.
         (d) Filter out any variables that are already bound by the type
             variable binders that precede the return kind.

         After doing these steps, what remains goes in place of ???. Let's
         explain this with the example above:

           data SymmetrySym1 (a :: Proxy (t :: k))
             :: forall ???. Proxy t
                         ~&gt; ((a :: Proxy (t :: k)) :~: (y :: Proxy (t :: k)))
                         ~&gt; Type

         (a) [t, a, k, y]
         (b) [(t :: k), (a :: Proxy t), k, (y :: Proxy t)]
         (c) [k, (t :: k), (a :: Proxy t), (y :: Proxy t)]
         (d) [(y :: Proxy t)] (`k`, `t` and `a` were already bound)

         Therefore, we end up with:

           data SymmetrySym1 (a :: Proxy (t :: k))
             :: forall (y :: Proxy t).
                            Proxy t
                         ~&gt; ((a :: Proxy (t :: k)) :~: (y :: Proxy (t :: k)))
                         ~&gt; Type
-}</span><span>
</span><a name="line-451"></a><span>
</span><a name="line-452"></a><span class="hs-comment">-- This is a small function with large importance. When generating</span><span>
</span><a name="line-453"></a><span class="hs-comment">-- defunctionalization data types, we often need to fill in the blank in the</span><span>
</span><a name="line-454"></a><span class="hs-comment">-- sort of code exemplified below:</span><span>
</span><a name="line-455"></a><span class="hs-comment">--</span><span>
</span><a name="line-456"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-457"></a><span class="hs-comment">-- data FooSym2 a (b :: x) (c :: TyFun y z) where</span><span>
</span><a name="line-458"></a><span class="hs-comment">--   FooSym2KindInference :: _</span><span>
</span><a name="line-459"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-460"></a><span class="hs-comment">--</span><span>
</span><a name="line-461"></a><span class="hs-comment">-- Where the kind of @a@ is not known. It's extremely tempting to just</span><span>
</span><a name="line-462"></a><span class="hs-comment">-- copy-and-paste the type variable binders from the data type itself to the</span><span>
</span><a name="line-463"></a><span class="hs-comment">-- constructor, like so:</span><span>
</span><a name="line-464"></a><span class="hs-comment">--</span><span>
</span><a name="line-465"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-466"></a><span class="hs-comment">-- data FooSym2 a (b :: x) (c :: TyFun y z) where</span><span>
</span><a name="line-467"></a><span class="hs-comment">--   FooSym2KindInference :: forall a (b :: x) (c :: TyFun y z).</span><span>
</span><a name="line-468"></a><span class="hs-comment">--                           SameKind (...) (...).</span><span>
</span><a name="line-469"></a><span class="hs-comment">--                           FooSym2KindInference a b c</span><span>
</span><a name="line-470"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-471"></a><span class="hs-comment">--</span><span>
</span><a name="line-472"></a><span class="hs-comment">-- But this ends up being an untenable approach. Because @a@ lacks a kind</span><span>
</span><a name="line-473"></a><span class="hs-comment">-- signature, @FooSym2@ does not have a complete, user-specified kind signature</span><span>
</span><a name="line-474"></a><span class="hs-comment">-- (or CUSK), so GHC will fail to typecheck @FooSym2KindInference@.</span><span>
</span><a name="line-475"></a><span class="hs-comment">--</span><span>
</span><a name="line-476"></a><span class="hs-comment">-- Thankfully, there's a workaround&#8212;just don't give any of the constructor's</span><span>
</span><a name="line-477"></a><span class="hs-comment">-- type variable binders any kinds:</span><span>
</span><a name="line-478"></a><span class="hs-comment">--</span><span>
</span><a name="line-479"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-480"></a><span class="hs-comment">-- data FooSym2 a (b :: x) (c :: TyFun y z) where</span><span>
</span><a name="line-481"></a><span class="hs-comment">--   FooSym2KindInference :: forall a b c</span><span>
</span><a name="line-482"></a><span class="hs-comment">--                           SameKind (...) (...).</span><span>
</span><a name="line-483"></a><span class="hs-comment">--                           FooSym2KindInference a b c</span><span>
</span><a name="line-484"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-485"></a><span class="hs-comment">--</span><span>
</span><a name="line-486"></a><span class="hs-comment">-- GHC may be moody when it comes to CUSKs, but it's at least understanding</span><span>
</span><a name="line-487"></a><span class="hs-comment">-- enough to typecheck this without issue. The 'dropTvbKind' function is</span><span>
</span><a name="line-488"></a><span class="hs-comment">-- what removes the kinds used in the kind inference constructor.</span><span>
</span><a name="line-489"></a><span class="hs-identifier">dropTvbKind</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DTyVarBndr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DTyVarBndr</span><span>
</span><a name="line-490"></a><a name="dropTvbKind"><a href="Data.Singletons.Promote.Defun.html#dropTvbKind"><span class="hs-identifier">dropTvbKind</span></a></a><span> </span><a name="local-6989586621679185375"><a href="#local-6989586621679185375"><span class="hs-identifier">tvb</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">DPlainTV</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679185375"><span class="hs-identifier hs-var">tvb</span></a><span>
</span><a name="line-491"></a><span class="hs-identifier">dropTvbKind</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DKindedTV</span><span> </span><a name="local-6989586621679185376"><a href="#local-6989586621679185376"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">DPlainTV</span><span> </span><a href="#local-6989586621679185376"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-492"></a><span>
</span><a name="line-493"></a><span class="hs-comment">-- Shorthand for building (k1 ~&gt; k2)</span><span>
</span><a name="line-494"></a><span class="hs-identifier">buildTyFunArrow</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DKind</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DKind</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DKind</span><span>
</span><a name="line-495"></a><a name="buildTyFunArrow"><a href="Data.Singletons.Promote.Defun.html#buildTyFunArrow"><span class="hs-identifier">buildTyFunArrow</span></a></a><span> </span><a name="local-6989586621679185377"><a href="#local-6989586621679185377"><span class="hs-identifier">k1</span></a></a><span> </span><a name="local-6989586621679185378"><a href="#local-6989586621679185378"><span class="hs-identifier">k2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">DConT</span><span> </span><a href="Data.Singletons.Names.html#tyFunArrowName"><span class="hs-identifier hs-var">tyFunArrowName</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">DAppT</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679185377"><span class="hs-identifier hs-var">k1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">DAppT</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679185378"><span class="hs-identifier hs-var">k2</span></a><span>
</span><a name="line-496"></a><span>
</span><a name="line-497"></a><span class="hs-identifier">buildTyFunArrow_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">DKind</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">DKind</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">DKind</span><span>
</span><a name="line-498"></a><a name="buildTyFunArrow_maybe"><a href="Data.Singletons.Promote.Defun.html#buildTyFunArrow_maybe"><span class="hs-identifier">buildTyFunArrow_maybe</span></a></a><span> </span><a name="local-6989586621679185379"><a href="#local-6989586621679185379"><span class="hs-identifier">m_k1</span></a></a><span> </span><a name="local-6989586621679185380"><a href="#local-6989586621679185380"><span class="hs-identifier">m_k2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-499"></a><span>  </span><a name="local-6989586621679185381"><a href="#local-6989586621679185381"><span class="hs-identifier">k1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679185379"><span class="hs-identifier hs-var">m_k1</span></a><span>
</span><a name="line-500"></a><span>  </span><a name="local-6989586621679185382"><a href="#local-6989586621679185382"><span class="hs-identifier">k2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679185380"><span class="hs-identifier hs-var">m_k2</span></a><span>
</span><a name="line-501"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">DConT</span><span> </span><a href="Data.Singletons.Names.html#tyFunArrowName"><span class="hs-identifier hs-var">tyFunArrowName</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">DAppT</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679185381"><span class="hs-identifier hs-var">k1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">DAppT</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679185382"><span class="hs-identifier hs-var">k2</span></a><span>
</span><a name="line-502"></a><span>
</span><a name="line-503"></a><span class="hs-comment">-- Build (~&gt;) kind from the list of kinds</span><span>
</span><a name="line-504"></a><span class="hs-identifier">ravelTyFun</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DKind</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DKind</span><span>
</span><a name="line-505"></a><a name="ravelTyFun"><a href="Data.Singletons.Promote.Defun.html#ravelTyFun"><span class="hs-identifier">ravelTyFun</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-string">&quot;Internal error: TyFun raveling nil&quot;</span><span>
</span><a name="line-506"></a><span class="hs-identifier">ravelTyFun</span><span> </span><span class="hs-special">[</span><a name="local-6989586621679185383"><a href="#local-6989586621679185383"><span class="hs-identifier">k</span></a></a><span class="hs-special">]</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679185383"><span class="hs-identifier hs-var">k</span></a><span>
</span><a name="line-507"></a><span class="hs-identifier">ravelTyFun</span><span> </span><a name="local-6989586621679185384"><a href="#local-6989586621679185384"><span class="hs-identifier">kinds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679185388"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679185387"><span class="hs-identifier hs-var">tailK</span></a><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Promote.Defun.html#buildTyFunArrow"><span class="hs-identifier hs-var">buildTyFunArrow</span></a><span> </span><a href="#local-6989586621679185386"><span class="hs-identifier hs-var">k2</span></a><span> </span><a href="#local-6989586621679185385"><span class="hs-identifier hs-var">k1</span></a><span class="hs-special">)</span><span>
</span><a name="line-508"></a><span>    </span><span class="hs-keyword">where</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679185385"><a href="#local-6989586621679185385"><span class="hs-identifier">k1</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621679185386"><a href="#local-6989586621679185386"><span class="hs-identifier">k2</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621679185387"><a href="#local-6989586621679185387"><span class="hs-identifier">tailK</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621679185384"><span class="hs-identifier hs-var">kinds</span></a><span>
</span><a name="line-509"></a><span>          </span><a name="local-6989586621679185388"><a href="#local-6989586621679185388"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><a name="local-6989586621679185389"><a href="#local-6989586621679185389"><span class="hs-identifier">acc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679185389"><span class="hs-identifier hs-var">acc</span></a><span>
</span><a name="line-510"></a><span>          </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679185390"><a href="#local-6989586621679185390"><span class="hs-identifier">k</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679185391"><a href="#local-6989586621679185391"><span class="hs-identifier">ks</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679185392"><a href="#local-6989586621679185392"><span class="hs-identifier">acc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679185388"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679185391"><span class="hs-identifier hs-var">ks</span></a><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Promote.Defun.html#buildTyFunArrow"><span class="hs-identifier hs-var">buildTyFunArrow</span></a><span> </span><a href="#local-6989586621679185390"><span class="hs-identifier hs-var">k</span></a><span> </span><a href="#local-6989586621679185392"><span class="hs-identifier hs-var">acc</span></a><span class="hs-special">)</span><span>
</span><a name="line-511"></a><span>
</span><a name="line-512"></a><span class="hs-comment">{-
Note [Fixity declarations for defunctionalization symbols]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Just like we promote fixity declarations, we should also generate fixity
declarations for defunctionaliztion symbols. A primary use case is the
following scenario:

  (.) :: (b -&gt; c) -&gt; (a -&gt; b) -&gt; (a -&gt; c)
  (f . g) x = f (g x)
  infixr 9 .

One often writes (f . g . h) at the value level, but because (.) is promoted
to a type family with three arguments, this doesn't directly translate to the
type level. Instead, one must write this:

  f .@#@$$$ g .@#@$$$ h

But in order to ensure that this associates to the right as expected, one must
generate an `infixr 9 .@#@#$$$` declaration. This is why defunctionalize accepts
a Maybe Fixity argument.
-}</span><span>
</span><a name="line-533"></a></pre></body></html>