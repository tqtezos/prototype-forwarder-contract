<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{- Data/Singletons/Promote.hs

(c) Richard Eisenberg 2013
rae@cs.brynmawr.edu

This file contains functions to promote term-level constructs to the
type level. It is an internal module to the singletons package.
-}</span><span>
</span><a name="line-9"></a><span>
</span><a name="line-10"></a><span class="hs-pragma">{-# LANGUAGE TemplateHaskell, MultiWayIf, LambdaCase, TupleSections #-}</span><span>
</span><a name="line-11"></a><span>
</span><a name="line-12"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Data.Singletons.Promote</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-13"></a><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Language.Haskell.TH</span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Q</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">cxt</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Language.Haskell.TH.Syntax</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Quasi</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Language.Haskell.TH.Desugar</span><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Singletons.Names.html"><span class="hs-identifier">Data.Singletons.Names</span></a><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Singletons.Promote.Monad.html"><span class="hs-identifier">Data.Singletons.Promote.Monad</span></a><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Singletons.Promote.Eq.html"><span class="hs-identifier">Data.Singletons.Promote.Eq</span></a><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Singletons.Promote.Defun.html"><span class="hs-identifier">Data.Singletons.Promote.Defun</span></a><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Singletons.Promote.Type.html"><span class="hs-identifier">Data.Singletons.Promote.Type</span></a><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Singletons.Deriving.Ord.html"><span class="hs-identifier">Data.Singletons.Deriving.Ord</span></a><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Singletons.Deriving.Bounded.html"><span class="hs-identifier">Data.Singletons.Deriving.Bounded</span></a><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Singletons.Deriving.Enum.html"><span class="hs-identifier">Data.Singletons.Deriving.Enum</span></a><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Singletons.Deriving.Show.html"><span class="hs-identifier">Data.Singletons.Deriving.Show</span></a><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Singletons.Deriving.Util.html"><span class="hs-identifier">Data.Singletons.Deriving.Util</span></a><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Singletons.Partition.html"><span class="hs-identifier">Data.Singletons.Partition</span></a><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Singletons.Util.html"><span class="hs-identifier">Data.Singletons.Util</span></a><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Singletons.Syntax.html"><span class="hs-identifier">Data.Singletons.Syntax</span></a><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Prelude</span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">exp</span><span class="hs-special">)</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Applicative</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Alternative</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Arrow</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">second</span><span class="hs-special">)</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.Trans.Class</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadTrans</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.Trans.Maybe</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.Writer</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Map.Strict</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Map</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Map.Strict</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Set</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Set</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Set</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Set</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Maybe</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">GHC.LanguageExtensions.Type</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">LangExt</span><span>
</span><a name="line-43"></a><span>
</span><a name="line-44"></a><span class="hs-comment">-- | Generate promoted definitions from a type that is already defined.</span><span>
</span><a name="line-45"></a><span class="hs-comment">-- This is generally only useful with classes.</span><span>
</span><a name="line-46"></a><span class="hs-identifier">genPromotions</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DsMonad</span><span> </span><a href="#local-6989586621679255097"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679255097"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span>
</span><a name="line-47"></a><a name="genPromotions"><a href="Data.Singletons.Promote.html#genPromotions"><span class="hs-identifier">genPromotions</span></a></a><span> </span><a name="local-6989586621679255098"><a href="#local-6989586621679255098"><span class="hs-identifier">names</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-48"></a><span>  </span><a href="Data.Singletons.Util.html#checkForRep"><span class="hs-identifier hs-var">checkForRep</span></a><span> </span><a href="#local-6989586621679255098"><span class="hs-identifier hs-var">names</span></a><span>
</span><a name="line-49"></a><span>  </span><a name="local-6989586621679255099"><a href="#local-6989586621679255099"><span class="hs-identifier">infos</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-identifier hs-var">reifyWithLocals</span><span> </span><a href="#local-6989586621679255098"><span class="hs-identifier hs-var">names</span></a><span>
</span><a name="line-50"></a><span>  </span><a name="local-6989586621679255100"><a href="#local-6989586621679255100"><span class="hs-identifier">dinfos</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-identifier hs-var">dsInfo</span><span> </span><a href="#local-6989586621679255099"><span class="hs-identifier hs-var">infos</span></a><span>
</span><a name="line-51"></a><span>  </span><a name="local-6989586621679255101"><a href="#local-6989586621679255101"><span class="hs-identifier">ddecs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Promote.Monad.html#promoteM_"><span class="hs-identifier hs-var">promoteM_</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mapM_</span><span> </span><a href="Data.Singletons.Promote.html#promoteInfo"><span class="hs-identifier hs-var">promoteInfo</span></a><span> </span><a href="#local-6989586621679255100"><span class="hs-identifier hs-var">dinfos</span></a><span>
</span><a name="line-52"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">decsToTH</span><span> </span><a href="#local-6989586621679255101"><span class="hs-identifier hs-var">ddecs</span></a><span>
</span><a name="line-53"></a><span>
</span><a name="line-54"></a><span class="hs-comment">-- | Promote every declaration given to the type level, retaining the originals.</span><span>
</span><a name="line-55"></a><span class="hs-identifier">promote</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DsMonad</span><span> </span><a href="#local-6989586621679255096"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679255096"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679255096"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span>
</span><a name="line-56"></a><a name="promote"><a href="Data.Singletons.Promote.html#promote"><span class="hs-identifier">promote</span></a></a><span> </span><a name="local-6989586621679255102"><a href="#local-6989586621679255102"><span class="hs-identifier">qdec</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-57"></a><span>  </span><a name="local-6989586621679255103"><a href="#local-6989586621679255103"><span class="hs-identifier">decls</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679255102"><span class="hs-identifier hs-var">qdec</span></a><span>
</span><a name="line-58"></a><span>  </span><a name="local-6989586621679255104"><a href="#local-6989586621679255104"><span class="hs-identifier">ddecls</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">withLocalDeclarations</span><span> </span><a href="#local-6989586621679255103"><span class="hs-identifier hs-var">decls</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">dsDecs</span><span> </span><a href="#local-6989586621679255103"><span class="hs-identifier hs-var">decls</span></a><span>
</span><a name="line-59"></a><span>  </span><a name="local-6989586621679255105"><a href="#local-6989586621679255105"><span class="hs-identifier">promDecls</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Promote.Monad.html#promoteM_"><span class="hs-identifier hs-var">promoteM_</span></a><span> </span><a href="#local-6989586621679255103"><span class="hs-identifier hs-var">decls</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Singletons.Promote.html#promoteDecs"><span class="hs-identifier hs-var">promoteDecs</span></a><span> </span><a href="#local-6989586621679255104"><span class="hs-identifier hs-var">ddecls</span></a><span>
</span><a name="line-60"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679255103"><span class="hs-identifier hs-var">decls</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">decsToTH</span><span> </span><a href="#local-6989586621679255105"><span class="hs-identifier hs-var">promDecls</span></a><span>
</span><a name="line-61"></a><span>
</span><a name="line-62"></a><span class="hs-comment">-- | Promote each declaration, discarding the originals. Note that a promoted</span><span>
</span><a name="line-63"></a><span class="hs-comment">-- datatype uses the same definition as an original datatype, so this will</span><span>
</span><a name="line-64"></a><span class="hs-comment">-- not work with datatypes. Classes, instances, and functions are all fine.</span><span>
</span><a name="line-65"></a><span class="hs-identifier">promoteOnly</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DsMonad</span><span> </span><a href="#local-6989586621679255095"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679255095"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679255095"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span>
</span><a name="line-66"></a><a name="promoteOnly"><a href="Data.Singletons.Promote.html#promoteOnly"><span class="hs-identifier">promoteOnly</span></a></a><span> </span><a name="local-6989586621679255106"><a href="#local-6989586621679255106"><span class="hs-identifier">qdec</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-67"></a><span>  </span><a name="local-6989586621679255107"><a href="#local-6989586621679255107"><span class="hs-identifier">decls</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679255106"><span class="hs-identifier hs-var">qdec</span></a><span>
</span><a name="line-68"></a><span>  </span><a name="local-6989586621679255108"><a href="#local-6989586621679255108"><span class="hs-identifier">ddecls</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">dsDecs</span><span> </span><a href="#local-6989586621679255107"><span class="hs-identifier hs-var">decls</span></a><span>
</span><a name="line-69"></a><span>  </span><a name="local-6989586621679255109"><a href="#local-6989586621679255109"><span class="hs-identifier">promDecls</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Promote.Monad.html#promoteM_"><span class="hs-identifier hs-var">promoteM_</span></a><span> </span><a href="#local-6989586621679255107"><span class="hs-identifier hs-var">decls</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Singletons.Promote.html#promoteDecs"><span class="hs-identifier hs-var">promoteDecs</span></a><span> </span><a href="#local-6989586621679255108"><span class="hs-identifier hs-var">ddecls</span></a><span>
</span><a name="line-70"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">decsToTH</span><span> </span><a href="#local-6989586621679255109"><span class="hs-identifier hs-var">promDecls</span></a><span>
</span><a name="line-71"></a><span>
</span><a name="line-72"></a><span class="hs-comment">-- | Generate defunctionalization symbols for existing type families.</span><span>
</span><a name="line-73"></a><span class="hs-comment">--</span><span>
</span><a name="line-74"></a><span class="hs-comment">-- 'genDefunSymbols' has reasonable support for type families that use</span><span>
</span><a name="line-75"></a><span class="hs-comment">-- dependent quantification. For instance, this:</span><span>
</span><a name="line-76"></a><span class="hs-comment">--</span><span>
</span><a name="line-77"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-78"></a><span class="hs-comment">-- type family MyProxy k (a :: k) :: Type where</span><span>
</span><a name="line-79"></a><span class="hs-comment">--   MyProxy k (a :: k) = Proxy a</span><span>
</span><a name="line-80"></a><span class="hs-comment">--</span><span>
</span><a name="line-81"></a><span class="hs-comment">-- $('genDefunSymbols' [''MyProxy])</span><span>
</span><a name="line-82"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-83"></a><span class="hs-comment">--</span><span>
</span><a name="line-84"></a><span class="hs-comment">-- Will generate the following defunctionalization symbols:</span><span>
</span><a name="line-85"></a><span class="hs-comment">--</span><span>
</span><a name="line-86"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-87"></a><span class="hs-comment">-- data MyProxySym0     :: Type  ~&gt; k ~&gt; Type</span><span>
</span><a name="line-88"></a><span class="hs-comment">-- data MyProxySym1 (k  :: Type) :: k ~&gt; Type</span><span>
</span><a name="line-89"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-90"></a><span class="hs-comment">--</span><span>
</span><a name="line-91"></a><span class="hs-comment">-- Note that @MyProxySym0@ is a bit more general than it ought to be, since</span><span>
</span><a name="line-92"></a><span class="hs-comment">-- there is no dependency between the first kind (@Type@) and the second kind</span><span>
</span><a name="line-93"></a><span class="hs-comment">-- (@k@). But this would require the ability to write something like:</span><span>
</span><a name="line-94"></a><span class="hs-comment">--</span><span>
</span><a name="line-95"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-96"></a><span class="hs-comment">-- data MyProxySym0 :: forall (k :: Type) ~&gt; k ~&gt; Type</span><span>
</span><a name="line-97"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-98"></a><span class="hs-comment">--</span><span>
</span><a name="line-99"></a><span class="hs-comment">-- Which currently isn't possible. So for the time being, the kind of</span><span>
</span><a name="line-100"></a><span class="hs-comment">-- @MyProxySym0@ will be slightly more general, which means that under rare</span><span>
</span><a name="line-101"></a><span class="hs-comment">-- circumstances, you may have to provide extra type signatures if you write</span><span>
</span><a name="line-102"></a><span class="hs-comment">-- code which exploits the dependency in @MyProxy@'s kind.</span><span>
</span><a name="line-103"></a><span class="hs-identifier">genDefunSymbols</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DsMonad</span><span> </span><a href="#local-6989586621679255094"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679255094"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span>
</span><a name="line-104"></a><a name="genDefunSymbols"><a href="Data.Singletons.Promote.html#genDefunSymbols"><span class="hs-identifier">genDefunSymbols</span></a></a><span> </span><a name="local-6989586621679255110"><a href="#local-6989586621679255110"><span class="hs-identifier">names</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-105"></a><span>  </span><a href="Data.Singletons.Util.html#checkForRep"><span class="hs-identifier hs-var">checkForRep</span></a><span> </span><a href="#local-6989586621679255110"><span class="hs-identifier hs-var">names</span></a><span>
</span><a name="line-106"></a><span>  </span><a name="local-6989586621679255111"><a href="#local-6989586621679255111"><span class="hs-identifier">infos</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dsInfo</span><span> </span><span class="hs-operator hs-var">&lt;=&lt;</span><span> </span><span class="hs-identifier hs-var">reifyWithLocals</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679255110"><span class="hs-identifier hs-var">names</span></a><span>
</span><a name="line-107"></a><span>  </span><a name="local-6989586621679255112"><a href="#local-6989586621679255112"><span class="hs-identifier">decs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Promote.Monad.html#promoteMDecs"><span class="hs-identifier hs-var">promoteMDecs</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a><span> </span><a href="Data.Singletons.Promote.Defun.html#defunInfo"><span class="hs-identifier hs-var">defunInfo</span></a><span> </span><a href="#local-6989586621679255111"><span class="hs-identifier hs-var">infos</span></a><span>
</span><a name="line-108"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">decsToTH</span><span> </span><a href="#local-6989586621679255112"><span class="hs-identifier hs-var">decs</span></a><span>
</span><a name="line-109"></a><span>
</span><a name="line-110"></a><span class="hs-comment">-- | Produce instances for @(==)@ (type-level equality) from the given types</span><span>
</span><a name="line-111"></a><span class="hs-identifier">promoteEqInstances</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DsMonad</span><span> </span><a href="#local-6989586621679255093"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679255093"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span>
</span><a name="line-112"></a><a name="promoteEqInstances"><a href="Data.Singletons.Promote.html#promoteEqInstances"><span class="hs-identifier">promoteEqInstances</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a><span> </span><a href="Data.Singletons.Promote.html#promoteEqInstance"><span class="hs-identifier hs-var">promoteEqInstance</span></a><span>
</span><a name="line-113"></a><span>
</span><a name="line-114"></a><span class="hs-comment">-- | Produce instances for 'POrd' from the given types</span><span>
</span><a name="line-115"></a><span class="hs-identifier">promoteOrdInstances</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DsMonad</span><span> </span><a href="#local-6989586621679255092"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679255092"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span>
</span><a name="line-116"></a><a name="promoteOrdInstances"><a href="Data.Singletons.Promote.html#promoteOrdInstances"><span class="hs-identifier">promoteOrdInstances</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a><span> </span><a href="Data.Singletons.Promote.html#promoteOrdInstance"><span class="hs-identifier hs-var">promoteOrdInstance</span></a><span>
</span><a name="line-117"></a><span>
</span><a name="line-118"></a><span class="hs-comment">-- | Produce an instance for 'POrd' from the given type</span><span>
</span><a name="line-119"></a><span class="hs-identifier">promoteOrdInstance</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DsMonad</span><span> </span><a href="#local-6989586621679255091"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679255091"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span>
</span><a name="line-120"></a><a name="promoteOrdInstance"><a href="Data.Singletons.Promote.html#promoteOrdInstance"><span class="hs-identifier">promoteOrdInstance</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Promote.html#promoteInstance"><span class="hs-identifier hs-var">promoteInstance</span></a><span> </span><a href="Data.Singletons.Deriving.Ord.html#mkOrdInstance"><span class="hs-identifier hs-var">mkOrdInstance</span></a><span> </span><span class="hs-string">&quot;Ord&quot;</span><span>
</span><a name="line-121"></a><span>
</span><a name="line-122"></a><span class="hs-comment">-- | Produce instances for 'PBounded' from the given types</span><span>
</span><a name="line-123"></a><span class="hs-identifier">promoteBoundedInstances</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DsMonad</span><span> </span><a href="#local-6989586621679255090"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679255090"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span>
</span><a name="line-124"></a><a name="promoteBoundedInstances"><a href="Data.Singletons.Promote.html#promoteBoundedInstances"><span class="hs-identifier">promoteBoundedInstances</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a><span> </span><a href="Data.Singletons.Promote.html#promoteBoundedInstance"><span class="hs-identifier hs-var">promoteBoundedInstance</span></a><span>
</span><a name="line-125"></a><span>
</span><a name="line-126"></a><span class="hs-comment">-- | Produce an instance for 'PBounded' from the given type</span><span>
</span><a name="line-127"></a><span class="hs-identifier">promoteBoundedInstance</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DsMonad</span><span> </span><a href="#local-6989586621679255089"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679255089"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span>
</span><a name="line-128"></a><a name="promoteBoundedInstance"><a href="Data.Singletons.Promote.html#promoteBoundedInstance"><span class="hs-identifier">promoteBoundedInstance</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Promote.html#promoteInstance"><span class="hs-identifier hs-var">promoteInstance</span></a><span> </span><a href="Data.Singletons.Deriving.Bounded.html#mkBoundedInstance"><span class="hs-identifier hs-var">mkBoundedInstance</span></a><span> </span><span class="hs-string">&quot;Bounded&quot;</span><span>
</span><a name="line-129"></a><span>
</span><a name="line-130"></a><span class="hs-comment">-- | Produce instances for 'PEnum' from the given types</span><span>
</span><a name="line-131"></a><span class="hs-identifier">promoteEnumInstances</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DsMonad</span><span> </span><a href="#local-6989586621679255088"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679255088"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span>
</span><a name="line-132"></a><a name="promoteEnumInstances"><a href="Data.Singletons.Promote.html#promoteEnumInstances"><span class="hs-identifier">promoteEnumInstances</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a><span> </span><a href="Data.Singletons.Promote.html#promoteEnumInstance"><span class="hs-identifier hs-var">promoteEnumInstance</span></a><span>
</span><a name="line-133"></a><span>
</span><a name="line-134"></a><span class="hs-comment">-- | Produce an instance for 'PEnum' from the given type</span><span>
</span><a name="line-135"></a><span class="hs-identifier">promoteEnumInstance</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DsMonad</span><span> </span><a href="#local-6989586621679255087"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679255087"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span>
</span><a name="line-136"></a><a name="promoteEnumInstance"><a href="Data.Singletons.Promote.html#promoteEnumInstance"><span class="hs-identifier">promoteEnumInstance</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Promote.html#promoteInstance"><span class="hs-identifier hs-var">promoteInstance</span></a><span> </span><a href="Data.Singletons.Deriving.Enum.html#mkEnumInstance"><span class="hs-identifier hs-var">mkEnumInstance</span></a><span> </span><span class="hs-string">&quot;Enum&quot;</span><span>
</span><a name="line-137"></a><span>
</span><a name="line-138"></a><span class="hs-comment">-- | Produce instances for 'PShow' from the given types</span><span>
</span><a name="line-139"></a><span class="hs-identifier">promoteShowInstances</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DsMonad</span><span> </span><a href="#local-6989586621679255086"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679255086"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span>
</span><a name="line-140"></a><a name="promoteShowInstances"><a href="Data.Singletons.Promote.html#promoteShowInstances"><span class="hs-identifier">promoteShowInstances</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a><span> </span><a href="Data.Singletons.Promote.html#promoteShowInstance"><span class="hs-identifier hs-var">promoteShowInstance</span></a><span>
</span><a name="line-141"></a><span>
</span><a name="line-142"></a><span class="hs-comment">-- | Produce an instance for 'PShow' from the given type</span><span>
</span><a name="line-143"></a><span class="hs-identifier">promoteShowInstance</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DsMonad</span><span> </span><a href="#local-6989586621679255085"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679255085"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span>
</span><a name="line-144"></a><a name="promoteShowInstance"><a href="Data.Singletons.Promote.html#promoteShowInstance"><span class="hs-identifier">promoteShowInstance</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Promote.html#promoteInstance"><span class="hs-identifier hs-var">promoteInstance</span></a><span> </span><a href="Data.Singletons.Deriving.Show.html#mkShowInstance"><span class="hs-identifier hs-var">mkShowInstance</span></a><span> </span><span class="hs-string">&quot;Show&quot;</span><span>
</span><a name="line-145"></a><span>
</span><a name="line-146"></a><span class="hs-comment">-- | Produce an instance for @(==)@ (type-level equality) from the given type</span><span>
</span><a name="line-147"></a><span class="hs-identifier">promoteEqInstance</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DsMonad</span><span> </span><a href="#local-6989586621679255084"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679255084"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span>
</span><a name="line-148"></a><a name="promoteEqInstance"><a href="Data.Singletons.Promote.html#promoteEqInstance"><span class="hs-identifier">promoteEqInstance</span></a></a><span> </span><a name="local-6989586621679255113"><a href="#local-6989586621679255113"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-149"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679255114"><a href="#local-6989586621679255114"><span class="hs-identifier">tvbs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679255115"><a href="#local-6989586621679255115"><span class="hs-identifier">cons</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDataD</span><span> </span><span class="hs-string">&quot;I cannot make an instance of (==) for it.&quot;</span><span> </span><a href="#local-6989586621679255113"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-150"></a><span>  </span><a name="local-6989586621679255116"><a href="#local-6989586621679255116"><span class="hs-identifier">tvbs'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-identifier hs-var">dsTvb</span><span> </span><a href="#local-6989586621679255114"><span class="hs-identifier hs-var">tvbs</span></a><span>
</span><a name="line-151"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679255117"><a href="#local-6989586621679255117"><span class="hs-identifier">data_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Util.html#foldTypeTvbs"><span class="hs-identifier hs-var">foldTypeTvbs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DConT</span><span> </span><a href="#local-6989586621679255113"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679255116"><span class="hs-identifier hs-var">tvbs'</span></a><span>
</span><a name="line-152"></a><span>  </span><a name="local-6989586621679255118"><a href="#local-6989586621679255118"><span class="hs-identifier">cons'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dsCon</span><span> </span><a href="#local-6989586621679255116"><span class="hs-identifier hs-var">tvbs'</span></a><span> </span><a href="#local-6989586621679255117"><span class="hs-identifier hs-var">data_ty</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679255115"><span class="hs-identifier hs-var">cons</span></a><span>
</span><a name="line-153"></a><span>  </span><a name="local-6989586621679255119"><a href="#local-6989586621679255119"><span class="hs-identifier">kind</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Promote.Type.html#promoteType"><span class="hs-identifier hs-var">promoteType</span></a><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Util.html#foldTypeTvbs"><span class="hs-identifier hs-var">foldTypeTvbs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DConT</span><span> </span><a href="#local-6989586621679255113"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679255116"><span class="hs-identifier hs-var">tvbs'</span></a><span class="hs-special">)</span><span>
</span><a name="line-154"></a><span>  </span><a name="local-6989586621679255120"><a href="#local-6989586621679255120"><span class="hs-identifier">inst_decs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Promote.Eq.html#mkEqTypeInstance"><span class="hs-identifier hs-var">mkEqTypeInstance</span></a><span> </span><a href="#local-6989586621679255119"><span class="hs-identifier hs-var">kind</span></a><span> </span><a href="#local-6989586621679255118"><span class="hs-identifier hs-var">cons'</span></a><span>
</span><a name="line-155"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">decsToTH</span><span> </span><a href="#local-6989586621679255120"><span class="hs-identifier hs-var">inst_decs</span></a><span>
</span><a name="line-156"></a><span>
</span><a name="line-157"></a><span class="hs-identifier">promoteInstance</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DsMonad</span><span> </span><a href="#local-6989586621679255083"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Data.Singletons.Deriving.Util.html#DerivDesc"><span class="hs-identifier hs-type">DerivDesc</span></a><span> </span><a href="#local-6989586621679255083"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679255083"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span>
</span><a name="line-158"></a><a name="promoteInstance"><a href="Data.Singletons.Promote.html#promoteInstance"><span class="hs-identifier">promoteInstance</span></a></a><span> </span><a name="local-6989586621679255121"><a href="#local-6989586621679255121"><span class="hs-identifier">mk_inst</span></a></a><span> </span><a name="local-6989586621679255122"><a href="#local-6989586621679255122"><span class="hs-identifier">class_name</span></a></a><span> </span><a name="local-6989586621679255123"><a href="#local-6989586621679255123"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-159"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679255124"><a href="#local-6989586621679255124"><span class="hs-identifier">tvbs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679255125"><a href="#local-6989586621679255125"><span class="hs-identifier">cons</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDataD</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;I cannot make an instance of &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679255122"><span class="hs-identifier hs-var">class_name</span></a><span>
</span><a name="line-160"></a><span>                            </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; for it.&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679255123"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-161"></a><span>  </span><a name="local-6989586621679255126"><a href="#local-6989586621679255126"><span class="hs-identifier">tvbs'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-identifier hs-var">dsTvb</span><span> </span><a href="#local-6989586621679255124"><span class="hs-identifier hs-var">tvbs</span></a><span>
</span><a name="line-162"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679255127"><a href="#local-6989586621679255127"><span class="hs-identifier">data_ty</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Util.html#foldTypeTvbs"><span class="hs-identifier hs-var">foldTypeTvbs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DConT</span><span> </span><a href="#local-6989586621679255123"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679255126"><span class="hs-identifier hs-var">tvbs'</span></a><span>
</span><a name="line-163"></a><span>  </span><a name="local-6989586621679255128"><a href="#local-6989586621679255128"><span class="hs-identifier">cons'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dsCon</span><span> </span><a href="#local-6989586621679255126"><span class="hs-identifier hs-var">tvbs'</span></a><span> </span><a href="#local-6989586621679255127"><span class="hs-identifier hs-var">data_ty</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679255125"><span class="hs-identifier hs-var">cons</span></a><span>
</span><a name="line-164"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679255129"><a href="#local-6989586621679255129"><span class="hs-identifier">data_decl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Syntax.html#DataDecl"><span class="hs-identifier hs-var">DataDecl</span></a><span> </span><a href="#local-6989586621679255123"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679255126"><span class="hs-identifier hs-var">tvbs'</span></a><span> </span><a href="#local-6989586621679255128"><span class="hs-identifier hs-var">cons'</span></a><span>
</span><a name="line-165"></a><span>  </span><a name="local-6989586621679255130"><a href="#local-6989586621679255130"><span class="hs-identifier">raw_inst</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679255121"><span class="hs-identifier hs-var">mk_inst</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621679255127"><span class="hs-identifier hs-var">data_ty</span></a><span> </span><a href="#local-6989586621679255129"><span class="hs-identifier hs-var">data_decl</span></a><span>
</span><a name="line-166"></a><span>  </span><a name="local-6989586621679255131"><a href="#local-6989586621679255131"><span class="hs-identifier">decs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Promote.Monad.html#promoteM_"><span class="hs-identifier hs-var">promoteM_</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">void</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Singletons.Promote.html#promoteInstanceDec"><span class="hs-identifier hs-var">promoteInstanceDec</span></a><span> </span><span class="hs-identifier hs-var">Map.empty</span><span> </span><a href="#local-6989586621679255130"><span class="hs-identifier hs-var">raw_inst</span></a><span>
</span><a name="line-167"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">decsToTH</span><span> </span><a href="#local-6989586621679255131"><span class="hs-identifier hs-var">decs</span></a><span>
</span><a name="line-168"></a><span>
</span><a name="line-169"></a><span class="hs-identifier">promoteInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DInfo</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-170"></a><a name="promoteInfo"><a href="Data.Singletons.Promote.html#promoteInfo"><span class="hs-identifier">promoteInfo</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DTyConI</span><span> </span><a name="local-6989586621679255132"><a href="#local-6989586621679255132"><span class="hs-identifier">dec</span></a></a><span> </span><a name="local-6989586621679255133"><a href="#local-6989586621679255133"><span class="hs-identifier">_instances</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Promote.html#promoteDecs"><span class="hs-identifier hs-var">promoteDecs</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621679255132"><span class="hs-identifier hs-var">dec</span></a><span class="hs-special">]</span><span>
</span><a name="line-171"></a><span class="hs-identifier">promoteInfo</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DPrimTyConI</span><span> </span><a name="local-6989586621679255134"><a href="#local-6989586621679255134"><span class="hs-identifier">_name</span></a></a><span> </span><a name="local-6989586621679255135"><a href="#local-6989586621679255135"><span class="hs-identifier">_numArgs</span></a></a><span> </span><a name="local-6989586621679255136"><a href="#local-6989586621679255136"><span class="hs-identifier">_unlifted</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-172"></a><span>  </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-string">&quot;Promotion of primitive type constructors not supported&quot;</span><span>
</span><a name="line-173"></a><span class="hs-identifier">promoteInfo</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DVarI</span><span> </span><a name="local-6989586621679255137"><a href="#local-6989586621679255137"><span class="hs-identifier">_name</span></a></a><span> </span><a name="local-6989586621679255138"><a href="#local-6989586621679255138"><span class="hs-identifier">_ty</span></a></a><span> </span><a name="local-6989586621679255139"><a href="#local-6989586621679255139"><span class="hs-identifier">_mdec</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-174"></a><span>  </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-string">&quot;Promotion of individual values not supported&quot;</span><span>
</span><a name="line-175"></a><span class="hs-identifier">promoteInfo</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DTyVarI</span><span> </span><a name="local-6989586621679255140"><a href="#local-6989586621679255140"><span class="hs-identifier">_name</span></a></a><span> </span><a name="local-6989586621679255141"><a href="#local-6989586621679255141"><span class="hs-identifier">_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-176"></a><span>  </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-string">&quot;Promotion of individual type variables not supported&quot;</span><span>
</span><a name="line-177"></a><span class="hs-identifier">promoteInfo</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DPatSynI</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-178"></a><span>  </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-string">&quot;Promotion of pattern synonyms not supported&quot;</span><span>
</span><a name="line-179"></a><span>
</span><a name="line-180"></a><span class="hs-comment">-- Note [Promoting declarations in two stages]</span><span>
</span><a name="line-181"></a><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><a name="line-182"></a><span class="hs-comment">--</span><span>
</span><a name="line-183"></a><span class="hs-comment">-- It is necessary to know the types of things when promoting. So,</span><span>
</span><a name="line-184"></a><span class="hs-comment">-- we promote in two stages: first, we build a LetDecEnv, which allows</span><span>
</span><a name="line-185"></a><span class="hs-comment">-- for easy lookup. Then, we go through the actual elements of the LetDecEnv,</span><span>
</span><a name="line-186"></a><span class="hs-comment">-- performing the promotion.</span><span>
</span><a name="line-187"></a><span class="hs-comment">--</span><span>
</span><a name="line-188"></a><span class="hs-comment">-- Why do we need the types? For kind annotations on the type family. We also</span><span>
</span><a name="line-189"></a><span class="hs-comment">-- need to have both the types and the actual function definition at the same</span><span>
</span><a name="line-190"></a><span class="hs-comment">-- time, because the function definition tells us how many patterns are</span><span>
</span><a name="line-191"></a><span class="hs-comment">-- matched. Note that an eta-contracted function needs to return a TyFun,</span><span>
</span><a name="line-192"></a><span class="hs-comment">-- not a proper type-level function.</span><span>
</span><a name="line-193"></a><span class="hs-comment">--</span><span>
</span><a name="line-194"></a><span class="hs-comment">-- Consider this example:</span><span>
</span><a name="line-195"></a><span class="hs-comment">--</span><span>
</span><a name="line-196"></a><span class="hs-comment">--   foo :: Nat -&gt; Bool -&gt; Bool</span><span>
</span><a name="line-197"></a><span class="hs-comment">--   foo Zero = id</span><span>
</span><a name="line-198"></a><span class="hs-comment">--   foo _    = not</span><span>
</span><a name="line-199"></a><span class="hs-comment">--</span><span>
</span><a name="line-200"></a><span class="hs-comment">-- Here the first parameter to foo is non-uniform, because it is</span><span>
</span><a name="line-201"></a><span class="hs-comment">-- inspected in a pattern and can be different in each defining</span><span>
</span><a name="line-202"></a><span class="hs-comment">-- equation of foo. The second parameter to foo, specified in the type</span><span>
</span><a name="line-203"></a><span class="hs-comment">-- signature as Bool, is a uniform parameter - it is not inspected and</span><span>
</span><a name="line-204"></a><span class="hs-comment">-- each defining equation of foo uses it the same way. The foo</span><span>
</span><a name="line-205"></a><span class="hs-comment">-- function will be promoted to a type familty Foo like this:</span><span>
</span><a name="line-206"></a><span class="hs-comment">--</span><span>
</span><a name="line-207"></a><span class="hs-comment">--   type family Foo (n :: Nat) :: Bool ~&gt; Bool where</span><span>
</span><a name="line-208"></a><span class="hs-comment">--      Foo Zero = Id</span><span>
</span><a name="line-209"></a><span class="hs-comment">--      Foo a    = Not</span><span>
</span><a name="line-210"></a><span class="hs-comment">--</span><span>
</span><a name="line-211"></a><span class="hs-comment">-- To generate type signature for Foo type family we must first learn</span><span>
</span><a name="line-212"></a><span class="hs-comment">-- what is the actual number of patterns used in defining cequations</span><span>
</span><a name="line-213"></a><span class="hs-comment">-- of foo. In this case there is only one so we declare Foo to take</span><span>
</span><a name="line-214"></a><span class="hs-comment">-- one argument and have return type of Bool -&gt; Bool.</span><span>
</span><a name="line-215"></a><span>
</span><a name="line-216"></a><span class="hs-comment">-- Promote a list of top-level declarations.</span><span>
</span><a name="line-217"></a><span class="hs-identifier">promoteDecs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DDec</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-218"></a><a name="promoteDecs"><a href="Data.Singletons.Promote.html#promoteDecs"><span class="hs-identifier">promoteDecs</span></a></a><span> </span><a name="local-6989586621679255142"><a href="#local-6989586621679255142"><span class="hs-identifier">raw_decls</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-219"></a><span>  </span><a name="local-6989586621679255143"><a href="#local-6989586621679255143"><span class="hs-identifier">decls</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">expand</span><span> </span><a href="#local-6989586621679255142"><span class="hs-identifier hs-var">raw_decls</span></a><span>     </span><span class="hs-comment">-- expand type synonyms</span><span>
</span><a name="line-220"></a><span>  </span><a href="Data.Singletons.Util.html#checkForRepInDecls"><span class="hs-identifier hs-var">checkForRepInDecls</span></a><span> </span><a href="#local-6989586621679255143"><span class="hs-identifier hs-var">decls</span></a><span>
</span><a name="line-221"></a><span>  </span><a href="Data.Singletons.Partition.html#PDecs"><span class="hs-identifier hs-var">PDecs</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">pd_let_decs</span><span>                </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679255144"><a href="#local-6989586621679255144"><span class="hs-identifier">let_decs</span></a></a><span>
</span><a name="line-222"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">pd_class_decs</span><span>              </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679255145"><a href="#local-6989586621679255145"><span class="hs-identifier">classes</span></a></a><span>
</span><a name="line-223"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">pd_instance_decs</span><span>           </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679255146"><a href="#local-6989586621679255146"><span class="hs-identifier">insts</span></a></a><span>
</span><a name="line-224"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">pd_data_decs</span><span>               </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679255147"><a href="#local-6989586621679255147"><span class="hs-identifier">datas</span></a></a><span>
</span><a name="line-225"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">pd_ty_syn_decs</span><span>             </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679255148"><a href="#local-6989586621679255148"><span class="hs-identifier">ty_syns</span></a></a><span>
</span><a name="line-226"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">pd_open_type_family_decs</span><span>   </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679255149"><a href="#local-6989586621679255149"><span class="hs-identifier">o_tyfams</span></a></a><span>
</span><a name="line-227"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">pd_closed_type_family_decs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679255150"><a href="#local-6989586621679255150"><span class="hs-identifier">c_tyfams</span></a></a><span>
</span><a name="line-228"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">pd_derived_eq_decs</span><span>         </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679255151"><a href="#local-6989586621679255151"><span class="hs-identifier">derived_eq_decs</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Partition.html#partitionDecs"><span class="hs-identifier hs-var">partitionDecs</span></a><span> </span><a href="#local-6989586621679255143"><span class="hs-identifier hs-var">decls</span></a><span>
</span><a name="line-229"></a><span>
</span><a name="line-230"></a><span>  </span><a href="Data.Singletons.Promote.Defun.html#defunTypeDecls"><span class="hs-identifier hs-var">defunTypeDecls</span></a><span> </span><a href="#local-6989586621679255148"><span class="hs-identifier hs-var">ty_syns</span></a><span> </span><a href="#local-6989586621679255150"><span class="hs-identifier hs-var">c_tyfams</span></a><span> </span><a href="#local-6989586621679255149"><span class="hs-identifier hs-var">o_tyfams</span></a><span>
</span><a name="line-231"></a><span>    </span><span class="hs-comment">-- promoteLetDecs returns LetBinds, which we don't need at top level</span><span>
</span><a name="line-232"></a><span>  </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Promote.html#promoteLetDecs"><span class="hs-identifier hs-var">promoteLetDecs</span></a><span> </span><a href="Data.Singletons.Util.html#noPrefix"><span class="hs-identifier hs-var">noPrefix</span></a><span> </span><a href="#local-6989586621679255144"><span class="hs-identifier hs-var">let_decs</span></a><span>
</span><a name="line-233"></a><span>  </span><span class="hs-identifier hs-var">mapM_</span><span> </span><a href="Data.Singletons.Promote.html#promoteClassDec"><span class="hs-identifier hs-var">promoteClassDec</span></a><span> </span><a href="#local-6989586621679255145"><span class="hs-identifier hs-var">classes</span></a><span>
</span><a name="line-234"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679255152"><a href="#local-6989586621679255152"><span class="hs-identifier">orig_meth_sigs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldMap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">lde_types</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">cd_lde</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679255145"><span class="hs-identifier hs-var">classes</span></a><span>
</span><a name="line-235"></a><span>  </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Promote.html#promoteInstanceDec"><span class="hs-identifier hs-var">promoteInstanceDec</span></a><span> </span><a href="#local-6989586621679255152"><span class="hs-identifier hs-var">orig_meth_sigs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679255146"><span class="hs-identifier hs-var">insts</span></a><span>
</span><a name="line-236"></a><span>  </span><span class="hs-identifier hs-var">mapM_</span><span> </span><a href="Data.Singletons.Promote.html#promoteDerivedEqDec"><span class="hs-identifier hs-var">promoteDerivedEqDec</span></a><span>   </span><a href="#local-6989586621679255151"><span class="hs-identifier hs-var">derived_eq_decs</span></a><span>
</span><a name="line-237"></a><span>  </span><a href="Data.Singletons.Promote.html#promoteDataDecs"><span class="hs-identifier hs-var">promoteDataDecs</span></a><span> </span><a href="#local-6989586621679255147"><span class="hs-identifier hs-var">datas</span></a><span>
</span><a name="line-238"></a><span>
</span><a name="line-239"></a><span class="hs-identifier">promoteDataDecs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Data.Singletons.Syntax.html#DataDecl"><span class="hs-identifier hs-type">DataDecl</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-240"></a><a name="promoteDataDecs"><a href="Data.Singletons.Promote.html#promoteDataDecs"><span class="hs-identifier">promoteDataDecs</span></a></a><span> </span><a name="local-6989586621679255153"><a href="#local-6989586621679255153"><span class="hs-identifier">data_decs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-241"></a><span>  </span><a name="local-6989586621679255159"><a href="#local-6989586621679255159"><span class="hs-identifier">rec_selectors</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a><span> </span><a href="#local-6989586621679255154"><span class="hs-identifier hs-var">extract_rec_selectors</span></a><span> </span><a href="#local-6989586621679255153"><span class="hs-identifier hs-var">data_decs</span></a><span>
</span><a name="line-242"></a><span>  </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Promote.html#promoteLetDecs"><span class="hs-identifier hs-var">promoteLetDecs</span></a><span> </span><a href="Data.Singletons.Util.html#noPrefix"><span class="hs-identifier hs-var">noPrefix</span></a><span> </span><a href="#local-6989586621679255159"><span class="hs-identifier hs-var">rec_selectors</span></a><span>
</span><a name="line-243"></a><span>  </span><span class="hs-identifier hs-var">mapM_</span><span> </span><a href="Data.Singletons.Promote.html#promoteDataDec"><span class="hs-identifier hs-var">promoteDataDec</span></a><span> </span><a href="#local-6989586621679255153"><span class="hs-identifier hs-var">data_decs</span></a><span>
</span><a name="line-244"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-245"></a><span>    </span><span class="hs-identifier">extract_rec_selectors</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Singletons.Syntax.html#DataDecl"><span class="hs-identifier hs-type">DataDecl</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DLetDec</span><span class="hs-special">]</span><span>
</span><a name="line-246"></a><span>    </span><a name="local-6989586621679255154"><a href="#local-6989586621679255154"><span class="hs-identifier">extract_rec_selectors</span></a></a><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Syntax.html#DataDecl"><span class="hs-identifier hs-var">DataDecl</span></a><span> </span><a name="local-6989586621679255155"><a href="#local-6989586621679255155"><span class="hs-identifier">data_name</span></a></a><span> </span><a name="local-6989586621679255156"><a href="#local-6989586621679255156"><span class="hs-identifier">tvbs</span></a></a><span> </span><a name="local-6989586621679255157"><a href="#local-6989586621679255157"><span class="hs-identifier">cons</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-247"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679255158"><a href="#local-6989586621679255158"><span class="hs-identifier">arg_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Util.html#foldTypeTvbs"><span class="hs-identifier hs-var">foldTypeTvbs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DConT</span><span> </span><a href="#local-6989586621679255155"><span class="hs-identifier hs-var">data_name</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679255156"><span class="hs-identifier hs-var">tvbs</span></a><span>
</span><a name="line-248"></a><span>      </span><span class="hs-keyword">in</span><span>
</span><a name="line-249"></a><span>      </span><span class="hs-identifier hs-var">getRecordSelectors</span><span> </span><a href="#local-6989586621679255158"><span class="hs-identifier hs-var">arg_ty</span></a><span> </span><a href="#local-6989586621679255157"><span class="hs-identifier hs-var">cons</span></a><span>
</span><a name="line-250"></a><span>
</span><a name="line-251"></a><span class="hs-comment">-- curious about ALetDecEnv? See the LetDecEnv module for an explanation.</span><span>
</span><a name="line-252"></a><span class="hs-identifier">promoteLetDecs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">String</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">String</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- (alpha, symb) prefixes to use</span><span>
</span><a name="line-253"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DLetDec</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="Data.Singletons.Promote.Monad.html#LetBind"><span class="hs-identifier hs-type">LetBind</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="Data.Singletons.Syntax.html#ALetDecEnv"><span class="hs-identifier hs-type">ALetDecEnv</span></a><span class="hs-special">)</span><span>
</span><a name="line-254"></a><span>  </span><span class="hs-comment">-- See Note [Promoting declarations in two stages]</span><span>
</span><a name="line-255"></a><a name="promoteLetDecs"><a href="Data.Singletons.Promote.html#promoteLetDecs"><span class="hs-identifier">promoteLetDecs</span></a></a><span> </span><a name="local-6989586621679255160"><a href="#local-6989586621679255160"><span class="hs-identifier">prefixes</span></a></a><span> </span><a name="local-6989586621679255161"><a href="#local-6989586621679255161"><span class="hs-identifier">decls</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-256"></a><span>  </span><a name="local-6989586621679255162"><a href="#local-6989586621679255162"><span class="hs-identifier">let_dec_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Syntax.html#buildLetDecEnv"><span class="hs-identifier hs-var">buildLetDecEnv</span></a><span> </span><a href="#local-6989586621679255161"><span class="hs-identifier hs-var">decls</span></a><span>
</span><a name="line-257"></a><span>  </span><a name="local-6989586621679255163"><a href="#local-6989586621679255163"><span class="hs-identifier">all_locals</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Promote.Monad.html#allLocals"><span class="hs-identifier hs-var">allLocals</span></a><span>
</span><a name="line-258"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679255164"><a href="#local-6989586621679255164"><span class="hs-identifier">binds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679255165"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">,</span><span> </span><a href="Data.Singletons.Util.html#foldType"><span class="hs-identifier hs-var">foldType</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DConT</span><span> </span><a href="#local-6989586621679255167"><span class="hs-identifier hs-var">sym</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">DVarT</span><span> </span><a href="#local-6989586621679255163"><span class="hs-identifier hs-var">all_locals</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-259"></a><span>              </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621679255165"><a href="#local-6989586621679255165"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">Map.keys</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">lde_defns</span><span> </span><a href="#local-6989586621679255162"><span class="hs-identifier hs-var">let_dec_env</span></a><span>
</span><a name="line-260"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679255166"><a href="#local-6989586621679255166"><span class="hs-identifier">proName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Names.html#promoteValNameLhsPrefix"><span class="hs-identifier hs-var">promoteValNameLhsPrefix</span></a><span> </span><a href="#local-6989586621679255160"><span class="hs-identifier hs-var">prefixes</span></a><span> </span><a href="#local-6989586621679255165"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-261"></a><span>                    </span><a name="local-6989586621679255167"><a href="#local-6989586621679255167"><span class="hs-identifier">sym</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Names.html#promoteTySym"><span class="hs-identifier hs-var">promoteTySym</span></a><span> </span><a href="#local-6989586621679255166"><span class="hs-identifier hs-var">proName</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679255163"><span class="hs-identifier hs-var">all_locals</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-262"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679255168"><a href="#local-6989586621679255168"><span class="hs-identifier">decs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679255169"><a href="#local-6989586621679255169"><span class="hs-identifier">let_dec_env'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Promote.Monad.html#letBind"><span class="hs-identifier hs-var">letBind</span></a><span> </span><a href="#local-6989586621679255164"><span class="hs-identifier hs-var">binds</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Singletons.Promote.html#promoteLetDecEnv"><span class="hs-identifier hs-var">promoteLetDecEnv</span></a><span> </span><a href="#local-6989586621679255160"><span class="hs-identifier hs-var">prefixes</span></a><span> </span><a href="#local-6989586621679255162"><span class="hs-identifier hs-var">let_dec_env</span></a><span>
</span><a name="line-263"></a><span>  </span><a href="Data.Singletons.Promote.Monad.html#emitDecs"><span class="hs-identifier hs-var">emitDecs</span></a><span> </span><a href="#local-6989586621679255168"><span class="hs-identifier hs-var">decs</span></a><span>
</span><a name="line-264"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679255164"><span class="hs-identifier hs-var">binds</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679255169"><span class="hs-identifier hs-var">let_dec_env'</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">lde_proms</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.fromList</span><span> </span><a href="#local-6989586621679255164"><span class="hs-identifier hs-var">binds</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-265"></a><span>
</span><a name="line-266"></a><span class="hs-comment">-- Promotion of data types to kinds is automatic (see &quot;Giving Haskell a</span><span>
</span><a name="line-267"></a><span class="hs-comment">-- Promotion&quot; paper for more details). Here we &quot;plug into&quot; the promotion</span><span>
</span><a name="line-268"></a><span class="hs-comment">-- mechanism to add some extra stuff to the promotion:</span><span>
</span><a name="line-269"></a><span class="hs-comment">--</span><span>
</span><a name="line-270"></a><span class="hs-comment">--  * if data type derives Eq we generate a type family that implements the</span><span>
</span><a name="line-271"></a><span class="hs-comment">--    equality test for the data type.</span><span>
</span><a name="line-272"></a><span class="hs-comment">--</span><span>
</span><a name="line-273"></a><span class="hs-comment">--  * for each data constructor with arity greater than 0 we generate type level</span><span>
</span><a name="line-274"></a><span class="hs-comment">--    symbols for use with Apply type family. In this way promoted data</span><span>
</span><a name="line-275"></a><span class="hs-comment">--    constructors and promoted functions can be used in a uniform way at the</span><span>
</span><a name="line-276"></a><span class="hs-comment">--    type level in the same way they can be used uniformly at the type level.</span><span>
</span><a name="line-277"></a><span class="hs-comment">--</span><span>
</span><a name="line-278"></a><span class="hs-comment">--  * for each nullary data constructor we generate a type synonym</span><span>
</span><a name="line-279"></a><span class="hs-identifier">promoteDataDec</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Singletons.Syntax.html#DataDecl"><span class="hs-identifier hs-type">DataDecl</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-280"></a><a name="promoteDataDec"><a href="Data.Singletons.Promote.html#promoteDataDec"><span class="hs-identifier">promoteDataDec</span></a></a><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Syntax.html#DataDecl"><span class="hs-identifier hs-var">DataDecl</span></a><span> </span><a name="local-6989586621679255170"><a href="#local-6989586621679255170"><span class="hs-identifier">_name</span></a></a><span> </span><a name="local-6989586621679255171"><a href="#local-6989586621679255171"><span class="hs-identifier">_tvbs</span></a></a><span> </span><a name="local-6989586621679255172"><a href="#local-6989586621679255172"><span class="hs-identifier">ctors</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-281"></a><span>  </span><a name="local-6989586621679255173"><a href="#local-6989586621679255173"><span class="hs-identifier">ctorSyms</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Promote.Defun.html#buildDefunSymsDataD"><span class="hs-identifier hs-var">buildDefunSymsDataD</span></a><span> </span><a href="#local-6989586621679255172"><span class="hs-identifier hs-var">ctors</span></a><span>
</span><a name="line-282"></a><span>  </span><a href="Data.Singletons.Promote.Monad.html#emitDecs"><span class="hs-identifier hs-var">emitDecs</span></a><span> </span><a href="#local-6989586621679255173"><span class="hs-identifier hs-var">ctorSyms</span></a><span>
</span><a name="line-283"></a><span>
</span><a name="line-284"></a><span class="hs-comment">-- Note [CUSKification]</span><span>
</span><a name="line-285"></a><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~</span><span>
</span><a name="line-286"></a><span class="hs-comment">-- GHC #12928 means that sometimes, this TH code will produce a declaration</span><span>
</span><a name="line-287"></a><span class="hs-comment">-- that has a kind signature even when we want kind inference to work. There</span><span>
</span><a name="line-288"></a><span class="hs-comment">-- seems to be no way to avoid this, so we embrace it:</span><span>
</span><a name="line-289"></a><span class="hs-comment">--</span><span>
</span><a name="line-290"></a><span class="hs-comment">--   * If a class type variable has no explicit kind, we make no effort to</span><span>
</span><a name="line-291"></a><span class="hs-comment">--     guess it and default to *. This is OK because before GHC 8.0, we were</span><span>
</span><a name="line-292"></a><span class="hs-comment">--     limited by KProxy anyway.</span><span>
</span><a name="line-293"></a><span class="hs-comment">--</span><span>
</span><a name="line-294"></a><span class="hs-comment">--   * If a class type variable has an explicit kind, it is preserved.</span><span>
</span><a name="line-295"></a><span class="hs-comment">--</span><span>
</span><a name="line-296"></a><span class="hs-comment">-- This way, we always get proper CUSKs where we need them.</span><span>
</span><a name="line-297"></a><span>
</span><a name="line-298"></a><span class="hs-identifier">promoteClassDec</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Singletons.Syntax.html#UClassDecl"><span class="hs-identifier hs-type">UClassDecl</span></a><span>
</span><a name="line-299"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a><span> </span><a href="Data.Singletons.Syntax.html#AClassDecl"><span class="hs-identifier hs-type">AClassDecl</span></a><span>
</span><a name="line-300"></a><a name="promoteClassDec"><a href="Data.Singletons.Promote.html#promoteClassDec"><span class="hs-identifier">promoteClassDec</span></a></a><span> </span><a name="local-6989586621679255174"><a href="#local-6989586621679255174"><span class="hs-identifier">decl</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Data.Singletons.Syntax.html#ClassDecl"><span class="hs-identifier hs-var">ClassDecl</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cd_cxt</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679255175"><a href="#local-6989586621679255175"><span class="hs-identifier">cxt</span></a></a><span>
</span><a name="line-301"></a><span>                                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cd_name</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679255176"><a href="#local-6989586621679255176"><span class="hs-identifier">cls_name</span></a></a><span>
</span><a name="line-302"></a><span>                                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cd_tvbs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679255177"><a href="#local-6989586621679255177"><span class="hs-identifier">tvbs'</span></a></a><span>
</span><a name="line-303"></a><span>                                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cd_fds</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679255178"><a href="#local-6989586621679255178"><span class="hs-identifier">fundeps</span></a></a><span>
</span><a name="line-304"></a><span>                                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cd_lde</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679255179"><a href="#local-6989586621679255179"><span class="hs-identifier">lde</span></a></a><span class="hs-glyph">@</span><a href="Data.Singletons.Syntax.html#LetDecEnv"><span class="hs-identifier hs-var">LetDecEnv</span></a><span>
</span><a name="line-305"></a><span>                                    </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">lde_defns</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679255180"><a href="#local-6989586621679255180"><span class="hs-identifier">defaults</span></a></a><span>
</span><a name="line-306"></a><span>                                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">lde_types</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679255181"><a href="#local-6989586621679255181"><span class="hs-identifier">meth_sigs</span></a></a><span>
</span><a name="line-307"></a><span>                                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">lde_infix</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679255182"><a href="#local-6989586621679255182"><span class="hs-identifier">infix_decls</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-308"></a><span>  </span><span class="hs-keyword">let</span><span>
</span><a name="line-309"></a><span>    </span><span class="hs-comment">-- a workaround for GHC Trac #12928; see Note [CUSKification]</span><span>
</span><a name="line-310"></a><span>    </span><a name="local-6989586621679255202"><a href="#local-6989586621679255202"><span class="hs-identifier">tvbs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="Data.Singletons.Util.html#cuskify"><span class="hs-identifier hs-var">cuskify</span></a><span> </span><a href="#local-6989586621679255177"><span class="hs-identifier hs-var">tvbs'</span></a><span>
</span><a name="line-311"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679255203"><a href="#local-6989586621679255203"><span class="hs-identifier">pClsName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Names.html#promoteClassName"><span class="hs-identifier hs-var">promoteClassName</span></a><span> </span><a href="#local-6989586621679255176"><span class="hs-identifier hs-var">cls_name</span></a><span>
</span><a name="line-312"></a><span>  </span><a name="local-6989586621679255204"><a href="#local-6989586621679255204"><span class="hs-identifier">pCxt</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="#local-6989586621679255187"><span class="hs-identifier hs-var">promote_superclass_pred</span></a><span> </span><a href="#local-6989586621679255175"><span class="hs-identifier hs-var">cxt</span></a><span>
</span><a name="line-313"></a><span>  </span><a href="Data.Singletons.Promote.Monad.html#forallBind"><span class="hs-identifier hs-var">forallBind</span></a><span> </span><a href="#local-6989586621679255185"><span class="hs-identifier hs-var">cls_kvs_to_bind</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-314"></a><span>    </span><a name="local-6989586621679255205"><a href="#local-6989586621679255205"><span class="hs-identifier">sig_decs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">uncurry</span><span> </span><a href="#local-6989586621679255186"><span class="hs-identifier hs-var">promote_sig</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.toList</span><span> </span><a href="#local-6989586621679255181"><span class="hs-identifier hs-var">meth_sigs</span></a><span class="hs-special">)</span><span>
</span><a name="line-315"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679255206"><a href="#local-6989586621679255206"><span class="hs-identifier">defaults_list</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.toList</span><span> </span><a href="#local-6989586621679255180"><span class="hs-identifier hs-var">defaults</span></a><span>
</span><a name="line-316"></a><span>        </span><a name="local-6989586621679255207"><a href="#local-6989586621679255207"><span class="hs-identifier">defaults_names</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621679255206"><span class="hs-identifier hs-var">defaults_list</span></a><span>
</span><a name="line-317"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621679255208"><a href="#local-6989586621679255208"><span class="hs-identifier">default_decs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679255209"><a href="#local-6989586621679255209"><span class="hs-identifier">ann_rhss</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679255210"><a href="#local-6989586621679255210"><span class="hs-identifier">prom_rhss</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-318"></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Util.html#mapAndUnzip3M"><span class="hs-identifier hs-var">mapAndUnzip3M</span></a><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Promote.html#promoteMethod"><span class="hs-identifier hs-var">promoteMethod</span></a><span> </span><span class="hs-identifier hs-var">Map.empty</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621679255181"><span class="hs-identifier hs-var">meth_sigs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679255206"><span class="hs-identifier hs-var">defaults_list</span></a><span>
</span><a name="line-319"></a><span>
</span><a name="line-320"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679255211"><a href="#local-6989586621679255211"><span class="hs-identifier">infix_decls'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">catMaybes</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">uncurry</span><span> </span><a href="Data.Singletons.Promote.html#promoteInfixDecl"><span class="hs-identifier hs-var">promoteInfixDecl</span></a><span class="hs-special">)</span><span>
</span><a name="line-321"></a><span>                                 </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Map.toList</span><span> </span><a href="#local-6989586621679255182"><span class="hs-identifier hs-var">infix_decls</span></a><span>
</span><a name="line-322"></a><span>
</span><a name="line-323"></a><span>    </span><span class="hs-comment">-- no need to do anything to the fundeps. They work as is!</span><span>
</span><a name="line-324"></a><span>    </span><a href="Data.Singletons.Promote.Monad.html#emitDecs"><span class="hs-identifier hs-var">emitDecs</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">DClassD</span><span> </span><a href="#local-6989586621679255204"><span class="hs-identifier hs-var">pCxt</span></a><span> </span><a href="#local-6989586621679255203"><span class="hs-identifier hs-var">pClsName</span></a><span> </span><a href="#local-6989586621679255202"><span class="hs-identifier hs-var">tvbs</span></a><span> </span><a href="#local-6989586621679255178"><span class="hs-identifier hs-var">fundeps</span></a><span>
</span><a name="line-325"></a><span>                      </span><span class="hs-special">(</span><a href="#local-6989586621679255205"><span class="hs-identifier hs-var">sig_decs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679255208"><span class="hs-identifier hs-var">default_decs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679255211"><span class="hs-identifier hs-var">infix_decls'</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-326"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679255212"><a href="#local-6989586621679255212"><span class="hs-identifier">defaults_list'</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621679255207"><span class="hs-identifier hs-var">defaults_names</span></a><span> </span><a href="#local-6989586621679255209"><span class="hs-identifier hs-var">ann_rhss</span></a><span>
</span><a name="line-327"></a><span>        </span><a name="local-6989586621679255213"><a href="#local-6989586621679255213"><span class="hs-identifier">proms</span></a></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621679255207"><span class="hs-identifier hs-var">defaults_names</span></a><span> </span><a href="#local-6989586621679255210"><span class="hs-identifier hs-var">prom_rhss</span></a><span>
</span><a name="line-328"></a><span>        </span><a name="local-6989586621679255214"><a href="#local-6989586621679255214"><span class="hs-identifier">cls_kvs_to_bind'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679255185"><span class="hs-identifier hs-var">cls_kvs_to_bind</span></a><span> </span><span class="hs-operator hs-var">&lt;$</span><span> </span><a href="#local-6989586621679255181"><span class="hs-identifier hs-var">meth_sigs</span></a><span>
</span><a name="line-329"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679255174"><span class="hs-identifier hs-var">decl</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cd_lde</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679255179"><span class="hs-identifier hs-var">lde</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">lde_defns</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.fromList</span><span> </span><a href="#local-6989586621679255212"><span class="hs-identifier hs-var">defaults_list'</span></a><span>
</span><a name="line-330"></a><span>                                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">lde_proms</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.fromList</span><span> </span><a href="#local-6989586621679255213"><span class="hs-identifier hs-var">proms</span></a><span>
</span><a name="line-331"></a><span>                                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">lde_bound_kvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679255214"><span class="hs-identifier hs-var">cls_kvs_to_bind'</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-332"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-333"></a><span>    </span><span class="hs-identifier">cls_kvb_names</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cls_tvb_names</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cls_kvs_to_bind</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Set</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-334"></a><span>    </span><a name="local-6989586621679255183"><a href="#local-6989586621679255183"><span class="hs-identifier">cls_kvb_names</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldMap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">foldMap</span><span> </span><span class="hs-identifier hs-var">fvDType</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Data.Singletons.Util.html#extractTvbKind"><span class="hs-identifier hs-var">extractTvbKind</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679255177"><span class="hs-identifier hs-var">tvbs'</span></a><span>
</span><a name="line-335"></a><span>    </span><a name="local-6989586621679255184"><a href="#local-6989586621679255184"><span class="hs-identifier">cls_tvb_names</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Set.fromList</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="Data.Singletons.Util.html#extractTvbName"><span class="hs-identifier hs-var">extractTvbName</span></a><span> </span><a href="#local-6989586621679255177"><span class="hs-identifier hs-var">tvbs'</span></a><span>
</span><a name="line-336"></a><span>    </span><a name="local-6989586621679255185"><a href="#local-6989586621679255185"><span class="hs-identifier">cls_kvs_to_bind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679255183"><span class="hs-identifier hs-var">cls_kvb_names</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">Set.union</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679255184"><span class="hs-identifier hs-var">cls_tvb_names</span></a><span>
</span><a name="line-337"></a><span>
</span><a name="line-338"></a><span>    </span><span class="hs-identifier">promote_sig</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a><span> </span><span class="hs-identifier hs-type">DDec</span><span>
</span><a name="line-339"></a><span>    </span><a name="local-6989586621679255186"><a href="#local-6989586621679255186"><span class="hs-identifier">promote_sig</span></a></a><span> </span><a name="local-6989586621679255188"><a href="#local-6989586621679255188"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621679255189"><a href="#local-6989586621679255189"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-340"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679255190"><a href="#local-6989586621679255190"><span class="hs-identifier">proName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Names.html#promoteValNameLhs"><span class="hs-identifier hs-var">promoteValNameLhs</span></a><span> </span><a href="#local-6989586621679255188"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-341"></a><span>      </span><span class="hs-special">(</span><a name="local-6989586621679255191"><a href="#local-6989586621679255191"><span class="hs-identifier">argKs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679255192"><a href="#local-6989586621679255192"><span class="hs-identifier">resK</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Promote.Type.html#promoteUnraveled"><span class="hs-identifier hs-var">promoteUnraveled</span></a><span> </span><a href="#local-6989586621679255189"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-342"></a><span>      </span><a name="local-6989586621679255193"><a href="#local-6989586621679255193"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">qNewName</span><span> </span><span class="hs-string">&quot;arg&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679255191"><span class="hs-identifier hs-var">argKs</span></a><span>
</span><a name="line-343"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679255194"><a href="#local-6989586621679255194"><span class="hs-identifier">tvbs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">zipWith</span><span> </span><span class="hs-identifier hs-var">DKindedTV</span><span> </span><a href="#local-6989586621679255193"><span class="hs-identifier hs-var">args</span></a><span> </span><a href="#local-6989586621679255191"><span class="hs-identifier hs-var">argKs</span></a><span>
</span><a name="line-344"></a><span>      </span><a href="Data.Singletons.Promote.Monad.html#emitDecsM"><span class="hs-identifier hs-var">emitDecsM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Singletons.Promote.Defun.html#defunReifyFixity"><span class="hs-identifier hs-var">defunReifyFixity</span></a><span> </span><a href="#local-6989586621679255190"><span class="hs-identifier hs-var">proName</span></a><span> </span><a href="#local-6989586621679255194"><span class="hs-identifier hs-var">tvbs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679255192"><span class="hs-identifier hs-var">resK</span></a><span class="hs-special">)</span><span>
</span><a name="line-345"></a><span>
</span><a name="line-346"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">DOpenTypeFamilyD</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DTypeFamilyHead</span><span> </span><a href="#local-6989586621679255190"><span class="hs-identifier hs-var">proName</span></a><span>
</span><a name="line-347"></a><span>                                                 </span><a href="#local-6989586621679255194"><span class="hs-identifier hs-var">tvbs</span></a><span>
</span><a name="line-348"></a><span>                                                 </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DKindSig</span><span> </span><a href="#local-6989586621679255192"><span class="hs-identifier hs-var">resK</span></a><span class="hs-special">)</span><span>
</span><a name="line-349"></a><span>                                                 </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span>
</span><a name="line-350"></a><span>
</span><a name="line-351"></a><span>    </span><span class="hs-identifier">promote_superclass_pred</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DPred</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a><span> </span><span class="hs-identifier hs-type">DPred</span><span>
</span><a name="line-352"></a><span>    </span><a name="local-6989586621679255187"><a href="#local-6989586621679255187"><span class="hs-identifier">promote_superclass_pred</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679255195"><span class="hs-identifier hs-var">go</span></a><span>
</span><a name="line-353"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-354"></a><span>      </span><a name="local-6989586621679255195"><a href="#local-6989586621679255195"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DForallPr</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-string">&quot;Cannot promote quantified constraints&quot;</span><span>
</span><a name="line-355"></a><span>      </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DAppPr</span><span> </span><a name="local-6989586621679255196"><a href="#local-6989586621679255196"><span class="hs-identifier">pr</span></a></a><span> </span><a name="local-6989586621679255197"><a href="#local-6989586621679255197"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">DAppPr</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679255195"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679255196"><span class="hs-identifier hs-var">pr</span></a><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><a href="Data.Singletons.Promote.Type.html#promoteType"><span class="hs-identifier hs-var">promoteType</span></a><span> </span><a href="#local-6989586621679255197"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-356"></a><span>      </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DSigPr</span><span> </span><a name="local-6989586621679255198"><a href="#local-6989586621679255198"><span class="hs-identifier">pr</span></a></a><span> </span><a name="local-6989586621679255199"><a href="#local-6989586621679255199"><span class="hs-identifier">_k</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679255195"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679255198"><span class="hs-identifier hs-var">pr</span></a><span>    </span><span class="hs-comment">-- just ignore the kind; it can't matter</span><span>
</span><a name="line-357"></a><span>      </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DVarPr</span><span> </span><a name="local-6989586621679255200"><a href="#local-6989586621679255200"><span class="hs-identifier">name</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Cannot promote ConstraintKinds variables like &quot;</span><span>
</span><a name="line-358"></a><span>                              </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679255200"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-359"></a><span>      </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DConPr</span><span> </span><a name="local-6989586621679255201"><a href="#local-6989586621679255201"><span class="hs-identifier">name</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">DConPr</span><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Names.html#promoteClassName"><span class="hs-identifier hs-var">promoteClassName</span></a><span> </span><a href="#local-6989586621679255201"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-360"></a><span>      </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier hs-var">DWildCardPr</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">DWildCardPr</span><span>
</span><a name="line-361"></a><span>
</span><a name="line-362"></a><span class="hs-comment">-- returns (unpromoted method name, ALetDecRHS) pairs</span><span>
</span><a name="line-363"></a><span class="hs-identifier">promoteInstanceDec</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-identifier hs-type">DType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Syntax.html#UInstDecl"><span class="hs-identifier hs-type">UInstDecl</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a><span> </span><a href="Data.Singletons.Syntax.html#AInstDecl"><span class="hs-identifier hs-type">AInstDecl</span></a><span>
</span><a name="line-364"></a><a name="promoteInstanceDec"><a href="Data.Singletons.Promote.html#promoteInstanceDec"><span class="hs-identifier">promoteInstanceDec</span></a></a><span> </span><a name="local-6989586621679255215"><a href="#local-6989586621679255215"><span class="hs-identifier">orig_meth_sigs</span></a></a><span>
</span><a name="line-365"></a><span>                   </span><a name="local-6989586621679255216"><a href="#local-6989586621679255216"><span class="hs-identifier">decl</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Data.Singletons.Syntax.html#InstDecl"><span class="hs-identifier hs-var">InstDecl</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">id_name</span><span>     </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679255217"><a href="#local-6989586621679255217"><span class="hs-identifier">cls_name</span></a></a><span>
</span><a name="line-366"></a><span>                                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">id_arg_tys</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679255218"><a href="#local-6989586621679255218"><span class="hs-identifier">inst_tys</span></a></a><span>
</span><a name="line-367"></a><span>                                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">id_sigs</span><span>     </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679255219"><a href="#local-6989586621679255219"><span class="hs-identifier">inst_sigs</span></a></a><span>
</span><a name="line-368"></a><span>                                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">id_meths</span><span>    </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679255220"><a href="#local-6989586621679255220"><span class="hs-identifier">meths</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-369"></a><span>  </span><a name="local-6989586621679255230"><a href="#local-6989586621679255230"><span class="hs-identifier">cls_tvb_names</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679255222"><span class="hs-identifier hs-var">lookup_cls_tvb_names</span></a><span>
</span><a name="line-370"></a><span>  </span><a name="local-6989586621679255231"><a href="#local-6989586621679255231"><span class="hs-identifier">inst_kis</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="Data.Singletons.Promote.Type.html#promoteType"><span class="hs-identifier hs-var">promoteType</span></a><span> </span><a href="#local-6989586621679255218"><span class="hs-identifier hs-var">inst_tys</span></a><span>
</span><a name="line-371"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679255232"><a href="#local-6989586621679255232"><span class="hs-identifier">kvs_to_bind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldMap</span><span> </span><span class="hs-identifier hs-var">fvDType</span><span> </span><a href="#local-6989586621679255231"><span class="hs-identifier hs-var">inst_kis</span></a><span>
</span><a name="line-372"></a><span>  </span><a href="Data.Singletons.Promote.Monad.html#forallBind"><span class="hs-identifier hs-var">forallBind</span></a><span> </span><a href="#local-6989586621679255232"><span class="hs-identifier hs-var">kvs_to_bind</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-373"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679255233"><a href="#local-6989586621679255233"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.fromList</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621679255230"><span class="hs-identifier hs-var">cls_tvb_names</span></a><span> </span><a href="#local-6989586621679255231"><span class="hs-identifier hs-var">inst_kis</span></a><span>
</span><a name="line-374"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621679255234"><a href="#local-6989586621679255234"><span class="hs-identifier">meths'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679255235"><a href="#local-6989586621679255235"><span class="hs-identifier">ann_rhss</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Util.html#mapAndUnzip3M"><span class="hs-identifier hs-var">mapAndUnzip3M</span></a><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Promote.html#promoteMethod"><span class="hs-identifier hs-var">promoteMethod</span></a><span> </span><a href="#local-6989586621679255219"><span class="hs-identifier hs-var">inst_sigs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679255233"><span class="hs-identifier hs-var">subst</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679255215"><span class="hs-identifier hs-var">orig_meth_sigs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679255220"><span class="hs-identifier hs-var">meths</span></a><span>
</span><a name="line-375"></a><span>    </span><a href="Data.Singletons.Promote.Monad.html#emitDecs"><span class="hs-identifier hs-var">emitDecs</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">DInstanceD</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Util.html#foldType"><span class="hs-identifier hs-var">foldType</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DConT</span><span> </span><a href="#local-6989586621679255221"><span class="hs-identifier hs-var">pClsName</span></a><span class="hs-special">)</span><span>
</span><a name="line-376"></a><span>                                      </span><a href="#local-6989586621679255231"><span class="hs-identifier hs-var">inst_kis</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679255234"><span class="hs-identifier hs-var">meths'</span></a><span class="hs-special">]</span><span>
</span><a name="line-377"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679255216"><span class="hs-identifier hs-var">decl</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">id_meths</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">zip</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621679255220"><span class="hs-identifier hs-var">meths</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679255235"><span class="hs-identifier hs-var">ann_rhss</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-378"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-379"></a><span>    </span><a name="local-6989586621679255221"><a href="#local-6989586621679255221"><span class="hs-identifier">pClsName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Names.html#promoteClassName"><span class="hs-identifier hs-var">promoteClassName</span></a><span> </span><a href="#local-6989586621679255217"><span class="hs-identifier hs-var">cls_name</span></a><span>
</span><a name="line-380"></a><span>
</span><a name="line-381"></a><span>    </span><span class="hs-identifier">lookup_cls_tvb_names</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span>
</span><a name="line-382"></a><span>    </span><a name="local-6989586621679255222"><a href="#local-6989586621679255222"><span class="hs-identifier">lookup_cls_tvb_names</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-383"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679255224"><a href="#local-6989586621679255224"><span class="hs-identifier">mk_tvb_names</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679255223"><span class="hs-identifier hs-var">extract_tvb_names</span></a><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Util.html#dsReifyTypeNameInfo"><span class="hs-identifier hs-var">dsReifyTypeNameInfo</span></a><span> </span><a href="#local-6989586621679255221"><span class="hs-identifier hs-var">pClsName</span></a><span class="hs-special">)</span><span>
</span><a name="line-384"></a><span>                     </span><span class="hs-operator hs-var">&lt;|&gt;</span><span> </span><a href="#local-6989586621679255223"><span class="hs-identifier hs-var">extract_tvb_names</span></a><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Util.html#dsReifyTypeNameInfo"><span class="hs-identifier hs-var">dsReifyTypeNameInfo</span></a><span> </span><a href="#local-6989586621679255217"><span class="hs-identifier hs-var">cls_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-385"></a><span>                      </span><span class="hs-comment">-- See Note [Using dsReifyTypeNameInfo when promoting instances]</span><span>
</span><a name="line-386"></a><span>      </span><a name="local-6989586621679255225"><a href="#local-6989586621679255225"><span class="hs-identifier">mb_tvb_names</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">runMaybeT</span><span> </span><a href="#local-6989586621679255224"><span class="hs-identifier hs-var">mk_tvb_names</span></a><span>
</span><a name="line-387"></a><span>      </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679255225"><span class="hs-identifier hs-var">mb_tvb_names</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-388"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679255226"><a href="#local-6989586621679255226"><span class="hs-identifier">tvb_names</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621679255226"><span class="hs-identifier hs-var">tvb_names</span></a><span>
</span><a name="line-389"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Cannot find class declaration annotation for &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679255217"><span class="hs-identifier hs-var">cls_name</span></a><span>
</span><a name="line-390"></a><span>
</span><a name="line-391"></a><span>    </span><span class="hs-identifier">extract_tvb_names</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">DInfo</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">MaybeT</span><span> </span><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span>
</span><a name="line-392"></a><span>    </span><a name="local-6989586621679255223"><a href="#local-6989586621679255223"><span class="hs-identifier">extract_tvb_names</span></a></a><span> </span><a name="local-6989586621679255227"><a href="#local-6989586621679255227"><span class="hs-identifier">reify_info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-393"></a><span>      </span><a name="local-6989586621679255228"><a href="#local-6989586621679255228"><span class="hs-identifier">mb_info</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">lift</span><span> </span><a href="#local-6989586621679255227"><span class="hs-identifier hs-var">reify_info</span></a><span>
</span><a name="line-394"></a><span>      </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679255228"><span class="hs-identifier hs-var">mb_info</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-395"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DTyConI</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DClassD</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679255229"><a href="#local-6989586621679255229"><span class="hs-identifier">tvbs</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-396"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="Data.Singletons.Util.html#extractTvbName"><span class="hs-identifier hs-var">extractTvbName</span></a><span> </span><a href="#local-6989586621679255229"><span class="hs-identifier hs-var">tvbs</span></a><span>
</span><a name="line-397"></a><span>        </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">empty</span><span>
</span><a name="line-398"></a><span>
</span><a name="line-399"></a><span class="hs-comment">{-
Note [Using dsReifyTypeNameInfo when promoting instances]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
During the promotion of a class instance, it becomes necessary to reify the
original promoted class's info to learn various things. It's tempting to think
that just calling dsReify on the class name will be sufficient, but it's not.
Consider this class and its promotion:

  class Eq a where
    (==) :: a -&gt; a -&gt; Bool

  class PEq a where
    type (==) (x :: a) (y :: a) :: Bool

Notice how both of these classes have an identifier named (==), one at the
value level, and one at the type level. Now imagine what happens when you
attempt to promote this Template Haskell declaration:

   [d| f :: Bool
       f = () == () |]

When promoting ==, singletons will come up with its promoted equivalent (which also
happens to be ==). However, this promoted name is a raw Name, since it is created
with mkName. This becomes an issue when we call dsReify the raw &quot;==&quot; Name, as
Template Haskell has to arbitrarily choose between reifying the info for the
value-level (==) and the type-level (==), and in this case, it happens to pick the
value-level (==) info. We want the type-level (==) info, however, because we care
about the promoted version of (==).

Fortunately, there's a serviceable workaround. Instead of dsReify, we can use
dsReifyTypeNameInfo, which first calls lookupTypeName (to ensure we can find a Name
that's in the type namespace) and _then_ reifies it.
-}</span><span>
</span><a name="line-432"></a><span>
</span><a name="line-433"></a><span class="hs-identifier">promoteMethod</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-identifier hs-type">DType</span><span> </span><span class="hs-comment">-- InstanceSigs for methods</span><span>
</span><a name="line-434"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Map</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-identifier hs-type">DKind</span><span class="hs-special">)</span><span>
</span><a name="line-435"></a><span>                    </span><span class="hs-comment">-- ^ instantiations for class tyvars (Nothing for default decls)</span><span>
</span><a name="line-436"></a><span>                    </span><span class="hs-comment">--   See Note [Promoted class method kinds]</span><span>
</span><a name="line-437"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-identifier hs-type">DType</span><span>     </span><span class="hs-comment">-- method types</span><span>
</span><a name="line-438"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span> </span><a href="Data.Singletons.Syntax.html#ULetDecRHS"><span class="hs-identifier hs-type">ULetDecRHS</span></a><span class="hs-special">)</span><span>
</span><a name="line-439"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DDec</span><span class="hs-special">,</span><span> </span><a href="Data.Singletons.Syntax.html#ALetDecRHS"><span class="hs-identifier hs-type">ALetDecRHS</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">DType</span><span class="hs-special">)</span><span>
</span><a name="line-440"></a><span>                 </span><span class="hs-comment">-- returns (type instance, ALetDecRHS, promoted RHS)</span><span>
</span><a name="line-441"></a><a name="promoteMethod"><a href="Data.Singletons.Promote.html#promoteMethod"><span class="hs-identifier">promoteMethod</span></a></a><span> </span><a name="local-6989586621679255236"><a href="#local-6989586621679255236"><span class="hs-identifier">inst_sigs_map</span></a></a><span> </span><a name="local-6989586621679255237"><a href="#local-6989586621679255237"><span class="hs-identifier">m_subst</span></a></a><span> </span><a name="local-6989586621679255238"><a href="#local-6989586621679255238"><span class="hs-identifier">orig_sigs_map</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679255239"><a href="#local-6989586621679255239"><span class="hs-identifier">meth_name</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679255240"><a href="#local-6989586621679255240"><span class="hs-identifier">meth_rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-442"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679255257"><a href="#local-6989586621679255257"><span class="hs-identifier">meth_arg_kis</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679255258"><a href="#local-6989586621679255258"><span class="hs-identifier">meth_res_ki</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679255242"><span class="hs-identifier hs-var">lookup_meth_ty</span></a><span>
</span><a name="line-443"></a><span>  </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679255259"><a href="#local-6989586621679255259"><span class="hs-identifier">eqns</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679255260"><a href="#local-6989586621679255260"><span class="hs-identifier">_defuns</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679255261"><a href="#local-6989586621679255261"><span class="hs-identifier">ann_rhs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-444"></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Promote.html#promoteLetDecRHS"><span class="hs-identifier hs-var">promoteLetDecRHS</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679255257"><span class="hs-identifier hs-var">meth_arg_kis</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679255258"><span class="hs-identifier hs-var">meth_res_ki</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">Map.empty</span><span> </span><span class="hs-identifier hs-var">Map.empty</span><span>
</span><a name="line-445"></a><span>                        </span><a href="Data.Singletons.Util.html#noPrefix"><span class="hs-identifier hs-var">noPrefix</span></a><span> </span><a href="#local-6989586621679255239"><span class="hs-identifier hs-var">meth_name</span></a><span> </span><a href="#local-6989586621679255240"><span class="hs-identifier hs-var">meth_rhs</span></a><span>
</span><a name="line-446"></a><span>  </span><a name="local-6989586621679255262"><a href="#local-6989586621679255262"><span class="hs-identifier">meth_arg_tvs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">qNewName</span><span> </span><span class="hs-string">&quot;a&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679255257"><span class="hs-identifier hs-var">meth_arg_kis</span></a><span>
</span><a name="line-447"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679255263"><a href="#local-6989586621679255263"><span class="hs-identifier">helperNameBase</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">nameBase</span><span> </span><a href="#local-6989586621679255241"><span class="hs-identifier hs-var">proName</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-448"></a><span>                         </span><a name="local-6989586621679255265"><a href="#local-6989586621679255265"><span class="hs-identifier">first</span></a></a><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Util.html#isHsLetter"><span class="hs-identifier hs-var">isHsLetter</span></a><span> </span><a href="#local-6989586621679255265"><span class="hs-identifier hs-var">first</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-string">&quot;TFHelper&quot;</span><span>
</span><a name="line-449"></a><span>                         </span><a name="local-6989586621679255266"><a href="#local-6989586621679255266"><span class="hs-identifier">alpha</span></a></a><span>                            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679255266"><span class="hs-identifier hs-var">alpha</span></a><span>
</span><a name="line-450"></a><span>
</span><a name="line-451"></a><span>      </span><span class="hs-comment">-- family_args are the type variables in a promoted class's</span><span>
</span><a name="line-452"></a><span>      </span><span class="hs-comment">-- associated type family instance (or default implementation), e.g.,</span><span>
</span><a name="line-453"></a><span>      </span><span class="hs-comment">--</span><span>
</span><a name="line-454"></a><span>      </span><span class="hs-comment">--   class C k where</span><span>
</span><a name="line-455"></a><span>      </span><span class="hs-comment">--     type T (a :: k) (b :: Bool)</span><span>
</span><a name="line-456"></a><span>      </span><span class="hs-comment">--     type T a b = THelper1 a b        -- family_args = [a, b]</span><span>
</span><a name="line-457"></a><span>      </span><span class="hs-comment">--</span><span>
</span><a name="line-458"></a><span>      </span><span class="hs-comment">--   instance C Bool where</span><span>
</span><a name="line-459"></a><span>      </span><span class="hs-comment">--     type T a b = THelper2 a b        -- family_args = [a, b]</span><span>
</span><a name="line-460"></a><span>      </span><span class="hs-comment">--</span><span>
</span><a name="line-461"></a><span>      </span><span class="hs-comment">-- We could annotate these variables with explicit kinds, but it's not</span><span>
</span><a name="line-462"></a><span>      </span><span class="hs-comment">-- strictly necessary, as kind inference can figure them out just as well.</span><span>
</span><a name="line-463"></a><span>      </span><a name="local-6989586621679255264"><a href="#local-6989586621679255264"><span class="hs-identifier">family_args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">DVarT</span><span> </span><a href="#local-6989586621679255262"><span class="hs-identifier hs-var">meth_arg_tvs</span></a><span>
</span><a name="line-464"></a><span>  </span><a name="local-6989586621679255267"><a href="#local-6989586621679255267"><span class="hs-identifier">helperName</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newUniqueName</span><span> </span><a href="#local-6989586621679255263"><span class="hs-identifier hs-var">helperNameBase</span></a><span>
</span><a name="line-465"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679255268"><a href="#local-6989586621679255268"><span class="hs-identifier">tvbs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">zipWith</span><span> </span><span class="hs-identifier hs-var">DKindedTV</span><span> </span><a href="#local-6989586621679255262"><span class="hs-identifier hs-var">meth_arg_tvs</span></a><span> </span><a href="#local-6989586621679255257"><span class="hs-identifier hs-var">meth_arg_kis</span></a><span>
</span><a name="line-466"></a><span>  </span><a href="Data.Singletons.Promote.Monad.html#emitDecs"><span class="hs-identifier hs-var">emitDecs</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">DClosedTypeFamilyD</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DTypeFamilyHead</span><span>
</span><a name="line-467"></a><span>                                  </span><a href="#local-6989586621679255267"><span class="hs-identifier hs-var">helperName</span></a><span>
</span><a name="line-468"></a><span>                                  </span><a href="#local-6989586621679255268"><span class="hs-identifier hs-var">tvbs</span></a><span>
</span><a name="line-469"></a><span>                                  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DKindSig</span><span> </span><a href="#local-6989586621679255258"><span class="hs-identifier hs-var">meth_res_ki</span></a><span class="hs-special">)</span><span>
</span><a name="line-470"></a><span>                                  </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span>
</span><a name="line-471"></a><span>                               </span><a href="#local-6989586621679255259"><span class="hs-identifier hs-var">eqns</span></a><span class="hs-special">]</span><span>
</span><a name="line-472"></a><span>  </span><a href="Data.Singletons.Promote.Monad.html#emitDecsM"><span class="hs-identifier hs-var">emitDecsM</span></a><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Promote.Defun.html#defunctionalize"><span class="hs-identifier hs-var">defunctionalize</span></a><span> </span><a href="#local-6989586621679255267"><span class="hs-identifier hs-var">helperName</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621679255268"><span class="hs-identifier hs-var">tvbs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679255258"><span class="hs-identifier hs-var">meth_res_ki</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-473"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">DTySynInstD</span><span>
</span><a name="line-474"></a><span>             </span><a href="#local-6989586621679255241"><span class="hs-identifier hs-var">proName</span></a><span>
</span><a name="line-475"></a><span>             </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DTySynEqn</span><span> </span><a href="#local-6989586621679255264"><span class="hs-identifier hs-var">family_args</span></a><span>
</span><a name="line-476"></a><span>                        </span><span class="hs-special">(</span><a href="Data.Singletons.Names.html#foldApply"><span class="hs-identifier hs-var">foldApply</span></a><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Names.html#promoteValRhs"><span class="hs-identifier hs-var">promoteValRhs</span></a><span> </span><a href="#local-6989586621679255267"><span class="hs-identifier hs-var">helperName</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">DVarT</span><span> </span><a href="#local-6989586621679255262"><span class="hs-identifier hs-var">meth_arg_tvs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-477"></a><span>         </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679255261"><span class="hs-identifier hs-var">ann_rhs</span></a><span>
</span><a name="line-478"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">DConT</span><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Names.html#promoteTySym"><span class="hs-identifier hs-var">promoteTySym</span></a><span> </span><a href="#local-6989586621679255267"><span class="hs-identifier hs-var">helperName</span></a><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-479"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-480"></a><span>    </span><a name="local-6989586621679255241"><a href="#local-6989586621679255241"><span class="hs-identifier">proName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Names.html#promoteValNameLhs"><span class="hs-identifier hs-var">promoteValNameLhs</span></a><span> </span><a href="#local-6989586621679255239"><span class="hs-identifier hs-var">meth_name</span></a><span>
</span><a name="line-481"></a><span>
</span><a name="line-482"></a><span>    </span><span class="hs-identifier">lookup_meth_ty</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">DKind</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">DKind</span><span class="hs-special">)</span><span>
</span><a name="line-483"></a><span>    </span><a name="local-6989586621679255242"><a href="#local-6989586621679255242"><span class="hs-identifier">lookup_meth_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-484"></a><span>      </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><a href="#local-6989586621679255239"><span class="hs-identifier hs-var">meth_name</span></a><span> </span><a href="#local-6989586621679255236"><span class="hs-identifier hs-var">inst_sigs_map</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-485"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679255244"><a href="#local-6989586621679255244"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-486"></a><span>          </span><span class="hs-comment">-- We have an InstanceSig. These are easy: no substitution for clas</span><span>
</span><a name="line-487"></a><span>          </span><span class="hs-comment">-- variables is required at all!</span><span>
</span><a name="line-488"></a><span>          </span><a href="Data.Singletons.Promote.Type.html#promoteUnraveled"><span class="hs-identifier hs-var">promoteUnraveled</span></a><span> </span><a href="#local-6989586621679255244"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-489"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-490"></a><span>          </span><span class="hs-comment">-- We don't have an InstanceSig, so we must compute the kind to use</span><span>
</span><a name="line-491"></a><span>          </span><span class="hs-comment">-- ourselves (possibly substituting for class variables below).</span><span>
</span><a name="line-492"></a><span>          </span><span class="hs-special">(</span><a name="local-6989586621679255251"><a href="#local-6989586621679255251"><span class="hs-identifier">arg_kis</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679255252"><a href="#local-6989586621679255252"><span class="hs-identifier">res_ki</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-493"></a><span>            </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><a href="#local-6989586621679255239"><span class="hs-identifier hs-var">meth_name</span></a><span> </span><a href="#local-6989586621679255238"><span class="hs-identifier hs-var">orig_sigs_map</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-494"></a><span>              </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-495"></a><span>                </span><a name="local-6989586621679255245"><a href="#local-6989586621679255245"><span class="hs-identifier">mb_info</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Util.html#dsReifyTypeNameInfo"><span class="hs-identifier hs-var">dsReifyTypeNameInfo</span></a><span> </span><a href="#local-6989586621679255241"><span class="hs-identifier hs-var">proName</span></a><span>
</span><a name="line-496"></a><span>                           </span><span class="hs-comment">-- See Note [Using dsReifyTypeNameInfo when promoting instances]</span><span>
</span><a name="line-497"></a><span>                </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679255245"><span class="hs-identifier hs-var">mb_info</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-498"></a><span>                  </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DTyConI</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DOpenTypeFamilyD</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DTypeFamilyHead</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679255246"><a href="#local-6989586621679255246"><span class="hs-identifier">tvbs</span></a></a><span> </span><a name="local-6989586621679255247"><a href="#local-6989586621679255247"><span class="hs-identifier">mb_res_ki</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-499"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679255248"><a href="#local-6989586621679255248"><span class="hs-identifier">arg_kis</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679255243"><span class="hs-identifier hs-var">default_to_star</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Data.Singletons.Util.html#extractTvbKind"><span class="hs-identifier hs-var">extractTvbKind</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679255246"><span class="hs-identifier hs-var">tvbs</span></a><span>
</span><a name="line-500"></a><span>                           </span><a name="local-6989586621679255249"><a href="#local-6989586621679255249"><span class="hs-identifier">res_ki</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679255243"><span class="hs-identifier hs-var">default_to_star</span></a><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Util.html#resultSigToMaybeKind"><span class="hs-identifier hs-var">resultSigToMaybeKind</span></a><span> </span><a href="#local-6989586621679255247"><span class="hs-identifier hs-var">mb_res_ki</span></a><span class="hs-special">)</span><span>
</span><a name="line-501"></a><span>                        </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679255248"><span class="hs-identifier hs-var">arg_kis</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679255249"><span class="hs-identifier hs-var">res_ki</span></a><span class="hs-special">)</span><span>
</span><a name="line-502"></a><span>                  </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Cannot find type annotation for &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679255241"><span class="hs-identifier hs-var">proName</span></a><span>
</span><a name="line-503"></a><span>              </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679255250"><a href="#local-6989586621679255250"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Promote.Type.html#promoteUnraveled"><span class="hs-identifier hs-var">promoteUnraveled</span></a><span> </span><a href="#local-6989586621679255250"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-504"></a><span>          </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- If we're dealing with an associated type family instance, substitute</span><span>
</span><a name="line-505"></a><span>              </span><span class="hs-comment">-- in the kind of the instance for better kind information in the RHS</span><span>
</span><a name="line-506"></a><span>              </span><span class="hs-comment">-- helper function. If we're dealing with a default family implementation</span><span>
</span><a name="line-507"></a><span>              </span><span class="hs-comment">-- (m_subst = Nothing), there's no need for a substitution.</span><span>
</span><a name="line-508"></a><span>              </span><span class="hs-comment">-- See Note [Promoted class method kinds]</span><span>
</span><a name="line-509"></a><span>              </span><a name="local-6989586621679255253"><a href="#local-6989586621679255253"><span class="hs-identifier">do_subst</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-identifier hs-var">id</span><span> </span><a href="Data.Singletons.Util.html#substKind"><span class="hs-identifier hs-var">substKind</span></a><span> </span><a href="#local-6989586621679255237"><span class="hs-identifier hs-var">m_subst</span></a><span>
</span><a name="line-510"></a><span>              </span><a name="local-6989586621679255254"><a href="#local-6989586621679255254"><span class="hs-identifier">meth_arg_kis'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621679255253"><span class="hs-identifier hs-var">do_subst</span></a><span> </span><a href="#local-6989586621679255251"><span class="hs-identifier hs-var">arg_kis</span></a><span>
</span><a name="line-511"></a><span>              </span><a name="local-6989586621679255255"><a href="#local-6989586621679255255"><span class="hs-identifier">meth_res_ki'</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679255253"><span class="hs-identifier hs-var">do_subst</span></a><span> </span><a href="#local-6989586621679255252"><span class="hs-identifier hs-var">res_ki</span></a><span>
</span><a name="line-512"></a><span>          </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679255254"><span class="hs-identifier hs-var">meth_arg_kis'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679255255"><span class="hs-identifier hs-var">meth_res_ki'</span></a><span class="hs-special">)</span><span>
</span><a name="line-513"></a><span>
</span><a name="line-514"></a><span>    </span><a name="local-6989586621679255243"><a href="#local-6989586621679255243"><span class="hs-identifier">default_to_star</span></a></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">DConT</span><span> </span><span class="hs-identifier hs-var">typeKindName</span><span>
</span><a name="line-515"></a><span>    </span><span class="hs-identifier">default_to_star</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679255256"><a href="#local-6989586621679255256"><span class="hs-identifier">k</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679255256"><span class="hs-identifier hs-var">k</span></a><span>
</span><a name="line-516"></a><span>
</span><a name="line-517"></a><span class="hs-comment">{-
Note [Promoted class method kinds]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider this example of a type class (and instance):

  class C a where
    m :: a -&gt; Bool -&gt; Bool
    m _ x = x

  instance C [a] where
    m l _ = null l

The promoted version of these declarations would be:

  class PC a where
    type M (x :: a) (y :: Bool) (z :: Bool)
    type M x y z = MHelper1 x y z

  instance PC [a] where
    type M x y z = MHelper2 x y z

  type family MHelper1 (x :: a)   (y :: Bool) (z :: Bool) where ...
  type family MHelper2 (x :: [a]) (y :: Bool) (z :: Bool) where ...

Getting the kind signature for MHelper1 (the promoted default implementation of
M) is quite simple, as it corresponds exactly to the kind of M. We might even
choose to make that the kind of MHelper2, but then it would be overly general
(and more difficult to find in -ddump-splices output). For this reason, we
substitute in the kinds of the instance itself to determine the kinds of
promoted method implementations like MHelper2.
-}</span><span>
</span><a name="line-548"></a><span>
</span><a name="line-549"></a><span class="hs-identifier">promoteLetDecEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">String</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">String</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Syntax.html#ULetDecEnv"><span class="hs-identifier hs-type">ULetDecEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">DDec</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="Data.Singletons.Syntax.html#ALetDecEnv"><span class="hs-identifier hs-type">ALetDecEnv</span></a><span class="hs-special">)</span><span>
</span><a name="line-550"></a><a name="promoteLetDecEnv"><a href="Data.Singletons.Promote.html#promoteLetDecEnv"><span class="hs-identifier">promoteLetDecEnv</span></a></a><span> </span><a name="local-6989586621679255269"><a href="#local-6989586621679255269"><span class="hs-identifier">prefixes</span></a></a><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Syntax.html#LetDecEnv"><span class="hs-identifier hs-var">LetDecEnv</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">lde_defns</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679255270"><a href="#local-6989586621679255270"><span class="hs-identifier">value_env</span></a></a><span>
</span><a name="line-551"></a><span>                                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">lde_types</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679255271"><a href="#local-6989586621679255271"><span class="hs-identifier">type_env</span></a></a><span>
</span><a name="line-552"></a><span>                                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">lde_infix</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679255272"><a href="#local-6989586621679255272"><span class="hs-identifier">fix_env</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-553"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679255279"><a href="#local-6989586621679255279"><span class="hs-identifier">infix_decls</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">catMaybes</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">uncurry</span><span> </span><a href="Data.Singletons.Promote.html#promoteInfixDecl"><span class="hs-identifier hs-var">promoteInfixDecl</span></a><span class="hs-special">)</span><span>
</span><a name="line-554"></a><span>                              </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Map.toList</span><span> </span><a href="#local-6989586621679255272"><span class="hs-identifier hs-var">fix_env</span></a><span>
</span><a name="line-555"></a><span>
</span><a name="line-556"></a><span>    </span><span class="hs-comment">-- promote all the declarations, producing annotated declarations</span><span>
</span><a name="line-557"></a><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679255280"><a href="#local-6989586621679255280"><span class="hs-identifier">names</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679255281"><a href="#local-6989586621679255281"><span class="hs-identifier">rhss</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unzip</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Map.toList</span><span> </span><a href="#local-6989586621679255270"><span class="hs-identifier hs-var">value_env</span></a><span>
</span><a name="line-558"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679255282"><a href="#local-6989586621679255282"><span class="hs-identifier">payloads</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679255283"><a href="#local-6989586621679255283"><span class="hs-identifier">defun_decss</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679255284"><a href="#local-6989586621679255284"><span class="hs-identifier">ann_rhss</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-559"></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">unzip3</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">zipWithM</span><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Promote.html#promoteLetDecRHS"><span class="hs-identifier hs-var">promoteLetDecRHS</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621679255271"><span class="hs-identifier hs-var">type_env</span></a><span> </span><a href="#local-6989586621679255272"><span class="hs-identifier hs-var">fix_env</span></a><span> </span><a href="#local-6989586621679255269"><span class="hs-identifier hs-var">prefixes</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679255280"><span class="hs-identifier hs-var">names</span></a><span> </span><a href="#local-6989586621679255281"><span class="hs-identifier hs-var">rhss</span></a><span>
</span><a name="line-560"></a><span>
</span><a name="line-561"></a><span>  </span><a href="Data.Singletons.Promote.Monad.html#emitDecs"><span class="hs-identifier hs-var">emitDecs</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">concat</span><span> </span><a href="#local-6989586621679255283"><span class="hs-identifier hs-var">defun_decss</span></a><span>
</span><a name="line-562"></a><span>  </span><a name="local-6989586621679255285"><a href="#local-6989586621679255285"><span class="hs-identifier">bound_kvs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Promote.Monad.html#allBoundKindVars"><span class="hs-identifier hs-var">allBoundKindVars</span></a><span>
</span><a name="line-563"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679255286"><a href="#local-6989586621679255286"><span class="hs-identifier">decs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621679255273"><span class="hs-identifier hs-var">payload_to_dec</span></a><span> </span><a href="#local-6989586621679255282"><span class="hs-identifier hs-var">payloads</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679255279"><span class="hs-identifier hs-var">infix_decls</span></a><span>
</span><a name="line-564"></a><span>
</span><a name="line-565"></a><span>    </span><span class="hs-comment">-- build the ALetDecEnv</span><span>
</span><a name="line-566"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679255287"><a href="#local-6989586621679255287"><span class="hs-identifier">let_dec_env'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Syntax.html#LetDecEnv"><span class="hs-identifier hs-var">LetDecEnv</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">lde_defns</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.fromList</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621679255280"><span class="hs-identifier hs-var">names</span></a><span> </span><a href="#local-6989586621679255284"><span class="hs-identifier hs-var">ann_rhss</span></a><span>
</span><a name="line-567"></a><span>                               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">lde_types</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679255271"><span class="hs-identifier hs-var">type_env</span></a><span>
</span><a name="line-568"></a><span>                               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">lde_infix</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679255272"><span class="hs-identifier hs-var">fix_env</span></a><span>
</span><a name="line-569"></a><span>                               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">lde_proms</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.empty</span><span>   </span><span class="hs-comment">-- filled in promoteLetDecs</span><span>
</span><a name="line-570"></a><span>                               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">lde_bound_kvs</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.fromList</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679255285"><span class="hs-identifier hs-var">bound_kvs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679255280"><span class="hs-identifier hs-var">names</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-571"></a><span>
</span><a name="line-572"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679255286"><span class="hs-identifier hs-var">decs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679255287"><span class="hs-identifier hs-var">let_dec_env'</span></a><span class="hs-special">)</span><span>
</span><a name="line-573"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-574"></a><span>    </span><a name="local-6989586621679255273"><a href="#local-6989586621679255273"><span class="hs-identifier">payload_to_dec</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679255274"><a href="#local-6989586621679255274"><span class="hs-identifier">name</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679255275"><a href="#local-6989586621679255275"><span class="hs-identifier">tvbs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679255276"><a href="#local-6989586621679255276"><span class="hs-identifier">m_ki</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679255277"><a href="#local-6989586621679255277"><span class="hs-identifier">eqns</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">DClosedTypeFamilyD</span><span>
</span><a name="line-575"></a><span>                                                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DTypeFamilyHead</span><span> </span><a href="#local-6989586621679255274"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679255275"><span class="hs-identifier hs-var">tvbs</span></a><span> </span><a href="#local-6989586621679255278"><span class="hs-identifier hs-var">sig</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span>
</span><a name="line-576"></a><span>                                                </span><a href="#local-6989586621679255277"><span class="hs-identifier hs-var">eqns</span></a><span>
</span><a name="line-577"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-578"></a><span>        </span><a name="local-6989586621679255278"><a href="#local-6989586621679255278"><span class="hs-identifier">sig</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-identifier hs-var">DNoSig</span><span> </span><span class="hs-identifier hs-var">DKindSig</span><span> </span><a href="#local-6989586621679255276"><span class="hs-identifier hs-var">m_ki</span></a><span>
</span><a name="line-579"></a><span>
</span><a name="line-580"></a><span class="hs-identifier">promoteInfixDecl</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Fixity</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">DDec</span><span>
</span><a name="line-581"></a><a name="promoteInfixDecl"><a href="Data.Singletons.Promote.html#promoteInfixDecl"><span class="hs-identifier">promoteInfixDecl</span></a></a><span> </span><a name="local-6989586621679255288"><a href="#local-6989586621679255288"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621679255289"><a href="#local-6989586621679255289"><span class="hs-identifier">fixity</span></a></a><span>
</span><a name="line-582"></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">nameBase</span><span> </span><a href="#local-6989586621679255288"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">nameBase</span><span> </span><a href="#local-6989586621679255290"><span class="hs-identifier hs-var">promoted_name</span></a><span>
</span><a name="line-583"></a><span>   </span><span class="hs-comment">-- If a name and its promoted counterpart are the same (modulo module</span><span>
</span><a name="line-584"></a><span>   </span><span class="hs-comment">-- prefixes), then there's no need to promote a fixity declaration for</span><span>
</span><a name="line-585"></a><span>   </span><span class="hs-comment">-- that name, since the existing fixity declaration will cover both</span><span>
</span><a name="line-586"></a><span>   </span><span class="hs-comment">-- the term- and type-level versions of that name,</span><span>
</span><a name="line-587"></a><span>   </span><span class="hs-comment">--</span><span>
</span><a name="line-588"></a><span>   </span><span class="hs-comment">-- Names that fall into this category include data constructor names</span><span>
</span><a name="line-589"></a><span>   </span><span class="hs-comment">-- and infix names, with the exceptions of (.) and (!).</span><span>
</span><a name="line-590"></a><span>   </span><span class="hs-comment">-- See Note [Special cases for (.) and (!)] in Data.Singletons.Names.</span><span>
</span><a name="line-591"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-592"></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-593"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">DLetDec</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">DInfixD</span><span> </span><a href="#local-6989586621679255289"><span class="hs-identifier hs-var">fixity</span></a><span> </span><a href="#local-6989586621679255290"><span class="hs-identifier hs-var">promoted_name</span></a><span>
</span><a name="line-594"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-595"></a><span>  </span><a name="local-6989586621679255290"><a href="#local-6989586621679255290"><span class="hs-identifier">promoted_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Names.html#promoteValNameLhs"><span class="hs-identifier hs-var">promoteValNameLhs</span></a><span> </span><a href="#local-6989586621679255288"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-596"></a><span>
</span><a name="line-597"></a><span class="hs-comment">-- This function is used both to promote class method defaults and normal</span><span>
</span><a name="line-598"></a><span class="hs-comment">-- let bindings. Thus, it can't quite do all the work locally and returns</span><span>
</span><a name="line-599"></a><span class="hs-comment">-- an intermediate structure. Perhaps a better design is available.</span><span>
</span><a name="line-600"></a><span class="hs-identifier">promoteLetDecRHS</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">DKind</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">DKind</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- the promoted type of the RHS (if known)</span><span>
</span><a name="line-601"></a><span>                                            </span><span class="hs-comment">-- needed to fix #136</span><span>
</span><a name="line-602"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-identifier hs-type">DType</span><span>       </span><span class="hs-comment">-- local type env't</span><span>
</span><a name="line-603"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-identifier hs-type">Fixity</span><span>      </span><span class="hs-comment">-- local fixity env't</span><span>
</span><a name="line-604"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">String</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">String</span><span class="hs-special">)</span><span>     </span><span class="hs-comment">-- let-binding prefixes</span><span>
</span><a name="line-605"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span>                 </span><span class="hs-comment">-- name of the thing being promoted</span><span>
</span><a name="line-606"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Syntax.html#ULetDecRHS"><span class="hs-identifier hs-type">ULetDecRHS</span></a><span>           </span><span class="hs-comment">-- body of the thing</span><span>
</span><a name="line-607"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DTyVarBndr</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">DKind</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DTySynEqn</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- &quot;type family&quot;</span><span>
</span><a name="line-608"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DDec</span><span class="hs-special">]</span><span>        </span><span class="hs-comment">-- defunctionalization</span><span>
</span><a name="line-609"></a><span>                        </span><span class="hs-special">,</span><span> </span><a href="Data.Singletons.Syntax.html#ALetDecRHS"><span class="hs-identifier hs-type">ALetDecRHS</span></a><span> </span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- annotated RHS</span><span>
</span><a name="line-610"></a><a name="promoteLetDecRHS"><a href="Data.Singletons.Promote.html#promoteLetDecRHS"><span class="hs-identifier">promoteLetDecRHS</span></a></a><span> </span><a name="local-6989586621679255291"><a href="#local-6989586621679255291"><span class="hs-identifier">m_rhs_ki</span></a></a><span> </span><a name="local-6989586621679255292"><a href="#local-6989586621679255292"><span class="hs-identifier">type_env</span></a></a><span> </span><a name="local-6989586621679255293"><a href="#local-6989586621679255293"><span class="hs-identifier">fix_env</span></a></a><span> </span><a name="local-6989586621679255294"><a href="#local-6989586621679255294"><span class="hs-identifier">prefixes</span></a></a><span> </span><a name="local-6989586621679255295"><a href="#local-6989586621679255295"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Syntax.html#UValue"><span class="hs-identifier hs-var">UValue</span></a><span> </span><a name="local-6989586621679255296"><a href="#local-6989586621679255296"><span class="hs-identifier">exp</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-611"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679255301"><a href="#local-6989586621679255301"><span class="hs-identifier">res_kind</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679255302"><a href="#local-6989586621679255302"><span class="hs-identifier">num_arrows</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-612"></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679255291"><span class="hs-identifier hs-var">m_rhs_ki</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-613"></a><span>         </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679255297"><a href="#local-6989586621679255297"><span class="hs-identifier">arg_kis</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679255298"><a href="#local-6989586621679255298"><span class="hs-identifier">res_ki</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Promote.Defun.html#ravelTyFun"><span class="hs-identifier hs-var">ravelTyFun</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679255297"><span class="hs-identifier hs-var">arg_kis</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679255298"><span class="hs-identifier hs-var">res_ki</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-614"></a><span>                                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679255297"><span class="hs-identifier hs-var">arg_kis</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-615"></a><span>         </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">|</span><span>  </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679255299"><a href="#local-6989586621679255299"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><a href="#local-6989586621679255295"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679255292"><span class="hs-identifier hs-var">type_env</span></a><span>
</span><a name="line-616"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621679255300"><a href="#local-6989586621679255300"><span class="hs-identifier">ki</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Promote.Type.html#promoteType"><span class="hs-identifier hs-var">promoteType</span></a><span> </span><a href="#local-6989586621679255299"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-617"></a><span>                 </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679255300"><span class="hs-identifier hs-var">ki</span></a><span class="hs-special">,</span><span> </span><a href="Data.Singletons.Util.html#countArgs"><span class="hs-identifier hs-var">countArgs</span></a><span> </span><a href="#local-6989586621679255299"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-618"></a><span>           </span><span class="hs-glyph">|</span><span>  </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-619"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">,</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span>
</span><a name="line-620"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679255302"><span class="hs-identifier hs-var">num_arrows</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-621"></a><span>    </span><span class="hs-number">0</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-622"></a><span>      </span><a name="local-6989586621679255303"><a href="#local-6989586621679255303"><span class="hs-identifier">all_locals</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Promote.Monad.html#allLocals"><span class="hs-identifier hs-var">allLocals</span></a><span>
</span><a name="line-623"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679255304"><a href="#local-6989586621679255304"><span class="hs-identifier">lde_kvs_to_bind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldMap</span><span> </span><span class="hs-identifier hs-var">fvDType</span><span> </span><a href="#local-6989586621679255301"><span class="hs-identifier hs-var">res_kind</span></a><span>
</span><a name="line-624"></a><span>      </span><span class="hs-special">(</span><a name="local-6989586621679255305"><a href="#local-6989586621679255305"><span class="hs-identifier">exp'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679255306"><a href="#local-6989586621679255306"><span class="hs-identifier">ann_exp</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Promote.Monad.html#forallBind"><span class="hs-identifier hs-var">forallBind</span></a><span> </span><a href="#local-6989586621679255304"><span class="hs-identifier hs-var">lde_kvs_to_bind</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Singletons.Promote.html#promoteExp"><span class="hs-identifier hs-var">promoteExp</span></a><span> </span><a href="#local-6989586621679255296"><span class="hs-identifier hs-var">exp</span></a><span>
</span><a name="line-625"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679255307"><a href="#local-6989586621679255307"><span class="hs-identifier">proName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Names.html#promoteValNameLhsPrefix"><span class="hs-identifier hs-var">promoteValNameLhsPrefix</span></a><span> </span><a href="#local-6989586621679255294"><span class="hs-identifier hs-var">prefixes</span></a><span> </span><a href="#local-6989586621679255295"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-626"></a><span>          </span><a name="local-6989586621679255308"><a href="#local-6989586621679255308"><span class="hs-identifier">m_fixity</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><a href="#local-6989586621679255295"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679255293"><span class="hs-identifier hs-var">fix_env</span></a><span>
</span><a name="line-627"></a><span>          </span><a name="local-6989586621679255309"><a href="#local-6989586621679255309"><span class="hs-identifier">tvbs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">DPlainTV</span><span> </span><a href="#local-6989586621679255303"><span class="hs-identifier hs-var">all_locals</span></a><span>
</span><a name="line-628"></a><span>      </span><a name="local-6989586621679255310"><a href="#local-6989586621679255310"><span class="hs-identifier">defuns</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Promote.Defun.html#defunctionalize"><span class="hs-identifier hs-var">defunctionalize</span></a><span> </span><a href="#local-6989586621679255307"><span class="hs-identifier hs-var">proName</span></a><span> </span><a href="#local-6989586621679255308"><span class="hs-identifier hs-var">m_fixity</span></a><span> </span><a href="#local-6989586621679255309"><span class="hs-identifier hs-var">tvbs</span></a><span> </span><a href="#local-6989586621679255301"><span class="hs-identifier hs-var">res_kind</span></a><span>
</span><a name="line-629"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621679255307"><span class="hs-identifier hs-var">proName</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679255309"><span class="hs-identifier hs-var">tvbs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679255301"><span class="hs-identifier hs-var">res_kind</span></a><span>
</span><a name="line-630"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">DTySynEqn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">DVarT</span><span> </span><a href="#local-6989586621679255303"><span class="hs-identifier hs-var">all_locals</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679255305"><span class="hs-identifier hs-var">exp'</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-631"></a><span>             </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679255310"><span class="hs-identifier hs-var">defuns</span></a><span>
</span><a name="line-632"></a><span>             </span><span class="hs-special">,</span><span> </span><a href="Data.Singletons.Syntax.html#AValue"><span class="hs-identifier hs-var">AValue</span></a><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Util.html#foldType"><span class="hs-identifier hs-var">foldType</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DConT</span><span> </span><a href="#local-6989586621679255307"><span class="hs-identifier hs-var">proName</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">DVarT</span><span> </span><a href="#local-6989586621679255303"><span class="hs-identifier hs-var">all_locals</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-633"></a><span>                      </span><a href="#local-6989586621679255302"><span class="hs-identifier hs-var">num_arrows</span></a><span> </span><a href="#local-6989586621679255306"><span class="hs-identifier hs-var">ann_exp</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-634"></a><span>    </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-635"></a><span>      </span><a name="local-6989586621679255311"><a href="#local-6989586621679255311"><span class="hs-identifier">names</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">replicateM</span><span> </span><a href="#local-6989586621679255302"><span class="hs-identifier hs-var">num_arrows</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">newUniqueName</span><span> </span><span class="hs-string">&quot;a&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-636"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679255312"><a href="#local-6989586621679255312"><span class="hs-identifier">pats</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">DVarPa</span><span> </span><a href="#local-6989586621679255311"><span class="hs-identifier hs-var">names</span></a><span>
</span><a name="line-637"></a><span>          </span><a name="local-6989586621679255313"><a href="#local-6989586621679255313"><span class="hs-identifier">newArgs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">DVarE</span><span>  </span><a href="#local-6989586621679255311"><span class="hs-identifier hs-var">names</span></a><span>
</span><a name="line-638"></a><span>      </span><a href="Data.Singletons.Promote.html#promoteLetDecRHS"><span class="hs-identifier hs-var">promoteLetDecRHS</span></a><span> </span><a href="#local-6989586621679255291"><span class="hs-identifier hs-var">m_rhs_ki</span></a><span> </span><a href="#local-6989586621679255292"><span class="hs-identifier hs-var">type_env</span></a><span> </span><a href="#local-6989586621679255293"><span class="hs-identifier hs-var">fix_env</span></a><span> </span><a href="#local-6989586621679255294"><span class="hs-identifier hs-var">prefixes</span></a><span> </span><a href="#local-6989586621679255295"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-639"></a><span>                       </span><span class="hs-special">(</span><a href="Data.Singletons.Syntax.html#UFunction"><span class="hs-identifier hs-var">UFunction</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">DClause</span><span> </span><a href="#local-6989586621679255312"><span class="hs-identifier hs-var">pats</span></a><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Util.html#foldExp"><span class="hs-identifier hs-var">foldExp</span></a><span> </span><a href="#local-6989586621679255296"><span class="hs-identifier hs-var">exp</span></a><span> </span><a href="#local-6989586621679255313"><span class="hs-identifier hs-var">newArgs</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-640"></a><span>
</span><a name="line-641"></a><span class="hs-identifier">promoteLetDecRHS</span><span> </span><a name="local-6989586621679255314"><a href="#local-6989586621679255314"><span class="hs-identifier">m_rhs_ki</span></a></a><span> </span><a name="local-6989586621679255315"><a href="#local-6989586621679255315"><span class="hs-identifier">type_env</span></a></a><span> </span><a name="local-6989586621679255316"><a href="#local-6989586621679255316"><span class="hs-identifier">fix_env</span></a></a><span> </span><a name="local-6989586621679255317"><a href="#local-6989586621679255317"><span class="hs-identifier">prefixes</span></a></a><span> </span><a name="local-6989586621679255318"><a href="#local-6989586621679255318"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Syntax.html#UFunction"><span class="hs-identifier hs-var">UFunction</span></a><span> </span><a name="local-6989586621679255319"><a href="#local-6989586621679255319"><span class="hs-identifier">clauses</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-642"></a><span>  </span><a name="local-6989586621679255334"><a href="#local-6989586621679255334"><span class="hs-identifier">numArgs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679255321"><span class="hs-identifier hs-var">count_args</span></a><span> </span><a href="#local-6989586621679255319"><span class="hs-identifier hs-var">clauses</span></a><span>
</span><a name="line-643"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679255340"><a href="#local-6989586621679255340"><span class="hs-identifier">m_argKs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679255341"><a href="#local-6989586621679255341"><span class="hs-identifier">m_resK</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679255342"><a href="#local-6989586621679255342"><span class="hs-identifier">ty_num_args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679255314"><span class="hs-identifier hs-var">m_rhs_ki</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-644"></a><span>    </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679255335"><a href="#local-6989586621679255335"><span class="hs-identifier">arg_kis</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679255336"><a href="#local-6989586621679255336"><span class="hs-identifier">res_ki</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679255335"><span class="hs-identifier hs-var">arg_kis</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679255336"><span class="hs-identifier hs-var">res_ki</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679255335"><span class="hs-identifier hs-var">arg_kis</span></a><span class="hs-special">)</span><span>
</span><a name="line-645"></a><span>    </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">|</span><span>  </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679255337"><a href="#local-6989586621679255337"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><a href="#local-6989586621679255318"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679255315"><span class="hs-identifier hs-var">type_env</span></a><span>
</span><a name="line-646"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-647"></a><span>      </span><span class="hs-comment">-- promoteType turns arrows into TyFun. So, we unravel first to</span><span>
</span><a name="line-648"></a><span>      </span><span class="hs-comment">-- avoid this behavior. Note the use of ravelTyFun in resultK</span><span>
</span><a name="line-649"></a><span>      </span><span class="hs-comment">-- to make the return kind work out</span><span>
</span><a name="line-650"></a><span>      </span><span class="hs-special">(</span><a name="local-6989586621679255338"><a href="#local-6989586621679255338"><span class="hs-identifier">argKs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679255339"><a href="#local-6989586621679255339"><span class="hs-identifier">resultK</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Promote.Type.html#promoteUnraveled"><span class="hs-identifier hs-var">promoteUnraveled</span></a><span> </span><a href="#local-6989586621679255337"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-651"></a><span>      </span><span class="hs-comment">-- invariant: countArgs ty == length argKs</span><span>
</span><a name="line-652"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679255338"><span class="hs-identifier hs-var">argKs</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679255339"><span class="hs-identifier hs-var">resultK</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679255338"><span class="hs-identifier hs-var">argKs</span></a><span class="hs-special">)</span><span>
</span><a name="line-653"></a><span>
</span><a name="line-654"></a><span>      </span><span class="hs-glyph">|</span><span>  </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-655"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">replicate</span><span> </span><a href="#local-6989586621679255334"><span class="hs-identifier hs-var">numArgs</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679255334"><span class="hs-identifier hs-var">numArgs</span></a><span class="hs-special">)</span><span>
</span><a name="line-656"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679255343"><a href="#local-6989586621679255343"><span class="hs-identifier">proName</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Names.html#promoteValNameLhsPrefix"><span class="hs-identifier hs-var">promoteValNameLhsPrefix</span></a><span> </span><a href="#local-6989586621679255317"><span class="hs-identifier hs-var">prefixes</span></a><span> </span><a href="#local-6989586621679255318"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-657"></a><span>      </span><a name="local-6989586621679255344"><a href="#local-6989586621679255344"><span class="hs-identifier">m_fixity</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><a href="#local-6989586621679255318"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679255316"><span class="hs-identifier hs-var">fix_env</span></a><span>
</span><a name="line-658"></a><span>  </span><a name="local-6989586621679255345"><a href="#local-6989586621679255345"><span class="hs-identifier">all_locals</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Promote.Monad.html#allLocals"><span class="hs-identifier hs-var">allLocals</span></a><span>
</span><a name="line-659"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679255346"><a href="#local-6989586621679255346"><span class="hs-identifier">local_tvbs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">DPlainTV</span><span> </span><a href="#local-6989586621679255345"><span class="hs-identifier hs-var">all_locals</span></a><span>
</span><a name="line-660"></a><span>  </span><a name="local-6989586621679255347"><a href="#local-6989586621679255347"><span class="hs-identifier">tyvarNames</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">qNewName</span><span> </span><span class="hs-string">&quot;a&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679255340"><span class="hs-identifier hs-var">m_argKs</span></a><span>
</span><a name="line-661"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679255348"><a href="#local-6989586621679255348"><span class="hs-identifier">args</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">zipWith</span><span> </span><a href="Data.Singletons.Util.html#inferMaybeKindTV"><span class="hs-identifier hs-var">inferMaybeKindTV</span></a><span> </span><a href="#local-6989586621679255347"><span class="hs-identifier hs-var">tyvarNames</span></a><span> </span><a href="#local-6989586621679255340"><span class="hs-identifier hs-var">m_argKs</span></a><span>
</span><a name="line-662"></a><span>      </span><a name="local-6989586621679255349"><a href="#local-6989586621679255349"><span class="hs-identifier">all_args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679255346"><span class="hs-identifier hs-var">local_tvbs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679255348"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-663"></a><span>  </span><a name="local-6989586621679255350"><a href="#local-6989586621679255350"><span class="hs-identifier">defun_decs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Promote.Defun.html#defunctionalize"><span class="hs-identifier hs-var">defunctionalize</span></a><span> </span><a href="#local-6989586621679255343"><span class="hs-identifier hs-var">proName</span></a><span> </span><a href="#local-6989586621679255344"><span class="hs-identifier hs-var">m_fixity</span></a><span> </span><a href="#local-6989586621679255349"><span class="hs-identifier hs-var">all_args</span></a><span> </span><a href="#local-6989586621679255341"><span class="hs-identifier hs-var">m_resK</span></a><span>
</span><a name="line-664"></a><span>  </span><a name="local-6989586621679255351"><a href="#local-6989586621679255351"><span class="hs-identifier">expClauses</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679255320"><span class="hs-identifier hs-var">etaContractOrExpand</span></a><span> </span><a href="#local-6989586621679255342"><span class="hs-identifier hs-var">ty_num_args</span></a><span> </span><a href="#local-6989586621679255334"><span class="hs-identifier hs-var">numArgs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679255319"><span class="hs-identifier hs-var">clauses</span></a><span>
</span><a name="line-665"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679255352"><a href="#local-6989586621679255352"><span class="hs-identifier">lde_kvs_to_bind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldMap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">foldMap</span><span> </span><span class="hs-identifier hs-var">fvDType</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679255340"><span class="hs-identifier hs-var">m_argKs</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">foldMap</span><span> </span><span class="hs-identifier hs-var">fvDType</span><span> </span><a href="#local-6989586621679255341"><span class="hs-identifier hs-var">m_resK</span></a><span>
</span><a name="line-666"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679255353"><a href="#local-6989586621679255353"><span class="hs-identifier">eqns</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679255354"><a href="#local-6989586621679255354"><span class="hs-identifier">ann_clauses</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Promote.Monad.html#forallBind"><span class="hs-identifier hs-var">forallBind</span></a><span> </span><a href="#local-6989586621679255352"><span class="hs-identifier hs-var">lde_kvs_to_bind</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-667"></a><span>                         </span><span class="hs-identifier hs-var">mapAndUnzipM</span><span> </span><a href="Data.Singletons.Promote.html#promoteClause"><span class="hs-identifier hs-var">promoteClause</span></a><span> </span><a href="#local-6989586621679255351"><span class="hs-identifier hs-var">expClauses</span></a><span>
</span><a name="line-668"></a><span>  </span><a name="local-6989586621679255355"><a href="#local-6989586621679255355"><span class="hs-identifier">prom_fun</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Promote.Monad.html#lookupVarE"><span class="hs-identifier hs-var">lookupVarE</span></a><span> </span><a href="#local-6989586621679255318"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-669"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679255343"><span class="hs-identifier hs-var">proName</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679255349"><span class="hs-identifier hs-var">all_args</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679255341"><span class="hs-identifier hs-var">m_resK</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679255353"><span class="hs-identifier hs-var">eqns</span></a><span class="hs-special">)</span><span>
</span><a name="line-670"></a><span>         </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679255350"><span class="hs-identifier hs-var">defun_decs</span></a><span>
</span><a name="line-671"></a><span>         </span><span class="hs-special">,</span><span> </span><a href="Data.Singletons.Syntax.html#AFunction"><span class="hs-identifier hs-var">AFunction</span></a><span> </span><a href="#local-6989586621679255355"><span class="hs-identifier hs-var">prom_fun</span></a><span> </span><a href="#local-6989586621679255342"><span class="hs-identifier hs-var">ty_num_args</span></a><span> </span><a href="#local-6989586621679255354"><span class="hs-identifier hs-var">ann_clauses</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-672"></a><span>
</span><a name="line-673"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-674"></a><span>    </span><span class="hs-identifier">etaContractOrExpand</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DClause</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a><span> </span><span class="hs-identifier hs-type">DClause</span><span>
</span><a name="line-675"></a><span>    </span><a name="local-6989586621679255320"><a href="#local-6989586621679255320"><span class="hs-identifier">etaContractOrExpand</span></a></a><span> </span><a name="local-6989586621679255322"><a href="#local-6989586621679255322"><span class="hs-identifier">ty_num_args</span></a></a><span> </span><a name="local-6989586621679255323"><a href="#local-6989586621679255323"><span class="hs-identifier">clause_num_args</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DClause</span><span> </span><a name="local-6989586621679255324"><a href="#local-6989586621679255324"><span class="hs-identifier">pats</span></a></a><span> </span><a name="local-6989586621679255325"><a href="#local-6989586621679255325"><span class="hs-identifier">exp</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-676"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679255326"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- Eta-expand</span><span>
</span><a name="line-677"></a><span>          </span><a name="local-6989586621679255327"><a href="#local-6989586621679255327"><span class="hs-identifier">names</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">replicateM</span><span> </span><a href="#local-6989586621679255326"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">newUniqueName</span><span> </span><span class="hs-string">&quot;a&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-678"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679255328"><a href="#local-6989586621679255328"><span class="hs-identifier">newPats</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">DVarPa</span><span> </span><a href="#local-6989586621679255327"><span class="hs-identifier hs-var">names</span></a><span>
</span><a name="line-679"></a><span>              </span><a name="local-6989586621679255329"><a href="#local-6989586621679255329"><span class="hs-identifier">newArgs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">DVarE</span><span>  </span><a href="#local-6989586621679255327"><span class="hs-identifier hs-var">names</span></a><span>
</span><a name="line-680"></a><span>          </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">DClause</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679255324"><span class="hs-identifier hs-var">pats</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679255328"><span class="hs-identifier hs-var">newPats</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Util.html#foldExp"><span class="hs-identifier hs-var">foldExp</span></a><span> </span><a href="#local-6989586621679255325"><span class="hs-identifier hs-var">exp</span></a><span> </span><a href="#local-6989586621679255329"><span class="hs-identifier hs-var">newArgs</span></a><span class="hs-special">)</span><span>
</span><a name="line-681"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- Eta-contract</span><span>
</span><a name="line-682"></a><span>          </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679255330"><a href="#local-6989586621679255330"><span class="hs-identifier">clausePats</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679255331"><a href="#local-6989586621679255331"><span class="hs-identifier">lamPats</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">splitAt</span><span> </span><a href="#local-6989586621679255322"><span class="hs-identifier hs-var">ty_num_args</span></a><span> </span><a href="#local-6989586621679255324"><span class="hs-identifier hs-var">pats</span></a><span>
</span><a name="line-683"></a><span>          </span><a name="local-6989586621679255332"><a href="#local-6989586621679255332"><span class="hs-identifier">lamExp</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mkDLamEFromDPats</span><span> </span><a href="#local-6989586621679255331"><span class="hs-identifier hs-var">lamPats</span></a><span> </span><a href="#local-6989586621679255325"><span class="hs-identifier hs-var">exp</span></a><span>
</span><a name="line-684"></a><span>          </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">DClause</span><span> </span><a href="#local-6989586621679255330"><span class="hs-identifier hs-var">clausePats</span></a><span> </span><a href="#local-6989586621679255332"><span class="hs-identifier hs-var">lamExp</span></a><span>
</span><a name="line-685"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-686"></a><span>        </span><a name="local-6989586621679255326"><a href="#local-6989586621679255326"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679255322"><span class="hs-identifier hs-var">ty_num_args</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679255323"><span class="hs-identifier hs-var">clause_num_args</span></a><span>
</span><a name="line-687"></a><span>
</span><a name="line-688"></a><span>    </span><a name="local-6989586621679255321"><a href="#local-6989586621679255321"><span class="hs-identifier">count_args</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DClause</span><span> </span><a name="local-6989586621679255333"><a href="#local-6989586621679255333"><span class="hs-identifier">pats</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679255333"><span class="hs-identifier hs-var">pats</span></a><span>
</span><a name="line-689"></a><span>    </span><span class="hs-identifier">count_args</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Impossible! A function without clauses.&quot;</span><span>
</span><a name="line-690"></a><span>
</span><a name="line-691"></a><span class="hs-identifier">promoteClause</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DClause</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DTySynEqn</span><span class="hs-special">,</span><span> </span><a href="Data.Singletons.Syntax.html#ADClause"><span class="hs-identifier hs-type">ADClause</span></a><span class="hs-special">)</span><span>
</span><a name="line-692"></a><a name="promoteClause"><a href="Data.Singletons.Promote.html#promoteClause"><span class="hs-identifier">promoteClause</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DClause</span><span> </span><a name="local-6989586621679255356"><a href="#local-6989586621679255356"><span class="hs-identifier">pats</span></a></a><span> </span><a name="local-6989586621679255357"><a href="#local-6989586621679255357"><span class="hs-identifier">exp</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-693"></a><span>  </span><span class="hs-comment">-- promoting the patterns creates variable bindings. These are passed</span><span>
</span><a name="line-694"></a><span>  </span><span class="hs-comment">-- to the function promoted the RHS</span><span>
</span><a name="line-695"></a><span>  </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621679255358"><a href="#local-6989586621679255358"><span class="hs-identifier">types</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679255359"><a href="#local-6989586621679255359"><span class="hs-identifier">pats'</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679255360"><a href="#local-6989586621679255360"><span class="hs-identifier">prom_pat_infos</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Util.html#evalForPair"><span class="hs-identifier hs-var">evalForPair</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mapAndUnzipM</span><span> </span><a href="Data.Singletons.Promote.html#promotePat"><span class="hs-identifier hs-var">promotePat</span></a><span> </span><a href="#local-6989586621679255356"><span class="hs-identifier hs-var">pats</span></a><span>
</span><a name="line-696"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a href="Data.Singletons.Syntax.html#PromDPatInfos"><span class="hs-identifier hs-var">PromDPatInfos</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">prom_dpat_vars</span><span>    </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679255361"><a href="#local-6989586621679255361"><span class="hs-identifier">new_vars</span></a></a><span>
</span><a name="line-697"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">prom_dpat_sig_kvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679255362"><a href="#local-6989586621679255362"><span class="hs-identifier">sig_kvs</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679255360"><span class="hs-identifier hs-var">prom_pat_infos</span></a><span>
</span><a name="line-698"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679255363"><a href="#local-6989586621679255363"><span class="hs-identifier">ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679255364"><a href="#local-6989586621679255364"><span class="hs-identifier">ann_exp</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Promote.Monad.html#forallBind"><span class="hs-identifier hs-var">forallBind</span></a><span> </span><a href="#local-6989586621679255362"><span class="hs-identifier hs-var">sig_kvs</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-699"></a><span>                   </span><a href="Data.Singletons.Promote.Monad.html#lambdaBind"><span class="hs-identifier hs-var">lambdaBind</span></a><span> </span><a href="#local-6989586621679255361"><span class="hs-identifier hs-var">new_vars</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-700"></a><span>                   </span><a href="Data.Singletons.Promote.html#promoteExp"><span class="hs-identifier hs-var">promoteExp</span></a><span> </span><a href="#local-6989586621679255357"><span class="hs-identifier hs-var">exp</span></a><span>
</span><a name="line-701"></a><span>  </span><a name="local-6989586621679255365"><a href="#local-6989586621679255365"><span class="hs-identifier">all_locals</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Promote.Monad.html#allLocals"><span class="hs-identifier hs-var">allLocals</span></a><span>   </span><span class="hs-comment">-- these are bound *outside* of this clause</span><span>
</span><a name="line-702"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">DTySynEqn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">DVarT</span><span> </span><a href="#local-6989586621679255365"><span class="hs-identifier hs-var">all_locals</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679255358"><span class="hs-identifier hs-var">types</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679255363"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-703"></a><span>         </span><span class="hs-special">,</span><span> </span><a href="Data.Singletons.Syntax.html#ADClause"><span class="hs-identifier hs-var">ADClause</span></a><span> </span><a href="#local-6989586621679255361"><span class="hs-identifier hs-var">new_vars</span></a><span> </span><a href="#local-6989586621679255359"><span class="hs-identifier hs-var">pats'</span></a><span> </span><a href="#local-6989586621679255364"><span class="hs-identifier hs-var">ann_exp</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-704"></a><span>
</span><a name="line-705"></a><span class="hs-identifier">promoteMatch</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DMatch</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DTySynEqn</span><span class="hs-special">,</span><span> </span><a href="Data.Singletons.Syntax.html#ADMatch"><span class="hs-identifier hs-type">ADMatch</span></a><span class="hs-special">)</span><span>
</span><a name="line-706"></a><a name="promoteMatch"><a href="Data.Singletons.Promote.html#promoteMatch"><span class="hs-identifier">promoteMatch</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DMatch</span><span> </span><a name="local-6989586621679255366"><a href="#local-6989586621679255366"><span class="hs-identifier">pat</span></a></a><span> </span><a name="local-6989586621679255367"><a href="#local-6989586621679255367"><span class="hs-identifier">exp</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-707"></a><span>  </span><span class="hs-comment">-- promoting the patterns creates variable bindings. These are passed</span><span>
</span><a name="line-708"></a><span>  </span><span class="hs-comment">-- to the function promoted the RHS</span><span>
</span><a name="line-709"></a><span>  </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621679255368"><a href="#local-6989586621679255368"><span class="hs-identifier">ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679255369"><a href="#local-6989586621679255369"><span class="hs-identifier">pat'</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679255370"><a href="#local-6989586621679255370"><span class="hs-identifier">prom_pat_infos</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Util.html#evalForPair"><span class="hs-identifier hs-var">evalForPair</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Singletons.Promote.html#promotePat"><span class="hs-identifier hs-var">promotePat</span></a><span> </span><a href="#local-6989586621679255366"><span class="hs-identifier hs-var">pat</span></a><span>
</span><a name="line-710"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a href="Data.Singletons.Syntax.html#PromDPatInfos"><span class="hs-identifier hs-var">PromDPatInfos</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">prom_dpat_vars</span><span>    </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679255371"><a href="#local-6989586621679255371"><span class="hs-identifier">new_vars</span></a></a><span>
</span><a name="line-711"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">prom_dpat_sig_kvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679255372"><a href="#local-6989586621679255372"><span class="hs-identifier">sig_kvs</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679255370"><span class="hs-identifier hs-var">prom_pat_infos</span></a><span>
</span><a name="line-712"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679255373"><a href="#local-6989586621679255373"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679255374"><a href="#local-6989586621679255374"><span class="hs-identifier">ann_exp</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Promote.Monad.html#forallBind"><span class="hs-identifier hs-var">forallBind</span></a><span> </span><a href="#local-6989586621679255372"><span class="hs-identifier hs-var">sig_kvs</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-713"></a><span>                    </span><a href="Data.Singletons.Promote.Monad.html#lambdaBind"><span class="hs-identifier hs-var">lambdaBind</span></a><span> </span><a href="#local-6989586621679255371"><span class="hs-identifier hs-var">new_vars</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-714"></a><span>                    </span><a href="Data.Singletons.Promote.html#promoteExp"><span class="hs-identifier hs-var">promoteExp</span></a><span> </span><a href="#local-6989586621679255367"><span class="hs-identifier hs-var">exp</span></a><span>
</span><a name="line-715"></a><span>  </span><a name="local-6989586621679255375"><a href="#local-6989586621679255375"><span class="hs-identifier">all_locals</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Promote.Monad.html#allLocals"><span class="hs-identifier hs-var">allLocals</span></a><span>
</span><a name="line-716"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">DTySynEqn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">DVarT</span><span> </span><a href="#local-6989586621679255375"><span class="hs-identifier hs-var">all_locals</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679255368"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679255373"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-717"></a><span>           </span><span class="hs-special">,</span><span> </span><a href="Data.Singletons.Syntax.html#ADMatch"><span class="hs-identifier hs-var">ADMatch</span></a><span> </span><a href="#local-6989586621679255371"><span class="hs-identifier hs-var">new_vars</span></a><span> </span><a href="#local-6989586621679255369"><span class="hs-identifier hs-var">pat'</span></a><span> </span><a href="#local-6989586621679255374"><span class="hs-identifier hs-var">ann_exp</span></a><span class="hs-special">)</span><span>
</span><a name="line-718"></a><span>
</span><a name="line-719"></a><span class="hs-comment">-- promotes a term pattern into a type pattern, accumulating bound variable names</span><span>
</span><a name="line-720"></a><span class="hs-identifier">promotePat</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DPat</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Util.html#QWithAux"><span class="hs-identifier hs-type">QWithAux</span></a><span> </span><a href="Data.Singletons.Syntax.html#PromDPatInfos"><span class="hs-identifier hs-type">PromDPatInfos</span></a><span> </span><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DType</span><span class="hs-special">,</span><span> </span><a href="Data.Singletons.Syntax.html#ADPat"><span class="hs-identifier hs-type">ADPat</span></a><span class="hs-special">)</span><span>
</span><a name="line-721"></a><a name="promotePat"><a href="Data.Singletons.Promote.html#promotePat"><span class="hs-identifier">promotePat</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DLitPa</span><span> </span><a name="local-6989586621679255376"><a href="#local-6989586621679255376"><span class="hs-identifier">lit</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span> </span><a href="Data.Singletons.Syntax.html#ADLitPa"><span class="hs-identifier hs-var">ADLitPa</span></a><span> </span><a href="#local-6989586621679255376"><span class="hs-identifier hs-var">lit</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Data.Singletons.Promote.html#promoteLitPat"><span class="hs-identifier hs-var">promoteLitPat</span></a><span> </span><a href="#local-6989586621679255376"><span class="hs-identifier hs-var">lit</span></a><span>
</span><a name="line-722"></a><span class="hs-identifier">promotePat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DVarPa</span><span> </span><a name="local-6989586621679255377"><a href="#local-6989586621679255377"><span class="hs-identifier">name</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-723"></a><span>      </span><span class="hs-comment">-- term vars can be symbols... type vars can't!</span><span>
</span><a name="line-724"></a><span>  </span><a name="local-6989586621679255378"><a href="#local-6989586621679255378"><span class="hs-identifier">tyName</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Names.html#mkTyName"><span class="hs-identifier hs-var">mkTyName</span></a><span> </span><a href="#local-6989586621679255377"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-725"></a><span>  </span><span class="hs-identifier hs-var">tell</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Singletons.Syntax.html#PromDPatInfos"><span class="hs-identifier hs-var">PromDPatInfos</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621679255377"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679255378"><span class="hs-identifier hs-var">tyName</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-identifier hs-var">Set.empty</span><span>
</span><a name="line-726"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DVarT</span><span> </span><a href="#local-6989586621679255378"><span class="hs-identifier hs-var">tyName</span></a><span class="hs-special">,</span><span> </span><a href="Data.Singletons.Syntax.html#ADVarPa"><span class="hs-identifier hs-var">ADVarPa</span></a><span> </span><a href="#local-6989586621679255377"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-727"></a><span class="hs-identifier">promotePat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DConPa</span><span> </span><a name="local-6989586621679255379"><a href="#local-6989586621679255379"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621679255380"><a href="#local-6989586621679255380"><span class="hs-identifier">pats</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-728"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679255384"><a href="#local-6989586621679255384"><span class="hs-identifier">types</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679255385"><a href="#local-6989586621679255385"><span class="hs-identifier">pats'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapAndUnzipM</span><span> </span><a href="Data.Singletons.Promote.html#promotePat"><span class="hs-identifier hs-var">promotePat</span></a><span> </span><a href="#local-6989586621679255380"><span class="hs-identifier hs-var">pats</span></a><span>
</span><a name="line-729"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679255386"><a href="#local-6989586621679255386"><span class="hs-identifier">name'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679255381"><span class="hs-identifier hs-var">unboxed_tuple_to_tuple</span></a><span> </span><a href="#local-6989586621679255379"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-730"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Util.html#foldType"><span class="hs-identifier hs-var">foldType</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DConT</span><span> </span><a href="#local-6989586621679255386"><span class="hs-identifier hs-var">name'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679255384"><span class="hs-identifier hs-var">types</span></a><span class="hs-special">,</span><span> </span><a href="Data.Singletons.Syntax.html#ADConPa"><span class="hs-identifier hs-var">ADConPa</span></a><span> </span><a href="#local-6989586621679255379"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679255385"><span class="hs-identifier hs-var">pats'</span></a><span class="hs-special">)</span><span>
</span><a name="line-731"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-732"></a><span>    </span><a name="local-6989586621679255381"><a href="#local-6989586621679255381"><span class="hs-identifier">unboxed_tuple_to_tuple</span></a></a><span> </span><a name="local-6989586621679255382"><a href="#local-6989586621679255382"><span class="hs-identifier">n</span></a></a><span>
</span><a name="line-733"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679255383"><a href="#local-6989586621679255383"><span class="hs-identifier">deg</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">unboxedTupleNameDegree_maybe</span><span> </span><a href="#local-6989586621679255382"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tupleDataName</span><span> </span><a href="#local-6989586621679255383"><span class="hs-identifier hs-var">deg</span></a><span>
</span><a name="line-734"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                                  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679255382"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-735"></a><span class="hs-identifier">promotePat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DTildePa</span><span> </span><a name="local-6989586621679255387"><a href="#local-6989586621679255387"><span class="hs-identifier">pat</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-736"></a><span>  </span><a href="Data.Singletons.Util.html#qReportWarning"><span class="hs-identifier hs-var">qReportWarning</span></a><span> </span><span class="hs-string">&quot;Lazy pattern converted into regular pattern in promotion&quot;</span><span>
</span><a name="line-737"></a><span>  </span><span class="hs-identifier hs-var">second</span><span> </span><a href="Data.Singletons.Syntax.html#ADTildePa"><span class="hs-identifier hs-var">ADTildePa</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Data.Singletons.Promote.html#promotePat"><span class="hs-identifier hs-var">promotePat</span></a><span> </span><a href="#local-6989586621679255387"><span class="hs-identifier hs-var">pat</span></a><span>
</span><a name="line-738"></a><span class="hs-identifier">promotePat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DBangPa</span><span> </span><a name="local-6989586621679255388"><a href="#local-6989586621679255388"><span class="hs-identifier">pat</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-739"></a><span>  </span><a href="Data.Singletons.Util.html#qReportWarning"><span class="hs-identifier hs-var">qReportWarning</span></a><span> </span><span class="hs-string">&quot;Strict pattern converted into regular pattern in promotion&quot;</span><span>
</span><a name="line-740"></a><span>  </span><span class="hs-identifier hs-var">second</span><span> </span><a href="Data.Singletons.Syntax.html#ADBangPa"><span class="hs-identifier hs-var">ADBangPa</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Data.Singletons.Promote.html#promotePat"><span class="hs-identifier hs-var">promotePat</span></a><span> </span><a href="#local-6989586621679255388"><span class="hs-identifier hs-var">pat</span></a><span>
</span><a name="line-741"></a><span class="hs-identifier">promotePat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DSigPa</span><span> </span><a name="local-6989586621679255389"><a href="#local-6989586621679255389"><span class="hs-identifier">pat</span></a></a><span> </span><a name="local-6989586621679255390"><a href="#local-6989586621679255390"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-742"></a><span>  </span><span class="hs-comment">-- We must maintain the invariant that any promoted pattern signature must</span><span>
</span><a name="line-743"></a><span>  </span><span class="hs-comment">-- not have any wildcards in the underlying pattern.</span><span>
</span><a name="line-744"></a><span>  </span><span class="hs-comment">-- See Note [Singling pattern signatures].</span><span>
</span><a name="line-745"></a><span>  </span><a name="local-6989586621679255391"><a href="#local-6989586621679255391"><span class="hs-identifier">wildless_pat</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">removeWilds</span><span> </span><a href="#local-6989586621679255389"><span class="hs-identifier hs-var">pat</span></a><span>
</span><a name="line-746"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679255392"><a href="#local-6989586621679255392"><span class="hs-identifier">promoted</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679255393"><a href="#local-6989586621679255393"><span class="hs-identifier">pat'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Promote.html#promotePat"><span class="hs-identifier hs-var">promotePat</span></a><span> </span><a href="#local-6989586621679255391"><span class="hs-identifier hs-var">wildless_pat</span></a><span>
</span><a name="line-747"></a><span>  </span><a name="local-6989586621679255394"><a href="#local-6989586621679255394"><span class="hs-identifier">ki</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Promote.Type.html#promoteType"><span class="hs-identifier hs-var">promoteType</span></a><span> </span><a href="#local-6989586621679255390"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-748"></a><span>  </span><span class="hs-identifier hs-var">tell</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Singletons.Syntax.html#PromDPatInfos"><span class="hs-identifier hs-var">PromDPatInfos</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fvDType</span><span> </span><a href="#local-6989586621679255394"><span class="hs-identifier hs-var">ki</span></a><span class="hs-special">)</span><span>
</span><a name="line-749"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DSigT</span><span> </span><a href="#local-6989586621679255392"><span class="hs-identifier hs-var">promoted</span></a><span> </span><a href="#local-6989586621679255394"><span class="hs-identifier hs-var">ki</span></a><span class="hs-special">,</span><span> </span><a href="Data.Singletons.Syntax.html#ADSigPa"><span class="hs-identifier hs-var">ADSigPa</span></a><span> </span><a href="#local-6989586621679255392"><span class="hs-identifier hs-var">promoted</span></a><span> </span><a href="#local-6989586621679255393"><span class="hs-identifier hs-var">pat'</span></a><span> </span><a href="#local-6989586621679255394"><span class="hs-identifier hs-var">ki</span></a><span class="hs-special">)</span><span>
</span><a name="line-750"></a><span class="hs-identifier">promotePat</span><span> </span><span class="hs-identifier hs-var">DWildPa</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DWildCardT</span><span class="hs-special">,</span><span> </span><a href="Data.Singletons.Syntax.html#ADWildPa"><span class="hs-identifier hs-var">ADWildPa</span></a><span class="hs-special">)</span><span>
</span><a name="line-751"></a><span>
</span><a name="line-752"></a><span class="hs-identifier">promoteExp</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DExp</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DType</span><span class="hs-special">,</span><span> </span><a href="Data.Singletons.Syntax.html#ADExp"><span class="hs-identifier hs-type">ADExp</span></a><span class="hs-special">)</span><span>
</span><a name="line-753"></a><a name="promoteExp"><a href="Data.Singletons.Promote.html#promoteExp"><span class="hs-identifier">promoteExp</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DVarE</span><span> </span><a name="local-6989586621679255395"><a href="#local-6989586621679255395"><span class="hs-identifier">name</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span> </span><a href="Data.Singletons.Syntax.html#ADVarE"><span class="hs-identifier hs-var">ADVarE</span></a><span> </span><a href="#local-6989586621679255395"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Singletons.Promote.Monad.html#lookupVarE"><span class="hs-identifier hs-var">lookupVarE</span></a><span> </span><a href="#local-6989586621679255395"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-754"></a><span class="hs-identifier">promoteExp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DConE</span><span> </span><a name="local-6989586621679255396"><a href="#local-6989586621679255396"><span class="hs-identifier">name</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Names.html#promoteValRhs"><span class="hs-identifier hs-var">promoteValRhs</span></a><span> </span><a href="#local-6989586621679255396"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">,</span><span> </span><a href="Data.Singletons.Syntax.html#ADConE"><span class="hs-identifier hs-var">ADConE</span></a><span> </span><a href="#local-6989586621679255396"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-755"></a><span class="hs-identifier">promoteExp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DLitE</span><span> </span><a name="local-6989586621679255397"><a href="#local-6989586621679255397"><span class="hs-identifier">lit</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span> </span><a href="Data.Singletons.Syntax.html#ADLitE"><span class="hs-identifier hs-var">ADLitE</span></a><span> </span><a href="#local-6989586621679255397"><span class="hs-identifier hs-var">lit</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Singletons.Promote.html#promoteLitExp"><span class="hs-identifier hs-var">promoteLitExp</span></a><span> </span><a href="#local-6989586621679255397"><span class="hs-identifier hs-var">lit</span></a><span>
</span><a name="line-756"></a><span class="hs-identifier">promoteExp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DAppE</span><span> </span><a name="local-6989586621679255398"><a href="#local-6989586621679255398"><span class="hs-identifier">exp1</span></a></a><span> </span><a name="local-6989586621679255399"><a href="#local-6989586621679255399"><span class="hs-identifier">exp2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-757"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679255400"><a href="#local-6989586621679255400"><span class="hs-identifier">exp1'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679255401"><a href="#local-6989586621679255401"><span class="hs-identifier">ann_exp1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Promote.html#promoteExp"><span class="hs-identifier hs-var">promoteExp</span></a><span> </span><a href="#local-6989586621679255398"><span class="hs-identifier hs-var">exp1</span></a><span>
</span><a name="line-758"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679255402"><a href="#local-6989586621679255402"><span class="hs-identifier">exp2'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679255403"><a href="#local-6989586621679255403"><span class="hs-identifier">ann_exp2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Promote.html#promoteExp"><span class="hs-identifier hs-var">promoteExp</span></a><span> </span><a href="#local-6989586621679255399"><span class="hs-identifier hs-var">exp2</span></a><span>
</span><a name="line-759"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Names.html#apply"><span class="hs-identifier hs-var">apply</span></a><span> </span><a href="#local-6989586621679255400"><span class="hs-identifier hs-var">exp1'</span></a><span> </span><a href="#local-6989586621679255402"><span class="hs-identifier hs-var">exp2'</span></a><span class="hs-special">,</span><span> </span><a href="Data.Singletons.Syntax.html#ADAppE"><span class="hs-identifier hs-var">ADAppE</span></a><span> </span><a href="#local-6989586621679255401"><span class="hs-identifier hs-var">ann_exp1</span></a><span> </span><a href="#local-6989586621679255403"><span class="hs-identifier hs-var">ann_exp2</span></a><span class="hs-special">)</span><span>
</span><a name="line-760"></a><span class="hs-comment">-- Until we get visible kind applications, this is the best we can do.</span><span>
</span><a name="line-761"></a><span class="hs-identifier">promoteExp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DAppTypeE</span><span> </span><a name="local-6989586621679255404"><a href="#local-6989586621679255404"><span class="hs-identifier">exp</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-762"></a><span>  </span><a href="Data.Singletons.Util.html#qReportWarning"><span class="hs-identifier hs-var">qReportWarning</span></a><span> </span><span class="hs-string">&quot;Visible type applications are ignored by `singletons`.&quot;</span><span>
</span><a name="line-763"></a><span>  </span><a href="Data.Singletons.Promote.html#promoteExp"><span class="hs-identifier hs-var">promoteExp</span></a><span> </span><a href="#local-6989586621679255404"><span class="hs-identifier hs-var">exp</span></a><span>
</span><a name="line-764"></a><span class="hs-identifier">promoteExp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DLamE</span><span> </span><a name="local-6989586621679255405"><a href="#local-6989586621679255405"><span class="hs-identifier">names</span></a></a><span> </span><a name="local-6989586621679255406"><a href="#local-6989586621679255406"><span class="hs-identifier">exp</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-765"></a><span>  </span><a name="local-6989586621679255407"><a href="#local-6989586621679255407"><span class="hs-identifier">lambdaName</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newUniqueName</span><span> </span><span class="hs-string">&quot;Lambda&quot;</span><span>
</span><a name="line-766"></a><span>  </span><a name="local-6989586621679255408"><a href="#local-6989586621679255408"><span class="hs-identifier">tyNames</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="Data.Singletons.Names.html#mkTyName"><span class="hs-identifier hs-var">mkTyName</span></a><span> </span><a href="#local-6989586621679255405"><span class="hs-identifier hs-var">names</span></a><span>
</span><a name="line-767"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679255409"><a href="#local-6989586621679255409"><span class="hs-identifier">var_proms</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621679255405"><span class="hs-identifier hs-var">names</span></a><span> </span><a href="#local-6989586621679255408"><span class="hs-identifier hs-var">tyNames</span></a><span>
</span><a name="line-768"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679255410"><a href="#local-6989586621679255410"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679255411"><a href="#local-6989586621679255411"><span class="hs-identifier">ann_exp</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Promote.Monad.html#lambdaBind"><span class="hs-identifier hs-var">lambdaBind</span></a><span> </span><a href="#local-6989586621679255409"><span class="hs-identifier hs-var">var_proms</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Singletons.Promote.html#promoteExp"><span class="hs-identifier hs-var">promoteExp</span></a><span> </span><a href="#local-6989586621679255406"><span class="hs-identifier hs-var">exp</span></a><span>
</span><a name="line-769"></a><span>  </span><a name="local-6989586621679255412"><a href="#local-6989586621679255412"><span class="hs-identifier">tyFamLamTypes</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">qNewName</span><span> </span><span class="hs-string">&quot;t&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679255405"><span class="hs-identifier hs-var">names</span></a><span>
</span><a name="line-770"></a><span>  </span><a name="local-6989586621679255413"><a href="#local-6989586621679255413"><span class="hs-identifier">all_locals</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Promote.Monad.html#allLocals"><span class="hs-identifier hs-var">allLocals</span></a><span>
</span><a name="line-771"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679255414"><a href="#local-6989586621679255414"><span class="hs-identifier">all_args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679255413"><span class="hs-identifier hs-var">all_locals</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679255412"><span class="hs-identifier hs-var">tyFamLamTypes</span></a><span>
</span><a name="line-772"></a><span>      </span><a name="local-6989586621679255415"><a href="#local-6989586621679255415"><span class="hs-identifier">tvbs</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">DPlainTV</span><span> </span><a href="#local-6989586621679255414"><span class="hs-identifier hs-var">all_args</span></a><span>
</span><a name="line-773"></a><span>  </span><a href="Data.Singletons.Promote.Monad.html#emitDecs"><span class="hs-identifier hs-var">emitDecs</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">DClosedTypeFamilyD</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DTypeFamilyHead</span><span>
</span><a name="line-774"></a><span>                                 </span><a href="#local-6989586621679255407"><span class="hs-identifier hs-var">lambdaName</span></a><span>
</span><a name="line-775"></a><span>                                 </span><a href="#local-6989586621679255415"><span class="hs-identifier hs-var">tvbs</span></a><span>
</span><a name="line-776"></a><span>                                 </span><span class="hs-identifier hs-var">DNoSig</span><span>
</span><a name="line-777"></a><span>                                 </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span>
</span><a name="line-778"></a><span>                               </span><span class="hs-special">[</span><span class="hs-identifier hs-var">DTySynEqn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">DVarT</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679255413"><span class="hs-identifier hs-var">all_locals</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679255408"><span class="hs-identifier hs-var">tyNames</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-779"></a><span>                                          </span><a href="#local-6989586621679255410"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-780"></a><span>  </span><a href="Data.Singletons.Promote.Monad.html#emitDecsM"><span class="hs-identifier hs-var">emitDecsM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Singletons.Promote.Defun.html#defunctionalize"><span class="hs-identifier hs-var">defunctionalize</span></a><span> </span><a href="#local-6989586621679255407"><span class="hs-identifier hs-var">lambdaName</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621679255415"><span class="hs-identifier hs-var">tvbs</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-781"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679255416"><a href="#local-6989586621679255416"><span class="hs-identifier">promLambda</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldl</span><span> </span><a href="Data.Singletons.Names.html#apply"><span class="hs-identifier hs-var">apply</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DConT</span><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Names.html#promoteTySym"><span class="hs-identifier hs-var">promoteTySym</span></a><span> </span><a href="#local-6989586621679255407"><span class="hs-identifier hs-var">lambdaName</span></a><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-782"></a><span>                               </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">DVarT</span><span> </span><a href="#local-6989586621679255413"><span class="hs-identifier hs-var">all_locals</span></a><span class="hs-special">)</span><span>
</span><a name="line-783"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679255416"><span class="hs-identifier hs-var">promLambda</span></a><span class="hs-special">,</span><span> </span><a href="Data.Singletons.Syntax.html#ADLamE"><span class="hs-identifier hs-var">ADLamE</span></a><span> </span><a href="#local-6989586621679255408"><span class="hs-identifier hs-var">tyNames</span></a><span> </span><a href="#local-6989586621679255416"><span class="hs-identifier hs-var">promLambda</span></a><span> </span><a href="#local-6989586621679255405"><span class="hs-identifier hs-var">names</span></a><span> </span><a href="#local-6989586621679255411"><span class="hs-identifier hs-var">ann_exp</span></a><span class="hs-special">)</span><span>
</span><a name="line-784"></a><span class="hs-identifier">promoteExp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DCaseE</span><span> </span><a name="local-6989586621679255417"><a href="#local-6989586621679255417"><span class="hs-identifier">exp</span></a></a><span> </span><a name="local-6989586621679255418"><a href="#local-6989586621679255418"><span class="hs-identifier">matches</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-785"></a><span>  </span><a name="local-6989586621679255419"><a href="#local-6989586621679255419"><span class="hs-identifier">caseTFName</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newUniqueName</span><span> </span><span class="hs-string">&quot;Case&quot;</span><span>
</span><a name="line-786"></a><span>  </span><a name="local-6989586621679255420"><a href="#local-6989586621679255420"><span class="hs-identifier">all_locals</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Promote.Monad.html#allLocals"><span class="hs-identifier hs-var">allLocals</span></a><span>
</span><a name="line-787"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679255421"><a href="#local-6989586621679255421"><span class="hs-identifier">prom_case</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Util.html#foldType"><span class="hs-identifier hs-var">foldType</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DConT</span><span> </span><a href="#local-6989586621679255419"><span class="hs-identifier hs-var">caseTFName</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">DVarT</span><span> </span><a href="#local-6989586621679255420"><span class="hs-identifier hs-var">all_locals</span></a><span class="hs-special">)</span><span>
</span><a name="line-788"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679255422"><a href="#local-6989586621679255422"><span class="hs-identifier">exp'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679255423"><a href="#local-6989586621679255423"><span class="hs-identifier">ann_exp</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Promote.html#promoteExp"><span class="hs-identifier hs-var">promoteExp</span></a><span> </span><a href="#local-6989586621679255417"><span class="hs-identifier hs-var">exp</span></a><span>
</span><a name="line-789"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679255424"><a href="#local-6989586621679255424"><span class="hs-identifier">eqns</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679255425"><a href="#local-6989586621679255425"><span class="hs-identifier">ann_matches</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapAndUnzipM</span><span> </span><a href="Data.Singletons.Promote.html#promoteMatch"><span class="hs-identifier hs-var">promoteMatch</span></a><span> </span><a href="#local-6989586621679255418"><span class="hs-identifier hs-var">matches</span></a><span>
</span><a name="line-790"></a><span>  </span><a name="local-6989586621679255426"><a href="#local-6989586621679255426"><span class="hs-identifier">tyvarName</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">qNewName</span><span> </span><span class="hs-string">&quot;t&quot;</span><span>
</span><a name="line-791"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679255427"><a href="#local-6989586621679255427"><span class="hs-identifier">all_args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679255420"><span class="hs-identifier hs-var">all_locals</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679255426"><span class="hs-identifier hs-var">tyvarName</span></a><span class="hs-special">]</span><span>
</span><a name="line-792"></a><span>      </span><a name="local-6989586621679255428"><a href="#local-6989586621679255428"><span class="hs-identifier">tvbs</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">DPlainTV</span><span> </span><a href="#local-6989586621679255427"><span class="hs-identifier hs-var">all_args</span></a><span>
</span><a name="line-793"></a><span>  </span><a href="Data.Singletons.Promote.Monad.html#emitDecs"><span class="hs-identifier hs-var">emitDecs</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">DClosedTypeFamilyD</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DTypeFamilyHead</span><span> </span><a href="#local-6989586621679255419"><span class="hs-identifier hs-var">caseTFName</span></a><span> </span><a href="#local-6989586621679255428"><span class="hs-identifier hs-var">tvbs</span></a><span> </span><span class="hs-identifier hs-var">DNoSig</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679255424"><span class="hs-identifier hs-var">eqns</span></a><span class="hs-special">]</span><span>
</span><a name="line-794"></a><span>    </span><span class="hs-comment">-- See Note [Annotate case return type] in Single</span><span>
</span><a name="line-795"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679255429"><a href="#local-6989586621679255429"><span class="hs-identifier">applied_case</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679255421"><span class="hs-identifier hs-var">prom_case</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">DAppT</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679255422"><span class="hs-identifier hs-var">exp'</span></a><span>
</span><a name="line-796"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621679255429"><span class="hs-identifier hs-var">applied_case</span></a><span>
</span><a name="line-797"></a><span>         </span><span class="hs-special">,</span><span> </span><a href="Data.Singletons.Syntax.html#ADCaseE"><span class="hs-identifier hs-var">ADCaseE</span></a><span> </span><a href="#local-6989586621679255423"><span class="hs-identifier hs-var">ann_exp</span></a><span> </span><a href="#local-6989586621679255425"><span class="hs-identifier hs-var">ann_matches</span></a><span> </span><a href="#local-6989586621679255429"><span class="hs-identifier hs-var">applied_case</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-798"></a><span class="hs-identifier">promoteExp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DLetE</span><span> </span><a name="local-6989586621679255430"><a href="#local-6989586621679255430"><span class="hs-identifier">decs</span></a></a><span> </span><a name="local-6989586621679255431"><a href="#local-6989586621679255431"><span class="hs-identifier">exp</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-799"></a><span>  </span><a name="local-6989586621679255432"><a href="#local-6989586621679255432"><span class="hs-identifier">unique</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Util.html#qNewUnique"><span class="hs-identifier hs-var">qNewUnique</span></a><span>
</span><a name="line-800"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679255433"><a href="#local-6989586621679255433"><span class="hs-identifier">letPrefixes</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Util.html#uniquePrefixes"><span class="hs-identifier hs-var">uniquePrefixes</span></a><span> </span><span class="hs-string">&quot;Let&quot;</span><span> </span><span class="hs-string">&quot;&lt;&lt;&lt;&quot;</span><span> </span><a href="#local-6989586621679255432"><span class="hs-identifier hs-var">unique</span></a><span>
</span><a name="line-801"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679255434"><a href="#local-6989586621679255434"><span class="hs-identifier">binds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679255435"><a href="#local-6989586621679255435"><span class="hs-identifier">ann_env</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Promote.html#promoteLetDecs"><span class="hs-identifier hs-var">promoteLetDecs</span></a><span> </span><a href="#local-6989586621679255433"><span class="hs-identifier hs-var">letPrefixes</span></a><span> </span><a href="#local-6989586621679255430"><span class="hs-identifier hs-var">decs</span></a><span>
</span><a name="line-802"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679255436"><a href="#local-6989586621679255436"><span class="hs-identifier">exp'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679255437"><a href="#local-6989586621679255437"><span class="hs-identifier">ann_exp</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Promote.Monad.html#letBind"><span class="hs-identifier hs-var">letBind</span></a><span> </span><a href="#local-6989586621679255434"><span class="hs-identifier hs-var">binds</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Singletons.Promote.html#promoteExp"><span class="hs-identifier hs-var">promoteExp</span></a><span> </span><a href="#local-6989586621679255431"><span class="hs-identifier hs-var">exp</span></a><span>
</span><a name="line-803"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679255436"><span class="hs-identifier hs-var">exp'</span></a><span class="hs-special">,</span><span> </span><a href="Data.Singletons.Syntax.html#ADLetE"><span class="hs-identifier hs-var">ADLetE</span></a><span> </span><a href="#local-6989586621679255435"><span class="hs-identifier hs-var">ann_env</span></a><span> </span><a href="#local-6989586621679255437"><span class="hs-identifier hs-var">ann_exp</span></a><span class="hs-special">)</span><span>
</span><a name="line-804"></a><span class="hs-identifier">promoteExp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DSigE</span><span> </span><a name="local-6989586621679255438"><a href="#local-6989586621679255438"><span class="hs-identifier">exp</span></a></a><span> </span><a name="local-6989586621679255439"><a href="#local-6989586621679255439"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-805"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679255440"><a href="#local-6989586621679255440"><span class="hs-identifier">exp'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679255441"><a href="#local-6989586621679255441"><span class="hs-identifier">ann_exp</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Promote.html#promoteExp"><span class="hs-identifier hs-var">promoteExp</span></a><span> </span><a href="#local-6989586621679255438"><span class="hs-identifier hs-var">exp</span></a><span>
</span><a name="line-806"></a><span>  </span><a name="local-6989586621679255442"><a href="#local-6989586621679255442"><span class="hs-identifier">ty'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Promote.Type.html#promoteType"><span class="hs-identifier hs-var">promoteType</span></a><span> </span><a href="#local-6989586621679255439"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-807"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DSigT</span><span> </span><a href="#local-6989586621679255440"><span class="hs-identifier hs-var">exp'</span></a><span> </span><a href="#local-6989586621679255442"><span class="hs-identifier hs-var">ty'</span></a><span class="hs-special">,</span><span> </span><a href="Data.Singletons.Syntax.html#ADSigE"><span class="hs-identifier hs-var">ADSigE</span></a><span> </span><a href="#local-6989586621679255440"><span class="hs-identifier hs-var">exp'</span></a><span> </span><a href="#local-6989586621679255441"><span class="hs-identifier hs-var">ann_exp</span></a><span> </span><a href="#local-6989586621679255439"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-808"></a><span class="hs-identifier">promoteExp</span><span> </span><a name="local-6989586621679255443"><a href="#local-6989586621679255443"><span class="hs-identifier">e</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">DStaticE</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Static expressions cannot be promoted: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679255443"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-809"></a><span>
</span><a name="line-810"></a><span class="hs-identifier">promoteLitExp</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Quasi</span><span> </span><a href="#local-6989586621679255082"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Lit</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679255082"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-identifier hs-type">DType</span><span>
</span><a name="line-811"></a><a name="promoteLitExp"><a href="Data.Singletons.Promote.html#promoteLitExp"><span class="hs-identifier">promoteLitExp</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">IntegerL</span><span> </span><a name="local-6989586621679255444"><a href="#local-6989586621679255444"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-812"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679255444"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><span class="hs-number">0</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DConT</span><span> </span><a href="Data.Singletons.Names.html#tyFromIntegerName"><span class="hs-identifier hs-var">tyFromIntegerName</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">DAppT</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">DLitT</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NumTyLit</span><span> </span><a href="#local-6989586621679255444"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-813"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DConT</span><span> </span><a href="Data.Singletons.Names.html#tyNegateName"><span class="hs-identifier hs-var">tyNegateName</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">DAppT</span><span class="hs-special">`</span><span>
</span><a name="line-814"></a><span>                          </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DConT</span><span> </span><a href="Data.Singletons.Names.html#tyFromIntegerName"><span class="hs-identifier hs-var">tyFromIntegerName</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">DAppT</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">DLitT</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NumTyLit</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><a href="#local-6989586621679255444"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-815"></a><span class="hs-identifier">promoteLitExp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">StringL</span><span> </span><a name="local-6989586621679255445"><a href="#local-6989586621679255445"><span class="hs-identifier">str</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-816"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679255446"><a href="#local-6989586621679255446"><span class="hs-identifier">prom_str_lit</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">DLitT</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">StrTyLit</span><span> </span><a href="#local-6989586621679255445"><span class="hs-identifier hs-var">str</span></a><span class="hs-special">)</span><span>
</span><a name="line-817"></a><span>  </span><a name="local-6989586621679255447"><a href="#local-6989586621679255447"><span class="hs-identifier">os_enabled</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">qIsExtEnabled</span><span> </span><span class="hs-identifier hs-var">LangExt.OverloadedStrings</span><span>
</span><a name="line-818"></a><span>  </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679255447"><span class="hs-identifier hs-var">os_enabled</span></a><span>
</span><a name="line-819"></a><span>         </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">DConT</span><span> </span><a href="Data.Singletons.Names.html#tyFromStringName"><span class="hs-identifier hs-var">tyFromStringName</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">DAppT</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679255446"><span class="hs-identifier hs-var">prom_str_lit</span></a><span>
</span><a name="line-820"></a><span>         </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621679255446"><span class="hs-identifier hs-var">prom_str_lit</span></a><span>
</span><a name="line-821"></a><span class="hs-identifier">promoteLitExp</span><span> </span><a name="local-6989586621679255448"><a href="#local-6989586621679255448"><span class="hs-identifier">lit</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-822"></a><span>  </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Only string and natural number literals can be promoted: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679255448"><span class="hs-identifier hs-var">lit</span></a><span class="hs-special">)</span><span>
</span><a name="line-823"></a><span>
</span><a name="line-824"></a><span class="hs-identifier">promoteLitPat</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679255081"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Lit</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679255081"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">DType</span><span>
</span><a name="line-825"></a><a name="promoteLitPat"><a href="Data.Singletons.Promote.html#promoteLitPat"><span class="hs-identifier">promoteLitPat</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">IntegerL</span><span> </span><a name="local-6989586621679255449"><a href="#local-6989586621679255449"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-826"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679255449"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><span class="hs-number">0</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DLitT</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NumTyLit</span><span> </span><a href="#local-6989586621679255449"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-827"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-828"></a><span>    </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Negative literal patterns are not allowed,\n&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-829"></a><span>           </span><span class="hs-string">&quot;because literal patterns are promoted to natural numbers.&quot;</span><span>
</span><a name="line-830"></a><span class="hs-identifier">promoteLitPat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">StringL</span><span> </span><a name="local-6989586621679255450"><a href="#local-6989586621679255450"><span class="hs-identifier">str</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">DLitT</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">StrTyLit</span><span> </span><a href="#local-6989586621679255450"><span class="hs-identifier hs-var">str</span></a><span class="hs-special">)</span><span>
</span><a name="line-831"></a><span class="hs-identifier">promoteLitPat</span><span> </span><a name="local-6989586621679255451"><a href="#local-6989586621679255451"><span class="hs-identifier">lit</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-832"></a><span>  </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Only string and natural number literals can be promoted: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679255451"><span class="hs-identifier hs-var">lit</span></a><span class="hs-special">)</span><span>
</span><a name="line-833"></a><span>
</span><a name="line-834"></a><span class="hs-comment">-- See Note [DerivedDecl]</span><span>
</span><a name="line-835"></a><span class="hs-identifier">promoteDerivedEqDec</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Singletons.Syntax.html#DerivedEqDecl"><span class="hs-identifier hs-type">DerivedEqDecl</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-836"></a><a name="promoteDerivedEqDec"><a href="Data.Singletons.Promote.html#promoteDerivedEqDec"><span class="hs-identifier">promoteDerivedEqDec</span></a></a><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Syntax.html#DerivedDecl"><span class="hs-identifier hs-var">DerivedDecl</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ded_type</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679255452"><a href="#local-6989586621679255452"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-837"></a><span>                                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ded_decl</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Syntax.html#DataDecl"><span class="hs-identifier hs-var">DataDecl</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679255453"><a href="#local-6989586621679255453"><span class="hs-identifier">cons</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-838"></a><span>  </span><a name="local-6989586621679255454"><a href="#local-6989586621679255454"><span class="hs-identifier">kind</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Promote.Type.html#promoteType"><span class="hs-identifier hs-var">promoteType</span></a><span> </span><a href="#local-6989586621679255452"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-839"></a><span>  </span><a name="local-6989586621679255455"><a href="#local-6989586621679255455"><span class="hs-identifier">inst_decs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Promote.Eq.html#mkEqTypeInstance"><span class="hs-identifier hs-var">mkEqTypeInstance</span></a><span> </span><a href="#local-6989586621679255454"><span class="hs-identifier hs-var">kind</span></a><span> </span><a href="#local-6989586621679255453"><span class="hs-identifier hs-var">cons</span></a><span>
</span><a name="line-840"></a><span>  </span><a href="Data.Singletons.Promote.Monad.html#emitDecs"><span class="hs-identifier hs-var">emitDecs</span></a><span> </span><a href="#local-6989586621679255455"><span class="hs-identifier hs-var">inst_decs</span></a><span>
</span><a name="line-841"></a></pre></body></html>