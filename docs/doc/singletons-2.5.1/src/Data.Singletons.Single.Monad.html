<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{- Data/Singletons/Single/Monad.hs

(c) Richard Eisenberg 2014
rae@cs.brynmawr.edu

This file defines the SgM monad and its operations, for use during singling.

The SgM monad allows reading from a SgEnv environment and is wrapped around a Q.
-}</span><span>
</span><a name="line-10"></a><span>
</span><a name="line-11"></a><span class="hs-pragma">{-# LANGUAGE GeneralizedNewtypeDeriving, ParallelListComp, TemplateHaskell #-}</span><span>
</span><a name="line-12"></a><span>
</span><a name="line-13"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Data.Singletons.Single.Monad</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-14"></a><span>  </span><a href="Data.Singletons.Single.Monad.html#SgM"><span class="hs-identifier hs-type">SgM</span></a><span class="hs-special">,</span><span> </span><a href="Data.Singletons.Single.Monad.html#bindLets"><span class="hs-identifier hs-var">bindLets</span></a><span class="hs-special">,</span><span> </span><a href="Data.Singletons.Single.Monad.html#bindContext"><span class="hs-identifier hs-var">bindContext</span></a><span class="hs-special">,</span><span> </span><a href="Data.Singletons.Single.Monad.html#askContext"><span class="hs-identifier hs-var">askContext</span></a><span class="hs-special">,</span><span> </span><a href="Data.Singletons.Single.Monad.html#lookupVarE"><span class="hs-identifier hs-var">lookupVarE</span></a><span class="hs-special">,</span><span> </span><a href="Data.Singletons.Single.Monad.html#lookupConE"><span class="hs-identifier hs-var">lookupConE</span></a><span class="hs-special">,</span><span>
</span><a name="line-15"></a><span>  </span><a href="Data.Singletons.Single.Monad.html#wrapSingFun"><span class="hs-identifier hs-var">wrapSingFun</span></a><span class="hs-special">,</span><span> </span><a href="Data.Singletons.Single.Monad.html#wrapUnSingFun"><span class="hs-identifier hs-var">wrapUnSingFun</span></a><span class="hs-special">,</span><span>
</span><a name="line-16"></a><span>  </span><a href="Data.Singletons.Single.Monad.html#singM"><span class="hs-identifier hs-var">singM</span></a><span class="hs-special">,</span><span> </span><a href="Data.Singletons.Single.Monad.html#singDecsM"><span class="hs-identifier hs-var">singDecsM</span></a><span class="hs-special">,</span><span>
</span><a name="line-17"></a><span>  </span><a href="Data.Singletons.Promote.Monad.html#emitDecs"><span class="hs-identifier hs-var">emitDecs</span></a><span class="hs-special">,</span><span> </span><a href="Data.Singletons.Promote.Monad.html#emitDecsM"><span class="hs-identifier hs-var">emitDecsM</span></a><span>
</span><a name="line-18"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-19"></a><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Prelude</span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">exp</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Map</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Map</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Map</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Singletons.Promote.Monad.html"><span class="hs-identifier">Data.Singletons.Promote.Monad</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="Data.Singletons.Promote.Monad.html#emitDecs"><span class="hs-identifier hs-var">emitDecs</span></a><span class="hs-special">,</span><span> </span><a href="Data.Singletons.Promote.Monad.html#emitDecsM"><span class="hs-identifier hs-var">emitDecsM</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Singletons.Names.html"><span class="hs-identifier">Data.Singletons.Names</span></a><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Singletons.Util.html"><span class="hs-identifier">Data.Singletons.Util</span></a><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Singletons.Internal.html"><span class="hs-identifier">Data.Singletons.Internal</span></a><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Language.Haskell.TH.Syntax</span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">lift</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Language.Haskell.TH.Desugar</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.Reader</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.Writer</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Applicative</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.Fail</span><span>
</span><a name="line-33"></a><span>
</span><a name="line-34"></a><span class="hs-comment">-- environment during singling</span><span>
</span><a name="line-35"></a><span class="hs-keyword">data</span><span> </span><a name="SgEnv"><a href="Data.Singletons.Single.Monad.html#SgEnv"><span class="hs-identifier">SgEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-36"></a><span>  </span><a name="SgEnv"><a href="Data.Singletons.Single.Monad.html#SgEnv"><span class="hs-identifier">SgEnv</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="sg_let_binds"><a href="Data.Singletons.Single.Monad.html#sg_let_binds"><span class="hs-identifier">sg_let_binds</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-identifier hs-type">DExp</span><span>   </span><span class="hs-comment">-- from the *original* name</span><span>
</span><a name="line-37"></a><span>        </span><span class="hs-special">,</span><span> </span><a name="sg_context"><a href="Data.Singletons.Single.Monad.html#sg_context"><span class="hs-identifier">sg_context</span></a></a><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DCxt</span><span> </span><span class="hs-comment">-- See Note [Tracking the current type signature context]</span><span>
</span><a name="line-38"></a><span>        </span><span class="hs-special">,</span><span> </span><a name="sg_local_decls"><a href="Data.Singletons.Single.Monad.html#sg_local_decls"><span class="hs-identifier">sg_local_decls</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span>
</span><a name="line-39"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-40"></a><span>
</span><a name="line-41"></a><span class="hs-identifier">emptySgEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Singletons.Single.Monad.html#SgEnv"><span class="hs-identifier hs-type">SgEnv</span></a><span>
</span><a name="line-42"></a><a name="emptySgEnv"><a href="Data.Singletons.Single.Monad.html#emptySgEnv"><span class="hs-identifier">emptySgEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Single.Monad.html#SgEnv"><span class="hs-identifier hs-var">SgEnv</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sg_let_binds</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.empty</span><span>
</span><a name="line-43"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sg_context</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-44"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sg_local_decls</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-45"></a><span>                   </span><span class="hs-special">}</span><span>
</span><a name="line-46"></a><span>
</span><a name="line-47"></a><span class="hs-comment">-- the singling monad</span><span>
</span><a name="line-48"></a><span class="hs-keyword">newtype</span><span> </span><a name="SgM"><a href="Data.Singletons.Single.Monad.html#SgM"><span class="hs-identifier">SgM</span></a></a><span> </span><a name="local-6989586621679169945"><a href="#local-6989586621679169945"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="SgM"><a href="Data.Singletons.Single.Monad.html#SgM"><span class="hs-identifier">SgM</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ReaderT</span><span> </span><a href="Data.Singletons.Single.Monad.html#SgEnv"><span class="hs-identifier hs-type">SgEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">WriterT</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DDec</span><span class="hs-special">]</span><span> </span><span class="hs-identifier hs-type">Q</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679169945"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-49"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Functor</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Applicative</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Monad</span><span>
</span><a name="line-50"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadReader</span><span> </span><a href="Data.Singletons.Single.Monad.html#SgEnv"><span class="hs-identifier hs-type">SgEnv</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadWriter</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DDec</span><span class="hs-special">]</span><span>
</span><a name="line-51"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadFail</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-52"></a><span>
</span><a name="line-53"></a><span class="hs-identifier">liftSgM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><a href="#local-6989586621679169956"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Single.Monad.html#SgM"><span class="hs-identifier hs-type">SgM</span></a><span> </span><a href="#local-6989586621679169956"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-54"></a><a name="liftSgM"><a href="Data.Singletons.Single.Monad.html#liftSgM"><span class="hs-identifier">liftSgM</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Single.Monad.html#SgM"><span class="hs-identifier hs-var">SgM</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">lift</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">lift</span><span>
</span><a name="line-55"></a><span>
</span><a name="line-56"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Quasi</span><span> </span><a href="Data.Singletons.Single.Monad.html#SgM"><span class="hs-identifier hs-type">SgM</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-57"></a><span>  </span><a name="local-8214565720323795227"><span class="hs-identifier">qNewName</span></a><span>          </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Single.Monad.html#liftSgM"><span class="hs-identifier hs-var">liftSgM</span></a><span> </span><span class="hs-special">`</span><a href="Data.Singletons.Util.html#comp1"><span class="hs-identifier hs-var">comp1</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">qNewName</span><span>
</span><a name="line-58"></a><span>  </span><a name="local-8214565720323795226"><span class="hs-identifier">qReport</span></a><span>           </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Single.Monad.html#liftSgM"><span class="hs-identifier hs-var">liftSgM</span></a><span> </span><span class="hs-special">`</span><a href="Data.Singletons.Util.html#comp2"><span class="hs-identifier hs-var">comp2</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">qReport</span><span>
</span><a name="line-59"></a><span>  </span><a name="local-8214565720323795224"><span class="hs-identifier">qLookupName</span></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Single.Monad.html#liftSgM"><span class="hs-identifier hs-var">liftSgM</span></a><span> </span><span class="hs-special">`</span><a href="Data.Singletons.Util.html#comp2"><span class="hs-identifier hs-var">comp2</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">qLookupName</span><span>
</span><a name="line-60"></a><span>  </span><a name="local-8214565720323795223"><span class="hs-identifier">qReify</span></a><span>            </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Single.Monad.html#liftSgM"><span class="hs-identifier hs-var">liftSgM</span></a><span> </span><span class="hs-special">`</span><a href="Data.Singletons.Util.html#comp1"><span class="hs-identifier hs-var">comp1</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">qReify</span><span>
</span><a name="line-61"></a><span>  </span><a name="local-8214565720323795221"><span class="hs-identifier">qReifyInstances</span></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Single.Monad.html#liftSgM"><span class="hs-identifier hs-var">liftSgM</span></a><span> </span><span class="hs-special">`</span><a href="Data.Singletons.Util.html#comp2"><span class="hs-identifier hs-var">comp2</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">qReifyInstances</span><span>
</span><a name="line-62"></a><span>  </span><a name="local-8214565720323795216"><span class="hs-identifier">qLocation</span></a><span>         </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Single.Monad.html#liftSgM"><span class="hs-identifier hs-var">liftSgM</span></a><span> </span><span class="hs-identifier hs-var">qLocation</span><span>
</span><a name="line-63"></a><span>  </span><a name="local-8214565720323795215"><span class="hs-identifier">qRunIO</span></a><span>            </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Single.Monad.html#liftSgM"><span class="hs-identifier hs-var">liftSgM</span></a><span> </span><span class="hs-special">`</span><a href="Data.Singletons.Util.html#comp1"><span class="hs-identifier hs-var">comp1</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">qRunIO</span><span>
</span><a name="line-64"></a><span>  </span><a name="local-8214565720323795214"><span class="hs-identifier">qAddDependentFile</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Single.Monad.html#liftSgM"><span class="hs-identifier hs-var">liftSgM</span></a><span> </span><span class="hs-special">`</span><a href="Data.Singletons.Util.html#comp1"><span class="hs-identifier hs-var">comp1</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">qAddDependentFile</span><span>
</span><a name="line-65"></a><span>  </span><a name="local-8214565720323795220"><span class="hs-identifier">qReifyRoles</span></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Single.Monad.html#liftSgM"><span class="hs-identifier hs-var">liftSgM</span></a><span> </span><span class="hs-special">`</span><a href="Data.Singletons.Util.html#comp1"><span class="hs-identifier hs-var">comp1</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">qReifyRoles</span><span>
</span><a name="line-66"></a><span>  </span><a name="local-8214565720323795219"><span class="hs-identifier">qReifyAnnotations</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Single.Monad.html#liftSgM"><span class="hs-identifier hs-var">liftSgM</span></a><span> </span><span class="hs-special">`</span><a href="Data.Singletons.Util.html#comp1"><span class="hs-identifier hs-var">comp1</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">qReifyAnnotations</span><span>
</span><a name="line-67"></a><span>  </span><a name="local-8214565720323795218"><span class="hs-identifier">qReifyModule</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Single.Monad.html#liftSgM"><span class="hs-identifier hs-var">liftSgM</span></a><span> </span><span class="hs-special">`</span><a href="Data.Singletons.Util.html#comp1"><span class="hs-identifier hs-var">comp1</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">qReifyModule</span><span>
</span><a name="line-68"></a><span>  </span><a name="local-8214565720323795212"><span class="hs-identifier">qAddTopDecls</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Single.Monad.html#liftSgM"><span class="hs-identifier hs-var">liftSgM</span></a><span> </span><span class="hs-special">`</span><a href="Data.Singletons.Util.html#comp1"><span class="hs-identifier hs-var">comp1</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">qAddTopDecls</span><span>
</span><a name="line-69"></a><span>  </span><a name="local-8214565720323795210"><span class="hs-identifier">qAddModFinalizer</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Single.Monad.html#liftSgM"><span class="hs-identifier hs-var">liftSgM</span></a><span> </span><span class="hs-special">`</span><a href="Data.Singletons.Util.html#comp1"><span class="hs-identifier hs-var">comp1</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">qAddModFinalizer</span><span>
</span><a name="line-70"></a><span>  </span><a name="local-8214565720323795208"><span class="hs-identifier">qGetQ</span></a><span>             </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Single.Monad.html#liftSgM"><span class="hs-identifier hs-var">liftSgM</span></a><span> </span><span class="hs-identifier hs-var">qGetQ</span><span>
</span><a name="line-71"></a><span>  </span><a name="local-8214565720323795207"><span class="hs-identifier">qPutQ</span></a><span>             </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Single.Monad.html#liftSgM"><span class="hs-identifier hs-var">liftSgM</span></a><span> </span><span class="hs-special">`</span><a href="Data.Singletons.Util.html#comp1"><span class="hs-identifier hs-var">comp1</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">qPutQ</span><span>
</span><a name="line-72"></a><span>
</span><a name="line-73"></a><span>  </span><a name="local-8214565720323795222"><span class="hs-identifier">qReifyFixity</span></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Single.Monad.html#liftSgM"><span class="hs-identifier hs-var">liftSgM</span></a><span> </span><span class="hs-special">`</span><a href="Data.Singletons.Util.html#comp1"><span class="hs-identifier hs-var">comp1</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">qReifyFixity</span><span>
</span><a name="line-74"></a><span>  </span><a name="local-8214565720323795217"><span class="hs-identifier">qReifyConStrictness</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Single.Monad.html#liftSgM"><span class="hs-identifier hs-var">liftSgM</span></a><span> </span><span class="hs-special">`</span><a href="Data.Singletons.Util.html#comp1"><span class="hs-identifier hs-var">comp1</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">qReifyConStrictness</span><span>
</span><a name="line-75"></a><span>  </span><a name="local-8214565720323795206"><span class="hs-identifier">qIsExtEnabled</span></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Single.Monad.html#liftSgM"><span class="hs-identifier hs-var">liftSgM</span></a><span> </span><span class="hs-special">`</span><a href="Data.Singletons.Util.html#comp1"><span class="hs-identifier hs-var">comp1</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">qIsExtEnabled</span><span>
</span><a name="line-76"></a><span>  </span><a name="local-8214565720323795205"><span class="hs-identifier">qExtsEnabled</span></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Single.Monad.html#liftSgM"><span class="hs-identifier hs-var">liftSgM</span></a><span> </span><span class="hs-identifier hs-var">qExtsEnabled</span><span>
</span><a name="line-77"></a><span>  </span><a name="local-8214565720323795211"><span class="hs-identifier">qAddForeignFilePath</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Single.Monad.html#liftSgM"><span class="hs-identifier hs-var">liftSgM</span></a><span> </span><span class="hs-special">`</span><a href="Data.Singletons.Util.html#comp2"><span class="hs-identifier hs-var">comp2</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">qAddForeignFilePath</span><span>
</span><a name="line-78"></a><span>  </span><a name="local-8214565720323795213"><span class="hs-identifier">qAddTempFile</span></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Single.Monad.html#liftSgM"><span class="hs-identifier hs-var">liftSgM</span></a><span> </span><span class="hs-special">`</span><a href="Data.Singletons.Util.html#comp1"><span class="hs-identifier hs-var">comp1</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">qAddTempFile</span><span>
</span><a name="line-79"></a><span>  </span><a name="local-8214565720323795209"><span class="hs-identifier">qAddCorePlugin</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Single.Monad.html#liftSgM"><span class="hs-identifier hs-var">liftSgM</span></a><span> </span><span class="hs-special">`</span><a href="Data.Singletons.Util.html#comp1"><span class="hs-identifier hs-var">comp1</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">qAddCorePlugin</span><span>
</span><a name="line-80"></a><span>
</span><a name="line-81"></a><span>  </span><a name="local-8214565720323795225"><span class="hs-identifier">qRecover</span></a><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Single.Monad.html#SgM"><span class="hs-identifier hs-var">SgM</span></a><span> </span><a name="local-6989586621679169946"><a href="#local-6989586621679169946"><span class="hs-identifier">handler</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Single.Monad.html#SgM"><span class="hs-identifier hs-var">SgM</span></a><span> </span><a name="local-6989586621679169947"><a href="#local-6989586621679169947"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-82"></a><span>    </span><a name="local-6989586621679169948"><a href="#local-6989586621679169948"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">ask</span><span>
</span><a name="line-83"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621679169949"><a href="#local-6989586621679169949"><span class="hs-identifier">result</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679169950"><a href="#local-6989586621679169950"><span class="hs-identifier">aux</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Single.Monad.html#liftSgM"><span class="hs-identifier hs-var">liftSgM</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-84"></a><span>                     </span><span class="hs-identifier hs-var">qRecover</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">runWriterT</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">runReaderT</span><span> </span><a href="#local-6989586621679169946"><span class="hs-identifier hs-var">handler</span></a><span> </span><a href="#local-6989586621679169948"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>
</span><a name="line-85"></a><span>                              </span><span class="hs-special">(</span><span class="hs-identifier">runWriterT</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">runReaderT</span><span> </span><a href="#local-6989586621679169947"><span class="hs-identifier hs-var">body</span></a><span> </span><a href="#local-6989586621679169948"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>
</span><a name="line-86"></a><span>    </span><span class="hs-identifier hs-var">tell</span><span> </span><a href="#local-6989586621679169950"><span class="hs-identifier hs-var">aux</span></a><span>
</span><a name="line-87"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679169949"><span class="hs-identifier hs-var">result</span></a><span>
</span><a name="line-88"></a><span>
</span><a name="line-89"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">DsMonad</span><span> </span><a href="Data.Singletons.Single.Monad.html#SgM"><span class="hs-identifier hs-type">SgM</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-90"></a><span>  </span><a name="local-8214565720323796445"><span class="hs-identifier">localDeclarations</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">asks</span><span> </span><span class="hs-identifier">sg_local_decls</span><span>
</span><a name="line-91"></a><span>
</span><a name="line-92"></a><span class="hs-identifier">bindLets</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">DExp</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Single.Monad.html#SgM"><span class="hs-identifier hs-type">SgM</span></a><span> </span><a href="#local-6989586621679169955"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Single.Monad.html#SgM"><span class="hs-identifier hs-type">SgM</span></a><span> </span><a href="#local-6989586621679169955"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-93"></a><a name="bindLets"><a href="Data.Singletons.Single.Monad.html#bindLets"><span class="hs-identifier">bindLets</span></a></a><span> </span><a name="local-6989586621679169957"><a href="#local-6989586621679169957"><span class="hs-identifier">lets1</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-94"></a><span>  </span><span class="hs-identifier hs-var">local</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679169958"><a href="#local-6989586621679169958"><span class="hs-identifier">env</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Data.Singletons.Single.Monad.html#SgEnv"><span class="hs-identifier hs-var">SgEnv</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sg_let_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679169959"><a href="#local-6989586621679169959"><span class="hs-identifier">lets2</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-95"></a><span>               </span><a href="#local-6989586621679169958"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sg_let_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.fromList</span><span> </span><a href="#local-6989586621679169957"><span class="hs-identifier hs-var">lets1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">Map.union</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679169959"><span class="hs-identifier hs-var">lets2</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-96"></a><span>
</span><a name="line-97"></a><span class="hs-comment">-- Add some constraints to the current type signature context.</span><span>
</span><a name="line-98"></a><span class="hs-comment">-- See Note [Tracking the current type signature context]</span><span>
</span><a name="line-99"></a><span class="hs-identifier">bindContext</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DCxt</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Single.Monad.html#SgM"><span class="hs-identifier hs-type">SgM</span></a><span> </span><a href="#local-6989586621679169954"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Single.Monad.html#SgM"><span class="hs-identifier hs-type">SgM</span></a><span> </span><a href="#local-6989586621679169954"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-100"></a><a name="bindContext"><a href="Data.Singletons.Single.Monad.html#bindContext"><span class="hs-identifier">bindContext</span></a></a><span> </span><a name="local-6989586621679169960"><a href="#local-6989586621679169960"><span class="hs-identifier">ctxt1</span></a></a><span>
</span><a name="line-101"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">local</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679169961"><a href="#local-6989586621679169961"><span class="hs-identifier">env</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Data.Singletons.Single.Monad.html#SgEnv"><span class="hs-identifier hs-var">SgEnv</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sg_context</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679169962"><a href="#local-6989586621679169962"><span class="hs-identifier">ctxt2</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-102"></a><span>                 </span><a href="#local-6989586621679169961"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sg_context</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679169960"><span class="hs-identifier hs-var">ctxt1</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679169962"><span class="hs-identifier hs-var">ctxt2</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-103"></a><span>
</span><a name="line-104"></a><span class="hs-comment">-- Retrieve the current type signature context.</span><span>
</span><a name="line-105"></a><span class="hs-comment">-- See Note [Tracking the current type signature context]</span><span>
</span><a name="line-106"></a><span class="hs-identifier">askContext</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Singletons.Single.Monad.html#SgM"><span class="hs-identifier hs-type">SgM</span></a><span> </span><span class="hs-identifier hs-type">DCxt</span><span>
</span><a name="line-107"></a><a name="askContext"><a href="Data.Singletons.Single.Monad.html#askContext"><span class="hs-identifier">askContext</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">asks</span><span> </span><span class="hs-identifier">sg_context</span><span>
</span><a name="line-108"></a><span>
</span><a name="line-109"></a><span class="hs-identifier">lookupVarE</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Single.Monad.html#SgM"><span class="hs-identifier hs-type">SgM</span></a><span> </span><span class="hs-identifier hs-type">DExp</span><span>
</span><a name="line-110"></a><a name="lookupVarE"><a href="Data.Singletons.Single.Monad.html#lookupVarE"><span class="hs-identifier">lookupVarE</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Single.Monad.html#lookup_var_con"><span class="hs-identifier hs-var">lookup_var_con</span></a><span> </span><a href="Data.Singletons.Names.html#singValName"><span class="hs-identifier hs-var">singValName</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DVarE</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Data.Singletons.Names.html#singValName"><span class="hs-identifier hs-var">singValName</span></a><span class="hs-special">)</span><span>
</span><a name="line-111"></a><span>
</span><a name="line-112"></a><span class="hs-identifier">lookupConE</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Single.Monad.html#SgM"><span class="hs-identifier hs-type">SgM</span></a><span> </span><span class="hs-identifier hs-type">DExp</span><span>
</span><a name="line-113"></a><a name="lookupConE"><a href="Data.Singletons.Single.Monad.html#lookupConE"><span class="hs-identifier">lookupConE</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Single.Monad.html#lookup_var_con"><span class="hs-identifier hs-var">lookup_var_con</span></a><span> </span><a href="Data.Singletons.Names.html#singDataConName"><span class="hs-identifier hs-var">singDataConName</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DConE</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Data.Singletons.Names.html#singDataConName"><span class="hs-identifier hs-var">singDataConName</span></a><span class="hs-special">)</span><span>
</span><a name="line-114"></a><span>
</span><a name="line-115"></a><span class="hs-identifier">lookup_var_con</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DExp</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Single.Monad.html#SgM"><span class="hs-identifier hs-type">SgM</span></a><span> </span><span class="hs-identifier hs-type">DExp</span><span>
</span><a name="line-116"></a><a name="lookup_var_con"><a href="Data.Singletons.Single.Monad.html#lookup_var_con"><span class="hs-identifier">lookup_var_con</span></a></a><span> </span><a name="local-6989586621679169963"><a href="#local-6989586621679169963"><span class="hs-identifier">mk_sing_name</span></a></a><span> </span><a name="local-6989586621679169964"><a href="#local-6989586621679169964"><span class="hs-identifier">mk_exp</span></a></a><span> </span><a name="local-6989586621679169965"><a href="#local-6989586621679169965"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-117"></a><span>  </span><a name="local-6989586621679169966"><a href="#local-6989586621679169966"><span class="hs-identifier">letExpansions</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">asks</span><span> </span><span class="hs-identifier">sg_let_binds</span><span>
</span><a name="line-118"></a><span>  </span><a name="local-6989586621679169967"><a href="#local-6989586621679169967"><span class="hs-identifier">sName</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mkDataName</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nameBase</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679169963"><span class="hs-identifier hs-var">mk_sing_name</span></a><span> </span><a href="#local-6989586621679169965"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- we want *term* names!</span><span>
</span><a name="line-119"></a><span>  </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><a href="#local-6989586621679169965"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679169966"><span class="hs-identifier hs-var">letExpansions</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-120"></a><span>    </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-121"></a><span>      </span><span class="hs-comment">-- try to get it from the global context</span><span>
</span><a name="line-122"></a><span>      </span><a name="local-6989586621679169968"><a href="#local-6989586621679169968"><span class="hs-identifier">m_dinfo</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftM2</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">&lt;|&gt;</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dsReify</span><span> </span><a href="#local-6989586621679169967"><span class="hs-identifier hs-var">sName</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dsReify</span><span> </span><a href="#local-6989586621679169965"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-123"></a><span>        </span><span class="hs-comment">-- try the unrefined name too -- it's needed to bootstrap Enum</span><span>
</span><a name="line-124"></a><span>      </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679169968"><span class="hs-identifier hs-var">m_dinfo</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-125"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DVarI</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679169969"><a href="#local-6989586621679169969"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-126"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679169970"><a href="#local-6989586621679169970"><span class="hs-identifier">num_args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Util.html#countArgs"><span class="hs-identifier hs-var">countArgs</span></a><span> </span><a href="#local-6989586621679169969"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-keyword">in</span><span>
</span><a name="line-127"></a><span>          </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Singletons.Single.Monad.html#wrapSingFun"><span class="hs-identifier hs-var">wrapSingFun</span></a><span> </span><a href="#local-6989586621679169970"><span class="hs-identifier hs-var">num_args</span></a><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Names.html#promoteValRhs"><span class="hs-identifier hs-var">promoteValRhs</span></a><span> </span><a href="#local-6989586621679169965"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679169964"><span class="hs-identifier hs-var">mk_exp</span></a><span> </span><a href="#local-6989586621679169965"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-128"></a><span>        </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679169964"><span class="hs-identifier hs-var">mk_exp</span></a><span> </span><a href="#local-6989586621679169965"><span class="hs-identifier hs-var">name</span></a><span>   </span><span class="hs-comment">-- lambda-bound</span><span>
</span><a name="line-129"></a><span>    </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679169971"><a href="#local-6989586621679169971"><span class="hs-identifier">exp</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679169971"><span class="hs-identifier hs-var">exp</span></a><span>
</span><a name="line-130"></a><span>
</span><a name="line-131"></a><span class="hs-identifier">wrapSingFun</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DExp</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DExp</span><span>
</span><a name="line-132"></a><a name="wrapSingFun"><a href="Data.Singletons.Single.Monad.html#wrapSingFun"><span class="hs-identifier">wrapSingFun</span></a></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">id</span><span>
</span><a name="line-133"></a><span class="hs-identifier">wrapSingFun</span><span> </span><a name="local-6989586621679169972"><a href="#local-6989586621679169972"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679169973"><a href="#local-6989586621679169973"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-134"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679169974"><a href="#local-6989586621679169974"><span class="hs-identifier">wrap_fun</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">DVarE</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679169972"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-135"></a><span>                           </span><span class="hs-number">1</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">'</span><span class="hs-identifier">singFun1</span><span>
</span><a name="line-136"></a><span>                           </span><span class="hs-number">2</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">'</span><span class="hs-identifier">singFun2</span><span>
</span><a name="line-137"></a><span>                           </span><span class="hs-number">3</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">'</span><span class="hs-identifier">singFun3</span><span>
</span><a name="line-138"></a><span>                           </span><span class="hs-number">4</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">'</span><span class="hs-identifier">singFun4</span><span>
</span><a name="line-139"></a><span>                           </span><span class="hs-number">5</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">'</span><span class="hs-identifier">singFun5</span><span>
</span><a name="line-140"></a><span>                           </span><span class="hs-number">6</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">'</span><span class="hs-identifier">singFun6</span><span>
</span><a name="line-141"></a><span>                           </span><span class="hs-number">7</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">'</span><span class="hs-identifier">singFun7</span><span>
</span><a name="line-142"></a><span>                           </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-string">&quot;No support for functions of arity &gt; 7.&quot;</span><span>
</span><a name="line-143"></a><span>  </span><span class="hs-keyword">in</span><span>
</span><a name="line-144"></a><span>  </span><span class="hs-special">(</span><a href="#local-6989586621679169974"><span class="hs-identifier hs-var">wrap_fun</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">DAppTypeE</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679169973"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">DAppE</span><span class="hs-special">`</span><span class="hs-special">)</span><span>
</span><a name="line-145"></a><span>
</span><a name="line-146"></a><span class="hs-identifier">wrapUnSingFun</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DExp</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DExp</span><span>
</span><a name="line-147"></a><a name="wrapUnSingFun"><a href="Data.Singletons.Single.Monad.html#wrapUnSingFun"><span class="hs-identifier">wrapUnSingFun</span></a></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">id</span><span>
</span><a name="line-148"></a><span class="hs-identifier">wrapUnSingFun</span><span> </span><a name="local-6989586621679169975"><a href="#local-6989586621679169975"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679169976"><a href="#local-6989586621679169976"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-149"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679169977"><a href="#local-6989586621679169977"><span class="hs-identifier">unwrap_fun</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">DVarE</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679169975"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-150"></a><span>                             </span><span class="hs-number">1</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">'</span><span class="hs-identifier">unSingFun1</span><span>
</span><a name="line-151"></a><span>                             </span><span class="hs-number">2</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">'</span><span class="hs-identifier">unSingFun2</span><span>
</span><a name="line-152"></a><span>                             </span><span class="hs-number">3</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">'</span><span class="hs-identifier">unSingFun3</span><span>
</span><a name="line-153"></a><span>                             </span><span class="hs-number">4</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">'</span><span class="hs-identifier">unSingFun4</span><span>
</span><a name="line-154"></a><span>                             </span><span class="hs-number">5</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">'</span><span class="hs-identifier">unSingFun5</span><span>
</span><a name="line-155"></a><span>                             </span><span class="hs-number">6</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">'</span><span class="hs-identifier">unSingFun6</span><span>
</span><a name="line-156"></a><span>                             </span><span class="hs-number">7</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">'</span><span class="hs-identifier">unSingFun7</span><span>
</span><a name="line-157"></a><span>                             </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-string">&quot;No support for functions of arity &gt; 7.&quot;</span><span>
</span><a name="line-158"></a><span>  </span><span class="hs-keyword">in</span><span>
</span><a name="line-159"></a><span>  </span><span class="hs-special">(</span><a href="#local-6989586621679169977"><span class="hs-identifier hs-var">unwrap_fun</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">DAppTypeE</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679169976"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">DAppE</span><span class="hs-special">`</span><span class="hs-special">)</span><span>
</span><a name="line-160"></a><span>
</span><a name="line-161"></a><span class="hs-identifier">singM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DsMonad</span><span> </span><a href="#local-6989586621679169952"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Single.Monad.html#SgM"><span class="hs-identifier hs-type">SgM</span></a><span> </span><a href="#local-6989586621679169953"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679169952"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679169953"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DDec</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-162"></a><a name="singM"><a href="Data.Singletons.Single.Monad.html#singM"><span class="hs-identifier">singM</span></a></a><span> </span><a name="local-6989586621679169978"><a href="#local-6989586621679169978"><span class="hs-identifier">locals</span></a></a><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Single.Monad.html#SgM"><span class="hs-identifier hs-var">SgM</span></a><span> </span><a name="local-6989586621679169979"><a href="#local-6989586621679169979"><span class="hs-identifier">rdr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-163"></a><span>  </span><a name="local-6989586621679169980"><a href="#local-6989586621679169980"><span class="hs-identifier">other_locals</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">localDeclarations</span><span>
</span><a name="line-164"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679169981"><a href="#local-6989586621679169981"><span class="hs-identifier">wr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">runReaderT</span><span> </span><a href="#local-6989586621679169979"><span class="hs-identifier hs-var">rdr</span></a><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Single.Monad.html#emptySgEnv"><span class="hs-identifier hs-var">emptySgEnv</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sg_local_decls</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679169980"><span class="hs-identifier hs-var">other_locals</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679169978"><span class="hs-identifier hs-var">locals</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-165"></a><span>      </span><a name="local-6989586621679169982"><a href="#local-6989586621679169982"><span class="hs-identifier">q</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">runWriterT</span><span> </span><a href="#local-6989586621679169981"><span class="hs-identifier hs-var">wr</span></a><span>
</span><a name="line-166"></a><span>  </span><span class="hs-identifier hs-var">runQ</span><span> </span><a href="#local-6989586621679169982"><span class="hs-identifier hs-var">q</span></a><span>
</span><a name="line-167"></a><span>
</span><a name="line-168"></a><span class="hs-identifier">singDecsM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DsMonad</span><span> </span><a href="#local-6989586621679169951"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Single.Monad.html#SgM"><span class="hs-identifier hs-type">SgM</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DDec</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679169951"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DDec</span><span class="hs-special">]</span><span>
</span><a name="line-169"></a><a name="singDecsM"><a href="Data.Singletons.Single.Monad.html#singDecsM"><span class="hs-identifier">singDecsM</span></a></a><span> </span><a name="local-6989586621679169983"><a href="#local-6989586621679169983"><span class="hs-identifier">locals</span></a></a><span> </span><a name="local-6989586621679169984"><a href="#local-6989586621679169984"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-170"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679169985"><a href="#local-6989586621679169985"><span class="hs-identifier">decs1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679169986"><a href="#local-6989586621679169986"><span class="hs-identifier">decs2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Single.Monad.html#singM"><span class="hs-identifier hs-var">singM</span></a><span> </span><a href="#local-6989586621679169983"><span class="hs-identifier hs-var">locals</span></a><span> </span><a href="#local-6989586621679169984"><span class="hs-identifier hs-var">thing</span></a><span>
</span><a name="line-171"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679169985"><span class="hs-identifier hs-var">decs1</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679169986"><span class="hs-identifier hs-var">decs2</span></a><span>
</span><a name="line-172"></a><span>
</span><a name="line-173"></a><span class="hs-comment">{-
Note [Tracking the current type signature context]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Much like we track the let-bound names in scope, we also track the current
context. For instance, in the following program:

  -- (1)
  f :: forall a. Show a =&gt; a -&gt; String -&gt; Bool
  f x y = g (show x) y
    where
      -- (2)
      g :: forall b. Eq b =&gt; b -&gt; b -&gt; Bool
      g = h
        where
          -- (3)
          h :: b -&gt; b -&gt; Bool
          h = (==)

Here is the context at various points:

(1) ()
(2) (Show a)
(3) (Show a, Eq b)

We track this informating during singling instead of during promotion, as the
promoted versions of things are often type families, which do not have
contexts.

Why do we bother tracking this at all? Ultimately, because singDefuns (from
Data.Singletons.Single.Defun) needs to know the current context in order to
generate a correctly typed SingI instance. For instance, if you called
singDefuns on the class method bar:

  class Foo a where
    bar :: Eq a =&gt; a -&gt; Bool

Then if you only grabbed the context of `bar` itself, then you'd end up
generating the following SingI instance for BarSym0:

  instance SEq a =&gt; SingI (FooSym0 :: a ~&gt; Bool) where ...

Which is incorrect&#8212;there needs to be an (SFoo a) constraint as well! If we
track the current context when singling Foo, then we will correctly propagate
this information to singDefuns.
-}</span><span>
</span><a name="line-218"></a></pre></body></html>