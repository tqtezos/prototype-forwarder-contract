<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{- Language/Haskell/TH/Desugar.hs

(c) Richard Eisenberg 2013
rae@cs.brynmawr.edu
-}</span><span>
</span><a name="line-6"></a><span>
</span><a name="line-7"></a><span class="hs-pragma">{-# LANGUAGE CPP, MultiParamTypeClasses, FunctionalDependencies,
             TypeSynonymInstances, FlexibleInstances, LambdaCase #-}</span><span>
</span><a name="line-9"></a><span>
</span><a name="line-10"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-11"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-12"></a><span class="hs-comment">-- Module      :  Language.Haskell.TH.Desugar</span><span>
</span><a name="line-13"></a><span class="hs-comment">-- Copyright   :  (C) 2014 Richard Eisenberg</span><span>
</span><a name="line-14"></a><span class="hs-comment">-- License     :  BSD-style (see LICENSE)</span><span>
</span><a name="line-15"></a><span class="hs-comment">-- Maintainer  :  Ryan Scott</span><span>
</span><a name="line-16"></a><span class="hs-comment">-- Stability   :  experimental</span><span>
</span><a name="line-17"></a><span class="hs-comment">-- Portability :  non-portable</span><span>
</span><a name="line-18"></a><span class="hs-comment">--</span><span>
</span><a name="line-19"></a><span class="hs-comment">-- Desugars full Template Haskell syntax into a smaller core syntax for further</span><span>
</span><a name="line-20"></a><span class="hs-comment">-- processing.</span><span>
</span><a name="line-21"></a><span class="hs-comment">--</span><span>
</span><a name="line-22"></a><span class="hs-comment">----------------------------------------------------------------------------</span><span>
</span><a name="line-23"></a><span>
</span><a name="line-24"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Language.Haskell.TH.Desugar</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-25"></a><span>  </span><span class="hs-comment">-- * Desugared data types</span><span>
</span><a name="line-26"></a><span>  </span><a href="Language.Haskell.TH.Desugar.AST.html#DExp"><span class="hs-identifier hs-type">DExp</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.AST.html#DLetDec"><span class="hs-identifier hs-type">DLetDec</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.AST.html#DPat"><span class="hs-identifier hs-type">DPat</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.AST.html#DType"><span class="hs-identifier hs-type">DType</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.AST.html#DKind"><span class="hs-identifier hs-type">DKind</span></a><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.AST.html#DCxt"><span class="hs-identifier hs-type">DCxt</span></a><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.AST.html#DPred"><span class="hs-identifier hs-type">DPred</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-27"></a><span>  </span><a href="Language.Haskell.TH.Desugar.AST.html#DTyVarBndr"><span class="hs-identifier hs-type">DTyVarBndr</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.AST.html#DMatch"><span class="hs-identifier hs-type">DMatch</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.AST.html#DClause"><span class="hs-identifier hs-type">DClause</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.AST.html#DDec"><span class="hs-identifier hs-type">DDec</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-28"></a><span>  </span><a href="Language.Haskell.TH.Desugar.AST.html#DDerivClause"><span class="hs-identifier hs-type">DDerivClause</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.AST.html#DDerivStrategy"><span class="hs-identifier hs-type">DDerivStrategy</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.AST.html#DPatSynDir"><span class="hs-identifier hs-type">DPatSynDir</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.AST.html#DPatSynType"><span class="hs-identifier hs-type">DPatSynType</span></a><span class="hs-special">,</span><span>
</span><a name="line-29"></a><span>  </span><span class="hs-identifier hs-type">Overlap</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">PatSynArgs</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.AST.html#NewOrData"><span class="hs-identifier hs-type">NewOrData</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-30"></a><span>  </span><a href="Language.Haskell.TH.Desugar.AST.html#DTypeFamilyHead"><span class="hs-identifier hs-type">DTypeFamilyHead</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.AST.html#DFamilyResultSig"><span class="hs-identifier hs-type">DFamilyResultSig</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">InjectivityAnn</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-31"></a><span>  </span><a href="Language.Haskell.TH.Desugar.AST.html#DCon"><span class="hs-identifier hs-type">DCon</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.AST.html#DConFields"><span class="hs-identifier hs-type">DConFields</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.AST.html#DDeclaredInfix"><span class="hs-identifier hs-type">DDeclaredInfix</span></a><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.AST.html#DBangType"><span class="hs-identifier hs-type">DBangType</span></a><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.AST.html#DVarBangType"><span class="hs-identifier hs-type">DVarBangType</span></a><span class="hs-special">,</span><span>
</span><a name="line-32"></a><span>  </span><span class="hs-identifier hs-type">Bang</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SourceUnpackedness</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SourceStrictness</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-33"></a><span>  </span><a href="Language.Haskell.TH.Desugar.AST.html#DForeign"><span class="hs-identifier hs-type">DForeign</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-34"></a><span>  </span><a href="Language.Haskell.TH.Desugar.AST.html#DPragma"><span class="hs-identifier hs-type">DPragma</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.AST.html#DRuleBndr"><span class="hs-identifier hs-type">DRuleBndr</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.AST.html#DTySynEqn"><span class="hs-identifier hs-type">DTySynEqn</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.AST.html#DInfo"><span class="hs-identifier hs-type">DInfo</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.AST.html#DInstanceDec"><span class="hs-identifier hs-type">DInstanceDec</span></a><span class="hs-special">,</span><span>
</span><a name="line-35"></a><span>  </span><span class="hs-identifier hs-type">Role</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">AnnTarget</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-36"></a><span>
</span><a name="line-37"></a><span>  </span><span class="hs-comment">-- * The 'Desugar' class</span><span>
</span><a name="line-38"></a><span>  </span><a href="Language.Haskell.TH.Desugar.html#Desugar"><span class="hs-identifier hs-type">Desugar</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-39"></a><span>
</span><a name="line-40"></a><span>  </span><span class="hs-comment">-- * Main desugaring functions</span><span>
</span><a name="line-41"></a><span>  </span><a href="Language.Haskell.TH.Desugar.Core.html#dsExp"><span class="hs-identifier hs-var">dsExp</span></a><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.Core.html#dsDecs"><span class="hs-identifier hs-var">dsDecs</span></a><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.Core.html#dsType"><span class="hs-identifier hs-var">dsType</span></a><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.Core.html#dsInfo"><span class="hs-identifier hs-var">dsInfo</span></a><span class="hs-special">,</span><span>
</span><a name="line-42"></a><span>  </span><a href="Language.Haskell.TH.Desugar.Core.html#dsPatOverExp"><span class="hs-identifier hs-var">dsPatOverExp</span></a><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.Core.html#dsPatsOverExp"><span class="hs-identifier hs-var">dsPatsOverExp</span></a><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.Core.html#dsPatX"><span class="hs-identifier hs-var">dsPatX</span></a><span class="hs-special">,</span><span>
</span><a name="line-43"></a><span>  </span><a href="Language.Haskell.TH.Desugar.Core.html#dsLetDecs"><span class="hs-identifier hs-var">dsLetDecs</span></a><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.Core.html#dsTvb"><span class="hs-identifier hs-var">dsTvb</span></a><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.Core.html#dsCxt"><span class="hs-identifier hs-var">dsCxt</span></a><span class="hs-special">,</span><span>
</span><a name="line-44"></a><span>  </span><a href="Language.Haskell.TH.Desugar.Core.html#dsCon"><span class="hs-identifier hs-var">dsCon</span></a><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.Core.html#dsForeign"><span class="hs-identifier hs-var">dsForeign</span></a><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.Core.html#dsPragma"><span class="hs-identifier hs-var">dsPragma</span></a><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.Core.html#dsRuleBndr"><span class="hs-identifier hs-var">dsRuleBndr</span></a><span class="hs-special">,</span><span>
</span><a name="line-45"></a><span>
</span><a name="line-46"></a><span>  </span><span class="hs-comment">-- ** Secondary desugaring functions</span><span>
</span><a name="line-47"></a><span>  </span><a href="Language.Haskell.TH.Desugar.Core.html#PatM"><span class="hs-identifier hs-type">PatM</span></a><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.Core.html#dsPred"><span class="hs-identifier hs-var">dsPred</span></a><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.Core.html#dsPat"><span class="hs-identifier hs-var">dsPat</span></a><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.Core.html#dsDec"><span class="hs-identifier hs-var">dsDec</span></a><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.Core.html#dsDerivClause"><span class="hs-identifier hs-var">dsDerivClause</span></a><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.Core.html#dsLetDec"><span class="hs-identifier hs-var">dsLetDec</span></a><span class="hs-special">,</span><span>
</span><a name="line-48"></a><span>  </span><a href="Language.Haskell.TH.Desugar.Core.html#dsMatches"><span class="hs-identifier hs-var">dsMatches</span></a><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.Core.html#dsBody"><span class="hs-identifier hs-var">dsBody</span></a><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.Core.html#dsGuards"><span class="hs-identifier hs-var">dsGuards</span></a><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.Core.html#dsDoStmts"><span class="hs-identifier hs-var">dsDoStmts</span></a><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.Core.html#dsComp"><span class="hs-identifier hs-var">dsComp</span></a><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.Core.html#dsClauses"><span class="hs-identifier hs-var">dsClauses</span></a><span class="hs-special">,</span><span>
</span><a name="line-49"></a><span>  </span><a href="Language.Haskell.TH.Desugar.Core.html#dsBangType"><span class="hs-identifier hs-var">dsBangType</span></a><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.Core.html#dsVarBangType"><span class="hs-identifier hs-var">dsVarBangType</span></a><span class="hs-special">,</span><span>
</span><a name="line-50"></a><span class="hs-cpp">#if __GLASGOW_HASKELL__ &gt; 710
</span><span>  </span><a href="Language.Haskell.TH.Desugar.Core.html#dsTypeFamilyHead"><span class="hs-identifier hs-var">dsTypeFamilyHead</span></a><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.Core.html#dsFamilyResultSig"><span class="hs-identifier hs-var">dsFamilyResultSig</span></a><span class="hs-special">,</span><span>
</span><a name="line-52"></a><span class="hs-cpp">#endif
#if __GLASGOW_HASKELL__ &gt;= 801
</span><span>  </span><a href="Language.Haskell.TH.Desugar.Core.html#dsPatSynDir"><span class="hs-identifier hs-var">dsPatSynDir</span></a><span class="hs-special">,</span><span>
</span><a name="line-55"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-57"></a><span>  </span><span class="hs-comment">-- * Converting desugared AST back to TH AST</span><span>
</span><a name="line-58"></a><span>  </span><span class="hs-keyword">module</span><span> </span><a href="Language.Haskell.TH.Desugar.Sweeten.html"><span class="hs-identifier">Language.Haskell.TH.Desugar.Sweeten</span></a><span class="hs-special">,</span><span>
</span><a name="line-59"></a><span>
</span><a name="line-60"></a><span>  </span><span class="hs-comment">-- * Expanding type synonyms</span><span>
</span><a name="line-61"></a><span>  </span><a href="Language.Haskell.TH.Desugar.Expand.html#expand"><span class="hs-identifier hs-var">expand</span></a><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.Expand.html#expandType"><span class="hs-identifier hs-var">expandType</span></a><span class="hs-special">,</span><span>
</span><a name="line-62"></a><span>
</span><a name="line-63"></a><span>  </span><span class="hs-comment">-- * Reification</span><span>
</span><a name="line-64"></a><span>  </span><a href="Language.Haskell.TH.Desugar.Reify.html#reifyWithWarning"><span class="hs-identifier hs-var">reifyWithWarning</span></a><span class="hs-special">,</span><span>
</span><a name="line-65"></a><span>
</span><a name="line-66"></a><span>  </span><span class="hs-comment">-- | The following definitions allow you to register a list of</span><span>
</span><a name="line-67"></a><span>  </span><span class="hs-comment">-- @Dec@s to be used in reification queries.</span><span>
</span><a name="line-68"></a><span>  </span><a href="Language.Haskell.TH.Desugar.Reify.html#withLocalDeclarations"><span class="hs-identifier hs-var">withLocalDeclarations</span></a><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.Core.html#dsReify"><span class="hs-identifier hs-var">dsReify</span></a><span class="hs-special">,</span><span>
</span><a name="line-69"></a><span>  </span><a href="Language.Haskell.TH.Desugar.Reify.html#reifyWithLocals_maybe"><span class="hs-identifier hs-var">reifyWithLocals_maybe</span></a><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.Reify.html#reifyWithLocals"><span class="hs-identifier hs-var">reifyWithLocals</span></a><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.Reify.html#reifyFixityWithLocals"><span class="hs-identifier hs-var">reifyFixityWithLocals</span></a><span class="hs-special">,</span><span>
</span><a name="line-70"></a><span>  </span><a href="Language.Haskell.TH.Desugar.Reify.html#lookupValueNameWithLocals"><span class="hs-identifier hs-var">lookupValueNameWithLocals</span></a><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.Reify.html#lookupTypeNameWithLocals"><span class="hs-identifier hs-var">lookupTypeNameWithLocals</span></a><span class="hs-special">,</span><span>
</span><a name="line-71"></a><span>  </span><a href="Language.Haskell.TH.Desugar.Reify.html#mkDataNameWithLocals"><span class="hs-identifier hs-var">mkDataNameWithLocals</span></a><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.Reify.html#mkTypeNameWithLocals"><span class="hs-identifier hs-var">mkTypeNameWithLocals</span></a><span class="hs-special">,</span><span>
</span><a name="line-72"></a><span>  </span><a href="Language.Haskell.TH.Desugar.Reify.html#reifyNameSpace"><span class="hs-identifier hs-var">reifyNameSpace</span></a><span class="hs-special">,</span><span>
</span><a name="line-73"></a><span>  </span><a href="Language.Haskell.TH.Desugar.Reify.html#DsMonad"><span class="hs-identifier hs-type">DsMonad</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.Reify.html#DsM"><span class="hs-identifier hs-type">DsM</span></a><span class="hs-special">,</span><span>
</span><a name="line-74"></a><span>
</span><a name="line-75"></a><span>  </span><span class="hs-comment">-- * Nested pattern flattening</span><span>
</span><a name="line-76"></a><span>  </span><a href="Language.Haskell.TH.Desugar.Match.html#scExp"><span class="hs-identifier hs-var">scExp</span></a><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.Match.html#scLetDec"><span class="hs-identifier hs-var">scLetDec</span></a><span class="hs-special">,</span><span>
</span><a name="line-77"></a><span>
</span><a name="line-78"></a><span>  </span><span class="hs-comment">-- * Capture-avoiding substitution and utilities</span><span>
</span><a name="line-79"></a><span>  </span><span class="hs-keyword">module</span><span> </span><a href="Language.Haskell.TH.Desugar.Subst.html"><span class="hs-identifier">Language.Haskell.TH.Desugar.Subst</span></a><span class="hs-special">,</span><span>
</span><a name="line-80"></a><span>
</span><a name="line-81"></a><span>  </span><span class="hs-comment">-- * Utility functions</span><span>
</span><a name="line-82"></a><span>  </span><a href="Language.Haskell.TH.Desugar.Core.html#applyDExp"><span class="hs-identifier hs-var">applyDExp</span></a><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.Core.html#applyDType"><span class="hs-identifier hs-var">applyDType</span></a><span class="hs-special">,</span><span>
</span><a name="line-83"></a><span>  </span><a href="Language.Haskell.TH.Desugar.Core.html#dPatToDExp"><span class="hs-identifier hs-var">dPatToDExp</span></a><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.Core.html#removeWilds"><span class="hs-identifier hs-var">removeWilds</span></a><span class="hs-special">,</span><span>
</span><a name="line-84"></a><span>  </span><a href="Language.Haskell.TH.Desugar.Reify.html#getDataD"><span class="hs-identifier hs-var">getDataD</span></a><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.Reify.html#dataConNameToDataName"><span class="hs-identifier hs-var">dataConNameToDataName</span></a><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.Reify.html#dataConNameToCon"><span class="hs-identifier hs-var">dataConNameToCon</span></a><span class="hs-special">,</span><span>
</span><a name="line-85"></a><span>  </span><a href="Language.Haskell.TH.Desugar.Util.html#nameOccursIn"><span class="hs-identifier hs-var">nameOccursIn</span></a><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.Util.html#allNamesIn"><span class="hs-identifier hs-var">allNamesIn</span></a><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.html#flattenDValD"><span class="hs-identifier hs-var">flattenDValD</span></a><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.html#getRecordSelectors"><span class="hs-identifier hs-var">getRecordSelectors</span></a><span class="hs-special">,</span><span>
</span><a name="line-86"></a><span>  </span><a href="Language.Haskell.TH.Desugar.Util.html#mkTypeName"><span class="hs-identifier hs-var">mkTypeName</span></a><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.Util.html#mkDataName"><span class="hs-identifier hs-var">mkDataName</span></a><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.Util.html#newUniqueName"><span class="hs-identifier hs-var">newUniqueName</span></a><span class="hs-special">,</span><span>
</span><a name="line-87"></a><span>  </span><a href="Language.Haskell.TH.Desugar.Core.html#mkTupleDExp"><span class="hs-identifier hs-var">mkTupleDExp</span></a><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.Core.html#mkTupleDPat"><span class="hs-identifier hs-var">mkTupleDPat</span></a><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.Core.html#maybeDLetE"><span class="hs-identifier hs-var">maybeDLetE</span></a><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.Core.html#maybeDCaseE"><span class="hs-identifier hs-var">maybeDCaseE</span></a><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.Core.html#mkDLamEFromDPats"><span class="hs-identifier hs-var">mkDLamEFromDPats</span></a><span class="hs-special">,</span><span>
</span><a name="line-88"></a><span>  </span><a href="Language.Haskell.TH.Desugar.Core.html#fvDType"><span class="hs-identifier hs-var">fvDType</span></a><span class="hs-special">,</span><span>
</span><a name="line-89"></a><span>  </span><a href="Language.Haskell.TH.Desugar.Util.html#tupleDegree_maybe"><span class="hs-identifier hs-var">tupleDegree_maybe</span></a><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.Util.html#tupleNameDegree_maybe"><span class="hs-identifier hs-var">tupleNameDegree_maybe</span></a><span class="hs-special">,</span><span>
</span><a name="line-90"></a><span>  </span><a href="Language.Haskell.TH.Desugar.Util.html#unboxedSumDegree_maybe"><span class="hs-identifier hs-var">unboxedSumDegree_maybe</span></a><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.Util.html#unboxedSumNameDegree_maybe"><span class="hs-identifier hs-var">unboxedSumNameDegree_maybe</span></a><span class="hs-special">,</span><span>
</span><a name="line-91"></a><span>  </span><a href="Language.Haskell.TH.Desugar.Util.html#unboxedTupleDegree_maybe"><span class="hs-identifier hs-var">unboxedTupleDegree_maybe</span></a><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.Util.html#unboxedTupleNameDegree_maybe"><span class="hs-identifier hs-var">unboxedTupleNameDegree_maybe</span></a><span class="hs-special">,</span><span>
</span><a name="line-92"></a><span>  </span><a href="Language.Haskell.TH.Desugar.Core.html#strictToBang"><span class="hs-identifier hs-var">strictToBang</span></a><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.Util.html#isTypeKindName"><span class="hs-identifier hs-var">isTypeKindName</span></a><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.Util.html#typeKindName"><span class="hs-identifier hs-var">typeKindName</span></a><span class="hs-special">,</span><span>
</span><a name="line-93"></a><span>  </span><a href="Language.Haskell.TH.Desugar.Core.html#unravel"><span class="hs-identifier hs-var">unravel</span></a><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.html#conExistentialTvbs"><span class="hs-identifier hs-var">conExistentialTvbs</span></a><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.html#mkExtraDKindBinders"><span class="hs-identifier hs-var">mkExtraDKindBinders</span></a><span class="hs-special">,</span><span>
</span><a name="line-94"></a><span>  </span><a href="Language.Haskell.TH.Desugar.Core.html#dTyVarBndrToDType"><span class="hs-identifier hs-var">dTyVarBndrToDType</span></a><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.Core.html#toposortTyVarsOf"><span class="hs-identifier hs-var">toposortTyVarsOf</span></a><span class="hs-special">,</span><span>
</span><a name="line-95"></a><span>
</span><a name="line-96"></a><span>  </span><span class="hs-comment">-- ** Extracting bound names</span><span>
</span><a name="line-97"></a><span>  </span><a href="Language.Haskell.TH.Desugar.Util.html#extractBoundNamesStmt"><span class="hs-identifier hs-var">extractBoundNamesStmt</span></a><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.Util.html#extractBoundNamesDec"><span class="hs-identifier hs-var">extractBoundNamesDec</span></a><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.Util.html#extractBoundNamesPat"><span class="hs-identifier hs-var">extractBoundNamesPat</span></a><span>
</span><a name="line-98"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-99"></a><span>
</span><a name="line-100"></a><span class="hs-keyword">import</span><span> </span><a href="Language.Haskell.TH.Desugar.AST.html"><span class="hs-identifier">Language.Haskell.TH.Desugar.AST</span></a><span>
</span><a name="line-101"></a><span class="hs-keyword">import</span><span> </span><a href="Language.Haskell.TH.Desugar.Core.html"><span class="hs-identifier">Language.Haskell.TH.Desugar.Core</span></a><span>
</span><a name="line-102"></a><span class="hs-keyword">import</span><span> </span><a href="Language.Haskell.TH.Desugar.Util.html"><span class="hs-identifier">Language.Haskell.TH.Desugar.Util</span></a><span>
</span><a name="line-103"></a><span class="hs-keyword">import</span><span> </span><a href="Language.Haskell.TH.Desugar.Sweeten.html"><span class="hs-identifier">Language.Haskell.TH.Desugar.Sweeten</span></a><span>
</span><a name="line-104"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Language.Haskell.TH.Syntax</span><span>
</span><a name="line-105"></a><span class="hs-keyword">import</span><span> </span><a href="Language.Haskell.TH.Desugar.Reify.html"><span class="hs-identifier">Language.Haskell.TH.Desugar.Reify</span></a><span>
</span><a name="line-106"></a><span class="hs-keyword">import</span><span> </span><a href="Language.Haskell.TH.Desugar.Expand.html"><span class="hs-identifier">Language.Haskell.TH.Desugar.Expand</span></a><span>
</span><a name="line-107"></a><span class="hs-keyword">import</span><span> </span><a href="Language.Haskell.TH.Desugar.Match.html"><span class="hs-identifier">Language.Haskell.TH.Desugar.Match</span></a><span>
</span><a name="line-108"></a><span class="hs-keyword">import</span><span> </span><a href="Language.Haskell.TH.Desugar.Subst.html"><span class="hs-identifier">Language.Haskell.TH.Desugar.Subst</span></a><span>
</span><a name="line-109"></a><span>
</span><a name="line-110"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>
</span><a name="line-111"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Map</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">M</span><span>
</span><a name="line-112"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Set</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">S</span><span>
</span><a name="line-113"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Prelude</span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">exp</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-114"></a><span>
</span><a name="line-115"></a><span class="hs-comment">-- | This class relates a TH type with its th-desugar type and allows</span><span>
</span><a name="line-116"></a><span class="hs-comment">-- conversions back and forth. The functional dependency goes only one</span><span>
</span><a name="line-117"></a><span class="hs-comment">-- way because `Type` and `Kind` are type synonyms, but they desugar</span><span>
</span><a name="line-118"></a><span class="hs-comment">-- to different types.</span><span>
</span><a name="line-119"></a><span class="hs-keyword">class</span><span> </span><a name="Desugar"><a href="Language.Haskell.TH.Desugar.html#Desugar"><span class="hs-identifier">Desugar</span></a></a><span> </span><a name="local-6989586621679330582"><a href="#local-6989586621679330582"><span class="hs-identifier">th</span></a></a><span> </span><a name="local-6989586621679330583"><a href="#local-6989586621679330583"><span class="hs-identifier">ds</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">ds</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">th</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-120"></a><span>  </span><a name="desugar"><a href="Language.Haskell.TH.Desugar.html#desugar"><span class="hs-identifier">desugar</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.Haskell.TH.Desugar.Reify.html#DsMonad"><span class="hs-identifier hs-type">DsMonad</span></a><span> </span><a href="#local-6989586621679330584"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679330582"><span class="hs-identifier hs-type">th</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679330584"><span class="hs-identifier hs-type">q</span></a><span> </span><a href="#local-6989586621679330583"><span class="hs-identifier hs-type">ds</span></a><span>
</span><a name="line-121"></a><span>  </span><a name="sweeten"><a href="Language.Haskell.TH.Desugar.html#sweeten"><span class="hs-identifier">sweeten</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679330583"><span class="hs-identifier hs-type">ds</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679330582"><span class="hs-identifier hs-type">th</span></a><span>
</span><a name="line-122"></a><span>
</span><a name="line-123"></a><span class="hs-keyword">instance</span><span> </span><a href="Language.Haskell.TH.Desugar.html#Desugar"><span class="hs-identifier hs-type">Desugar</span></a><span> </span><span class="hs-identifier hs-type">Exp</span><span> </span><a href="Language.Haskell.TH.Desugar.AST.html#DExp"><span class="hs-identifier hs-type">DExp</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-124"></a><span>  </span><a name="local-8214565720324105487"><a href="Language.Haskell.TH.Desugar.html#desugar"><span class="hs-identifier">desugar</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.Haskell.TH.Desugar.Core.html#dsExp"><span class="hs-identifier hs-var">dsExp</span></a><span>
</span><a name="line-125"></a><span>  </span><a name="local-8214565720324105488"><a href="Language.Haskell.TH.Desugar.html#sweeten"><span class="hs-identifier">sweeten</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.Haskell.TH.Desugar.Sweeten.html#expToTH"><span class="hs-identifier hs-var">expToTH</span></a><span>
</span><a name="line-126"></a><span>
</span><a name="line-127"></a><span class="hs-keyword">instance</span><span> </span><a href="Language.Haskell.TH.Desugar.html#Desugar"><span class="hs-identifier hs-type">Desugar</span></a><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><a href="Language.Haskell.TH.Desugar.AST.html#DType"><span class="hs-identifier hs-type">DType</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-128"></a><span>  </span><a name="local-8214565720324105487"><a href="Language.Haskell.TH.Desugar.html#desugar"><span class="hs-identifier">desugar</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.Haskell.TH.Desugar.Core.html#dsType"><span class="hs-identifier hs-var">dsType</span></a><span>
</span><a name="line-129"></a><span>  </span><a name="local-8214565720324105488"><a href="Language.Haskell.TH.Desugar.html#sweeten"><span class="hs-identifier">sweeten</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.Haskell.TH.Desugar.Sweeten.html#typeToTH"><span class="hs-identifier hs-var">typeToTH</span></a><span>
</span><a name="line-130"></a><span>
</span><a name="line-131"></a><span class="hs-keyword">instance</span><span> </span><a href="Language.Haskell.TH.Desugar.html#Desugar"><span class="hs-identifier hs-type">Desugar</span></a><span> </span><span class="hs-identifier hs-type">Cxt</span><span> </span><a href="Language.Haskell.TH.Desugar.AST.html#DCxt"><span class="hs-identifier hs-type">DCxt</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-132"></a><span>  </span><a name="local-8214565720324105487"><a href="Language.Haskell.TH.Desugar.html#desugar"><span class="hs-identifier">desugar</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.Haskell.TH.Desugar.Core.html#dsCxt"><span class="hs-identifier hs-var">dsCxt</span></a><span>
</span><a name="line-133"></a><span>  </span><a name="local-8214565720324105488"><a href="Language.Haskell.TH.Desugar.html#sweeten"><span class="hs-identifier">sweeten</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.Haskell.TH.Desugar.Sweeten.html#cxtToTH"><span class="hs-identifier hs-var">cxtToTH</span></a><span>
</span><a name="line-134"></a><span>
</span><a name="line-135"></a><span class="hs-keyword">instance</span><span> </span><a href="Language.Haskell.TH.Desugar.html#Desugar"><span class="hs-identifier hs-type">Desugar</span></a><span> </span><span class="hs-identifier hs-type">TyVarBndr</span><span> </span><a href="Language.Haskell.TH.Desugar.AST.html#DTyVarBndr"><span class="hs-identifier hs-type">DTyVarBndr</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-136"></a><span>  </span><a name="local-8214565720324105487"><a href="Language.Haskell.TH.Desugar.html#desugar"><span class="hs-identifier">desugar</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.Haskell.TH.Desugar.Core.html#dsTvb"><span class="hs-identifier hs-var">dsTvb</span></a><span>
</span><a name="line-137"></a><span>  </span><a name="local-8214565720324105488"><a href="Language.Haskell.TH.Desugar.html#sweeten"><span class="hs-identifier">sweeten</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.Haskell.TH.Desugar.Sweeten.html#tvbToTH"><span class="hs-identifier hs-var">tvbToTH</span></a><span>
</span><a name="line-138"></a><span>
</span><a name="line-139"></a><span class="hs-keyword">instance</span><span> </span><a href="Language.Haskell.TH.Desugar.html#Desugar"><span class="hs-identifier hs-type">Desugar</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><a href="Language.Haskell.TH.Desugar.AST.html#DDec"><span class="hs-identifier hs-type">DDec</span></a><span class="hs-special">]</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-140"></a><span>  </span><a name="local-8214565720324105487"><a href="Language.Haskell.TH.Desugar.html#desugar"><span class="hs-identifier">desugar</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.Haskell.TH.Desugar.Core.html#dsDecs"><span class="hs-identifier hs-var">dsDecs</span></a><span>
</span><a name="line-141"></a><span>  </span><a name="local-8214565720324105488"><a href="Language.Haskell.TH.Desugar.html#sweeten"><span class="hs-identifier">sweeten</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.Haskell.TH.Desugar.Sweeten.html#decsToTH"><span class="hs-identifier hs-var">decsToTH</span></a><span>
</span><a name="line-142"></a><span>
</span><a name="line-143"></a><span class="hs-comment">-- | If the declaration passed in is a 'DValD', creates new, equivalent</span><span>
</span><a name="line-144"></a><span class="hs-comment">-- declarations such that the 'DPat' in all 'DValD's is just a plain</span><span>
</span><a name="line-145"></a><span class="hs-comment">-- 'DVarPa'. Other declarations are passed through unchanged.</span><span>
</span><a name="line-146"></a><span class="hs-comment">-- Note that the declarations that come out of this function are rather</span><span>
</span><a name="line-147"></a><span class="hs-comment">-- less efficient than those that come in: they have many more pattern</span><span>
</span><a name="line-148"></a><span class="hs-comment">-- matches.</span><span>
</span><a name="line-149"></a><span class="hs-identifier">flattenDValD</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Quasi</span><span> </span><a href="#local-6989586621679330588"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Language.Haskell.TH.Desugar.AST.html#DLetDec"><span class="hs-identifier hs-type">DLetDec</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679330588"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-special">[</span><a href="Language.Haskell.TH.Desugar.AST.html#DLetDec"><span class="hs-identifier hs-type">DLetDec</span></a><span class="hs-special">]</span><span>
</span><a name="line-150"></a><a name="flattenDValD"><a href="Language.Haskell.TH.Desugar.html#flattenDValD"><span class="hs-identifier">flattenDValD</span></a></a><span> </span><a name="local-6989586621679330589"><a href="#local-6989586621679330589"><span class="hs-identifier">dec</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Language.Haskell.TH.Desugar.AST.html#DValD"><span class="hs-identifier hs-var">DValD</span></a><span> </span><span class="hs-special">(</span><a href="Language.Haskell.TH.Desugar.AST.html#DVarPa"><span class="hs-identifier hs-var">DVarPa</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679330589"><span class="hs-identifier hs-var">dec</span></a><span class="hs-special">]</span><span>
</span><a name="line-151"></a><span class="hs-identifier">flattenDValD</span><span> </span><span class="hs-special">(</span><a href="Language.Haskell.TH.Desugar.AST.html#DValD"><span class="hs-identifier hs-var">DValD</span></a><span> </span><a name="local-6989586621679330590"><a href="#local-6989586621679330590"><span class="hs-identifier">pat</span></a></a><span> </span><a name="local-6989586621679330591"><a href="#local-6989586621679330591"><span class="hs-identifier">exp</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-152"></a><span>  </span><a name="local-6989586621679330611"><a href="#local-6989586621679330611"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Language.Haskell.TH.Desugar.Util.html#newUniqueName"><span class="hs-identifier hs-var">newUniqueName</span></a><span> </span><span class="hs-string">&quot;x&quot;</span><span> </span><span class="hs-comment">-- must use newUniqueName here because we might be top-level</span><span>
</span><a name="line-153"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679330612"><a href="#local-6989586621679330612"><span class="hs-identifier">top_val_d</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.Haskell.TH.Desugar.AST.html#DValD"><span class="hs-identifier hs-var">DValD</span></a><span> </span><span class="hs-special">(</span><a href="Language.Haskell.TH.Desugar.AST.html#DVarPa"><span class="hs-identifier hs-var">DVarPa</span></a><span> </span><a href="#local-6989586621679330611"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679330591"><span class="hs-identifier hs-var">exp</span></a><span>
</span><a name="line-154"></a><span>      </span><a name="local-6989586621679330613"><a href="#local-6989586621679330613"><span class="hs-identifier">bound_names</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">S.elems</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.Haskell.TH.Desugar.Core.html#extractBoundNamesDPat"><span class="hs-identifier hs-var">extractBoundNamesDPat</span></a><span> </span><a href="#local-6989586621679330590"><span class="hs-identifier hs-var">pat</span></a><span>
</span><a name="line-155"></a><span>  </span><a name="local-6989586621679330614"><a href="#local-6989586621679330614"><span class="hs-identifier">other_val_ds</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679330592"><span class="hs-identifier hs-var">mk_val_d</span></a><span> </span><a href="#local-6989586621679330611"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679330613"><span class="hs-identifier hs-var">bound_names</span></a><span>
</span><a name="line-156"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679330612"><span class="hs-identifier hs-var">top_val_d</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679330614"><span class="hs-identifier hs-var">other_val_ds</span></a><span>
</span><a name="line-157"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-158"></a><span>    </span><a name="local-6989586621679330592"><a href="#local-6989586621679330592"><span class="hs-identifier">mk_val_d</span></a></a><span> </span><a name="local-6989586621679330594"><a href="#local-6989586621679330594"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621679330595"><a href="#local-6989586621679330595"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-159"></a><span>      </span><a name="local-6989586621679330596"><a href="#local-6989586621679330596"><span class="hs-identifier">y</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Language.Haskell.TH.Desugar.Util.html#newUniqueName"><span class="hs-identifier hs-var">newUniqueName</span></a><span> </span><span class="hs-string">&quot;y&quot;</span><span>
</span><a name="line-160"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679330597"><a href="#local-6989586621679330597"><span class="hs-identifier">pat'</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679330593"><span class="hs-identifier hs-var">wildify</span></a><span> </span><a href="#local-6989586621679330595"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679330596"><span class="hs-identifier hs-var">y</span></a><span> </span><a href="#local-6989586621679330590"><span class="hs-identifier hs-var">pat</span></a><span>
</span><a name="line-161"></a><span>          </span><a name="local-6989586621679330598"><a href="#local-6989586621679330598"><span class="hs-identifier">match</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.Haskell.TH.Desugar.AST.html#DMatch"><span class="hs-identifier hs-var">DMatch</span></a><span> </span><a href="#local-6989586621679330597"><span class="hs-identifier hs-var">pat'</span></a><span> </span><span class="hs-special">(</span><a href="Language.Haskell.TH.Desugar.AST.html#DVarE"><span class="hs-identifier hs-var">DVarE</span></a><span> </span><a href="#local-6989586621679330596"><span class="hs-identifier hs-var">y</span></a><span class="hs-special">)</span><span>
</span><a name="line-162"></a><span>          </span><a name="local-6989586621679330599"><a href="#local-6989586621679330599"><span class="hs-identifier">cas</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Language.Haskell.TH.Desugar.AST.html#DCaseE"><span class="hs-identifier hs-var">DCaseE</span></a><span> </span><span class="hs-special">(</span><a href="Language.Haskell.TH.Desugar.AST.html#DVarE"><span class="hs-identifier hs-var">DVarE</span></a><span> </span><a href="#local-6989586621679330594"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679330598"><span class="hs-identifier hs-var">match</span></a><span class="hs-special">]</span><span>
</span><a name="line-163"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.Haskell.TH.Desugar.AST.html#DValD"><span class="hs-identifier hs-var">DValD</span></a><span> </span><span class="hs-special">(</span><a href="Language.Haskell.TH.Desugar.AST.html#DVarPa"><span class="hs-identifier hs-var">DVarPa</span></a><span> </span><a href="#local-6989586621679330595"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679330599"><span class="hs-identifier hs-var">cas</span></a><span>
</span><a name="line-164"></a><span>
</span><a name="line-165"></a><span>    </span><a name="local-6989586621679330593"><a href="#local-6989586621679330593"><span class="hs-identifier">wildify</span></a></a><span> </span><a name="local-6989586621679330600"><a href="#local-6989586621679330600"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621679330601"><a href="#local-6989586621679330601"><span class="hs-identifier">y</span></a></a><span> </span><a name="local-6989586621679330602"><a href="#local-6989586621679330602"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-166"></a><span>      </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679330602"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-167"></a><span>        </span><a href="Language.Haskell.TH.Desugar.AST.html#DLitPa"><span class="hs-identifier hs-var">DLitPa</span></a><span> </span><a name="local-6989586621679330603"><a href="#local-6989586621679330603"><span class="hs-identifier">lit</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.Haskell.TH.Desugar.AST.html#DLitPa"><span class="hs-identifier hs-var">DLitPa</span></a><span> </span><a href="#local-6989586621679330603"><span class="hs-identifier hs-var">lit</span></a><span>
</span><a name="line-168"></a><span>        </span><a href="Language.Haskell.TH.Desugar.AST.html#DVarPa"><span class="hs-identifier hs-var">DVarPa</span></a><span> </span><a name="local-6989586621679330604"><a href="#local-6989586621679330604"><span class="hs-identifier">n</span></a></a><span>
</span><a name="line-169"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679330604"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621679330600"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.Haskell.TH.Desugar.AST.html#DVarPa"><span class="hs-identifier hs-var">DVarPa</span></a><span> </span><a href="#local-6989586621679330601"><span class="hs-identifier hs-var">y</span></a><span>
</span><a name="line-170"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.Haskell.TH.Desugar.AST.html#DWildPa"><span class="hs-identifier hs-var">DWildPa</span></a><span>
</span><a name="line-171"></a><span>        </span><a href="Language.Haskell.TH.Desugar.AST.html#DConPa"><span class="hs-identifier hs-var">DConPa</span></a><span> </span><a name="local-6989586621679330605"><a href="#local-6989586621679330605"><span class="hs-identifier">con</span></a></a><span> </span><a name="local-6989586621679330606"><a href="#local-6989586621679330606"><span class="hs-identifier">ps</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.Haskell.TH.Desugar.AST.html#DConPa"><span class="hs-identifier hs-var">DConPa</span></a><span> </span><a href="#local-6989586621679330605"><span class="hs-identifier hs-var">con</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679330593"><span class="hs-identifier hs-var">wildify</span></a><span> </span><a href="#local-6989586621679330600"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679330601"><span class="hs-identifier hs-var">y</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679330606"><span class="hs-identifier hs-var">ps</span></a><span class="hs-special">)</span><span>
</span><a name="line-172"></a><span>        </span><a href="Language.Haskell.TH.Desugar.AST.html#DTildePa"><span class="hs-identifier hs-var">DTildePa</span></a><span> </span><a name="local-6989586621679330607"><a href="#local-6989586621679330607"><span class="hs-identifier">pa</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.Haskell.TH.Desugar.AST.html#DTildePa"><span class="hs-identifier hs-var">DTildePa</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679330593"><span class="hs-identifier hs-var">wildify</span></a><span> </span><a href="#local-6989586621679330600"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679330601"><span class="hs-identifier hs-var">y</span></a><span> </span><a href="#local-6989586621679330607"><span class="hs-identifier hs-var">pa</span></a><span class="hs-special">)</span><span>
</span><a name="line-173"></a><span>        </span><a href="Language.Haskell.TH.Desugar.AST.html#DBangPa"><span class="hs-identifier hs-var">DBangPa</span></a><span> </span><a name="local-6989586621679330608"><a href="#local-6989586621679330608"><span class="hs-identifier">pa</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.Haskell.TH.Desugar.AST.html#DBangPa"><span class="hs-identifier hs-var">DBangPa</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679330593"><span class="hs-identifier hs-var">wildify</span></a><span> </span><a href="#local-6989586621679330600"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679330601"><span class="hs-identifier hs-var">y</span></a><span> </span><a href="#local-6989586621679330608"><span class="hs-identifier hs-var">pa</span></a><span class="hs-special">)</span><span>
</span><a name="line-174"></a><span>        </span><a href="Language.Haskell.TH.Desugar.AST.html#DSigPa"><span class="hs-identifier hs-var">DSigPa</span></a><span> </span><a name="local-6989586621679330609"><a href="#local-6989586621679330609"><span class="hs-identifier">pa</span></a></a><span> </span><a name="local-6989586621679330610"><a href="#local-6989586621679330610"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.Haskell.TH.Desugar.AST.html#DSigPa"><span class="hs-identifier hs-var">DSigPa</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679330593"><span class="hs-identifier hs-var">wildify</span></a><span> </span><a href="#local-6989586621679330600"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679330601"><span class="hs-identifier hs-var">y</span></a><span> </span><a href="#local-6989586621679330609"><span class="hs-identifier hs-var">pa</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679330610"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-175"></a><span>        </span><a href="Language.Haskell.TH.Desugar.AST.html#DWildPa"><span class="hs-identifier hs-var">DWildPa</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.Haskell.TH.Desugar.AST.html#DWildPa"><span class="hs-identifier hs-var">DWildPa</span></a><span>
</span><a name="line-176"></a><span>
</span><a name="line-177"></a><span class="hs-identifier">flattenDValD</span><span> </span><a name="local-6989586621679330615"><a href="#local-6989586621679330615"><span class="hs-identifier">other_dec</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679330615"><span class="hs-identifier hs-var">other_dec</span></a><span class="hs-special">]</span><span>
</span><a name="line-178"></a><span>
</span><a name="line-179"></a><span class="hs-comment">-- | Produces 'DLetDec's representing the record selector functions from</span><span>
</span><a name="line-180"></a><span class="hs-comment">-- the provided 'DCon's.</span><span>
</span><a name="line-181"></a><span class="hs-comment">--</span><span>
</span><a name="line-182"></a><span class="hs-comment">-- Note that if the same record selector appears in multiple constructors,</span><span>
</span><a name="line-183"></a><span class="hs-comment">-- 'getRecordSelectors' will return only one binding for that selector.</span><span>
</span><a name="line-184"></a><span class="hs-comment">-- For example, if you had:</span><span>
</span><a name="line-185"></a><span class="hs-comment">--</span><span>
</span><a name="line-186"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-187"></a><span class="hs-comment">-- data X = X1 {y :: Symbol} | X2 {y :: Symbol}</span><span>
</span><a name="line-188"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-189"></a><span class="hs-comment">--</span><span>
</span><a name="line-190"></a><span class="hs-comment">-- Then calling 'getRecordSelectors' on @[X1, X2]@ will return:</span><span>
</span><a name="line-191"></a><span class="hs-comment">--</span><span>
</span><a name="line-192"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-193"></a><span class="hs-comment">-- [ DSigD y (DAppT (DAppT DArrowT (DConT X)) (DConT Symbol))</span><span>
</span><a name="line-194"></a><span class="hs-comment">-- , DFunD y [ DClause [DConPa X1 [DVarPa field]] (DVarE field)</span><span>
</span><a name="line-195"></a><span class="hs-comment">--           , DClause [DConPa X2 [DVarPa field]] (DVarE field) ] ]</span><span>
</span><a name="line-196"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-197"></a><span class="hs-comment">--</span><span>
</span><a name="line-198"></a><span class="hs-comment">-- instead of returning one binding for @X1@ and another binding for @X2@.</span><span>
</span><a name="line-199"></a><span class="hs-comment">--</span><span>
</span><a name="line-200"></a><span class="hs-comment">-- 'getRecordSelectors' attempts to filter out \&quot;naughty\&quot; record selectors</span><span>
</span><a name="line-201"></a><span class="hs-comment">-- whose types mention existentially quantified type variables. But see the</span><span>
</span><a name="line-202"></a><span class="hs-comment">-- documentation for 'conExistentialTvbs' for limitations to this approach.</span><span>
</span><a name="line-203"></a><span>
</span><a name="line-204"></a><span class="hs-comment">-- See https://github.com/goldfirere/singletons/issues/180 for an example where</span><span>
</span><a name="line-205"></a><span class="hs-comment">-- the latter behavior can bite you.</span><span>
</span><a name="line-206"></a><span>
</span><a name="line-207"></a><span class="hs-identifier">getRecordSelectors</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Quasi</span><span> </span><a href="#local-6989586621679330587"><span class="hs-identifier hs-type">q</span></a><span>
</span><a name="line-208"></a><span>                   </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Language.Haskell.TH.Desugar.AST.html#DType"><span class="hs-identifier hs-type">DType</span></a><span>        </span><span class="hs-comment">-- ^ the type of the argument</span><span>
</span><a name="line-209"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Language.Haskell.TH.Desugar.AST.html#DCon"><span class="hs-identifier hs-type">DCon</span></a><span class="hs-special">]</span><span>
</span><a name="line-210"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679330587"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-special">[</span><a href="Language.Haskell.TH.Desugar.AST.html#DLetDec"><span class="hs-identifier hs-type">DLetDec</span></a><span class="hs-special">]</span><span>
</span><a name="line-211"></a><a name="getRecordSelectors"><a href="Language.Haskell.TH.Desugar.html#getRecordSelectors"><span class="hs-identifier">getRecordSelectors</span></a></a><span> </span><a name="local-6989586621679330616"><a href="#local-6989586621679330616"><span class="hs-identifier">arg_ty</span></a></a><span> </span><a name="local-6989586621679330617"><a href="#local-6989586621679330617"><span class="hs-identifier">cons</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679330620"><span class="hs-identifier hs-var">merge_let_decs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">fmap</span><span class="hs-special">`</span><span> </span><a href="Language.Haskell.TH.Desugar.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a><span> </span><a href="#local-6989586621679330618"><span class="hs-identifier hs-var">get_record_sels</span></a><span> </span><a href="#local-6989586621679330617"><span class="hs-identifier hs-var">cons</span></a><span>
</span><a name="line-212"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-213"></a><span>    </span><a name="local-6989586621679330618"><a href="#local-6989586621679330618"><span class="hs-identifier">get_record_sels</span></a></a><span> </span><span class="hs-special">(</span><a href="Language.Haskell.TH.Desugar.AST.html#DCon"><span class="hs-identifier hs-var">DCon</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679330621"><a href="#local-6989586621679330621"><span class="hs-identifier">con_name</span></a></a><span> </span><a name="local-6989586621679330622"><a href="#local-6989586621679330622"><span class="hs-identifier">con</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679330622"><span class="hs-identifier hs-var">con</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-214"></a><span>      </span><a href="Language.Haskell.TH.Desugar.AST.html#DRecC"><span class="hs-identifier hs-var">DRecC</span></a><span> </span><a name="local-6989586621679330633"><a href="#local-6989586621679330633"><span class="hs-identifier">fields</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679330623"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679330633"><span class="hs-identifier hs-var">fields</span></a><span>
</span><a name="line-215"></a><span>      </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-216"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-217"></a><span>        </span><a name="local-6989586621679330623"><a href="#local-6989586621679330623"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621679330624"><a href="#local-6989586621679330624"><span class="hs-identifier">fields</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-218"></a><span>          </span><a name="local-6989586621679330625"><a href="#local-6989586621679330625"><span class="hs-identifier">varName</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">qNewName</span><span> </span><span class="hs-string">&quot;field&quot;</span><span>
</span><a name="line-219"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679330626"><a href="#local-6989586621679330626"><span class="hs-identifier">tvbs</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="Language.Haskell.TH.Desugar.Core.html#fvDType"><span class="hs-identifier hs-var">fvDType</span></a><span> </span><a href="#local-6989586621679330616"><span class="hs-identifier hs-var">arg_ty</span></a><span>
</span><a name="line-220"></a><span>              </span><a name="local-6989586621679330627"><a href="#local-6989586621679330627"><span class="hs-identifier">forall'</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Language.Haskell.TH.Desugar.AST.html#DForallT"><span class="hs-identifier hs-var">DForallT</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="Language.Haskell.TH.Desugar.AST.html#DPlainTV"><span class="hs-identifier hs-var">DPlainTV</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">S.toList</span><span> </span><a href="#local-6989586621679330626"><span class="hs-identifier hs-var">tvbs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-221"></a><span>              </span><a name="local-6989586621679330628"><a href="#local-6989586621679330628"><span class="hs-identifier">num_pats</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679330624"><span class="hs-identifier hs-var">fields</span></a><span>
</span><a name="line-222"></a><span>          </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">concat</span><span>
</span><a name="line-223"></a><span>            </span><span class="hs-special">[</span><span> </span><span class="hs-special">[</span><span> </span><a href="Language.Haskell.TH.Desugar.AST.html#DSigD"><span class="hs-identifier hs-var">DSigD</span></a><span> </span><a href="#local-6989586621679330629"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679330627"><span class="hs-identifier hs-var">forall'</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.Haskell.TH.Desugar.AST.html#DArrowT"><span class="hs-identifier hs-var">DArrowT</span></a><span> </span><span class="hs-special">`</span><a href="Language.Haskell.TH.Desugar.AST.html#DAppT"><span class="hs-identifier hs-var">DAppT</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679330616"><span class="hs-identifier hs-var">arg_ty</span></a><span> </span><span class="hs-special">`</span><a href="Language.Haskell.TH.Desugar.AST.html#DAppT"><span class="hs-identifier hs-var">DAppT</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679330631"><span class="hs-identifier hs-var">res_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-224"></a><span>              </span><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.AST.html#DFunD"><span class="hs-identifier hs-var">DFunD</span></a><span> </span><a href="#local-6989586621679330629"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-special">[</span><a href="Language.Haskell.TH.Desugar.AST.html#DClause"><span class="hs-identifier hs-var">DClause</span></a><span> </span><span class="hs-special">[</span><a href="Language.Haskell.TH.Desugar.AST.html#DConPa"><span class="hs-identifier hs-var">DConPa</span></a><span> </span><a href="#local-6989586621679330621"><span class="hs-identifier hs-var">con_name</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679330619"><span class="hs-identifier hs-var">mk_field_pats</span></a><span> </span><a href="#local-6989586621679330632"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621679330628"><span class="hs-identifier hs-var">num_pats</span></a><span> </span><a href="#local-6989586621679330625"><span class="hs-identifier hs-var">varName</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-225"></a><span>                                    </span><span class="hs-special">(</span><a href="Language.Haskell.TH.Desugar.AST.html#DVarE"><span class="hs-identifier hs-var">DVarE</span></a><span> </span><a href="#local-6989586621679330625"><span class="hs-identifier hs-var">varName</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-226"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621679330629"><a href="#local-6989586621679330629"><span class="hs-identifier">name</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679330630"><a href="#local-6989586621679330630"><span class="hs-identifier">_strict</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679330631"><a href="#local-6989586621679330631"><span class="hs-identifier">res_ty</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679330632"><a href="#local-6989586621679330632"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621679330624"><span class="hs-identifier hs-var">fields</span></a><span> </span><span class="hs-special">[</span><span class="hs-number">0</span><span class="hs-glyph">..</span><span class="hs-special">]</span><span>
</span><a name="line-227"></a><span>            </span><span class="hs-special">,</span><span> </span><a href="Language.Haskell.TH.Desugar.Core.html#fvDType"><span class="hs-identifier hs-var">fvDType</span></a><span> </span><a href="#local-6989586621679330631"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">S.isSubsetOf</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679330626"><span class="hs-identifier hs-var">tvbs</span></a><span>   </span><span class="hs-comment">-- exclude &quot;naughty&quot; selectors</span><span>
</span><a name="line-228"></a><span>            </span><span class="hs-special">]</span><span>
</span><a name="line-229"></a><span>
</span><a name="line-230"></a><span>    </span><span class="hs-identifier">mk_field_pats</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Language.Haskell.TH.Desugar.AST.html#DPat"><span class="hs-identifier hs-type">DPat</span></a><span class="hs-special">]</span><span>
</span><a name="line-231"></a><span>    </span><a name="local-6989586621679330619"><a href="#local-6989586621679330619"><span class="hs-identifier">mk_field_pats</span></a></a><span> </span><span class="hs-number">0</span><span> </span><a name="local-6989586621679330634"><a href="#local-6989586621679330634"><span class="hs-identifier">total</span></a></a><span> </span><a name="local-6989586621679330635"><a href="#local-6989586621679330635"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.Haskell.TH.Desugar.AST.html#DVarPa"><span class="hs-identifier hs-var">DVarPa</span></a><span> </span><a href="#local-6989586621679330635"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">replicate</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679330634"><span class="hs-identifier hs-var">total</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="Language.Haskell.TH.Desugar.AST.html#DWildPa"><span class="hs-identifier hs-var">DWildPa</span></a><span class="hs-special">)</span><span>
</span><a name="line-232"></a><span>    </span><span class="hs-identifier">mk_field_pats</span><span> </span><a name="local-6989586621679330636"><a href="#local-6989586621679330636"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679330637"><a href="#local-6989586621679330637"><span class="hs-identifier">total</span></a></a><span> </span><a name="local-6989586621679330638"><a href="#local-6989586621679330638"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.Haskell.TH.Desugar.AST.html#DWildPa"><span class="hs-identifier hs-var">DWildPa</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679330619"><span class="hs-identifier hs-var">mk_field_pats</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679330636"><span class="hs-identifier hs-var">n</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679330637"><span class="hs-identifier hs-var">total</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679330638"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-233"></a><span>
</span><a name="line-234"></a><span>    </span><span class="hs-identifier">merge_let_decs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Language.Haskell.TH.Desugar.AST.html#DLetDec"><span class="hs-identifier hs-type">DLetDec</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Language.Haskell.TH.Desugar.AST.html#DLetDec"><span class="hs-identifier hs-type">DLetDec</span></a><span class="hs-special">]</span><span>
</span><a name="line-235"></a><span>    </span><a name="local-6989586621679330620"><a href="#local-6989586621679330620"><span class="hs-identifier">merge_let_decs</span></a></a><span> </span><a name="local-6989586621679330639"><a href="#local-6989586621679330639"><span class="hs-identifier">decs</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-236"></a><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679330664"><a href="#local-6989586621679330664"><span class="hs-identifier">name_clause_map</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679330665"><a href="#local-6989586621679330665"><span class="hs-identifier">decs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679330640"><span class="hs-identifier hs-var">gather_decs</span></a><span> </span><span class="hs-identifier hs-var">M.empty</span><span> </span><span class="hs-identifier hs-var">S.empty</span><span> </span><a href="#local-6989586621679330639"><span class="hs-identifier hs-var">decs</span></a><span>
</span><a name="line-237"></a><span>       </span><span class="hs-keyword">in</span><span> </span><a href="#local-6989586621679330641"><span class="hs-identifier hs-var">augment_clauses</span></a><span> </span><a href="#local-6989586621679330664"><span class="hs-identifier hs-var">name_clause_map</span></a><span> </span><a href="#local-6989586621679330665"><span class="hs-identifier hs-var">decs'</span></a><span>
</span><a name="line-238"></a><span>        </span><span class="hs-comment">-- First, for each record selector-related declarations, do the following:</span><span>
</span><a name="line-239"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-240"></a><span>        </span><span class="hs-comment">-- 1. If it's a DFunD...</span><span>
</span><a name="line-241"></a><span>        </span><span class="hs-comment">--   a. If we haven't encountered it before, add a mapping from its Name</span><span>
</span><a name="line-242"></a><span>        </span><span class="hs-comment">--      to its associated DClauses, and continue.</span><span>
</span><a name="line-243"></a><span>        </span><span class="hs-comment">--   b. If we have encountered it before, augment the existing Name's</span><span>
</span><a name="line-244"></a><span>        </span><span class="hs-comment">--      mapping with the new clauses. Then remove the DFunD from the list</span><span>
</span><a name="line-245"></a><span>        </span><span class="hs-comment">--      and continue.</span><span>
</span><a name="line-246"></a><span>        </span><span class="hs-comment">-- 2. If it's a DSigD...</span><span>
</span><a name="line-247"></a><span>        </span><span class="hs-comment">--   a. If we haven't encountered it before, remember its Name and continue.</span><span>
</span><a name="line-248"></a><span>        </span><span class="hs-comment">--   b. If we have encountered it before, remove the DSigD from the list</span><span>
</span><a name="line-249"></a><span>        </span><span class="hs-comment">--      and continue.</span><span>
</span><a name="line-250"></a><span>        </span><span class="hs-comment">-- 3. Otherwise, continue.</span><span>
</span><a name="line-251"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-252"></a><span>        </span><span class="hs-comment">-- After this, scan over the resulting list once more with the mapping</span><span>
</span><a name="line-253"></a><span>        </span><span class="hs-comment">-- that we accumulated. For every DFunD, replace its DClauses with the</span><span>
</span><a name="line-254"></a><span>        </span><span class="hs-comment">-- ones corresponding to its Name in the mapping.</span><span>
</span><a name="line-255"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-256"></a><span>        </span><span class="hs-comment">-- Note that this algorithm combines all of the DClauses for each unique</span><span>
</span><a name="line-257"></a><span>        </span><span class="hs-comment">-- Name, while preserving the order in which the DFunDs were originally</span><span>
</span><a name="line-258"></a><span>        </span><span class="hs-comment">-- found. Moreover, it removes duplicate DSigD entries. Using Maps and</span><span>
</span><a name="line-259"></a><span>        </span><span class="hs-comment">-- Sets avoid quadratic blowup for data types with many record selectors.</span><span>
</span><a name="line-260"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-261"></a><span>        </span><span class="hs-identifier">gather_decs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">M.Map</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-special">[</span><a href="Language.Haskell.TH.Desugar.AST.html#DClause"><span class="hs-identifier hs-type">DClause</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">S.Set</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Language.Haskell.TH.Desugar.AST.html#DLetDec"><span class="hs-identifier hs-type">DLetDec</span></a><span class="hs-special">]</span><span>
</span><a name="line-262"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">M.Map</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-special">[</span><a href="Language.Haskell.TH.Desugar.AST.html#DClause"><span class="hs-identifier hs-type">DClause</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Language.Haskell.TH.Desugar.AST.html#DLetDec"><span class="hs-identifier hs-type">DLetDec</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-263"></a><span>        </span><a name="local-6989586621679330640"><a href="#local-6989586621679330640"><span class="hs-identifier">gather_decs</span></a></a><span> </span><a name="local-6989586621679330642"><a href="#local-6989586621679330642"><span class="hs-identifier">name_clause_map</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679330642"><span class="hs-identifier hs-var">name_clause_map</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-264"></a><span>        </span><span class="hs-identifier">gather_decs</span><span> </span><a name="local-6989586621679330643"><a href="#local-6989586621679330643"><span class="hs-identifier">name_clause_map</span></a></a><span> </span><a name="local-6989586621679330644"><a href="#local-6989586621679330644"><span class="hs-identifier">type_sig_names</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679330645"><a href="#local-6989586621679330645"><span class="hs-identifier">x</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679330646"><a href="#local-6989586621679330646"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-265"></a><span>          </span><span class="hs-comment">-- 1.</span><span>
</span><a name="line-266"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="Language.Haskell.TH.Desugar.AST.html#DFunD"><span class="hs-identifier hs-var">DFunD</span></a><span> </span><a name="local-6989586621679330647"><a href="#local-6989586621679330647"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679330648"><a href="#local-6989586621679330648"><span class="hs-identifier">clauses</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679330645"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-267"></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679330649"><a href="#local-6989586621679330649"><span class="hs-identifier">name_clause_map'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">M.insertWith</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679330650"><a href="#local-6989586621679330650"><span class="hs-identifier">new</span></a></a><span> </span><a name="local-6989586621679330651"><a href="#local-6989586621679330651"><span class="hs-identifier">old</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679330651"><span class="hs-identifier hs-var">old</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679330650"><span class="hs-identifier hs-var">new</span></a><span class="hs-special">)</span><span>
</span><a name="line-268"></a><span>                                                </span><a href="#local-6989586621679330647"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621679330648"><span class="hs-identifier hs-var">clauses</span></a><span> </span><a href="#local-6989586621679330643"><span class="hs-identifier hs-var">name_clause_map</span></a><span>
</span><a name="line-269"></a><span>             </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679330647"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">M.member</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679330643"><span class="hs-identifier hs-var">name_clause_map</span></a><span>
</span><a name="line-270"></a><span>                </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621679330640"><span class="hs-identifier hs-var">gather_decs</span></a><span> </span><a href="#local-6989586621679330649"><span class="hs-identifier hs-var">name_clause_map'</span></a><span> </span><a href="#local-6989586621679330644"><span class="hs-identifier hs-var">type_sig_names</span></a><span> </span><a href="#local-6989586621679330646"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-271"></a><span>                </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679330652"><a href="#local-6989586621679330652"><span class="hs-identifier">map'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679330653"><a href="#local-6989586621679330653"><span class="hs-identifier">decs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679330640"><span class="hs-identifier hs-var">gather_decs</span></a><span> </span><a href="#local-6989586621679330649"><span class="hs-identifier hs-var">name_clause_map'</span></a><span>
</span><a name="line-272"></a><span>                                           </span><a href="#local-6989586621679330644"><span class="hs-identifier hs-var">type_sig_names</span></a><span> </span><a href="#local-6989586621679330646"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-273"></a><span>                      </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679330652"><span class="hs-identifier hs-var">map'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679330645"><span class="hs-identifier hs-var">x</span></a><span class="hs-glyph">:</span><a href="#local-6989586621679330653"><span class="hs-identifier hs-var">decs'</span></a><span class="hs-special">)</span><span>
</span><a name="line-274"></a><span>
</span><a name="line-275"></a><span>          </span><span class="hs-comment">-- 2.</span><span>
</span><a name="line-276"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="Language.Haskell.TH.Desugar.AST.html#DSigD"><span class="hs-identifier hs-var">DSigD</span></a><span> </span><a name="local-6989586621679330654"><a href="#local-6989586621679330654"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679330645"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-277"></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679330654"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">S.member</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679330644"><span class="hs-identifier hs-var">type_sig_names</span></a><span>
</span><a name="line-278"></a><span>            </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621679330640"><span class="hs-identifier hs-var">gather_decs</span></a><span> </span><a href="#local-6989586621679330643"><span class="hs-identifier hs-var">name_clause_map</span></a><span> </span><a href="#local-6989586621679330644"><span class="hs-identifier hs-var">type_sig_names</span></a><span> </span><a href="#local-6989586621679330646"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-279"></a><span>            </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679330655"><a href="#local-6989586621679330655"><span class="hs-identifier">map'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679330656"><a href="#local-6989586621679330656"><span class="hs-identifier">decs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679330640"><span class="hs-identifier hs-var">gather_decs</span></a><span> </span><a href="#local-6989586621679330643"><span class="hs-identifier hs-var">name_clause_map</span></a><span>
</span><a name="line-280"></a><span>                                       </span><span class="hs-special">(</span><a href="#local-6989586621679330654"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">S.insert</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679330644"><span class="hs-identifier hs-var">type_sig_names</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679330646"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-281"></a><span>                  </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679330655"><span class="hs-identifier hs-var">map'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679330645"><span class="hs-identifier hs-var">x</span></a><span class="hs-glyph">:</span><a href="#local-6989586621679330656"><span class="hs-identifier hs-var">decs'</span></a><span class="hs-special">)</span><span>
</span><a name="line-282"></a><span>
</span><a name="line-283"></a><span>          </span><span class="hs-comment">-- 3.</span><span>
</span><a name="line-284"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-285"></a><span>              </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679330657"><a href="#local-6989586621679330657"><span class="hs-identifier">map'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679330658"><a href="#local-6989586621679330658"><span class="hs-identifier">decs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679330640"><span class="hs-identifier hs-var">gather_decs</span></a><span> </span><a href="#local-6989586621679330643"><span class="hs-identifier hs-var">name_clause_map</span></a><span> </span><a href="#local-6989586621679330644"><span class="hs-identifier hs-var">type_sig_names</span></a><span> </span><a href="#local-6989586621679330646"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-286"></a><span>               </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679330657"><span class="hs-identifier hs-var">map'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679330645"><span class="hs-identifier hs-var">x</span></a><span class="hs-glyph">:</span><a href="#local-6989586621679330658"><span class="hs-identifier hs-var">decs'</span></a><span class="hs-special">)</span><span>
</span><a name="line-287"></a><span>
</span><a name="line-288"></a><span>        </span><span class="hs-identifier">augment_clauses</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">M.Map</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-special">[</span><a href="Language.Haskell.TH.Desugar.AST.html#DClause"><span class="hs-identifier hs-type">DClause</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Language.Haskell.TH.Desugar.AST.html#DLetDec"><span class="hs-identifier hs-type">DLetDec</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Language.Haskell.TH.Desugar.AST.html#DLetDec"><span class="hs-identifier hs-type">DLetDec</span></a><span class="hs-special">]</span><span>
</span><a name="line-289"></a><span>        </span><a name="local-6989586621679330641"><a href="#local-6989586621679330641"><span class="hs-identifier">augment_clauses</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-290"></a><span>        </span><span class="hs-identifier">augment_clauses</span><span> </span><a name="local-6989586621679330659"><a href="#local-6989586621679330659"><span class="hs-identifier">name_clause_map</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679330660"><a href="#local-6989586621679330660"><span class="hs-identifier">x</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679330661"><a href="#local-6989586621679330661"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-291"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="Language.Haskell.TH.Desugar.AST.html#DFunD"><span class="hs-identifier hs-var">DFunD</span></a><span> </span><a name="local-6989586621679330662"><a href="#local-6989586621679330662"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679330660"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679330663"><a href="#local-6989586621679330663"><span class="hs-identifier">merged_clauses</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679330662"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">M.lookup</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679330659"><span class="hs-identifier hs-var">name_clause_map</span></a><span>
</span><a name="line-292"></a><span>          </span><span class="hs-glyph">=</span><span> </span><a href="Language.Haskell.TH.Desugar.AST.html#DFunD"><span class="hs-identifier hs-var">DFunD</span></a><span> </span><a href="#local-6989586621679330662"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621679330663"><span class="hs-identifier hs-var">merged_clauses</span></a><span class="hs-glyph">:</span><a href="#local-6989586621679330641"><span class="hs-identifier hs-var">augment_clauses</span></a><span> </span><a href="#local-6989586621679330659"><span class="hs-identifier hs-var">name_clause_map</span></a><span> </span><a href="#local-6989586621679330661"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-293"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679330660"><span class="hs-identifier hs-var">x</span></a><span class="hs-glyph">:</span><a href="#local-6989586621679330641"><span class="hs-identifier hs-var">augment_clauses</span></a><span> </span><a href="#local-6989586621679330659"><span class="hs-identifier hs-var">name_clause_map</span></a><span> </span><a href="#local-6989586621679330661"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-294"></a><span>
</span><a name="line-295"></a><span class="hs-comment">-- | Create new kind variable binder names corresponding to the return kind of</span><span>
</span><a name="line-296"></a><span class="hs-comment">-- a data type. This is useful when you have a data type like:</span><span>
</span><a name="line-297"></a><span class="hs-comment">--</span><span>
</span><a name="line-298"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-299"></a><span class="hs-comment">-- data Foo :: forall k. k -&gt; Type -&gt; Type where ...</span><span>
</span><a name="line-300"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-301"></a><span class="hs-comment">--</span><span>
</span><a name="line-302"></a><span class="hs-comment">-- But you want to be able to refer to the type @Foo a b@.</span><span>
</span><a name="line-303"></a><span class="hs-comment">-- 'mkExtraDKindBinders' will take the kind @forall k. k -&gt; Type -&gt; Type@,</span><span>
</span><a name="line-304"></a><span class="hs-comment">-- discover that is has two visible argument kinds, and return as a result</span><span>
</span><a name="line-305"></a><span class="hs-comment">-- two new kind variable binders @[a :: k, b :: Type]@, where @a@ and @b@</span><span>
</span><a name="line-306"></a><span class="hs-comment">-- are fresh type variable names.</span><span>
</span><a name="line-307"></a><span class="hs-comment">--</span><span>
</span><a name="line-308"></a><span class="hs-comment">-- This expands kind synonyms if necessary.</span><span>
</span><a name="line-309"></a><span class="hs-identifier">mkExtraDKindBinders</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.Haskell.TH.Desugar.Reify.html#DsMonad"><span class="hs-identifier hs-type">DsMonad</span></a><span> </span><a href="#local-6989586621679330586"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Language.Haskell.TH.Desugar.AST.html#DKind"><span class="hs-identifier hs-type">DKind</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679330586"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-special">[</span><a href="Language.Haskell.TH.Desugar.AST.html#DTyVarBndr"><span class="hs-identifier hs-type">DTyVarBndr</span></a><span class="hs-special">]</span><span>
</span><a name="line-310"></a><a name="mkExtraDKindBinders"><a href="Language.Haskell.TH.Desugar.html#mkExtraDKindBinders"><span class="hs-identifier">mkExtraDKindBinders</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.Haskell.TH.Desugar.Expand.html#expandType"><span class="hs-identifier hs-var">expandType</span></a><span> </span><span class="hs-operator hs-var">&gt;=&gt;</span><span> </span><a href="Language.Haskell.TH.Desugar.Core.html#mkExtraDKindBinders%27"><span class="hs-identifier hs-var">mkExtraDKindBinders'</span></a><span>
</span><a name="line-311"></a><span>
</span><a name="line-312"></a><span class="hs-comment">-- | Returns all of a constructor's existentially quantified type variable</span><span>
</span><a name="line-313"></a><span class="hs-comment">-- binders.</span><span>
</span><a name="line-314"></a><span class="hs-comment">--</span><span>
</span><a name="line-315"></a><span class="hs-comment">-- Detecting the presence of existentially quantified type variables in the</span><span>
</span><a name="line-316"></a><span class="hs-comment">-- context of Template Haskell is quite involved. Here is an example that</span><span>
</span><a name="line-317"></a><span class="hs-comment">-- we will use to explain how this works:</span><span>
</span><a name="line-318"></a><span class="hs-comment">--</span><span>
</span><a name="line-319"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-320"></a><span class="hs-comment">-- data family Foo a b</span><span>
</span><a name="line-321"></a><span class="hs-comment">-- data instance Foo (Maybe a) b where</span><span>
</span><a name="line-322"></a><span class="hs-comment">--   MkFoo :: forall x y z. x -&gt; y -&gt; z -&gt; Foo (Maybe x) [z]</span><span>
</span><a name="line-323"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-324"></a><span class="hs-comment">--</span><span>
</span><a name="line-325"></a><span class="hs-comment">-- In @MkFoo@, @x@ is universally quantified, whereas @y@ and @z@ are</span><span>
</span><a name="line-326"></a><span class="hs-comment">-- existentially quantified. Note that @MkFoo@ desugars (in Core) to</span><span>
</span><a name="line-327"></a><span class="hs-comment">-- something like this:</span><span>
</span><a name="line-328"></a><span class="hs-comment">--</span><span>
</span><a name="line-329"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-330"></a><span class="hs-comment">-- data instance Foo (Maybe a) b where</span><span>
</span><a name="line-331"></a><span class="hs-comment">--   MkFoo :: forall a b y z. (b ~ [z]). a -&gt; y -&gt; z -&gt; Foo (Maybe a) b</span><span>
</span><a name="line-332"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-333"></a><span class="hs-comment">--</span><span>
</span><a name="line-334"></a><span class="hs-comment">-- Here, we can see that @a@ appears in the desugared return type (it is a</span><span>
</span><a name="line-335"></a><span class="hs-comment">-- simple alpha-renaming of @x@), so it is universally quantified. On the other</span><span>
</span><a name="line-336"></a><span class="hs-comment">-- hand, neither @y@ nor @z@ appear in the desugared return type, so they are</span><span>
</span><a name="line-337"></a><span class="hs-comment">-- existentially quantified.</span><span>
</span><a name="line-338"></a><span class="hs-comment">--</span><span>
</span><a name="line-339"></a><span class="hs-comment">-- This analysis would not have been possible without knowing what the original</span><span>
</span><a name="line-340"></a><span class="hs-comment">-- data declaration's type was (in this case, @Foo (Maybe a) b@), which is why</span><span>
</span><a name="line-341"></a><span class="hs-comment">-- we require it as an argument. Our algorithm for detecting existentially</span><span>
</span><a name="line-342"></a><span class="hs-comment">-- quantified variables is not too different from what was described above:</span><span>
</span><a name="line-343"></a><span class="hs-comment">-- we match the constructor's return type with the original data type, forming</span><span>
</span><a name="line-344"></a><span class="hs-comment">-- a substitution, and check which quantified variables are not part of the</span><span>
</span><a name="line-345"></a><span class="hs-comment">-- domain of the substitution.</span><span>
</span><a name="line-346"></a><span class="hs-comment">--</span><span>
</span><a name="line-347"></a><span class="hs-comment">-- Be warned: this may overestimate which variables are existentially</span><span>
</span><a name="line-348"></a><span class="hs-comment">-- quantified when kind variables are involved. For instance, consider this</span><span>
</span><a name="line-349"></a><span class="hs-comment">-- example:</span><span>
</span><a name="line-350"></a><span class="hs-comment">--</span><span>
</span><a name="line-351"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-352"></a><span class="hs-comment">-- data S k (a :: k)</span><span>
</span><a name="line-353"></a><span class="hs-comment">-- data T a where</span><span>
</span><a name="line-354"></a><span class="hs-comment">--   MkT :: forall k (a :: k). { foo :: Proxy (a :: k), bar :: S k a } -&gt; T a</span><span>
</span><a name="line-355"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-356"></a><span class="hs-comment">--</span><span>
</span><a name="line-357"></a><span class="hs-comment">-- Here, the kind variable @k@ does not appear syntactically in the return type</span><span>
</span><a name="line-358"></a><span class="hs-comment">-- @T a@, so 'conExistentialTvbs' would mistakenly flag @k@ as existential.</span><span>
</span><a name="line-359"></a><span class="hs-comment">--</span><span>
</span><a name="line-360"></a><span class="hs-comment">-- There are various tricks we could employ to improve this, but ultimately,</span><span>
</span><a name="line-361"></a><span class="hs-comment">-- making this behave correctly with respect to @PolyKinds@ 100% of the time</span><span>
</span><a name="line-362"></a><span class="hs-comment">-- would amount to performing kind inference in Template Haskell, which is</span><span>
</span><a name="line-363"></a><span class="hs-comment">-- quite difficult. For the sake of simplicity, we have decided to stick with</span><span>
</span><a name="line-364"></a><span class="hs-comment">-- a dumb-but-predictable syntactic check.</span><span>
</span><a name="line-365"></a><span class="hs-identifier">conExistentialTvbs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.Haskell.TH.Desugar.Reify.html#DsMonad"><span class="hs-identifier hs-type">DsMonad</span></a><span> </span><a href="#local-6989586621679330585"><span class="hs-identifier hs-type">q</span></a><span>
</span><a name="line-366"></a><span>                   </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Language.Haskell.TH.Desugar.AST.html#DType"><span class="hs-identifier hs-type">DType</span></a><span> </span><span class="hs-comment">-- ^ The type of the original data declaration</span><span>
</span><a name="line-367"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.Haskell.TH.Desugar.AST.html#DCon"><span class="hs-identifier hs-type">DCon</span></a><span>
</span><a name="line-368"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679330585"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-special">[</span><a href="Language.Haskell.TH.Desugar.AST.html#DTyVarBndr"><span class="hs-identifier hs-type">DTyVarBndr</span></a><span class="hs-special">]</span><span>
</span><a name="line-369"></a><a name="conExistentialTvbs"><a href="Language.Haskell.TH.Desugar.html#conExistentialTvbs"><span class="hs-identifier">conExistentialTvbs</span></a></a><span> </span><a name="local-6989586621679330666"><a href="#local-6989586621679330666"><span class="hs-identifier">data_ty</span></a></a><span> </span><span class="hs-special">(</span><a href="Language.Haskell.TH.Desugar.AST.html#DCon"><span class="hs-identifier hs-var">DCon</span></a><span> </span><a name="local-6989586621679330667"><a href="#local-6989586621679330667"><span class="hs-identifier">tvbs</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679330668"><a href="#local-6989586621679330668"><span class="hs-identifier">ret_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-370"></a><span>  </span><span class="hs-comment">-- Due to GHC Trac #13885, it's possible that the type variables bound by</span><span>
</span><a name="line-371"></a><span>  </span><span class="hs-comment">-- a GADT constructor will shadow those that are bound by the data type.</span><span>
</span><a name="line-372"></a><span>  </span><span class="hs-comment">-- This function assumes this isn't the case in certain parts (e.g., when</span><span>
</span><a name="line-373"></a><span>  </span><span class="hs-comment">-- unifying types), so we do an alpha-renaming of the</span><span>
</span><a name="line-374"></a><span>  </span><span class="hs-comment">-- constructor-bound variables before proceeding.</span><span>
</span><a name="line-375"></a><span>  </span><a href="Language.Haskell.TH.Desugar.Subst.html#substTyVarBndrs"><span class="hs-identifier hs-var">substTyVarBndrs</span></a><span> </span><span class="hs-identifier hs-var">M.empty</span><span> </span><a href="#local-6989586621679330667"><span class="hs-identifier hs-var">tvbs</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679330669"><a href="#local-6989586621679330669"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621679330670"><a href="#local-6989586621679330670"><span class="hs-identifier">tvbs'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-376"></a><span>    </span><a name="local-6989586621679330671"><a href="#local-6989586621679330671"><span class="hs-identifier">renamed_ret_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Language.Haskell.TH.Desugar.Subst.html#substTy"><span class="hs-identifier hs-var">substTy</span></a><span> </span><a href="#local-6989586621679330669"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621679330668"><span class="hs-identifier hs-var">ret_ty</span></a><span>
</span><a name="line-377"></a><span>    </span><a name="local-6989586621679330672"><a href="#local-6989586621679330672"><span class="hs-identifier">data_ty'</span></a></a><span>       </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Language.Haskell.TH.Desugar.Expand.html#expandType"><span class="hs-identifier hs-var">expandType</span></a><span> </span><a href="#local-6989586621679330666"><span class="hs-identifier hs-var">data_ty</span></a><span>
</span><a name="line-378"></a><span>    </span><a name="local-6989586621679330673"><a href="#local-6989586621679330673"><span class="hs-identifier">ret_ty'</span></a></a><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Language.Haskell.TH.Desugar.Expand.html#expandType"><span class="hs-identifier hs-var">expandType</span></a><span> </span><a href="#local-6989586621679330671"><span class="hs-identifier hs-var">renamed_ret_ty</span></a><span>
</span><a name="line-379"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="Language.Haskell.TH.Desugar.Subst.html#matchTy"><span class="hs-identifier hs-var">matchTy</span></a><span> </span><a href="Language.Haskell.TH.Desugar.Subst.html#YesIgnore"><span class="hs-identifier hs-var">YesIgnore</span></a><span> </span><a href="#local-6989586621679330673"><span class="hs-identifier hs-var">ret_ty'</span></a><span> </span><a href="#local-6989586621679330672"><span class="hs-identifier hs-var">data_ty'</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-380"></a><span>      </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">showString</span><span> </span><span class="hs-string">&quot;Unable to match type &quot;</span><span>
</span><a name="line-381"></a><span>                      </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">showsPrec</span><span> </span><span class="hs-number">11</span><span> </span><a href="#local-6989586621679330673"><span class="hs-identifier hs-var">ret_ty'</span></a><span>
</span><a name="line-382"></a><span>                      </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">showString</span><span> </span><span class="hs-string">&quot; with &quot;</span><span>
</span><a name="line-383"></a><span>                      </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">showsPrec</span><span> </span><span class="hs-number">11</span><span> </span><a href="#local-6989586621679330672"><span class="hs-identifier hs-var">data_ty'</span></a><span>
</span><a name="line-384"></a><span>                      </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-385"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679330674"><a href="#local-6989586621679330674"><span class="hs-identifier">gadtSubt</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621679330675"><span class="hs-identifier hs-var">tvb</span></a><span>
</span><a name="line-386"></a><span>                              </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621679330675"><a href="#local-6989586621679330675"><span class="hs-identifier">tvb</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679330670"><span class="hs-identifier hs-var">tvbs'</span></a><span>
</span><a name="line-387"></a><span>                              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">M.notMember</span><span> </span><span class="hs-special">(</span><a href="Language.Haskell.TH.Desugar.Core.html#dtvbName"><span class="hs-identifier hs-var">dtvbName</span></a><span> </span><a href="#local-6989586621679330675"><span class="hs-identifier hs-var">tvb</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679330674"><span class="hs-identifier hs-var">gadtSubt</span></a><span>
</span><a name="line-388"></a><span>                              </span><span class="hs-special">]</span><span>
</span><a name="line-389"></a></pre></body></html>