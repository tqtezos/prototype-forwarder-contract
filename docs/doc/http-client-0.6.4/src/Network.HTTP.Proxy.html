<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP               #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE FlexibleContexts  #-}</span><span>
</span><a name="line-4"></a><span>
</span><a name="line-5"></a><span class="hs-comment">{-
Copyright (c) 2002, Warrick Gray
Copyright (c) 2002-2005, Ian Lynagh
Copyright (c) 2003-2006, Bjorn Bringert
Copyright (c) 2004, Andre Furtado
Copyright (c) 2004-2005, Dominic Steinitz
Copyright (c) 2007, Robin Bate Boerop
Copyright (c) 2008-2010, Sigbjorn Finne
Copyright (c) 2009, Eric Kow
Copyright (c) 2010, Antoine Latter
Copyright (c) 2004, 2010-2011, Ganesh Sittampalam
Copyright (c) 2011, Duncan Coutts
Copyright (c) 2011, Matthew Gruen
Copyright (c) 2011, Jeremy Yallop
Copyright (c) 2011, Eric Hesselink
Copyright (c) 2011, Yi Huang
Copyright (c) 2011, Tom Lokhorst
Copyright (c) 2017, Vassil Keremidchiev

All rights reserved.

Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are
met:

    * Redistributions of source code must retain the above copyright
      notice, this list of conditions and the following disclaimer.

    * Redistributions in binary form must reproduce the above
      copyright notice, this list of conditions and the following
      disclaimer in the documentation and/or other materials provided
      with the distribution.

    * The names of contributors may not be used to endorse or promote
      products derived from this software without specific prior
      written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
&quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
-}</span><span>
</span><a name="line-54"></a><span>
</span><a name="line-55"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Network.HTTP.Proxy</span><span class="hs-special">(</span><span>  </span><a href="Network.HTTP.Proxy.html#ProxyProtocol"><span class="hs-identifier hs-type">ProxyProtocol</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Network.HTTP.Proxy.html#EnvHelper"><span class="hs-identifier hs-type">EnvHelper</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-56"></a><span>                            </span><a href="Network.HTTP.Proxy.html#systemProxyHelper"><span class="hs-identifier hs-var">systemProxyHelper</span></a><span class="hs-special">,</span><span> </span><a href="Network.HTTP.Proxy.html#envHelper"><span class="hs-identifier hs-var">envHelper</span></a><span class="hs-special">,</span><span>
</span><a name="line-57"></a><span>                            </span><a href="Network.HTTP.Proxy.html#httpProtocol"><span class="hs-identifier hs-var">httpProtocol</span></a><span class="hs-special">,</span><span>
</span><a name="line-58"></a><span>                            </span><a href="Network.HTTP.Proxy.html#ProxySettings"><span class="hs-identifier hs-type">ProxySettings</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-59"></a><span>
</span><a name="line-60"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Control.Applicative</span><span>         </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">A</span><span>
</span><a name="line-61"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Arrow</span><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-var">first</span><span class="hs-special">)</span><span>
</span><a name="line-62"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Monad</span><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-var">guard</span><span class="hs-special">)</span><span>
</span><a name="line-63"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.ByteString.Char8</span><span>       </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">S8</span><span>
</span><a name="line-64"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Char</span><span>                   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">toLower</span><span class="hs-special">)</span><span>
</span><a name="line-65"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Map</span><span>                    </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Map</span><span>
</span><a name="line-66"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Text</span><span>                   </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">T</span><span>
</span><a name="line-67"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Text.Read</span><span>              </span><span class="hs-special">(</span><span class="hs-identifier hs-var">decimal</span><span class="hs-special">)</span><span>
</span><a name="line-68"></a><span class="hs-keyword">import</span><span>           </span><a href="Network.HTTP.Client.Request.html"><span class="hs-identifier">Network.HTTP.Client.Request</span></a><span> </span><span class="hs-special">(</span><a href="Network.HTTP.Client.Request.html#applyBasicProxyAuth"><span class="hs-identifier hs-var">applyBasicProxyAuth</span></a><span class="hs-special">,</span><span>
</span><a name="line-69"></a><span>                                              </span><a href="Network.HTTP.Client.Request.html#extractBasicAuthInfo"><span class="hs-identifier hs-var">extractBasicAuthInfo</span></a><span class="hs-special">)</span><span>
</span><a name="line-70"></a><span class="hs-keyword">import</span><span>           </span><a href="Network.HTTP.Client.Types.html"><span class="hs-identifier">Network.HTTP.Client.Types</span></a><span>   </span><span class="hs-special">(</span><a href="Network.HTTP.Client.Types.html#HttpExceptionContent"><span class="hs-identifier hs-type">HttpExceptionContent</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-71"></a><span>                                              </span><a href="Network.HTTP.Client.Types.html#Proxy"><span class="hs-identifier hs-type">Proxy</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Network.HTTP.Client.Types.html#Request"><span class="hs-identifier hs-type">Request</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-72"></a><span>                                              </span><a href="Network.HTTP.Client.Types.html#throwHttp"><span class="hs-identifier hs-var">throwHttp</span></a><span class="hs-special">)</span><span>
</span><a name="line-73"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Network.URI</span><span>                 </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">U</span><span>
</span><a name="line-74"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">System.Environment</span><span>          </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getEnvironment</span><span class="hs-special">)</span><span>
</span><a name="line-75"></a><span>
</span><a name="line-76"></a><span class="hs-cpp">#if defined(mingw32_HOST_OS)
</span><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Exception</span><span>           </span><span class="hs-special">(</span><span class="hs-identifier">IOException</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">bracket</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">catch</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">try</span><span class="hs-special">)</span><span>
</span><a name="line-78"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Monad</span><span>               </span><span class="hs-special">(</span><span class="hs-identifier">join</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">liftM</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mplus</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">when</span><span class="hs-special">)</span><span>
</span><a name="line-79"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.List</span><span>                   </span><span class="hs-special">(</span><span class="hs-identifier">isInfixOf</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">isPrefixOf</span><span class="hs-special">)</span><span>
</span><a name="line-80"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Foreign</span><span>                     </span><span class="hs-special">(</span><span class="hs-identifier">Storable</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">peek</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sizeOf</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">alloca</span><span class="hs-special">,</span><span>
</span><a name="line-81"></a><span>                                              </span><span class="hs-identifier">castPtr</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">toBool</span><span class="hs-special">)</span><span>
</span><a name="line-82"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Network.URI</span><span>                 </span><span class="hs-special">(</span><span class="hs-identifier">parseAbsoluteURI</span><span class="hs-special">)</span><span>
</span><a name="line-83"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Safe</span><span>                        </span><span class="hs-special">(</span><span class="hs-identifier">readDef</span><span class="hs-special">)</span><span>
</span><a name="line-84"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">System.IO</span><span>
</span><a name="line-85"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">System.Win32.Registry</span><span>       </span><span class="hs-special">(</span><span class="hs-identifier">hKEY_CURRENT_USER</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rEG_DWORD</span><span class="hs-special">,</span><span>
</span><a name="line-86"></a><span>                                              </span><span class="hs-identifier">regCloseKey</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">regOpenKey</span><span class="hs-special">,</span><span>
</span><a name="line-87"></a><span>                                              </span><span class="hs-identifier">regQueryValue</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">regQueryValueEx</span><span class="hs-special">)</span><span>
</span><a name="line-88"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">System.Win32.Types</span><span>          </span><span class="hs-special">(</span><span class="hs-identifier">DWORD</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">HKEY</span><span class="hs-special">)</span><span>
</span><a name="line-89"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-91"></a><span class="hs-keyword">type</span><span> </span><a name="EnvName"><a href="Network.HTTP.Proxy.html#EnvName"><span class="hs-identifier">EnvName</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">T.Text</span><span>
</span><a name="line-92"></a><span class="hs-keyword">type</span><span> </span><a name="HostAddress"><a href="Network.HTTP.Proxy.html#HostAddress"><span class="hs-identifier">HostAddress</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">S8.ByteString</span><span>
</span><a name="line-93"></a><span class="hs-keyword">type</span><span> </span><a name="UserName"><a href="Network.HTTP.Proxy.html#UserName"><span class="hs-identifier">UserName</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">S8.ByteString</span><span>
</span><a name="line-94"></a><span class="hs-keyword">type</span><span> </span><a name="Password"><a href="Network.HTTP.Proxy.html#Password"><span class="hs-identifier">Password</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">S8.ByteString</span><span>
</span><a name="line-95"></a><span>
</span><a name="line-96"></a><span class="hs-comment">-- There are other proxy protocols like SOCKS, FTP, etc.</span><span>
</span><a name="line-97"></a><span class="hs-keyword">data</span><span> </span><a name="ProxyProtocol"><a href="Network.HTTP.Proxy.html#ProxyProtocol"><span class="hs-identifier">ProxyProtocol</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="HTTPProxy"><a href="Network.HTTP.Proxy.html#HTTPProxy"><span class="hs-identifier">HTTPProxy</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="HTTPSProxy"><a href="Network.HTTP.Proxy.html#HTTPSProxy"><span class="hs-identifier">HTTPSProxy</span></a></a><span>
</span><a name="line-98"></a><span>
</span><a name="line-99"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Show</span><span> </span><a href="Network.HTTP.Proxy.html#ProxyProtocol"><span class="hs-identifier hs-type">ProxyProtocol</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-100"></a><span>    </span><a name="local-8214565720323790400"><span class="hs-identifier">show</span></a><span> </span><a href="Network.HTTP.Proxy.html#HTTPProxy"><span class="hs-identifier hs-var">HTTPProxy</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;http&quot;</span><span>
</span><a name="line-101"></a><span>    </span><span class="hs-identifier">show</span><span> </span><a href="Network.HTTP.Proxy.html#HTTPSProxy"><span class="hs-identifier hs-var">HTTPSProxy</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;https&quot;</span><span>
</span><a name="line-102"></a><span>
</span><a name="line-103"></a><span class="hs-keyword">data</span><span> </span><a name="ProxySettings"><a href="Network.HTTP.Proxy.html#ProxySettings"><span class="hs-identifier">ProxySettings</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="ProxySettings"><a href="Network.HTTP.Proxy.html#ProxySettings"><span class="hs-identifier">ProxySettings</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="_proxyHost"><a href="Network.HTTP.Proxy.html#_proxyHost"><span class="hs-identifier">_proxyHost</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.HTTP.Client.Types.html#Proxy"><span class="hs-identifier hs-type">Proxy</span></a><span class="hs-special">,</span><span>
</span><a name="line-104"></a><span>                                     </span><a name="_proxyAuth"><a href="Network.HTTP.Proxy.html#_proxyAuth"><span class="hs-identifier">_proxyAuth</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="Network.HTTP.Proxy.html#UserName"><span class="hs-identifier hs-type">UserName</span></a><span class="hs-special">,</span><span> </span><a href="Network.HTTP.Proxy.html#Password"><span class="hs-identifier hs-type">Password</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-105"></a><span>                                     </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-identifier hs-type">Show</span><span>
</span><a name="line-106"></a><span>
</span><a name="line-107"></a><span class="hs-identifier">httpProtocol</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.HTTP.Proxy.html#ProxyProtocol"><span class="hs-identifier hs-type">ProxyProtocol</span></a><span>
</span><a name="line-108"></a><a name="httpProtocol"><a href="Network.HTTP.Proxy.html#httpProtocol"><span class="hs-identifier">httpProtocol</span></a></a><span> </span><span class="hs-identifier hs-var">True</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Network.HTTP.Proxy.html#HTTPSProxy"><span class="hs-identifier hs-var">HTTPSProxy</span></a><span>
</span><a name="line-109"></a><span class="hs-identifier">httpProtocol</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.HTTP.Proxy.html#HTTPProxy"><span class="hs-identifier hs-var">HTTPProxy</span></a><span>
</span><a name="line-110"></a><span>
</span><a name="line-111"></a><span class="hs-keyword">data</span><span> </span><a name="EnvHelper"><a href="Network.HTTP.Proxy.html#EnvHelper"><span class="hs-identifier">EnvHelper</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="EHFromRequest"><a href="Network.HTTP.Proxy.html#EHFromRequest"><span class="hs-identifier">EHFromRequest</span></a></a><span>
</span><a name="line-112"></a><span>               </span><span class="hs-glyph">|</span><span> </span><a name="EHNoProxy"><a href="Network.HTTP.Proxy.html#EHNoProxy"><span class="hs-identifier">EHNoProxy</span></a></a><span>
</span><a name="line-113"></a><span>               </span><span class="hs-glyph">|</span><span> </span><a name="EHUseProxy"><a href="Network.HTTP.Proxy.html#EHUseProxy"><span class="hs-identifier">EHUseProxy</span></a></a><span> </span><a href="Network.HTTP.Client.Types.html#Proxy"><span class="hs-identifier hs-type">Proxy</span></a><span>
</span><a name="line-114"></a><span>
</span><a name="line-115"></a><span class="hs-identifier">headJust</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621679108416"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621679108416"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-116"></a><a name="headJust"><a href="Network.HTTP.Proxy.html#headJust"><span class="hs-identifier">headJust</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-117"></a><span class="hs-identifier">headJust</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Nothing</span><span class="hs-glyph">:</span><a name="local-6989586621679108417"><a href="#local-6989586621679108417"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="Network.HTTP.Proxy.html#headJust"><span class="hs-identifier hs-var">headJust</span></a><span> </span><a href="#local-6989586621679108417"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-118"></a><span class="hs-identifier">headJust</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621679108418"><a href="#local-6989586621679108418"><span class="hs-identifier">y</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679108418"><span class="hs-identifier hs-var">y</span></a><span>
</span><a name="line-119"></a><span>
</span><a name="line-120"></a><span class="hs-identifier">systemProxyHelper</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">T.Text</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.HTTP.Proxy.html#ProxyProtocol"><span class="hs-identifier hs-type">ProxyProtocol</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.HTTP.Proxy.html#EnvHelper"><span class="hs-identifier hs-type">EnvHelper</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="Network.HTTP.Client.Types.html#Request"><span class="hs-identifier hs-type">Request</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.HTTP.Client.Types.html#Request"><span class="hs-identifier hs-type">Request</span></a><span class="hs-special">)</span><span>
</span><a name="line-121"></a><a name="systemProxyHelper"><a href="Network.HTTP.Proxy.html#systemProxyHelper"><span class="hs-identifier">systemProxyHelper</span></a></a><span> </span><a name="local-6989586621679108419"><a href="#local-6989586621679108419"><span class="hs-identifier">envOveride</span></a></a><span> </span><a name="local-6989586621679108420"><a href="#local-6989586621679108420"><span class="hs-identifier">prot</span></a></a><span> </span><a name="local-6989586621679108421"><a href="#local-6989586621679108421"><span class="hs-identifier">eh</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-122"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679108422"><a href="#local-6989586621679108422"><span class="hs-identifier">envName'</span></a></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="Network.HTTP.Proxy.html#envName"><span class="hs-identifier hs-var">envName</span></a><span> </span><a href="#local-6989586621679108420"><span class="hs-identifier hs-var">prot</span></a><span>
</span><a name="line-123"></a><span>        </span><span class="hs-identifier">envName'</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679108423"><a href="#local-6989586621679108423"><span class="hs-identifier">name</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679108423"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-124"></a><span>
</span><a name="line-125"></a><span>    </span><a name="local-6989586621679108424"><a href="#local-6989586621679108424"><span class="hs-identifier">modifier</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Network.HTTP.Proxy.html#envHelper"><span class="hs-identifier hs-var">envHelper</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679108422"><span class="hs-identifier hs-var">envName'</span></a><span> </span><a href="#local-6989586621679108419"><span class="hs-identifier hs-var">envOveride</span></a><span class="hs-special">)</span><span>
</span><a name="line-126"></a><span>
</span><a name="line-127"></a><span class="hs-comment">-- Under Windows try first env. variables override then Windows proxy settings</span><span>
</span><a name="line-128"></a><span class="hs-cpp">#if defined(mingw32_HOST_OS)
</span><span>    </span><span class="hs-identifier">modifier'</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">systemProxy</span><span> </span><span class="hs-identifier">prot</span><span>
</span><a name="line-130"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">modifiers</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">modifier</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">modifier'</span><span class="hs-special">]</span><span>
</span><a name="line-131"></a><span class="hs-cpp">#else
</span><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679108425"><a href="#local-6989586621679108425"><span class="hs-identifier">modifiers</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679108424"><span class="hs-identifier hs-var">modifier</span></a><span class="hs-special">]</span><span>
</span><a name="line-133"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-135"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">chooseMod</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.HTTP.Client.Types.html#Request"><span class="hs-identifier hs-type">Request</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Network.HTTP.Proxy.html#ProxySettings"><span class="hs-identifier hs-type">ProxySettings</span></a><span>
</span><a name="line-136"></a><span>        </span><a name="local-6989586621679108426"><a href="#local-6989586621679108426"><span class="hs-identifier">chooseMod</span></a></a><span> </span><a name="local-6989586621679108428"><a href="#local-6989586621679108428"><span class="hs-identifier">req</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.HTTP.Proxy.html#headJust"><span class="hs-identifier hs-var">headJust</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679108429"><a href="#local-6989586621679108429"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679108429"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">host</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679108428"><span class="hs-identifier hs-var">req</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679108425"><span class="hs-identifier hs-var">modifiers</span></a><span>
</span><a name="line-137"></a><span>
</span><a name="line-138"></a><span>        </span><a name="local-6989586621679108427"><a href="#local-6989586621679108427"><span class="hs-identifier">noEnvProxy</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679108421"><span class="hs-identifier hs-var">eh</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-139"></a><span>            </span><a href="Network.HTTP.Proxy.html#EHFromRequest"><span class="hs-identifier hs-var">EHFromRequest</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">id</span><span>
</span><a name="line-140"></a><span>            </span><a href="Network.HTTP.Proxy.html#EHNoProxy"><span class="hs-identifier hs-var">EHNoProxy</span></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679108430"><a href="#local-6989586621679108430"><span class="hs-identifier">req</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679108430"><span class="hs-identifier hs-var">req</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">proxy</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-141"></a><span>            </span><a href="Network.HTTP.Proxy.html#EHUseProxy"><span class="hs-identifier hs-var">EHUseProxy</span></a><span> </span><a name="local-6989586621679108431"><a href="#local-6989586621679108431"><span class="hs-identifier">p</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679108432"><a href="#local-6989586621679108432"><span class="hs-identifier">req</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679108432"><span class="hs-identifier hs-var">req</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">proxy</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679108431"><span class="hs-identifier hs-var">p</span></a><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-142"></a><span>
</span><a name="line-143"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679108433"><a href="#local-6989586621679108433"><span class="hs-identifier">result</span></a></a><span> </span><a name="local-6989586621679108434"><a href="#local-6989586621679108434"><span class="hs-identifier">req</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679108435"><span class="hs-identifier hs-var">toRequest</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679108426"><span class="hs-identifier hs-var">chooseMod</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679108434"><span class="hs-identifier hs-var">req</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-144"></a><span>            </span><a name="local-6989586621679108435"><a href="#local-6989586621679108435"><span class="hs-identifier">toRequest</span></a></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>                            </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679108427"><span class="hs-identifier hs-var">noEnvProxy</span></a><span> </span><a href="#local-6989586621679108434"><span class="hs-identifier hs-var">req</span></a><span>
</span><a name="line-145"></a><span>            </span><span class="hs-identifier">toRequest</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="Network.HTTP.Proxy.html#ProxySettings"><span class="hs-identifier hs-var">ProxySettings</span></a><span> </span><a name="local-6989586621679108436"><a href="#local-6989586621679108436"><span class="hs-identifier">p</span></a></a><span> </span><a name="local-6989586621679108437"><a href="#local-6989586621679108437"><span class="hs-identifier">muserpass</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-identifier hs-var">id</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">uncurry</span><span> </span><a href="Network.HTTP.Client.Request.html#applyBasicProxyAuth"><span class="hs-identifier hs-var">applyBasicProxyAuth</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679108437"><span class="hs-identifier hs-var">muserpass</span></a><span>
</span><a name="line-146"></a><span>                                        </span><a href="#local-6989586621679108434"><span class="hs-identifier hs-var">req</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">proxy</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679108436"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-147"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679108433"><span class="hs-identifier hs-var">result</span></a><span>
</span><a name="line-148"></a><span>
</span><a name="line-149"></a><span>
</span><a name="line-150"></a><span class="hs-cpp">#if defined(mingw32_HOST_OS)
</span><span class="hs-identifier">windowsProxyString</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">ProxyProtocol</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">String</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">String</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-152"></a><span class="hs-identifier">windowsProxyString</span><span> </span><span class="hs-identifier">proto</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-153"></a><span>    </span><span class="hs-identifier">mProxy</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">registryProxyString</span><span>
</span><a name="line-154"></a><span>    </span><span class="hs-identifier">return</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-155"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier">proxies</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">exceptions</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">mProxy</span><span>
</span><a name="line-156"></a><span>        </span><span class="hs-identifier">protoProxy</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">parseWindowsProxy</span><span> </span><span class="hs-identifier">proto</span><span> </span><span class="hs-identifier">proxies</span><span>
</span><a name="line-157"></a><span>        </span><span class="hs-identifier">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">protoProxy</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">exceptions</span><span class="hs-special">)</span><span>
</span><a name="line-158"></a><span>
</span><a name="line-159"></a><span class="hs-identifier">registryProxyLoc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">HKEY</span><span class="hs-special">,</span><span class="hs-identifier">String</span><span class="hs-special">)</span><span>
</span><a name="line-160"></a><span class="hs-identifier">registryProxyLoc</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hive</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">path</span><span class="hs-special">)</span><span>
</span><a name="line-161"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-162"></a><span>    </span><span class="hs-comment">-- some sources say proxy settings should be at</span><span>
</span><a name="line-163"></a><span>    </span><span class="hs-comment">-- HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows</span><span>
</span><a name="line-164"></a><span>    </span><span class="hs-comment">--                   \CurrentVersion\Internet Settings\ProxyServer</span><span>
</span><a name="line-165"></a><span>    </span><span class="hs-comment">-- but if the user sets them with IE connection panel they seem to</span><span>
</span><a name="line-166"></a><span>    </span><span class="hs-comment">-- end up in the following place:</span><span>
</span><a name="line-167"></a><span>    </span><span class="hs-identifier">hive</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hKEY_CURRENT_USER</span><span>
</span><a name="line-168"></a><span>    </span><span class="hs-identifier">path</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings&quot;</span><span>
</span><a name="line-169"></a><span>
</span><a name="line-170"></a><span class="hs-comment">-- read proxy settings from the windows registry; this is just a best</span><span>
</span><a name="line-171"></a><span class="hs-comment">-- effort and may not work on all setups.</span><span>
</span><a name="line-172"></a><span class="hs-identifier">registryProxyString</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">String</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">String</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-173"></a><span class="hs-identifier">registryProxyString</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">catch</span><span>
</span><a name="line-174"></a><span>  </span><span class="hs-special">(</span><span class="hs-identifier">bracket</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">uncurry</span><span> </span><span class="hs-identifier">regOpenKey</span><span> </span><span class="hs-identifier">registryProxyLoc</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">regCloseKey</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">hkey</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-175"></a><span>    </span><span class="hs-identifier">enable</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">toBool</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">maybe</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-identifier">id</span><span> </span><span class="hs-operator">A.&lt;$&gt;</span><span> </span><span class="hs-identifier">regQueryValueDWORD</span><span> </span><span class="hs-identifier">hkey</span><span> </span><span class="hs-string">&quot;ProxyEnable&quot;</span><span>
</span><a name="line-176"></a><span>    </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">enable</span><span>
</span><a name="line-177"></a><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-178"></a><span class="hs-cpp">#if MIN_VERSION_Win32(2, 6, 0)
</span><span>            </span><span class="hs-identifier">server</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">regQueryValue</span><span> </span><span class="hs-identifier">hkey</span><span> </span><span class="hs-string">&quot;ProxyServer&quot;</span><span>
</span><a name="line-180"></a><span>            </span><span class="hs-identifier">exceptions</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">try</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">regQueryValue</span><span> </span><span class="hs-identifier">hkey</span><span> </span><span class="hs-string">&quot;ProxyOverride&quot;</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Either</span><span> </span><span class="hs-identifier">IOException</span><span> </span><span class="hs-identifier">String</span><span class="hs-special">)</span><span>
</span><a name="line-181"></a><span class="hs-cpp">#else
</span><span>            </span><span class="hs-identifier">server</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">regQueryValue</span><span> </span><span class="hs-identifier">hkey</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Just</span><span> </span><span class="hs-string">&quot;ProxyServer&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-183"></a><span>            </span><span class="hs-identifier">exceptions</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">try</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">regQueryValue</span><span> </span><span class="hs-identifier">hkey</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Just</span><span> </span><span class="hs-string">&quot;ProxyOverride&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Either</span><span> </span><span class="hs-identifier">IOException</span><span> </span><span class="hs-identifier">String</span><span class="hs-special">)</span><span>
</span><a name="line-184"></a><span class="hs-cpp">#endif
</span><span>            </span><span class="hs-identifier">return</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">server</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">either</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">const</span><span> </span><span class="hs-string">&quot;&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">id</span><span> </span><span class="hs-identifier">exceptions</span><span class="hs-special">)</span><span>
</span><a name="line-186"></a><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier">return</span><span> </span><span class="hs-identifier">Nothing</span><span class="hs-special">)</span><span>
</span><a name="line-187"></a><span>  </span><span class="hs-identifier">hideError</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-188"></a><span>      </span><span class="hs-identifier">hideError</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">IOException</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">String</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">String</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-189"></a><span>      </span><span class="hs-identifier">hideError</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">return</span><span> </span><span class="hs-identifier">Nothing</span><span>
</span><a name="line-190"></a><span>
</span><a name="line-191"></a><span class="hs-comment">-- the proxy string is in the format &quot;http=x.x.x.x:yyyy;https=...;ftp=...;socks=...&quot;</span><span>
</span><a name="line-192"></a><span class="hs-comment">-- even though the following article indicates otherwise</span><span>
</span><a name="line-193"></a><span class="hs-comment">-- https://support.microsoft.com/en-us/kb/819961</span><span>
</span><a name="line-194"></a><span class="hs-comment">--</span><span>
</span><a name="line-195"></a><span class="hs-comment">-- to be sure, parse strings where each entry in the ';'-separated list above is</span><span>
</span><a name="line-196"></a><span class="hs-comment">-- either in the format &quot;protocol=...&quot; or &quot;protocol://...&quot;</span><span>
</span><a name="line-197"></a><span class="hs-identifier">parseWindowsProxy</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">ProxyProtocol</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Maybe</span><span> </span><span class="hs-identifier">String</span><span>
</span><a name="line-198"></a><span class="hs-identifier">parseWindowsProxy</span><span> </span><span class="hs-identifier">proto</span><span> </span><span class="hs-identifier">s</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-199"></a><span>  </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">proxies</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-200"></a><span>    </span><span class="hs-identifier">x</span><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Just</span><span> </span><span class="hs-identifier">x</span><span>
</span><a name="line-201"></a><span>    </span><span class="hs-identifier">_</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Nothing</span><span>
</span><a name="line-202"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-203"></a><span>    </span><span class="hs-identifier">parts</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">split</span><span> </span><span class="hs-char">';'</span><span> </span><span class="hs-identifier">s</span><span>
</span><a name="line-204"></a><span>    </span><span class="hs-identifier">pr</span><span> </span><span class="hs-identifier">x</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">break</span><span> </span><span class="hs-special">(</span><span class="hs-operator">==</span><span> </span><span class="hs-char">'='</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">x</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-205"></a><span>      </span><span class="hs-special">(</span><span class="hs-identifier">p</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">p</span><span>  </span><span class="hs-comment">-- might be in format http://</span><span>
</span><a name="line-206"></a><span>      </span><span class="hs-special">(</span><span class="hs-identifier">p</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">u</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">p</span><span> </span><span class="hs-operator">++</span><span> </span><span class="hs-string">&quot;://&quot;</span><span> </span><span class="hs-operator">++</span><span> </span><span class="hs-identifier">drop</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-identifier">u</span><span>
</span><a name="line-207"></a><span>
</span><a name="line-208"></a><span>    </span><span class="hs-identifier">protoPrefix</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">show</span><span> </span><span class="hs-identifier">proto</span><span class="hs-special">)</span><span> </span><span class="hs-operator">++</span><span> </span><span class="hs-string">&quot;://&quot;</span><span>
</span><a name="line-209"></a><span>    </span><span class="hs-identifier">proxies</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">filter</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">isPrefixOf</span><span> </span><span class="hs-identifier">protoPrefix</span><span class="hs-special">)</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">map</span><span> </span><span class="hs-identifier">pr</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">parts</span><span>
</span><a name="line-210"></a><span>
</span><a name="line-211"></a><span>    </span><span class="hs-identifier">split</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Eq</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">a</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="hs-identifier">a</span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-212"></a><span>    </span><span class="hs-identifier">split</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-213"></a><span>    </span><span class="hs-identifier">split</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-identifier">xs</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">break</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">a</span><span> </span><span class="hs-operator">==</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">xs</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-214"></a><span>      </span><span class="hs-special">(</span><span class="hs-identifier">ys</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">ys</span><span class="hs-special">]</span><span>
</span><a name="line-215"></a><span>      </span><span class="hs-special">(</span><span class="hs-identifier">ys</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-glyph">:</span><span class="hs-identifier">zs</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">ys</span><span class="hs-glyph">:</span><span class="hs-identifier">split</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-identifier">zs</span><span>
</span><a name="line-216"></a><span>
</span><a name="line-217"></a><span class="hs-comment">-- Extract proxy settings from Windows registry. This is a standard way in Windows OS.</span><span>
</span><a name="line-218"></a><span class="hs-identifier">systemProxy</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">ProxyProtocol</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">HostAddress</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Maybe</span><span> </span><span class="hs-identifier">ProxySettings</span><span class="hs-special">)</span><span>
</span><a name="line-219"></a><span class="hs-identifier">systemProxy</span><span> </span><span class="hs-identifier">proto</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-220"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">isURLlocal</span><span> </span><span class="hs-string">&quot;127.0.0.1&quot;</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">True</span><span>
</span><a name="line-221"></a><span>        </span><span class="hs-identifier">isURLlocal</span><span> </span><span class="hs-string">&quot;localhost&quot;</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">True</span><span>
</span><a name="line-222"></a><span>        </span><span class="hs-identifier">isURLlocal</span><span> </span><span class="hs-identifier">_</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">False</span><span>
</span><a name="line-223"></a><span>
</span><a name="line-224"></a><span>        </span><span class="hs-identifier">hasLocal</span><span> </span><span class="hs-identifier">exceptions</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;&lt;local&gt;&quot;</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">isInfixOf</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">exceptions</span><span>
</span><a name="line-225"></a><span>
</span><a name="line-226"></a><span>    </span><span class="hs-identifier">settings</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">fetchProxy</span><span> </span><span class="hs-identifier">proto</span><span>
</span><a name="line-227"></a><span>    </span><span class="hs-identifier">return</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">url</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-228"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier">proxy</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">exceptions</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">settings</span><span>
</span><a name="line-229"></a><span>
</span><a name="line-230"></a><span>        </span><span class="hs-comment">-- Skip proxy for local hosts if it's enabled in IE settings</span><span>
</span><a name="line-231"></a><span>        </span><span class="hs-comment">-- TODO Implement skipping for address patterns, like (*.google.com)</span><span>
</span><a name="line-232"></a><span>        </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">isURLlocal</span><span> </span><span class="hs-identifier">url</span><span> </span><span class="hs-operator">&amp;&amp;</span><span> </span><span class="hs-identifier">hasLocal</span><span> </span><span class="hs-identifier">exceptions</span><span class="hs-special">)</span><span> </span><span class="hs-operator">||</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">url</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">S8.isInfixOf</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">S8.pack</span><span> </span><span class="hs-identifier">exceptions</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier">Nothing</span><span>
</span><a name="line-233"></a><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier">Just</span><span> </span><span class="hs-identifier">proxy</span><span>
</span><a name="line-234"></a><span>
</span><a name="line-235"></a><span class="hs-comment">-- | @fetchProxy flg@ gets the local proxy settings and parse the string</span><span>
</span><a name="line-236"></a><span class="hs-comment">-- into a @Proxy@ value.</span><span>
</span><a name="line-237"></a><span class="hs-comment">-- Proxy settings are sourced from IE/WinInet's proxy</span><span>
</span><a name="line-238"></a><span class="hs-comment">-- setting in the Registry.</span><span>
</span><a name="line-239"></a><span class="hs-identifier">fetchProxy</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">ProxyProtocol</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ProxySettings</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">String</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-240"></a><span class="hs-identifier">fetchProxy</span><span> </span><span class="hs-identifier">proto</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-241"></a><span>    </span><span class="hs-identifier">mstr</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">windowsProxyString</span><span> </span><span class="hs-identifier">proto</span><span>
</span><a name="line-242"></a><span>    </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">mstr</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-243"></a><span>      </span><span class="hs-identifier">Nothing</span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">return</span><span> </span><span class="hs-identifier">Nothing</span><span>
</span><a name="line-244"></a><span>      </span><span class="hs-identifier">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">proxy</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">except</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">parseProxy</span><span> </span><span class="hs-identifier">proto</span><span> </span><span class="hs-identifier">proxy</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-245"></a><span>          </span><span class="hs-identifier">Just</span><span> </span><span class="hs-identifier">p</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">return</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">p</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">except</span><span class="hs-special">)</span><span>
</span><a name="line-246"></a><span>          </span><span class="hs-identifier">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-247"></a><span>              </span><span class="hs-identifier">throwHttp</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">InvalidProxySettings</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">T.pack</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">unlines</span><span> </span><span class="hs-operator">$</span><span>
</span><a name="line-248"></a><span>                      </span><span class="hs-special">[</span><span> </span><span class="hs-string">&quot;Invalid http proxy uri: &quot;</span><span> </span><span class="hs-operator">++</span><span> </span><span class="hs-identifier">show</span><span> </span><span class="hs-identifier">proxy</span><span>
</span><a name="line-249"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;proxy uri must be http with a hostname&quot;</span><span>
</span><a name="line-250"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;ignoring http proxy, trying a direct connection&quot;</span><span>
</span><a name="line-251"></a><span>                      </span><span class="hs-special">]</span><span>
</span><a name="line-252"></a><span>
</span><a name="line-253"></a><span class="hs-comment">-- | @parseProxy str@ translates a proxy server string into a @ProxySettings@ value;</span><span>
</span><a name="line-254"></a><span class="hs-comment">-- returns @Nothing@ if not well-formed.</span><span>
</span><a name="line-255"></a><span class="hs-identifier">parseProxy</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">ProxyProtocol</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Maybe</span><span> </span><span class="hs-identifier">ProxySettings</span><span>
</span><a name="line-256"></a><span class="hs-identifier">parseProxy</span><span> </span><span class="hs-identifier">proto</span><span> </span><span class="hs-identifier">str</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">join</span><span>
</span><a name="line-257"></a><span>                 </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">uri2proxy</span><span> </span><span class="hs-identifier">proto</span><span class="hs-special">)</span><span>
</span><a name="line-258"></a><span>                 </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">parseHttpURI</span><span> </span><span class="hs-identifier">str</span><span>
</span><a name="line-259"></a><span>                 </span><span class="hs-special">`</span><span class="hs-identifier">mplus</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">parseHttpURI</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">protoPrefix</span><span> </span><span class="hs-operator">++</span><span> </span><span class="hs-identifier">str</span><span class="hs-special">)</span><span>
</span><a name="line-260"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-261"></a><span>     </span><span class="hs-identifier">protoPrefix</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">show</span><span> </span><span class="hs-identifier">proto</span><span class="hs-special">)</span><span> </span><span class="hs-operator">++</span><span> </span><span class="hs-string">&quot;://&quot;</span><span>
</span><a name="line-262"></a><span>     </span><span class="hs-identifier">parseHttpURI</span><span> </span><span class="hs-identifier">str'</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-263"></a><span>      </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">parseAbsoluteURI</span><span> </span><span class="hs-identifier">str'</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-264"></a><span>        </span><span class="hs-identifier">Just</span><span> </span><span class="hs-identifier">uri</span><span class="hs-glyph">@</span><span class="hs-identifier">U.URI</span><span class="hs-special">{</span><span class="hs-identifier">U.uriAuthority</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">Just</span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">fixUserInfo</span><span> </span><span class="hs-identifier">uri</span><span class="hs-special">)</span><span>
</span><a name="line-265"></a><span>        </span><span class="hs-identifier">_</span><span>                                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Nothing</span><span>
</span><a name="line-266"></a><span>
</span><a name="line-267"></a><span>       </span><span class="hs-comment">-- Note: we need to be able to parse non-URIs like @\&quot;wwwcache.example.com:80\&quot;@</span><span>
</span><a name="line-268"></a><span>       </span><span class="hs-comment">-- which lack the @\&quot;http://\&quot;@ URI scheme. The problem is that</span><span>
</span><a name="line-269"></a><span>       </span><span class="hs-comment">-- @\&quot;wwwcache.example.com:80\&quot;@ is in fact a valid URI but with scheme</span><span>
</span><a name="line-270"></a><span>       </span><span class="hs-comment">-- @\&quot;wwwcache.example.com:\&quot;@, no authority part and a path of @\&quot;80\&quot;@.</span><span>
</span><a name="line-271"></a><span>       </span><span class="hs-comment">--</span><span>
</span><a name="line-272"></a><span>       </span><span class="hs-comment">-- So our strategy is to try parsing as normal uri first and if it lacks the</span><span>
</span><a name="line-273"></a><span>       </span><span class="hs-comment">-- 'uriAuthority' then we try parsing again with a @\&quot;http://\&quot;@ prefix.</span><span>
</span><a name="line-274"></a><span>       </span><span class="hs-comment">--</span><span>
</span><a name="line-275"></a><span>
</span><a name="line-276"></a><span class="hs-comment">-- | @dropWhileTail p ls@ chops off trailing elements from @ls@</span><span>
</span><a name="line-277"></a><span class="hs-comment">-- until @p@ returns @False@.</span><span>
</span><a name="line-278"></a><span class="hs-identifier">dropWhileTail</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Bool</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">a</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">a</span><span class="hs-special">]</span><span>
</span><a name="line-279"></a><span class="hs-identifier">dropWhileTail</span><span> </span><span class="hs-identifier">f</span><span> </span><span class="hs-identifier">ls</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-280"></a><span>    </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">foldr</span><span> </span><span class="hs-identifier">chop</span><span> </span><span class="hs-identifier">Nothing</span><span> </span><span class="hs-identifier">ls</span><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">Just</span><span> </span><span class="hs-identifier">xs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">xs</span><span class="hs-special">;</span><span> </span><span class="hs-identifier">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-281"></a><span>     </span><span class="hs-keyword">where</span><span>
</span><a name="line-282"></a><span>       </span><span class="hs-identifier">chop</span><span> </span><span class="hs-identifier">x</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Just</span><span> </span><span class="hs-identifier">xs</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">x</span><span class="hs-glyph">:</span><span class="hs-identifier">xs</span><span class="hs-special">)</span><span>
</span><a name="line-283"></a><span>       </span><span class="hs-identifier">chop</span><span> </span><span class="hs-identifier">x</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-284"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">f</span><span> </span><span class="hs-identifier">x</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">Nothing</span><span>
</span><a name="line-285"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">Just</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">x</span><span class="hs-special">]</span><span>
</span><a name="line-286"></a><span>
</span><a name="line-287"></a><span class="hs-comment">-- | @chopAtDelim elt ls@ breaks up @ls@ into two at first occurrence</span><span>
</span><a name="line-288"></a><span class="hs-comment">-- of @elt@; @elt@ is elided too. If @elt@ does not occur, the second</span><span>
</span><a name="line-289"></a><span class="hs-comment">-- list is empty and the first is equal to @ls@.</span><span>
</span><a name="line-290"></a><span class="hs-identifier">chopAtDelim</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Eq</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">a</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier">a</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-identifier">a</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-291"></a><span class="hs-identifier">chopAtDelim</span><span> </span><span class="hs-identifier">elt</span><span> </span><span class="hs-identifier">xs</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-292"></a><span>    </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">break</span><span> </span><span class="hs-special">(</span><span class="hs-operator">==</span><span class="hs-identifier">elt</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">xs</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-293"></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">xs</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-294"></a><span>    </span><span class="hs-special">(</span><span class="hs-keyword">as</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-glyph">:</span><span class="hs-identifier">bs</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">as</span><span class="hs-special">,</span><span class="hs-identifier">bs</span><span class="hs-special">)</span><span>
</span><a name="line-295"></a><span>
</span><a name="line-296"></a><span class="hs-comment">-- | tidy up user portion, don't want the trailing &quot;\@&quot;.</span><span>
</span><a name="line-297"></a><span class="hs-identifier">fixUserInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">U.URI</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">U.URI</span><span>
</span><a name="line-298"></a><span class="hs-identifier">fixUserInfo</span><span> </span><span class="hs-identifier">uri</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">uri</span><span class="hs-special">{</span><span> </span><span class="hs-identifier">U.uriAuthority</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">f</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">fmap</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">U.uriAuthority</span><span> </span><span class="hs-identifier">uri</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-299"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-300"></a><span>     </span><span class="hs-identifier">f</span><span> </span><span class="hs-identifier">a</span><span class="hs-glyph">@</span><span class="hs-identifier">U.URIAuth</span><span class="hs-special">{</span><span class="hs-identifier">U.uriUserInfo</span><span class="hs-glyph">=</span><span class="hs-identifier">s</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">a</span><span class="hs-special">{</span><span class="hs-identifier">U.uriUserInfo</span><span class="hs-glyph">=</span><span class="hs-identifier">dropWhileTail</span><span> </span><span class="hs-special">(</span><span class="hs-operator">==</span><span class="hs-char">'@'</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">s</span><span class="hs-special">}</span><span>
</span><a name="line-301"></a><span>
</span><a name="line-302"></a><span class="hs-identifier">defaultHTTPport</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">ProxyProtocol</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Int</span><span>
</span><a name="line-303"></a><span class="hs-identifier">defaultHTTPport</span><span> </span><span class="hs-identifier">HTTPProxy</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">80</span><span>
</span><a name="line-304"></a><span class="hs-identifier">defaultHTTPport</span><span> </span><span class="hs-identifier">HTTPSProxy</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">443</span><span>
</span><a name="line-305"></a><span>
</span><a name="line-306"></a><span class="hs-identifier">uri2proxy</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">ProxyProtocol</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">U.URI</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Maybe</span><span> </span><span class="hs-identifier">ProxySettings</span><span>
</span><a name="line-307"></a><span class="hs-identifier">uri2proxy</span><span> </span><span class="hs-identifier">proto</span><span> </span><span class="hs-identifier">uri</span><span class="hs-glyph">@</span><span class="hs-identifier">U.URI</span><span class="hs-special">{</span><span> </span><span class="hs-identifier">U.uriAuthority</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">U.URIAuth</span><span> </span><span class="hs-identifier">auth'</span><span> </span><span class="hs-identifier">hst</span><span> </span><span class="hs-identifier">prt</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-308"></a><span>    </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">show</span><span> </span><span class="hs-identifier">proto</span><span> </span><span class="hs-operator">++</span><span> </span><span class="hs-string">&quot;:&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">U.uriScheme</span><span> </span><span class="hs-identifier">uri</span><span> </span><span class="hs-keyword">then</span><span>
</span><a name="line-309"></a><span>        </span><span class="hs-identifier">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ProxySettings</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Proxy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">S8.pack</span><span> </span><span class="hs-identifier">hst</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">port</span><span> </span><span class="hs-identifier">prt</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">auth</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier">Nothing</span><span>
</span><a name="line-310"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-311"></a><span>     </span><span class="hs-identifier">port</span><span> </span><span class="hs-special">(</span><span class="hs-char">':'</span><span class="hs-glyph">:</span><span class="hs-identifier">xs</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">readDef</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">defaultHTTPport</span><span> </span><span class="hs-identifier">proto</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">xs</span><span>
</span><a name="line-312"></a><span>     </span><span class="hs-identifier">port</span><span> </span><span class="hs-identifier">_</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">defaultHTTPport</span><span> </span><span class="hs-identifier">proto</span><span class="hs-special">)</span><span>
</span><a name="line-313"></a><span>
</span><a name="line-314"></a><span>     </span><span class="hs-identifier">auth</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-315"></a><span>       </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">auth'</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-316"></a><span>         </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Nothing</span><span>
</span><a name="line-317"></a><span>         </span><span class="hs-keyword">as</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Just</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier">S8.pack</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">U.unEscapeString</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">usr</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">S8.pack</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">U.unEscapeString</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">pwd</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-318"></a><span>          </span><span class="hs-keyword">where</span><span>
</span><a name="line-319"></a><span>           </span><span class="hs-special">(</span><span class="hs-identifier">usr</span><span class="hs-special">,</span><span class="hs-identifier">pwd</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">chopAtDelim</span><span> </span><span class="hs-char">':'</span><span> </span><span class="hs-keyword">as</span><span>
</span><a name="line-320"></a><span>
</span><a name="line-321"></a><span class="hs-identifier">uri2proxy</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">Nothing</span><span>
</span><a name="line-322"></a><span>
</span><a name="line-323"></a><span class="hs-identifier">regQueryValueDWORD</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">HKEY</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Maybe</span><span> </span><span class="hs-identifier">DWORD</span><span class="hs-special">)</span><span>
</span><a name="line-324"></a><span class="hs-identifier">regQueryValueDWORD</span><span> </span><span class="hs-identifier">hkey</span><span> </span><span class="hs-identifier">name</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">alloca</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">ptr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-325"></a><span>  </span><span class="hs-identifier">key</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">regQueryValueEx</span><span> </span><span class="hs-identifier">hkey</span><span> </span><span class="hs-identifier">name</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">castPtr</span><span> </span><span class="hs-identifier">ptr</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">sizeOf</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">undefined</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">DWORD</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-326"></a><span>  </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">key</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">rEG_DWORD</span><span> </span><span class="hs-keyword">then</span><span>
</span><a name="line-327"></a><span>      </span><span class="hs-identifier">Just</span><span> </span><span class="hs-operator">A.&lt;$&gt;</span><span> </span><span class="hs-identifier">peek</span><span> </span><span class="hs-identifier">ptr</span><span>
</span><a name="line-328"></a><span>  </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier">return</span><span> </span><span class="hs-identifier">Nothing</span><span>
</span><a name="line-329"></a><span>
</span><a name="line-330"></a><span class="hs-comment">-- defined(mingw32_HOST_OS)</span><span>
</span><a name="line-331"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-333"></a><span class="hs-identifier">envName</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.HTTP.Proxy.html#ProxyProtocol"><span class="hs-identifier hs-type">ProxyProtocol</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.HTTP.Proxy.html#EnvName"><span class="hs-identifier hs-type">EnvName</span></a><span>
</span><a name="line-334"></a><a name="envName"><a href="Network.HTTP.Proxy.html#envName"><span class="hs-identifier">envName</span></a></a><span> </span><a name="local-6989586621679108438"><a href="#local-6989586621679108438"><span class="hs-identifier">proto</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">T.pack</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679108438"><span class="hs-identifier hs-var">proto</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;_proxy&quot;</span><span>
</span><a name="line-335"></a><span>
</span><a name="line-336"></a><span class="hs-comment">-- Extract proxy settings from environment variables. This is a standard way in Linux.</span><span>
</span><a name="line-337"></a><span class="hs-identifier">envHelper</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.HTTP.Proxy.html#EnvName"><span class="hs-identifier hs-type">EnvName</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="Network.HTTP.Proxy.html#HostAddress"><span class="hs-identifier hs-type">HostAddress</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Network.HTTP.Proxy.html#ProxySettings"><span class="hs-identifier hs-type">ProxySettings</span></a><span class="hs-special">)</span><span>
</span><a name="line-338"></a><a name="envHelper"><a href="Network.HTTP.Proxy.html#envHelper"><span class="hs-identifier">envHelper</span></a></a><span> </span><a name="local-6989586621679108439"><a href="#local-6989586621679108439"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-339"></a><span>  </span><a name="local-6989586621679108447"><a href="#local-6989586621679108447"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getEnvironment</span><span>
</span><a name="line-340"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679108448"><a href="#local-6989586621679108448"><span class="hs-identifier">lenv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.fromList</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">first</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">T.toLower</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">T.pack</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679108447"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-341"></a><span>      </span><a name="local-6989586621679108449"><a href="#local-6989586621679108449"><span class="hs-identifier">lookupEnvVar</span></a></a><span> </span><a name="local-6989586621679108451"><a href="#local-6989586621679108451"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lookup</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">T.unpack</span><span> </span><a href="#local-6989586621679108451"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679108447"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-operator hs-var">A.&lt;|&gt;</span><span> </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><a href="#local-6989586621679108451"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621679108448"><span class="hs-identifier hs-var">lenv</span></a><span>
</span><a name="line-342"></a><span>      </span><a name="local-6989586621679108450"><a href="#local-6989586621679108450"><span class="hs-identifier">noProxyDomains</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679108441"><span class="hs-identifier hs-var">domainSuffixes</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679108449"><span class="hs-identifier hs-var">lookupEnvVar</span></a><span> </span><span class="hs-string">&quot;no_proxy&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-343"></a><span>
</span><a name="line-344"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679108449"><span class="hs-identifier hs-var">lookupEnvVar</span></a><span> </span><a href="#local-6989586621679108439"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-345"></a><span>      </span><span class="hs-identifier hs-var">Nothing</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-346"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-string">&quot;&quot;</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-347"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679108452"><a href="#local-6989586621679108452"><span class="hs-identifier">str</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-348"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679108453"><a href="#local-6989586621679108453"><span class="hs-identifier">invalid</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.HTTP.Client.Types.html#throwHttp"><span class="hs-identifier hs-var">throwHttp</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Network.HTTP.Client.Types.html#InvalidProxyEnvironmentVariable"><span class="hs-identifier hs-var">InvalidProxyEnvironmentVariable</span></a><span> </span><a href="#local-6989586621679108439"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">T.pack</span><span> </span><a href="#local-6989586621679108452"><span class="hs-identifier hs-var">str</span></a><span class="hs-special">)</span><span>
</span><a name="line-349"></a><span>          </span><span class="hs-special">(</span><a name="local-6989586621679108462"><a href="#local-6989586621679108462"><span class="hs-identifier">p</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679108463"><a href="#local-6989586621679108463"><span class="hs-identifier">muserpass</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">maybe</span><span> </span><a href="#local-6989586621679108453"><span class="hs-identifier hs-var">invalid</span></a><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-350"></a><span>              </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679108454"><a href="#local-6989586621679108454"><span class="hs-identifier">allowedScheme</span></a></a><span> </span><a name="local-6989586621679108455"><a href="#local-6989586621679108455"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679108455"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-string">&quot;http:&quot;</span><span>
</span><a name="line-351"></a><span>              </span><a name="local-6989586621679108457"><a href="#local-6989586621679108457"><span class="hs-identifier">uri</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">U.parseURI</span><span> </span><a href="#local-6989586621679108452"><span class="hs-identifier hs-var">str</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-352"></a><span>                  </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679108456"><a href="#local-6989586621679108456"><span class="hs-identifier">u</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679108454"><span class="hs-identifier hs-var">allowedScheme</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">U.uriScheme</span><span> </span><a href="#local-6989586621679108456"><span class="hs-identifier hs-var">u</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679108456"><span class="hs-identifier hs-var">u</span></a><span>
</span><a name="line-353"></a><span>                  </span><span class="hs-identifier">_</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">U.parseURI</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;http://&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679108452"><span class="hs-identifier hs-var">str</span></a><span>
</span><a name="line-354"></a><span>
</span><a name="line-355"></a><span>              </span><span class="hs-identifier hs-var">guard</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679108454"><span class="hs-identifier hs-var">allowedScheme</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">U.uriScheme</span><span> </span><a href="#local-6989586621679108457"><span class="hs-identifier hs-var">uri</span></a><span>
</span><a name="line-356"></a><span>              </span><span class="hs-identifier hs-var">guard</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">U.uriPath</span><span> </span><a href="#local-6989586621679108457"><span class="hs-identifier hs-var">uri</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier">U.uriPath</span><span> </span><a href="#local-6989586621679108457"><span class="hs-identifier hs-var">uri</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-string">&quot;/&quot;</span><span>
</span><a name="line-357"></a><span>              </span><span class="hs-identifier hs-var">guard</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">U.uriQuery</span><span> </span><a href="#local-6989586621679108457"><span class="hs-identifier hs-var">uri</span></a><span>
</span><a name="line-358"></a><span>              </span><span class="hs-identifier hs-var">guard</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">U.uriFragment</span><span> </span><a href="#local-6989586621679108457"><span class="hs-identifier hs-var">uri</span></a><span>
</span><a name="line-359"></a><span>
</span><a name="line-360"></a><span>              </span><a name="local-6989586621679108458"><a href="#local-6989586621679108458"><span class="hs-identifier">auth</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">U.uriAuthority</span><span> </span><a href="#local-6989586621679108457"><span class="hs-identifier hs-var">uri</span></a><span>
</span><a name="line-361"></a><span>              </span><a name="local-6989586621679108461"><a href="#local-6989586621679108461"><span class="hs-identifier">port'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-362"></a><span>                  </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">U.uriPort</span><span> </span><a href="#local-6989586621679108458"><span class="hs-identifier hs-var">auth</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-363"></a><span>                      </span><span class="hs-string">&quot;&quot;</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-number">80</span><span>
</span><a name="line-364"></a><span>                      </span><span class="hs-char">':'</span><span class="hs-glyph">:</span><a name="local-6989586621679108459"><a href="#local-6989586621679108459"><span class="hs-identifier">rest</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-365"></a><span>                          </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">decimal</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">T.pack</span><span> </span><a href="#local-6989586621679108459"><span class="hs-identifier hs-var">rest</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-366"></a><span>                              </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679108460"><a href="#local-6989586621679108460"><span class="hs-identifier">p</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679108460"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-367"></a><span>                              </span><span class="hs-identifier">_</span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-368"></a><span>                      </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-369"></a><span>
</span><a name="line-370"></a><span>              </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="Network.HTTP.Client.Types.html#Proxy"><span class="hs-identifier hs-var">Proxy</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">S8.pack</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">U.uriRegName</span><span> </span><a href="#local-6989586621679108458"><span class="hs-identifier hs-var">auth</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679108461"><span class="hs-identifier hs-var">port'</span></a><span class="hs-special">,</span><span> </span><a href="Network.HTTP.Client.Request.html#extractBasicAuthInfo"><span class="hs-identifier hs-var">extractBasicAuthInfo</span></a><span> </span><a href="#local-6989586621679108457"><span class="hs-identifier hs-var">uri</span></a><span class="hs-special">)</span><span>
</span><a name="line-371"></a><span>          </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679108464"><a href="#local-6989586621679108464"><span class="hs-identifier">hostRequest</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-372"></a><span>              </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679108464"><span class="hs-identifier hs-var">hostRequest</span></a><span> </span><span class="hs-special">`</span><a href="#local-6989586621679108442"><span class="hs-identifier hs-var">hasDomainSuffixIn</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679108450"><span class="hs-identifier hs-var">noProxyDomains</span></a><span>
</span><a name="line-373"></a><span>              </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-374"></a><span>              </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Network.HTTP.Proxy.html#ProxySettings"><span class="hs-identifier hs-var">ProxySettings</span></a><span> </span><a href="#local-6989586621679108462"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621679108463"><span class="hs-identifier hs-var">muserpass</span></a><span>
</span><a name="line-375"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621679108440"><a href="#local-6989586621679108440"><span class="hs-identifier">prefixed</span></a></a><span> </span><a name="local-6989586621679108443"><a href="#local-6989586621679108443"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">S8.head</span><span> </span><a href="#local-6989586621679108443"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-char">'.'</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679108443"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-376"></a><span>                   </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">S8.cons</span><span> </span><span class="hs-char">'.'</span><span> </span><a href="#local-6989586621679108443"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-377"></a><span>        </span><a name="local-6989586621679108441"><a href="#local-6989586621679108441"><span class="hs-identifier">domainSuffixes</span></a></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-378"></a><span>        </span><span class="hs-identifier">domainSuffixes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-string">&quot;&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-379"></a><span>        </span><span class="hs-identifier">domainSuffixes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679108444"><a href="#local-6989586621679108444"><span class="hs-identifier">no_proxy</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679108440"><span class="hs-identifier hs-var">prefixed</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">S8.dropWhile</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-char">' '</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679108445"><span class="hs-identifier hs-var">suffix</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621679108445"><a href="#local-6989586621679108445"><span class="hs-identifier">suffix</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">S8.split</span><span> </span><span class="hs-char">','</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">S8.pack</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">toLower</span><span> </span><a href="#local-6989586621679108444"><span class="hs-identifier hs-var">no_proxy</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">S8.null</span><span> </span><a href="#local-6989586621679108445"><span class="hs-identifier hs-var">suffix</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-380"></a><span>        </span><a name="local-6989586621679108442"><a href="#local-6989586621679108442"><span class="hs-identifier">hasDomainSuffixIn</span></a></a><span> </span><a name="local-6989586621679108446"><a href="#local-6989586621679108446"><span class="hs-identifier">host'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier hs-var">S8.isSuffixOf</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679108440"><span class="hs-identifier hs-var">prefixed</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">S8.map</span><span> </span><span class="hs-identifier hs-var">toLower</span><span> </span><a href="#local-6989586621679108446"><span class="hs-identifier hs-var">host'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-381"></a></pre></body></html>