<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP, DeriveDataTypeable, NoImplicitPrelude #-}</span><span>
</span><a name="line-2"></a><span>
</span><a name="line-3"></a><span class="hs-cpp">#if __GLASGOW_HASKELL__ &gt;= 704
</span><span class="hs-pragma">{-# LANGUAGE Safe #-}</span><span>
</span><a name="line-5"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-7"></a><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><a name="line-8"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-9"></a><span class="hs-comment">-- Module     : Control.Concurrent.Timeout</span><span>
</span><a name="line-10"></a><span class="hs-comment">-- Copyright  : 2011 Bas van Dijk &amp; Roel van Dijk</span><span>
</span><a name="line-11"></a><span class="hs-comment">-- License    : BSD3 (see the file LICENSE)</span><span>
</span><a name="line-12"></a><span class="hs-comment">-- Maintainer : Bas van Dijk &lt;v.dijk.bas@gmail.com&gt;</span><span>
</span><a name="line-13"></a><span class="hs-comment">--            , Roel van Dijk &lt;vandijk.roel@gmail.com&gt;</span><span>
</span><a name="line-14"></a><span class="hs-comment">--</span><span>
</span><a name="line-15"></a><span class="hs-comment">-- Wait arbitrarily long for an IO computation to finish.</span><span>
</span><a name="line-16"></a><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><a name="line-17"></a><span>
</span><a name="line-18"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Control.Concurrent.Timeout</span><span> </span><span class="hs-special">(</span><span> </span><a href="Control.Concurrent.Timeout.html#timeout"><span class="hs-identifier hs-var">timeout</span></a><span class="hs-special">,</span><span> </span><a href="Control.Concurrent.Timeout.html#Timeout"><span class="hs-identifier hs-type">Timeout</span></a><span class="hs-special">,</span><span> </span><a href="Control.Concurrent.Timeout.html#timeoutWithPred"><span class="hs-identifier hs-var">timeoutWithPred</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-19"></a><span>
</span><a name="line-20"></a><span>
</span><a name="line-21"></a><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><a name="line-22"></a><span class="hs-comment">-- Imports</span><span>
</span><a name="line-23"></a><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><a name="line-24"></a><span>
</span><a name="line-25"></a><span class="hs-comment">-- from base:</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Concurrent</span><span>       </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">forkIOWithUnmask</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">myThreadId</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">throwTo</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">killThread</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Exception</span><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Exception</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">bracket</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">handleJust</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>            </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">return</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">&gt;&gt;</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Bool</span><span>                </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Eq</span><span>                  </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">==</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Function</span><span>            </span><span class="hs-special">(</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">.</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">const</span><span class="hs-special">)</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Maybe</span><span>               </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span class="hs-special">(</span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Ord</span><span>                 </span><span class="hs-special">(</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">&lt;</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Typeable</span><span>            </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Typeable</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Unique</span><span>              </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Unique</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">newUnique</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Prelude</span><span>                  </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Integer</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.IO</span><span>                </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Text.Show</span><span>                </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-39"></a><span>
</span><a name="line-40"></a><span class="hs-cpp">#if __GLASGOW_HASKELL__ &lt; 700
</span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Prelude</span><span>                  </span><span class="hs-special">(</span><span> </span><span class="hs-identifier">fromInteger</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>            </span><span class="hs-special">(</span><span> </span><span class="hs-special">(</span><span class="hs-operator">&gt;&gt;=</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fail</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-43"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-45"></a><span class="hs-cpp">#ifdef __HADDOCK_VERSION__
</span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Int</span><span>                 </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.IO</span><span>                </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">hGetBuf</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">hPutBuf</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">hWaitForInput</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">System.Timeout</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">timeout</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-49"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-51"></a><span class="hs-comment">-- from unbounded-delays (this package):</span><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span> </span><a href="Control.Concurrent.Thread.Delay.html"><span class="hs-identifier">Control.Concurrent.Thread.Delay</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="Control.Concurrent.Thread.Delay.html#delay"><span class="hs-identifier hs-var">delay</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-53"></a><span>
</span><a name="line-54"></a><span>
</span><a name="line-55"></a><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><a name="line-56"></a><span class="hs-comment">-- Long delays and timeouts</span><span>
</span><a name="line-57"></a><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><a name="line-58"></a><span>
</span><a name="line-59"></a><span class="hs-comment">{-
The following code was mostly copied from the module System.Timeout in the
package base-4.2.0.0.

(c) The University of Glasgow 2007
-}</span><span>
</span><a name="line-65"></a><span>
</span><a name="line-66"></a><span class="hs-keyword">newtype</span><span> </span><a name="Timeout"><a href="Control.Concurrent.Timeout.html#Timeout"><span class="hs-identifier">Timeout</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Timeout"><a href="Control.Concurrent.Timeout.html#Timeout"><span class="hs-identifier">Timeout</span></a></a><span> </span><span class="hs-identifier hs-type">Unique</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Typeable</span><span class="hs-special">)</span><span>
</span><a name="line-67"></a><span>
</span><a name="line-68"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Show</span><span> </span><a href="Control.Concurrent.Timeout.html#Timeout"><span class="hs-identifier hs-type">Timeout</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-69"></a><span>    </span><a name="local-8214565720323790232"><span class="hs-identifier">show</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;&lt;&lt;timeout&gt;&gt;&quot;</span><span>
</span><a name="line-70"></a><span>
</span><a name="line-71"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Exception</span><span> </span><a href="Control.Concurrent.Timeout.html#Timeout"><span class="hs-identifier hs-type">Timeout</span></a><span>
</span><a name="line-72"></a><span>
</span><a name="line-73"></a><span class="hs-comment">{-|
Like @System.Timeout.'System.Timeout.timeout'@, but not bounded by an 'Int'.
(..)
Wrap an 'IO' computation to time out and return 'Nothing' in case no result is
available within @n@ microseconds (@1\/10^6@ seconds). In case a result is
available before the timeout expires, 'Just' @a@ is returned. A negative timeout
interval means \&quot;wait indefinitely\&quot;.

If the computation has not terminated after @n@ microseconds, it is interrupted
by an asynchronous exception. The function passed to @f@ can be used to detect
whether it was interrupted by this timeout or some other exception.

The design of this combinator was guided by the objective that @timeout n (const f)@
should behave exactly the same as @f@ as long as @f@ doesn't time out. This
means that @f@ has the same 'myThreadId' it would have without the timeout
wrapper. Any exceptions @f@ might throw cancel the timeout and propagate further
up. It also possible for @f@ to receive exceptions thrown to it by another
thread.

A tricky implementation detail is the question of how to abort an 'IO'
computation. This combinator relies on asynchronous exceptions internally.  The
technique works very well for computations executing inside of the Haskell
runtime system, but it doesn't work at all for non-Haskell code. Foreign
function calls, for example, cannot be timed out with this combinator simply
because an arbitrary C function cannot receive asynchronous exceptions. When
@timeout@ is used to wrap an FFI call that blocks, no timeout event can be
delivered until the FFI call returns, which pretty much negates the purpose of
the combinator. In practice, however, this limitation is less severe than it may
sound. Standard I\/O functions like 'System.IO.hGetBuf', 'System.IO.hPutBuf',
Network.Socket.accept, or 'System.IO.hWaitForInput' appear to be blocking, but
they really don't because the runtime system uses scheduling mechanisms like
@select(2)@ to perform asynchronous I\/O, so it is possible to interrupt
standard socket I\/O or file I\/O using this combinator.
-}</span><span>
</span><a name="line-107"></a><span class="hs-identifier">timeoutWithPred</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Integer</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="Control.Concurrent.Timeout.html#Timeout"><span class="hs-identifier hs-type">Timeout</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679028164"><span class="hs-identifier hs-type">&#945;</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621679028164"><span class="hs-identifier hs-type">&#945;</span></a><span class="hs-special">)</span><span>
</span><a name="line-108"></a><a name="timeoutWithPred"><a href="Control.Concurrent.Timeout.html#timeoutWithPred"><span class="hs-identifier">timeoutWithPred</span></a></a><span> </span><a name="local-6989586621679028165"><a href="#local-6989586621679028165"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679028166"><a href="#local-6989586621679028166"><span class="hs-identifier">f</span></a></a><span>
</span><a name="line-109"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679028165"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-number">0</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679028166"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-110"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679028165"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-111"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-112"></a><span>        </span><a name="local-6989586621679028659"><a href="#local-6989586621679028659"><span class="hs-identifier">pid</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">myThreadId</span><span>
</span><a name="line-113"></a><span>        </span><a name="local-6989586621679028660"><a href="#local-6989586621679028660"><span class="hs-identifier">ex</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><a href="Control.Concurrent.Timeout.html#Timeout"><span class="hs-identifier hs-var">Timeout</span></a><span> </span><span class="hs-identifier hs-var">newUnique</span><span>
</span><a name="line-114"></a><span>        </span><span class="hs-identifier hs-var">handleJust</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679028983"><a href="#local-6989586621679028983"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679028983"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621679028660"><span class="hs-identifier hs-var">ex</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span>
</span><a name="line-115"></a><span>                   </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span>
</span><a name="line-116"></a><span>                   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">bracket</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">forkIOWithUnmask</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679028984"><a href="#local-6989586621679028984"><span class="hs-identifier">unmask</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679028984"><span class="hs-identifier hs-var">unmask</span></a><span> </span><span class="hs-special">(</span><a href="Control.Concurrent.Thread.Delay.html#delay"><span class="hs-identifier hs-var">delay</span></a><span> </span><a href="#local-6989586621679028165"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><span class="hs-identifier hs-var">throwTo</span><span> </span><a href="#local-6989586621679028659"><span class="hs-identifier hs-var">pid</span></a><span> </span><a href="#local-6989586621679028660"><span class="hs-identifier hs-var">ex</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-117"></a><span>                            </span><span class="hs-special">(</span><span class="hs-identifier hs-var">killThread</span><span class="hs-special">)</span><span>
</span><a name="line-118"></a><span>                            </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679028166"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">==</span><a href="#local-6989586621679028660"><span class="hs-identifier hs-var">ex</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-119"></a><span>                   </span><span class="hs-special">)</span><span>
</span><a name="line-120"></a><span>
</span><a name="line-121"></a><span class="hs-comment">{-|
Like 'timeoutWithPred', but does not expose the 'Timeout' exception to the called action.
-}</span><span>
</span><a name="line-124"></a><span class="hs-identifier">timeout</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Integer</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679028112"><span class="hs-identifier hs-type">&#945;</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621679028112"><span class="hs-identifier hs-type">&#945;</span></a><span class="hs-special">)</span><span>
</span><a name="line-125"></a><a name="timeout"><a href="Control.Concurrent.Timeout.html#timeout"><span class="hs-identifier">timeout</span></a></a><span> </span><a name="local-6989586621679028985"><a href="#local-6989586621679028985"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Control.Concurrent.Timeout.html#timeoutWithPred"><span class="hs-identifier hs-var">timeoutWithPred</span></a><span> </span><a href="#local-6989586621679028985"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">const</span><span>
</span><a name="line-126"></a></pre></body></html>