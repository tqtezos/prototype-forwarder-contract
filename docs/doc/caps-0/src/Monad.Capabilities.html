<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE TypeInType, GADTs, ScopedTypeVariables, FlexibleInstances,
             TypeOperators, ConstraintKinds, TypeFamilies, PartialTypeSignatures,
             UndecidableInstances, ViewPatterns, RankNTypes, TypeApplications,
             MultiParamTypeClasses, UndecidableSuperClasses, TemplateHaskell,
             StandaloneDeriving, DerivingStrategies, GeneralizedNewtypeDeriving #-}</span><span>
</span><a name="line-6"></a><span>
</span><a name="line-7"></a><span class="hs-comment">{-|

Monadic capabilities are additional methods for a base monad. For instance, when
our base monad is 'IO', our capabilities might include logging, networking,
database access, and so on.

This framework allows mutually recursive late-bound capabilities with runtime
dispatch and a type-safe interface.

A capability is defined as a record type with methods parametrized over a base
monad:

@
data Logging m =
  Logging
    { _logError :: String -&gt; m (),
      _logDebug :: String -&gt; m ()
    }
@

We can define implementations as values of this record type:

@
loggingDummy :: Monad m =&gt; CapImpl Logging '[] m
loggingDummy = CapImpl $ Logging (\\_ -&gt; return ()) (\\_ -&gt; return ())

loggingIO :: MonadIO m =&gt; CapImpl Logging '[] m
loggingIO = CapImpl $
  Logging
    { _logError = \\msg -&gt; liftIO . putStrLn $ &quot;[Error] &quot; ++ msg
      _logDebug = \\msg -&gt; liftIO . putStrLn $ &quot;[Debug] &quot; ++ msg
    }
@

The dictionary is wrapped in 'CapImpl' to guarantee that it is sufficiently
polymorphic (this is required to support simultaneous use of monadic actions in
negative position and capability extension).

Then we want to use this capability in the 'CapsT' monad (which is nothing more
but a synonym for 'ReaderT' of 'Capabilities'), and for this we define a helper
per method:

@
logError :: HasCap Logging caps =&gt; String -&gt; CapsT caps m ()
logError message = withCap $ \\cap -&gt; _logError cap message

logDebug :: HasCap Logging caps =&gt; String -&gt; CapsT caps m ()
logDebug message = withCap $ \\cap -&gt; _logDebug cap message
@

We can define other capabilities in a similar manner:

@
data Networking m =
  Networking
    { _sendRequest :: ByteString -&gt; m ByteString }

data FileStorage m =
  FileStorage
    { _readFile :: FilePath -&gt; m ByteString,
      _writeFile :: FilePath -&gt; ByteString -&gt; m ()
    }
@

Implementations of capabilities may depend on other capabilities, which are
listed in their signature. For instance, this is how we can define the
'FileStorage' capability using the 'Logging' capability:

@
fileStorageIO :: MonadIO m =&gt; CapImpl FileStorage '[Logging] m
fileStorageIO = CapImpl $
  FileStorage
    { _readFile = \\path -&gt; do
        logDebug $ &quot;readFile &quot; ++ path
        lift $ ByteString.readFile path
      _writeFile = \\path content -&gt; do
        logDebug $
          &quot;writeFile &quot; ++ path ++
          &quot; (&quot; ++ show (ByteString.length content) ++
          &quot; bytes)&quot;
        lift $ ByteString.writeFile path content
    }
@

Here the @fileStorageIO@ implementation requires a logging capability,
but it's not specified which one.

When we decided what set of capabilities our application needs, we can put them
together in a 'Capabilities' map and run the application with this map in a
'ReaderT' context:

@
caps = buildCaps $
  AddCap loggingIO $
  AddCap fileStorageIO $
  BaseCaps emptyCaps

flip runReaderT caps $ do
  config &lt;- readFile &quot;config.yaml&quot;
  ...
@

Capabilities passed to 'buildCaps' can depend on each other. The order does not
matter (although it is reflected in the types), and duplicate capabilities are
disallowed.

We can override a capability locally:

@
do
  config &lt;- readFile &quot;config.yaml&quot;
  withReaderT (overrideCap loggingDummy) $ do
    -- logging is disabled here
    writeFile &quot;config-backup.yaml&quot; config
    ...
@

or we can add more capabilities:

@
do
  config &lt;- readFile &quot;config.yaml&quot;
  networkingImpl &lt;- parseNetworkingConfig config
  withReaderT (addCap networkingImpl) $ do
    -- networking capability added
    resp &lt;- sendRequest req
    ...
@

-}</span><span>
</span><a name="line-137"></a><span>
</span><a name="line-138"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Monad.Capabilities</span><span>
</span><a name="line-139"></a><span>  </span><span class="hs-special">(</span><span>
</span><a name="line-140"></a><span>    </span><span class="hs-comment">-- * Capabilities</span><span>
</span><a name="line-141"></a><span>    </span><a href="Monad.Capabilities.html#Capabilities"><span class="hs-identifier hs-type">Capabilities</span></a><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-142"></a><span>    </span><a href="Monad.Capabilities.html#CapsT"><span class="hs-identifier hs-type">CapsT</span></a><span class="hs-special">,</span><span>
</span><a name="line-143"></a><span>    </span><a href="Monad.Capabilities.html#emptyCaps"><span class="hs-identifier hs-var">emptyCaps</span></a><span class="hs-special">,</span><span>
</span><a name="line-144"></a><span>    </span><a href="Monad.Capabilities.html#buildCaps"><span class="hs-identifier hs-var">buildCaps</span></a><span class="hs-special">,</span><span>
</span><a name="line-145"></a><span>    </span><a href="Monad.Capabilities.html#CapabilitiesBuilder"><span class="hs-identifier hs-type">CapabilitiesBuilder</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-146"></a><span>    </span><a href="Monad.Capabilities.html#CapImpl"><span class="hs-identifier hs-type">CapImpl</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-147"></a><span>    </span><a href="Monad.Capabilities.html#getCap"><span class="hs-identifier hs-var">getCap</span></a><span class="hs-special">,</span><span>
</span><a name="line-148"></a><span>    </span><a href="Monad.Capabilities.html#overrideCap"><span class="hs-identifier hs-var">overrideCap</span></a><span class="hs-special">,</span><span>
</span><a name="line-149"></a><span>    </span><a href="Monad.Capabilities.html#addCap"><span class="hs-identifier hs-var">addCap</span></a><span class="hs-special">,</span><span>
</span><a name="line-150"></a><span>    </span><a href="Monad.Capabilities.html#insertCap"><span class="hs-identifier hs-var">insertCap</span></a><span class="hs-special">,</span><span>
</span><a name="line-151"></a><span>    </span><a href="Monad.Capabilities.html#withCap"><span class="hs-identifier hs-var">withCap</span></a><span class="hs-special">,</span><span>
</span><a name="line-152"></a><span>    </span><a href="Monad.Capabilities.html#checkCap"><span class="hs-identifier hs-var">checkCap</span></a><span class="hs-special">,</span><span>
</span><a name="line-153"></a><span>    </span><a href="Monad.Capabilities.html#adjustCap"><span class="hs-identifier hs-var">adjustCap</span></a><span class="hs-special">,</span><span>
</span><a name="line-154"></a><span>
</span><a name="line-155"></a><span>    </span><span class="hs-comment">-- * Default capabilities</span><span>
</span><a name="line-156"></a><span>    </span><a href="Monad.Capabilities.html#Context"><span class="hs-identifier hs-type">Context</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-157"></a><span>    </span><a href="Monad.Capabilities.html#HasContext"><span class="hs-identifier hs-type">HasContext</span></a><span class="hs-special">,</span><span>
</span><a name="line-158"></a><span>    </span><a href="Monad.Capabilities.html#newContext"><span class="hs-identifier hs-var">newContext</span></a><span class="hs-special">,</span><span>
</span><a name="line-159"></a><span>    </span><a href="Monad.Capabilities.html#askContext"><span class="hs-identifier hs-var">askContext</span></a><span class="hs-special">,</span><span>
</span><a name="line-160"></a><span>    </span><a href="Monad.Capabilities.html#localContext"><span class="hs-identifier hs-var">localContext</span></a><span class="hs-special">,</span><span>
</span><a name="line-161"></a><span>
</span><a name="line-162"></a><span>    </span><span class="hs-comment">-- * Type-level checks</span><span>
</span><a name="line-163"></a><span>    </span><span class="hs-keyword">type</span><span> </span><a href="Monad.Capabilities.html#HasCap"><span class="hs-identifier hs-type">HasCap</span></a><span class="hs-special">,</span><span>
</span><a name="line-164"></a><span>    </span><span class="hs-keyword">type</span><span> </span><a href="Monad.Capabilities.html#HasCaps"><span class="hs-identifier hs-type">HasCaps</span></a><span class="hs-special">,</span><span>
</span><a name="line-165"></a><span>    </span><span class="hs-keyword">type</span><span> </span><a href="Monad.Capabilities.html#HasNoCap"><span class="hs-identifier hs-type">HasNoCap</span></a><span class="hs-special">,</span><span>
</span><a name="line-166"></a><span>    </span><a href="Monad.Capabilities.html#HasCapDecision"><span class="hs-identifier hs-type">HasCapDecision</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-167"></a><span>
</span><a name="line-168"></a><span>    </span><span class="hs-comment">-- * Utils</span><span>
</span><a name="line-169"></a><span>    </span><a href="Monad.Capabilities.html#makeCap"><span class="hs-identifier hs-var">makeCap</span></a><span>
</span><a name="line-170"></a><span>
</span><a name="line-171"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-172"></a><span>
</span><a name="line-173"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.Trans.Reader</span><span>
</span><a name="line-174"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Kind</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Constraint</span><span class="hs-special">)</span><span>
</span><a name="line-175"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Traversable</span><span>
</span><a name="line-176"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Proxy</span><span>
</span><a name="line-177"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Type.Equality</span><span>
</span><a name="line-178"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.List</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">foldl1'</span><span class="hs-special">)</span><span>
</span><a name="line-179"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHC.TypeLits</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TypeError</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">ErrorMessage</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-180"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Type.Reflection</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Typeable</span><span class="hs-special">)</span><span>
</span><a name="line-181"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Unsafe.Coerce</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unsafeCoerce</span><span class="hs-special">)</span><span>
</span><a name="line-182"></a><span>
</span><a name="line-183"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.TypeRepMap</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">TypeRepMap</span><span>
</span><a name="line-184"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.TypeRepMap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TypeRepMap</span><span class="hs-special">)</span><span>
</span><a name="line-185"></a><span>
</span><a name="line-186"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Language.Haskell.TH</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">TH</span><span>
</span><a name="line-187"></a><span>
</span><a name="line-188"></a><span class="hs-keyword">type</span><span> </span><a name="MonadK"><a href="Monad.Capabilities.html#MonadK"><span class="hs-identifier">MonadK</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span>
</span><a name="line-189"></a><span>
</span><a name="line-190"></a><span class="hs-keyword">type</span><span> </span><a name="CapK"><a href="Monad.Capabilities.html#CapK"><span class="hs-identifier">CapK</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Monad.Capabilities.html#MonadK"><span class="hs-identifier hs-type">MonadK</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span>
</span><a name="line-191"></a><span>
</span><a name="line-192"></a><span class="hs-comment">-- | @'Capabilities' caps m@ is a map of capabilities @caps@ over a base monad</span><span>
</span><a name="line-193"></a><span class="hs-comment">-- @m@. Consider the following capabilities:</span><span>
</span><a name="line-194"></a><span class="hs-comment">--</span><span>
</span><a name="line-195"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-196"></a><span class="hs-comment">-- data X m = X (String -&gt; m String)</span><span>
</span><a name="line-197"></a><span class="hs-comment">-- data Y m = Y (Int -&gt; m Bool)</span><span>
</span><a name="line-198"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-199"></a><span class="hs-comment">--</span><span>
</span><a name="line-200"></a><span class="hs-comment">-- We can construct a map of capabilities with the following type:</span><span>
</span><a name="line-201"></a><span class="hs-comment">--</span><span>
</span><a name="line-202"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-203"></a><span class="hs-comment">-- capsXY :: Capabilities '[X, Y] IO</span><span>
</span><a name="line-204"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-205"></a><span class="hs-comment">--</span><span>
</span><a name="line-206"></a><span class="hs-comment">-- In this case, @capsXY@ would be a map with two elements, one at key @X@ and</span><span>
</span><a name="line-207"></a><span class="hs-comment">-- one at key @Y@. The types of capabilities themselves serve as keys.</span><span>
</span><a name="line-208"></a><span class="hs-comment">--</span><span>
</span><a name="line-209"></a><span class="hs-comment">-- 'Capabilities' is a heterogeneous collection, meaning that its values have</span><span>
</span><a name="line-210"></a><span class="hs-comment">-- different types. The type of a value is determined by the key:</span><span>
</span><a name="line-211"></a><span class="hs-comment">--</span><span>
</span><a name="line-212"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-213"></a><span class="hs-comment">--</span><span>
</span><a name="line-214"></a><span class="hs-comment">--  X:   X (\\_ -&gt; return &quot;hi&quot;) :: X (CapsT '[X, Y] IO)</span><span>
</span><a name="line-215"></a><span class="hs-comment">--  Y:   Y (\\_ -&gt; return True) :: Y (CapsT '[X, Y] IO)</span><span>
</span><a name="line-216"></a><span class="hs-comment">-- ----  ---------------------    --------------------</span><span>
</span><a name="line-217"></a><span class="hs-comment">-- keys         values              types of values</span><span>
</span><a name="line-218"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-219"></a><span class="hs-comment">--</span><span>
</span><a name="line-220"></a><span class="hs-comment">-- Notice that stored dictionaries are parametrized not just by the base monad</span><span>
</span><a name="line-221"></a><span class="hs-comment">-- @IO@, but with the 'CapsT' transformer on top. This means that each</span><span>
</span><a name="line-222"></a><span class="hs-comment">-- capability has access to all other capabilities and itself.</span><span>
</span><a name="line-223"></a><span class="hs-comment">--</span><span>
</span><a name="line-224"></a><span class="hs-keyword">newtype</span><span> </span><a name="Capabilities"><a href="Monad.Capabilities.html#Capabilities"><span class="hs-identifier">Capabilities</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679043390"><a href="#local-6989586621679043390"><span class="hs-identifier">caps</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Monad.Capabilities.html#CapK"><span class="hs-identifier hs-type">CapK</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679043391"><a href="#local-6989586621679043391"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Monad.Capabilities.html#MonadK"><span class="hs-identifier hs-type">MonadK</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-225"></a><span>  </span><a name="Capabilities"><a href="Monad.Capabilities.html#Capabilities"><span class="hs-identifier">Capabilities</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TypeRepMap</span><span> </span><span class="hs-special">(</span><a href="Monad.Capabilities.html#CapElem"><span class="hs-identifier hs-type">CapElem</span></a><span> </span><a href="#local-6989586621679043391"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-226"></a><span>
</span><a name="line-227"></a><span class="hs-identifier">emptyCaps</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Monad.Capabilities.html#Capabilities"><span class="hs-identifier hs-type">Capabilities</span></a><span> </span><span class="hs-special">'</span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621679044093"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-228"></a><a name="emptyCaps"><a href="Monad.Capabilities.html#emptyCaps"><span class="hs-identifier">emptyCaps</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Monad.Capabilities.html#Capabilities"><span class="hs-identifier hs-var">Capabilities</span></a><span> </span><span class="hs-identifier hs-var">TypeRepMap.empty</span><span>
</span><a name="line-229"></a><span>
</span><a name="line-230"></a><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">newtype</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Show</span><span> </span><span class="hs-special">(</span><a href="Monad.Capabilities.html#Capabilities"><span class="hs-identifier hs-type">Capabilities</span></a><span> </span><a href="#local-6989586621679044490"><span class="hs-identifier hs-type">caps</span></a><span> </span><a href="#local-6989586621679044491"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-231"></a><span>
</span><a name="line-232"></a><span class="hs-comment">-- | The 'CapsT' transformer adds access to capabilities. This is a convenience</span><span>
</span><a name="line-233"></a><span class="hs-comment">-- synonym for 'ReaderT' of 'Capabilities', and all 'ReaderT' functions</span><span>
</span><a name="line-234"></a><span class="hs-comment">-- ('runReaderT', 'withReaderT') can be used with it.</span><span>
</span><a name="line-235"></a><span class="hs-keyword">type</span><span> </span><a name="CapsT"><a href="Monad.Capabilities.html#CapsT"><span class="hs-identifier">CapsT</span></a></a><span> </span><a name="local-6989586621679043388"><a href="#local-6989586621679043388"><span class="hs-identifier">caps</span></a></a><span> </span><a name="local-6989586621679043389"><a href="#local-6989586621679043389"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">ReaderT</span><span> </span><span class="hs-special">(</span><a href="Monad.Capabilities.html#Capabilities"><span class="hs-identifier hs-type">Capabilities</span></a><span> </span><a href="#local-6989586621679043388"><span class="hs-identifier hs-type">caps</span></a><span> </span><a href="#local-6989586621679043389"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679043389"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-236"></a><span>
</span><a name="line-237"></a><span class="hs-comment">-- | The 'CapImpl' newtype guarantees that the wrapped capability implementation</span><span>
</span><a name="line-238"></a><span class="hs-comment">-- is sufficiently polymorphic so that required subtyping properties hold in</span><span>
</span><a name="line-239"></a><span class="hs-comment">-- methods that take monadic actions as input (negative position).</span><span>
</span><a name="line-240"></a><span class="hs-comment">--</span><span>
</span><a name="line-241"></a><span class="hs-comment">-- This rules out using 'addCap', 'insertCap', and 'buildCaps' inside capability</span><span>
</span><a name="line-242"></a><span class="hs-comment">-- implementations in an unsafe manner.</span><span>
</span><a name="line-243"></a><span class="hs-keyword">data</span><span> </span><a name="CapImpl"><a href="Monad.Capabilities.html#CapImpl"><span class="hs-identifier">CapImpl</span></a></a><span> </span><a name="local-6989586621679043381"><a href="#local-6989586621679043381"><span class="hs-identifier">cap</span></a></a><span> </span><a name="local-6989586621679043382"><a href="#local-6989586621679043382"><span class="hs-identifier">icaps</span></a></a><span> </span><a name="local-6989586621679043383"><a href="#local-6989586621679043383"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-244"></a><span>  </span><a name="CapImpl"><a href="Monad.Capabilities.html#CapImpl"><span class="hs-identifier">CapImpl</span></a></a><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-245"></a><span>    </span><a href="Monad.Capabilities.html#WithSpine"><span class="hs-identifier hs-type">WithSpine</span></a><span> </span><a href="#local-6989586621679043384"><span class="hs-identifier hs-type">icaps</span></a><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><a name="line-246"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="getCapImpl"><a href="Monad.Capabilities.html#getCapImpl"><span class="hs-identifier">getCapImpl</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679043387"><a href="#local-6989586621679043387"><span class="hs-identifier">caps</span></a></a><span class="hs-operator">.</span><span> </span><a href="Monad.Capabilities.html#HasCaps"><span class="hs-identifier hs-type">HasCaps</span></a><span> </span><a href="#local-6989586621679043384"><span class="hs-identifier hs-type">icaps</span></a><span> </span><a href="#local-6989586621679043387"><span class="hs-identifier hs-type">caps</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679043385"><span class="hs-identifier hs-type">cap</span></a><span> </span><span class="hs-special">(</span><a href="Monad.Capabilities.html#CapsT"><span class="hs-identifier hs-type">CapsT</span></a><span> </span><a href="#local-6989586621679043387"><span class="hs-identifier hs-type">caps</span></a><span> </span><a href="#local-6989586621679043386"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-247"></a><span>    </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-248"></a><span>    </span><a href="Monad.Capabilities.html#CapImpl"><span class="hs-identifier hs-type">CapImpl</span></a><span> </span><a href="#local-6989586621679043385"><span class="hs-identifier hs-type">cap</span></a><span> </span><a href="#local-6989586621679043384"><span class="hs-identifier hs-type">icaps</span></a><span> </span><a href="#local-6989586621679043386"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-249"></a><span>
</span><a name="line-250"></a><span class="hs-keyword">newtype</span><span> </span><a name="CapElem"><a href="Monad.Capabilities.html#CapElem"><span class="hs-identifier">CapElem</span></a></a><span> </span><a name="local-6989586621679043378"><a href="#local-6989586621679043378"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679043379"><a href="#local-6989586621679043379"><span class="hs-identifier">cap</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-251"></a><span>  </span><a name="CapElem"><a href="Monad.Capabilities.html#CapElem"><span class="hs-identifier">CapElem</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="getCapElem"><a href="Monad.Capabilities.html#getCapElem"><span class="hs-identifier">getCapElem</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679043380"><a href="#local-6989586621679043380"><span class="hs-identifier">caps</span></a></a><span class="hs-operator">.</span><span> </span><a href="#local-6989586621679043379"><span class="hs-identifier hs-type">cap</span></a><span> </span><span class="hs-special">(</span><a href="Monad.Capabilities.html#CapsT"><span class="hs-identifier hs-type">CapsT</span></a><span> </span><a href="#local-6989586621679043380"><span class="hs-identifier hs-type">caps</span></a><span> </span><a href="#local-6989586621679043378"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-252"></a><span>
</span><a name="line-253"></a><span class="hs-identifier">overCapElem</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-254"></a><span>  </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679044092"><a href="#local-6989586621679044092"><span class="hs-identifier">caps</span></a></a><span class="hs-operator">.</span><span> </span><a href="#local-6989586621679044088"><span class="hs-identifier hs-type">cap</span></a><span> </span><span class="hs-special">(</span><a href="Monad.Capabilities.html#CapsT"><span class="hs-identifier hs-type">CapsT</span></a><span> </span><a href="#local-6989586621679044092"><span class="hs-identifier hs-type">caps</span></a><span> </span><a href="#local-6989586621679044089"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679044090"><span class="hs-identifier hs-type">cap'</span></a><span> </span><span class="hs-special">(</span><a href="Monad.Capabilities.html#CapsT"><span class="hs-identifier hs-type">CapsT</span></a><span> </span><a href="#local-6989586621679044092"><span class="hs-identifier hs-type">caps</span></a><span> </span><a href="#local-6989586621679044091"><span class="hs-identifier hs-type">m'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-255"></a><span>  </span><a href="Monad.Capabilities.html#CapElem"><span class="hs-identifier hs-type">CapElem</span></a><span> </span><a href="#local-6989586621679044089"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679044088"><span class="hs-identifier hs-type">cap</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-256"></a><span>  </span><a href="Monad.Capabilities.html#CapElem"><span class="hs-identifier hs-type">CapElem</span></a><span> </span><a href="#local-6989586621679044091"><span class="hs-identifier hs-type">m'</span></a><span> </span><a href="#local-6989586621679044090"><span class="hs-identifier hs-type">cap'</span></a><span>
</span><a name="line-257"></a><a name="overCapElem"><a href="Monad.Capabilities.html#overCapElem"><span class="hs-identifier">overCapElem</span></a></a><span> </span><a name="local-6989586621679044094"><a href="#local-6989586621679044094"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a href="Monad.Capabilities.html#CapElem"><span class="hs-identifier hs-var">CapElem</span></a><span> </span><a name="local-6989586621679044095"><a href="#local-6989586621679044095"><span class="hs-identifier">cap</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Monad.Capabilities.html#CapElem"><span class="hs-identifier hs-var">CapElem</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679044094"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679044095"><span class="hs-identifier hs-var">cap</span></a><span class="hs-special">)</span><span>
</span><a name="line-258"></a><span>
</span><a name="line-259"></a><span class="hs-comment">-- Continuation-passing encoding of a list spine:</span><span>
</span><a name="line-260"></a><span class="hs-comment">--</span><span>
</span><a name="line-261"></a><span class="hs-comment">-- data Spine xs where</span><span>
</span><a name="line-262"></a><span class="hs-comment">--   Cons :: Spine xs -&gt; Spine (x : xs)</span><span>
</span><a name="line-263"></a><span class="hs-comment">--   Nil :: Spine '[]</span><span>
</span><a name="line-264"></a><span class="hs-comment">--</span><span>
</span><a name="line-265"></a><span class="hs-keyword">class</span><span> </span><a name="WithSpine"><a href="Monad.Capabilities.html#WithSpine"><span class="hs-identifier">WithSpine</span></a></a><span> </span><a name="local-6989586621679043374"><a href="#local-6989586621679043374"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-266"></a><span>  </span><a name="onSpine"><a href="Monad.Capabilities.html#onSpine"><span class="hs-identifier">onSpine</span></a></a><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-267"></a><span>    </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679043375"><a href="#local-6989586621679043375"><span class="hs-identifier">r</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-268"></a><span>    </span><span class="hs-identifier hs-type">Proxy</span><span> </span><a href="#local-6989586621679043374"><span class="hs-identifier hs-type">xs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-269"></a><span>    </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier hs-type">xs</span><span> </span><span class="hs-glyph">~</span><span> </span><span class="hs-special">'</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679043375"><span class="hs-identifier hs-type">r</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-270"></a><span>    </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679043376"><a href="#local-6989586621679043376"><span class="hs-identifier">y</span></a></a><span> </span><a name="local-6989586621679043377"><a href="#local-6989586621679043377"><span class="hs-identifier">ys</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-271"></a><span>      </span><span class="hs-special">(</span><span class="hs-identifier hs-type">xs</span><span> </span><span class="hs-glyph">~</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">y</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679043377"><span class="hs-identifier hs-type">ys</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><a name="line-272"></a><span>      </span><a href="Monad.Capabilities.html#WithSpine"><span class="hs-identifier hs-type">WithSpine</span></a><span> </span><a href="#local-6989586621679043377"><span class="hs-identifier hs-type">ys</span></a><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><a name="line-273"></a><span>      </span><span class="hs-identifier hs-type">Proxy</span><span> </span><a href="#local-6989586621679043376"><span class="hs-identifier hs-type">y</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-274"></a><span>      </span><span class="hs-identifier hs-type">Proxy</span><span> </span><a href="#local-6989586621679043377"><span class="hs-identifier hs-type">ys</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-275"></a><span>      </span><a href="#local-6989586621679043375"><span class="hs-identifier hs-type">r</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-276"></a><span>    </span><a href="#local-6989586621679043375"><span class="hs-identifier hs-type">r</span></a><span>
</span><a name="line-277"></a><span>
</span><a name="line-278"></a><span class="hs-keyword">instance</span><span> </span><a href="Monad.Capabilities.html#WithSpine"><span class="hs-identifier hs-type">WithSpine</span></a><span> </span><span class="hs-special">'</span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-279"></a><span>  </span><a name="local-8214565720323816950"><a href="Monad.Capabilities.html#onSpine"><span class="hs-identifier">onSpine</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679043399"><a href="#local-6989586621679043399"><span class="hs-identifier">onNil</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679043399"><span class="hs-identifier hs-var">onNil</span></a><span>
</span><a name="line-280"></a><span>
</span><a name="line-281"></a><span class="hs-keyword">instance</span><span> </span><a href="Monad.Capabilities.html#WithSpine"><span class="hs-identifier hs-type">WithSpine</span></a><span> </span><a href="#local-6989586621679043396"><span class="hs-identifier hs-type">xs</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Monad.Capabilities.html#WithSpine"><span class="hs-identifier hs-type">WithSpine</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">x</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679043396"><span class="hs-identifier hs-type">xs</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-282"></a><span>  </span><a name="local-8214565720323816950"><a href="Monad.Capabilities.html#onSpine"><span class="hs-identifier">onSpine</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679043398"><a href="#local-6989586621679043398"><span class="hs-identifier">onCons</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679043398"><span class="hs-identifier hs-var">onCons</span></a><span> </span><span class="hs-identifier hs-var">Proxy</span><span> </span><span class="hs-identifier hs-var">Proxy</span><span>
</span><a name="line-283"></a><span>
</span><a name="line-284"></a><span class="hs-identifier">toCapElem</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-285"></a><span>  </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679044085"><a href="#local-6989586621679044085"><span class="hs-identifier">cap</span></a></a><span> </span><a name="local-6989586621679044086"><a href="#local-6989586621679044086"><span class="hs-identifier">icaps</span></a></a><span> </span><a name="local-6989586621679044087"><a href="#local-6989586621679044087"><span class="hs-identifier">m</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-286"></a><span>  </span><a href="Monad.Capabilities.html#CapImpl"><span class="hs-identifier hs-type">CapImpl</span></a><span> </span><a href="#local-6989586621679044085"><span class="hs-identifier hs-type">cap</span></a><span> </span><a href="#local-6989586621679044086"><span class="hs-identifier hs-type">icaps</span></a><span> </span><a href="#local-6989586621679044087"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-287"></a><span>  </span><a href="Monad.Capabilities.html#CapElem"><span class="hs-identifier hs-type">CapElem</span></a><span> </span><a href="#local-6989586621679044087"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679044085"><span class="hs-identifier hs-type">cap</span></a><span>
</span><a name="line-288"></a><a name="toCapElem"><a href="Monad.Capabilities.html#toCapElem"><span class="hs-identifier">toCapElem</span></a></a><span> </span><span class="hs-special">(</span><a href="Monad.Capabilities.html#CapImpl"><span class="hs-identifier hs-var">CapImpl</span></a><span> </span><a name="local-6989586621679044096"><a href="#local-6989586621679044096"><span class="hs-identifier">cap</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Monad.Capabilities.html#CapElem"><span class="hs-identifier hs-var">CapElem</span></a><span>
</span><a name="line-289"></a><span>  </span><span class="hs-special">(</span><a href="Monad.Capabilities.html#fiatHasElems"><span class="hs-identifier hs-var">fiatHasElems</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Proxy</span><span> </span><span class="hs-glyph">@</span><a href="#local-6989586621679044086"><span class="hs-identifier hs-type">icaps</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Proxy</span><span> </span><span class="hs-glyph">@</span><a href="#local-6989586621679044097"><span class="hs-identifier hs-type">caps</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679044096"><span class="hs-identifier hs-var">cap</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679044097"><a href="#local-6989586621679044097"><span class="hs-identifier">caps</span></a></a><span class="hs-operator">.</span><span> </span><a href="#local-6989586621679044085"><span class="hs-identifier hs-type">cap</span></a><span> </span><span class="hs-special">(</span><a href="Monad.Capabilities.html#CapsT"><span class="hs-identifier hs-type">CapsT</span></a><span> </span><a href="#local-6989586621679044097"><span class="hs-identifier hs-type">caps</span></a><span> </span><a href="#local-6989586621679044087"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-290"></a><span>
</span><a name="line-291"></a><span class="hs-identifier">fiatHasElems</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-292"></a><span>  </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679044082"><a href="#local-6989586621679044082"><span class="hs-identifier">icaps</span></a></a><span> </span><a name="local-6989586621679044083"><a href="#local-6989586621679044083"><span class="hs-identifier">caps</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-293"></a><span>  </span><a href="Monad.Capabilities.html#WithSpine"><span class="hs-identifier hs-type">WithSpine</span></a><span> </span><a href="#local-6989586621679044082"><span class="hs-identifier hs-type">icaps</span></a><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><a name="line-294"></a><span>  </span><span class="hs-identifier hs-type">Proxy</span><span> </span><a href="#local-6989586621679044082"><span class="hs-identifier hs-type">icaps</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-295"></a><span>  </span><span class="hs-identifier hs-type">Proxy</span><span> </span><a href="#local-6989586621679044083"><span class="hs-identifier hs-type">caps</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-296"></a><span>  </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679044084"><a href="#local-6989586621679044084"><span class="hs-identifier">r</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><a href="Monad.Capabilities.html#HasCaps"><span class="hs-identifier hs-type">HasCaps</span></a><span> </span><a href="#local-6989586621679044082"><span class="hs-identifier hs-type">icaps</span></a><span> </span><a href="#local-6989586621679044083"><span class="hs-identifier hs-type">caps</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679044084"><span class="hs-identifier hs-type">r</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679044084"><span class="hs-identifier hs-type">r</span></a><span>
</span><a name="line-297"></a><a name="fiatHasElems"><a href="Monad.Capabilities.html#fiatHasElems"><span class="hs-identifier">fiatHasElems</span></a></a><span> </span><span class="hs-identifier hs-var">Proxy</span><span> </span><span class="hs-identifier hs-var">Proxy</span><span> </span><a name="local-6989586621679044098"><a href="#local-6989586621679044098"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-298"></a><span>  </span><a href="Monad.Capabilities.html#onSpine"><span class="hs-identifier hs-var">onSpine</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Proxy</span><span> </span><span class="hs-glyph">@</span><a href="#local-6989586621679044082"><span class="hs-identifier hs-type">icaps</span></a><span class="hs-special">)</span><span>
</span><a name="line-299"></a><span>    </span><span class="hs-comment">-- nil</span><span>
</span><a name="line-300"></a><span>    </span><a href="#local-6989586621679044098"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-301"></a><span>    </span><span class="hs-comment">-- cons</span><span>
</span><a name="line-302"></a><span>    </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-identifier hs-var">Proxy</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Proxy</span><span> </span><a href="#local-6989586621679044099"><span class="hs-identifier hs-type">cap</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Proxy</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Proxy</span><span> </span><a href="#local-6989586621679044100"><span class="hs-identifier hs-type">icaps'</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-303"></a><span>       </span><span class="hs-keyword">case</span><span> </span><a href="Monad.Capabilities.html#unsafeUnitConstr"><span class="hs-identifier hs-var">unsafeUnitConstr</span></a><span> </span><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Monad.Capabilities.html#HasCap"><span class="hs-identifier hs-type">HasCap</span></a><span> </span><a href="#local-6989586621679044099"><span class="hs-identifier hs-type">cap</span></a><span> </span><a href="#local-6989586621679044083"><span class="hs-identifier hs-type">caps</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-304"></a><span>         </span><span class="hs-identifier hs-var">Refl</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Monad.Capabilities.html#fiatHasElems"><span class="hs-identifier hs-var">fiatHasElems</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Proxy</span><span> </span><span class="hs-glyph">@</span><a href="#local-6989586621679044100"><span class="hs-identifier hs-type">icaps'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Proxy</span><span> </span><span class="hs-glyph">@</span><a href="#local-6989586621679044083"><span class="hs-identifier hs-type">caps</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679044098"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-305"></a><span>
</span><a name="line-306"></a><span class="hs-comment">{-

Since 'caps' is phantom, we can reorder capabilities, remove non-unique
capabilities, or extend them.

The tricky case is extension. Assume @caps'@ subsumes @caps@, and consider each
@cap n@ where @n ~ CapsT caps m@ individually. When we cast this to use @caps'@,
we must know that @cap@ will continue to work correctly.

1. Assume @cap@ uses @n@ in positive position exclusively. This means that the
   capability defines methods that take @Capabilities caps m@ as input, and
   it's okay if we pass @Capabilities caps' m@ instead, as we will simply have
   some unnecessary input.

2. Assume @cap@ uses @n@ in a negative poistion as well. This means that the
   capability defines method that will be passing @Capabilities caps m@ to
   other monadic actions. But when we cast to @caps'@, these monadic actions
   require @Capabilities caps' m@, where @caps'@ subsumes @caps@, so at runtime
   it's possible that we don't pass all needed capabilities for them.

In order for (2) to be safe, we need to place an additional requirement on
capabilities which use the provided @Capabilities caps m@ in a negative position:

  The positive occurence of @Capabilities caps m@ must come from a value
  provided by an occurence of @Capabilities caps m@ in a negative position,
  unmodified, rather than be constructed.

Essentially, we want capabilities to do only two things with @Capabilities@:

* extract parts of it with 'getCap'
* pass it along

In this case, even when on types we put @Capabilities caps m@ in a positive
position (where @caps@ might be insufficient), at runtime we know that these
capabilities actually contain @caps'@.

We guarantee this property by the 'CapImpl' newtype.

-}</span><span>
</span><a name="line-345"></a><span>
</span><a name="line-346"></a><span class="hs-comment">-- | 'CapabilitiesBuilder' is a type to extend capabilities.</span><span>
</span><a name="line-347"></a><span class="hs-comment">--</span><span>
</span><a name="line-348"></a><span class="hs-comment">-- The @allCaps@ parameter is a list of capabilities that will be provided to</span><span>
</span><a name="line-349"></a><span class="hs-comment">-- 'buildCaps' eventually, when the building process is done. The @caps@</span><span>
</span><a name="line-350"></a><span class="hs-comment">-- parameter is the part of capabilities that was constructed so far. The</span><span>
</span><a name="line-351"></a><span class="hs-comment">-- builder is considered complete when @allCaps ~ caps@, only then it can be</span><span>
</span><a name="line-352"></a><span class="hs-comment">-- passed to 'buildCaps'.</span><span>
</span><a name="line-353"></a><span class="hs-keyword">data</span><span> </span><a name="CapabilitiesBuilder"><a href="Monad.Capabilities.html#CapabilitiesBuilder"><span class="hs-identifier">CapabilitiesBuilder</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679043363"><a href="#local-6989586621679043363"><span class="hs-identifier">allCaps</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Monad.Capabilities.html#CapK"><span class="hs-identifier hs-type">CapK</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679043364"><a href="#local-6989586621679043364"><span class="hs-identifier">caps</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Monad.Capabilities.html#CapK"><span class="hs-identifier hs-type">CapK</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679043365"><a href="#local-6989586621679043365"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Monad.Capabilities.html#MonadK"><span class="hs-identifier hs-type">MonadK</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-354"></a><span>  </span><a name="AddCap"><a href="Monad.Capabilities.html#AddCap"><span class="hs-identifier">AddCap</span></a></a><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-355"></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Typeable</span><span> </span><a href="#local-6989586621679043366"><span class="hs-identifier hs-type">cap</span></a><span class="hs-special">,</span><span> </span><a href="Monad.Capabilities.html#HasCaps"><span class="hs-identifier hs-type">HasCaps</span></a><span> </span><a href="#local-6989586621679043367"><span class="hs-identifier hs-type">icaps</span></a><span> </span><a href="#local-6989586621679043368"><span class="hs-identifier hs-type">allCaps</span></a><span class="hs-special">,</span><span> </span><a href="Monad.Capabilities.html#HasNoCap"><span class="hs-identifier hs-type">HasNoCap</span></a><span> </span><a href="#local-6989586621679043366"><span class="hs-identifier hs-type">cap</span></a><span> </span><a href="#local-6989586621679043369"><span class="hs-identifier hs-type">caps</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><a name="line-356"></a><span>    </span><a href="Monad.Capabilities.html#CapImpl"><span class="hs-identifier hs-type">CapImpl</span></a><span> </span><a href="#local-6989586621679043366"><span class="hs-identifier hs-type">cap</span></a><span> </span><a href="#local-6989586621679043367"><span class="hs-identifier hs-type">icaps</span></a><span> </span><a href="#local-6989586621679043370"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-357"></a><span>    </span><a href="Monad.Capabilities.html#CapabilitiesBuilder"><span class="hs-identifier hs-type">CapabilitiesBuilder</span></a><span> </span><a href="#local-6989586621679043368"><span class="hs-identifier hs-type">allCaps</span></a><span> </span><a href="#local-6989586621679043369"><span class="hs-identifier hs-type">caps</span></a><span> </span><a href="#local-6989586621679043370"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-358"></a><span>    </span><a href="Monad.Capabilities.html#CapabilitiesBuilder"><span class="hs-identifier hs-type">CapabilitiesBuilder</span></a><span> </span><a href="#local-6989586621679043368"><span class="hs-identifier hs-type">allCaps</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">cap</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679043369"><span class="hs-identifier hs-type">caps</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679043370"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-359"></a><span>  </span><a name="BaseCaps"><a href="Monad.Capabilities.html#BaseCaps"><span class="hs-identifier">BaseCaps</span></a></a><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-360"></a><span>    </span><a href="Monad.Capabilities.html#Capabilities"><span class="hs-identifier hs-type">Capabilities</span></a><span> </span><a href="#local-6989586621679043371"><span class="hs-identifier hs-type">caps</span></a><span> </span><a href="#local-6989586621679043372"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-361"></a><span>    </span><a href="Monad.Capabilities.html#CapabilitiesBuilder"><span class="hs-identifier hs-type">CapabilitiesBuilder</span></a><span> </span><a href="#local-6989586621679043373"><span class="hs-identifier hs-type">allCaps</span></a><span> </span><a href="#local-6989586621679043371"><span class="hs-identifier hs-type">caps</span></a><span> </span><a href="#local-6989586621679043372"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-362"></a><span>
</span><a name="line-363"></a><span class="hs-comment">-- | Build a map of capabilities from individual implementations:</span><span>
</span><a name="line-364"></a><span class="hs-comment">--</span><span>
</span><a name="line-365"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-366"></a><span class="hs-comment">-- capsXY :: Capabilities '[X, Y] IO</span><span>
</span><a name="line-367"></a><span class="hs-comment">-- capsXY = buildCaps $</span><span>
</span><a name="line-368"></a><span class="hs-comment">--     AddCap xImpl $</span><span>
</span><a name="line-369"></a><span class="hs-comment">--     AddCap yImpl $</span><span>
</span><a name="line-370"></a><span class="hs-comment">--     BaseCaps emptyCaps</span><span>
</span><a name="line-371"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-372"></a><span class="hs-identifier">buildCaps</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679044080"><a href="#local-6989586621679044080"><span class="hs-identifier">caps</span></a></a><span> </span><a name="local-6989586621679044081"><a href="#local-6989586621679044081"><span class="hs-identifier">m</span></a></a><span class="hs-operator">.</span><span> </span><a href="Monad.Capabilities.html#CapabilitiesBuilder"><span class="hs-identifier hs-type">CapabilitiesBuilder</span></a><span> </span><a href="#local-6989586621679044080"><span class="hs-identifier hs-type">caps</span></a><span> </span><a href="#local-6989586621679044080"><span class="hs-identifier hs-type">caps</span></a><span> </span><a href="#local-6989586621679044081"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Monad.Capabilities.html#Capabilities"><span class="hs-identifier hs-type">Capabilities</span></a><span> </span><a href="#local-6989586621679044080"><span class="hs-identifier hs-type">caps</span></a><span> </span><a href="#local-6989586621679044081"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-373"></a><a name="buildCaps"><a href="Monad.Capabilities.html#buildCaps"><span class="hs-identifier">buildCaps</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Monad.Capabilities.html#Capabilities"><span class="hs-identifier hs-var">Capabilities</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679044101"><span class="hs-identifier hs-var">go</span></a><span>
</span><a name="line-374"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-375"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-376"></a><span>      </span><a href="Monad.Capabilities.html#CapabilitiesBuilder"><span class="hs-identifier hs-type">CapabilitiesBuilder</span></a><span> </span><a href="#local-6989586621679044080"><span class="hs-identifier hs-type">caps</span></a><span> </span><a href="#local-6989586621679044102"><span class="hs-identifier hs-type">caps'</span></a><span> </span><a href="#local-6989586621679044081"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-377"></a><span>      </span><span class="hs-identifier hs-type">TypeRepMap</span><span> </span><span class="hs-special">(</span><a href="Monad.Capabilities.html#CapElem"><span class="hs-identifier hs-type">CapElem</span></a><span> </span><a href="#local-6989586621679044081"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-378"></a><span>    </span><a name="local-6989586621679044101"><a href="#local-6989586621679044101"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">(</span><a href="Monad.Capabilities.html#BaseCaps"><span class="hs-identifier hs-var">BaseCaps</span></a><span> </span><span class="hs-special">(</span><a href="Monad.Capabilities.html#Capabilities"><span class="hs-identifier hs-var">Capabilities</span></a><span> </span><a name="local-6989586621679044103"><a href="#local-6989586621679044103"><span class="hs-identifier">caps</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679044103"><span class="hs-identifier hs-var">caps</span></a><span>
</span><a name="line-379"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="Monad.Capabilities.html#AddCap"><span class="hs-identifier hs-var">AddCap</span></a><span> </span><a name="local-6989586621679044104"><a href="#local-6989586621679044104"><span class="hs-identifier">capImpl</span></a></a><span> </span><a name="local-6989586621679044105"><a href="#local-6989586621679044105"><span class="hs-identifier">otherCaps</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-380"></a><span>      </span><span class="hs-identifier hs-var">TypeRepMap.insert</span><span> </span><span class="hs-special">(</span><a href="Monad.Capabilities.html#toCapElem"><span class="hs-identifier hs-var">toCapElem</span></a><span> </span><a href="#local-6989586621679044104"><span class="hs-identifier hs-var">capImpl</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679044101"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679044105"><span class="hs-identifier hs-var">otherCaps</span></a><span class="hs-special">)</span><span>
</span><a name="line-381"></a><span>
</span><a name="line-382"></a><span class="hs-comment">-- | Ensure that the @caps@ list has an element @cap@.</span><span>
</span><a name="line-383"></a><span class="hs-keyword">type</span><span> </span><span class="hs-keyword">family</span><span> </span><a name="HasCap"><a href="Monad.Capabilities.html#HasCap"><span class="hs-identifier">HasCap</span></a></a><span> </span><a name="local-6989586621679043355"><a href="#local-6989586621679043355"><span class="hs-identifier">cap</span></a></a><span> </span><a name="local-6989586621679043356"><a href="#local-6989586621679043356"><span class="hs-identifier">caps</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Constraint</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-384"></a><span>  </span><span class="hs-identifier">HasCap</span><span> </span><a href="#local-6989586621679043357"><span class="hs-identifier hs-type">cap</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">cap</span><span>  </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier hs-type">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-385"></a><span>  </span><span class="hs-identifier">HasCap</span><span> </span><a href="#local-6989586621679043359"><span class="hs-identifier hs-type">cap</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">cap'</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679043361"><span class="hs-identifier hs-type">caps</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Monad.Capabilities.html#HasCap"><span class="hs-identifier hs-type">HasCap</span></a><span> </span><a href="#local-6989586621679043359"><span class="hs-identifier hs-type">cap</span></a><span> </span><a href="#local-6989586621679043361"><span class="hs-identifier hs-type">caps</span></a><span>
</span><a name="line-386"></a><span>  </span><span class="hs-identifier">HasCap</span><span> </span><a href="#local-6989586621679043362"><span class="hs-identifier hs-type">cap</span></a><span> </span><span class="hs-special">'</span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-387"></a><span>    </span><span class="hs-identifier hs-type">TypeError</span><span>
</span><a name="line-388"></a><span>      </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Text</span><span> </span><span class="hs-string">&quot;Capability &quot;</span><span> </span><span class="hs-operator hs-type">:&lt;&gt;:</span><span>
</span><a name="line-389"></a><span>       </span><span class="hs-identifier hs-type">ShowType</span><span> </span><a href="#local-6989586621679043362"><span class="hs-identifier hs-type">cap</span></a><span> </span><span class="hs-operator">:&lt;&gt;:</span><span>
</span><a name="line-390"></a><span>       </span><span class="hs-identifier hs-type">Text</span><span> </span><span class="hs-string">&quot; must be available&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-391"></a><span>
</span><a name="line-392"></a><span class="hs-comment">-- | Ensure that the @caps@ list subsumes @icaps@. It is equivalent</span><span>
</span><a name="line-393"></a><span class="hs-comment">-- to a @HasCap icap caps@ constraint for each @icap@ in @icaps@.</span><span>
</span><a name="line-394"></a><span class="hs-keyword">type</span><span> </span><span class="hs-keyword">family</span><span> </span><a name="HasCaps"><a href="Monad.Capabilities.html#HasCaps"><span class="hs-identifier">HasCaps</span></a></a><span> </span><a name="local-6989586621679043349"><a href="#local-6989586621679043349"><span class="hs-identifier">icaps</span></a></a><span> </span><a name="local-6989586621679043350"><a href="#local-6989586621679043350"><span class="hs-identifier">caps</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Constraint</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-395"></a><span>  </span><span class="hs-identifier">HasCaps</span><span> </span><span class="hs-special">'</span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-396"></a><span>  </span><span class="hs-identifier">HasCaps</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">icap</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679043353"><span class="hs-identifier hs-type">icaps</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679043354"><span class="hs-identifier hs-type">caps</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="Monad.Capabilities.html#HasCap"><span class="hs-identifier hs-type">HasCap</span></a><span> </span><a href="#local-6989586621679043352"><span class="hs-identifier hs-type">icap</span></a><span> </span><a href="#local-6989586621679043354"><span class="hs-identifier hs-type">caps</span></a><span class="hs-special">,</span><span> </span><a href="Monad.Capabilities.html#HasCaps"><span class="hs-identifier hs-type">HasCaps</span></a><span> </span><a href="#local-6989586621679043353"><span class="hs-identifier hs-type">icaps</span></a><span> </span><a href="#local-6989586621679043354"><span class="hs-identifier hs-type">caps</span></a><span class="hs-special">)</span><span>
</span><a name="line-397"></a><span>
</span><a name="line-398"></a><span class="hs-comment">-- | Ensure that the @caps@ list does not have an element @cap@.</span><span>
</span><a name="line-399"></a><span class="hs-keyword">type</span><span> </span><span class="hs-keyword">family</span><span> </span><a name="HasNoCap"><a href="Monad.Capabilities.html#HasNoCap"><span class="hs-identifier">HasNoCap</span></a></a><span> </span><a name="local-6989586621679043341"><a href="#local-6989586621679043341"><span class="hs-identifier">cap</span></a></a><span> </span><a name="local-6989586621679043342"><a href="#local-6989586621679043342"><span class="hs-identifier">caps</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Constraint</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-400"></a><span>  </span><span class="hs-identifier">HasNoCap</span><span> </span><a href="#local-6989586621679043343"><span class="hs-identifier hs-type">cap</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">cap</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier hs-type">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-401"></a><span>    </span><span class="hs-identifier hs-type">TypeError</span><span>
</span><a name="line-402"></a><span>      </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Text</span><span> </span><span class="hs-string">&quot;Capability &quot;</span><span> </span><span class="hs-operator hs-type">:&lt;&gt;:</span><span>
</span><a name="line-403"></a><span>       </span><span class="hs-identifier hs-type">ShowType</span><span> </span><a href="#local-6989586621679043343"><span class="hs-identifier hs-type">cap</span></a><span> </span><span class="hs-operator">:&lt;&gt;:</span><span>
</span><a name="line-404"></a><span>       </span><span class="hs-identifier hs-type">Text</span><span> </span><span class="hs-string">&quot; is already present&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-405"></a><span>  </span><span class="hs-identifier">HasNoCap</span><span> </span><a href="#local-6989586621679043345"><span class="hs-identifier hs-type">cap</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">cap'</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679043347"><span class="hs-identifier hs-type">caps</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Monad.Capabilities.html#HasNoCap"><span class="hs-identifier hs-type">HasNoCap</span></a><span> </span><a href="#local-6989586621679043345"><span class="hs-identifier hs-type">cap</span></a><span> </span><a href="#local-6989586621679043347"><span class="hs-identifier hs-type">caps</span></a><span>
</span><a name="line-406"></a><span>  </span><span class="hs-identifier">HasNoCap</span><span> </span><a href="#local-6989586621679043348"><span class="hs-identifier hs-type">cap</span></a><span> </span><span class="hs-special">'</span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-407"></a><span>
</span><a name="line-408"></a><span class="hs-comment">-- | Lookup a capability in a 'Capabilities' map. The 'HasCap' constraint</span><span>
</span><a name="line-409"></a><span class="hs-comment">-- guarantees that the lookup does not fail.</span><span>
</span><a name="line-410"></a><span class="hs-identifier">getCap</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679044077"><a href="#local-6989586621679044077"><span class="hs-identifier">cap</span></a></a><span> </span><a name="local-6989586621679044078"><a href="#local-6989586621679044078"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679044079"><a href="#local-6989586621679044079"><span class="hs-identifier">caps</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Typeable</span><span> </span><a href="#local-6989586621679044077"><span class="hs-identifier hs-type">cap</span></a><span class="hs-special">,</span><span> </span><a href="Monad.Capabilities.html#HasCap"><span class="hs-identifier hs-type">HasCap</span></a><span> </span><a href="#local-6989586621679044077"><span class="hs-identifier hs-type">cap</span></a><span> </span><a href="#local-6989586621679044079"><span class="hs-identifier hs-type">caps</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Monad.Capabilities.html#Capabilities"><span class="hs-identifier hs-type">Capabilities</span></a><span> </span><a href="#local-6989586621679044079"><span class="hs-identifier hs-type">caps</span></a><span> </span><a href="#local-6989586621679044078"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679044077"><span class="hs-identifier hs-type">cap</span></a><span> </span><span class="hs-special">(</span><a href="Monad.Capabilities.html#CapsT"><span class="hs-identifier hs-type">CapsT</span></a><span> </span><a href="#local-6989586621679044079"><span class="hs-identifier hs-type">caps</span></a><span> </span><a href="#local-6989586621679044078"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-411"></a><a name="getCap"><a href="Monad.Capabilities.html#getCap"><span class="hs-identifier">getCap</span></a></a><span> </span><span class="hs-special">(</span><a href="Monad.Capabilities.html#Capabilities"><span class="hs-identifier hs-var">Capabilities</span></a><span> </span><a name="local-6989586621679044106"><a href="#local-6989586621679044106"><span class="hs-identifier">m</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-string">&quot;getCap: impossible&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">getCapElem</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TypeRepMap.lookup</span><span> </span><a href="#local-6989586621679044106"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-412"></a><span>
</span><a name="line-413"></a><span class="hs-comment">-- An internal function that adds capabilities.</span><span>
</span><a name="line-414"></a><span class="hs-identifier">unsafeInsertCap</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-415"></a><span>  </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Typeable</span><span> </span><a href="#local-6989586621679044072"><span class="hs-identifier hs-type">cap</span></a><span class="hs-special">,</span><span> </span><a href="Monad.Capabilities.html#HasCaps"><span class="hs-identifier hs-type">HasCaps</span></a><span> </span><a href="#local-6989586621679044073"><span class="hs-identifier hs-type">icaps</span></a><span> </span><a href="#local-6989586621679044074"><span class="hs-identifier hs-type">caps'</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><a name="line-416"></a><span>  </span><a href="Monad.Capabilities.html#CapImpl"><span class="hs-identifier hs-type">CapImpl</span></a><span> </span><a href="#local-6989586621679044072"><span class="hs-identifier hs-type">cap</span></a><span> </span><a href="#local-6989586621679044073"><span class="hs-identifier hs-type">icaps</span></a><span> </span><a href="#local-6989586621679044075"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-417"></a><span>  </span><a href="Monad.Capabilities.html#Capabilities"><span class="hs-identifier hs-type">Capabilities</span></a><span> </span><a href="#local-6989586621679044076"><span class="hs-identifier hs-type">caps</span></a><span> </span><a href="#local-6989586621679044075"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-418"></a><span>  </span><a href="Monad.Capabilities.html#Capabilities"><span class="hs-identifier hs-type">Capabilities</span></a><span> </span><a href="#local-6989586621679044074"><span class="hs-identifier hs-type">caps'</span></a><span> </span><a href="#local-6989586621679044075"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-419"></a><a name="unsafeInsertCap"><a href="Monad.Capabilities.html#unsafeInsertCap"><span class="hs-identifier">unsafeInsertCap</span></a></a><span> </span><a name="local-6989586621679044145"><a href="#local-6989586621679044145"><span class="hs-identifier">capImpl</span></a></a><span> </span><span class="hs-special">(</span><a href="Monad.Capabilities.html#Capabilities"><span class="hs-identifier hs-var">Capabilities</span></a><span> </span><a name="local-6989586621679044146"><a href="#local-6989586621679044146"><span class="hs-identifier">caps</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-420"></a><span>  </span><a href="Monad.Capabilities.html#Capabilities"><span class="hs-identifier hs-var">Capabilities</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TypeRepMap.insert</span><span> </span><span class="hs-special">(</span><a href="Monad.Capabilities.html#toCapElem"><span class="hs-identifier hs-var">toCapElem</span></a><span> </span><a href="#local-6989586621679044145"><span class="hs-identifier hs-var">capImpl</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679044146"><span class="hs-identifier hs-var">caps</span></a><span class="hs-special">)</span><span>
</span><a name="line-421"></a><span>
</span><a name="line-422"></a><span class="hs-comment">-- | Extend the set of capabilities. In case the capability is already present,</span><span>
</span><a name="line-423"></a><span class="hs-comment">-- it will be overriden (as with 'overrideCap'), but occur twice in the type.</span><span>
</span><a name="line-424"></a><span class="hs-identifier">insertCap</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-425"></a><span>  </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Typeable</span><span> </span><a href="#local-6989586621679044068"><span class="hs-identifier hs-type">cap</span></a><span class="hs-special">,</span><span> </span><a href="Monad.Capabilities.html#HasCaps"><span class="hs-identifier hs-type">HasCaps</span></a><span> </span><a href="#local-6989586621679044069"><span class="hs-identifier hs-type">icaps</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">cap</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679044070"><span class="hs-identifier hs-type">caps</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><a name="line-426"></a><span>  </span><a href="Monad.Capabilities.html#CapImpl"><span class="hs-identifier hs-type">CapImpl</span></a><span> </span><a href="#local-6989586621679044068"><span class="hs-identifier hs-type">cap</span></a><span> </span><a href="#local-6989586621679044069"><span class="hs-identifier hs-type">icaps</span></a><span> </span><a href="#local-6989586621679044071"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-427"></a><span>  </span><a href="Monad.Capabilities.html#Capabilities"><span class="hs-identifier hs-type">Capabilities</span></a><span> </span><a href="#local-6989586621679044070"><span class="hs-identifier hs-type">caps</span></a><span> </span><a href="#local-6989586621679044071"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-428"></a><span>  </span><a href="Monad.Capabilities.html#Capabilities"><span class="hs-identifier hs-type">Capabilities</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">cap</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679044070"><span class="hs-identifier hs-type">caps</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679044071"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-429"></a><a name="insertCap"><a href="Monad.Capabilities.html#insertCap"><span class="hs-identifier">insertCap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Monad.Capabilities.html#unsafeInsertCap"><span class="hs-identifier hs-var">unsafeInsertCap</span></a><span>
</span><a name="line-430"></a><span>
</span><a name="line-431"></a><span class="hs-comment">-- | Extend the set of capabilities. In case the capability is already present,</span><span>
</span><a name="line-432"></a><span class="hs-comment">-- a type error occurs.</span><span>
</span><a name="line-433"></a><span class="hs-identifier">addCap</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-434"></a><span>  </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Typeable</span><span> </span><a href="#local-6989586621679044064"><span class="hs-identifier hs-type">cap</span></a><span class="hs-special">,</span><span> </span><a href="Monad.Capabilities.html#HasNoCap"><span class="hs-identifier hs-type">HasNoCap</span></a><span> </span><a href="#local-6989586621679044064"><span class="hs-identifier hs-type">cap</span></a><span> </span><a href="#local-6989586621679044065"><span class="hs-identifier hs-type">caps</span></a><span class="hs-special">,</span><span> </span><a href="Monad.Capabilities.html#HasCaps"><span class="hs-identifier hs-type">HasCaps</span></a><span> </span><a href="#local-6989586621679044066"><span class="hs-identifier hs-type">icaps</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">cap</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679044065"><span class="hs-identifier hs-type">caps</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><a name="line-435"></a><span>  </span><a href="Monad.Capabilities.html#CapImpl"><span class="hs-identifier hs-type">CapImpl</span></a><span> </span><a href="#local-6989586621679044064"><span class="hs-identifier hs-type">cap</span></a><span> </span><a href="#local-6989586621679044066"><span class="hs-identifier hs-type">icaps</span></a><span> </span><a href="#local-6989586621679044067"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-436"></a><span>  </span><a href="Monad.Capabilities.html#Capabilities"><span class="hs-identifier hs-type">Capabilities</span></a><span> </span><a href="#local-6989586621679044065"><span class="hs-identifier hs-type">caps</span></a><span> </span><a href="#local-6989586621679044067"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-437"></a><span>  </span><a href="Monad.Capabilities.html#Capabilities"><span class="hs-identifier hs-type">Capabilities</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">cap</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679044065"><span class="hs-identifier hs-type">caps</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679044067"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-438"></a><a name="addCap"><a href="Monad.Capabilities.html#addCap"><span class="hs-identifier">addCap</span></a></a><span> </span><a name="local-6989586621679044147"><a href="#local-6989586621679044147"><span class="hs-identifier">capImpl</span></a></a><span> </span><a name="local-6989586621679044148"><a href="#local-6989586621679044148"><span class="hs-identifier">caps</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Monad.Capabilities.html#buildCaps"><span class="hs-identifier hs-var">buildCaps</span></a><span> </span><span class="hs-special">(</span><a href="Monad.Capabilities.html#AddCap"><span class="hs-identifier hs-var">AddCap</span></a><span> </span><a href="#local-6989586621679044147"><span class="hs-identifier hs-var">capImpl</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Monad.Capabilities.html#BaseCaps"><span class="hs-identifier hs-var">BaseCaps</span></a><span> </span><a href="#local-6989586621679044148"><span class="hs-identifier hs-var">caps</span></a><span class="hs-special">)</span><span>
</span><a name="line-439"></a><span>
</span><a name="line-440"></a><span class="hs-comment">-- | Override the implementation of an existing capability.</span><span>
</span><a name="line-441"></a><span class="hs-identifier">overrideCap</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-442"></a><span>  </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Typeable</span><span> </span><a href="#local-6989586621679044060"><span class="hs-identifier hs-type">cap</span></a><span class="hs-special">,</span><span> </span><a href="Monad.Capabilities.html#HasCap"><span class="hs-identifier hs-type">HasCap</span></a><span> </span><a href="#local-6989586621679044060"><span class="hs-identifier hs-type">cap</span></a><span> </span><a href="#local-6989586621679044061"><span class="hs-identifier hs-type">caps</span></a><span class="hs-special">,</span><span> </span><a href="Monad.Capabilities.html#HasCaps"><span class="hs-identifier hs-type">HasCaps</span></a><span> </span><a href="#local-6989586621679044062"><span class="hs-identifier hs-type">icaps</span></a><span> </span><a href="#local-6989586621679044061"><span class="hs-identifier hs-type">caps</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><a name="line-443"></a><span>  </span><a href="Monad.Capabilities.html#CapImpl"><span class="hs-identifier hs-type">CapImpl</span></a><span> </span><a href="#local-6989586621679044060"><span class="hs-identifier hs-type">cap</span></a><span> </span><a href="#local-6989586621679044062"><span class="hs-identifier hs-type">icaps</span></a><span> </span><a href="#local-6989586621679044063"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-444"></a><span>  </span><a href="Monad.Capabilities.html#Capabilities"><span class="hs-identifier hs-type">Capabilities</span></a><span> </span><a href="#local-6989586621679044061"><span class="hs-identifier hs-type">caps</span></a><span> </span><a href="#local-6989586621679044063"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-445"></a><span>  </span><a href="Monad.Capabilities.html#Capabilities"><span class="hs-identifier hs-type">Capabilities</span></a><span> </span><a href="#local-6989586621679044061"><span class="hs-identifier hs-type">caps</span></a><span> </span><a href="#local-6989586621679044063"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-446"></a><a name="overrideCap"><a href="Monad.Capabilities.html#overrideCap"><span class="hs-identifier">overrideCap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Monad.Capabilities.html#unsafeInsertCap"><span class="hs-identifier hs-var">unsafeInsertCap</span></a><span>
</span><a name="line-447"></a><span>
</span><a name="line-448"></a><span class="hs-comment">-- | Override the implementation of an existing capability using the previous</span><span>
</span><a name="line-449"></a><span class="hs-comment">-- implementation. This is a more efficient equivalent to extracting a</span><span>
</span><a name="line-450"></a><span class="hs-comment">-- capability with 'getCap', adjusting it with a function, and putting it back</span><span>
</span><a name="line-451"></a><span class="hs-comment">-- with 'overrideCap'.</span><span>
</span><a name="line-452"></a><span class="hs-identifier">adjustCap</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-453"></a><span>  </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679044056"><a href="#local-6989586621679044056"><span class="hs-identifier">cap</span></a></a><span> </span><a name="local-6989586621679044057"><a href="#local-6989586621679044057"><span class="hs-identifier">caps</span></a></a><span> </span><a name="local-6989586621679044058"><a href="#local-6989586621679044058"><span class="hs-identifier">m</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-454"></a><span>  </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Typeable</span><span> </span><a href="#local-6989586621679044056"><span class="hs-identifier hs-type">cap</span></a><span class="hs-special">,</span><span> </span><a href="Monad.Capabilities.html#HasCap"><span class="hs-identifier hs-type">HasCap</span></a><span> </span><a href="#local-6989586621679044056"><span class="hs-identifier hs-type">cap</span></a><span> </span><a href="#local-6989586621679044057"><span class="hs-identifier hs-type">caps</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><a name="line-455"></a><span>  </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679044059"><a href="#local-6989586621679044059"><span class="hs-identifier">caps'</span></a></a><span class="hs-operator">.</span><span> </span><a href="#local-6989586621679044056"><span class="hs-identifier hs-type">cap</span></a><span> </span><span class="hs-special">(</span><a href="Monad.Capabilities.html#CapsT"><span class="hs-identifier hs-type">CapsT</span></a><span> </span><a href="#local-6989586621679044059"><span class="hs-identifier hs-type">caps'</span></a><span> </span><a href="#local-6989586621679044058"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679044056"><span class="hs-identifier hs-type">cap</span></a><span> </span><span class="hs-special">(</span><a href="Monad.Capabilities.html#CapsT"><span class="hs-identifier hs-type">CapsT</span></a><span> </span><a href="#local-6989586621679044059"><span class="hs-identifier hs-type">caps'</span></a><span> </span><a href="#local-6989586621679044058"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-456"></a><span>  </span><a href="Monad.Capabilities.html#Capabilities"><span class="hs-identifier hs-type">Capabilities</span></a><span> </span><a href="#local-6989586621679044057"><span class="hs-identifier hs-type">caps</span></a><span> </span><a href="#local-6989586621679044058"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-457"></a><span>  </span><a href="Monad.Capabilities.html#Capabilities"><span class="hs-identifier hs-type">Capabilities</span></a><span> </span><a href="#local-6989586621679044057"><span class="hs-identifier hs-type">caps</span></a><span> </span><a href="#local-6989586621679044058"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-458"></a><a name="adjustCap"><a href="Monad.Capabilities.html#adjustCap"><span class="hs-identifier">adjustCap</span></a></a><span> </span><a name="local-6989586621679044149"><a href="#local-6989586621679044149"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a href="Monad.Capabilities.html#Capabilities"><span class="hs-identifier hs-var">Capabilities</span></a><span> </span><a name="local-6989586621679044150"><a href="#local-6989586621679044150"><span class="hs-identifier">caps</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-459"></a><span>  </span><a href="Monad.Capabilities.html#Capabilities"><span class="hs-identifier hs-var">Capabilities</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TypeRepMap.adjust</span><span> </span><span class="hs-special">(</span><a href="Monad.Capabilities.html#overCapElem"><span class="hs-identifier hs-var">overCapElem</span></a><span> </span><a href="#local-6989586621679044149"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679044150"><span class="hs-identifier hs-var">caps</span></a><span class="hs-special">)</span><span>
</span><a name="line-460"></a><span>
</span><a name="line-461"></a><span class="hs-comment">-- | Extract a capability from 'CapsT' and provide it to a continuation.</span><span>
</span><a name="line-462"></a><span class="hs-identifier">withCap</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Typeable</span><span> </span><a href="#local-6989586621679044052"><span class="hs-identifier hs-type">cap</span></a><span class="hs-special">,</span><span> </span><a href="Monad.Capabilities.html#HasCap"><span class="hs-identifier hs-type">HasCap</span></a><span> </span><a href="#local-6989586621679044052"><span class="hs-identifier hs-type">cap</span></a><span> </span><a href="#local-6989586621679044053"><span class="hs-identifier hs-type">caps</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679044052"><span class="hs-identifier hs-type">cap</span></a><span> </span><span class="hs-special">(</span><a href="Monad.Capabilities.html#CapsT"><span class="hs-identifier hs-type">CapsT</span></a><span> </span><a href="#local-6989586621679044053"><span class="hs-identifier hs-type">caps</span></a><span> </span><a href="#local-6989586621679044054"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Monad.Capabilities.html#CapsT"><span class="hs-identifier hs-type">CapsT</span></a><span> </span><a href="#local-6989586621679044053"><span class="hs-identifier hs-type">caps</span></a><span> </span><a href="#local-6989586621679044054"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679044055"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Monad.Capabilities.html#CapsT"><span class="hs-identifier hs-type">CapsT</span></a><span> </span><a href="#local-6989586621679044053"><span class="hs-identifier hs-type">caps</span></a><span> </span><a href="#local-6989586621679044054"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679044055"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-463"></a><a name="withCap"><a href="Monad.Capabilities.html#withCap"><span class="hs-identifier">withCap</span></a></a><span> </span><a name="local-6989586621679044151"><a href="#local-6989586621679044151"><span class="hs-identifier">cont</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ReaderT</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679044152"><a href="#local-6989586621679044152"><span class="hs-identifier">caps</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">runReaderT</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679044151"><span class="hs-identifier hs-var">cont</span></a><span> </span><span class="hs-special">(</span><a href="Monad.Capabilities.html#getCap"><span class="hs-identifier hs-var">getCap</span></a><span> </span><a href="#local-6989586621679044152"><span class="hs-identifier hs-var">caps</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679044152"><span class="hs-identifier hs-var">caps</span></a><span>
</span><a name="line-464"></a><span>
</span><a name="line-465"></a><span class="hs-comment">-- | Evidence that @cap@ is present or absent in @caps@.</span><span>
</span><a name="line-466"></a><span class="hs-keyword">data</span><span> </span><a name="HasCapDecision"><a href="Monad.Capabilities.html#HasCapDecision"><span class="hs-identifier">HasCapDecision</span></a></a><span> </span><a name="local-6989586621679043335"><a href="#local-6989586621679043335"><span class="hs-identifier">cap</span></a></a><span> </span><a name="local-6989586621679043336"><a href="#local-6989586621679043336"><span class="hs-identifier">caps</span></a></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-467"></a><span>  </span><a name="HasNoCap"><a href="Monad.Capabilities.html#HasNoCap"><span class="hs-identifier">HasNoCap</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Monad.Capabilities.html#HasNoCap"><span class="hs-identifier hs-type">HasNoCap</span></a><span> </span><a href="#local-6989586621679043337"><span class="hs-identifier hs-type">cap</span></a><span> </span><a href="#local-6989586621679043338"><span class="hs-identifier hs-type">caps</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Monad.Capabilities.html#HasCapDecision"><span class="hs-identifier hs-type">HasCapDecision</span></a><span> </span><a href="#local-6989586621679043337"><span class="hs-identifier hs-type">cap</span></a><span> </span><a href="#local-6989586621679043338"><span class="hs-identifier hs-type">caps</span></a><span>
</span><a name="line-468"></a><span>  </span><a name="HasCap"><a href="Monad.Capabilities.html#HasCap"><span class="hs-identifier">HasCap</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Monad.Capabilities.html#HasCap"><span class="hs-identifier hs-type">HasCap</span></a><span> </span><a href="#local-6989586621679043339"><span class="hs-identifier hs-type">cap</span></a><span> </span><a href="#local-6989586621679043340"><span class="hs-identifier hs-type">caps</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Monad.Capabilities.html#HasCapDecision"><span class="hs-identifier hs-type">HasCapDecision</span></a><span> </span><a href="#local-6989586621679043339"><span class="hs-identifier hs-type">cap</span></a><span> </span><a href="#local-6989586621679043340"><span class="hs-identifier hs-type">caps</span></a><span>
</span><a name="line-469"></a><span>
</span><a name="line-470"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Show</span><span> </span><span class="hs-special">(</span><a href="Monad.Capabilities.html#HasCapDecision"><span class="hs-identifier hs-type">HasCapDecision</span></a><span> </span><a href="#local-6989586621679043394"><span class="hs-identifier hs-type">cap</span></a><span> </span><a href="#local-6989586621679043395"><span class="hs-identifier hs-type">caps</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-471"></a><span>  </span><a name="local-8214565720323790326"><span class="hs-identifier">show</span></a><span> </span><a href="Monad.Capabilities.html#HasNoCap"><span class="hs-identifier hs-var">HasNoCap</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;HasNoCap&quot;</span><span>
</span><a name="line-472"></a><span>  </span><span class="hs-identifier">show</span><span> </span><a href="Monad.Capabilities.html#HasCap"><span class="hs-identifier hs-var">HasCap</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;HasCap&quot;</span><span>
</span><a name="line-473"></a><span>
</span><a name="line-474"></a><span class="hs-comment">-- | Determine at runtime whether 'HasCap cap caps' or 'HasNoCap cap caps' holds.</span><span>
</span><a name="line-475"></a><span class="hs-identifier">checkCap</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679044049"><a href="#local-6989586621679044049"><span class="hs-identifier">cap</span></a></a><span> </span><a name="local-6989586621679044050"><a href="#local-6989586621679044050"><span class="hs-identifier">caps</span></a></a><span> </span><a name="local-6989586621679044051"><a href="#local-6989586621679044051"><span class="hs-identifier">m</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-identifier hs-type">Typeable</span><span> </span><a href="#local-6989586621679044049"><span class="hs-identifier hs-type">cap</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Monad.Capabilities.html#Capabilities"><span class="hs-identifier hs-type">Capabilities</span></a><span> </span><a href="#local-6989586621679044050"><span class="hs-identifier hs-type">caps</span></a><span> </span><a href="#local-6989586621679044051"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Monad.Capabilities.html#HasCapDecision"><span class="hs-identifier hs-type">HasCapDecision</span></a><span> </span><a href="#local-6989586621679044049"><span class="hs-identifier hs-type">cap</span></a><span> </span><a href="#local-6989586621679044050"><span class="hs-identifier hs-type">caps</span></a><span>
</span><a name="line-476"></a><a name="checkCap"><a href="Monad.Capabilities.html#checkCap"><span class="hs-identifier">checkCap</span></a></a><span> </span><span class="hs-special">(</span><a href="Monad.Capabilities.html#Capabilities"><span class="hs-identifier hs-var">Capabilities</span></a><span> </span><a name="local-6989586621679044153"><a href="#local-6989586621679044153"><span class="hs-identifier">m</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-477"></a><span>  </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">TypeRepMap.member</span><span> </span><span class="hs-glyph">@</span><a href="#local-6989586621679044049"><span class="hs-identifier hs-type">cap</span></a><span> </span><a href="#local-6989586621679044153"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-478"></a><span>  </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Monad.Capabilities.html#unsafeUnitConstr"><span class="hs-identifier hs-var">unsafeUnitConstr</span></a><span> </span><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Monad.Capabilities.html#HasCap"><span class="hs-identifier hs-type">HasCap</span></a><span> </span><a href="#local-6989586621679044049"><span class="hs-identifier hs-type">cap</span></a><span> </span><a href="#local-6989586621679044050"><span class="hs-identifier hs-type">caps</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-identifier hs-var">Refl</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Monad.Capabilities.html#HasCap"><span class="hs-identifier hs-var">HasCap</span></a><span>
</span><a name="line-479"></a><span>  </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Monad.Capabilities.html#unsafeUnitConstr"><span class="hs-identifier hs-var">unsafeUnitConstr</span></a><span> </span><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Monad.Capabilities.html#HasNoCap"><span class="hs-identifier hs-type">HasNoCap</span></a><span> </span><a href="#local-6989586621679044049"><span class="hs-identifier hs-type">cap</span></a><span> </span><a href="#local-6989586621679044050"><span class="hs-identifier hs-type">caps</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-identifier hs-var">Refl</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Monad.Capabilities.html#HasNoCap"><span class="hs-identifier hs-var">HasNoCap</span></a><span>
</span><a name="line-480"></a><span>
</span><a name="line-481"></a><span class="hs-comment">-- Use to construct 'HasCap' or 'HasNoCap'.</span><span>
</span><a name="line-482"></a><span class="hs-identifier">unsafeUnitConstr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">c</span><span> </span><span class="hs-operator hs-type">:~:</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Constraint</span><span class="hs-special">)</span><span>
</span><a name="line-483"></a><a name="unsafeUnitConstr"><a href="Monad.Capabilities.html#unsafeUnitConstr"><span class="hs-identifier">unsafeUnitConstr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unsafeCoerce</span><span> </span><span class="hs-identifier hs-var">Refl</span><span>
</span><a name="line-484"></a><span>
</span><a name="line-485"></a><span class="hs-comment">-- | The 'Context' capability is used to model the @Reader@ effect within the</span><span>
</span><a name="line-486"></a><span class="hs-comment">-- capabilities framework.</span><span>
</span><a name="line-487"></a><span class="hs-keyword">newtype</span><span> </span><a name="Context"><a href="Monad.Capabilities.html#Context"><span class="hs-identifier">Context</span></a></a><span> </span><a name="local-6989586621679043333"><a href="#local-6989586621679043333"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679043334"><a href="#local-6989586621679043334"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Monad.Capabilities.html#MonadK"><span class="hs-identifier hs-type">MonadK</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="Context"><a href="Monad.Capabilities.html#Context"><span class="hs-identifier">Context</span></a></a><span> </span><a href="#local-6989586621679043333"><span class="hs-identifier hs-type">x</span></a><span>
</span><a name="line-488"></a><span>
</span><a name="line-489"></a><span class="hs-comment">-- | The 'HasContext' constraint is a shorthand for 'HasCap' of 'Context'.</span><span>
</span><a name="line-490"></a><span class="hs-keyword">class</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Typeable</span><span> </span><a href="#local-6989586621679042888"><span class="hs-identifier hs-type">x</span></a><span class="hs-special">,</span><span> </span><a href="Monad.Capabilities.html#HasCap"><span class="hs-identifier hs-type">HasCap</span></a><span> </span><span class="hs-special">(</span><a href="Monad.Capabilities.html#Context"><span class="hs-identifier hs-type">Context</span></a><span> </span><a href="#local-6989586621679042888"><span class="hs-identifier hs-type">x</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679042889"><span class="hs-identifier hs-type">caps</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a name="HasContext"><a href="Monad.Capabilities.html#HasContext"><span class="hs-identifier">HasContext</span></a></a><span> </span><a name="local-6989586621679042888"><a href="#local-6989586621679042888"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621679042889"><a href="#local-6989586621679042889"><span class="hs-identifier">caps</span></a></a><span>
</span><a name="line-491"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Typeable</span><span> </span><a href="#local-6989586621679043392"><span class="hs-identifier hs-type">x</span></a><span class="hs-special">,</span><span> </span><a href="Monad.Capabilities.html#HasCap"><span class="hs-identifier hs-type">HasCap</span></a><span> </span><span class="hs-special">(</span><a href="Monad.Capabilities.html#Context"><span class="hs-identifier hs-type">Context</span></a><span> </span><a href="#local-6989586621679043392"><span class="hs-identifier hs-type">x</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679043393"><span class="hs-identifier hs-type">caps</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Monad.Capabilities.html#HasContext"><span class="hs-identifier hs-type">HasContext</span></a><span> </span><a href="#local-6989586621679043392"><span class="hs-identifier hs-type">x</span></a><span> </span><a href="#local-6989586621679043393"><span class="hs-identifier hs-type">caps</span></a><span>
</span><a name="line-492"></a><span>
</span><a name="line-493"></a><span class="hs-comment">-- | Initialize a 'Context' capability.</span><span>
</span><a name="line-494"></a><span class="hs-identifier">newContext</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679044046"><a href="#local-6989586621679044046"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621679044047"><a href="#local-6989586621679044047"><span class="hs-identifier">m</span></a></a><span class="hs-operator">.</span><span> </span><a href="#local-6989586621679044046"><span class="hs-identifier hs-type">x</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Monad.Capabilities.html#CapImpl"><span class="hs-identifier hs-type">CapImpl</span></a><span> </span><span class="hs-special">(</span><a href="Monad.Capabilities.html#Context"><span class="hs-identifier hs-type">Context</span></a><span> </span><a href="#local-6989586621679044046"><span class="hs-identifier hs-type">x</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">'</span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621679044047"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-495"></a><a name="newContext"><a href="Monad.Capabilities.html#newContext"><span class="hs-identifier">newContext</span></a></a><span> </span><a name="local-6989586621679044154"><a href="#local-6989586621679044154"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Monad.Capabilities.html#CapImpl"><span class="hs-identifier hs-var">CapImpl</span></a><span> </span><span class="hs-special">(</span><a href="Monad.Capabilities.html#Context"><span class="hs-identifier hs-var">Context</span></a><span> </span><a href="#local-6989586621679044154"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-496"></a><span>
</span><a name="line-497"></a><span class="hs-comment">-- | Retrieve the context value. Moral equivalent of 'ask'.</span><span>
</span><a name="line-498"></a><span class="hs-identifier">askContext</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Monad.Capabilities.html#HasContext"><span class="hs-identifier hs-type">HasContext</span></a><span> </span><a href="#local-6989586621679044043"><span class="hs-identifier hs-type">x</span></a><span> </span><a href="#local-6989586621679044044"><span class="hs-identifier hs-type">caps</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Applicative</span><span> </span><a href="#local-6989586621679044045"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Monad.Capabilities.html#CapsT"><span class="hs-identifier hs-type">CapsT</span></a><span> </span><a href="#local-6989586621679044044"><span class="hs-identifier hs-type">caps</span></a><span> </span><a href="#local-6989586621679044045"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679044043"><span class="hs-identifier hs-type">x</span></a><span>
</span><a name="line-499"></a><a name="askContext"><a href="Monad.Capabilities.html#askContext"><span class="hs-identifier">askContext</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Monad.Capabilities.html#withCap"><span class="hs-identifier hs-var">withCap</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a href="Monad.Capabilities.html#Context"><span class="hs-identifier hs-var">Context</span></a><span> </span><a name="local-6989586621679044155"><a href="#local-6989586621679044155"><span class="hs-identifier">x</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621679044155"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-500"></a><span>
</span><a name="line-501"></a><span class="hs-comment">-- | Execute a computation with a modified context value. Moral equivalent of 'local'.</span><span>
</span><a name="line-502"></a><span class="hs-identifier">localContext</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679044039"><a href="#local-6989586621679044039"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621679044040"><a href="#local-6989586621679044040"><span class="hs-identifier">caps</span></a></a><span> </span><a name="local-6989586621679044041"><a href="#local-6989586621679044041"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679044042"><a href="#local-6989586621679044042"><span class="hs-identifier">a</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><a href="Monad.Capabilities.html#HasContext"><span class="hs-identifier hs-type">HasContext</span></a><span> </span><a href="#local-6989586621679044039"><span class="hs-identifier hs-type">x</span></a><span> </span><a href="#local-6989586621679044040"><span class="hs-identifier hs-type">caps</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679044039"><span class="hs-identifier hs-type">x</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679044039"><span class="hs-identifier hs-type">x</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Monad.Capabilities.html#CapsT"><span class="hs-identifier hs-type">CapsT</span></a><span> </span><a href="#local-6989586621679044040"><span class="hs-identifier hs-type">caps</span></a><span> </span><a href="#local-6989586621679044041"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679044042"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Monad.Capabilities.html#CapsT"><span class="hs-identifier hs-type">CapsT</span></a><span> </span><a href="#local-6989586621679044040"><span class="hs-identifier hs-type">caps</span></a><span> </span><a href="#local-6989586621679044041"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679044042"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-503"></a><a name="localContext"><a href="Monad.Capabilities.html#localContext"><span class="hs-identifier">localContext</span></a></a><span> </span><a name="local-6989586621679044156"><a href="#local-6989586621679044156"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-504"></a><span>  </span><span class="hs-keyword">let</span><span>
</span><a name="line-505"></a><span>    </span><span class="hs-identifier">f'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679044158"><a href="#local-6989586621679044158"><span class="hs-identifier">m'</span></a></a><span class="hs-operator">.</span><span> </span><a href="Monad.Capabilities.html#Context"><span class="hs-identifier hs-type">Context</span></a><span> </span><a href="#local-6989586621679044039"><span class="hs-identifier hs-type">x</span></a><span> </span><a href="#local-6989586621679044158"><span class="hs-identifier hs-type">m'</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Monad.Capabilities.html#Context"><span class="hs-identifier hs-type">Context</span></a><span> </span><a href="#local-6989586621679044039"><span class="hs-identifier hs-type">x</span></a><span> </span><a href="#local-6989586621679044158"><span class="hs-identifier hs-type">m'</span></a><span>
</span><a name="line-506"></a><span>    </span><a name="local-6989586621679044157"><a href="#local-6989586621679044157"><span class="hs-identifier">f'</span></a></a><span> </span><span class="hs-special">(</span><a href="Monad.Capabilities.html#Context"><span class="hs-identifier hs-var">Context</span></a><span> </span><a name="local-6989586621679044159"><a href="#local-6989586621679044159"><span class="hs-identifier">x</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Monad.Capabilities.html#Context"><span class="hs-identifier hs-var">Context</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679044156"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679044159"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-507"></a><span>  </span><span class="hs-keyword">in</span><span>
</span><a name="line-508"></a><span>    </span><span class="hs-identifier hs-var">local</span><span> </span><span class="hs-special">(</span><a href="Monad.Capabilities.html#adjustCap"><span class="hs-identifier hs-var">adjustCap</span></a><span> </span><a href="#local-6989586621679044157"><span class="hs-identifier hs-var">f'</span></a><span class="hs-special">)</span><span>
</span><a name="line-509"></a><span>
</span><a name="line-510"></a><span class="hs-identifier">makeCap</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TH.Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TH.DecsQ</span><span>
</span><a name="line-511"></a><a name="makeCap"><a href="Monad.Capabilities.html#makeCap"><span class="hs-identifier">makeCap</span></a></a><span> </span><a name="local-6989586621679044160"><a href="#local-6989586621679044160"><span class="hs-identifier">capName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-512"></a><span>  </span><a name="local-6989586621679044237"><a href="#local-6989586621679044237"><span class="hs-identifier">info</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">TH.reify</span><span> </span><a href="#local-6989586621679044160"><span class="hs-identifier hs-var">capName</span></a><span>
</span><a name="line-513"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679044242"><a href="#local-6989586621679044242"><span class="hs-identifier">vbts</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679044243"><a href="#local-6989586621679044243"><span class="hs-identifier">tyVars</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-514"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679044237"><span class="hs-identifier hs-var">info</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-515"></a><span>      </span><span class="hs-identifier hs-var">TH.TyConI</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.DataD</span><span>    </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679044238"><a href="#local-6989586621679044238"><span class="hs-identifier">tyVars</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">TH.RecC</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679044239"><a href="#local-6989586621679044239"><span class="hs-identifier">vbts</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679044239"><span class="hs-identifier hs-var">vbts</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679044238"><span class="hs-identifier hs-var">tyVars</span></a><span class="hs-special">)</span><span>
</span><a name="line-516"></a><span>      </span><span class="hs-identifier hs-var">TH.TyConI</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.NewtypeD</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679044240"><a href="#local-6989586621679044240"><span class="hs-identifier">tyVars</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.RecC</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679044241"><a href="#local-6989586621679044241"><span class="hs-identifier">vbts</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679044241"><span class="hs-identifier hs-var">vbts</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679044240"><span class="hs-identifier hs-var">tyVars</span></a><span class="hs-special">)</span><span>
</span><a name="line-517"></a><span>      </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-string">&quot;Capabilities must be single-constructor record types&quot;</span><span>
</span><a name="line-518"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679044434"><a href="#local-6989586621679044434"><span class="hs-identifier">mVar</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679044435"><a href="#local-6989586621679044435"><span class="hs-identifier">extraTyVars</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-519"></a><span>    </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621679044243"><span class="hs-identifier hs-var">tyVars</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-520"></a><span>      </span><span class="hs-special">(</span><a name="local-6989586621679044432"><a href="#local-6989586621679044432"><span class="hs-identifier">tv</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679044433"><a href="#local-6989586621679044433"><span class="hs-identifier">tvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679044432"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621679044433"><span class="hs-identifier hs-var">tvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-521"></a><span>      </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-string">&quot;Capability must have a monadic parameter&quot;</span><span>
</span><a name="line-522"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679044436"><a href="#local-6989586621679044436"><span class="hs-identifier">capType</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldl1'</span><span> </span><span class="hs-identifier hs-var">TH.appT</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.conT</span><span> </span><a href="#local-6989586621679044160"><span class="hs-identifier hs-var">capName</span></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621679044161"><span class="hs-identifier hs-var">tyVarBndrT</span></a><span> </span><a href="#local-6989586621679044435"><span class="hs-identifier hs-var">extraTyVars</span></a><span class="hs-special">)</span><span>
</span><a name="line-523"></a><span>  </span><a name="local-6989586621679044446"><a href="#local-6989586621679044446"><span class="hs-identifier">methodSpecs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">for</span><span> </span><a href="#local-6989586621679044242"><span class="hs-identifier hs-var">vbts</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679044437"><a href="#local-6989586621679044437"><span class="hs-identifier">fieldName</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679044438"><a href="#local-6989586621679044438"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-524"></a><span>    </span><a name="local-6989586621679044440"><a href="#local-6989586621679044440"><span class="hs-identifier">methodName</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-525"></a><span>      </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">TH.nameBase</span><span> </span><a href="#local-6989586621679044437"><span class="hs-identifier hs-var">fieldName</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-526"></a><span>        </span><span class="hs-special">(</span><span class="hs-char">'_'</span><span class="hs-glyph">:</span><a name="local-6989586621679044439"><a href="#local-6989586621679044439"><span class="hs-identifier">methodName</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">TH.mkName</span><span> </span><a href="#local-6989586621679044439"><span class="hs-identifier hs-var">methodName</span></a><span>
</span><a name="line-527"></a><span>        </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-string">&quot;Capability method names must start with underscores&quot;</span><span>
</span><a name="line-528"></a><span>    </span><a name="local-6989586621679044445"><a href="#local-6989586621679044445"><span class="hs-identifier">tyArgList</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-529"></a><span>      </span><span class="hs-keyword">let</span><span>
</span><a name="line-530"></a><span>        </span><a name="local-6989586621679044441"><a href="#local-6989586621679044441"><span class="hs-identifier">toArgList</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.ArrowT</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">TH.AppT</span><span class="hs-special">`</span><span> </span><a name="local-6989586621679044442"><a href="#local-6989586621679044442"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">TH.AppT</span><span class="hs-special">`</span><span> </span><a name="local-6989586621679044443"><a href="#local-6989586621679044443"><span class="hs-identifier">b</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679044442"><span class="hs-identifier hs-var">a</span></a><span class="hs-glyph">:</span><a href="#local-6989586621679044441"><span class="hs-identifier hs-var">toArgList</span></a><span> </span><a href="#local-6989586621679044443"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-531"></a><span>        </span><span class="hs-identifier">toArgList</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.ForallT</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679044444"><a href="#local-6989586621679044444"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679044441"><span class="hs-identifier hs-var">toArgList</span></a><span> </span><a href="#local-6989586621679044444"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-532"></a><span>        </span><span class="hs-identifier">toArgList</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-533"></a><span>      </span><span class="hs-keyword">in</span><span>
</span><a name="line-534"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679044441"><span class="hs-identifier hs-var">toArgList</span></a><span> </span><a href="#local-6989586621679044438"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-535"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679044440"><span class="hs-identifier hs-var">methodName</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679044437"><span class="hs-identifier hs-var">fieldName</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679044438"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679044445"><span class="hs-identifier hs-var">tyArgList</span></a><span class="hs-special">)</span><span>
</span><a name="line-536"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679044447"><a href="#local-6989586621679044447"><span class="hs-identifier">className</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TH.mkName</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Monad&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">TH.nameBase</span><span> </span><a href="#local-6989586621679044160"><span class="hs-identifier hs-var">capName</span></a><span class="hs-special">)</span><span>
</span><a name="line-537"></a><span>  </span><a name="local-6989586621679044464"><a href="#local-6989586621679044464"><span class="hs-identifier">class_decs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">:</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span>
</span><a name="line-538"></a><span>    </span><span class="hs-identifier hs-var">TH.classD</span><span>
</span><a name="line-539"></a><span>      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.cxt</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-540"></a><span>      </span><a href="#local-6989586621679044447"><span class="hs-identifier hs-var">className</span></a><span>
</span><a name="line-541"></a><span>      </span><span class="hs-special">[</span><a href="#local-6989586621679044434"><span class="hs-identifier hs-var">mVar</span></a><span class="hs-special">]</span><span>
</span><a name="line-542"></a><span>      </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-543"></a><span>      </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">TH.sigD</span><span> </span><a href="#local-6989586621679044448"><span class="hs-identifier hs-var">methodName</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679044449"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-544"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679044448"><a href="#local-6989586621679044448"><span class="hs-identifier">methodName</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679044449"><a href="#local-6989586621679044449"><span class="hs-identifier">ty</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679044446"><span class="hs-identifier hs-var">methodSpecs</span></a><span>
</span><a name="line-545"></a><span>      </span><span class="hs-special">]</span><span>
</span><a name="line-546"></a><span>  </span><span class="hs-keyword">let</span><span>
</span><a name="line-547"></a><span>    </span><a name="local-6989586621679044465"><a href="#local-6989586621679044465"><span class="hs-identifier">methodDec</span></a></a><span> </span><a name="local-6989586621679044466"><a href="#local-6989586621679044466"><span class="hs-identifier">methodName</span></a></a><span> </span><a name="local-6989586621679044467"><a href="#local-6989586621679044467"><span class="hs-identifier">fieldName</span></a></a><span> </span><a name="local-6989586621679044468"><a href="#local-6989586621679044468"><span class="hs-identifier">tyArgList</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-548"></a><span>      </span><span class="hs-identifier hs-var">TH.funD</span><span> </span><a href="#local-6989586621679044466"><span class="hs-identifier hs-var">methodName</span></a><span>
</span><a name="line-549"></a><span>        </span><span class="hs-special">[</span><span class="hs-keyword">do</span><span>
</span><a name="line-550"></a><span>          </span><a name="local-6989586621679044471"><a href="#local-6989586621679044471"><span class="hs-identifier">argNames</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-551"></a><span>            </span><span class="hs-identifier hs-var">for</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zip</span><span> </span><span class="hs-special">[</span><span class="hs-number">0</span><span class="hs-glyph">..</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621679044468"><span class="hs-identifier hs-var">tyArgList</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679044469"><a href="#local-6989586621679044469"><span class="hs-identifier">i</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679044470"><a href="#local-6989586621679044470"><span class="hs-identifier">_tyArg</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-552"></a><span>              </span><span class="hs-identifier hs-var">TH.newName</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;arg&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679044469"><span class="hs-identifier hs-var">i</span></a><span class="hs-glyph">::</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-553"></a><span>          </span><span class="hs-keyword">let</span><span>
</span><a name="line-554"></a><span>            </span><a name="local-6989586621679044472"><a href="#local-6989586621679044472"><span class="hs-identifier">pats</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">TH.varP</span><span> </span><a href="#local-6989586621679044471"><span class="hs-identifier hs-var">argNames</span></a><span>
</span><a name="line-555"></a><span>            </span><a name="local-6989586621679044473"><a href="#local-6989586621679044473"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">TH.varE</span><span> </span><a href="#local-6989586621679044471"><span class="hs-identifier hs-var">argNames</span></a><span>
</span><a name="line-556"></a><span>            </span><a name="local-6989586621679044474"><a href="#local-6989586621679044474"><span class="hs-identifier">body</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TH.normalB</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-557"></a><span>              </span><a name="local-6989586621679044475"><a href="#local-6989586621679044475"><span class="hs-identifier">lamName</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">TH.newName</span><span> </span><span class="hs-string">&quot;cap&quot;</span><span>
</span><a name="line-558"></a><span>              </span><span class="hs-identifier hs-var">TH.appE</span><span> </span><span class="hs-special">[e|</span><a href="Monad.Capabilities.html#withCap"><span class="hs-identifier hs-var">withCap</span></a><span class="hs-special">|]</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-559"></a><span>                </span><span class="hs-identifier hs-var">TH.lam1E</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.varP</span><span> </span><a href="#local-6989586621679044475"><span class="hs-identifier hs-var">lamName</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-560"></a><span>                  </span><span class="hs-identifier hs-var">foldl1'</span><span> </span><span class="hs-identifier hs-var">TH.appE</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.varE</span><span> </span><a href="#local-6989586621679044467"><span class="hs-identifier hs-var">fieldName</span></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier hs-var">TH.varE</span><span> </span><a href="#local-6989586621679044475"><span class="hs-identifier hs-var">lamName</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679044473"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-561"></a><span>          </span><span class="hs-identifier hs-var">TH.clause</span><span> </span><a href="#local-6989586621679044472"><span class="hs-identifier hs-var">pats</span></a><span> </span><a href="#local-6989586621679044474"><span class="hs-identifier hs-var">body</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-562"></a><span>        </span><span class="hs-special">]</span><span>
</span><a name="line-563"></a><span>  </span><a name="local-6989586621679044489"><a href="#local-6989586621679044489"><span class="hs-identifier">instance_decs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">:</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-564"></a><span>    </span><a name="local-6989586621679044476"><a href="#local-6989586621679044476"><span class="hs-identifier">rVar</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">TH.newName</span><span> </span><span class="hs-string">&quot;r&quot;</span><span>
</span><a name="line-565"></a><span>    </span><a name="local-6989586621679044477"><a href="#local-6989586621679044477"><span class="hs-identifier">capsVar</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">TH.newName</span><span> </span><span class="hs-string">&quot;caps&quot;</span><span>
</span><a name="line-566"></a><span>    </span><span class="hs-identifier hs-var">TH.instanceD</span><span>
</span><a name="line-567"></a><span>      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.cxt</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">[t|</span><a href="Monad.Capabilities.html#HasCap"><span class="hs-identifier hs-type">HasCap</span></a><span> </span><span class="">$capType</span><span> </span><span class="hs-special">$(</span><span class="hs-identifier hs-var">TH.varT</span><span> </span><a href="#local-6989586621679044477"><span class="hs-identifier hs-var">capsVar</span></a><span class="hs-special">)</span><span class="hs-special">|]</span><span class="hs-special">,</span><span>
</span><a name="line-568"></a><span>                </span><span class="hs-special">[t|</span><span> </span><span class="hs-special">$(</span><span class="hs-identifier hs-var">TH.varT</span><span> </span><a href="#local-6989586621679044476"><span class="hs-identifier hs-var">rVar</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">~</span><span> </span><a href="Monad.Capabilities.html#Capabilities"><span class="hs-identifier hs-type">Capabilities</span></a><span> </span><span class="hs-special">$(</span><span class="hs-identifier hs-var">TH.varT</span><span> </span><a href="#local-6989586621679044477"><span class="hs-identifier hs-var">capsVar</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">$(</span><a href="#local-6989586621679044162"><span class="hs-identifier hs-var">tyVarBndrT'</span></a><span> </span><a href="#local-6989586621679044434"><span class="hs-identifier hs-var">mVar</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">|]</span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-569"></a><span>      </span><span class="hs-special">[t|</span><span> </span><span class="hs-special">$(</span><span class="hs-identifier hs-var">TH.conT</span><span> </span><a href="#local-6989586621679044447"><span class="hs-identifier hs-var">className</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ReaderT</span><span> </span><span class="hs-special">$(</span><span class="hs-identifier hs-var">TH.varT</span><span> </span><a href="#local-6989586621679044476"><span class="hs-identifier hs-var">rVar</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">$(</span><a href="#local-6989586621679044162"><span class="hs-identifier hs-var">tyVarBndrT'</span></a><span> </span><a href="#local-6989586621679044434"><span class="hs-identifier hs-var">mVar</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">|]</span><span>
</span><a name="line-570"></a><span>      </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621679044465"><span class="hs-identifier hs-var">methodDec</span></a><span> </span><a href="#local-6989586621679044486"><span class="hs-identifier hs-var">methodName</span></a><span> </span><a href="#local-6989586621679044487"><span class="hs-identifier hs-var">fieldName</span></a><span> </span><a href="#local-6989586621679044488"><span class="hs-identifier hs-var">tyArgList</span></a><span>
</span><a name="line-571"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679044486"><a href="#local-6989586621679044486"><span class="hs-identifier">methodName</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679044487"><a href="#local-6989586621679044487"><span class="hs-identifier">fieldName</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679044488"><a href="#local-6989586621679044488"><span class="hs-identifier">tyArgList</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679044446"><span class="hs-identifier hs-var">methodSpecs</span></a><span>
</span><a name="line-572"></a><span>      </span><span class="hs-special">]</span><span>
</span><a name="line-573"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679044464"><span class="hs-identifier hs-var">class_decs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679044489"><span class="hs-identifier hs-var">instance_decs</span></a><span class="hs-special">)</span><span>
</span><a name="line-574"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-575"></a><span>    </span><a name="local-6989586621679044161"><a href="#local-6989586621679044161"><span class="hs-identifier">tyVarBndrT</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.PlainTV</span><span> </span><a name="local-6989586621679044163"><a href="#local-6989586621679044163"><span class="hs-identifier">name</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TH.varT</span><span> </span><a href="#local-6989586621679044163"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-576"></a><span>    </span><span class="hs-identifier">tyVarBndrT</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.KindedTV</span><span> </span><a name="local-6989586621679044164"><a href="#local-6989586621679044164"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621679044165"><a href="#local-6989586621679044165"><span class="hs-identifier">k</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TH.sigT</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.varT</span><span> </span><a href="#local-6989586621679044164"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679044165"><span class="hs-identifier hs-var">k</span></a><span>
</span><a name="line-577"></a><span>
</span><a name="line-578"></a><span>    </span><a name="local-6989586621679044162"><a href="#local-6989586621679044162"><span class="hs-identifier">tyVarBndrT'</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.PlainTV</span><span> </span><a name="local-6989586621679044235"><a href="#local-6989586621679044235"><span class="hs-identifier">name</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TH.varT</span><span> </span><a href="#local-6989586621679044235"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-579"></a><span>    </span><span class="hs-identifier">tyVarBndrT'</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.KindedTV</span><span> </span><a name="local-6989586621679044236"><a href="#local-6989586621679044236"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TH.varT</span><span> </span><a href="#local-6989586621679044236"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-580"></a></pre></body></html>