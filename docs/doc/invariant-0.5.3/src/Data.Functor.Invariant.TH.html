<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><a name="line-2"></a><span>
</span><a name="line-3"></a><span class="hs-comment">{-|
Module:      Data.Functor.Invariant.TH
Copyright:   (C) 2012-2017 Nicolas Frisby, (C) 2015-2017 Ryan Scott
License:     BSD-style (see the file LICENSE)
Maintainer:  Ryan Scott
Portability: Template Haskell

Functions to mechanically derive 'Data.Functor.Invariant.Invariant'
or 'Data.Functor.Invariant.Invariant2' instances,
or to splice 'Data.Functor.Invariant.invmap' or
'Data.Functor.Invariant.invmap2' into Haskell source code. You need to enable
the @TemplateHaskell@ language extension in order to use this module.
-}</span><span>
</span><a name="line-16"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Data.Functor.Invariant.TH</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-17"></a><span>      </span><span class="hs-comment">-- * @deriveInvariant(2)@</span><span>
</span><a name="line-18"></a><span>      </span><span class="hs-comment">-- $deriveInvariant</span><span>
</span><a name="line-19"></a><span>      </span><a href="Data.Functor.Invariant.TH.html#deriveInvariant"><span class="hs-identifier hs-var">deriveInvariant</span></a><span>
</span><a name="line-20"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Data.Functor.Invariant.TH.html#deriveInvariantOptions"><span class="hs-identifier hs-var">deriveInvariantOptions</span></a><span>
</span><a name="line-21"></a><span>      </span><span class="hs-comment">-- $deriveInvariant2</span><span>
</span><a name="line-22"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Data.Functor.Invariant.TH.html#deriveInvariant2"><span class="hs-identifier hs-var">deriveInvariant2</span></a><span>
</span><a name="line-23"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Data.Functor.Invariant.TH.html#deriveInvariant2Options"><span class="hs-identifier hs-var">deriveInvariant2Options</span></a><span>
</span><a name="line-24"></a><span>      </span><span class="hs-comment">-- * @makeInvmap(2)@</span><span>
</span><a name="line-25"></a><span>      </span><span class="hs-comment">-- $make</span><span>
</span><a name="line-26"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Data.Functor.Invariant.TH.html#makeInvmap"><span class="hs-identifier hs-var">makeInvmap</span></a><span>
</span><a name="line-27"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Data.Functor.Invariant.TH.html#makeInvmapOptions"><span class="hs-identifier hs-var">makeInvmapOptions</span></a><span>
</span><a name="line-28"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Data.Functor.Invariant.TH.html#makeInvmap2"><span class="hs-identifier hs-var">makeInvmap2</span></a><span>
</span><a name="line-29"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Data.Functor.Invariant.TH.html#makeInvmap2Options"><span class="hs-identifier hs-var">makeInvmap2Options</span></a><span>
</span><a name="line-30"></a><span>      </span><span class="hs-comment">-- * 'Options'</span><span>
</span><a name="line-31"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Data.Functor.Invariant.TH.html#Options"><span class="hs-identifier hs-type">Options</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-32"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Data.Functor.Invariant.TH.html#defaultOptions"><span class="hs-identifier hs-var">defaultOptions</span></a><span>
</span><a name="line-33"></a><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-34"></a><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Monad</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unless</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">when</span><span class="hs-special">)</span><span>
</span><a name="line-36"></a><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span>           </span><a href="Data.Functor.Invariant.TH.Internal.html"><span class="hs-identifier">Data.Functor.Invariant.TH.Internal</span></a><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.List</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Map</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromList</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">keys</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">lookup</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">size</span><span class="hs-special">)</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Maybe</span><span>
</span><a name="line-41"></a><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Language.Haskell.TH.Datatype</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Language.Haskell.TH.Lib</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Language.Haskell.TH.Ppr</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Language.Haskell.TH.Syntax</span><span>
</span><a name="line-46"></a><span>
</span><a name="line-47"></a><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><a name="line-48"></a><span class="hs-comment">-- User-facing API</span><span>
</span><a name="line-49"></a><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><a name="line-50"></a><span>
</span><a name="line-51"></a><span class="hs-comment">-- | Options that further configure how the functions in</span><span>
</span><a name="line-52"></a><span class="hs-comment">-- &quot;Data.Functor.Invariant.TH&quot; should behave.</span><span>
</span><a name="line-53"></a><span class="hs-keyword">newtype</span><span> </span><a name="Options"><a href="Data.Functor.Invariant.TH.html#Options"><span class="hs-identifier">Options</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Options"><a href="Data.Functor.Invariant.TH.html#Options"><span class="hs-identifier">Options</span></a></a><span>
</span><a name="line-54"></a><span>  </span><span class="hs-special">{</span><span> </span><a name="emptyCaseBehavior"><a href="Data.Functor.Invariant.TH.html#emptyCaseBehavior"><span class="hs-identifier">emptyCaseBehavior</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-55"></a><span>    </span><span class="hs-comment">-- ^ If 'True', derived instances for empty data types (i.e., ones with</span><span>
</span><a name="line-56"></a><span>    </span><span class="hs-comment">--   no data constructors) will use the @EmptyCase@ language extension.</span><span>
</span><a name="line-57"></a><span>    </span><span class="hs-comment">--   If 'False', derived instances will simply use 'seq' instead.</span><span>
</span><a name="line-58"></a><span>    </span><span class="hs-comment">--   (This has no effect on GHCs before 7.8, since @EmptyCase@ is only</span><span>
</span><a name="line-59"></a><span>    </span><span class="hs-comment">--   available in 7.8 or later.)</span><span>
</span><a name="line-60"></a><span>  </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Read</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Show</span><span class="hs-special">)</span><span>
</span><a name="line-61"></a><span>
</span><a name="line-62"></a><span class="hs-comment">-- | Conservative 'Options' that doesn't attempt to use @EmptyCase@ (to</span><span>
</span><a name="line-63"></a><span class="hs-comment">-- prevent users from having to enable that extension at use sites.)</span><span>
</span><a name="line-64"></a><span class="hs-identifier">defaultOptions</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Functor.Invariant.TH.html#Options"><span class="hs-identifier hs-type">Options</span></a><span>
</span><a name="line-65"></a><a name="defaultOptions"><a href="Data.Functor.Invariant.TH.html#defaultOptions"><span class="hs-identifier">defaultOptions</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Functor.Invariant.TH.html#Options"><span class="hs-identifier hs-var">Options</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">emptyCaseBehavior</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-66"></a><span>
</span><a name="line-67"></a><span class="hs-comment">{- $deriveInvariant

'deriveInvariant' automatically generates an 'Data.Functor.Invariant.Invariant'
instance declaration for a data type, newtype, or data family instance that has
at least one type variable.  This emulates what would (hypothetically) happen
if you could attach a @deriving 'Data.Functor.Invariant.Invariant'@ clause to
the end of a data declaration. Examples:

@
&amp;#123;-&amp;#35; LANGUAGE TemplateHaskell &amp;#35;-&amp;#125;
import Data.Functor.Invariant.TH

data Pair a = Pair a a
$('deriveInvariant' ''Pair) -- instance Invariant Pair where ...

newtype Alt f a = Alt (f a)
$('deriveInvariant' ''Alt) -- instance Invariant f =&gt; Invariant (Alt f) where ...
@

If you are using @template-haskell-2.7.0.0@ or later (i.e., GHC 7.4 or later),
'deriveInvariant' can also be used to derive 'Data.Functor.Invariant.Invariant' instances for data family
instances (which requires the @-XTypeFamilies@ extension). To do so, pass the name of
a data or newtype instance constructor to 'deriveInvariant'.  Note that the generated
code may require the @-XFlexibleInstances@ extension. Some examples:

@
&amp;#123;-&amp;#35; LANGUAGE FlexibleInstances, TemplateHaskell, TypeFamilies &amp;#35;-&amp;#125;
import Data.Functor.Invariant.TH

class AssocClass a b where
    data AssocData a b
instance AssocClass Int b where
    data AssocData Int b = AssocDataInt1 Int | AssocDataInt2 b Int
$('deriveInvariant' 'AssocDataInt1) -- instance Invariant (AssocData Int) where ...
-- Alternatively, one could use $(deriveInvariant 'AssocDataInt2)

data family DataFam a b
newtype instance DataFam () b = DataFamB b
$('deriveInvariant' 'DataFamB) -- instance Invariant (DataFam ())
@

Note that there are some limitations:

* The 'Name' argument to 'deriveInvariant' must not be a type synonym.

* With 'deriveInvariant', the argument's last type variable must be of kind @*@.
  For other ones, type variables of kind @* -&gt; *@ are assumed to require an
  'Data.Functor.Invariant.Invariant' context. For more complicated scenarios,
  use 'makeInvmap'.

* If using the @-XDatatypeContexts@, @-XExistentialQuantification@, or @-XGADTs@
  extensions, a constraint cannot mention the last type variable. For example,
  @data Illegal a where I :: Ord a =&gt; a -&gt; Illegal a@ cannot have a derived
  'Data.Functor.Invariant.Invariant' instance.

* If the last type variable is used within a data field of a constructor, it must only
  be used in the last argument of the data type constructor. For example, @data Legal a
  = Legal (Either Int a)@ can have a derived 'Data.Functor.Invariant.Invariant' instance,
  but @data Illegal a = Illegal (Either a a)@ cannot.

* Data family instances must be able to eta-reduce the last type variable. In other
  words, if you have a instance of the form:

  @
  data family Family a1 ... an t
  data instance Family e1 ... e2 v = ...
  @

  Then the following conditions must hold:

  1. @v@ must be a type variable.
  2. @v@ must not be mentioned in any of @e1@, ..., @e2@.

-}</span><span>
</span><a name="line-141"></a><span>
</span><a name="line-142"></a><span class="hs-comment">-- | Generates an 'Data.Functor.Invariant.Invariant' instance declaration for the given</span><span>
</span><a name="line-143"></a><span class="hs-comment">-- data type or data family instance.</span><span>
</span><a name="line-144"></a><span class="hs-identifier">deriveInvariant</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span>
</span><a name="line-145"></a><a name="deriveInvariant"><a href="Data.Functor.Invariant.TH.html#deriveInvariant"><span class="hs-identifier">deriveInvariant</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Functor.Invariant.TH.html#deriveInvariantOptions"><span class="hs-identifier hs-var">deriveInvariantOptions</span></a><span> </span><a href="Data.Functor.Invariant.TH.html#defaultOptions"><span class="hs-identifier hs-var">defaultOptions</span></a><span>
</span><a name="line-146"></a><span>
</span><a name="line-147"></a><span class="hs-comment">-- | Like 'deriveInvariant', but takes an 'Options' argument.</span><span>
</span><a name="line-148"></a><span class="hs-identifier">deriveInvariantOptions</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Functor.Invariant.TH.html#Options"><span class="hs-identifier hs-type">Options</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span>
</span><a name="line-149"></a><a name="deriveInvariantOptions"><a href="Data.Functor.Invariant.TH.html#deriveInvariantOptions"><span class="hs-identifier">deriveInvariantOptions</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Functor.Invariant.TH.html#deriveInvariantClass"><span class="hs-identifier hs-var">deriveInvariantClass</span></a><span> </span><a href="Data.Functor.Invariant.TH.Internal.html#Invariant"><span class="hs-identifier hs-var">Invariant</span></a><span>
</span><a name="line-150"></a><span>
</span><a name="line-151"></a><span class="hs-comment">{- $deriveInvariant2

'deriveInvariant2' automatically generates an
'Data.Functor.Invariant.Invariant2' instance declaration for a data type,
newtype, or data family instance that has at least two type variables.  This
emulates what would (hypothetically) happen if you could attach a @deriving
'Data.Functor.Invariant.Invariant2'@ clause to the end of a data declaration.
Examples:

@
&amp;#123;-&amp;#35; LANGUAGE TemplateHaskell &amp;#35;-&amp;#125;
import Data.Functor.Invariant.TH

data OneOrNone a b = OneL a | OneR b | None
$('deriveInvariant2' ''OneOrNone) -- instance Invariant2 OneOrNone where ...

newtype Alt2 f a b = Alt2 (f a b)
$('deriveInvariant2' ''Alt2) -- instance Invariant2 f =&gt; Invariant2 (Alt2 f) where ...
@

The same restrictions that apply to 'deriveInvariant' also apply to 'deriveInvariant2',
with some caveats:

* With 'deriveInvariant2', the last type variables must both be of kind @*@. For other
  ones, type variables of kind @* -&gt; *@ are assumed to require an 'Data.Functor.Invariant.Invariant'
  constraint, and type variables of kind @* -&gt; * -&gt; *@ are assumed to require an
  'Data.Functor.Invariant.Invariant2' constraint. For more complicated scenarios, use 'makeInvmap2'.

* If using the @-XDatatypeContexts@, @-XExistentialQuantification@, or @-XGADTs@
  extensions, a constraint cannot mention either of the last two type variables. For
  example, @data Illegal2 a b where I2 :: Ord a =&gt; a -&gt; b -&gt; Illegal2 a b@ cannot
  have a derived 'Data.Functor.Invariant.Invariant2' instance.

* If either of the last two type variables is used within a data field of a constructor,
  it must only be used in the last two arguments of the data type constructor. For
  example, @data Legal a b = Legal (Int, Int, a, b)@ can have a derived
  'Data.Functor.Invariant.Invariant2' instance, but
  @data Illegal a b = Illegal (a, b, a, b)@ cannot.

* Data family instances must be able to eta-reduce the last two type variables. In other
  words, if you have a instance of the form:

  @
  data family Family a1 ... an t1 t2
  data instance Family e1 ... e2 v1 v2 = ...
  @

  Then the following conditions must hold:

  1. @v1@ and @v2@ must be distinct type variables.
  2. Neither @v1@ not @v2@ must be mentioned in any of @e1@, ..., @e2@.

-}</span><span>
</span><a name="line-204"></a><span>
</span><a name="line-205"></a><span class="hs-comment">-- | Generates an 'Data.Functor.Invariant.Invariant2' instance declaration for</span><span>
</span><a name="line-206"></a><span class="hs-comment">-- the given data type or data family instance.</span><span>
</span><a name="line-207"></a><span class="hs-identifier">deriveInvariant2</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span>
</span><a name="line-208"></a><a name="deriveInvariant2"><a href="Data.Functor.Invariant.TH.html#deriveInvariant2"><span class="hs-identifier">deriveInvariant2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Functor.Invariant.TH.html#deriveInvariant2Options"><span class="hs-identifier hs-var">deriveInvariant2Options</span></a><span> </span><a href="Data.Functor.Invariant.TH.html#defaultOptions"><span class="hs-identifier hs-var">defaultOptions</span></a><span>
</span><a name="line-209"></a><span>
</span><a name="line-210"></a><span class="hs-comment">-- | Like 'deriveInvariant2', but takes an 'Options' argument.</span><span>
</span><a name="line-211"></a><span class="hs-identifier">deriveInvariant2Options</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Functor.Invariant.TH.html#Options"><span class="hs-identifier hs-type">Options</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span>
</span><a name="line-212"></a><a name="deriveInvariant2Options"><a href="Data.Functor.Invariant.TH.html#deriveInvariant2Options"><span class="hs-identifier">deriveInvariant2Options</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Functor.Invariant.TH.html#deriveInvariantClass"><span class="hs-identifier hs-var">deriveInvariantClass</span></a><span> </span><a href="Data.Functor.Invariant.TH.Internal.html#Invariant2"><span class="hs-identifier hs-var">Invariant2</span></a><span>
</span><a name="line-213"></a><span>
</span><a name="line-214"></a><span class="hs-comment">{- $make

There may be scenarios in which you want to @invmap@ over an arbitrary data
type or data family instance without having to make the type an instance of
'Data.Functor.Invariant.Invariant'. For these cases, this module provides
several functions (all prefixed with @make-@) that splice the appropriate
lambda expression into your source code. Example:

This is particularly useful for creating instances for sophisticated data
types. For example, 'deriveInvariant' cannot infer the correct type context for
@newtype HigherKinded f a b c = HigherKinded (f a b c)@, since @f@ is of kind
@* -&gt; * -&gt; * -&gt; *@. However, it is still possible to create an
'Data.Functor.Invariant.Invariant' instance for @HigherKinded@ without too much
trouble using 'makeInvmap':

@
&amp;#123;-&amp;#35; LANGUAGE FlexibleContexts, TemplateHaskell &amp;#35;-&amp;#125;
import Data.Functor.Invariant
import Data.Functor.Invariant.TH

newtype HigherKinded f a b c = HigherKinded (f a b c)

instance Invariant (f a b) =&gt; Invariant (HigherKinded f a b) where
    invmap = $(makeInvmap ''HigherKinded)
@

-}</span><span>
</span><a name="line-241"></a><span>
</span><a name="line-242"></a><span class="hs-comment">-- | Generates a lambda expression which behaves like</span><span>
</span><a name="line-243"></a><span class="hs-comment">-- 'Data.Functor.Invariant.invmap' (without requiring an</span><span>
</span><a name="line-244"></a><span class="hs-comment">-- 'Data.Functor.Invariant.Invariant' instance).</span><span>
</span><a name="line-245"></a><span class="hs-identifier">makeInvmap</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Exp</span><span>
</span><a name="line-246"></a><a name="makeInvmap"><a href="Data.Functor.Invariant.TH.html#makeInvmap"><span class="hs-identifier">makeInvmap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Functor.Invariant.TH.html#makeInvmapOptions"><span class="hs-identifier hs-var">makeInvmapOptions</span></a><span> </span><a href="Data.Functor.Invariant.TH.html#defaultOptions"><span class="hs-identifier hs-var">defaultOptions</span></a><span>
</span><a name="line-247"></a><span>
</span><a name="line-248"></a><span class="hs-comment">-- | Like 'makeInvmap', but takes an 'Options' argument.</span><span>
</span><a name="line-249"></a><span class="hs-identifier">makeInvmapOptions</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Functor.Invariant.TH.html#Options"><span class="hs-identifier hs-type">Options</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Exp</span><span>
</span><a name="line-250"></a><a name="makeInvmapOptions"><a href="Data.Functor.Invariant.TH.html#makeInvmapOptions"><span class="hs-identifier">makeInvmapOptions</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Functor.Invariant.TH.html#makeInvmapClass"><span class="hs-identifier hs-var">makeInvmapClass</span></a><span> </span><a href="Data.Functor.Invariant.TH.Internal.html#Invariant"><span class="hs-identifier hs-var">Invariant</span></a><span>
</span><a name="line-251"></a><span>
</span><a name="line-252"></a><span class="hs-comment">-- | Generates a lambda expression which behaves like</span><span>
</span><a name="line-253"></a><span class="hs-comment">-- 'Data.Functor.Invariant.invmap2' (without requiring an</span><span>
</span><a name="line-254"></a><span class="hs-comment">-- 'Data.Functor.Invariant.Invariant2' instance).</span><span>
</span><a name="line-255"></a><span class="hs-identifier">makeInvmap2</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Exp</span><span>
</span><a name="line-256"></a><a name="makeInvmap2"><a href="Data.Functor.Invariant.TH.html#makeInvmap2"><span class="hs-identifier">makeInvmap2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Functor.Invariant.TH.html#makeInvmap2Options"><span class="hs-identifier hs-var">makeInvmap2Options</span></a><span> </span><a href="Data.Functor.Invariant.TH.html#defaultOptions"><span class="hs-identifier hs-var">defaultOptions</span></a><span>
</span><a name="line-257"></a><span>
</span><a name="line-258"></a><span class="hs-comment">-- | Like 'makeInvmap2', but takes an 'Options' argument.</span><span>
</span><a name="line-259"></a><span class="hs-identifier">makeInvmap2Options</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Functor.Invariant.TH.html#Options"><span class="hs-identifier hs-type">Options</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Exp</span><span>
</span><a name="line-260"></a><a name="makeInvmap2Options"><a href="Data.Functor.Invariant.TH.html#makeInvmap2Options"><span class="hs-identifier">makeInvmap2Options</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Functor.Invariant.TH.html#makeInvmapClass"><span class="hs-identifier hs-var">makeInvmapClass</span></a><span> </span><a href="Data.Functor.Invariant.TH.Internal.html#Invariant2"><span class="hs-identifier hs-var">Invariant2</span></a><span>
</span><a name="line-261"></a><span>
</span><a name="line-262"></a><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><a name="line-263"></a><span class="hs-comment">-- Code generation</span><span>
</span><a name="line-264"></a><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><a name="line-265"></a><span>
</span><a name="line-266"></a><span class="hs-comment">-- | Derive an Invariant(2) instance declaration (depending on the InvariantClass</span><span>
</span><a name="line-267"></a><span class="hs-comment">-- argument's value).</span><span>
</span><a name="line-268"></a><span class="hs-identifier">deriveInvariantClass</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Functor.Invariant.TH.Internal.html#InvariantClass"><span class="hs-identifier hs-type">InvariantClass</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Functor.Invariant.TH.html#Options"><span class="hs-identifier hs-type">Options</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span>
</span><a name="line-269"></a><a name="deriveInvariantClass"><a href="Data.Functor.Invariant.TH.html#deriveInvariantClass"><span class="hs-identifier">deriveInvariantClass</span></a></a><span> </span><a name="local-6989586621679099963"><a href="#local-6989586621679099963"><span class="hs-identifier">iClass</span></a></a><span> </span><a name="local-6989586621679099964"><a href="#local-6989586621679099964"><span class="hs-identifier">opts</span></a></a><span> </span><a name="local-6989586621679099965"><a href="#local-6989586621679099965"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-270"></a><span>  </span><a name="local-6989586621679099966"><a href="#local-6989586621679099966"><span class="hs-identifier">info</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">reifyDatatype</span><span> </span><a href="#local-6989586621679099965"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-271"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679099966"><span class="hs-identifier hs-var">info</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-272"></a><span>    </span><span class="hs-identifier hs-var">DatatypeInfo</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">datatypeContext</span><span>   </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679099967"><a href="#local-6989586621679099967"><span class="hs-identifier">ctxt</span></a></a><span>
</span><a name="line-273"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">datatypeName</span><span>      </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679099968"><a href="#local-6989586621679099968"><span class="hs-identifier">parentName</span></a></a><span>
</span><a name="line-274"></a><span class="hs-cpp">#if MIN_VERSION_th_abstraction(0,3,0)
</span><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">datatypeInstTypes</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679099969"><a href="#local-6989586621679099969"><span class="hs-identifier">instTys</span></a></a><span>
</span><a name="line-276"></a><span class="hs-cpp">#else
</span><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">datatypeVars</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">instTys</span><span>
</span><a name="line-278"></a><span class="hs-cpp">#endif
</span><span class="">                 , datatypeVariant   = variant
                 , datatypeCons      = cons
                 } -&gt; do
      (instanceCxt, instanceType)
        &lt;- buildTypeInstance iClass parentName ctxt instTys variant
      (:[]) `fmap` instanceD (return instanceCxt)
                             (return instanceType)
                             (invmapDecs iClass opts parentName instTys cons)

-- | Generates a declaration defining the primary function corresponding to a
-- particular class (invmap for Invariant and invmap2 for Invariant2).
invmapDecs :: InvariantClass -&gt; Options -&gt; Name -&gt; [Type] -&gt; [ConstructorInfo]
           -&gt; [Q Dec]
invmapDecs iClass opts parentName instTys cons =
    [ funD (invmapName iClass)
           [ clause []
                    (normalB $ makeInvmapForCons iClass opts parentName instTys cons)
                    []
           ]
    ]

-- | Generates a lambda expression which behaves like invmap (for Invariant),
-- or invmap2 (for Invariant2).
makeInvmapClass :: InvariantClass -&gt; Options -&gt; Name -&gt; Q Exp
makeInvmapClass iClass opts name = do
  info &lt;- reifyDatatype name
  case info of
    DatatypeInfo { datatypeContext   = ctxt
                 , datatypeName      = parentName
</span><span class="hs-cpp">#if MIN_VERSION_th_abstraction(0,3,0)
</span><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">datatypeInstTypes</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679100621"><a href="#local-6989586621679100621"><span class="hs-identifier">instTys</span></a></a><span>
</span><a name="line-310"></a><span class="hs-cpp">#else
</span><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">datatypeVars</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">instTys</span><span>
</span><a name="line-312"></a><span class="hs-cpp">#endif
</span><span class="">                 , datatypeVariant   = variant
                 , datatypeCons      = cons
                 } -&gt;
      -- We force buildTypeInstance here since it performs some checks for whether
      -- or not the provided datatype can actually have invmap/invmap2
      -- implemented for it, and produces errors if it can't.
      buildTypeInstance iClass parentName ctxt instTys variant
        &gt;&gt; makeInvmapForCons iClass opts parentName instTys cons

-- | Generates a lambda expression for invmap(2) for the given constructors.
-- All constructors must be from the same type.
makeInvmapForCons :: InvariantClass -&gt; Options -&gt; Name -&gt; [Type] -&gt; [ConstructorInfo]
                  -&gt; Q Exp
makeInvmapForCons iClass opts _parentName instTys cons = do
    value      &lt;- newName &quot;value&quot;
    covMaps    &lt;- newNameList &quot;covMap&quot; numNbs
    contraMaps &lt;- newNameList &quot;contraMap&quot; numNbs

    let mapFuns    = zip covMaps contraMaps
        lastTyVars = map varTToName $ drop (length instTys - fromEnum iClass) instTys
        tvMap      = Map.fromList $ zip lastTyVars mapFuns
        argNames   = concat (transpose [covMaps, contraMaps]) ++ [value]
    lamE (map varP argNames)
        . appsE
        $ [ varE $ invmapConstName iClass
          , makeFun value tvMap
          ] ++ map varE argNames
  where
    numNbs :: Int
    numNbs = fromEnum iClass

    makeFun :: Name -&gt; TyVarMap -&gt; Q Exp
    makeFun value tvMap = do
</span><span class="hs-cpp">#if MIN_VERSION_template_haskell(2,9,0)
</span><span>      </span><a name="local-6989586621679100634"><a href="#local-6989586621679100634"><span class="hs-identifier">roles</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">reifyRoles</span><span> </span><a href="#local-6989586621679100626"><span class="hs-identifier hs-var">_parentName</span></a><span>
</span><a name="line-348"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679100635"><a href="#local-6989586621679100635"><span class="hs-identifier">rroles</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679100634"><span class="hs-identifier hs-var">roles</span></a><span>
</span><a name="line-349"></a><span class="hs-cpp">#endif
</span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-351"></a><span>        </span><span class="hs-identifier">_</span><span>
</span><a name="line-352"></a><span>
</span><a name="line-353"></a><span class="hs-cpp">#if MIN_VERSION_template_haskell(2,9,0)
</span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679100635"><span class="hs-identifier hs-var">rroles</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><a href="#local-6989586621679100629"><span class="hs-identifier hs-var">numNbs</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-355"></a><span>            </span><span class="hs-special">(</span><span class="hs-identifier hs-var">all</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">PhantomR</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">take</span><span> </span><a href="#local-6989586621679100629"><span class="hs-identifier hs-var">numNbs</span></a><span> </span><a href="#local-6989586621679100635"><span class="hs-identifier hs-var">rroles</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-356"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">varE</span><span> </span><a href="Data.Functor.Invariant.TH.Internal.html#coerceValName"><span class="hs-identifier hs-var">coerceValName</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">appE</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">varE</span><span> </span><a href="#local-6989586621679100632"><span class="hs-identifier hs-var">value</span></a><span>
</span><a name="line-357"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-359"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621679100628"><span class="hs-identifier hs-var">cons</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier">emptyCaseBehavior</span><span> </span><a href="#local-6989586621679100625"><span class="hs-identifier hs-var">opts</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621679100631"><span class="hs-identifier hs-var">ghc7'8OrLater</span></a><span>
</span><a name="line-360"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">caseE</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">varE</span><span> </span><a href="#local-6989586621679100632"><span class="hs-identifier hs-var">value</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-361"></a><span>
</span><a name="line-362"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621679100628"><span class="hs-identifier hs-var">cons</span></a><span>
</span><a name="line-363"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">appE</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">varE</span><span> </span><a href="Data.Functor.Invariant.TH.Internal.html#seqValName"><span class="hs-identifier hs-var">seqValName</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">varE</span><span> </span><a href="#local-6989586621679100632"><span class="hs-identifier hs-var">value</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">appE</span><span class="hs-special">`</span><span>
</span><a name="line-364"></a><span>            </span><span class="hs-identifier hs-var">appE</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">varE</span><span> </span><a href="Data.Functor.Invariant.TH.Internal.html#errorValName"><span class="hs-identifier hs-var">errorValName</span></a><span class="hs-special">)</span><span>
</span><a name="line-365"></a><span>                 </span><span class="hs-special">(</span><span class="hs-identifier hs-var">stringE</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Void &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">nameBase</span><span> </span><span class="hs-special">(</span><a href="Data.Functor.Invariant.TH.Internal.html#invmapName"><span class="hs-identifier hs-var">invmapName</span></a><span> </span><a href="#local-6989586621679100624"><span class="hs-identifier hs-var">iClass</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-366"></a><span>
</span><a name="line-367"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-368"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">caseE</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">varE</span><span> </span><a href="#local-6989586621679100632"><span class="hs-identifier hs-var">value</span></a><span class="hs-special">)</span><span>
</span><a name="line-369"></a><span>                  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="Data.Functor.Invariant.TH.html#makeInvmapForCon"><span class="hs-identifier hs-var">makeInvmapForCon</span></a><span> </span><a href="#local-6989586621679100624"><span class="hs-identifier hs-var">iClass</span></a><span> </span><a href="#local-6989586621679100633"><span class="hs-identifier hs-var">tvMap</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679100628"><span class="hs-identifier hs-var">cons</span></a><span class="hs-special">)</span><span>
</span><a name="line-370"></a><span>
</span><a name="line-371"></a><span>    </span><span class="hs-identifier">ghc7'8OrLater</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-372"></a><span class="hs-cpp">#if __GLASGOW_HASKELL__ &gt;= 708
</span><span>    </span><a name="local-6989586621679100631"><a href="#local-6989586621679100631"><span class="hs-identifier">ghc7'8OrLater</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-374"></a><span class="hs-cpp">#else
</span><span>    </span><span class="hs-identifier">ghc7'8OrLater</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">False</span><span>
</span><a name="line-376"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-378"></a><span class="hs-comment">-- | Generates a lambda expression for invmap(2) for a single constructor.</span><span>
</span><a name="line-379"></a><span class="hs-identifier">makeInvmapForCon</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Functor.Invariant.TH.Internal.html#InvariantClass"><span class="hs-identifier hs-type">InvariantClass</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Functor.Invariant.TH.Internal.html#TyVarMap"><span class="hs-identifier hs-type">TyVarMap</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ConstructorInfo</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Match</span><span>
</span><a name="line-380"></a><a name="makeInvmapForCon"><a href="Data.Functor.Invariant.TH.html#makeInvmapForCon"><span class="hs-identifier">makeInvmapForCon</span></a></a><span> </span><a name="local-6989586621679100795"><a href="#local-6989586621679100795"><span class="hs-identifier">iClass</span></a></a><span> </span><a name="local-6989586621679100796"><a href="#local-6989586621679100796"><span class="hs-identifier">tvMap</span></a></a><span>
</span><a name="line-381"></a><span>  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ConstructorInfo</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">constructorName</span><span>    </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679100797"><a href="#local-6989586621679100797"><span class="hs-identifier">conName</span></a></a><span>
</span><a name="line-382"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">constructorContext</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679100798"><a href="#local-6989586621679100798"><span class="hs-identifier">ctxt</span></a></a><span>
</span><a name="line-383"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">constructorFields</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679100799"><a href="#local-6989586621679100799"><span class="hs-identifier">ts</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-384"></a><span>    </span><a name="local-6989586621679100800"><a href="#local-6989586621679100800"><span class="hs-identifier">ts'</span></a></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-identifier hs-var">resolveTypeSynonyms</span><span> </span><a href="#local-6989586621679100799"><span class="hs-identifier hs-var">ts</span></a><span>
</span><a name="line-385"></a><span>    </span><a name="local-6989586621679100801"><a href="#local-6989586621679100801"><span class="hs-identifier">argNames</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Functor.Invariant.TH.Internal.html#newNameList"><span class="hs-identifier hs-var">newNameList</span></a><span> </span><span class="hs-string">&quot;arg&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679100800"><span class="hs-identifier hs-var">ts'</span></a><span>
</span><a name="line-386"></a><span>    </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><a href="Data.Functor.Invariant.TH.Internal.html#predMentionsName"><span class="hs-identifier hs-var">predMentionsName</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">Map.keys</span><span> </span><a href="#local-6989586621679100796"><span class="hs-identifier hs-var">tvMap</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679100798"><span class="hs-identifier hs-var">ctxt</span></a><span>
</span><a name="line-387"></a><span>         </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">Map.size</span><span> </span><a href="#local-6989586621679100796"><span class="hs-identifier hs-var">tvMap</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-identifier hs-var">fromEnum</span><span> </span><a href="#local-6989586621679100795"><span class="hs-identifier hs-var">iClass</span></a><span>
</span><a name="line-388"></a><span>       </span><span class="hs-keyword">then</span><span> </span><a href="Data.Functor.Invariant.TH.html#existentialContextError"><span class="hs-identifier hs-var">existentialContextError</span></a><span> </span><a href="#local-6989586621679100797"><span class="hs-identifier hs-var">conName</span></a><span>
</span><a name="line-389"></a><span>       </span><span class="hs-keyword">else</span><span> </span><a href="Data.Functor.Invariant.TH.html#makeInvmapForArgs"><span class="hs-identifier hs-var">makeInvmapForArgs</span></a><span> </span><a href="#local-6989586621679100795"><span class="hs-identifier hs-var">iClass</span></a><span> </span><a href="#local-6989586621679100796"><span class="hs-identifier hs-var">tvMap</span></a><span> </span><a href="#local-6989586621679100797"><span class="hs-identifier hs-var">conName</span></a><span> </span><a href="#local-6989586621679100800"><span class="hs-identifier hs-var">ts'</span></a><span> </span><a href="#local-6989586621679100801"><span class="hs-identifier hs-var">argNames</span></a><span>
</span><a name="line-390"></a><span>
</span><a name="line-391"></a><span class="hs-identifier">makeInvmapForArgs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Functor.Invariant.TH.Internal.html#InvariantClass"><span class="hs-identifier hs-type">InvariantClass</span></a><span>
</span><a name="line-392"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Functor.Invariant.TH.Internal.html#TyVarMap"><span class="hs-identifier hs-type">TyVarMap</span></a><span>
</span><a name="line-393"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-394"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span>
</span><a name="line-395"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span>
</span><a name="line-396"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Match</span><span>
</span><a name="line-397"></a><a name="makeInvmapForArgs"><a href="Data.Functor.Invariant.TH.html#makeInvmapForArgs"><span class="hs-identifier">makeInvmapForArgs</span></a></a><span> </span><a name="local-6989586621679100802"><a href="#local-6989586621679100802"><span class="hs-identifier">iClass</span></a></a><span> </span><a name="local-6989586621679100803"><a href="#local-6989586621679100803"><span class="hs-identifier">tvMap</span></a></a><span> </span><a name="local-6989586621679100804"><a href="#local-6989586621679100804"><span class="hs-identifier">conName</span></a></a><span> </span><a name="local-6989586621679100805"><a href="#local-6989586621679100805"><span class="hs-identifier">tys</span></a></a><span> </span><a name="local-6989586621679100806"><a href="#local-6989586621679100806"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-398"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">mappedArgs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Exp</span><span class="hs-special">]</span><span>
</span><a name="line-399"></a><span>        </span><a name="local-6989586621679100807"><a href="#local-6989586621679100807"><span class="hs-identifier">mappedArgs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">zipWith</span><span> </span><span class="hs-special">(</span><a href="Data.Functor.Invariant.TH.html#makeInvmapForArg"><span class="hs-identifier hs-var">makeInvmapForArg</span></a><span> </span><a href="#local-6989586621679100802"><span class="hs-identifier hs-var">iClass</span></a><span> </span><a href="#local-6989586621679100804"><span class="hs-identifier hs-var">conName</span></a><span> </span><a href="#local-6989586621679100803"><span class="hs-identifier hs-var">tvMap</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679100805"><span class="hs-identifier hs-var">tys</span></a><span> </span><a href="#local-6989586621679100806"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-400"></a><span>     </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">match</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">conP</span><span> </span><a href="#local-6989586621679100804"><span class="hs-identifier hs-var">conName</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">varP</span><span> </span><a href="#local-6989586621679100806"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-401"></a><span>              </span><span class="hs-special">(</span><span class="hs-identifier hs-var">normalB</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">appsE</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">conE</span><span> </span><a href="#local-6989586621679100804"><span class="hs-identifier hs-var">conName</span></a><span class="hs-glyph">:</span><a href="#local-6989586621679100807"><span class="hs-identifier hs-var">mappedArgs</span></a><span class="hs-special">)</span><span>
</span><a name="line-402"></a><span>              </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-403"></a><span>
</span><a name="line-404"></a><span class="hs-comment">-- | Generates a lambda expression for invmap(2) for an argument of a constructor.</span><span>
</span><a name="line-405"></a><span class="hs-identifier">makeInvmapForArg</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Functor.Invariant.TH.Internal.html#InvariantClass"><span class="hs-identifier hs-type">InvariantClass</span></a><span>
</span><a name="line-406"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-407"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Functor.Invariant.TH.Internal.html#TyVarMap"><span class="hs-identifier hs-type">TyVarMap</span></a><span>
</span><a name="line-408"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span>
</span><a name="line-409"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-410"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Exp</span><span>
</span><a name="line-411"></a><a name="makeInvmapForArg"><a href="Data.Functor.Invariant.TH.html#makeInvmapForArg"><span class="hs-identifier">makeInvmapForArg</span></a></a><span> </span><a name="local-6989586621679100808"><a href="#local-6989586621679100808"><span class="hs-identifier">iClass</span></a></a><span> </span><a name="local-6989586621679100809"><a href="#local-6989586621679100809"><span class="hs-identifier">conName</span></a></a><span> </span><a name="local-6989586621679100810"><a href="#local-6989586621679100810"><span class="hs-identifier">tvis</span></a></a><span> </span><a name="local-6989586621679100811"><a href="#local-6989586621679100811"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621679100812"><a href="#local-6989586621679100812"><span class="hs-identifier">tyExpName</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-412"></a><span>    </span><span class="hs-identifier hs-var">appE</span><span> </span><span class="hs-special">(</span><a href="Data.Functor.Invariant.TH.html#makeInvmapForType"><span class="hs-identifier hs-var">makeInvmapForType</span></a><span> </span><a href="#local-6989586621679100808"><span class="hs-identifier hs-var">iClass</span></a><span> </span><a href="#local-6989586621679100809"><span class="hs-identifier hs-var">conName</span></a><span> </span><a href="#local-6989586621679100810"><span class="hs-identifier hs-var">tvis</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a href="#local-6989586621679100811"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">varE</span><span> </span><a href="#local-6989586621679100812"><span class="hs-identifier hs-var">tyExpName</span></a><span class="hs-special">)</span><span>
</span><a name="line-413"></a><span>
</span><a name="line-414"></a><span class="hs-comment">-- | Generates a lambda expression for invmap(2) for a specific type.</span><span>
</span><a name="line-415"></a><span class="hs-comment">-- The generated expression depends on the number of type variables.</span><span>
</span><a name="line-416"></a><span class="hs-identifier">makeInvmapForType</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Functor.Invariant.TH.Internal.html#InvariantClass"><span class="hs-identifier hs-type">InvariantClass</span></a><span>
</span><a name="line-417"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-418"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Functor.Invariant.TH.Internal.html#TyVarMap"><span class="hs-identifier hs-type">TyVarMap</span></a><span>
</span><a name="line-419"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-420"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span>
</span><a name="line-421"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Exp</span><span>
</span><a name="line-422"></a><a name="makeInvmapForType"><a href="Data.Functor.Invariant.TH.html#makeInvmapForType"><span class="hs-identifier">makeInvmapForType</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679100813"><a href="#local-6989586621679100813"><span class="hs-identifier">tvMap</span></a></a><span> </span><a name="local-6989586621679100814"><a href="#local-6989586621679100814"><span class="hs-identifier">covariant</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">VarT</span><span> </span><a name="local-6989586621679100815"><a href="#local-6989586621679100815"><span class="hs-identifier">tyName</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-423"></a><span>    </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><a href="#local-6989586621679100815"><span class="hs-identifier hs-var">tyName</span></a><span> </span><a href="#local-6989586621679100813"><span class="hs-identifier hs-var">tvMap</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-424"></a><span>         </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679100816"><a href="#local-6989586621679100816"><span class="hs-identifier">covMap</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679100817"><a href="#local-6989586621679100817"><span class="hs-identifier">contraMap</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-425"></a><span>             </span><span class="hs-identifier hs-var">varE</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679100814"><span class="hs-identifier hs-var">covariant</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621679100816"><span class="hs-identifier hs-var">covMap</span></a><span> </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621679100817"><span class="hs-identifier hs-var">contraMap</span></a><span>
</span><a name="line-426"></a><span>         </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- Produce a lambda expression rather than id, addressing Trac #7436</span><span>
</span><a name="line-427"></a><span>             </span><a name="local-6989586621679100818"><a href="#local-6989586621679100818"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newName</span><span> </span><span class="hs-string">&quot;x&quot;</span><span>
</span><a name="line-428"></a><span>             </span><span class="hs-identifier hs-var">lamE</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">varP</span><span> </span><a href="#local-6989586621679100818"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">varE</span><span> </span><a href="#local-6989586621679100818"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-429"></a><span class="hs-identifier">makeInvmapForType</span><span> </span><a name="local-6989586621679100819"><a href="#local-6989586621679100819"><span class="hs-identifier">iClass</span></a></a><span> </span><a name="local-6989586621679100820"><a href="#local-6989586621679100820"><span class="hs-identifier">conName</span></a></a><span> </span><a name="local-6989586621679100821"><a href="#local-6989586621679100821"><span class="hs-identifier">tvMap</span></a></a><span> </span><a name="local-6989586621679100822"><a href="#local-6989586621679100822"><span class="hs-identifier">covariant</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SigT</span><span> </span><a name="local-6989586621679100823"><a href="#local-6989586621679100823"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-430"></a><span>    </span><a href="Data.Functor.Invariant.TH.html#makeInvmapForType"><span class="hs-identifier hs-var">makeInvmapForType</span></a><span> </span><a href="#local-6989586621679100819"><span class="hs-identifier hs-var">iClass</span></a><span> </span><a href="#local-6989586621679100820"><span class="hs-identifier hs-var">conName</span></a><span> </span><a href="#local-6989586621679100821"><span class="hs-identifier hs-var">tvMap</span></a><span> </span><a href="#local-6989586621679100822"><span class="hs-identifier hs-var">covariant</span></a><span> </span><a href="#local-6989586621679100823"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-431"></a><span class="hs-identifier">makeInvmapForType</span><span> </span><a name="local-6989586621679100824"><a href="#local-6989586621679100824"><span class="hs-identifier">iClass</span></a></a><span> </span><a name="local-6989586621679100825"><a href="#local-6989586621679100825"><span class="hs-identifier">conName</span></a></a><span> </span><a name="local-6989586621679100826"><a href="#local-6989586621679100826"><span class="hs-identifier">tvMap</span></a></a><span> </span><a name="local-6989586621679100827"><a href="#local-6989586621679100827"><span class="hs-identifier">covariant</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ForallT</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679100828"><a href="#local-6989586621679100828"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-432"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Data.Functor.Invariant.TH.html#makeInvmapForType"><span class="hs-identifier hs-var">makeInvmapForType</span></a><span> </span><a href="#local-6989586621679100824"><span class="hs-identifier hs-var">iClass</span></a><span> </span><a href="#local-6989586621679100825"><span class="hs-identifier hs-var">conName</span></a><span> </span><a href="#local-6989586621679100826"><span class="hs-identifier hs-var">tvMap</span></a><span> </span><a href="#local-6989586621679100827"><span class="hs-identifier hs-var">covariant</span></a><span> </span><a href="#local-6989586621679100828"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-433"></a><span class="hs-identifier">makeInvmapForType</span><span> </span><a name="local-6989586621679100829"><a href="#local-6989586621679100829"><span class="hs-identifier">iClass</span></a></a><span> </span><a name="local-6989586621679100830"><a href="#local-6989586621679100830"><span class="hs-identifier">conName</span></a></a><span> </span><a name="local-6989586621679100831"><a href="#local-6989586621679100831"><span class="hs-identifier">tvMap</span></a></a><span> </span><a name="local-6989586621679100832"><a href="#local-6989586621679100832"><span class="hs-identifier">covariant</span></a></a><span> </span><a name="local-6989586621679100833"><a href="#local-6989586621679100833"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-434"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">tyCon</span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span>
</span><a name="line-435"></a><span>        </span><span class="hs-identifier">tyArgs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span>
</span><a name="line-436"></a><span>        </span><a name="local-6989586621679100834"><a href="#local-6989586621679100834"><span class="hs-identifier">tyCon</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679100835"><a href="#local-6989586621679100835"><span class="hs-identifier">tyArgs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Functor.Invariant.TH.Internal.html#unapplyTy"><span class="hs-identifier hs-var">unapplyTy</span></a><span> </span><a href="#local-6989586621679100833"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-437"></a><span>
</span><a name="line-438"></a><span>        </span><span class="hs-identifier">numLastArgs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-439"></a><span>        </span><a name="local-6989586621679100836"><a href="#local-6989586621679100836"><span class="hs-identifier">numLastArgs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">min</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromEnum</span><span> </span><a href="#local-6989586621679100829"><span class="hs-identifier hs-var">iClass</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679100835"><span class="hs-identifier hs-var">tyArgs</span></a><span class="hs-special">)</span><span>
</span><a name="line-440"></a><span>
</span><a name="line-441"></a><span>        </span><span class="hs-identifier">lhsArgs</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rhsArgs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span>
</span><a name="line-442"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621679100837"><a href="#local-6989586621679100837"><span class="hs-identifier">lhsArgs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679100838"><a href="#local-6989586621679100838"><span class="hs-identifier">rhsArgs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">splitAt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679100835"><span class="hs-identifier hs-var">tyArgs</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679100836"><span class="hs-identifier hs-var">numLastArgs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679100835"><span class="hs-identifier hs-var">tyArgs</span></a><span>
</span><a name="line-443"></a><span>
</span><a name="line-444"></a><span>        </span><span class="hs-identifier">tyVarNames</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span>
</span><a name="line-445"></a><span>        </span><a name="local-6989586621679100839"><a href="#local-6989586621679100839"><span class="hs-identifier">tyVarNames</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.keys</span><span> </span><a href="#local-6989586621679100831"><span class="hs-identifier hs-var">tvMap</span></a><span>
</span><a name="line-446"></a><span>
</span><a name="line-447"></a><span>        </span><span class="hs-identifier">doubleMap</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Exp</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Exp</span><span class="hs-special">]</span><span>
</span><a name="line-448"></a><span>        </span><a name="local-6989586621679100840"><a href="#local-6989586621679100840"><span class="hs-identifier">doubleMap</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-449"></a><span>        </span><span class="hs-identifier">doubleMap</span><span> </span><a name="local-6989586621679100844"><a href="#local-6989586621679100844"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679100845"><a href="#local-6989586621679100845"><span class="hs-identifier">t</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679100846"><a href="#local-6989586621679100846"><span class="hs-identifier">ts</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679100844"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679100832"><span class="hs-identifier hs-var">covariant</span></a><span> </span><a href="#local-6989586621679100845"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679100844"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621679100832"><span class="hs-identifier hs-var">covariant</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679100845"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679100840"><span class="hs-identifier hs-var">doubleMap</span></a><span> </span><a href="#local-6989586621679100844"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679100846"><span class="hs-identifier hs-var">ts</span></a><span>
</span><a name="line-450"></a><span>
</span><a name="line-451"></a><span>        </span><span class="hs-identifier">mentionsTyArgs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-452"></a><span>        </span><a name="local-6989586621679100841"><a href="#local-6989586621679100841"><span class="hs-identifier">mentionsTyArgs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><a href="Data.Functor.Invariant.TH.Internal.html#mentionsName"><span class="hs-identifier hs-var">mentionsName</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679100839"><span class="hs-identifier hs-var">tyVarNames</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679100835"><span class="hs-identifier hs-var">tyArgs</span></a><span>
</span><a name="line-453"></a><span>
</span><a name="line-454"></a><span>        </span><span class="hs-identifier">makeInvmapTuple</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Pat</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Pat</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Exp</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Exp</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Exp</span><span>
</span><a name="line-455"></a><span>        </span><a name="local-6989586621679100842"><a href="#local-6989586621679100842"><span class="hs-identifier">makeInvmapTuple</span></a></a><span> </span><a name="local-6989586621679100847"><a href="#local-6989586621679100847"><span class="hs-identifier">mkTupP</span></a></a><span> </span><a name="local-6989586621679100848"><a href="#local-6989586621679100848"><span class="hs-identifier">mkTupE</span></a></a><span> </span><a name="local-6989586621679100849"><a href="#local-6989586621679100849"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-456"></a><span>            </span><a name="local-6989586621679100850"><a href="#local-6989586621679100850"><span class="hs-identifier">x</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newName</span><span> </span><span class="hs-string">&quot;x&quot;</span><span>
</span><a name="line-457"></a><span>            </span><a name="local-6989586621679100851"><a href="#local-6989586621679100851"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Functor.Invariant.TH.Internal.html#newNameList"><span class="hs-identifier hs-var">newNameList</span></a><span> </span><span class="hs-string">&quot;x&quot;</span><span> </span><a href="#local-6989586621679100849"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-458"></a><span>            </span><span class="hs-identifier hs-var">lamE</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">varP</span><span> </span><a href="#local-6989586621679100850"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">caseE</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">varE</span><span> </span><a href="#local-6989586621679100850"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-459"></a><span>                </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">match</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679100847"><span class="hs-identifier hs-var">mkTupP</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">varP</span><span> </span><a href="#local-6989586621679100851"><span class="hs-identifier hs-var">xs</span></a><span class="hs-special">)</span><span>
</span><a name="line-460"></a><span>                        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">normalB</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679100848"><span class="hs-identifier hs-var">mkTupE</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">zipWith</span><span> </span><a href="#local-6989586621679100843"><span class="hs-identifier hs-var">makeInvmapTupleField</span></a><span> </span><a href="#local-6989586621679100835"><span class="hs-identifier hs-var">tyArgs</span></a><span> </span><a href="#local-6989586621679100851"><span class="hs-identifier hs-var">xs</span></a><span class="hs-special">)</span><span>
</span><a name="line-461"></a><span>                        </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-462"></a><span>                </span><span class="hs-special">]</span><span>
</span><a name="line-463"></a><span>
</span><a name="line-464"></a><span>        </span><span class="hs-identifier">makeInvmapTupleField</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Exp</span><span>
</span><a name="line-465"></a><span>        </span><a name="local-6989586621679100843"><a href="#local-6989586621679100843"><span class="hs-identifier">makeInvmapTupleField</span></a></a><span> </span><a name="local-6989586621679100852"><a href="#local-6989586621679100852"><span class="hs-identifier">fieldTy</span></a></a><span> </span><a name="local-6989586621679100853"><a href="#local-6989586621679100853"><span class="hs-identifier">fieldName</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-466"></a><span>            </span><span class="hs-identifier hs-var">appE</span><span> </span><span class="hs-special">(</span><a href="Data.Functor.Invariant.TH.html#makeInvmapForType"><span class="hs-identifier hs-var">makeInvmapForType</span></a><span> </span><a href="#local-6989586621679100829"><span class="hs-identifier hs-var">iClass</span></a><span> </span><a href="#local-6989586621679100830"><span class="hs-identifier hs-var">conName</span></a><span> </span><a href="#local-6989586621679100831"><span class="hs-identifier hs-var">tvMap</span></a><span> </span><a href="#local-6989586621679100832"><span class="hs-identifier hs-var">covariant</span></a><span> </span><a href="#local-6989586621679100852"><span class="hs-identifier hs-var">fieldTy</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">varE</span><span> </span><a href="#local-6989586621679100853"><span class="hs-identifier hs-var">fieldName</span></a><span>
</span><a name="line-467"></a><span>
</span><a name="line-468"></a><span>     </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679100834"><span class="hs-identifier hs-var">tyCon</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-469"></a><span>          </span><span class="hs-identifier hs-var">ArrowT</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679100841"><span class="hs-identifier hs-var">mentionsTyArgs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-470"></a><span>              </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">[</span><a name="local-6989586621679100854"><a href="#local-6989586621679100854"><span class="hs-identifier">argTy</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679100855"><a href="#local-6989586621679100855"><span class="hs-identifier">resTy</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679100835"><span class="hs-identifier hs-var">tyArgs</span></a><span>
</span><a name="line-471"></a><span>               </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621679100856"><a href="#local-6989586621679100856"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newName</span><span> </span><span class="hs-string">&quot;x&quot;</span><span>
</span><a name="line-472"></a><span>                     </span><a name="local-6989586621679100857"><a href="#local-6989586621679100857"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newName</span><span> </span><span class="hs-string">&quot;b&quot;</span><span>
</span><a name="line-473"></a><span>                     </span><span class="hs-identifier hs-var">lamE</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">varP</span><span> </span><a href="#local-6989586621679100856"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">varP</span><span> </span><a href="#local-6989586621679100857"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-474"></a><span>                       </span><a href="Data.Functor.Invariant.TH.html#makeInvmapForType"><span class="hs-identifier hs-var">makeInvmapForType</span></a><span> </span><a href="#local-6989586621679100829"><span class="hs-identifier hs-var">iClass</span></a><span> </span><a href="#local-6989586621679100830"><span class="hs-identifier hs-var">conName</span></a><span> </span><a href="#local-6989586621679100831"><span class="hs-identifier hs-var">tvMap</span></a><span> </span><a href="#local-6989586621679100832"><span class="hs-identifier hs-var">covariant</span></a><span> </span><a href="#local-6989586621679100855"><span class="hs-identifier hs-var">resTy</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">appE</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">varE</span><span> </span><a href="#local-6989586621679100856"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">appE</span><span class="hs-special">`</span><span>
</span><a name="line-475"></a><span>                         </span><span class="hs-special">(</span><a href="Data.Functor.Invariant.TH.html#makeInvmapForType"><span class="hs-identifier hs-var">makeInvmapForType</span></a><span> </span><a href="#local-6989586621679100829"><span class="hs-identifier hs-var">iClass</span></a><span> </span><a href="#local-6989586621679100830"><span class="hs-identifier hs-var">conName</span></a><span> </span><a href="#local-6989586621679100831"><span class="hs-identifier hs-var">tvMap</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621679100832"><span class="hs-identifier hs-var">covariant</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679100854"><span class="hs-identifier hs-var">argTy</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">appE</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">varE</span><span> </span><a href="#local-6989586621679100857"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-476"></a><span class="hs-cpp">#if MIN_VERSION_template_haskell(2,6,0)
</span><span>          </span><span class="hs-identifier hs-var">UnboxedTupleT</span><span> </span><a name="local-6989586621679100858"><a href="#local-6989586621679100858"><span class="hs-identifier">n</span></a></a><span>
</span><a name="line-478"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679100858"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621679100841"><span class="hs-identifier hs-var">mentionsTyArgs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679100842"><span class="hs-identifier hs-var">makeInvmapTuple</span></a><span> </span><span class="hs-identifier hs-var">unboxedTupP</span><span> </span><span class="hs-identifier hs-var">unboxedTupE</span><span> </span><a href="#local-6989586621679100858"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-479"></a><span class="hs-cpp">#endif
</span><span>          </span><span class="hs-identifier hs-var">TupleT</span><span> </span><a name="local-6989586621679100859"><a href="#local-6989586621679100859"><span class="hs-identifier">n</span></a></a><span>
</span><a name="line-481"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679100859"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621679100841"><span class="hs-identifier hs-var">mentionsTyArgs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679100842"><span class="hs-identifier hs-var">makeInvmapTuple</span></a><span> </span><span class="hs-identifier hs-var">tupP</span><span> </span><span class="hs-identifier hs-var">tupE</span><span> </span><a href="#local-6989586621679100859"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-482"></a><span>          </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-483"></a><span>              </span><a name="local-6989586621679100860"><a href="#local-6989586621679100860"><span class="hs-identifier">itf</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Functor.Invariant.TH.Internal.html#isTyFamily"><span class="hs-identifier hs-var">isTyFamily</span></a><span> </span><a href="#local-6989586621679100834"><span class="hs-identifier hs-var">tyCon</span></a><span>
</span><a name="line-484"></a><span>              </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><a href="Data.Functor.Invariant.TH.Internal.html#mentionsName"><span class="hs-identifier hs-var">mentionsName</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679100839"><span class="hs-identifier hs-var">tyVarNames</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679100837"><span class="hs-identifier hs-var">lhsArgs</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679100860"><span class="hs-identifier hs-var">itf</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621679100841"><span class="hs-identifier hs-var">mentionsTyArgs</span></a><span class="hs-special">)</span><span>
</span><a name="line-485"></a><span>                   </span><span class="hs-keyword">then</span><span> </span><a href="Data.Functor.Invariant.TH.html#outOfPlaceTyVarError"><span class="hs-identifier hs-var">outOfPlaceTyVarError</span></a><span> </span><a href="#local-6989586621679100830"><span class="hs-identifier hs-var">conName</span></a><span> </span><a href="#local-6989586621679100839"><span class="hs-identifier hs-var">tyVarNames</span></a><span>
</span><a name="line-486"></a><span>                   </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><a href="Data.Functor.Invariant.TH.Internal.html#mentionsName"><span class="hs-identifier hs-var">mentionsName</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679100839"><span class="hs-identifier hs-var">tyVarNames</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679100838"><span class="hs-identifier hs-var">rhsArgs</span></a><span>
</span><a name="line-487"></a><span>                        </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">appsE</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-488"></a><span>                             </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">varE</span><span> </span><span class="hs-special">(</span><a href="Data.Functor.Invariant.TH.Internal.html#invmapName"><span class="hs-identifier hs-var">invmapName</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">toEnum</span><span> </span><a href="#local-6989586621679100836"><span class="hs-identifier hs-var">numLastArgs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-489"></a><span>                             </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679100840"><span class="hs-identifier hs-var">doubleMap</span></a><span> </span><span class="hs-special">(</span><a href="Data.Functor.Invariant.TH.html#makeInvmapForType"><span class="hs-identifier hs-var">makeInvmapForType</span></a><span> </span><a href="#local-6989586621679100829"><span class="hs-identifier hs-var">iClass</span></a><span> </span><a href="#local-6989586621679100830"><span class="hs-identifier hs-var">conName</span></a><span> </span><a href="#local-6989586621679100831"><span class="hs-identifier hs-var">tvMap</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679100838"><span class="hs-identifier hs-var">rhsArgs</span></a><span>
</span><a name="line-490"></a><span>                             </span><span class="hs-special">)</span><span>
</span><a name="line-491"></a><span>                        </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621679100861"><a href="#local-6989586621679100861"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newName</span><span> </span><span class="hs-string">&quot;x&quot;</span><span>
</span><a name="line-492"></a><span>                                </span><span class="hs-identifier hs-var">lamE</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">varP</span><span> </span><a href="#local-6989586621679100861"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">varE</span><span> </span><a href="#local-6989586621679100861"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-493"></a><span>
</span><a name="line-494"></a><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><a name="line-495"></a><span class="hs-comment">-- Template Haskell reifying and AST manipulation</span><span>
</span><a name="line-496"></a><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><a name="line-497"></a><span>
</span><a name="line-498"></a><span class="hs-comment">-- For the given Types, generate an instance context and head. Coming up with</span><span>
</span><a name="line-499"></a><span class="hs-comment">-- the instance type isn't as simple as dropping the last types, as you need to</span><span>
</span><a name="line-500"></a><span class="hs-comment">-- be wary of kinds being instantiated with *.</span><span>
</span><a name="line-501"></a><span class="hs-comment">-- See Note [Type inference in derived instances]</span><span>
</span><a name="line-502"></a><span class="hs-identifier">buildTypeInstance</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Functor.Invariant.TH.Internal.html#InvariantClass"><span class="hs-identifier hs-type">InvariantClass</span></a><span>
</span><a name="line-503"></a><span>                  </span><span class="hs-comment">-- ^ Invariant or Invariant2</span><span>
</span><a name="line-504"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-505"></a><span>                  </span><span class="hs-comment">-- ^ The type constructor or data family name</span><span>
</span><a name="line-506"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Cxt</span><span>
</span><a name="line-507"></a><span>                  </span><span class="hs-comment">-- ^ The datatype context</span><span>
</span><a name="line-508"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span>
</span><a name="line-509"></a><span>                  </span><span class="hs-comment">-- ^ The types to instantiate the instance with</span><span>
</span><a name="line-510"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DatatypeVariant</span><span>
</span><a name="line-511"></a><span>                  </span><span class="hs-comment">-- ^ Are we dealing with a data family instance or not</span><span>
</span><a name="line-512"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Cxt</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Type</span><span class="hs-special">)</span><span>
</span><a name="line-513"></a><a name="buildTypeInstance"><a href="Data.Functor.Invariant.TH.html#buildTypeInstance"><span class="hs-identifier">buildTypeInstance</span></a></a><span> </span><a name="local-6989586621679100862"><a href="#local-6989586621679100862"><span class="hs-identifier">iClass</span></a></a><span> </span><a name="local-6989586621679100863"><a href="#local-6989586621679100863"><span class="hs-identifier">tyConName</span></a></a><span> </span><a name="local-6989586621679100864"><a href="#local-6989586621679100864"><span class="hs-identifier">dataCxt</span></a></a><span> </span><a name="local-6989586621679100865"><a href="#local-6989586621679100865"><span class="hs-identifier">varTysOrig</span></a></a><span> </span><a name="local-6989586621679100866"><a href="#local-6989586621679100866"><span class="hs-identifier">variant</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-514"></a><span>    </span><span class="hs-comment">-- Make sure to expand through type/kind synonyms! Otherwise, the</span><span>
</span><a name="line-515"></a><span>    </span><span class="hs-comment">-- eta-reduction check might get tripped up over type variables in a</span><span>
</span><a name="line-516"></a><span>    </span><span class="hs-comment">-- synonym that are actually dropped.</span><span>
</span><a name="line-517"></a><span>    </span><span class="hs-comment">-- (See GHC Trac #11416 for a scenario where this actually happened.)</span><span>
</span><a name="line-518"></a><span>    </span><a name="local-6989586621679100867"><a href="#local-6989586621679100867"><span class="hs-identifier">varTysExp</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-identifier hs-var">resolveTypeSynonyms</span><span> </span><a href="#local-6989586621679100865"><span class="hs-identifier hs-var">varTysOrig</span></a><span>
</span><a name="line-519"></a><span>
</span><a name="line-520"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">remainingLength</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-521"></a><span>        </span><a name="local-6989586621679100868"><a href="#local-6989586621679100868"><span class="hs-identifier">remainingLength</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679100865"><span class="hs-identifier hs-var">varTysOrig</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-identifier hs-var">fromEnum</span><span> </span><a href="#local-6989586621679100862"><span class="hs-identifier hs-var">iClass</span></a><span>
</span><a name="line-522"></a><span>
</span><a name="line-523"></a><span>        </span><span class="hs-identifier">droppedTysExp</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span>
</span><a name="line-524"></a><span>        </span><a name="local-6989586621679100869"><a href="#local-6989586621679100869"><span class="hs-identifier">droppedTysExp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">drop</span><span> </span><a href="#local-6989586621679100868"><span class="hs-identifier hs-var">remainingLength</span></a><span> </span><a href="#local-6989586621679100867"><span class="hs-identifier hs-var">varTysExp</span></a><span>
</span><a name="line-525"></a><span>
</span><a name="line-526"></a><span>        </span><span class="hs-identifier">droppedStarKindStati</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Data.Functor.Invariant.TH.Internal.html#StarKindStatus"><span class="hs-identifier hs-type">StarKindStatus</span></a><span class="hs-special">]</span><span>
</span><a name="line-527"></a><span>        </span><a name="local-6989586621679100870"><a href="#local-6989586621679100870"><span class="hs-identifier">droppedStarKindStati</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="Data.Functor.Invariant.TH.Internal.html#canRealizeKindStar"><span class="hs-identifier hs-var">canRealizeKindStar</span></a><span> </span><a href="#local-6989586621679100869"><span class="hs-identifier hs-var">droppedTysExp</span></a><span>
</span><a name="line-528"></a><span>
</span><a name="line-529"></a><span>    </span><span class="hs-comment">-- Check there are enough types to drop and that all of them are either of</span><span>
</span><a name="line-530"></a><span>    </span><span class="hs-comment">-- kind * or kind k (for some kind variable k). If not, throw an error.</span><span>
</span><a name="line-531"></a><span>    </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679100868"><span class="hs-identifier hs-var">remainingLength</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">==</span><span> </span><a href="Data.Functor.Invariant.TH.Internal.html#NotKindStar"><span class="hs-identifier hs-var">NotKindStar</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679100870"><span class="hs-identifier hs-var">droppedStarKindStati</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-532"></a><span>      </span><a href="Data.Functor.Invariant.TH.html#derivingKindError"><span class="hs-identifier hs-var">derivingKindError</span></a><span> </span><a href="#local-6989586621679100862"><span class="hs-identifier hs-var">iClass</span></a><span> </span><a href="#local-6989586621679100863"><span class="hs-identifier hs-var">tyConName</span></a><span>
</span><a name="line-533"></a><span>
</span><a name="line-534"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">droppedKindVarNames</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span>
</span><a name="line-535"></a><span>        </span><a name="local-6989586621679100871"><a href="#local-6989586621679100871"><span class="hs-identifier">droppedKindVarNames</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Functor.Invariant.TH.Internal.html#catKindVarNames"><span class="hs-identifier hs-var">catKindVarNames</span></a><span> </span><a href="#local-6989586621679100870"><span class="hs-identifier hs-var">droppedStarKindStati</span></a><span>
</span><a name="line-536"></a><span>
</span><a name="line-537"></a><span>        </span><span class="hs-comment">-- Substitute kind * for any dropped kind variables</span><span>
</span><a name="line-538"></a><span>        </span><span class="hs-identifier">varTysExpSubst</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span>
</span><a name="line-539"></a><span>        </span><a name="local-6989586621679100872"><a href="#local-6989586621679100872"><span class="hs-identifier">varTysExpSubst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="Data.Functor.Invariant.TH.Internal.html#substNamesWithKindStar"><span class="hs-identifier hs-var">substNamesWithKindStar</span></a><span> </span><a href="#local-6989586621679100871"><span class="hs-identifier hs-var">droppedKindVarNames</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679100867"><span class="hs-identifier hs-var">varTysExp</span></a><span>
</span><a name="line-540"></a><span>
</span><a name="line-541"></a><span>        </span><span class="hs-identifier">remainingTysExpSubst</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">droppedTysExpSubst</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span>
</span><a name="line-542"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621679100873"><a href="#local-6989586621679100873"><span class="hs-identifier">remainingTysExpSubst</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679100874"><a href="#local-6989586621679100874"><span class="hs-identifier">droppedTysExpSubst</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-543"></a><span>          </span><span class="hs-identifier hs-var">splitAt</span><span> </span><a href="#local-6989586621679100868"><span class="hs-identifier hs-var">remainingLength</span></a><span> </span><a href="#local-6989586621679100872"><span class="hs-identifier hs-var">varTysExpSubst</span></a><span>
</span><a name="line-544"></a><span>
</span><a name="line-545"></a><span>        </span><span class="hs-comment">-- All of the type variables mentioned in the dropped types</span><span>
</span><a name="line-546"></a><span>        </span><span class="hs-comment">-- (post-synonym expansion)</span><span>
</span><a name="line-547"></a><span>        </span><span class="hs-identifier">droppedTyVarNames</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span>
</span><a name="line-548"></a><span>        </span><a name="local-6989586621679100875"><a href="#local-6989586621679100875"><span class="hs-identifier">droppedTyVarNames</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">freeVariables</span><span> </span><a href="#local-6989586621679100874"><span class="hs-identifier hs-var">droppedTysExpSubst</span></a><span>
</span><a name="line-549"></a><span>
</span><a name="line-550"></a><span>    </span><span class="hs-comment">-- If any of the dropped types were polykinded, ensure that there are of kind *</span><span>
</span><a name="line-551"></a><span>    </span><span class="hs-comment">-- after substituting * for the dropped kind variables. If not, throw an error.</span><span>
</span><a name="line-552"></a><span>    </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">all</span><span> </span><a href="Data.Functor.Invariant.TH.Internal.html#hasKindStar"><span class="hs-identifier hs-var">hasKindStar</span></a><span> </span><a href="#local-6989586621679100874"><span class="hs-identifier hs-var">droppedTysExpSubst</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-553"></a><span>      </span><a href="Data.Functor.Invariant.TH.html#derivingKindError"><span class="hs-identifier hs-var">derivingKindError</span></a><span> </span><a href="#local-6989586621679100862"><span class="hs-identifier hs-var">iClass</span></a><span> </span><a href="#local-6989586621679100863"><span class="hs-identifier hs-var">tyConName</span></a><span>
</span><a name="line-554"></a><span>
</span><a name="line-555"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">preds</span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Pred</span><span class="hs-special">]</span><span>
</span><a name="line-556"></a><span>        </span><span class="hs-identifier">kvNames</span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-557"></a><span>        </span><span class="hs-identifier">kvNames'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span>
</span><a name="line-558"></a><span>        </span><span class="hs-comment">-- Derive instance constraints (and any kind variables which are specialized</span><span>
</span><a name="line-559"></a><span>        </span><span class="hs-comment">-- to * in those constraints)</span><span>
</span><a name="line-560"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621679100876"><a href="#local-6989586621679100876"><span class="hs-identifier">preds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679100877"><a href="#local-6989586621679100877"><span class="hs-identifier">kvNames</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unzip</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="Data.Functor.Invariant.TH.html#deriveConstraint"><span class="hs-identifier hs-var">deriveConstraint</span></a><span> </span><a href="#local-6989586621679100862"><span class="hs-identifier hs-var">iClass</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679100873"><span class="hs-identifier hs-var">remainingTysExpSubst</span></a><span>
</span><a name="line-561"></a><span>        </span><a name="local-6989586621679100878"><a href="#local-6989586621679100878"><span class="hs-identifier">kvNames'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concat</span><span> </span><a href="#local-6989586621679100877"><span class="hs-identifier hs-var">kvNames</span></a><span>
</span><a name="line-562"></a><span>
</span><a name="line-563"></a><span>        </span><span class="hs-comment">-- Substitute the kind variables specialized in the constraints with *</span><span>
</span><a name="line-564"></a><span>        </span><span class="hs-identifier">remainingTysExpSubst'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span>
</span><a name="line-565"></a><span>        </span><a name="local-6989586621679100879"><a href="#local-6989586621679100879"><span class="hs-identifier">remainingTysExpSubst'</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-566"></a><span>          </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="Data.Functor.Invariant.TH.Internal.html#substNamesWithKindStar"><span class="hs-identifier hs-var">substNamesWithKindStar</span></a><span> </span><a href="#local-6989586621679100878"><span class="hs-identifier hs-var">kvNames'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679100873"><span class="hs-identifier hs-var">remainingTysExpSubst</span></a><span>
</span><a name="line-567"></a><span>
</span><a name="line-568"></a><span>        </span><span class="hs-comment">-- We now substitute all of the specialized-to-* kind variable names with</span><span>
</span><a name="line-569"></a><span>        </span><span class="hs-comment">-- *, but in the original types, not the synonym-expanded types. The reason</span><span>
</span><a name="line-570"></a><span>        </span><span class="hs-comment">-- we do this is a superficial one: we want the derived instance to resemble</span><span>
</span><a name="line-571"></a><span>        </span><span class="hs-comment">-- the datatype written in source code as closely as possible. For example,</span><span>
</span><a name="line-572"></a><span>        </span><span class="hs-comment">-- for the following data family instance:</span><span>
</span><a name="line-573"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-574"></a><span>        </span><span class="hs-comment">--   data family Fam a</span><span>
</span><a name="line-575"></a><span>        </span><span class="hs-comment">--   newtype instance Fam String = Fam String</span><span>
</span><a name="line-576"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-577"></a><span>        </span><span class="hs-comment">-- We'd want to generate the instance:</span><span>
</span><a name="line-578"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-579"></a><span>        </span><span class="hs-comment">--   instance C (Fam String)</span><span>
</span><a name="line-580"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-581"></a><span>        </span><span class="hs-comment">-- Not:</span><span>
</span><a name="line-582"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-583"></a><span>        </span><span class="hs-comment">--   instance C (Fam [Char])</span><span>
</span><a name="line-584"></a><span>        </span><span class="hs-identifier">remainingTysOrigSubst</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span>
</span><a name="line-585"></a><span>        </span><a name="local-6989586621679100880"><a href="#local-6989586621679100880"><span class="hs-identifier">remainingTysOrigSubst</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-586"></a><span>          </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="Data.Functor.Invariant.TH.Internal.html#substNamesWithKindStar"><span class="hs-identifier hs-var">substNamesWithKindStar</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">union</span><span> </span><a href="#local-6989586621679100871"><span class="hs-identifier hs-var">droppedKindVarNames</span></a><span> </span><a href="#local-6989586621679100878"><span class="hs-identifier hs-var">kvNames'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-587"></a><span>            </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">take</span><span> </span><a href="#local-6989586621679100868"><span class="hs-identifier hs-var">remainingLength</span></a><span> </span><a href="#local-6989586621679100865"><span class="hs-identifier hs-var">varTysOrig</span></a><span>
</span><a name="line-588"></a><span>
</span><a name="line-589"></a><span>        </span><span class="hs-identifier">isDataFamily</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-590"></a><span>        </span><a name="local-6989586621679100881"><a href="#local-6989586621679100881"><span class="hs-identifier">isDataFamily</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679100866"><span class="hs-identifier hs-var">variant</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-591"></a><span>                         </span><span class="hs-identifier hs-var">Datatype</span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-592"></a><span>                         </span><span class="hs-identifier hs-var">Newtype</span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-593"></a><span>                         </span><span class="hs-identifier hs-var">DataInstance</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-594"></a><span>                         </span><span class="hs-identifier hs-var">NewtypeInstance</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-595"></a><span>
</span><a name="line-596"></a><span>        </span><span class="hs-identifier">remainingTysOrigSubst'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span>
</span><a name="line-597"></a><span>        </span><span class="hs-comment">-- See Note [Kind signatures in derived instances] for an explanation</span><span>
</span><a name="line-598"></a><span>        </span><span class="hs-comment">-- of the isDataFamily check.</span><span>
</span><a name="line-599"></a><span>        </span><a name="local-6989586621679100882"><a href="#local-6989586621679100882"><span class="hs-identifier">remainingTysOrigSubst'</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-600"></a><span>          </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679100881"><span class="hs-identifier hs-var">isDataFamily</span></a><span>
</span><a name="line-601"></a><span>             </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621679100880"><span class="hs-identifier hs-var">remainingTysOrigSubst</span></a><span>
</span><a name="line-602"></a><span>             </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="Data.Functor.Invariant.TH.Internal.html#unSigT"><span class="hs-identifier hs-var">unSigT</span></a><span> </span><a href="#local-6989586621679100880"><span class="hs-identifier hs-var">remainingTysOrigSubst</span></a><span>
</span><a name="line-603"></a><span>
</span><a name="line-604"></a><span>        </span><span class="hs-identifier">instanceCxt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Cxt</span><span>
</span><a name="line-605"></a><span>        </span><a name="local-6989586621679100883"><a href="#local-6989586621679100883"><span class="hs-identifier">instanceCxt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">catMaybes</span><span> </span><a href="#local-6989586621679100876"><span class="hs-identifier hs-var">preds</span></a><span>
</span><a name="line-606"></a><span>
</span><a name="line-607"></a><span>        </span><span class="hs-identifier">instanceType</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span>
</span><a name="line-608"></a><span>        </span><a name="local-6989586621679100884"><a href="#local-6989586621679100884"><span class="hs-identifier">instanceType</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">AppT</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ConT</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Functor.Invariant.TH.Internal.html#invariantClassName"><span class="hs-identifier hs-var">invariantClassName</span></a><span> </span><a href="#local-6989586621679100862"><span class="hs-identifier hs-var">iClass</span></a><span class="hs-special">)</span><span>
</span><a name="line-609"></a><span>                     </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Functor.Invariant.TH.Internal.html#applyTyCon"><span class="hs-identifier hs-var">applyTyCon</span></a><span> </span><a href="#local-6989586621679100863"><span class="hs-identifier hs-var">tyConName</span></a><span> </span><a href="#local-6989586621679100882"><span class="hs-identifier hs-var">remainingTysOrigSubst'</span></a><span>
</span><a name="line-610"></a><span>
</span><a name="line-611"></a><span>    </span><span class="hs-comment">-- If the datatype context mentions any of the dropped type variables,</span><span>
</span><a name="line-612"></a><span>    </span><span class="hs-comment">-- we can't derive an instance, so throw an error.</span><span>
</span><a name="line-613"></a><span>    </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><a href="Data.Functor.Invariant.TH.Internal.html#predMentionsName"><span class="hs-identifier hs-var">predMentionsName</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679100875"><span class="hs-identifier hs-var">droppedTyVarNames</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679100864"><span class="hs-identifier hs-var">dataCxt</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-614"></a><span>      </span><a href="Data.Functor.Invariant.TH.html#datatypeContextError"><span class="hs-identifier hs-var">datatypeContextError</span></a><span> </span><a href="#local-6989586621679100863"><span class="hs-identifier hs-var">tyConName</span></a><span> </span><a href="#local-6989586621679100884"><span class="hs-identifier hs-var">instanceType</span></a><span>
</span><a name="line-615"></a><span>    </span><span class="hs-comment">-- Also ensure the dropped types can be safely eta-reduced. Otherwise,</span><span>
</span><a name="line-616"></a><span>    </span><span class="hs-comment">-- throw an error.</span><span>
</span><a name="line-617"></a><span>    </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><a href="Data.Functor.Invariant.TH.Internal.html#canEtaReduce"><span class="hs-identifier hs-var">canEtaReduce</span></a><span> </span><a href="#local-6989586621679100879"><span class="hs-identifier hs-var">remainingTysExpSubst'</span></a><span> </span><a href="#local-6989586621679100874"><span class="hs-identifier hs-var">droppedTysExpSubst</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-618"></a><span>      </span><a href="Data.Functor.Invariant.TH.html#etaReductionError"><span class="hs-identifier hs-var">etaReductionError</span></a><span> </span><a href="#local-6989586621679100884"><span class="hs-identifier hs-var">instanceType</span></a><span>
</span><a name="line-619"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679100883"><span class="hs-identifier hs-var">instanceCxt</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679100884"><span class="hs-identifier hs-var">instanceType</span></a><span class="hs-special">)</span><span>
</span><a name="line-620"></a><span>
</span><a name="line-621"></a><span class="hs-comment">-- | Attempt to derive a constraint on a Type. If successful, return</span><span>
</span><a name="line-622"></a><span class="hs-comment">-- Just the constraint and any kind variable names constrained to *.</span><span>
</span><a name="line-623"></a><span class="hs-comment">-- Otherwise, return Nothing and the empty list.</span><span>
</span><a name="line-624"></a><span class="hs-comment">--</span><span>
</span><a name="line-625"></a><span class="hs-comment">-- See Note [Type inference in derived instances] for the heuristics used to</span><span>
</span><a name="line-626"></a><span class="hs-comment">-- come up with constraints.</span><span>
</span><a name="line-627"></a><span class="hs-identifier">deriveConstraint</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Functor.Invariant.TH.Internal.html#InvariantClass"><span class="hs-identifier hs-type">InvariantClass</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Pred</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-628"></a><a name="deriveConstraint"><a href="Data.Functor.Invariant.TH.html#deriveConstraint"><span class="hs-identifier">deriveConstraint</span></a></a><span> </span><a name="local-6989586621679100885"><a href="#local-6989586621679100885"><span class="hs-identifier">iClass</span></a></a><span> </span><a name="local-6989586621679100886"><a href="#local-6989586621679100886"><span class="hs-identifier">t</span></a></a><span>
</span><a name="line-629"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="Data.Functor.Invariant.TH.Internal.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a><span> </span><a href="#local-6989586621679100886"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-630"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Data.Functor.Invariant.TH.Internal.html#hasKindVarChain"><span class="hs-identifier hs-var">hasKindVarChain</span></a><span> </span><span class="hs-number">1</span><span> </span><a href="#local-6989586621679100886"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-631"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679100888"><a href="#local-6989586621679100888"><span class="hs-identifier">ns</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679100885"><span class="hs-identifier hs-var">iClass</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><a href="Data.Functor.Invariant.TH.Internal.html#Invariant"><span class="hs-identifier hs-var">Invariant</span></a><span>
</span><a name="line-632"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="Data.Functor.Invariant.TH.Internal.html#applyClass"><span class="hs-identifier hs-var">applyClass</span></a><span> </span><a href="Data.Functor.Invariant.TH.Internal.html#invariantTypeName"><span class="hs-identifier hs-var">invariantTypeName</span></a><span> </span><a href="#local-6989586621679100887"><span class="hs-identifier hs-var">tName</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679100888"><span class="hs-identifier hs-var">ns</span></a><span class="hs-special">)</span><span>
</span><a name="line-633"></a><span>      </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Data.Functor.Invariant.TH.Internal.html#hasKindVarChain"><span class="hs-identifier hs-var">hasKindVarChain</span></a><span> </span><span class="hs-number">2</span><span> </span><a href="#local-6989586621679100886"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-634"></a><span>                </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679100889"><a href="#local-6989586621679100889"><span class="hs-identifier">ns</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679100885"><span class="hs-identifier hs-var">iClass</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="Data.Functor.Invariant.TH.Internal.html#Invariant2"><span class="hs-identifier hs-var">Invariant2</span></a><span>
</span><a name="line-635"></a><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="Data.Functor.Invariant.TH.Internal.html#applyClass"><span class="hs-identifier hs-var">applyClass</span></a><span> </span><a href="Data.Functor.Invariant.TH.Internal.html#invariant2TypeName"><span class="hs-identifier hs-var">invariant2TypeName</span></a><span> </span><a href="#local-6989586621679100887"><span class="hs-identifier hs-var">tName</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679100889"><span class="hs-identifier hs-var">ns</span></a><span class="hs-special">)</span><span>
</span><a name="line-636"></a><span>                </span><span class="hs-identifier">_</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-637"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-638"></a><span>    </span><span class="hs-identifier">tName</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-639"></a><span>    </span><a name="local-6989586621679100887"><a href="#local-6989586621679100887"><span class="hs-identifier">tName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Functor.Invariant.TH.Internal.html#varTToName"><span class="hs-identifier hs-var">varTToName</span></a><span> </span><a href="#local-6989586621679100886"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-640"></a><span>
</span><a name="line-641"></a><span class="hs-comment">{-
Note [Kind signatures in derived instances]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

It is possible to put explicit kind signatures into the derived instances, e.g.,

  instance C a =&gt; C (Data (f :: * -&gt; *)) where ...

But it is preferable to avoid this if possible. If we come up with an incorrect
kind signature (which is entirely possible, since our type inferencer is pretty
unsophisticated - see Note [Type inference in derived instances]), then GHC will
flat-out reject the instance, which is quite unfortunate.

Plain old datatypes have the advantage that you can avoid using any kind signatures
at all in their instances. This is because a datatype declaration uses all type
variables, so the types that we use in a derived instance uniquely determine their
kinds. As long as we plug in the right types, the kind inferencer can do the rest
of the work. For this reason, we use unSigT to remove all kind signatures before
splicing in the instance context and head.

Data family instances are trickier, since a data family can have two instances that
are distinguished by kind alone, e.g.,

  data family Fam (a :: k)
  data instance Fam (a :: * -&gt; *)
  data instance Fam (a :: *)

If we dropped the kind signatures for C (Fam a), then GHC will have no way of
knowing which instance we are talking about. To avoid this scenario, we always
include explicit kind signatures in data family instances. There is a chance that
the inferred kind signatures will be incorrect, but if so, we can always fall back
on the make- functions.

Note [Type inference in derived instances]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Type inference is can be tricky to get right, and we want to avoid recreating the
entirety of GHC's type inferencer in Template Haskell. For this reason, we will
probably never come up with derived instance contexts that are as accurate as
GHC's. But that doesn't mean we can't do anything! There are a couple of simple
things we can do to make instance contexts that work for 80% of use cases:

1. If one of the last type parameters is polykinded, then its kind will be
   specialized to * in the derived instance. We note what kind variable the type
   parameter had and substitute it with * in the other types as well. For example,
   imagine you had

     data Data (a :: k) (b :: k) (c :: k)

   Then you'd want to derived instance to be:

     instance C (Data (a :: *))

   Not:

     instance C (Data (a :: k))

2. We na&#239;vely come up with instance constraints using the following criteria:

   (i)  If there's a type parameter n of kind k1 -&gt; k2 (where k1/k2 are * or kind
        variables), then generate an Invariant n constraint, and if k1/k2 are kind
        variables, then substitute k1/k2 with * elsewhere in the types. We must
        consider the case where they are kind variables because you might have a
        scenario like this:

          newtype Compose (f :: k3 -&gt; *) (g :: k1 -&gt; k2 -&gt; k3) (a :: k1) (b :: k2)
            = Compose (f (g a b))

        Which would have a derived Invariant2 instance of:

          instance (Invariant f, Invariant2 g) =&gt; Invariant2 (Compose f g) where ...

   (ii) If there's a type parameter n of kind k1 -&gt; k2 -&gt; k3 (where k1/k2/k3 are
        * or kind variables), then generate a Invariant2 n constraint and perform
        kind substitution as in the other case.
-}</span><span>
</span><a name="line-717"></a><span>
</span><a name="line-718"></a><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><a name="line-719"></a><span class="hs-comment">-- Error messages</span><span>
</span><a name="line-720"></a><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><a name="line-721"></a><span>
</span><a name="line-722"></a><span class="hs-comment">-- | Either the given data type doesn't have enough type variables, or one of</span><span>
</span><a name="line-723"></a><span class="hs-comment">-- the type variables to be eta-reduced cannot realize kind *.</span><span>
</span><a name="line-724"></a><span class="hs-identifier">derivingKindError</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Functor.Invariant.TH.Internal.html#InvariantClass"><span class="hs-identifier hs-type">InvariantClass</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679099962"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-725"></a><a name="derivingKindError"><a href="Data.Functor.Invariant.TH.html#derivingKindError"><span class="hs-identifier">derivingKindError</span></a></a><span> </span><a name="local-6989586621679100890"><a href="#local-6989586621679100890"><span class="hs-identifier">iClass</span></a></a><span> </span><a name="local-6989586621679100891"><a href="#local-6989586621679100891"><span class="hs-identifier">tyConName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">error</span><span>
</span><a name="line-726"></a><span>    </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">showString</span><span> </span><span class="hs-string">&quot;Cannot derive well-kinded instance of form &#8216;&quot;</span><span>
</span><a name="line-727"></a><span>    </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">showString</span><span> </span><a href="#local-6989586621679100892"><span class="hs-identifier hs-var">className</span></a><span>
</span><a name="line-728"></a><span>    </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">showChar</span><span> </span><span class="hs-char">' '</span><span>
</span><a name="line-729"></a><span>    </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">showParen</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-730"></a><span>      </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">showString</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nameBase</span><span> </span><a href="#local-6989586621679100891"><span class="hs-identifier hs-var">tyConName</span></a><span class="hs-special">)</span><span>
</span><a name="line-731"></a><span>      </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">showString</span><span> </span><span class="hs-string">&quot; ...&quot;</span><span>
</span><a name="line-732"></a><span>      </span><span class="hs-special">)</span><span>
</span><a name="line-733"></a><span>    </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">showString</span><span> </span><span class="hs-string">&quot;&#8216;\n\tClass &quot;</span><span>
</span><a name="line-734"></a><span>    </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">showString</span><span> </span><a href="#local-6989586621679100892"><span class="hs-identifier hs-var">className</span></a><span>
</span><a name="line-735"></a><span>    </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">showString</span><span> </span><span class="hs-string">&quot; expects an argument of kind &quot;</span><span>
</span><a name="line-736"></a><span>    </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">showString</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pprint</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Data.Functor.Invariant.TH.Internal.html#createKindChain"><span class="hs-identifier hs-var">createKindChain</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">fromEnum</span><span> </span><a href="#local-6989586621679100890"><span class="hs-identifier hs-var">iClass</span></a><span class="hs-special">)</span><span>
</span><a name="line-737"></a><span>    </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-738"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-739"></a><span>    </span><span class="hs-identifier">className</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-740"></a><span>    </span><a name="local-6989586621679100892"><a href="#local-6989586621679100892"><span class="hs-identifier">className</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nameBase</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Functor.Invariant.TH.Internal.html#invariantClassName"><span class="hs-identifier hs-var">invariantClassName</span></a><span> </span><a href="#local-6989586621679100890"><span class="hs-identifier hs-var">iClass</span></a><span>
</span><a name="line-741"></a><span>
</span><a name="line-742"></a><span class="hs-comment">-- | The data type has a DatatypeContext which mentions one of the eta-reduced</span><span>
</span><a name="line-743"></a><span class="hs-comment">-- type variables.</span><span>
</span><a name="line-744"></a><span class="hs-identifier">datatypeContextError</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679099961"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-745"></a><a name="datatypeContextError"><a href="Data.Functor.Invariant.TH.html#datatypeContextError"><span class="hs-identifier">datatypeContextError</span></a></a><span> </span><a name="local-6989586621679100893"><a href="#local-6989586621679100893"><span class="hs-identifier">dataName</span></a></a><span> </span><a name="local-6989586621679100894"><a href="#local-6989586621679100894"><span class="hs-identifier">instanceType</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">error</span><span>
</span><a name="line-746"></a><span>    </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">showString</span><span> </span><span class="hs-string">&quot;Can't make a derived instance of &#8216;&quot;</span><span>
</span><a name="line-747"></a><span>    </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">showString</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pprint</span><span> </span><a href="#local-6989586621679100894"><span class="hs-identifier hs-var">instanceType</span></a><span class="hs-special">)</span><span>
</span><a name="line-748"></a><span>    </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">showString</span><span> </span><span class="hs-string">&quot;&#8216;:\n\tData type &#8216;&quot;</span><span>
</span><a name="line-749"></a><span>    </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">showString</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nameBase</span><span> </span><a href="#local-6989586621679100893"><span class="hs-identifier hs-var">dataName</span></a><span class="hs-special">)</span><span>
</span><a name="line-750"></a><span>    </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">showString</span><span> </span><span class="hs-string">&quot;&#8216; must not have a class context involving the last type argument(s)&quot;</span><span>
</span><a name="line-751"></a><span>    </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-752"></a><span>
</span><a name="line-753"></a><span class="hs-comment">-- | The data type has an existential constraint which mentions one of the</span><span>
</span><a name="line-754"></a><span class="hs-comment">-- eta-reduced type variables.</span><span>
</span><a name="line-755"></a><span class="hs-identifier">existentialContextError</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679099960"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-756"></a><a name="existentialContextError"><a href="Data.Functor.Invariant.TH.html#existentialContextError"><span class="hs-identifier">existentialContextError</span></a></a><span> </span><a name="local-6989586621679100895"><a href="#local-6989586621679100895"><span class="hs-identifier">conName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">error</span><span>
</span><a name="line-757"></a><span>    </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">showString</span><span> </span><span class="hs-string">&quot;Constructor &#8216;&quot;</span><span>
</span><a name="line-758"></a><span>    </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">showString</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nameBase</span><span> </span><a href="#local-6989586621679100895"><span class="hs-identifier hs-var">conName</span></a><span class="hs-special">)</span><span>
</span><a name="line-759"></a><span>    </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">showString</span><span> </span><span class="hs-string">&quot;&#8216; must be truly polymorphic in the last argument(s) of the data type&quot;</span><span>
</span><a name="line-760"></a><span>    </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-761"></a><span>
</span><a name="line-762"></a><span class="hs-comment">-- | The data type mentions one of the n eta-reduced type variables in a place other</span><span>
</span><a name="line-763"></a><span class="hs-comment">-- than the last nth positions of a data type in a constructor's field.</span><span>
</span><a name="line-764"></a><span class="hs-identifier">outOfPlaceTyVarError</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679099959"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-765"></a><a name="outOfPlaceTyVarError"><a href="Data.Functor.Invariant.TH.html#outOfPlaceTyVarError"><span class="hs-identifier">outOfPlaceTyVarError</span></a></a><span> </span><a name="local-6989586621679100896"><a href="#local-6989586621679100896"><span class="hs-identifier">conName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">error</span><span>
</span><a name="line-766"></a><span>  </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">showString</span><span> </span><span class="hs-string">&quot;Constructor &#8216;&quot;</span><span>
</span><a name="line-767"></a><span>  </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">showString</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nameBase</span><span> </span><a href="#local-6989586621679100896"><span class="hs-identifier hs-var">conName</span></a><span class="hs-special">)</span><span>
</span><a name="line-768"></a><span>  </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">showString</span><span> </span><span class="hs-string">&quot;&#8216; must only use its last two type variable(s) within&quot;</span><span>
</span><a name="line-769"></a><span>  </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">showString</span><span> </span><span class="hs-string">&quot; the last two argument(s) of a data type&quot;</span><span>
</span><a name="line-770"></a><span>  </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-771"></a><span>
</span><a name="line-772"></a><span class="hs-comment">-- | One of the last type variables cannot be eta-reduced (see the canEtaReduce</span><span>
</span><a name="line-773"></a><span class="hs-comment">-- function for the criteria it would have to meet).</span><span>
</span><a name="line-774"></a><span class="hs-identifier">etaReductionError</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679099958"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-775"></a><a name="etaReductionError"><a href="Data.Functor.Invariant.TH.html#etaReductionError"><span class="hs-identifier">etaReductionError</span></a></a><span> </span><a name="local-6989586621679100897"><a href="#local-6989586621679100897"><span class="hs-identifier">instanceType</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-776"></a><span>    </span><span class="hs-string">&quot;Cannot eta-reduce to an instance of form \n\tinstance (...) =&gt; &quot;</span><span>
</span><a name="line-777"></a><span>    </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">pprint</span><span> </span><a href="#local-6989586621679100897"><span class="hs-identifier hs-var">instanceType</span></a><span>
</span><a name="line-778"></a></pre></body></html>